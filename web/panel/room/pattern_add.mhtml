<%args>
	$tourn
	$rpool_id
	$site_id => undef
	$pattern => undef
</%args>
<%init>

	if ($pattern) {

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select room.id
			from room
		where room.site = ?
			and room.name like ?
	");

	$pattern = $pattern.'%';
	$sth->execute($pattern);

	if ($ARGS{"delete"}) {

		my $delete_sth = $dbh->prepare("
			delete * from jpool_room jpr
				where jpr.room = ?
				and jpr.rpool = ?
		");

		while (
			my (
				$room_id
			) = $sth->fetchrow_array()
		) {
			$delete_sth->execute($room_id, $rpool_id);
		}

	} else {

		my $add_sth = $dbh->prepare("
			insert into jpool_room
				(room, rpool)
			values (?, ?)

			where not exists (
				select jpr2.id
					from jpool_room jpr2
				where jpr2.room = ?
					and jpr2.rpool = ?
			)
		");

		while (
			my (
				$room_id
			) = $sth->fetchrow_array()
		) {
			$add_sth->execute($room_id, $rpool_id, $room_id, $rpool_id);
		}
	}

	my $msg = "All $pattern rooms added to pool";
	$m->redirect("/panel/room/rpool.mhtml?rpool_id=$rpool_id");

</%init>
