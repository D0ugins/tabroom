<%args>
	$tourn
	$tourn_settings
	$perms
	$person
</%args>
<%init>

	my @rooms = eval {
		return @{$tourn_settings->{"online_rooms"}};
	};

	my @events = $tourn->events();
	my @categories = $tourn->categories();

</%init>

	<& menu.mas,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		perms          => $perms,
	&>

	<div class="main">

		<h2>Online Utility Rooms</h2>

		<& tabbar.mas,
			tourn    => $tourn,
			whoami   => "utility"
		&>

		<& /funclib/tablesorter.mas,
			table => "online"
		&>

		<form
			action="utility_save.mhtml"
			method="post"
		>
<%perl>

		my $new = ({
			id => "new"
		});

		push @rooms, $new;

		foreach my $room (@rooms) {

			my $key = $room->{"id"};
</%perl>

			<div class="row rooms" id="<% $key %>">

				<span class="fifth">
					<input
						type        = "text"
						size        = 16
						name        = "<% $key %>_name"
						value       = "<% $room->{"name"} %>"
						placeholder = "Room label/name"
					>
				</span>

%				if ($tourn_settings->{"online_public_approved"}
%					|| $tourn_settings->{"online_private_approved"}
%				) {

					<span class="fifth types">
						<select
							class    = "fixedsmaller"
							name     = "<% $key %>_type"
							id       = "<% $key %>_type"
							onChange = "checkService();";
						>
							<option
								value = ""
							>Online Service</option>
							<option
								value = "jitsi"
								<% $room->{"type"} eq "jitsi" ? "selected" : "" %>
								<% (not defined $room->{"type"}) ? "selected" : "" %>
							>NSDA Campus</option>
							<option
								value = "link"
								<% $room->{"type"} eq "link" ? "selected" : "" %>
							>Link to Other Service</option>
						</select>
					</span>

					<span class="<% $key %>_type_jitsi <% $key %>_types fifth rightalign">
%						unless ($key eq "new") {
							Regenerate:
							<input
								type        = "checkbox"
								name        = "<% $key %>_regenerate"
								value       = "1"
							>
%						}
					</span>

%				}

				<span class='<% $key %>_type_link <% $key %>_types fifth'>
					<input
						type        = "url"
						size        = 16
						name        = "<% $key %>_url"
						value       = "<% $room->{"url"} %>"
						placeholder = "Meeting Room URL/Link"
					>
				</span>

				<span class='fifth'>
					<select
						name     = "<% $key %>_access"
						id       = "<% $key %>_access"
						class    = "fixedsmaller"
						onChange = "checkScopes();"
					>
%						foreach my $access ("all", "entry", "judge", "coach", "tab") {
							<option
								value = "<% $access %>"
								<% $room->{"access"} eq $access ? "selected" : "" %>
							><% ucfirst($access) %></option>
%						}
					</select>
				</span>

				<span class='<% $key %>_scope_event <% $key %>_scopes fifth'>
					<select
						name  = "<% $key %>_event"
						class = "fixedsmaller"
					>
						<option value="">All</option>
%						foreach my $event (@events) {
							<option
								value="<% $event->id %>"
								<% $event->id eq $room->{"event_id"} ? "selected" : "" %>
							><% $event->abbr %></option>
%						}
					</select>
				</span>

				<span class='<% $key %>_scope_category <% $key %>_scopes fifth'>
					<select
						name  = "<% $key %>_category"
						class = "fixedsmaller"
					>
%						foreach my $category (@categories) {
							<option
								value="<% $category->id %>"
								<% $category->id eq $room->{"category_id"} ? "selected" : "" %>
							><% $category->abbr %></option>
%						}
					</select>
				</span>

			</div>
%		}

		<div class="liblrow rightalign">
			<span class="centeralign third nospace">
				<input type="submit" value="Save Rooms">
			</span>
		</div>

		</form>

	</div>

	<script>

		function checkService() {

			$('.rooms').each(function() {

				var rowId = $(this).attr("id");
				var roomType = $("#"+rowId+"_type").val();

				console.log("Adding hidden to "+rowId+"_types and then removing from "+rowId+"_type_"+roomType);

				$("."+rowId+"_types").addClass("hidden");
				$("."+rowId+"_type_"+roomType).removeClass("hidden")

			});
		}

		function checkScopes() {

			$('.rooms').each(function() {

				var rowId = $(this).attr("id");
				var roomAccess = $("#"+rowId+"_access").val();

				console.log("Row "+rowId+" has access "+roomAccess);

				$("."+rowId+"_scopes").addClass('hidden');

				if (roomAccess == "tab" || roomAccess == "entry" || roomAccess == "coach") {

					$("."+rowId+"_scope_event").removeClass('hidden');

				} else if (roomAccess == "judge") {
					$("."+rowId+"_scope_category").removeClass('hidden');

				}
			});
		}

		$(document).ready(function() {
			checkService();
			checkScopes();
		});

	</script>

