<%args>
	$person
	$room_id       => undef
	$rpool_id      => undef
	$value         => undef
	$target_id     => undef
	$setting_name  => undef
	$property_name => undef
</%args>
<%init>

	$m->clear_buffer();
	$r->content_type('application/json');


	$rpool_id = $target_id if $target_id;
	$room_id = $setting_name if $setting_name;

	unless ($room_id) { 
		$m->print('{ "error": true, "message": "No room ID sent"}');
		$m->abort();
	}

	unless ($rpool_id) { 
		$m->print('{ "error": true, "message": "No room pool ID sent"}');
		$m->abort();
	}

	my $existing = Tab::RPoolRoom->search( 
		room  => $room_id,
		rpool => $rpool_id
	)->first;

	my $message;

	if ($property_name eq "flip") { 

		if ($existing) { 

			$existing->delete();
			$message = "Room $room_id removed from pool";

		} else { 

			eval { 
				$existing = Tab::RPoolRoom->create({
					room  => $room_id,
					rpool => $rpool_id
				}) unless $existing;
			};

			$message = "Room $room_id added to pool $rpool_id" if $existing > 0;
		}

		$m->print('{ "error": false, "message": "'.$message.'"}');
		$m->abort();

	}


	if ($value == 1) { 

		eval { 
			$existing = Tab::RPoolRoom->create({
				room  => $room_id,
				rpool => $rpool_id
			}) unless $existing;
		};

		if ($existing) { 
			$message = "Room $room_id added to pool";
		}

	} else { 
			
		$existing->delete() if $existing;
		$message = "Room removed from pool";
	}

	$m->print('{ "error": false, "message": "'.$message.'"}');
	$m->abort();

</%init>

