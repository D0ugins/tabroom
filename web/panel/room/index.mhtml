<%args>
	$tourn
	$tourn_settings
	$perms
	$person
	$timeslot_id => undef
	$round_type  => undef
	$site_id     => undef
	$weekend_id  => undef
</%args>
<%init>

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;
	my $site = Tab::Site->retrieve($site_id) if $site_id;
	my $weekend = Tab::Weekend->retrieve($weekend_id) if $weekend_id;

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas",
		tourn   => $tourn,
		perms   => $perms,
		type    => "admin",
		weekend => $weekend_id
	);

	my %ok_events = map {$_->id => $_} @{$eventref};

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my %room_by_id = ();

	foreach my $site ($tourn->sites) {
		foreach my $room ($site->rooms(deleted => 0)) {
			$room_by_id{$room->id} = $room;
		}
	}

	my %panels_by_round = ();
	my @strikes = $m->comp("/funclib/tourn_roomstrikes.mas", tourn => $tourn);
	my %strikes_by_room = ();

	foreach my $strike (@strikes) {
		push (@{$strikes_by_room{$strike->room->id}}, $strike);
	}

	my @clean_rooms = $m->comp(
		"/funclib/timeslot_rooms.mas",
		timeslot => $timeslot,
		avail => 1
	);

	my @timeslot_events;

	if ($weekend) {
		@timeslot_events = $m->comp("/funclib/weekend_events.mas", weekend => $weekend);
	} elsif ($timeslot) {
		@timeslot_events = $m->comp("/funclib/timeslot_events.mas", timeslot => $timeslot);
	} else {
		@timeslot_events = @{$eventref};
	}

</%init>

	<& menu.mas,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		perms          => $perms,
		site           => $site,
		timeslot       => $timeslot,
		round_type     => $round_type,
		weekend        => $weekend,
		clean_rooms    => \@clean_rooms
	&>

	<div class="main">

		<h2>Rooms</h2>

		<& tabbar.mas,
			tourn    => $tourn,
			timeslot => $timeslot,
			whoami   => "index"
		&>

%		if ($timeslot) {

			<div>
				<span class="half nospace">
					<h4>Timeslot <% $timeslot ? $timeslot->name : "" %></h4>
				</span>

				<span class="half nospace rightalign">
					<h5>
						<% $timeslot->start->set_time_zone($tz)->day_name %>
						<% Tab::nicetime($timeslot->start->set_time_zone($tz)) %> -
						<% Tab::nicetime($timeslot->end->set_time_zone($tz)) %>
						<% Tab::tzname($tz) %>
					</h5>
				</span>
			</div>

%		} elsif ($weekend) {

			<div>
				<span class="half nospace">
					<h4>Weekend: <% $weekend ? $weekend->name : "" %></h4>
				</span>

				<span class="half nospace rightalign">
					<h5>
						<% $weekend->start->set_time_zone($tz)->day_name %>
						<% Tab::nicetime($weekend->start->set_time_zone($tz)) %> -
						<% Tab::nicetime($weekend->end->set_time_zone($tz)) %>
						<% Tab::tzname($tz) %>
					</h5>
				</span>
			</div>
%		}

<%perl>

		my $notfirst;

		foreach my $event (@timeslot_events) {

			next unless $ok_events{$event->id};

			my @rounds = $event->rounds;
			my @clear_rounds;

			if ($timeslot) {
				foreach my $round (@rounds) {
					next unless $round->timeslot->id == $timeslot->id;
					push @clear_rounds, $round;
				}
				@rounds = @clear_rounds;
				undef @clear_rounds;
			}

			if ($round_type) {
				foreach my $round (@rounds) {
					next unless $round->type eq $round_type;
					push @clear_rounds, $round;
				}
				@rounds = @clear_rounds;
				undef @clear_rounds;
			}

			next unless @rounds;
			my $notfirstround;

</%perl>

%			$m->print('<hr / class="martopmore">') if $notfirst++;

			<span class="half nospace">
				<h5><% $event->name %></h5>
			</span>

%				foreach my $round (@rounds) {

					<span class="<% $notfirstround++ ? "pagefull" : "half" %> nospace rightalign">
						<h6><% ucfirst($round->type) %> <% $round->realname %></h6>
					</span>

<%perl>
					my $switch;
					my $counter = 1;
					my %used;

					my $args = "&timeslot_id=".$timeslot_id."&round_type=".$round_type;

					foreach  my $panel (sort {$a->letter <=> $b->letter} $round->panels) {

						my $room;
						$room = $panel->room if $panel->room;
</%perl>

%						if ($room) {

							<span class="marvertno smallish third thin hover
								<% $switch % 2 ? "even" : "odd"%>">

								<a
									class="full plain nospace hover"
									href="/panel/room/report.mhtml?room_id=<% $room %><% $args %>"
								>
									<span class="quarter marno padless">
										<% $round->event->abbr %> <% $round->name %> <% $panel->letter %>
									</span>

									<span class="threequarter nowrap padless semibold bluetext">
										<% $room_by_id{$room->id}? $room_by_id{$room->id}->name : "None" %>
									</span>

								</a>

							</span>
%						} else {

							<span class="marvertno smallish third thin hover <% $switch % 2 ? "even" : "odd"%>">
								<span class="quarter marno padless">
									<% $round->event->abbr %> <% $round->name %> <% $panel->letter %>
								</span>

								<span class="threequarter nowrap padless semibold redtext">
									NO ROOM
								</span>
							</span>
<%perl>
						}

						$switch++ unless $counter++ % 3;
					}
				}
			}

</%perl>


	</div>




