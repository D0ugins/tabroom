<%args>
	$tourn
	$perms
	$person
	$timeslot_id => undef
</%args>
<%init>

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id);

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas", 
		tourn => $tourn,
		perms => $perms,
		type  => "admin"
	);

	my @events = @{$eventref};

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @rooms = $m->comp(
		"/funclib/timeslot_rooms.mas", 
		timeslot => $timeslot
	) if $timeslot;


	my %room_by_id = ();
	foreach my $room (@rooms) { 
		$room_by_id{$room->id} = $room;
	}

	my %panels_by_round = ();


	my @strikes = $m->comp("/funclib/tourn_roomstrikes.mas", tourn => $tourn);
	my %strikes_by_room = ();

	foreach my $strike (@strikes) { 
		push (@{$strikes_by_room{$strike->room->id}}, $strike);
	}

	my @clean_rooms = $m->comp(
		"/funclib/timeslot_rooms.mas", 
		timeslot => $timeslot, 
		avail => 1
	);

</%init>

	<& menu.mas, 
		tourn       => $tourn,
		perms       => $perms,
		timeslot    => $timeslot,
		clean_rooms => \@clean_rooms
	&>

	<div class="main">

		<h2>Rooms</h2>
		
		<& tabbar.mas, 
			tourn    => $tourn,
			timeslot => $timeslot,
			whoami   => "index"
		&>

%		if ($timeslot) { 

			<div>
				<span class="half nospace">
					<h4>Timeslot <% $timeslot ? $timeslot->name : "" %></h4>
				</span>

				<span class="half nospace rightalign">
					<h5>
						<% $timeslot->start->set_time_zone($tz)->day_name %>
						<% Tab::nicetime($timeslot->start->set_time_zone($tz)) %> -
						<% Tab::nicetime($timeslot->end->set_time_zone($tz)) %>
						<% Tab::tzname($tz) %>
					</h5>
				</span>
			</div>

%			foreach my $event (@events) { 

				<hr />

				<span class="half nospace">
					<h5><% $event->name %></h5>
				</span>

%				foreach my $round ($event->rounds(timeslot => $timeslot->id)) { 

					<span class="half nospace rightalign">
						<h6><% $round->realname %></h6>
					</span>

<%perl>
					my $switch;
					my $counter = 1;
					my %used;

					foreach  my $panel (sort {$a->letter <=> $b->letter} $round->panels) { 

						my $room;
						$room = $panel->room if $panel->room;

</%perl>

%						if ($room) { 
							<span class="marvertno smallish third thin hover <% $switch % 2 ? "even" : "odd"%>">

								<a 
									class="full plain nospace hover" 
									href="/panel/room/report.mhtml?room_id=<% $room %>&timeslot_id=<% $timeslot->id %>">

									<span class="quarter marno padless">
										<% $round->event->abbr %> <% $round->name %> <% $panel->letter %>
									</span>

									<span class="threequarter nowrap padless semibold bluetext">
										<% $room_by_id{$room->id}? $room_by_id{$room->id}->name : "None" %>
									</span>

								</a>

							</span>
%						} else { 

							<span class="marvertno smallish third thin hover <% $switch % 2 ? "even" : "odd"%>">
								<span class="quarter marno padless">
									<% $round->event->abbr %> <% $round->name %> <% $panel->letter %>
								</span>

								<span class="threequarter nowrap padless semibold redtext">
									NO ROOM
								</span>
							</span>
<%perl>
						}

						$switch++ unless $counter++ % 3;
					}
				}
			}
		}
</%perl>


	</div>




