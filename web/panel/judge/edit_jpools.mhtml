<%args>
	$tourn
	$perms
	$tourn_settings
	$person
	$jpool_id         => undef
	$category_id      => undef
	$only_category    => undef
	$pull_category_id => undef
</%args>
<%init>

	my $jpool = Tab::JPool->retrieve($jpool_id);

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas", 
		tourn => $tourn,
		perms => $perms,
		type  => "admin"
	);

	my @events = @{$eventref};
	my @categories = @{$catref};

	my $category = Tab::Category->retrieve($category_id);
	$category = $categories[0] 
		if @categories && (not defined $category);

	my @sites = $m->comp('/funclib/tourn_sites.mas', tourn => $tourn);

	my @timeslots = 
		sort {$a->start->epoch <=> $b->start->epoch} 
		$tourn->timeslots;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	$m->abort unless $category;

	my @jpools;
	my %children;

	if ($tourn_settings->{"nsda_nats"}) { 
		@jpools = $m->comp(
			"/funclib/tourn_jpools.mas", 
			tourn => $tourn,
			limit => "registrant"
		);

		foreach my $jpool (@jpools) {
			push @{$children{$jpool->id}}, $jpool->children;
			Tab::debuglog("I have children ".$jpool->children);
		}
	} else { 
		@jpools = sort {$a->name cmp $b->name} $category->jpools;
	}

	unless ($jpool) { 
		$jpool = $jpools[0] if @jpools;
	}

	my %jpool_settings = $m->comp("/funclib/jpool_settings.mas", category => $category);

</%init>

    <script type="text/javascript"> 
        function showMe (it, box) { 
            var vis = (box.checked) ? "inline-block" : "none"; 
            document.getElementById(it).style.display = vis;
        } 
    </script>

	<& "menu.mas",
		tourn          => $tourn,
		perms          => $perms,
		tourn_settings => $tourn_settings,
		category       => $category,
		whoami         => "edit_jpools",
		jpool          => $jpool,
		only_category  => $only_category
	&>

	<div class="main">

%		unless ($category) { 

			<h2>Choose a judge category at right</h2>
	
%		} else {

			<h2><% $category->name %></h2>
			
			<& "tabbar.mas", 
				category => $category,
				whoami   => "edit_jpools"
			&>

			<form 
				action = "edit_jpools_save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				value = "<% $category->id %>"
				name  = "category_id"
			>

<%perl>
			foreach my $master (@jpools) { 

				my $notfirst;

				foreach my $jpool ($master, @{$children{$master->id}}) { 
</%perl>

					<div class="row <% $notfirst++ 
						? "marleft borderleft" 
						: "bordertop martop"
					%>">
						
						<span class="fifth">
							<input 
								type  = "text"
								size  = "18"
								value = "<% $jpool->name %>"
								name  = "name_<% $jpool->id %>"
							>
						</span>

						<span class="fivetenths padno">

%							my $spansize = "third";
%							if ($tourn_settings->{"nsda_nats"}) { 
%								$spansize = "quarter";

								<span class="<% $spansize %> smallish centeralign">
									Code:
									<input 
										type  = "text"
										size  = "4" 
										id    = "code_<% $jpool->id %>"
										name  = "code_<% $jpool->id %>"
										value = "<% $jpool_settings{$jpool->id}{"code"} %>"
									>
								</span>

								<span 
									class = "<% $spansize %> smallish centeralign"
									title = "Rounds of obligations this pool satisfies"
								>
									Rounds
									<input 
										type  = "text"
										size  = "4" 
										id    = "rounds_<% $jpool->id %>"
										name  = "rounds_<% $jpool->id %>"
										value = "<% $jpool_settings{$jpool->id}{"rounds"} %>"
									>
								</span>
%							}

							<label for="publish_<% $jpool->id %>">

								<span class="<% $spansize %> smallish hover marno">

									Publish:
									<input 
										type  = "checkbox"
										value = "1"
										id    = "publish_<% $jpool->id %>"
										name  = "publish_<% $jpool->id %>"
										<% $jpool_settings{$jpool->id}{"publish"}
											? 'checked="checked"' 
											: ""
										%> 
									>
								</span>
							</label>

%							my $standby_click = "showMe('standby_ts_".$jpool->id."', this)";

							<label for="standby_<% $jpool->id %>">
								<span class="<% $spansize %> smallish hover">
									Standby:

									<input 
										type    = "checkbox"
										value   = "1"
										id      = "standby_<% $jpool->id %>"
										onclick = "<% $standby_click %>"
										name    = "standby_<% $jpool->id %>"
										<% $jpool_settings{$jpool->id}{"standby"}
											? 'checked="checked"' 
											: ""
										%> 
									>
								</span>
							</label>

							<span <% $jpool_settings{$jpool->id}{"standby"}
								? "display: inline-block;" 
								: 'style="display: none;"' 
							%> 
								class="<% $spansize %> smallish hover" 
								id="standby_ts_<% $jpool->id %>"
							>

								<select 
									name="standby_timeslot_<% $jpool->id %>" 
									class="fixedtiny plain"
								> 

									<option value="">Choose When:</option>

%									foreach my $timeslot ($tourn->timeslots) { 

										<option value="<% $timeslot->id %>" 
											<% $jpool_settings{$jpool->id}{"standby_timeslot"}
												&& $timeslot->id == $jpool_settings{$jpool->id}{"standby_timeslot"}
												? 'selected="selected"' 
												: "" %>
										><% $timeslot->name %></option>
%	   		                   		}
								</select>
							</span>
						</span>

%						if (scalar @sites > 0) { 

							<span class="threetenths nospace">

								<span class="seveneighths nospace">

									<select 
										name="site_<% $jpool->id %>" 
										class="fixedsmall"
									>
%										foreach my $site (@sites) { 
											<option value="<% $site->id %>" 
												<% $site->id == $jpool->site->id 
													? 'selected="selected"' : "" %>
											><% $site->name %></option>
%										}
									</select>
								</span>
								<span class="tenth nospace rightalign">

%									my $warn = "Really delete the pool ".$jpool->name." and all round and judge assignments?";
									<a 
										class="buttonwhite fa fa-sm fa-trash redtext hover" 
										href="jpool_rm.mhtml?jpool_id=<% $jpool->id %>&category_id=<% $category_id %>"
										<& "/funclib/confirm.mas", warn => $warn &>  >
									</a>

								</span>
							</span>

%						}  else { 

							<span class="quarter rightalign nospace">

%								my $warn = "Really delete the pool ".$jpool->name." and all round and judge assignments?";

								<a 
									class="buttonwhite fa  fa-trash redtext hover" 
									href="jpool_rm.mhtml?jpool_id=<% $jpool->id %>&category_id=<% $category_id %>"
									<& "/funclib/confirm.mas", warn => $warn &> 
								>
								</a>
							</span>
%						}  
					</div>
%				}
%			}
			

			<div class="liblrow rightalign">
				<input type="submit" value=" Save Pools">
			</div>

%		}

	</div>

