<%args>
	$tourn
	$perms
	$tourn_settings
	$person
	$event_id         => undef
	$jpool_id         => undef
	$category_id      => undef
	$only_category    => undef
	$pull_category_id => undef
</%args>
<%init>
	
	# Yeah, OK, I'm sorry.  -CLP

	my ($event, $eventsref,
		$category, $categoriesref, 
		$jpool, $jpoolsref, $jpool_settingsref, 
		$childrenref) = $m->comp("pools.mas", 
			tourn       => $tourn,
			nsda_nats   => $tourn_settings->{"nsda_nats"},
			perms       => $perms,
			jpool_id    => $jpool_id,
			event_id    => $event_id,
			category_id => $category_id,
		);

	my @sites = $m->comp(
		'/funclib/tourn_sites.mas', 
		tourn => $tourn
	);

	my @timeslots = 
		sort {$a->start->epoch <=> $b->start->epoch} 
		$tourn->timeslots;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $nats_category;

	if ($tourn_settings->{"nsda_nats"}) { 

		# Nationals has 38,421 judge pools.  Don't show them all, only 
		# display the specific event

		$nats_category++ if $category && $category->setting("nats_category");
	}


</%init>

    <script type="text/javascript"> 
        function showMe (it, box) { 
            var vis = (box.checked) ? "inline-block" : "none"; 
            document.getElementById(it).style.display = vis;
        } 
    </script>

	<& "menu.mas",
		tourn             => $tourn,
		event             => $event,
		perms             => $perms,
		tourn_settings    => $tourn_settings,
		category          => $category,
		whoami            => "edit_jpools",
		jpool             => $jpool,
		only_category     => $only_category,
		nats_category     => $nats_category,
		eventsref         => $eventsref,
		categoriesref     => $categoriesref,
		jpoolsref         => $jpoolsref,
		jpool_settingsref => $jpool_settingsref,
	&>

	<div class="main">

%		unless ($category) { 

			<h2>Choose a judge category at right</h2>
	
%		} else {

			<h2><% $category->name %></h2>
			
			<& "tabbar.mas", 
				category => $category,
				event    => $event,
				jpool    => $jpool,
				whoami   => "edit_jpools"
			&>

%			if (scalar @{$eventsref} > 1) { 

				<span class="half">
					<h5><% $event ? $event->abbr : "Registrant" %> pools</h5>
				</span>

				<span class="eighth semibold bluetext rightalign marno">
					Event:
				</span>

				<span class="threeeighths centeralign marno">
					<form 
						action = "edit_jpools.mhtml"
						method = "post"
					>
						<input 
							type  = "hidden"
							value = "<% $category->id %>"
							name  = "category_id"
						>

						<select 
							name     = "event_id"
							class    = "fixedmed plain"
							onChange = "this.form.submit();"
						>
%							if ($perms->{'owner'} || $perms->{"full_admin"}) { 
								<option value="">Registrant Pools</option>
%							}

%							foreach my $oevent (@{$eventsref}) { 
								<option value="<% $oevent->id %>"
									<% $oevent->id == $event ? "selected" : "" %>
								><% $oevent->name %></option>
%							}

						</select>
					</form>
				</span>
%			}

			<form 
				action = "edit_jpools_save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				value = "<% $category->id %>"
				name  = "category_id"
			>

			<input 
				type  = "hidden"
				value = "<% $event %>"
				name  = "event_id"
			>


<%perl>
			foreach my $master (@{$jpoolsref}) { 

				my $notfirst;

				foreach my $jpool ($master, @{$childrenref->{$master->id}}) { 
</%perl>

					<div class="row <% $notfirst++ 
						? "marleft borderleft" 
						: "bordertop"
					%>">
						
						<span class="fifth">
							<input 
								type  = "text"
								size  = "16"
								value = "<% $jpool->name %>"
								name  = "name_<% $jpool->id %>"
							>
						</span>

						<span class="fivetenths padno">

<%perl>
							my $spansize = "third";

							if ($tourn_settings->{"nsda_nats"} 
								&& $perms->{'owner'} 
								&& $perms->{"full_admin"}
							) { 
								$spansize = "quarter";

</%perl>
								<span class="<% $spansize %> smallish centeralign">
									Code:
									<input 
										type  = "text"
										size  = "4" 
										id    = "code_<% $jpool->id %>"
										name  = "code_<% $jpool->id %>"
										value = "<% $jpool_settingsref->{$jpool->id}{"code"} %>"
									>
								</span>

								<span 
									class = "<% $spansize %> smallish centeralign"
									title = "Rounds of obligations this pool satisfies"
								>
									Rounds
									<input 
										type  = "text"
										size  = "4" 
										id    = "rounds_<% $jpool->id %>"
										name  = "rounds_<% $jpool->id %>"
										value = "<% $jpool_settingsref->{$jpool->id}{"rounds"} %>"
									>
								</span>
%							}

							<label for="publish_<% $jpool->id %>">

								<span class="<% $spansize %> smallish hover marno centeralign">

									Publish:
									<input 
										type     = "checkbox"
										value    = "1"
										tabindex = -1
										id       = "publish_<% $jpool->id %>"
										name     = "publish_<% $jpool->id %>"
										<% $jpool_settingsref->{$jpool->id}{"publish"}
											? 'checked="checked"' 
											: ""
										%> 
									>
								</span>
							</label>

%							my $standby_click = "showMe('standby_ts_".$jpool->id."', this)";

							<label for="standby_<% $jpool->id %>">
								<span class="<% $spansize %> smallish hover">
									Standby:

									<input 
										type     = "checkbox"
										value    = "1"
										tabindex = -1
										id       = "standby_<% $jpool->id %>"
										onclick  = "<% $standby_click %>"
										name     = "standby_<% $jpool->id %>"
										<% $jpool_settingsref->{$jpool->id}{"standby"}
											? 'checked="checked"' 
											: ""
										%> 
									>
								</span>
							</label>

							<span <% $jpool_settingsref->{$jpool->id}{"standby"}
								? "display: inline-block;" 
								: 'style="display: none;"' 
							%> 
								class="<% $spansize %> smallish hover" 
								id="standby_ts_<% $jpool->id %>"
							>

								<select 
									name="standby_timeslot_<% $jpool->id %>" 
									class="fixedtiny"
									tabindex = -1
								> 

									<option value="">Choose When:</option>

%									foreach my $timeslot ($tourn->timeslots) { 

										<option value="<% $timeslot->id %>" 
											<% $jpool_settingsref->{$jpool->id}{"standby_timeslot"}
												&& $timeslot->id == $jpool_settingsref->{$jpool->id}{"standby_timeslot"}
												? 'selected="selected"' 
												: "" %>
										><% $timeslot->name %></option>
%	   		                   		}
								</select>
							</span>
						</span>

%						if (scalar @sites > 0) { 

							<span class="threetenths nospace">

								<span class="seveneighths nospace">

									<select 
										name="site_<% $jpool->id %>" 
										class="fixedsmall"
									>
%										foreach my $site (@sites) { 
											<option value="<% $site->id %>" 
												<% $site->id == $jpool->site->id 
													? 'selected="selected"' : "" %>
											><% $site->name %></option>
%										}
									</select>
								</span>
								<span class="tenth nospace rightalign">

%									my $warn = "Really delete the pool ".$jpool->name." and all round and judge assignments?";
									<a 
										class="buttonwhite fa fa-sm fa-trash redtext hover" 
										tabindex = -1
										href="jpool_rm.mhtml?jpool_id=<% $jpool->id %>&category_id=<% $category_id %>"
										<& "/funclib/confirm.mas", warn => $warn &>  >
									</a>

								</span>
							</span>

%						}  else { 

							<span class="quarter rightalign nospace">

%								my $warn = "Really delete the pool ".$jpool->name." and all round and judge assignments?";

								<a 
									class="buttonwhite fa  fa-trash redtext hover" 
									href="jpool_rm.mhtml?jpool_id=<% $jpool->id %>&category_id=<% $category_id %>"
									<& "/funclib/confirm.mas", warn => $warn &> 
								>
								</a>
							</span>
%						}  
					</div>
%				}
%			}
			

			<div class="liblrow rightalign">
				<input type="submit" value=" Save Pools">
			</div>

%		}

	</div>

