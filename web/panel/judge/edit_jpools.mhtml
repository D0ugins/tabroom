<%args>
	$tourn
	$perms
	$tourn_settings
	$person
	$session
	$defaults => undef
	$event_id         => undef
	$jpool_id         => undef
	$category_id      => undef
	$only_category    => undef
	$pull_category_id => undef
</%args>
<%init>

	# Yeah, OK, I'm sorry.  -CLP

	my ($event, $eventsref,
		$category, $categoriesref,
		$jpool, $jpoolsref, $jpool_settingsref,
		$childrenref) = $m->comp("pools.mas",
			tourn       => $tourn,
			session     => $session,
			defaults    => $defaults,
			nsda_nats   => $tourn_settings->{"nsda_nats"},
			perms       => $perms,
			jpool_id    => $jpool_id,
			event_id    => $event_id,
			category_id => $category_id,
		);

	my @sites = $m->comp(
		'/funclib/tourn_sites.mas',
		tourn => $tourn
	);

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select timeslot.id, timeslot.name, timeslot.start
		from timeslot
		where timeslot.tourn = ?
		order by timeslot.start
	");

	$sth->execute($tourn->id);

	my $order = 1;
	my %timeslots;

	while (
		my ($id, $name, $start) = $sth->fetchrow_array()
	) {
		$timeslots{$id}{"name"} = $name;
		$timeslots{$id}{"start"} = $start;
		$timeslots{$id}{"order"} = $order++;
	}

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $nats_category;

	if ($tourn_settings->{"nsda_nats"}) {

		# Nationals has 38,421 judge pools.  Don't show them all, only
		# display the specific event

		$nats_category++ if $category && $category->setting("nats_category");
	}

</%init>

    <script type="text/javascript">
        function showSites (it, box) {
			if (box.checked) {
				$("#"+it).removeClass('hidden');
			} else {
				$("#"+it).addClass('hidden');
			}
        }
    </script>

	<& "menu.mas",
		tourn             => $tourn,
		event             => $event,
		perms             => $perms,
		tourn_settings    => $tourn_settings,
		category          => $category,
		whoami            => "edit_jpools",
		jpool             => $jpool,
		only_category     => $only_category,
		nats_category     => $nats_category,
		eventsref         => $eventsref,
		childrenref       => $childrenref,
		categoriesref     => $categoriesref,
		jpoolsref         => $jpoolsref,
		jpool_settingsref => $jpool_settingsref,
		timeslots         => \%timeslots
	&>

	<div class="main">

%		unless ($category) {

			<h2>Choose a judge category at right</h2>

%		} else {

			<h2><% $category->name %></h2>

			<& "tabbar.mas",
				category => $category,
				event    => $event,
				jpool    => $jpool,
				whoami   => "edit_jpools",
				nsda     => $tourn_settings->{'nsda_nats'}
			&>

%			if (scalar @{$eventsref} > 1) {

				<span class="half">
					<h5><% $event ? $event->abbr : "Registrant" %> pools</h5>
				</span>

				<span class="eighth semibold bluetext rightalign marno">
					Event:
				</span>

				<span class="threeeighths centeralign marno">
					<form
						action = "edit_jpools.mhtml"
						method = "post"
					>
						<input
							type  = "hidden"
							value = "<% $category->id %>"
							name  = "category_id"
						>

						<select
							name     = "event_id"
							class    = "fixedmed plain"
							onChange = "this.form.submit();"
						>
%							if ($perms->{'owner'} || $perms->{"full_admin"}) {
								<option value="">Registrant Pools</option>
%							}

%							foreach my $oevent (@{$eventsref}) {
								<option value="<% $oevent->id %>"
									<% $oevent->id == $event ? "selected" : "" %>
								><% $oevent->name %></option>
%							}

						</select>
					</form>
				</span>
%			}

			<form
				action = "edit_jpools_save.mhtml"
				method = "post"
			>

			<input
				type  = "hidden"
				value = "<% $category->id %>"
				name  = "category_id"
			>

			<input
				type  = "hidden"
				value = "<% $event %>"
				name  = "event_id"
			>


<%perl>

			$m->comp("/funclib/mixed_sort.mas", array => $jpoolsref);

			foreach my $master (@{$jpoolsref}) {

				my $notfirst;

				if ($childrenref->{$master->id}) { 
					$m->comp("/funclib/mixed_sort.mas", array => $childrenref->{$master->id});
				}

				foreach my $jpool ($master, @{$childrenref->{$master->id}}) {
</%perl>

					<div class="row <% $notfirst++
						? "marleft borderleft"
						: "bordertop"
					%>">

						<span class="fifth">
							<input
								type  = "text"
								size  = "16"
								value = "<% $jpool->name %>"
								name  = "name_<% $jpool->id %>"
							>
						</span>

						<label for="show_judges_<% $jpool->id %>">
							<span
								class = "seventh smallish hover marno centeralign"
								title = "Shows this judge pool on their online assignments"
							>
								Show Judges
								<input
									type     = "checkbox"
									value    = "1"
									tabindex = -1
									id       = "show_judges_<% $jpool->id %>"
									name     = "show_judges_<% $jpool->id %>"
									onclick  = "showSites('show_judges_ts_<% $jpool->id %>', this)";
									<% $jpool_settingsref->{$jpool->id}{"show_judges"}
										? 'checked="checked"'
										: ""
									%>
								>
							</span>
						</label>

						<label for="publish_<% $jpool->id %>">
							<span
								class="eighth smallish hover marno centeralign"
								title="Publishes this judge pool and its members on the public web"
							>
								On Web
								<input
									type     = "checkbox"
									value    = "1"
									tabindex = -1
									id       = "publish_<% $jpool->id %>"
									name     = "publish_<% $jpool->id %>"
									<% $jpool_settingsref->{$jpool->id}{"publish"}
										? 'checked="checked"'
										: ""
									%>
								>
							</span>
						</label>

						<label for="standby_<% $jpool->id %>">
							<span class="ninth smallish hover">
								Standby:
								<input
									type     = "checkbox"
									value    = "1"
									tabindex = -1
									id       = "standby_<% $jpool->id %>"
									onclick  = "showSites('standby_ts_<% $jpool->id %>', this)";
									name     = "standby_<% $jpool->id %>"
									<% $jpool_settingsref->{$jpool->id}{"standby"}
										? 'checked="checked"'
										: ""
									%>
								>
							</span>
						</label>

						<span class="sixth true smallish">
							<div
								class="<% $jpool_settingsref->{$jpool->id}{"standby"} ? "" : "hidden" %> full nospace"
								id="standby_ts_<% $jpool->id %>"
							>

								<select
									name     = "standby_timeslot_<% $jpool->id %>"
									class    = "fixedsmaller plain"
									tabindex = -1
								>
									<option value="">Choose When:</option>

<%perl>
									my $standby;

									if ($jpool_settingsref->{$jpool->id}{"standby_timeslot"}) {
										$standby = $jpool_settingsref->{$jpool->id}{"standby_timeslot"};
									}

									foreach my $timeslot_id (
										sort {$timeslots{$a}{"order"} <=> $timeslots{$b}{"order"}} keys %timeslots
									) {
</%perl>
										<option value="<% $timeslot_id %>"
											<% $standby == $timeslot_id ? 'selected="selected"' : "" %>
										><% $timeslots{$timeslot_id}{name} %></option>
%	   		                   		}
								</select>
							</div>
						</span>

%						if (scalar @sites > 0) {
							<span class="fifth nospace">
								<select
									name="site_<% $jpool->id %>"
									class="fixedsmall"
								>
%									foreach my $site (@sites) {
										<option value="<% $site->id %>"
											<% $site->id == $jpool->site->id
												? 'selected="selected"' : "" %>
										><% $site->name %></option>
%									}
								</select>
							</span>
%						}

						<span class="twenty nospace rightalign">
%							my $warn = "Really delete the pool ".$jpool->name." and all round and judge assignments?";
							<a
								class="buttonwhite fa fa-sm fa-trash redtext hover"
								tabindex = -1
								href="jpool_rm.mhtml?jpool_id=<% $jpool->id %>&category_id=<% $category_id %>"
								<& "/funclib/confirm.mas", warn => $warn &>  >
							</a>
						</span>

						<div
							class="<% $jpool_settingsref->{$jpool->id}{"show_judges"} ? "" : "hidden" %> full nospace ltbordertop"
							id   ="show_judges_ts_<% $jpool->id %>"
						>

							<span class="third semibold bluetext rightalign padless">
								Message/instructions for judges:
							</span>

							<span class="twothirds centeralign padless">
								<input
									type  = "text"
									size  = "72"
									name  = "message_<% $jpool->id %>"
									value = "<% $jpool->setting("message") %>"
								>
							</span>
						</div>
					</div>
%				}
%			}

			<div class="liblrow rightalign">
				<input type="submit" value=" Save Pools">
			</div>

%		}

	</div>
