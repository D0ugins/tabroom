<%args>
	$tourn
	$tourn_settings
	$person
	$perms
</%args>
<%init>

	Tab::Category->set_sql( nats => "
		select category.*
			from category, category_setting
		where category.tourn = ?
			and category.id = category_setting.category
			and category_setting.tag = 'nats_category'
	");

	my $category = Tab::Category->search_nats($tourn->id)->first;

	unless ($category) {
		$m->comp("/funclib/abort.mas",
			message => "No NSDA Nationals Main category found"
		);
	}

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			jpool.id, jpool.name, parent.name,
			registrant.value, rounds.value, target.value,
			round.name, event.abbr,
			count(judge.id)

		from (jpool)

			left join jpool parent on parent.id = jpool.parent
			left join jpool_setting registrant on registrant.jpool = jpool.id and registrant.tag = 'registrant'
			left join jpool_setting rounds on rounds.jpool = jpool.id and rounds.tag = 'rounds'
			left join jpool_setting target on target.jpool = jpool.id and target.tag = 'target'

			left join jpool_round jpr on jpr.jpool = jpool.id
			left join round on round.id = jpr.round
			left join event on round.event = event.id

			left join jpool_judge jpj on jpj.jpool = jpool.id
			left join judge on judge.id = jpj.judge and judge.active = 1

		where jpool.category = ?

		group by jpool.id
		order by registrant.value DESC, jpool.parent, jpool.name

	");

	$sth->execute($category->id);

</%init>

	<div class="main">

	<h2><% $category->name %></h2>

	<& "tabbar.mas",
		category => $category,
		nsda     => $tourn_settings->{'nsda_nats'},
		whoami   => "pool_counts"
	&>

	<& "/funclib/tablesorter.mas", table => "jpool_count" &>

	<span class="threequarters nospace">
		<h4>Judge Pool Counts</h4>
	</span>
	<span
		id="jpool_count_buttonarea"
		class='quarter rightalign'
	></span>

	<table id ="jpool_count">

		<thead>

			<tr class="yellowrow">
				<th>
					Pool
				</th>

				<th>
					Reg
				</th>

				<th>
					Counts
				</th>

				<th>
					Parent
				</th>

				<th>
					Event
				</th>

				<th>
					Round
				</th>

				<th>
					Target
				</th>

				<th>
					Judges
				</th>

			</tr>

		</thead>

		<tbody>
<%perl>

		while (
			my (
				$jpool_id, $jpool_name, $jpool_parent,
				$registrant_value, $rounds_value, $target_value,
				$round_name, $event_abbr, $judge_count
			) = $sth->fetchrow_array()
		) {

			next unless $jpool_id;
</%perl>
			<tr>
				<td>
					<% $jpool_name ? $jpool_name : $jpool_id %>
				</td>

				<td class="centeralign">
					<% $registrant_value ? "Y" : "" %>
				</td>

				<td class="centeralign">
					<% $rounds_value %>
				</td>

				<td>
					<span class="hidden"><% $jpool_parent ? $jpool_parent."Z" : $jpool_name."A" %>></span>
					<% $jpool_parent ? $jpool_parent : "" %>
				</td>

				<td class="centeralign">
					<% $event_abbr %>
				</td>

				<td class="centeralign">
					<% $round_name %>
				</td>

				<td class="rightalign">
					<% $target_value %>
				</td>

				<td class="rightalign">
					<% $judge_count %>
				</td>
			</tr>
%		}

		</tbody>

	</table>

	</div>

	<script>

		$(document).ready(function() {
			console.log("hellow");
			zebraRows();
		});

	</script>
