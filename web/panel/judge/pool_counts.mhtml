<%args>
	$tourn
	$tourn_settings
	$person
</%args>
<%init>

	my $category;

	foreach my $cat ($tourn->categories) {
		next unless $cat->setting('nats_category');
		$category = $cat;
		last if $category;
	}

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			jpool.id, jpool.name, parent.name,
			registrant.value, rounds.value,
			round.name, event.abbr,
			count(judge.id)

		from (jpool)

		left join jpool parent on parent.id = jpool.parent
		left join jpool_setting registrant on registrant.jpool = jpool.id and registrant.tag = 'registrant'
		left join jpool_setting rounds on rounds.jpool = jpool.id and rounds.tag = 'rounds'

		left join jpool_round jpr on jpr.jpool = jpool.id
		left join round on round.id = jpr.round
		left join event on round.event = event.id

		left join jpool_judge jpj on jpj.jpool = jpool.id
		left join judge on judge.id = jpj.judge and judge.active = 1

		where jpool.category = ?

		group by jpool.id
		order by jpool.name

	");

	$sth->execute($category->id);

</%init>

	<div class="main">

	<& "tabbar.mas",
		category => $category,
		nsda     => $tourn_settings->{'nsda_nats'},
		whoami   => "pool_counts"
	&>

	<& "/funclib/tablesorter.mas", table => "jpools" &>

	<span class="threequarters">
		<h4>Judge Pool Counts</h4>
	</span>
	<span
		id="jpools_buttonarea"
		class='quarter rightalign'
	></span>

	<table id ="jpools">

		<thead>

			<tr class="yellowrow">

				<th>
					Pool
				</th>

				<th>
					Reg
				</th>

				<th>
					Rnds
				</th>

				<th>
					Parent
				</th>

				<th>
					Event
				</th>

				<th>
					Round
				</th>

				<th>
					Judges
				</th>

			</tr>

		</thead>

		<tbody>

<%perl>

		while (
			my (
				$jpool_id, $jpool_name, $jpool_parent,
				$registrant_value, $rounds_value,
				$round_name, $event_abbr, $judge_count
			) = $sth->fetchrow_array()
		) {

</%perl>

			<tr id="<% $jpool_id %>">

				<td>
					<% $jpool_name %>
				</td>

				<td class="centeralign">
					<% $registrant_value ? "Y" : "" %>
				</td>

				<td class="centeralign">
					<% $rounds_value %>
				</td>

				<td>
					<span class="hidden"><% $jpool_parent ? $jpool_parent."Z" : $jpool_name."A" %>></span>
					<% $jpool_parent ? $jpool_parent : "Master Pool" %>
				</td>

				<td>
					<% $event_abbr %>
				</td>

				<td class="centeralign">
					<% $round_name %>
				</td>

				<td class="rightalign">
					<% $judge_count %>
				</td>

			<tr>
%		}

		</tbody>

	</table>

	</div>
