<%args>
	$tourn
	$tourn_settings
	$person
	$jpool_id         => undef
	$category_id      => undef
	$pull_category_id => undef
	$only_category    => undef
</%args>
<%init>

	my $jpool = Tab::JPool->retrieve($jpool_id);
	my $category = Tab::Category->retrieve($category_id);

	$category = $only_category if $only_category;
	$m->abort unless $category;

	my @sites = $m->comp('/funclib/tourn_sites.mas', tourn => $tourn);
	my @timeslots = $tourn->timeslots;

	my %category_settings = $category->all_settings();

	@timeslots = $m->comp(
		"/funclib/category_timeslots.mas", 
		category => $only_category
	) if $only_category;

	@timeslots = 
		sort {$a->start->epoch <=> $b->start->epoch} 
		$tourn->timeslots;

	my $ncfl++ if $tourn_settings->{"ncfl"};

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	unless ($jpool) { 
		my @jpools = $category->jpools;
		$jpool = shift @jpools if @jpools;
	}

	my %rating = ();

</%init>

	<& "menu.mas",
		tourn         => $tourn,
		category      => $category,
		whoami        => "jpool",
		jpool         => $jpool,
		only_category => $only_category
	&>

	<div class="main">

%		unless ($category) { 

			<h2>Choose a judge category at right</h2>
	
%		} elsif (not defined $jpool)  { 

			<h2><% $category->name %></h2>
			
			<& tabbar.mas,
				category => $category, 
				whoami => "jpools"
			&>

			<h4>Choose a jpool at right</h4>

%		} else {

			<h2><% $category->name %></h2>
			
			<& tabbar.mas, 
				category => $category,
				whoami   => "jpools"
			&>

			<form action="jpool.mhtml#judges" method="post">

			<input 
				type  = "hidden"
				name  = "jpool_id"
				value = "<% $jpool->id %>"
			>

			<input 
				type  = "hidden"
				name  = "category_id"
				value = "<% $category->id %>"
			>

			<div class="even full nospace padbottom">

				<span class="half">
					<h4>Judges for <% $jpool->name %></h4>
				</span>

%				unless ($only_category) { 

					<span class="half rightalign nospace">

						<span class="half nospace">
							Pull from
						</span>

						<span class="half nospace">

							<select 
								name     = "pull_category_id"
								onchange = 'this.form.submit()'
								class    = "fixedsmall chosen"
							>

%								foreach my $category ($tourn->categories) { 
									<option 
										value="<% $category->id %>" 
										<% $category->id == $pull_category_id ? "selected" : "" %>
									>
										<% $category->name %>
									</option>
%								} 
							</select>

						</span>

					</span>
%				} 

				</form>

			</div>

<%perl>

			my @jpool_judges = $m->comp(
				"/funclib/jpool_judges.mas", 
				jpool    => $jpool,
				inactive => 1
			);

			my $no_codes = $category_settings{"no_codes"};
			my $ask_parli = $category_settings{"ask_parli"};
			my $prefs = $category_settings{"prefs"};
			my $tab_ratings = $category_settings{"tab_ratings"};
			my $coach_ratings = $category_settings{"coach_ratings"};

			undef $prefs if $prefs eq "none";

			my $pull_category = Tab::Category->retrieve($pull_category_id) 
				if $pull_category_id;

			$pull_category = $category unless $pull_category;

			my %category_count = ();
			my %used = ();

</%perl>


			<span class = "pagehalf padtop" >

				<span class="threequarters nospace">
					<h4>
						<span 
							class="inline" 
							id="incount"
						>
							<% scalar @jpool_judges %>
						</span>
						in pool
					</h4>
				</span>

				<span 
					id = "insort_buttonarea"
					class="quarter rightalign nospace"
				>
				</span>

				<& "/funclib/tablesorter.mas", table => "insort" &>

				<table id="insort" >

					<thead>

						<tr class="yellowrow smallish">

%						unless ($no_codes) { 
							<th>
								Code
							</th>
%						}

%						if ($ask_parli) { 
							<th>
								P
							</th>
%						}
	
						<th>
							First
						</th>

						<th>
							Last
						</th>

%						if ($prefs) { 
							<th title="Average Pref">
								AP
							</th>
%						}

%						if ($coach_ratings) { 
							<th title="Coach Ratings">
								CR
							</th>
%						}
%						if ($tab_ratings) { 
							<th title="Tab Ratings">
								TR
							</th>
%						}

%						if ($tourn_settings->{"nsda_nats"}) { 

							<th title="State">
								S
							</th>

							<th title="District">
								D
							</th>

							<th title="Round Obligation">
								Ob
							</th>

%						} elsif ( $tourn_settings->{"ncfl"} 
%							|| $tourn_settings->{"regions"} 
%						) { 
							<th>
								D
							</th>
%						}

							<th>
								School
							</th>

						</tr>

					</thead>

					<tbody id="in">
<%perl>
					foreach my $judge (@jpool_judges) { 

						my $hidden = "lirdrow" unless $judge->active;

						$used{$judge->id}++;
						$category_count{$judge->category->id}++;

</%perl>

						<tr
							class   = "judge <% $hidden %> smallish hover"
							id      = "<% $judge->id %>"
							onClick = "togglePool(this);"
						>

%							unless ($no_codes) { 
								<td>
									<% $judge->code %>
								</td>
%							}

%							if ($ask_parli) { 
								<td>
									<% $judge->parli ? "P" : "" %>
								</td>
%							}
	
							<td class="cellmax nowrap">
								<% $judge->first %>
							</td>

							<td class="cellmax nowrap">
								<% $judge->last %>
							</td>

%							if ($prefs eq "ordinals") { 
								<td>
									<% $judge->percentile %>
								</td>
%							} elsif ($prefs) { 
								<td>
									<% $judge->avg %>
								</td>
%							} 

%							if ($coach_ratings) { 
								<td>
									<% $judge->coach_rating %>
								</td>
%							}

%							if ($tab_ratings) { 
								<td>
									<% $judge->tab_rating %>
								</td>
%							}


%							if ($tourn_settings->{"nsda_nats"}) { 

								<td class="centeralign">
									<% $judge->state %>
								</td>

								<td class="rightalign">
									<% $judge->districtcode %>
								</td>

								<td class="rightalign">
									<% ($judge->obligation + $judge->hired) %>
								</td>


%							} elsif ( $tourn_settings->{"ncfl"} 
%								|| $tourn_settings->{"regions"} 
%							) { 

								<td>
									<% $judge->regioncode %>
								</td>

%							}

							<td 
								class="cellmax nowrap"
								title="<% $judge->schoolname %>"
							>
								<% Tab::short_name($judge->schoolname) %>
							</td>

						</tr>
%					}

					</tbody>

				</table>

			</span>

			<span class = "pagehalf padtop">

<%perl>
			if ($pull_category) { 

				my @judges = $m->comp(
					"/funclib/category_judges.mas", 
					category => $pull_category
				);

				my $no_codes = $category_settings{"no_codes"};
				my $ask_parli = $category_settings{"ask_parli"};
				my $prefs = $category_settings{"prefs"};
				my $tab_ratings = $category_settings{"tab_ratings"};
				my $coach_ratings = $category_settings{"coach_ratings"};

				undef $prefs if $prefs eq "none";

</%perl>

				<span class="threequarters nospace">
					<h4>
						<span class="inline" id="outcount">
							<% scalar @judges %>
						</span>
						available:
					</h4>
				</span>

				<span 
					id = "outsort_buttonarea"
					class="quarter rightalign nospace"
				>
				</span>

				<& "/funclib/tablesorter.mas", table => "outsort" &>

				<table id="outsort">

					<thead>

						<tr class="yellowrow smallish">

%						unless ($no_codes) { 
							<th>
								Code
							</th>
%						}

%						if ($ask_parli) { 
							<th>
								P
							</th>
%						}
	
						<th>
							First
						</th>

						<th>
							Last
						</th>

%						if ($prefs) { 
							<th title="Average Pref">
								AP
							</th>
%						}

%						if ($coach_ratings) { 
							<th title="Coach Ratings">
								CR
							</th>
%						}
%						if ($tab_ratings) { 
							<th title="Tab Ratings">
								TR
							</th>
%						}

%						if ($tourn_settings->{"nsda_nats"}) { 

							<th title="State">
								S
							</th>

							<th title="District">
								D
							</th>

							<th title="Round Obligation">
								O
							</th>

%						} elsif ( $tourn_settings->{"ncfl"} 
%							|| $tourn_settings->{"regions"} 
%						) { 
							<th>
								D
							</th>
%						}

							<th>
								School
							</th>

						</tr>

					</thead>

					<tbody id="out">

<%perl>
					foreach my $judge (@judges) { 

						my $hidden = "lirdrow" unless $judge->active;

						next if $used{$judge->id};

</%perl>

						<tr
							class   = "judge <% $hidden %> smallish hover"
							id      = "<% $judge->id %>"
							onClick = "togglePool(this);"
						>

%							unless ($no_codes) { 
								<td>
									<% $judge->code %>
								</td>
%							}

%							if ($ask_parli) { 
								<td>
									<% $judge->parli ? "P" : "" %>
								</td>
%							}
	
							<td class="cellmax nowrap">
								<% $judge->first %>
							</td>

							<td class="cellmax nowrap">
								<% $judge->last %>
							</td>

%							if ($prefs) { 
								<td>
									<% $judge->avg %>
								</td>
%							} 

%							if ($coach_ratings) { 
								<td>
									<% $judge->coach_rating %>
								</td>
%							}


%							if ($tab_ratings) { 
								<td>
									<% $judge->tab_rating %>
								</td>
%							}

%							if ($tourn_settings->{"nsda_nats"}) { 

								<td class="centeralign">
									<% $judge->state %>
								</td>

								<td class="rightalign">
									<% $judge->distcode %>
								</td>

								<td class="rightalign">
									<% ($judge->obligation + $judge->hired)  %>
								</td>

%							} elsif ( $tourn_settings->{"ncfl"} 
%								|| $tourn_settings->{"regions"} 
%							) { 

								<td>
									<% $judge->regcode %>
								</td>

%							}

							<td class="cellmax nowrap"
								title="<% $judge->schname %>"
							>
								<% Tab::short_name($judge->schname) %>
							</td>

						</tr>
%					}

					</tbody>

				</table>
%			}

			</span>
%		}

	</div>


		<script type="text/javascript">

			$(document).ready( function(){
				countPools();
			});

			function countPools() { 

				var countIn = $("#in .judge:visible").length;
				var countOut = $("#out .judge:visible").length;

				$("#outcount").text(countOut);
				$("#incount").text(countIn);

				$("#insort").trigger("applyWidgets");
				$("#insort").trigger("update");
				$("#insort").trigger('resort');

				$("#outsort").trigger("applyWidgets");
				$("#outsort").trigger("update");
				$("#outsort").trigger('resort');

			}

			function togglePool(judgeSpan) { 

				var parentID = $(judgeSpan).closest("tbody").attr("id");

				var judgeID = $(judgeSpan).attr("id");

				var postValue, newParent;

				console.log("Parent is "+parentID);

				if (parentID === "in") { 

					postValue = 0;
					newParent = "out";

				} else { 

					postValue = 1;
					newParent = "in";

				}

				$.ajax({
					url: 'jpool_judge_switch.mhtml',
					type: 'POST',
					data: { 
						judge_id : judgeID,
						value    : postValue,
						jpool_id : "<% $jpool->id %>"

					}, success: function(data) { 

						if (data.error) { 
							
							alertify.error(data.message);

						} else { 

							console.log("new parentID is "+newParent);
						
							alertify.set('notifier','delay', 2);
							alertify.notify(data.message, "custom");
							alertify.set('notifier','delay', 5);

							$("#"+judgeID).prependTo("#"+newParent)

						}

						countPools();
					}

				});
			}

		</script>
