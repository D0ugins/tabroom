<%args>
	$tourn
	$tourn_settings
	$perms
	$session
	$defaults => undef
	$event_id      => undef
	$jpool_id      => undef
	$category_id   => undef
	$only_category => undef
</%args>
<%init>

	my $nocodes;

	my ($event, $eventsref,
		$category, $categoriesref,
		$jpool, $jpoolsref, $jpool_settingsref,
		$childrenref) = $m->comp("pools.mas",
			tourn       => $tourn,
			session     => $session,
			defaults    => $defaults,
			nsda_nats   => $tourn_settings->{"nsda_nats"},
			perms       => $perms,
			jpool_id    => $jpool_id,
			event_id    => $event_id,
			category_id => $category_id,
		);

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @judges;
	my %judge_rounds = ();
	my %judge_unique_rounds = ();

	my $rounds_per;
	my %judges;

	if ($category) {

		my $dbh = Tab::DBI->db_Main();

		my $sth = $dbh->prepare("

			select
				judge.id, judge.code, judge.first, judge.last, judge.obligation, judge.hired, judge.active,
				event.abbr, event.id, event.tourn,
				school.name, school.code, school.id,
				region.name, region.code, region.id,
				district.name, district.code, district.id,
				panel.id, panel.letter, panel.flight,
				room.name, room.id,
				round.name, round.label, round.start_time, round.timeslot, round.flighted

			from (judge)

			left join school on school.id = judge.school
			left join region on school.region = region.id
			left join district on school.district = district.id

			left join ballot on ballot.judge = judge.id
			left join panel on ballot.panel  = panel.id
			left join round on panel.round   = round.id
			left join event on round.event   = event.id
			left join room on room.id        = panel.room

			where judge.category = ?
			order by ballot.judge, round.name, panel.flight
		");

		$sth->execute($category->id);

		my %dts;

		while(
			my(
				$judge_id, $judge_code, $judge_first, $judge_last,
					$judge_obligation, $judge_hired, $judge_active,
				$event_abbr, $event_id, $event_tourn,
				$school_name, $school_code, $school_id,
				$region_name, $region_code, $region_id,
				$district_name, $district_code, $district_id,
				$panel_id, $panel_letter, $panel_flight,
				$room_name,
				$room_id,
				$round_name, $round_label, $round_start_time, $timeslot_id, $flighted
			) = $sth->fetchrow_array()
		) {

			next if $event_tourn != $tourn;

			$judges{$judge_id}{"first"} = $judge_first;
			$judges{$judge_id}{"last"} = $judge_last;
			$judges{$judge_id}{"code"} = $judge_code;
			$judges{$judge_id}{"active"} = $judge_active;
			$judges{$judge_id}{"obligation"} = $judge_obligation + $judge_hired;

			$judges{$judge_id}{"school_name"} = $school_name;
			$judges{$judge_id}{"school_code"} = $school_code;
			$judges{$judge_id}{"region_name"} = $region_name;
			$judges{$judge_id}{"region_code"} = $region_code;
			$judges{$judge_id}{"district_name"} = $district_name;
			$judges{$judge_id}{"district_code"} = $district_code;

			next unless $panel_id;

			$judges{$judge_id}{"panels"}{$panel_id}{"letter"} = $panel_letter;
			$judges{$judge_id}{"panels"}{$panel_id}{"flight"} = $panel_flight if $flighted > 1;
			$judges{$judge_id}{"panels"}{$panel_id}{"round"} = $round_name;
			$judges{$judge_id}{"panels"}{$panel_id}{"room"} = $room_name;
			$judges{$judge_id}{"panels"}{$panel_id}{"event"} = $event_abbr;

			my $dt = $dts{$round_start_time};

			unless ($dt) {
				$dt = DateTime::Format::MySQL->parse_datetime($round_start_time);
				$dt->set_time_zone("UTC");
				$dt->set_time_zone($tz);
				$dts{$round_start_time} = $dt;
			}

			$judges{$judge_id}{"panels"}{$panel_id}{"start"} = $dt->epoch;
			$judges{$judge_id}{"panels"}{$panel_id}{"start_time"} = Tab::shorttime($dt);

			if ($round_label) {
				$judges{$judge_id}{"panels"}{$panel_id}{"round_name"} = $round_label;
			} else {
				$judges{$judge_id}{"panels"}{$panel_id}{"round_name"} = "R".$round_name;
			}
		}

		my @standbys = $m->comp(
			"/funclib/category_standbys.mas",
			category => $category,
			type     => "time"
		);
	}

</%init>

	<& menu.mas,
		tourn             => $tourn,
		perms             => $perms,
		category          => $category,
		whoami            => "chart",
		only_category     => $only_category,
		tourn_settings    => $tourn_settings,
		eventsref         => $eventsref,
		childrenref       => $childrenref,
		categoriesref     => $categoriesref,
		jpoolsref         => $jpoolsref,
		jpool_settingsref => $jpool_settingsref,
	&>

	<div class="main">

%		if ($category) {

			<& "/funclib/tablesorter.mas",
				table => "judges"
			&>

			<h2><% $category->name %></h2>

			<& tabbar.mas,
				category => $category,
				event    => $event,
				jpool    => $jpool,
				whoami   => "chart"
			&>

			<table id="judges">

				<thead>

					<tr class="yellowrow">

						<th class="smaller">
							<% $nocodes ? "Code" : "Sch" %>
						</th>

						<th class="smaller">
							First
						</th>

						<th class="smaller">
							Last
						</th>

						<th class="smaller">
							Assignments
						</th>

%						if ($rounds_per) {
							<th class="smaller">
								Obli
							</th>
%						}

						<th class="smaller">
							Rds
						</th>

					</tr>

				</thead>

				<tbody>

%				foreach my $judge_id (sort {$judges{$a}{"last"} cmp $judges{$b}{"last"}} keys %judges) {

					<tr>

						<td class="smaller centeralign nowrap">
							<% $judges{$judge_id}{"school_code"} %>
							<% $nocodes ? "" : $judges{$judge_id}{"code"} %>
						</td>

						<td class="smallish nospace">
							<a class="white" href="/register/judge/edit.mhtml?judge_id=<% $judge_id %>">
								<% $judges{$judge_id}{"first"} %>
							</a>
						</td>

						<td class="smallish">
							<a class="white" href="/register/judge/edit.mhtml?judge_id=<% $judge_id %>">
								<% $judges{$judge_id}{"last"} %>
							</a>
						</td>

						<td class="nospace">
%							unless ($judges{$judge_id}{"active"}) {
								<span class="redtext semibold third padleft padvertmore">
									Inactive
								</span>
%							}
%							if ($judges{$judge_id}{"special"}) {
								<span class="bluetext semibold third padleft padvert">
									<% $judges{$judge_id}{"special"} %>
								</span>
%							}

<%perl>

							my @panel_ids = keys %{$judges{$judge_id}{"panels"}};

							@panel_ids =
								sort {$judges{$judge_id}{"panels"}{$a}{"start"} cmp
									$judges{$judge_id}{"panels"}{$b}{"start"} }
									@panel_ids;

							@panel_ids =
								sort {$judges{$judge_id}{"panels"}{$a}{"flight"} <=>
									$judges{$judge_id}{"panels"}{$b}{"flight"} }
									@panel_ids;

							my $panel_count = scalar @panel_ids;
</%perl>

%							foreach my $panel_id (@panel_ids) {

								<span class="third smallish padless ltborder centeralign">

									<a
										class="white nospace hover"
										href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel_id %>"
									>
										<span class="full nospace padvertless">
											<% $judges{$judge_id}{"panels"}{$panel_id}{"start_time"} %>
											&ndash;
											<% $judges{$judge_id}{"panels"}{$panel_id}{"event"} %>
											&ndash;
											<% $judges{$judge_id}{"panels"}{$panel_id}{"round_name"} %>
											&ndash;
											S<% $judges{$judge_id}{"panels"}{$panel_id}{"letter"} %>
											<% $judges{$judge_id}{"panels"}{$panel_id}{"flight"}
												?  "&ndash; F".$judges{$judge_id}{"panels"}{$panel_id}{"flight"}
												: ""
											%>
										</span>
										<span class="full nospace padvertless smaller">
											<% $judges{$judge_id}{"panels"}{$panel_id}{"room"}
												? "In" : "" %>
											<% $judges{$judge_id}{"panels"}{$panel_id}{"room"} %>
										</span>

									</a>

								</span>
%							}
						</td>

%						if ($rounds_per) {
							<td class="smallish centeralign">
								<% $judges{$judge_id}{"obligation"} %>
							</td>
%						}

						<td class="smallish centeralign">
							<% $panel_count %>
						</td>

					</tr>
%				}

				</tbody>

			</table>

%		}

	</div>

