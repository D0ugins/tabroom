<%args>
	$tourn
	$tourn_settings
	$perms
	$event_id      => undef
	$jpool_id      => undef
	$category_id   => undef
	$only_category => undef
</%args>
<%init>

	my $nocodes;

	my ($event, $eventsref,
		$category, $categoriesref, 
		$jpool, $jpoolsref, $jpool_settingsref, 
		$childrenref) = $m->comp("pools.mas", 
			tourn       => $tourn,
			nsda_nats   => $tourn_settings->{"nsda_nats"},
			perms       => $perms,
			jpool_id    => $jpool_id,
			event_id    => $event_id,
			category_id => $category_id,
		);

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @judges;
	my %judge_rounds = ();
	my %judge_unique_rounds = ();

	my $rounds_per;

	if ($category) { 

		@judges = sort {$a->last cmp $b->last} $category->judges;
		$nocodes++ if $category->setting("no_codes");

		my @rooms = $m->comp(
			"/funclib/category_rooms.mas", 
			category => $category);

		my @panels = $m->comp(
			"/funclib/category_panels.mas", 
			category => $category,
			by_judge => 1
		);

		my @rounds = $m->comp(
			"/funclib/category_rounds.mas", 
			category => $category
		);

		my @ballots = $m->comp(
			"/funclib/category_ballots.mas", 
			category => $category
		);

		my @standbys = $m->comp(
			"/funclib/category_standbys.mas", 
			category => $category,
			type     => "time"
		);

		my @timeslots = $m->comp(
			"/funclib/category_timeslots.mas",
			category => $category
		);

		my %timeslot_start = ();

		foreach my $timeslot (@timeslots) { 
			$timeslot_start{$timeslot->id} = 
				Tab::shorttime($timeslot->start->set_time_zone($tz));
		}

		my %round_label = ();
		foreach my $round (sort {$a->name <=> $b->name} @rounds) { 
			$round_label{$round->id} = $round->name."-".$timeslot_start{$round->timeslot->id};
		}

		my %room_name = ();
		foreach my $room (@rooms) { 
			$room_name{$room->id} = $room->name;
		}

		my %panel_label = ();
		my %panel_round = ();

		foreach my $panel (@panels) { 
			$panel_round{$panel->id} = $panel->round->id;
			$panel_label{$panel->id} = 
				'<a class="white" href="/panel/schemat/panel_view.mhtml?panel_id='.$panel->id.'">'.
			$round_label{$panel->round->id}." ".$panel->eventname." in ".$room_name{$panel->room}."</a>";
		}

		my %used;

		foreach my $ballot (@ballots) { 
			next if $used{$ballot->panel->id."-".$ballot->judge->id};
			push @{$judge_rounds{$ballot->judge->id}}, $panel_label{$ballot->panel->id};
			$used{$ballot->panel->id."-".$ballot->judge->id}++;
			push @{$judge_unique_rounds{$ballot->judge->id}}, $panel_round{$ballot->panel->id};

		}

		foreach my $standby (@standbys) { 
			push @{$judge_rounds{$standby->judge->id}}, "Standby at ".$timeslot_start{$standby->jpool->setting("standby_timeslot")};
		}

	 	$rounds_per = $category->setting("rounds_per");

	}

	foreach my $judge (@judges) { 
	}

</%init>

	<& menu.mas,
		tourn             => $tourn,
		perms             => $perms,
		category          => $category,
		whoami            => "chart",
		only_category     => $only_category,
		tourn_settings    => $tourn_settings,
		eventsref         => $eventsref,
		categoriesref     => $categoriesref,
		jpoolsref         => $jpoolsref,
		jpool_settingsref => $jpool_settingsref,
	&>

	<div class="main">

%		if ($category) { 
	
			<& /funclib/tablesorter.mas, 
				table => "sortable_table"
			&>

			<h2><% $category->name %></h2>
			
			<& tabbar.mas, 
				category => $category,
				event    => $event,
				jpool    => $jpool,
				whoami   => "chart"
			&>

			<table id="sortable_table">

				<thead>

					<tr class="yellowrow">

						<th class="smaller">
							<% $nocodes ? "Code" : "Sch" %>
						</th>

						<th class="smaller">
							First
						</th>

						<th class="smaller">
							Last
						</th>

						<th class="smaller">
							Assignments
						</th>

%						if ($rounds_per) { 
							<th class="smaller">
								Obli
							</th>
%						}

						<th class="smaller">
							Rds
						</th>

					</tr>

				</thead>

				<tbody>

%				foreach my $judge (@judges) { 
		
%					my %uniq;
%					my @things = grep { ! $uniq{$_}++ } @{$judge_unique_rounds{$judge->id}};

					<tr <% $judge->active ? "" : 'class="liblrow"' %>>

						<td class="smaller centeralign nowrap">
							<% $judge->school->code %> <% $nocodes ? "" : $judge->code %>
						</td>

						<td class="smallish">
							<a class="white" href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>">
							<% $judge->first %>
							</a>
						</td>

						<td class="smallish">
							<a class="white" href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>">
							<% $judge->last %>
							</a>
						</td>

						<td>
%							foreach my $string (@{$judge_rounds{$judge->id}}) {
								<span class="third smallish nospace">
									<% $string %>
								</span>
%							}
							<% $judge->active ? "" : "Inactive" %>
							<% $judge->setting('special_job') ? "(".$judge->setting('special_job').")" : "" %>
						</td>

%						if ($rounds_per) { 
							<td class="smallish centeralign">
								<% $judge->obligation + $judge->hired %>
							</td>
%						}

						<td class="smallish centeralign">
							<% scalar @{$judge_rounds{$judge->id}} %><% scalar @things != scalar @{$judge_rounds{$judge->id}} ? "/".scalar @things : ""%>
						</td>

					</tr>
%				}

				</tbody>

			</table>

%		}

	</div>

