<%args>
	$tourn
	$perms
	$person
	$event_id   => undef
	$only_category => undef
	$category_id   => undef
</%args>
<%init>

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas", 
		tourn => $tourn,
		perms => $perms,
		type  => "admin"
	);

	my @events = @{$eventref};
	my @categories = @{$catref};

	my $category = Tab::Category->retrieve($category_id);
	$category = $categories[0] 
		if @categories && (not defined $category);

	my $event = Tab::Event->retrieve($event_id);
	$category = $event->category if $event && $event->category->id != $category->id;

	unless ($event || $category) { 
		$m->abort;
	}
	unless ($category->tourn->id == $tourn->id) { 
		$m->abort 
	}

</%init>

%	unless ($event) { 

		<& menu.mas, 
			tourn         => $tourn,
			perms         => $perms,
			category      => $category,
			whoami        => "event",
			only_category => $only_category
		&>

		<div class="main">

			<h2><% $category->name %></h2>

			<& tabbar.mas, 
				tourn    => $tourn,
				category => $category,
				whoami   => "event"
			&>

%	} else { 

		<& menu.mas, 
			tourn         => $tourn,
			perms         => $perms,
			category      => $category,
			event         => $event,
			whoami        => "event",
			only_category => $only_category
		&>

		<& "/funclib/tablesorter.mas", table => "event" &>

		<div class="main">

			<span class="twothirds nospace">
				<h2><% $category->name %></h2>
			</span>
			<span 
				id    = "event_buttonarea"
				class = "third nospace rightalign"
			></span>
		
			<& tabbar.mas, 
				tourn    => $tourn,
				category => $category,
				whoami   => "event"
			&>

			<h4><% $event->name %> Judge Settings</h4>

			<form action="event_save.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "event_id"
				value = "<% $event->id %>"
			>

			<table id="event">

				<thead>
				<tr class="yellowrow">

					<th class="smaller">
						Round
					</th>

					<th class="smaller">
						Flights
					</th>

					<th class="smaller">
						# Judges per panel
					</th>

					<th class="smaller">
						Judge pools
					</th>

				</tr>
				</thead>

				<tbody>

%					foreach my $round (sort {$a->name <=> $b->name} $event->rounds) { 

						<tr>

							<td class="smallish">
								<% $round->realname %>
							</td>

							<td class="centeralign">
								<input 
									name  = "flighted_<% $round->id %>"
									class = "smaller"
									type  = "number"
									min   = "1"
									max   = "99"
									size  = "3"
									value = "<% $round->flighted ? $round->flighted : 1 %>"
								>
							</td>

							<td class="centeralign">
								<input 
									name  = "judges_<% $round->id %>"
									class = "smaller"
									type  = "number"
									min   = "1"
									max   = "99"
									size  = "3"
									value = "<% $round->setting("num_judges") 
										? $round->setting("num_judges") : 1
									%>">
							</td>

							<td class="nospace">
%								my %used;
%								foreach my $jpool ($round->jpools) { 
%									$used{$jpool->id}++;
									<span class="half nospace borderbottom">
										<span class="threequarters semibold bluetext padvert padleft">
											<% $jpool->name %>
										</span>
										<span class="quarter nospace">
											<a 
												class="buttonwhite redtext fa fa-sm fa-trash" 
												href="jpool_round_rm.mhtml?jpool_id=<% $jpool->id %>&round_id=<% $round->id %>&event_id=<% $event->id %>"></a>
										</span>
									</span>
%								}

								<div class="centeralign">

								<select 
									name     = "jpool_<% $round->id %>"
									class    = "fixed chosen"
									onChange = "this.form.submit();"
								>
									<option value="">Limit to a judge pool:</option>
%									foreach my $jpool ($category->jpools) { 
%										next if $used{$jpool->id}++;
										<option value="<% $jpool->id %>">
											<% $jpool->name %>
										</option>
%									}

								</select>

								</div>
							</td>

						</tr>

%					}

				</tbody>

			</table>

			<div class="libl rightalign">

				<input 
					type="submit" 
					value="Save <% $event->abbr %> Judge Settings">
				</form>
			</div>

		</div>
%	}
