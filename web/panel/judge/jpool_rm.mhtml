<%args>
	$jpool_id
	$person
</%args>
<%init>

	my $jpool = Tab::JPool->retrieve($jpool_id);
	my $now = DateTime->now();

	Tab::JPoolRound->set_sql( delete_jpool => " delete from jpool_round where jpool = ? ");
	Tab::JPoolJudge->set_sql( delete_jpool => " delete from jpool_judge where jpool = ? ");

	my $msg;
	my $category_id;

	if ($jpool) { 

		Tab::JPoolJudge->sql_delete_jpool->execute($jpool->id);
		Tab::JPoolRound->sql_delete_jpool->execute($jpool->id);
		$msg = $jpool->name." has been deleted";

		my $category = $jpool->category;
		$category_id = $category->id;

		$jpool->delete;

		Tab::ChangeLog->create({ 
			type        => 'tabbing',
			tourn       => $category->tourn->id,
			person      => $person->id,
			created     => $now,
			description => $msg
		}); 

	}

	$m->redirect("edit_jpools.mhtml?category_id=$category_id&msg=$msg");


</%init>
