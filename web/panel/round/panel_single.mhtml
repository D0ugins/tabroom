<%args>
	$tourn
	$person
	$round_id 
</%args>
<%init>

	use POSIX;

	my $round = Tab::Round->retrieve($round_id) if $round_id;

	unless ($round) { 
		$m->comp("/funclib/abort.mas", 
			err => "No valid round ID sent."
		);
	}

	my $event = $round->event;

	my $previous_round = Tab::Round->search( 
		name => ($round->name - 1), 
		event => $event->id
	)->first;
	
	my %event_settings = $event->all_settings();

	unless ($event->type eq "speech" 
		|| $event->type eq "congress"
	) { 
		$m->comp("/funclib/abort.mas", 
			err => "Sorry, this is really intended for speech events only"
		);
	}

	my $section = "sections" if $event->type eq "speech";
	$section = "chambers" if $event->type eq "congress";

	my $minpanelsize = $event_settings{"min_panel_size"};
	$minpanelsize = 5 unless $minpanelsize;

	my $maxpanelsize = $event_settings{"max_panel_size"};
	$maxpanelsize = 8 unless $maxpanelsize;

	my $defaultpanelsize = $event_settings{"default_panel_size"};
	$defaultpanelsize = 6 unless $defaultpanelsize;

	my $num_competitors = scalar $event->entries( 
		active => 1,
		dq     => 0
	);

	my $max_panel_number = ceil($num_competitors / $minpanelsize);
	my $min_panel_number = ceil($num_competitors / $maxpanelsize);

	$defaultpanelsize = ceil($num_competitors / $min_panel_number) 
			if ($num_competitors / $minpanelsize) < $min_panel_number;

	$defaultpanelsize = ceil($num_competitors / $min_panel_number) 
		if $min_panel_number 
		&& (($num_competitors / $min_panel_number) < $min_panel_number);

</%init>

	<div class="main">

		<h2>Panel <% $round->realname %> of <% $event->abbr %></h2>
		
		<form 
			action = "panel_master.mhtml"
			method = "post"
		>

			<input 
				type    = "hidden"
				id      = "room_<% $event->id %>"
				name    = "room_<% $event->id %>"
				value   = "1"
			>

			<input 
				type    = "hidden"
				name    = "round_id"
				value   = "<% $round->id %>"
			>

			<div class="full lightodd">

				<span class="pagehalf nospace">

					<div class="full nospace">

						<span class="twofifths strong rightalign top padless">
							Round Type
						</span>

						<span class="threefifths">

							<% $round->type eq "snaked_prelim" 
								? "Power-protected prelim" 
								: "" 
							%>

							<% $round->type eq "prelim" 
								? "Randomly assigned prelim" 
								: ""
							%>

						</span>

					</div>

					<div class="full nospace">

						<span class="twofifths strong rightalign top padless">
							Competitors
						</span>

						<span class="threefifths">
							<% $num_competitors %>
						</span>

					</div>

				</span>

				<span class="pagehalf">

					<div class="full nospace">

						<span class="fourtenths strong rightalign top padless">
							Section Sizes
						</span>

						<span class="half top nospace">

							<div class="full nospace">

								<span class="half leftalign">
									Default
								</span>
								<span class="half leftalign">
									<% $defaultpanelsize %>
								</span>

							</div>

							<div class="full nospace">

								<span class="half leftalign">
									Minimum
								</span>
								<span class="half leftalign">
									<% $minpanelsize %>
								</span>

							</div>

							<div class="full nospace">

								<span class="half leftalign">
									Maximum
								</span>
								<span class="half leftalign">
									<% $maxpanelsize %>
								</span>

							</div>

						</span>

					</div>

				</span>

			</div>

			<div class="full martopmore">

				<span class="third nospace">
					<h4>
						Options
					</h4>
				</span>

				<span class="twothirds rightalign strong nospace">

%					if ($previous_round) { 
						<h6>
							<% $previous_round->realname %>
							had 
							<% scalar($previous_round->panels) %>
							<% $section %>
						</h6>
%					}

				</span>

			</div>

			<div class="lightrow">

%				if ($event->type eq "congress" && $previous_round) { 

					<span class="quarter strong padtopmore padbottommore padleft">
						<% scalar $previous_round->panels %> chambers <% $previous_round->realname %>.
					</span>
					<span class="threequarters">
						Congress chambers will be copied over exactly session to session.  <br />
						To change the number of chambers, erase existing sessions. 
					</span>

%				} else { 

					<span class="quarter strong rightalign top martopmore marbottommore">
						Number of <% $section %>
					</span>

					<span class="threequarters">

<%perl>

						my $last_panel_size;

						foreach my $num_panels ($min_panel_number .. $max_panel_number) {

							next unless $num_panels > 0;

							my $panel_size = ceil($num_competitors/$num_panels);

							my $competitors_if_panels_full = $num_panels * $panel_size;

							my $num_short_panels = $competitors_if_panels_full - $num_competitors;

							my $num_full_panels = $num_panels - $num_short_panels;
								
							next if $num_short_panels < 0 
								|| $num_full_panels <= 0; 
							
							$defaultpanelsize = $panel_size 
								if ($last_panel_size > $defaultpanelsize && $panel_size < $defaultpanelsize); 
								
							$last_panel_size = $panel_size;

</%perl>

							<label for="num_panels_<% $round->id %>_<% $num_panels %>">

								<span class="sixth hover centeralign nospace padtopless padbottomless">

									<input 
										type  = "radio"
										name  = "num_panels_<% $round->id %>"
										id    = "num_panels_<% $round->id %>_<% $num_panels %>"
										value = "<% $num_panels %>"
										<% ($panel_size == $defaultpanelsize) ? 'checked' : '' %>
									>

									<%$num_panels %>

								</span>

							</label>

%						}

					</span>

%					if ($event->type eq "congress") { 
						<div class="full bordertop">

							<span class="threetenths strong martopmore marbottommore">
								Wipe existing chambers?
							</span>

%							my $warn = "This will delete all existing chambers and reassign students.  You sure now?";

							<label for="wipe">
								<span class="eighth hover centeralign">
									<input
										type  = "checkbox"
										name  = "wipe"
										id    = "wipe"
										value = "1"
										<& "/funclib/confirm.mas", warn => $warn &>
									>
								</span>
							</label>

						</div>
%					}

%				}

			</div>

			<div class="libl nospace">

				<span class="seveneighths">

				</span>

				<span class="eighth padtopmore marno">
					<input 
						type="submit" 
						value="Section"
					>
				</span>
			<div>

		</form>

	</div>

