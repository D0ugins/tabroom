<%args>
	$tourn
	$person
	$round_id 
</%args>
<%init>

	use POSIX;

	my $round = Tab::Round->retrieve($round_id) if $round_id;

	unless ($round) { 
		$m->comp("/funclib/abort.mas", 
			err => "No valid round ID sent."
		);
	}

	my $event = $round->event;
	
	my %event_settings = $event->all_settings();

	unless ($event->type eq "speech") { 
		$m->comp("/funclib/abort.mas", 
			err => "Sorry, this is really intended for speech events only"
		);
	}

	my $minpanelsize = $event_settings{"min_panel_size"};
	$minpanelsize = 5 unless $minpanelsize;

	my $maxpanelsize = $event_settings{"max_panel_size"};
	$maxpanelsize = 8 unless $maxpanelsize;

	my $defaultpanelsize = $event_settings{"default_panel_size"};
	$defaultpanelsize = 6 unless $defaultpanelsize;

	my $num_competitors = scalar $event->entries( active => 1, dq => 0);

	my $max_panel_number = ceil($num_competitors / $minpanelsize);
	my $min_panel_number = ceil($num_competitors / $maxpanelsize);

	$defaultpanelsize = ceil($num_competitors / $min_panel_number) 
			if ($num_competitors / $minpanelsize) < $min_panel_number;

	$defaultpanelsize = ceil($num_competitors / $min_panel_number) 
		if $min_panel_number 
		&& (($num_competitors / $min_panel_number) < $min_panel_number);

</%init>

	<div class="main">

		<h2>Panel <% $round->realname %> of <% $event->abbr %></h2>
		
		<form 
			action="panel_master.mhtml" 
			method="post"
		>

			<input 
				type    = "hidden"
				id      = "room_<% $event->id %>"
				name    = "room_<% $event->id %>"
				value   = "1"
			>

			<input 
				type    = "hidden"
				name    = "round_id"
				value   = "<% $round->id %>"
			>

			<div class="lightrow padmuchmore">

				<span class="rightalign quarter semibold">
					Active Competitors: 
				</span>

				<span class="eighth">
					<% $num_competitors %>
				</span>

				<span class="quarter rightalign semibold">
					Round Type:
				</span>

				<span class="threeeighths">
					<% $round->type eq "snaked_prelim" ? "Power-protected prelim" : "" %>
					<% $round->type eq "prelim" ? "Randomly assigned prelim" : "" %>
				</span>
			</div>

			<div class="lightrow padmuchmore">

				<span class="quarter semibold rightalign">
					Section Sizes:
				</span>

				<span class="quarter centeralign">
					Minimum: <% $minpanelsize %>
				</span>

				<span class="quarter centeralign">
					Maximum: <% $maxpanelsize %>
				</span>

				<span class="quarter centeralign">
					Default: <% $defaultpanelsize %>
				</span>


			</div>

			<div class="lightrow">

				<span class="quarter semibold rightalign">
					Number of sections:
				</span>

				<span class="threequarters nospace">
<%perl>

				my $last_panel_size;

				foreach my $num_panels ($min_panel_number .. $max_panel_number) {

					next unless $num_panels > 0;

   					my $panel_size = ceil($num_competitors/$num_panels);
   					my $competitors_if_panels_full = $num_panels * $panel_size;
					my $num_short_panels = $competitors_if_panels_full - $num_competitors;
					my $num_full_panels = $num_panels - $num_short_panels;
						
					next if $num_short_panels < 0 or $num_full_panels <= 0; 
					
					$defaultpanelsize = $panel_size 
						if ($last_panel_size > $defaultpanelsize && $panel_size < $defaultpanelsize); 
						
					$last_panel_size = $panel_size;

</%perl>

					<label for="num_panels_<% $event->id %>_<% $num_panels %>">

						<span class="sixth hover centeralign nospace">

							<input 
								type  = "radio"
								name  = "num_panels_<% $event->id %>"
								id    = "num_panels_<% $event->id %>_<% $num_panels %>"
								value = "<% $num_panels %>"
								<% ($panel_size == $defaultpanelsize) ? 'checked' : '' %>
							><%$num_panels %>
						</span>
					</label>

%				}

				</span>

			</div>

			<div class="libl nospace">

				<span class="seveneighths">

				</span>

				<span class="eighth padtopmore marno">
					<input 
						type="submit" 
						value="Section"
					>
				</span>
			<div>

		</form>

	</div>

