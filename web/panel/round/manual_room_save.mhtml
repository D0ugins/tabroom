<%args>
	$room_id
	$panel_id
	$round_id
	$flight => 1
</%args>
<%init>

    $m->clear_buffer;
    $r->content_type('application/json');

	my $panel = Tab::Panel->retrieve($panel_id);
	return unless $panel;

	my $room = Tab::Room->retrieve($room_id);
	my $dbh = Tab::DBI->db_Main();

	my $round = $panel->round;
	my $event = $round->event;
	my @ties;
	my $ids;

	if ($event->type eq "congress") {

		@ties = $m->comp("/funclib/congress_ties.mas", round => $round);
		$ids = "(";

		my $notfirst;
		foreach my $tie (@ties) {
			$ids .= ", " if $notfirst++;
			$ids .= $tie->id;
		}
		$ids .= ")";

	} else {
		$ids = "(".$round->id.")";
	}

	my $origin_panel;
	my $origin_room  = $panel->room;

	if ($room) {
		$origin_panel = $round->panels(flight => $flight, room => $room->id )->first;
	}

	my $room_sth = $dbh->prepare("
		update panel set room = ?
			where letter = ?
			and round in $ids
	");

	my $msg;

	if ($room && $panel) {
		$room_sth->execute($room, $panel->letter);
		$msg .= "Section ".$panel->letter." moved to ".$room->name;
	} elsif ($panel) {
		$room_sth->execute(0, $panel->letter);
		$msg .= "<br>Section ".$panel->letter." room removed";
	}

	if ($origin_panel && $origin_room) {
		$room_sth->execute($origin_room, $origin_panel->letter);
		$msg .= "<br>Section ".$origin_panel->letter." moved to ".$origin_room->name;
	} elsif ($origin_panel) {
		$room_sth->execute(0, $origin_panel->letter);
		$msg .= "<br>Section ".$origin_panel->letter." room removed";
	}

	$dbh->disconnect();

    $m->print('{
        "error"        : false,
        "message"      : "'.$msg.'",
        "origin_panel" : "'.$origin_panel.'",
        "origin_room"  : "'.$origin_room.'"
    }');

    $m->abort();

</%init>
