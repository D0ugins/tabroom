<%args>
	$tourn
	$tourn_settings
	$round_id        => undef
	$tiebreak_set_id => undef
	$exclude         => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id) 
		if $round_id
		&& $round_id == int($round_id);

	unless ($round) { 
		$m->comp(
			"/funclib/abort.mas", 
			message => "No valid round found for ID $round_id"
		);
	}

	my $event = $round->event;

	my $tiebreak_set;

	$tiebreak_set = Tab::TiebreakSet->retrieve($tiebreak_set_id) 
		if $tiebreak_set_id;

	my (@results) = $m->comp(
		"/tabbing/results/order_entries.mas",
		round        => $round,
		tiebreak_set => $tiebreak_set
	);

	my $entries_ref = pop @results if @results;

    my %entry_ballots = $m->comp(
		"/funclib/round_ballot_strings.mas",
			round => $round
		);

    my %entry_by_id = 
        map {$_->id => $_} $event->entries();

	my @vacate_slots = $m->comp(
		"/funclib/event_entry_settings.mas",
		event => $event,
		tag   => "nsda_vacate"
	);

	my %vacated = map {$_->entry->id => $_->value } @vacate_slots;

	my @priorities = $m->comp(
		"/funclib/event_entry_settings.mas",
		event => $event,
		tag   => "nsda_priority"
	);

	my %priorities = map {$_->entry->id => $_->value } @priorities;

    my @tiebreak_keys =
		sort {$a <=> $b}
		keys %{$entries_ref->{"tier_description"}};

    my @ineligibles = $m->comp(
		"/funclib/event_entry_settings.mas",
		event => $event,
		tag   => "no_elims"
	); 
	
	my %ineligible = map {$_->entry->id => $_->value} @ineligibles;

	my %existing_rounds = map {$_->timeslot->id => 1} $event->rounds();

</%init>

	<div class="main">

		<h4><% $round->realname %>: Runoffs to break ties</h4>

		<form 
			action = "runoffs_schedule.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "round_id"
			value = "<% $round->id %>"
		>

		<div class="row">

			<span class="eighth semibold">
				During:
			</span>

			<span class="twotenths centeralign ">

				<select name="timeslot_id" class="fixedsmall">
%					foreach my $timeslot ($tourn->timeslots) { 
%						next if $existing_rounds{$timeslot->id};
						<option 
							value="<% $timeslot->id %>"
						><% $timeslot->name %></option>
%					}
				</select>

			</span>

			<span class="sixth nospace semibold">
				Or, new timeslot:
			</span>

			<span class="sixth semibold centeralign">
				<select name="new_day" class="fixedtiny inline">
				</select>
			</span>

			<span class="sixth semibold">
				From:
			</span>

			<span class="sixth semibold">
				To:
			</span>

<%perl>

			my $runoff_tb_set;

			if ($tourn_settings->{"nsda_district"}) {

				if ($event->type eq "speech") { 

					$runoff_tb_set = Tab::TiebreakSet->search(
						tourn => $tourn->id,
						name => "Speech Runoffs"
					)->first;

					unless ($runoff_tb_set) { 

						$runoff_tb_set = Tab::TiebreakSet->create({
							tourn => $tourn->id,
							name  => "Speech Runoffs"
						});

						Tab::Tiebreak->create({
							tiebreak_set => $runoff_tb_set->id,
							name         => "ranks",
							count        => "previous",
							priority     => 1
						});

					}

				} else { 

					$runoff_tb_set = Tab::TiebreakSet->search(
						tourn => $tourn->id,
						name => "Debate Elim"
					)->first;

					unless ($runoff_tb_set) { 
						$runoff_tb_set = Tab::TiebreakSet->search(
							tourn => $tourn->id,
							name => "Debate Elims"
						)->first;
					}

					unless ($runoff_tb_set) { 
						$runoff_tb_set = Tab::TiebreakSet->search(
							tourn => $tourn->id,
							name => "Debate Runoffs"
						)->first;
					}

					unless ($runoff_tb_set) { 

						$runoff_tb_set = Tab::TiebreakSet->create({
							tourn => $tourn->id,
							name  => "Speech Runoffs"
						});

						Tab::Tiebreak->create({
							tiebreak_set => $runoff_tb_set->id,
							name         => "ranks",
							count        => "previous",
							priority     => 1
						});

					}

				}

			} else { 

</%perl>
				<span class="quarter semibold">
					Tiebreakers:
				</span>

				<span class="quarter centeralign">
					<select name="tiebreak_set_id" class="fixedmed">
%						foreach my $tiebreak_set ($tourn->tiebreak_sets()) { 
							<option 
								value="<% $tiebreak_set->id %>"
							><% $tiebreak_set->name %></option>
%						}
					</select>
				</span>
%			}

		</div>

<%perl>

		if (${$entries_ref}{"by_place"}) {

			foreach my $key ( sort {$a <=> $b} keys %{${$entries_ref}{"by_place"}}) {

				next unless (scalar @{${${$entries_ref}{"by_place"}}{$key}}) > 1;

				my @tied;

				ENTRY:
				foreach my $entry_id (@{${${$entries_ref}{"by_place"}}{$key}}) {

					next if $exclude && $exclude->{$entry_id};
					next if $vacated{$entry_id};

					push @tied, $entry_id;
				}

				next unless scalar @tied > 1;
</%perl>

				<h6 class="martop semibold">Tie for <% $key %>:</h6>

				<table>

					<tr class="yellowrow semibold">

						<td>
							Entry
						</td>

%						if ($tourn_settings->{"nsda_district"}) {
							<td>
								Entry Priority
							</td>
%						}

%                       foreach my $key (@tiebreak_keys) {
                            <th class="smallish">
                                <span title="<% ${$entries_ref}{"tier_long_description"}{$key} %>">
                                    <% ${$entries_ref}{"tier_description"}{$key} %>
                                </span>
                            </th>
%                       }

						<td>
							Runoff?
						</td>

					</tr>

%					foreach my $entry_id (@tied) { 
			
						<tr class="row">

							<td> 
								<% $entries_ref->{"code"}{$entry_id} %>
							</td>

%							if ($tourn_settings->{"nsda_district"}) {
								<td class="smallish centeralign">
									<% $priorities{$entry_id} %>
								</td>
%							}

<%perl>

							foreach my $key (@tiebreak_keys) {

								my $value = ${$entries_ref}{"tiebreak"}{$key}{$entry_id};

								$value =~ s/\.(?:|.*[^0]\K)0*\z//;

								$value = sprintf("%.2f", $value)
									unless ${$entries_ref}{"tier_description"}{$key} eq "Rk"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Win"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Prev Win"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Rnds"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Loss"
									|| ${$entries_ref}{"tier_description"}{$key} eq "PO Pt"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Dwn"
									|| ${$entries_ref}{"tier_description"}{$key} eq "CDwn"
									|| ${$entries_ref}{"tier_description"}{$key} eq "H2H"
									|| ${$entries_ref}{"tier_description"}{$key} eq "JP"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Bal";

</%perl>				
								<td class="smallish nowrap rightalign">
									<% $value %>
								</td>

%							}

							<td class="centeralign">
								<input 
									type  = "checkbox"
									name  = "<% $key %>_<% $entry_id %>"
									value = "1"
								>
							</td>
		
						</tr>

%					}

				</table>
%			}

%		}

	</div>

