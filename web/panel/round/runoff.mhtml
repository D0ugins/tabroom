<%args>
	$tourn
	$tourn_settings
	$round_id        => undef
	$tiebreak_set_id => undef
	$exclude         => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id) 
		if $round_id
		&& $round_id == int($round_id);

	unless ($round) { 
		$m->comp(
			"/funclib/abort.mas", 
			message => "No valid round found for ID $round_id"
		);
	}

	my $event = $round->event;

	my $final = $event->rounds(type => "final")->first;

	unless ($final) { 
		my @rounds = 
			sort {$b->name cmp $a->name} $event->rounds();

		$final = $rounds[0];
	}

	my $runoff;
	$runoff = $final->runoff if $final;

	my %already_entries = 
		map {$_->id => $_}
		$m->comp("/funclib/round_entries.mas", 
			round => $runoff
		) if $runoff;

	my $now = DateTime->now();
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $tiebreak_set;

	$tiebreak_set = Tab::TiebreakSet->retrieve($tiebreak_set_id) 
		if $tiebreak_set_id;

	my (@results) = $m->comp(
		"/tabbing/results/order_entries.mas",
		round        => $round,
		tiebreak_set => $tiebreak_set
	);

	my $entries_ref = pop @results if @results;

    my %entry_ballots = $m->comp(
		"/funclib/round_ballot_strings.mas",
			round => $round
		);

    my %entry_by_id = 
        map {$_->id => $_} $event->entries();

	my @vacate_slots = $m->comp(
		"/funclib/event_entry_settings.mas",
		event => $event,
		tag   => "nsda_vacate"
	);

	my %vacated = map {$_->entry->id => $_->value } @vacate_slots;

	my @priorities = $m->comp(
		"/funclib/event_entry_settings.mas",
		event => $event,
		tag   => "nsda_priority"
	);

	my %priorities = map {$_->entry->id => $_->value } @priorities;

    my @tiebreak_keys =
		sort {$a <=> $b}
		keys %{$entries_ref->{"tier_description"}};

    my @ineligibles = $m->comp(
		"/funclib/event_entry_settings.mas",
		event => $event,
		tag   => "no_elims"
	); 
	
	my %ineligible = map {$_->entry->id => $_->value} @ineligibles;

	my %existing_rounds = map {$_->timeslot->id => 1} $event->rounds();

</%init>

	<div class="main">

		<h4><% $round->realname %>: Runoffs to break ties</h4>

		<form 
			action = "runoff_schedule.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "round_id"
			value = "<% $round->id %>"
		>

		<div class="row">

			<span class="eighth semibold">
				During:
			</span>

			<span class="twotenths centeralign">

				<select name="timeslot_id" class="fixedsmall">
%					foreach my $timeslot ($tourn->timeslots) { 
%						next if $existing_rounds{$timeslot->id};
						<option 
							value="<% $timeslot->id %>"
							<% $runoff && $runoff->timeslot->id == $timeslot->id 
								? "selected" 
								: ""
							%>
						><% $timeslot->name %></option>
%					}
				</select>

			</span>

			<span class="sixth nospace semibold nowrap rightalign">
				New timeslot:
			</span>

			<span class="sixth centeralign">
				<select name="new_day" class="fixedsmallest inline">

					<option 
						value="<% $now->mdy('/') %>"
					><%
						substr($now->day_name, 0, 3) 
					%> <% 
						$now->month %>/<% $now->day 
					%></option>

%					foreach my $day ($m->comp("/funclib/tourn_days.mas", tourn => $tourn)) { 

						<option 
							value = "<% $day->mdy('/') %>"
						><% 
							substr($day->day_name,0, 3) 
						%> <%
							$day->month."/".$day->day 
						%></option>
%					}
				</select>
			</span>

<%perl>

			$now->set_time_zone($tz);

			my $start = $now->clone();
			my $end = $now->clone();


			$start->add(minutes => 15);
			$end->add(minutes => 15, hours => 2);

			my $minutes = $start->minute;
			$minutes = Math::Round::nearest(5, $minutes);
			$minutes = 0 if $minutes > 55;

			$start->set(minute => $minutes);
			$end->set(minute => $minutes);

</%perl>

			<span class="third nospace">

				<span class="nospace half">
					<span class="inline padleft semibold">
						From:
					</span>

					<& "/funclib/timepicker.mas", 
						name => "new_start_time",
						size => 7,
						time => $start
					&>
				</span>

				<span class="nospace half">

					<span class="inline padleft semibold">
						To:
					</span>

					<& "/funclib/timepicker.mas", 
						name => "new_end_time",
						size => 7,
						time => $end
					&>

				</span>
			</span>

		</div>

%		unless ($tourn_settings->{"nsda_district"}) { 

			<div class="row full marno">

				<span class="quarter semibold">
					Tiebreakers:
				</span>

				<span class="threequarters centeralign">
					<select name="runoff_tbset_id" class="fixedmed">
%						foreach my $tiebreak_set ($tourn->tiebreak_sets()) { 
							<option 
								value="<% $tiebreak_set->id %>"
								<% $runoff && $runoff->tiebreak_set->id == $tiebreak_set->id 
									? "selected"
									: "" 
								%>
							><% $tiebreak_set->name %></option>
%						}
					</select>
				</span>
			</div>

%		}

<%perl>

		if (${$entries_ref}{"by_place"}) {

			foreach my $key ( sort {$a <=> $b} keys %{${$entries_ref}{"by_place"}}) {

				next unless (scalar @{${${$entries_ref}{"by_place"}}{$key}}) > 1;

				my @tied;

				ENTRY:
				foreach my $entry_id (@{${${$entries_ref}{"by_place"}}{$key}}) {

					next if $exclude && $exclude->{$entry_id};
					next if $vacated{$entry_id};

					push @tied, $entry_id;
				}

				next unless scalar @tied > 1;
</%perl>

				<h6 class="martop semibold">Tie for <% $key %>:</h6>

				<table>

					<tr class="ltyellow semibold">

						<td>
							Entry
						</td>

%						if ($tourn_settings->{"nsda_district"}) {
							<td class="smallish">
								Nationals Single-Entry Priority
							</td>
%						}

%                       foreach my $key (@tiebreak_keys) {
                            <th class="smallish">
                                <span title="<% ${$entries_ref}{"tier_long_description"}{$key} %>">
                                    <% ${$entries_ref}{"tier_description"}{$key} %>
                                </span>
                            </th>
%                       }

						<td>
							Runoff?
						</td>

					</tr>

%					my $first++; 

%					foreach my $entry_id (@tied) { 
			
						<tr class="row">

							<td class="nospace"> 
								<span class="marno full padleftmore padvertmore">
								<% $entries_ref->{"code"}{$entry_id} %>
								</span>
							</td>

%							if ($tourn_settings->{"nsda_district"}) {
%								my $es = Tab::EntryStudent->search( entry => $entry_id )->first;
								<td class="smallish centeralign">
									<% $priorities{$es->student->id}{$entry_id} %>
								</td>
%							}

<%perl>

							foreach my $key (@tiebreak_keys) {

								my $value = ${$entries_ref}{"tiebreak"}{$key}{$entry_id};

								$value =~ s/\.(?:|.*[^0]\K)0*\z//;

								$value = sprintf("%.2f", $value)
									unless ${$entries_ref}{"tier_description"}{$key} eq "Rk"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Win"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Prev Win"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Rnds"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Loss"
									|| ${$entries_ref}{"tier_description"}{$key} eq "PO Pt"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Dwn"
									|| ${$entries_ref}{"tier_description"}{$key} eq "CDwn"
									|| ${$entries_ref}{"tier_description"}{$key} eq "H2H"
									|| ${$entries_ref}{"tier_description"}{$key} eq "JP"
									|| ${$entries_ref}{"tier_description"}{$key} eq "Bal";

</%perl>				
								<td class="smallish nowrap centeralign">
									<% $value %>
								</td>

%							}

%							if ($first) { 

%								undef $first;
								<td
									class="odd centeralign nospace <% $already_entries{$entry_id} ? "borderredthin" : "" %>
									" 
									rowspan="<% scalar @tied %>">

%									 if ($already_entries{$entry_id}) { 

										<span class="semibold redtext">
											Already <br />Scheduled!
										</span>

%									} else { 
										<label for="<% $key %>">
											<span class="padvertmore full hover">
												<input 
													type  = "checkbox"
													class = "bigger"
													name  = "<% $key %>"
													id    = "<% $key %>"
													value = "1"
												>
											</span>
										</label>
%									}
								</td>
%							}
		
						</tr>

%					}

				</table>
%			}

			<span class="full libl rightalign marno">
				<input 
					type  = "submit"
					value = "Schedule runoffs"
				>
			</span>

			</form>

%		}

	</div>

