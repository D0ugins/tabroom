<%args>
	$tourn
	$tourn_settings
	$person
	$round_id
	$next    => undef
	$default => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id);
	$m->abort unless $round;

	my $previous_round;

	if ($next) { 

		$previous_round = $round;

		my $next_round = Tab::Round->search(
			event => $previous_round->event->id,
			name  => ($round->name + 1)
		)->first;

		if ($next_round > 0) { 

			$round = $next_round;
			undef $next;

		} else { 
			undef $round;
		}
		
	} else  { 

		$previous_round = Tab::Round->search(
			event => $round->event->id,
			name  => ($round->name - 1)
		)->first;
	}

	my $event = $previous_round->event if $previous_round;
	$event = $round->event unless $event || (not defined $round);

	$m->abort unless $event;
	$m->abort unless $event->tourn == $tourn;

	my %event_settings = $event->all_settings;
	my %round_settings = $round->all_settings;

	my @panels = $round->panels if $round;

	my @tabs;
	my $entries_ref;

	if ($previous_round) { 

		my @results = $m->comp(
			"/tabbing/results/order_entries.mas",
			round => $previous_round, 
		) if $previous_round;

		$entries_ref = pop @results if @results;
		push @tabs, "results";

	}

	push @tabs, "create";

	if (@panels && scalar @panels > 0) { 
		push @tabs, "checks";
	}

	unless ($default) { 
		$default = "checks" if (@panels && scalar @panels > 0);
		$default = "create";
	}

</%init>

	<& 	"menu.mas",
		round          => $round,
		event          => $event,
		round_settings => \%round_settings,
		event_settings => \%event_settings
	&>

	<div class="main">

		<div class="full nospace">

			<span class="half nospace">
				<h2><% $next ? "Create Next Round" : $round->realname %></h2>
			</span>

			<span class="half rightalign nospace">
				<h2><% $event->abbr %></h2>
			</span>

		</div>

%		unless (scalar @tabs < 2) { 
			<& 
				"/funclib/tabs.mas", 
				tabs    => \@tabs,
				default => $default
			&>
%		}

%		if ($round->name > 1) { 

			<div 
				id    = "results"
				class = "results screens"
			>
				<h4>Previous Round Results</h4>

				<& "/tabbing/results/results_table.mas", round => $previous_round &>

			</div>
%		}

		<div 
			id    = "create"
			class = "create screens"
		>

%		if (next) { 

			<h4>Create next round</h4> 

%		} else { 

			<h4>Section <% $round->realname %></h4>

			<form 
				action = "/panel/round/panel_master.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				name  = "round_id"
				value = "<% $round->id %>"
			>

			<input 
				type  = "hidden"
				name  = "whoami"
				value = "doubledown.mhtml"
			>

%			if (@panels) { 

				<div class="lightrow">

					<div class="full warning centeralign">
						This round has already been sectioned!
					</div>

					<span class="threequarters rightalign">
						Type "I am certain" to confirm deleting existing
						sections and creating new ones:
					</span>

					<span class="quarter">
						<input 
							type           = "text"
							size           = '16'
							name           = "certain"
							autocomplete   = "off"
							autocorrect    = "off"
							autocapitalize = "off"
							spellcheck     = "false"
						>
					</span>
				</div>
%			}
%		}

<%perl>

			my $num_entries = scalar $event->entries( active => 1 );

			my $minpanelsize = $event_settings{"min_panel_size"};
			$minpanelsize = 4 unless $minpanelsize;

			my $maxpanelsize = $event_settings{"max_panel_size"};
			$maxpanelsize = 7 unless $maxpanelsize;

			my $defaultpanelsize = $event_settings{"default_panel_size"};
			$defaultpanelsize = 6 unless $defaultpanelsize;

			my $max_panel_number = POSIX::ceil($num_entries / $minpanelsize);

			my $min_panel_number = POSIX::ceil($num_entries / $maxpanelsize);

			$defaultpanelsize = POSIX::ceil($num_entries / $min_panel_number) 
				if ($num_entries / $minpanelsize) < $min_panel_number;

			$defaultpanelsize = POSIX::ceil($num_entries / $min_panel_number) 
				if $min_panel_number 
				&& (($num_entries / $min_panel_number) < $min_panel_number);

</%perl> 

			<div class="full martopmore">

				<span class="third">
					<h5>
						Create sections:
					</h5>
				</span>

				<span class="twothirds rightalign">

					<span class="nospace quarter">
						Section sizes:
					</span>

					<span class="nospace quarter">
						Minimum: <% $minpanelsize %> 
					</span>

					<span class="nospace quarter">
						Default: <% $defaultpanelsize %> 
					</span>

					<span class="nospace quarter">
						Maximum: <% $maxpanelsize %> 
					</span>

				</span>

			</div>

			<div class="full lightrow nospace">

				<span class="tenth">
					<% $round->realname %>
				</span> 
				
				<span class="centeralign eighth">
					<% $num_entries %> entries
				</span> 
				
				<span class="centeralign tenth">
					<% ucfirst($round->type) %>
				</span>

				<span class="centeralign eighth">
					# Sections:
				</span>

             	<span class="twofifths">
<%perl>
					my $last_panel_size;

					foreach my $num_panels ($min_panel_number .. $max_panel_number) {

						next unless $num_panels > 0;

						my $panel_size = POSIX::ceil($num_entries/$num_panels);
						my $entries_if_panels_full = $num_panels * $panel_size;
						my $num_short_panels = $entries_if_panels_full - $num_entries;
						my $num_full_panels = $num_panels - $num_short_panels;

						next if $num_short_panels < 0 or $num_full_panels <= 0;

						$defaultpanelsize = $panel_size
							if $last_panel_size > $defaultpanelsize
							&& $panel_size < $defaultpanelsize;

						$last_panel_size = $panel_size;

</%perl>

						<label for="num_panels_<% $num_panels %>_<% $round->id %>">

							<span class="fifth hover marno padleft padright">

								<input 
									type  = "radio"
									name  = "num_panels_<% $round->id %>"
									id    = "num_panels_<% $num_panels %>_<% $round->id %>"
									value = " <% $num_panels %> "
									<% ($panel_size == $defaultpanelsize) ? 'checked' : '' %>
								>

									<% $num_panels %>
							</span>

						</label>

%					}

					</span>

					<span class="eighth">
						<input 
							type  = "submit"
							value = "Create"
							class = "thin"
						>
					</span>

				</div>

			</form>

		</div>

%		if (@panels) { 

			<div 
				id    = "checks"
				class = "checks screens"
			>

				<& "checks.mas", 
					round => $round,
					tourn => $tourn,
					person => $person	

				&>

			</div>

%		}

	</div>
