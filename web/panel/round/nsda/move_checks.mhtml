<%args>
	$person
	$tourn
	$entry_id     => undef
	$panel_marker => undef
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;

	my ($panel_id, $speaks) = split(/_/, $panel_marker) if $panel_marker;

	my $panel = Tab::Panel->retrieve($panel_id) if $panel_id;


	Tab::Ballot->set_sql( round_and_entry => "
		select distinct ballot.*
		from ballot, panel
		where ballot.entry = ? 
		and ballot.panel = panel.id
		and panel.round = ? 
	");

	unless ($panel && $entry) { 

		my $err = "No panel or entry found for that combo.  Please refresh page and start again";

	} else { 

		my $msg = "I think you tried to move ".$entry->code." into marker $panel_marker";
		$msg .= " which is section ".$panel->letter." speaker ".$speaks;

		my $round = $panel->round;
		my $err;

		foreach my $ballot (
			Tab::Ballot->search_round_and_entry($entry->id, $round->id)
		) { 

			if ($ballot->audit) { 
				$err = "These ballots have scores! ";
				$err .= "Please use the entry screen interfaces to make changes
				because you can do some serious damage here!";

			} else { 

				Tab::debuglog("Deleted ballot $ballot");
				$ballot->delete;

			}

		}

		if ($err) { 

		} else { 

			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);

			my $ballot;

			if (@judges) { 

				foreach my $judge (@judges) {

					$ballot = Tab::Ballot->create({
						panel        => $panel->id,
						judge        => $judge->id,
						entry        => $entry->id,
						speakerorder => $speaks
					});
				}

			} else { 

				$ballot = Tab::Ballot->create({
					panel        => $panel->id,
					judge        => 0,
					entry        => $entry->id,
					speakerorder => $speaks
				});

			}

			Tab::debuglog("Created ballot $ballot");

		}

	}

	return;

</%init>
