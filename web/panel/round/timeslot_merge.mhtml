<%args>
	$timeslot_id
	$on => undef
</%args>
<%init>

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id);

	if ($on) { 

		my @rounds = $timeslot->rounds;
		my $master = shift @rounds;

		foreach my $panel ($master->panels) { 
			$panel->score(0);
			$panel->update();
		}

		foreach my $round (@rounds) { 

			foreach my $panel ($round->panels) { 
				$panel->score($round->id);
				$panel->round($master->id);
				$panel->update();
			}

		}

		$m->redirect("/panel/schemat/show.mhtml?round_id=".$master->id."&default=schematic");

	} else { 

		my $last_round;

		foreach my $round ($timeslot->rounds) { 

			foreach my $panel ($round->panels) {

				if ($panel->score > 0) { 
					$panel->round($panel->score);
					$panel->score(0);
					$panel->update();
				} 
			}

			$last_round = $round;

		}

		$m->redirect("/panel/schemat/show.mhtml?round_id=".$last_round->id."&default=schematic");

	}

</%init>
