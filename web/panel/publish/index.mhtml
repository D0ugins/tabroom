<%args>
	$tourn
	$tourn_settings
	$timeslot_id => undef
	$event_id    => undef
</%args>
<%init>

	my @events = sort {
		$a->type cmp $b->type
		|| $a->abbr cmp $b->abbr
	} $tourn->events;

	my @timeslots = sort {
		$a->start->epoch <=> $b->start->epoch
		|| $a->name cmp $b->name
	} $tourn->timeslots;

	my %rounds;
	my $limit;

	if ($event_id) {
		$limit .= " and round.event = ".int($event_id);
	} elsif ($timeslot_id) {
		$limit .= " and round.timeslot = ".int($timeslot_id);
	} else {
		$event_id = $events[0]->id;
		$limit .= " and round.event = ".int($event_id);
	}

	if ($limit) {

		my $dbh = Tab::DBI->db_Main();
		my $sth = $dbh->prepare("
			select
				round.id, round.name, round.label,
				event.type,
				round.published, round.post_results,
				publish_prelim_chamber.value,
				publish_entry_list_no_byes.value,
				publish_entry_list.value,
				public_feedback.value,
				coach_wins.value,
				coach_points.value,
				coach_feedback.value
			from (round, event)

				left join round_setting publish_prelim_chamber
					on publish_prelim_chamber.round = round.id
					and publish_prelim_chamber.tag = 'publish_prelim_chamber'

				left join round_setting publish_entry_list_no_byes
					on publish_entry_list_no_byes.round = round.id
					and publish_entry_list_no_byes.tag = 'publish_entry_list_no_byes'

				left join round_setting publish_entry_list
					on publish_entry_list.round = round.id
					and publish_entry_list.tag = 'publish_entry_list'

				left join round_setting public_feedback
					on public_feedback.round = round.id
					and public_feedback.tag = 'public_feedback'

				left join round_setting coach_wins
					on coach_wins.round = round.id
					and coach_wins.tag = 'coach_wins'

				left join round_setting coach_points
					on coach_points.round = round.id
					and coach_points.tag = 'coach_points'

				left join round_setting coach_feedback
					on coach_feedback.round = round.id
					and coach_feedback.tag = 'coach_feedback'

			where round.event = event.id
			$limit
			order by round.name
		");

		$sth->execute();

</%init>

		<div class="main">

			<span class="third nospace">
				<h4>Mass Publish</h4>
			</span>
			<span
				class = "twothirds rightalign nospace"
				id    = "publish_buttonarea"
			>
			</span>

			<& "/funclib/tablesorter.mas", table => "publish" &>

			<table id="publish">
				<thead>
					<tr class="yellowrow">
						<th>
							Round
						</th>

						<th>
							Public Schematic
						</th>

						<th class = "centeralign"
							title = "Posts a list of entries advancing in this round, in code order"
						>
							Entry List
						</th>

						<th class="centeralign">
							<div class="full nospace">
								Coach Visible Results
							</div>
							<span class="third smallish centeralign nospace">
								Rk/W-L
							</span>
							<span class="third smallish centeralign nospace">
								Pts
							</span>
							<span class="third smallish centeralign nospace">
								Feedback
							</span>
						</th>

						<th class="centeralign" colspan="3">
							<div class="full nospace">
								Public Visible Results
							</div>
							<span class="third smallish centeralign nospace">
								Rk/W-L
							</span>
							<span class="third smallish centeralign nospace">
								Feedback
							</span>
							<span class="third smallish centeralign nospace">
								All
							</span>
						</th>
					</tr>
				</thead>

				<tbody>
<%perl>
					while (
						my (
							$id, $name, $label,
							$event_type,
							$publish, $post_results,
							$publish_prelim_chamber,
							$publish_entry_list_no_byes,
							$publish_entry_list,
							$public_feedback,
							$coach_wins,
							$coach_points,
							$coach_feedback
						) = $sth->fetchrow_array()
					) {

						my $public_wins;
						my $public_points;

						if ($post_results) {
							$public_wins = 1;
						}

						if ($post_results > 1) {
							$public_points = 1;
							$public_wins = 1;
							$public_feedback = 1;
						}
</%perl>
						<tr>

							<td class="fifth semibold bluetext centeralign">
								<div class="full padleft padvert">
									<% $name %> <% $label %>
								</div>
							</td>

							<td>
								<select
									target_id     = "<% $id %>"
									property_name = "published"
									onChange      = "postSwitch(this, 'publish_switch.mhtml');"
									class         = "fixedmed"
								>
									<option value="0"
										<% $publish ? "" : "selected" %>
									>Not Public</option>
									<option value="1"
										<% $publish == 1 ? "selected" : "" %>
									>Public</option>
									<option value="2"
										<% $publish == 2 ? "selected" : "" %>
									>Public w/o Judges</option>
%									if ($event_type eq "congress") {
										<option value="5"
											<% (not defined $publish) && $publish_prelim_chamber ? "selected" : "" %>
										>Show Entries Their Chambers</option>
%									}
								</select>
							</td>

							<td class="centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "publish_entry_list",
									value   => $publish_entry_list,,
									target  => $id,
									smaller => 1,
									url     => "publish_switch.mhtml"
								&>
							</td>

							<td class="centeralign">
								<span class="third smallish centeralign nospace">
									<& "/funclib/bool_switch.mas",
										tag     => "coach_wins",
										value   => $coach_wins,
										target  => $id,
										smaller => 1,
										url     => "publish_switch.mhtml"
									&>
								</span>
								<span class="third smallish centeralign nospace">
									<& "/funclib/bool_switch.mas",
										tag     => "coach_points",
										value   => $coach_points,
										target  => $id,
										smaller => 1,
										url     => "publish_switch.mhtml"
									&>
								</span>
								<span class="third smallish centeralign nospace">
									<& "/funclib/bool_switch.mas",
										tag     => "coach_feedback",
										value   => $coach_feedback,
										target  => $id,
										smaller => 1,
										url     => "publish_switch.mhtml"
									&>
								</span>
							</td>

							<td class="centeralign">
								<span class="third smallish centeralign nospace">
									<& "/funclib/bool_switch.mas",
										tag     => "public_wins",
										value   => $public_wins,
										target  => $id,
										smaller => 1,
										url     => "publish_switch.mhtml"
									&>
								</span>
								<span class="third smallish centeralign nospace">
									<& "/funclib/bool_switch.mas",
										tag     => "public_feedback",
										value   => $public_feedback,
										target  => $id,
										smaller => 1,
										url     => "publish_switch.mhtml"
									&>
								</span>
								<span class="third smallish centeralign nospace">
									<& "/funclib/bool_switch.mas",
										tag     => "public_points",
										value   => $public_points,
										target  => $id,
										smaller => 1,
										url     => "publish_switch.mhtml"
									&>
								</span>
							</td>
						</tr>
%					}
				</tbody>
			</table>

%			if ($event_id) {
%				my $event = Tab::Event->retrieve($event_id);


%			}


		</div>

%		$sth->finish();
%		$dbh->disconnect();

%	} else {
		<div class="main">
		</div>
%	}


	<div class="menu">

		<div class="sidenote">

			<h4>By Event</h4>

			<form action="index.mhtml" method="post">
				<div class="full even">
					<select
						name     = "event_id"
						class    = "fixedmost"
						onChange = "this.form.submit();";
					>
						<option value=""></option>
%						foreach my $event (@events) {
							<option
								value="<% $event->id %>"
								<% $event->id == $event_id ? "selected" : "" %>
							><% $event->abbr %></option>
%						}
					</select>
				</div>
			</form>

			<h4>Or, By Timeslot</h4>

			<form action="index.mhtml" method="post">
				<div class="full even">
					<select
						name     = "timeslot_id"
						class    = "fixedmost"
						onChange = "this.form.submit();";
					>
						<option value=""></option>
%						foreach my $timeslot (@timeslots) {
							<option
								value="<% $timeslot->id %>"
								<% $timeslot->id == $timeslot_id ? "selected" : "" %>
							><% $timeslot->name %></option>
%						}
					</select>
				</div>
			</form>
		</div>
	</div>
