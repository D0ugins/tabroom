<%args>
	$tourn
	$perms
	$category_id => undef
</%args>
<%init>

	$m->abort if $perms->{"detailed"};

	my $category = Tab::Category->retrieve($category_id) if $category_id;
	my @categories = sort {$a->name cmp $b->name} $tourn->categories;
	$category = $categories[0] if @categories &! $category;
	$category_id = $category->id if $category;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $switch;

</%init>

	<div class="main">

%		if ($category) {

			<& "/funclib/tablesorter.mas", table => "timeslots" &>

			<h2>Publish <% $category->name %> timeslots</h2>

			<table id="timeslots">

				<thead>

					<tr class="yellowrow">

						<th class="smaller centeralign padno">
							Timeslot
						</th>

						<th class="smaller centeralign padno">
							Starts
						</th>

						<th class="smaller">
							Private
						</th>

						<th class="smaller">
							Pub w/o Judge
						</th>

						<th class="smaller">
							Public
						</th>

						<th class="smaller">
							Results
						</th>

						<th class="smaller">
						</th>

						<th class="smaller">
						</th>

					</tr>

				</thead>

				<tbody>

<%perl>
				foreach my $timeslot ($m->comp("/funclib/category_timeslots.mas", category => $category)) {

					my @rounds = $timeslot->rounds;
					my @no;
					my @publish;
					my @nojudge;
					my @results;

					foreach my $round (@rounds) {
						push @no, $round if $round->published < 1 && $round->post_results < 1;
						push @publish, $round if $round->published == 1 && $round->post_results < 1;
						push @nojudge, $round if $round->published == 2 && $round->post_results < 1;
						push @results, $round if $round->post_results > 0;
					}

</%perl>

					<tr>

						<td class="smaller">
							<% $timeslot->name %>
						</td>

						<td class="smaller centeralign padno">
							<span class="hidden">
								<% $timeslot->start->epoch %>
							</span>
							<% Tab::nicetime($timeslot->start->set_time_zone($tz)) %>
						</td>

						<td class="smaller">
%							foreach my $no (@no) {
								<div>
									<% $no->event->abbr." ".$no->realname %>
								</div>
%							}
						</td>

						<td class="smaller">
%							foreach my $nojudge (@nojudge) {
								<div>
									<% $nojudge->event->abbr." ".$nojudge->realname %>
								</div>
%							}
						</td>
						<td class="smaller">
%							foreach my $publish (@publish) {
								<div>
								<% $publish->event->abbr." ".$publish->realname %>
								</div>
%							}
						</td>

						<td class="smaller">
%							foreach my $results (@results) {
								<div>
									<% $results->event->abbr." ".$results->realname %>
								</div>
%							}
						</td>

						<td class="smallish centeralign top">

							<a class="bluetext buttonwhite hover full thin martop"
							href="timeslot_save.mhtml?timeslot_id=<% $timeslot->id %>&category_id=<% $category_id %>">
								Publish All
							</a>

							<a class="bluetext buttonwhite hover full thin martop"
								href="timeslot_save.mhtml?timeslot_id=<% $timeslot->id %>&category_id=<% $category_id %>&entryonly=1">
								Publish w/o Judges
							</a>

							<a class="bluetext buttonwhite hover full thin martop"
							href="blast.mhtml?timeslot_id=<% $timeslot->id %>&category_id=<% $category_id %>&result=1">
								Blast All
							</a>

							<a class="bluetext buttonwhite hover full thin martop"
							href="timeslot_save.mhtml?timeslot_id=<% $timeslot->id %>&category_id=<% $category_id %>&result=1">
								Publish Results
							</a>
						</td>

						<td class="smallish centeralign top">

							<a class="redtext buttonwhite hover full thin martop"
							href="timeslot_save.mhtml?timeslot_id=<% $timeslot->id %>&category_id=<% $category_id %>&undo=1">
								Unpublish All
							</a>

							<br />
							<a class="redtext buttonwhite hover full thin martop"
							href="timeslot_save.mhtml?timeslot_id=<% $timeslot->id %>&category_id=<% $category_id %>&result=1&undo=1">
								Undo Results
							</a>

						</td>

					</tr>

%				}

				</tbody>

			</table>

%		}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Judge Category</h4>

%			foreach my $category ($tourn->categories) {

				<a class="<% $category->id == $category_id? "dk" : ""%>blue nowrap block" href="timeslots.mhtml?category_id=<% $category->id %>">
					<% $category->name %>
				</a>
%			}

			<a href="index.mhtml" class="martop yellow block">
				By Division
			</a>

		</div>

	</div>

