<%args>
	$tourn
	$session
	$round_id    => undef
</%args>
<%init>

	use POSIX;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	
	my $round = Tab::Round->retrieve($round_id);
	my $event = $round->event();
	my $name = $round->realname."-".$round->event->abbr if $round;

	my $filename = "HalfPostings-$name";
    my $filepath = $Tab::file_root."/tmp/".$filename;
    my $garbage = `rm -f $filename.*`;

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		head     => 1,
		taller   => 1
	);

    open (TEXOUT, ">>$filepath.tex");

	my $names;
	my $codes;

	my $schem_style  = $event->setting("schem_designation");
	$names++ if $schem_style eq "names" || $schem_style eq "both";
	$codes++ if $schem_style eq "codes" || $schem_style eq "both";
	$codes++ unless $names || $codes;

	my $fontsize;

	foreach my $panel ($round->panels) { 

		$fontsize = 32;
		print TEXOUT "\\fontsize{".$fontsize."pt}{".$fontsize."pt}\\selectfont ";

		print TEXOUT "{\\normalsize ".$event->abbr." } \\hfill \n\n";

		print TEXOUT "\\strut\n";
		print TEXOUT "\\hfill\n";

		if ($round->type eq "final" || $round->type eq "runoff") { 

		} else { 

			if ($event->type eq "congress") { 
				print TEXOUT " CHAMBER ";
				print TEXOUT Tab::texify(uc($panel->letter))."\n" 
			} elsif ($event->type eq "speech") {
				print TEXOUT " SECTION ";
				print TEXOUT Tab::texify(uc($panel->letter))."\n" 
			}
		}

		print TEXOUT "\\hfill\n";
		print TEXOUT "\\strut\n";

		if ($event->type eq "speech") { 
			print TEXOUT "\\vspace{-8mm}\n";
		} else { 
			print TEXOUT "\\smallskip\n";
		}

		print TEXOUT "\\newline\n";

		print TEXOUT "\\strut\n";
		print TEXOUT "\\hfill\n";
		print TEXOUT "\\makebox[.8\\textwidth]{\\hrulefill}\n";
		print TEXOUT "\\hfill\n";
		print TEXOUT "\\strut\n";

		if ($event->type eq "speech") { 

			print TEXOUT "\\vspace{4mm}\n";
			print TEXOUT "\\newline\n";
			$fontsize = 48;

		} elsif ($event->type eq "congress") { 

			print TEXOUT "\\vspace{4mm}\n";
			print TEXOUT "\\newline\n";
			$fontsize = 32 if $codes;
			$fontsize = 24 if $names;

		} else { 

			print TEXOUT "\\vspace{12mm}\n";
			print TEXOUT "\\newline\n";
			$fontsize = 54 if $codes;
			$fontsize = 36 if $names;
		}

		print TEXOUT "\\fontsize{".$fontsize."pt}{".$fontsize."pt}\\selectfont \n";

		my $switch;
		my $notfirst;
		
		my @entries = $m->comp(
			"/funclib/panel_entries.mas",
			panel    => $panel,
			no_drops => 1
		);

		my $switch_threshold = 3 if $codes;
		$switch_threshold = 2 if $names;

		if ($event->type eq "congress") { 
			@entries = sort {$a->code <=> $b->code} @entries if $codes;
			@entries = sort {$a->lastname cmp $b->lastname} @entries if $names;
		}
			
		foreach my $entry (@entries) { 

			if ($event->type eq "speech") { 
		
				print TEXOUT "\\strut\n";
				print TEXOUT "\\hfill\n";
				print TEXOUT "\\textsb{ ";
				print TEXOUT Tab::texify($entry->code)." \n" if $codes;
				print TEXOUT Tab::texify($entry->name)." \n" if $names;
				print TEXOUT " } \n";
				print TEXOUT "\\hfill\n";
				print TEXOUT "\\strut\n";
					
				print TEXOUT "\\vspace{4mm}\n";
				print TEXOUT "\\newline\n";
			
			} elsif ($event->type eq "congress") { 

				if ($switch++) { 
					if ($switch % $switch_threshold) { 
						print TEXOUT "\\hfill\n ";
					} else { 
						if ($names) { 
							print TEXOUT "\\vspace{4mm}\n";
						} else { 
							print TEXOUT "\\vspace{8mm}\n";
						}
						print TEXOUT "\\newline\n";
					}
				} elsif ($switch_threshold == 3) { 
					$switch += 2; #ugly hack
				} elsif ($switch_threshold == 2) { 
					$switch ++; #similarly ugly hack
				}

				print TEXOUT Tab::texify($entry->code)." \n" if $codes;
				print TEXOUT Tab::texify($entry->name)." \n" if $names;

			} else { 
		
				if ($notfirst++) { 
					print TEXOUT "\\newline\n";
					print TEXOUT "\\strut\n";
					print TEXOUT "\\hfill\n";
					print TEXOUT "\\noindent \\emph{\\Huge vs} \n";
					print TEXOUT "\\hfill\n";
					print TEXOUT "\\strut\n";
					print TEXOUT "\\bigskip\n";
					print TEXOUT "\\newline\n";
				}

				print TEXOUT "\\strut\n";
				print TEXOUT "\\hfill\n";
				print TEXOUT Tab::texify($entry->code)." \n" if $codes;
				print TEXOUT Tab::texify($entry->name)." \n" if $names;
				print TEXOUT "\\hfill\n";
				print TEXOUT "\\strut\n";
				print TEXOUT "\\medskip\n";
			}

		}

		if ($event->type eq "speech") { 
			print TEXOUT "\\vspace{-12mm}\n";
		} 

		print TEXOUT "\\newline\n";

		print TEXOUT "\\strut\n";
		print TEXOUT "\\hfill\n";
		print TEXOUT "\\makebox[.8\\textwidth]{\\hrulefill}\n";
		print TEXOUT "\\hfill\n";
		print TEXOUT "\\strut\n";

		print TEXOUT "\\newline";

		print TEXOUT "\\fontsize{32pt}{32pt}\\selectfont \n"; 	

		if ($panel->room > 0) { 
			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\textsb{ROOM: ".Tab::texify($panel->room->name) ."} ";
			print TEXOUT "\\strut\n";
			print TEXOUT "\\hfill\n";
			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline";
		}

		undef $switch;
		print TEXOUT "\\newpage \n";

	} # end of foreach panel

	close TEXOUT;

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		tail     => 1
	);

</%init>
