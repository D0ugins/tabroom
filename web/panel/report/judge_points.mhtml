<%args>
	$tourn
	$tourn_settings
	$category_id => undef
	$event_id    => undef
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $limit;

	if ($event_id) {
		$limit = " and event.id = ".int($event_id);
	}

	my $sth = $dbh->prepare("

		select
			judge.id, judge.code, judge.first, judge.last,
			AVG(score.value),
			school.name

		from (judge, ballot, score, panel, round, event)

			left join school on judge.school = school.id
		where event.category = ?
		$limit
			and event.id = round.event
			and round.id = panel.round
			and panel.id = ballot.panel
			and ballot.id = score.ballot
			and score.tag = 'point'
		group by judge.id
	");

	my %judges = ();

	$sth->execute($category->id);

	while (
		my (
			$judge_id, $judge_code, $judge_first, $judge_last, $average,
			$school
		) = $sth->fetchrow_array()
	) {

		$judges{$judge_id} = ({
			first   => $judge_first,
			last    => $judge_last,
			code    => $judge_code,
			school  => $school,
			average => $average
		});
	}

</%init>

	<& "/funclib/tablesorter.mas", table => "point_average" &>

	<div class="main">

		<div class="full">

			<span class="third nospace">
				<h4>Judge point averages</h4>
			</span>

			<form
				action = "judge_points.mhtml"
				method = "post"
			>
				<span class="third centeralign">
					<select
						type     = "category_id"
						class    = "fixedmost"
						onChange = "this.form.submit();"
					>
						<option id=""></option>
%						foreach my $category ($tourn->categories) {
							<option
								id = "<% $category->id %>"
								<% $category_id == $category->id ? "selected" : "" %>
							><% $category->name %></option>
%						}
					</select>
				</span>

				<span class="third">
					<select
						type     = "event_id"
						class    = "fixedmost"
						onChange = "this.form.submit();"
					>
						<option id=""></option>
%						foreach my $event ($tourn->events) {
							<option
								id = "<% $event->id %>"
								<% $event_id == $event->id ? "selected" : "" %>
							><% $event->name %></option>
%						}
					</select>
				</span>
			</form>

		</div>

		<table id="point_average">
			<thead>
				<tr class="yellowrow">
					<td>
						Code
					</td>

					<td>
						First
					</td>

					<td>
						Last
					</td>

					<td>
						School
					</td>

					<td>
						Average
					</td>
				</tr>
			</thead>

			<tbody>
<%perl>
				foreach my $jid (
					sort {
						$judges{$a}{"average"} <=> $judges{$b}{"average"}
						|| $judges{$a}{"last"} cmp $judges{$b}{"last"}
						|| $judges{$a}{"first"} cmp $judges{$b}{"first"}
					} keys %judges
				) {
</%perl>
					<tr>
						<td>
							<% $judges{$jid}{"code"} %>
						</td>

						<td>
							<% $judges{$jid}{"first"} %>
						</td>

						<td>
							<% $judges{$jid}{"last"} %>
						</td>

						<td>
							<% $judges{$jid}{"school"} %>
						</td>

						<td class="rightalign">
							<% Math::Round::nearest(.01, $judges{$jid}{"average"}) %>
						</td>
					</tr>
%				}

			</tbody>
		</table>
	</div>

	<&
		"menu.mas",
		whoami => "jpoints"
	&>

