<%args>
	$tourn
	$person
	$debug => undef
</%args>

	<& menu.mas, tourn => $tourn, whoami => "disaster" &>

	<div class="main">

		<h2>Disasters Waiting to Happen for <% $tourn->name %></h2>

<%perl>
		my @bad_rounds;

		my @events = $tourn->events(type => "speech");
		push @events, $tourn->events(type => "congress");

		my %roomless = ();

		foreach my $event (@events) { 

			next if $event->type eq "debate";

			foreach my $round ($event->rounds) { 
				push (@bad_rounds, $round) 
					if $m->comp("/funclib/round_unbalanced.mas", round => $round);

				my $roomless_count = scalar ($round->panels(room => 0, bye => 0));

				if ($roomless_count) { 
					$roomless{$round->id}{"round"} = $round;
					$roomless{$round->id}{"count"} = $roomless_count;
				}

			}
		}
</%perl>

		<h4>Rounds out of balance </h4>

%		if (@bad_rounds) { 
% 			foreach my $round (@bad_rounds) { 
				<a class="yellow padleftmore padtopmore padbottommore martop half" 
					href="/panel/schemat/show.mhtml?round_id=<% $round->id %>">
						Round <% $round->name." of ".$round->event->name %>
				</a>
% 			}
%		}

%		my @double_booked = $m->comp("/funclib/double_booked_judges.mas", tourn => $tourn);

		<h4>Double booked judges</h4>

%		if (@double_booked) { 

%			foreach my $judge (@double_booked) {

				<a class="yellow padleftmore padtopmore padbottommore martop half" 
					href="/register/judge_edit.mhtml?judge_id=<% $judge->id %>"
				>
					Judge <% $judge->code %> <% $judge->first." ".$judge->last %>
				</a>
%			}

%		} else { 
			<p>No judges are double booked</p>
%		}

		<h4>Insufficient Judging panels</h4>

%		my @bad_panels = $m->comp("/funclib/judge_count_check.mas", tourn => $tourn);

%		foreach my $panel (@bad_panels) { 
				
			<a class="yellow padleftmore padtop padbottom martop half" 
				href="/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>"
			>
				<span class="quarter">
					<% $panel->round->event->abbr %> 
					<%$panel->letter %> 
				</span>
				<span class="quarter">
					<% $panel->round->realname %>
				</span>
				<span class="half">
					(<% $panel->panelsize %> judges, <% $panel->judgenum %> needed)
				</span>
			</a>

%		} 

		<h4>Sections without Rooms: </h4>

%		foreach my $round_id (sort keys %roomless) { 

%			my $round = $roomless{$round_id}{"round"};
%			my $count = $roomless{$round_id}{"count"};

			<a class="yellow padtop padbottom martop half" 
				href="/panel/schemat/show.mhtml?round_id=<% $round->id %>"
			>
				<span class="half marno padleftmore">
					<% $round->realname." of ".$round->event->abbr %>
				</span>

				<span class="fourtenths marno">
					<% $count %> sections w/o rooms
				</span>
			</a>
% 		}

			<h4>Entries without assignments: </h4>
%# 			foreach my $entry (sort {$a->code cmp $b->code} $tourn->unassigned_entries) { 

	</div>

