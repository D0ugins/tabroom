<%args>
	$tourn
	$tourn_settings
	$panel_id => undef
	$confirm  => undef
	$message  => undef
	$motion   => undef
	$only     => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now( time_zone => $tz);

	my $panel = Tab::Panel->retrieve($panel_id) if $panel_id;
	my $round = $panel->round;
	my $event = $round->event;

	if ($confirm) {

		unless ($panel) {
			my $msg = "Pick a section plz";
			$m->redirect("/panel/schemat/show.mhtml?event_id=".$event->id."&msg=$msg");
		}

		if ( $event->type eq "speech" ) {

			$m->comp("blast_speech.mas",
				panel          => $panel,
				event          => $event,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				message        => $message,
				only           => $only
			);

		} elsif ( $event->type eq "congress" ) {

			$m->comp("blast_congress.mas",
				panel          => $panel,
				event          => $event,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				only           => $only
			);

		} elsif ( $event->type eq "wudc" ) {

			$m->comp("blast_wudc.mas",
				panel          => $panel,
				event          => $event,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				message        => $message,
				motion         => $motion,
				only           => $only
			);

		} else {

			$m->comp("blast_debate.mas",
				panel          => $panel,
				event          => $event,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				message        => $message,
				only           => $only,
				motion         => $motion
			);
		}

		my $msg = "Email and text message sent to folks in this section";
		$m->redirect("panel_view.mhtml?panel_id=".$panel->id."&msg=$msg");

	}

</%init>

	<div class="main">

		<h2>Blast Pairing</h2>

		<p>
			This will send individual email and text assignments to the judges
			and entries in:
		</p>

		<div class="full nospace padvertmore marvertmore">
			<span class="third nospace">
				<h5 class="nospace">
					Section <% $panel->letter %>
				</h5>
			</span>

			<span class="third nospace">
				<h5 class="centeralign nospace">
					Room <% $panel->room ? $panel->room->name : "NONE" %>
				</h5>
			</span>

			<span class="third nospace">
				<h5 class="rightalign nospace">
					<% $round->realname %> of <% $round->event->name %>
				</h5>
			</span>
		</div>

		<form action="panel_blast.mhtml">

		<input
			type  = "hidden"
			name  = "panel_id"
			value = "<% $panel->id %>"
		>

		<div class="row">
			<span class="twofifths semibold bluetext">
				Include a message to recipients (50 characters max)
			</span>
			<span class="threefifths rightalign">
				<input
					type      = "text"
					name      = "message"
					maxlength = "50"
					size      = "64"
				>
			</span>
		</div>

		<div class="row">
			<span class="quarter semibold bluetext">
				Send Blast To:
			</span>

			<span class="threequarters rightalign nospace">
				<label for="everyone">
					<span class="quarter hover">
						<input
							type  = "radio"
							name  = "only"
							id    = "everyone"
							value = ""
							checked
						> Everyone
					</span>
				</label>
				<label for="judges">
					<span class="hover quarter">
						<input
							type  = "radio"
							id    = "judges"
							name  = "only"
							value = "judges"
						> Judges Only
					</span>
				</label>
				<label for="entries">
					<span class="hover quarter">
						<input
							type  = "radio"
							id    = "entries"
							name  = "only"
							value = "entries"
						> Entries Only
					</span>
				</label>
			</span>
		</div>

%		if ($round->event->type eq "wudc" || $round->event->type eq "wsdc") {

			<div class="row">

				<span class="quarter">
					Include Motion:
				</span>

				<label for="include">
					<span class="quarter hover centeralign">
						<input
							type  = "checkbox"
							class = "largecheck"
							name  = "motion"
							id    = "include"
							value = "1"
						>
					</span>
				</label>

				<span class="half">
					<% $round->setting("motion") %>
				</span>

			</div>
%		}

		<span class="liblrow full rightalign">
			<span class="third centeralign">
				<input
					type        = "submit"
					name        = "confirm"
					value       = "Send email/text blast"
					placeholder = "Max 50 characters"
				>
			</span>
		</span>

		</form>


		<h5 class="padvertmore">
			Sending to:
		</h5>

%		foreach my $entry ($m->comp('/funclib/panel_entries.mas', panel => $panel)) {
			<span class="quarter">
				<% $entry->code %>
			</span>
%		}

%		foreach my $judge ($m->comp('/funclib/panel_judges.mas', panel => $panel)) {
			<span class="quarter">
				<% $judge->first." ".$judge->last %>
			</span>
%		}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Pairings/Printouts</h4>

			<a
				class = "blue block"
				href  = "show.mhtml?round_id=<% $round->id %>"
			>
				<% $event->abbr %> Round <% $round->name %> Pairing
			</a>

			<a
				class = "blue block"
				href  = "/panel/report/print_ballots.mhtml?panel_id=<% $panel->id %>"
			>
				Print Master Ballots
			</a>

			<a
				class = "blue block"
				href  = "/panel/report/posting.mhtml?panel_id=<% $panel->id %>"
			>
				Print Round Posting
			</a>

			<a
				class = "dkblue block"
				href  = "/panel/schemat/panel_blast.mhtml?panel_id=<% $panel->id %>"
			>
				Text/email blast this section
			</a>

		</div>


%		if ($round->flighted > 1) {
			<div class="sidenote">
				<h4>Flight</h4>

				<form
					action = "panel_flight_save.mhtml"
					method = "post"
				>

				<span class="row block centeralign">

					<input
						type  = "hidden"
						name  = "panel_id"
						value = "<% $panel_id %>"
					>

					<select
						name     = "flight"
						onChange = 'this.form.submit();'
						class    = "fixedsmall"
					>

						<option value="">None</option>
%						foreach my $flight ( 1 .. $round->flighted ) {
							<option
								value="<% $flight %>"
								<% $flight == $panel->flight ? "selected" : "" %>
							><% $flight %></option>
%						}
					</select>
				</span>
				</form>
			</div>
%		}

	</div>
