<%args>
	$person
	$tourn
	$tourn_settings
	$event
	$event_settings
	$round
	$round_settings => undef
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $round_type = $round->type;
	my $event_type = $event->type;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now(time_zone => $tz);

	my $round_start = $round->start_time;

	unless ($round_start) {
		$round_start = $round->timezone->start;
	}

	$round_start->set_time_zone("UTC");
	$round_start->set_time_zone($tz);

	if ($event_settings->{"flip_online"}
		&& (
			($round_type eq "elim" || $round_type eq "prelim")
			&& (not defined ($event_settings->{"sidelock_elims"}))
		) || (
			$event_settings->{"no_side_constraints"}
		)
	) {

		my $flip_at = $round_settings->{'flip_at'};
		my $flip_default;

		unless ($flip_at) {
			$flip_at = $now->clone();
			$flip_at->add(minutes => $event_settings->{"flip_deadline"});
			$flip_default++;
		}

		my $sth = $dbh->prepare("select max(flip_at) from panel where round = ? ");
		$sth->execute($round->id);

		my $datestring = $dbh->selectrow_array(
			'select max(flip_at) from panel where round = ?',
			undef,
			$round->id
		);

		my $flip_blasted = $round->setting("flip_blasted");

</%init>

		<h5>Online flip for sides</h5>

		<span class="pagehalf">
			<div class="row">
				<span class="twothirds semibold bluetext">
					<span class="spacette"></span>
					Flipped at
				</span>

				<span class="third centeralign padsetting">
%					if ($datestring) {
						<& "/funclib/showdt.mas",
							string => $datestring,
							tz     => $tz
						&>
%					} else {
						Not flipped
%					}
				</span>
			</div>

			<div class="row">
				<span
					class="twothirds semibold"
				>
					<span class="spacette"></span>
					Flip Deadline <% $round_start->month."/".$round_start->day %> @
				</span>

				<span class="third centeralign">
					<script type="text/javascript">
						 $(document).ready(function() {
							 $('#flip_at').timepicker({
								 showLeadingZero : false,
								 showPeriod      : true,
								 periodSeparator : ' '
							 });
						 });
					 </script>

					<input
						class         = "notfirst"
						id            = "flip_at"
						name          = "flip_at"
						size          = "8"
						type          = "text"
%						if ($flip_default) {
							placeholder = "<% Tab::pickertime($flip_at) %>"
%						} else {
							value = "<% Tab::pickertime($flip_at) %>"
%						}
						setting_name  = "deadline_only"
						property_name = "round"
						target_id     = "<% $round->id %>"
						onChange      = "postSwitch( this, 'flips.mhtml');"
					>
				</span>
			</div>

			<div class="row">
				<span class="twothirds semibold bluetext">
					<span class="spacette"></span>
					Flips blasted at
				</span>

				<span class="third centeralign padsetting" id="blast_time">
%					if ($flip_blasted) {
						<& "/funclib/showdt.mas",
							string => $flip_blasted,
							tz     => $tz
						&>
%					} else {
						Not blasted
%					}
				</span>
			</div>


		</span>
<%perl>

		my $warn;

		if ($datestring) {
			$warn = "This round has already been flipped. Are you sure?";
		}

</%perl>

		<span class="pagehalf">

			<div class="row">
				<span class="twothirds semibold redtext">
					<span class="spacette"></span>
					<% $datestring ? "Redo" : "Do" %> all flips, publish &amp; blast
				</span>

				<span class="quarter centeralign">
					<a
						class         = "blueprint"
						value         = "1"
						id            = "<% $round->id %>"
						property_name = "round"
						target_id     = "<% $round->id %>"
						onClick       = "postConfirm('<% $warn %>', this, 'flips.mhtml');"
					>Flip!</a>
				</span>
			</div>

			<div class="row">
				<span class="twothirds semibold redtext">
					<span class="spacette"></span>
					Only <% $datestring ? "redo" : "do" %> flips
				</span>

				<span class="quarter centeralign">
					<a
						class         = "blueprint"
						value         = "1"
						id            = "<% $round->id %>"
						property_name = "round"
						setting_name  = "no_blast"
						target_id     = "<% $round->id %>"
						onClick       = "postConfirm('<% $warn %>', this, 'flips.mhtml');"
					>Flip!</a>
				</span>
			</div>

%			if ($datestring) {

				<div class="row">
					<span class="twothirds semibold redtext">
						<span class="spacette"></span>
						Open flips online
					</span>

					<span class="quarter centeralign">
						<label class="switch">
							<input
								type          = "checkbox"
								value         = "1"
								id            = "<% $round->id %>"
								setting_name  = "flip_published"
								property_name = "round"
								target_id     = "<% $round->id %>"
								onChange      = "postSwitch( this, 'flips.mhtml');"
								<% $round_settings->{"flip_published"}
									? 'checked="checked"'
									: ""
								%>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>

%				my $warn = "This will blast all the flip results to all followers.  You sure?";

				<div class="row">
					<span class="twothirds semibold redtext">
						<span class="spacette"></span>
						Blast flip notices
					</span>

					<span class="quarter centeralign">
						<a
							class         = "blueprint"
							value         = "1"
							id            = "<% $round->id %>"
							property_name = "round"
							reply_target  = "blast_time"
							target_id     = "<% $round->id %>"
							onClick       = "postConfirm('<% $warn %>', this, 'flips.mhtml');"
						>Blast!</a>
					</span>
				</div>
%			}

		</span>
<%perl>

	}

	if ($round_type eq "elim" || $round_type eq "final") {

		my $default = $round_settings->{'strikes'};
		$default = 0 unless $default;

		my $strikes_due = $round_settings->{'strikes_due'};

		unless ($strikes_due) {
			$strikes_due = $now->clone();
			$strikes_due->add(minutes => 20);
		}

		$strikes_due->set_time_zone($tz);

</%perl>

		<h5 class="martopmore">
			Online Strike Cards
		</h5>

		<span class="pagehalf">

			<div class="row">
				<span class="twothirds semibold">
					<span class="spacette"></span>
					Strikes Allowed
				</span>
				<span class="third centeralign">
					<input
						type         = "number"
						name         = "number"
						min          = "0"
						max          = "99"
						class        = "smaller"
						value        = <% $default %>
						setting_name = "strikes"
						target_type  = "round"
						target_id    = "<% $round->id %>"
						onChange     = "postSwitch( this, 'strike_cards.mhtml');"
					>
				</span>
			</div>

			<div class="row">
				<span
					title="When set the system will auto-strike down to this number where necessary.  If unset, the system will strike down to the first odd number if necessary."
					class="twothirds semibold"
				>
					<span class="spacette"></span>
					Target panel size
				</span>
				<span class="third centeralign">
					<input
						type         = "number"
						name         = "number"
						min          = "0"
						max          = "99"
						class        = "smaller"
						value        = "<% $round_settings->{'strikes_panel_size'} %>"
						setting_name = "strikes_panel_size"
						target_type  = "round"
						target_id    = "<% $round->id %>"
						onChange     = "postSwitch( this, 'strike_cards.mhtml');"
					>
				</span>
			</div>

			<div class="row">
				<span
					class="twothirds semibold"
				>
					<span class="spacette"></span>
					Strike Deadline <% $round_start->month."/".$round_start->day %> @
				</span>

				<span class="third centeralign">
					<script type="text/javascript">
						 $(document).ready(function() {
							 $('#strikes_due').timepicker({
								 showLeadingZero : false,
								 showPeriod      : true,
								 periodSeparator : ' '
							 });
						 });
					 </script>

					<input
						class        = "notfirst"
						id           = "strikes_due"
						size         = "8"
						type         = "text"
						name         = "strikes_due"
						value        = "<% Tab::pickertime($strikes_due) %>"
						setting_name = "strikes_due"
						target_type  = "round"
						target_id    = "<% $round->id %>"
						onChange     = "postSwitch( this, 'strike_cards.mhtml');"
					>
				</span>
			</div>

			<div class="row">

				<span
					class="twothirds semibold"
					title="This setting will randomly remove judges if an even number remains after the strikes are processed, or for teams that do not enter strikes by the deadline.  It will also automatically publish and blast the round once all strikes are in or the deadline is reached. Otherwise you will have to do so manually."
				>
					<span class="spacette"></span>
					Auto-publish round
				</span>

				<span class="third centeralign">
					<label class="switch">
						<input
							type         = "checkbox"
							value        = "1"
							id           = "<% $round->id %>"
							setting_name = "strikes_auto"
							target_type  = "round"
							target_id    = "<% $round->id %>"
							onChange     = "postSwitch( this, 'strike_cards.mhtml');"
							<% $round_settings->{"strikes_auto"}
								? 'checked="checked"'
								: ""
							%>
						>
						<div class="slider"></div>
					</label>
				</span>
			</div>

			<div class="row">
				<span
					class = "twothirds semibold"
					title = "This setting will blast each panel individually once both teams have entered their cards.  It only works if auto-publish is also enabled."
				>
					<span class="spacette"></span>
					Instant Publish
				</span>

				<span class="third centeralign">
					<label class="switch">
						<input
							type         = "checkbox"
							value        = "1"
							id           = "<% $round->id %>"
							setting_name = "strikes_instapublish"
							target_type  = "round"
							target_id    = "<% $round->id %>"
							onChange     = "postSwitch( this, 'strike_cards.mhtml');"
							<% $round_settings->{"strikes_instapublish"}
								? 'checked="checked"'
								: ""
							%>
						>
						<div class="slider"></div>
					</label>
				</span>
			</div>

		</span>

		<span class="pagehalf">

			<div class="row">
				<span class="twothirds semibold redtext">
					<span class="spacette"></span>
					Open strike cards online
				</span>

				<span class="quarter centeralign">
					<label class="switch">
						<input
							type         = "checkbox"
							value        = "1"
							id           = "<% $round->id %>"
							setting_name = "strikes_published"
							target_type  = "round"
							target_id    = "<% $round->id %>"
							onChange     = "postSwitch( this, 'strike_cards.mhtml');"
							<% $round_settings->{"strikes_published"}
								? 'checked="checked"'
								: ""
							%>
						>
						<div class="slider"></div>
					</label>
				</span>
			</div>

			<div class="row">
				<span class="twothirds semibold redtext">
					<span class="spacette"></span>
					Blast strike notices
				</span>

				<span class="quarter centeralign">
					<a
						class        = "blueprint"
						value        = "1"
						id           = "<% $round->id %>"
						setting_name = "strikes_blast"
						target_type  = "round"
						target_id    = "<% $round->id %>"
						onClick      = "postSwitch( this, 'strike_cards.mhtml');"
					>Blast</a>
				</span>
			</div>

			<div class="row">
				<span class="twothirds semibold redtext">
					<span class="spacette"></span>
					Strike blast sent
				</span>

				<span id="blasted" class="third padsetting">
<%perl>
					if ($round_settings->{"strikes_blasted"}) {
						$m->comp("/funclib/showdt.mas",
							dt => $round_settings->{"strikes_blasted"}
						);
					} else {
</%perl>
						Not Blasted
%					}
				</span>
			</div>

			<div class="row">
				<span class="twothirds semibold redtext">
					<span class="spacette"></span>
					Paper Strike Cards
				</span>

				<span class="quarter centeralign">
					<a
						class="blueprint"
						href = "/panel/report/strike_cards.mhtml?round_id=<% $round->id %>"
					>
						Print
					</a>
				</span>
			</div>
		</span>
%	}

%	$dbh->disconnect();

