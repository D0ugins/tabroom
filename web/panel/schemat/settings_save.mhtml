<%args>
	$round_id            => undef
	$timeslot            => undef
	$flighted            => undef
	$type                => undef
	$tiebreak_set        => undef
	$label               => undef
	$reset_room_moves    => undef
	$flight_rooms_only   => 0
	$include_room_notes  => 0
	$wsdc_round_type     => 0
	$motion              => undef
	$notes               => undef
	$judges              => undef
	$jpool               => undef
	$ballot_rules        => 0
	$tab_rating_priority => undef
	$tab_seed_priority   => undef
	$offset              => 0
	$start_time          => undef
	$ignore_results      => 0
	$sidelock_against    => 0
	$omit_from_bracket   => 0
	$use_for_breakout    => 0
</%args>
<%init>

	$m->abort unless $round_id;

	unless ($tiebreak_set) { 
		my $err = "You must select a tiebreak set";
		$m->redirect("show.mhtml?round_id=".$round_id."&default=settings&err=$err");
	}

	unless ($type) { 
		my $err = "You must select a round type";
		$m->redirect("show.mhtml?round_id=".$round_id."&default=settings&err=$err");
	}

	unless ($timeslot) { 
		my $err = "You must select a timeslot";
		$m->redirect("show.mhtml?round_id=".$round_id."&default=settings&err=$err");
	}

	my $round = Tab::Round->retrieve($round_id);
	my $event = $round->event;
	my $tz = $event->tourn->tz;

	$tz = "UTC" unless $tz;

	$round->type($type);
	$round->timeslot($timeslot);
	$round->flighted($flighted);
	$round->tiebreak_set($tiebreak_set);
	$round->label($label);

	$round->update();

	$m->comp("/funclib/renumber_rounds.mas", event_id => $event->id);

	$round->setting("ignore_results", $ignore_results);
	$round->setting("sidelock_against", $sidelock_against);
	$round->setting("omit_from_bracket", $omit_from_bracket);
	$round->setting("use_for_breakout", $use_for_breakout);
	$round->setting("include_room_notes", $include_room_notes);
	$round->setting("wsdc_round_type", $wsdc_round_type);
	$round->setting("notes", "text", $notes);
	$round->setting("motion", "text", $motion);
	$round->setting("num_judges", $judges);
	$round->setting("reset_room_moves", $reset_room_moves);
	$round->setting("jpool", $jpool);
		
	my $start_date = $round->timeslot->start->set_time_zone($tz);

	my $start;

	if ($start_time) { 

		eval { 
			$start = Tab::dtme( $start_date->mdy('/'), $start_time, $tz);
		};
	
		undef $start unless $start && $start->year;
		$round->start_time($start) if $start;
		$round->start_time($round->timeslot->start) unless $start;

	} else { 
		$round->start_time($round->timeslot->start);
	}

	$round->update();

	$tab_rating_priority =~ s/\./,/g;
	$tab_rating_priority =~ s/\ /,/g;
	$tab_rating_priority =~ s/\:/,/g;

	$round->setting("tab_rating_priority", $tab_rating_priority);

	$tab_seed_priority =~ s/\./,/g;
	$tab_seed_priority =~ s/\ /,/g;
	$tab_seed_priority =~ s/\:/,/g;

	$round->setting("tab_seed_priority", $tab_seed_priority);

	$event->setting("ballot_rules", "text", $ballot_rules);
	$event->setting("flight_offset", $offset);
	$event->setting("flight_rooms_only", $flight_rooms_only);

	my $msg = $round->realname." settings saved  $start_time.";

	my $err = $label ." is a manifestly ridiculous name for an elimination round. It's not even proper Latin.  <br/></br/>If you are going to use weird round names like that, consider using other software in the future" if $label eq "Sextodecimals";

	$m->redirect("show.mhtml?round_id=".$round->id."&default=settings&msg=$msg&err=$err");

</%init>
