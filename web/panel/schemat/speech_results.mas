<%args>
	$round
</%args>
<%init>

		my @done_panels = $m->comp(
			"/funclib/round_results.mas",
			round => $round
		);

		my $tourn = $round->event->tourn;

		my $points;

		my $tiebreak_set = $round->tiebreak_set;

		if ($tiebreak_set) {
			foreach my $tiebreak ($tiebreak_set->tiebreaks) {
				$points++ if $tiebreak->name eq "points";
			}
		}

</%init>

		<span class="half nospace">
			<h5><% $round->realname %> Results</h5>
		</span>

		<span class="quarter centeralign nospace">
%			if ($event_settings->{"online_ballots"}) {
				<a
					href  = "online_ballots.mhtml?round_id=<% $round->id %>"
					class =" buttonwhite greentext smallish thin marno padvert"
				>View Comments</a>
%			}
		</span>

		<span
			class = "quarter rightalign"
			id    = "round_results_buttonarea"
		></span>

		<& "/funclib/tablesorter.mas", table => "round_results" &>

		<table id="round_results">

			<thead>

				<tr class="yellowrow">

					<th class="smaller">
						Room
					</th>

					<th class="smaller">
						Code
					</th>

					<th class="smaller">
						Name
					</th>

					<th class="smaller">
						School
					</th>

					<th class="smaller">
						Judging
					</th>

					<th class="smaller">
						Ranks
					</th>

%					if ($points) {
						<th class="smaller">
							Points
						</th>
%					}

				</tr>

			</thead>

			<tbody>

<%perl>

		my %seen = ();

		@done_panels = grep { ! $seen{$_->id} ++ } @done_panels;

		my %done_entry;

		foreach my $done (@done_panels) {

			my @judges = $m->comp('/funclib/panel_judges.mas', panel => $done);

			my @entries = $m->comp('/funclib/panel_entries.mas', panel => $done);

			my %eseen = ();
			@entries = grep { ! $eseen{$_->id} ++ } @entries;

			my @scores = $m->comp('/funclib/panel_scores.mas', panel => $done);

			my %scores = ();

			foreach my $score (@scores) {
				push @{$scores{$score->judgeid."-".$score->entryid}}, $score;
			}


</%perl>

%			foreach my $entry (sort {$a->side <=> $b->side} @entries) {

				<tr>

					<td class="smallish">
						<a
							class="plain padmuchmore hover full"
							href="/panel/schemat/panel_view.mhtml?panel_id=<% $done->id %>"
						>
							<% $done->room ? $done->room->name : $done->letter %>
						</a>
					</td>

					<td class="smallish">
						<a
							href="/register/entry/edit.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $entry->id %>"
							class="white padno">
							<% $entry->code %>
						</a>
					</td>
					<td class="smallish">
						<a
							href="/register/entry/edit.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $entry->id %>"
							class="white padno">
							<% $entry->name %>
						</a>
					</td>

					<td class="smallish">

						<a
							href="/register/school/edit.mhtml?tourn_id=<% $tourn->id %>&school_id=<% $entry->school->id %>"
							class="white padno"
						>
							<% $entry->school->short_name %>
						</a>

					</td>

					<td class="smallish centeralign">

%						foreach my $judge (@judges) {

							<div class="nowrap">

								<div class="white marno padless">
									<% $judge->last %>, <% $judge->first %>
								</div>
							</div>
%						}
					</td>

					<td class="smallish centeralign">

%						foreach my $judge (@judges) {

							<div class="nowrap">

%								if ($scores{$judge->id."-".$entry->id}) {
%									foreach my $score (@{$scores{$judge->id."-".$entry->id}}) {
%										next unless $score->tag eq "rank";
										<div class="white marno padless">
											<% $score->value  %>
										</div>
%									}
%								}

							</div>
%						}
					</td>

%					if ($points) {
						<td class="smallish centeralign">
%							foreach my $judge (@judges) {
								<div class="nowrap block marno padless">
%									if ($scores{$judge->id."-".$entry->id}) {
%										foreach my $score (@{$scores{$judge->id."-".$entry->id}}) {
											<a class="white padno">
											<% $score->tag eq "points" ? $score->value : "" %>
											</a>
%										}
%									}
								</div>
%							}
						</td>
%					}
				</tr>
%			}
%		}

		</tbody>

	</table>

