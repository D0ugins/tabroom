<%args>
	$tourn
	$person
	$panel_id => undef
	$from     => undef
	$judge_id => undef
</%args>
<%init>

	my $switch;

	my $panel = Tab::Panel->retrieve($panel_id);

	unless ($panel) { 
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $round = $panel->round;

	my @values = $m->comp("/funclib/panel_scores.mas", panel => $panel);

	my $timeslot = $panel->round->timeslot;
	my $start = $timeslot->start;
	my $end = $timeslot->end;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	$start->set_time_zone($tz);
	$end->set_time_zone($tz);

	my $event = $panel->round->event;
	my $category = $event->category;

	my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

</%init>

	<div class="main">

		<h4>Round <% $round->name %> Panel <% $panel->letter %> of <% $event->abbr %></h4>

		<h4> Entry Speaker Order </h4>

		<form 
			action = "speaker_order_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "panel_id"
			value = "<% $panel->id %>"
		>

		<& "/funclib/tablesorter.mas", 
			table     => "order",
			nobuttons => 1 
		&>

		<table id="order">

			<thead>

			<tr class="yellowrow">

				<th class="smaller">
					Order
				</th>

				<th class="smaller">
					Entry
				</th>

				<th colspan="2" class="smaller">
					School
				</th>

%				if ($tourn->setting("ncfl")) {
					<th class="smaller">
						Dio
					</th>
%				}

				<th class="smaller">
					Other Orders
				</th>

			</tr>

			</thead>


% 			$switch = 1;

% 		foreach my $entry (@entries) { 

			<tr>

				<td class="smallish centeralign">
					<input 
						type  = "number"
						size  = "5"
						min   = "1"
						max   = "<% scalar @entries %>"
						name  = "<% $entry->id %>"
						value = "<% $entry->speaks %>"
					>
				</td>

				<td class="smallish">
					<a 
						class    = "white"
						tabindex = "-1"
						href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
					>
						<% ($entry->dq) ? "DQ" : $entry->code %>
						<% $entry->name %>
					</a>
				</td>
					
				<td class="smallish">
					<% $entry->school->short_name %> 
				</td>

				<td class="smallish">
					<% ($entry->school->code) ? $entry->school->code  : "" %>
				</td>

%				if ($tourn->setting("regions") || $tourn->setting("ncfl")) {
					<td class="smallish centeralign">
						<% ($entry->school->region) ? $entry->school->region->code : "" %>
					</td>
%				}

				<td class="smallish centeralign">
<%perl>

					my %used = ();
					my $total;

					foreach my $ballot ($entry->ballots) { 
						next unless $ballot->panel->round;
						next if $ballot->panel->round->id == $round->id;
						next if $used{$ballot->panel->id};
						$used{$ballot->panel->id}++;
   						$m->print($ballot->speakerorder);
						$total += $ballot->speakerorder;
					}

</%perl>
					(<% $total %>)
				</td>

			</tr>

% 		}

		<tr class="liblrow">
			<td colspan="7" class="rightalign">
				<input type="submit" value=" Save order ">
				</form>
			</td>
		</tr>

		</table>


%		if ($person->site_admin) { 

			<br />

			<p style="text-align: center;" >
				Round <% $round->id %> Panel <% $panel->id %> Event <% $event->id %>
			</p>
%		}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Pairings/Printouts</h4>

			<a 
				class="blue full" 
				href="show.mhtml?round_id=<% $round->id %>"
			>
				<% $event->abbr %> Round <% $round->name %> Pairing
			</a>

			<a class="blue full" 
				href="/panel/report/master_single.mhtml?panel_id=<% $panel->id %>">
				Print Master Ballots
			</a>

			<a class="blue full" 
				href="/panel/report/posting.mhtml?panel_id=<% $panel->id %>">
				Print Round Posting
			</a>

		</div>

		<div class="sidenote">

			<h4>Room</h4>

			<span class="even full centeralign bluetext semibold">
%				if ($panel->room) { 
					<% $panel->room->name %>
%				}
			</span>

			<h4>Time</h4>

				<div class="row">
					<span class="third semibold">
						Starts: 
					</span>

					<span class="twothirds">
						<% &Tab::niceshortdt($start) %> 
					</span>
				</div>

				<div class="row">
					<span class="third semibold">
						Ends
					</span>

					<span class="twothirds">
						<% &Tab::niceshortdt($end) %> 
					</span>
				</div>

		</div>

		<div class="sidenote">

			<h4>Make Changes</h4>

			<a href="speaker_order.mhtml?panel_id=<% $panel->id %>" 
				class="dkyellow block">
				Change Speaker Order
			</a>

			<a href="/tabbing/entry/panel.mhtml?panel_id=<% $panel->id %>" 
				class="yellow full">
				View/Edit Ranks
			</a>

		</div>

	</div>

