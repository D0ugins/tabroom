<%args>
	$tourn
	$tourn_settings => undef
	$round_id       => undef
	$confirm        => undef
	$message        => undef
	$include_motion => undef
	$motion         => undef
	$scheduled      => undef
</%args>
<%init>

	my $round = Tab::Round->retrieve($round_id) if $round_id;
	$m->abort unless $round;
	my $event = $round->event;

	my $tz = $tourn->tz;
	$tz ="UTC" unless $tz;

	my $event_type = $event->type;

	$event_type = "debate"
		if $event_type eq "wsdc"
		|| $event_type eq "policy"
		|| $event_type eq "big_questions"
		|| $event_type eq "ld"
		|| $event_type eq "pf"
		|| $event_type eq "parli";

	if ($confirm) {

		unless ($round) {
			my $msg ="Pick a round plz";
			$m->redirect("/register/index.mhtml?msg=$msg");
		}

		my $preset = 1 unless $m->comp(
			'/funclib/round_entries.mas',
			round => $round
		);

		if ($include_motion && $motion) {

			$round->setting("motion", $motion);

		} else {

			undef $motion;

		}

		if ( $event_type eq "speech" ) {
			$m->comp("blast_speech.mas",
				round          => $round,
				event          => $event,
				tourn          => $tourn,
				flight         => $ARGS{"flight"},
				tourn_settings => $tourn_settings,
				message        => $message
			);
		} elsif ( $event_type eq "congress" ) {
			$m->comp("blast_congress.mas",
				round          => $round,
				event          => $event,
				tourn          => $tourn,
				flight         => $ARGS{"flight"},
				tourn_settings => $tourn_settings,
				message        => $message
			);
		} elsif ( $event_type eq "wudc" ) {
			$m->comp("blast_wudc.mas",
				round          => $round,
				event          => $event,
				message        => $message,
				tourn          => $tourn,
				flight         => $ARGS{"flight"},
				tourn_settings => $tourn_settings,
				motion         => $motion
			);
		} else {
			$m->comp(
				"blast_debate.mas",
				round          => $round,
				event          => $event,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				message        => $message,
				flight         => $ARGS{"flight"},
				motion         => $motion
			);
		}

		my $now = DateTime->now();
		$round->setting("blasted", "date", $now);

		my $msg ="Email and text notices sent for ".$round->realname;
		return if $scheduled;

		$m->redirect("show.mhtml?round_id=".$round->id."&msg=$msg");

	}

</%init>

	<div class="main">

		<h4>Blast Room Assignments</h4>

		<p class="centeralign">
			Send individualized email and text assignments to all the entries
			and judges in <% $round->realname %> of <% $round->event->name %>.
		</p>

		<form action="blast.mhtml">

		<input
			type  = "hidden"
			name  = "round_id"
			value = "<% $round->id %>"
		>

		<div class="row">

			<span class="twofifth semibold">
				Message to recipients
			</span>

			<span class="threefifth">

				<input
					type        = "text"
					name        = "message"
					maxlength   = "50"
					size        = "50"
					placeholder = "Limit 50 characters"
					value       = "<% $round->setting("notes") ? $round->setting("notes") :"" %>"
				>
			</span>
		</div>

%		if ($event->type eq "parli") {

			<div class="row">
				<label for="include">
					<span class="twofifths hover nospace">

						<span class="twothirds padleft">
							Include Motion:
						</span>

						<span class="third">
							Yes:
							<input
								type  = "checkbox"
								class = "largecheck"
								name  = "include_motion"
								id    = "include"
								value = "1"
							>
						</span>
					</span>
				</label>

				<span class="threefifths">
					<input
						type      = "text"
						name      = "motion"
						maxlength = "50"
						size      = "50"
						value     = "<% $round->setting("motion") ? $round->setting("motion") :"" %>">
				</span>
			</div>
%		}

%		if ($round->flighted > 1) {

			<div class="row">

				<span class="twofifth semibold">
					Flight
				</span>

				<span class="threefifths nospace">

					<label for="m_all">
						<span class="quarter hover">
							<input
								type  = "radio"
								id    = "m_all"
								name  = "flight"
								value = ""
								checked
							>
							All
						</span>
					</label>

%					foreach my $tick (1 .. $round->flighted) {

						<label for="m_<% $tick %>">
							<span class="quarter hover">
								<input
									type  = "radio"
									name  = "flight"
									id    = "m_<% $tick %>"
									value = "<% $tick %>"
								>
								<% $tick %>
							</span>
						</label>
%					}

				</span>

			</div>
%		}


		<div class="liblrow rightalign marno">

			<input
				type        = "submit"
				name        = "confirm"
				value       = "Send assignments"
				placeholder = "Max 50 characters"
			>
			</form>
		</div>

		<h4 class="martopmore">Blast Message Only</h4>

		<p class="centeralign">
			Send a short message/announcement only to entries
			and judges in <% $round->realname %> of <% $round->event->name %>.
		</p>

		<form action="blast_message.mhtml">

		<input
			type  = "hidden"
			name  = "round_id"
			value = "<% $round->id %>"
		>

		<div class="row">
			<span class="twofifths semibold">
				Message to recipients
			</span>

			<span class="threefifths">
				<input
					type      = "text"
					name      = "message"
					maxlength = "150"
					size      = "50"
					value     = "<% $round->setting("notes") ? $round->setting("notes") :"" %>"
				>
			</span>
		</div>

%		if ($event->type eq "parli") {

			<div class="row">
				<label for="include2">
					<span class="twofifths hover nospace">

						<span class="twothirds padleft">
							Include Motion:
						</span>

						<span class="third">
							Yes:
							<input
								type  = "checkbox"
								class = "largecheck"
								name  = "include_motion"
								id    = "include2"
								value = "1"
							>
						</span>
					</span>
				</label>

				<span class="threefifths">
					<input
						type      = "text"
						name      = "motion"
						maxlength = "50"
						size      = "50"
						value     = "<% $round->setting("motion")
							? $round->setting("motion")
							: ""
					%>">
				</span>
			</div>
%		}


		<div class="row">

			<span class="quarter">
				Send to followers of
			</span>

			<span class="threequarters nospace">

				<label for="f_all">
					<span class="quarter hover">
						<input
							type  = "radio"
							name  = "sendto"
							id    = "f_all"
							value = "all"
							checked
						> All
					</span>
				</label>

				<label for="entries">
					<span class="quarter hover">
						<input
							type  = "radio"
							name  = "sendto"
							id    = "entries"
							value = "entries"
							> Entries
					</span>
				</label>

				<label for="judges">
					<span class="quarter hover">
						<input
							type  = "radio"
							name  = "sendto"
							id    = "judges"
							value = "judges"
							> Judges
					</span>
				</label>

			</span>

		</div>

%		if ($round->flighted > 1) {

			<div class="row">

				<span class="quarter">
					Flight
				</span>

				<span class="threequarters nospace">

					<label for="w_all">
						<span class="quarter hover leftalign">
							<input
								type  = "radio"
								id    = "w_all"
								name  = "flight"
								value = ""
								checked
							>
							All
						</span>
					</label>

%					foreach my $tick (1 .. $round->flighted) {

						<label for="<% $tick %>">
							<span class="quarter hover leftalign">
								<input
									type  = "radio"
									id    = "<% $tick %>"
									name  = "flight"
									value = "<% $tick %>"
								>
								<% $tick %>
							</span>
						</label>
%					}
				</span>
			</div>
%		}


		<div class="row">

			<span class="quarter">
				Round types
			</span>

			<span class="threequarter nospace">

				<label for="allround">
					<span class="quarter hover">
						<input
							type  = "radio"
							name  = "panels"
							id    = "allround"
							value = "all"
							checked
						> All Rounds
					</span>
				</label>

				<label for="unstarted">
					<span class="quarter hover">
						<input
							type  = "radio"
							name  = "panels"
							id    = "unstarted"
							value = "unstarted"
						> Unstarted
					</span>
				</label>

				<label for="unentered">
					<span class="quarter hover">
						<input
							type="radio"
							name="panels"
							id="unentered"
							value="unentered"> Unentered
					</span>
				</label>

				<label for="unconfirmed">
					<span class="quarter nowrap hover">
						<input
							type  = "radio"
							name  = "panels"
							id    = "unconfirmed"
							value = "unconfirmed"
						> Unconfirmed
					</span>
				</label>

			</span>

		</div>

		<div class="liblrow rightalign marbottom">

			<input
				type  = "submit"
				name  = "confirm"
				value = "Send message"
			>
			</form>
		</div>

		</form>

		<h4 class="martopmore">Scheduled Blast & Publish</h4>

<%perl>

		my $setting = Tab::RoundSetting->search(
			round => $round_id,
			tag   => "scheduled_elast"
		)->first;

</%perl>

%		if ($setting) {

			<div class="dkred row marbottom">

				<span class="threequarters">
					Round will be
					<% $setting->value eq "both" ? "both blasted &amp; published" : "" %>
					<% $setting->value eq "blast" ? "blasted only" : "" %>
					<% $setting->value eq "publish" ? "published only" : "" %>
						at
					<% $setting->value_date
						? Tab::niceshortdayt($setting->value_date->set_time_zone($tz))." ".Tab::tzname($tz)
						: ""
					%>
				</span>

				<span class="quarter">
					<a
						class="dkyellow button"
						href="schedule_delete.mhtml?setting_id=<% $setting->id %>"
					>
						Cancel Scheduled Blast
					</a>
				</span>

			</div>
%		}

		<form
			action="schedule_blast.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "round_id"
				value = "<% $round->id %>"
			>

			<div class="row">

				<span class="quarter">
					Send blast and publish at
				</span>

				<span class="half">
					<& "/funclib/datepicker.mas",
						id =>"blastdate",
						max => $tourn->end
					&>

					<input
						type        = "text"
						name        = "blastdate"
						id          = "blastdate"
						placeholder = "Date.."
						size        = "24"
					>

					@ <&
						"/funclib/timepicker.mas",
						name        => "blasttime",
						size        => 16,
						placeholder => "Time..."
					&>
				</span>

				<span class="quarter">

					<select
						name  = "style"
						class = "fixedmed"
					>
						<option value="both">Text Blast &amp; Publish </option>
						<option value="blast">Text Blast Only</option>
						<option value="publish">Web Publish Only</option>
					</select>
				</span>

			</div>

			<div class="row">

				<span class="quarter semibold">
					Message to recipients
				</span>

				<span class="threequarters">
					<input
						type        = "text"
						name        = "message"
						maxlength   = "50"
						size        = "50"
						placeholder = "Limit 50 characters"
						value       = "<% $round->setting("notes")
							? $round->setting("notes")
							:""
						%>">
				</span>
			</div>

			<div class="liblrow rightalign">
				<input
					type  = "submit"
					value = "Schedule Blast"
				>
			</div>

		</form>

	</div>

%	my $start = $round->start_time;
%	$start = $round->timeslot->start unless $start;
%	$start->set_time_zone($tz);

	<div class="menu">

		<div class="sidenote">

			<h4>Share & Enjoy</h4>

            <div class="row full">
                Start time: <% Tab::nicetime($start)."".Tab::tzname($tz) %>
            </div>

			<a class="full blue" href="show.mhtml?round_id=<% $round->id %>">
				Return to Pairing
			</a>

			<a
				class="full blue"
				href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $round->event->id %>"
			>
				Print Pairing
			</a>

		</div>

		<div class="sidenote">

			<h4>Stats & Data</h4>

%			if ($event->type eq "wudc" || $event->type eq "wsdc") {
				<span class="third block">
					Motion
				</span>
				<span class="twothird block">
					<% $round->setting("motion") ?"Entered" :"Not Entered" %>
				</span>
%			}

			<div class="row full">
				<span class="quarter">
					Paired:
				</span>

				<span class="threequarter">
					<% $round->created
						? &Tab::nicedt($round->created->set_time_zone($tourn->tz))
						:"Not recorded"
					%>
				</span>
			</div>

%			my $completed = $round->setting('completed');
%			my $blasted = $round->setting('blasted');

			<div class="row full">
				<span class="quarter">
					Finished:
				</span>
				<span class="threequarter">
					<% $completed
						? &Tab::nicedt($completed->set_time_zone($tourn->tz))
						: "Not recorded"
					%>
				</span>
			</div>

			<div class="row full">
				<span class="quarter">
					Blasted:
				</span>
				<span class="threequarter">
					<% $blasted
						? &Tab::nicedt($blasted->set_time_zone($tourn->tz))
						: "Not yet blasted"
					%>
				</span>
			</div>

		</div>

	</div>

