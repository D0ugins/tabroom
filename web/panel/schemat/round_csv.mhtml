<%args>
	$round_id => undef
	$person
	$session
	$tourn
	$tourn_settings
</%args>
<%init>
	use POSIX;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now;    
    $now->set_time_zone($tz);

	my $round = Tab::Round->retrieve($round_id);

	my $event = $round->event;

    my $event_name = $round->event->abbr;
    $event_name =~ s/[\W_]//g;

    my $name = $round->realname;
    $name =~ s/[\W_]//g;

    my $filename = "Schematic-$event_name-$name.csv";

	my $designation = $event->setting('schem_designation');
    my $codes++ if $designation eq "codes";
    my $names++ if $designation eq "names";

    $codes++ if $designation eq "both";
    $names++ if $designation eq "both";

	$m->clear_buffer();
    $r->content_type('application/csv');
    $r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	$m->print('"'.$event->name.'",');
	$m->print('"'.$round->realname.'"');
	$m->print("\n");

	my @panels = $m->comp("/funclib/round_panels.mas", round => $round);

	foreach my $panel (@panels) { 

		my @entries = $m->comp(
			"/funclib/panel_entries.mas", 
			panel => $panel
		);

		my @judges = $m->comp(
			"/funclib/panel_judges.mas", 
			panel => $panel
		);

		$m->print('"'.$panel->letter.'",');
		$m->print('"'.$panel->roomname.'",');

		foreach my $judge (@judges) { 
			$m->print('"'.$judge->code.'",');
			$m->print('"'.$judge->first.'",');
			$m->print('"'.$judge->last.'",');
		}

		foreach my $entry (@entries) { 
			$m->print('"'.$entry->code.'",');
			$m->print('"'.$entry->name.'",');
			$m->print('"'.$entry->lastname.'",');
		}

		$m->print("\n");

	}
	
	foreach my $panel (@panels) { 

		my @entries = $m->comp(
			"/funclib/panel_entries.mas", 
			panel => $panel
		);

		my @judges = $m->comp(
			"/funclib/panel_judges.mas", 
			panel => $panel
		);

		$m->print('"'.$panel->letter.'"');
		$m->print("\n");
	
		$m->print('"'.$panel->roomname.'"');
		$m->print("\n");

		foreach my $entry (@entries) { 

			$m->print('"'.$entry->code.'",');
			$m->print('"'.$entry->name.'",');
			$m->print('"'.$entry->lastname.'",');

			if ($tourn_settings->{"nsda_nats"}) { 

				$m->print('"'.$entry->state.'",');
				$m->print('"'.$entry->schoolname.'",');
				$m->print('"'.$entry->districtcode.'",');
				$m->print('"'.$entry->districtname.'",');
			}

			$m->print("\n");
		}

		$m->print('"Judges"');
		$m->print("\n");
		foreach my $judge (@judges) { 
			$m->print('"'.$judge->code.'",');
			$m->print('"'.$judge->first.'",');
			$m->print('"'.$judge->last.'",');
			$m->print("\n");
		}

		$m->print("\n");
		$m->print("\n");


	}

	$m->flush_buffer();
	$m->abort();

</%init>

