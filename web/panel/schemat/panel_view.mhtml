<%args>
	$tourn
	$tourn_settings
	$person
	$panel_id
	$judge_id => undef
	$from     => undef
	$perms    => undef
</%args>
<%init>

	use Math::Round;
	use POSIX;

	my $panel = Tab::Panel->retrieve($panel_id);

	$m->redirect("/setup/tourn/main.mhtml?err=Could%20not%20retrieve%20requested%20panel.") 
		unless $panel;

	# I do this because it makes it easy to pass all the options to the judge
	# menu fesormatter.  I am not proud of it. 

	my %settings;
	$settings{"nsda_nats"} = $tourn_settings->{"nsda_nats"};
	$settings{"ncfl"}      = $tourn_settings->{"ncfl"};
	$settings{"region"}    = $tourn_settings->{"regions"};

	$m->comp("/funclib/panel_dedupe.mas", panel => $panel);

	my $entry_only++ if ${$perms}{"entry_only"};

	my $reg_only++ 
		if ${$perms}{"limited"} 
		&! ${$perms}{"registration"};

	unless ($panel) { 
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $round = $panel->round;
	my $timeslot = $round->timeslot;
	my $event = $round->event;
	my $start = $timeslot->start->set_time_zone($tz);
	my %event_settings = $event->all_settings();

	$settings{"flighted"} = $round->flighted;

	my @scores = $m->comp(
		"/funclib/panel_scores.mas",
		panel => $panel
	);

	my %judge_sites = ();

	my $blind_mode++ if $event_settings{"blind_mode"} && $round->published < 1;
	$settings{"blind_mode"} = $blind_mode;
	$settings{"online_ballots"}++ if $event_settings{"online_ballots"};

	my %anonymize = $m->comp(
		"/funclib/blind_mode.mas", 
		round => $round
	) if $blind_mode;

	if ($event_settings{'wsdc_multiple_sites'}) { 

		my @round_sites = $m->comp(
			"/funclib/round_sites.mas", 
			round => $round
		);

		my %site_name = 
			map {$_->id => $_->name} 
			@round_sites;

		my $round_time = $round->timeslot->start;

		my $today_start_string = $round_time->year."-".$round_time->month."-".$round_time->day." 00:00:00";

		my $today_end_string = $round_time->year."-".$round_time->month."-".$round_time->day." 23:59:59";

		Tab::Round->set_sql( today => " 
			select round.* 
			from round, timeslot
			where round.timeslot = timeslot.id
			and timeslot.start > ?
			and timeslot.start < ? 
			and round.event = ? 
		");

		my @todays_rounds = Tab::Round->search_today( 
			$today_start_string, 
			$today_end_string, 
			$event->id
		);

		foreach my $today (@todays_rounds) { 

			next if $today->id == $round->id;

			my @judges = $m->comp(
				"/funclib/round_judges.mas", 
				round => $today
			);

			%judge_sites = 
				map {$_->id => $site_name{$_->site}} 
				@judges;

			undef @judges;
		}   

		$settings{"judge_sites"} = \%judge_sites;
		
	}

	$settings{"region"}++ if $event_settings{"region_avoid"};
	$settings{"region"}++ if $event_settings{"region_constrain"};

	my $category = $event->category;

	my %category_settings = $category->all_settings();

	if ($category_settings{"conflict_region_judges"}) { 

		$settings{"dio_regions"}++;

        foreach my $diocese (
			$m->comp(
				"/funclib/tourn_regions.mas", 
				tourn => $tourn)
		) { 
			$settings{"dio_region"}{$diocese->code} 
				= $diocese->setting("region-".$event->id);
		}
	}
	
	my $aff_string = $event_settings{"aff_label"};
	my $neg_string = $event_settings{"neg_label"};

	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	$start->add(minutes => $event_settings{"flight_offset"} * ($panel->flight - 1));

	my $live_updates++ if $event_settings{'live_updates'};

	my @judges = $m->comp(
		"/funclib/panel_judges.mas", 
		panel => $panel
	);

	my $all++ if $tourn_settings->{"nsda_nats"} && $event_settings{"supp"};

	my %entry_wins = $m->comp(
		"/funclib/entry_wins.mas", 
			event => $event,
			round => $round,
			all   => $all
		);

	my %entry_losses = $m->comp(
		"/funclib/entry_losses.mas", 
		event => $event,
		round => $round,
		all   => $all
	);

	my @reserved_rooms;

	foreach my $judge (@judges) {
		my $r_id = $judge->setting('room_reserved');
		my $r2 = Tab::Room->retrieve($r_id) if $r_id;
		push @reserved_rooms, $r2 if $r2;
	}

	my @entries = $m->comp(
		"/funclib/panel_entries.mas", 
		panel => $panel
	);
 
	unless ($event->type eq "speech" || $event->type eq "congress") {
		@entries = sort {$a->side <=> $b->side} @entries;
	}

	my %schools = map {$_->school->id => 1} @entries;

	$settings{"tab_ratings"}++ if $category_settings{"tab_ratings"};
	$settings{"prefs"} = $category_settings{"prefs"};

	if ($settings{"prefs"} eq "ndt") { 
		$settings{"prefs"} = "ordinals";
		$settings{"prefs"} = "tiered" if $round->type eq "elim";
		$settings{"prefs"} = "tiered" if $round->type eq "final";
		$settings{"prefs"} = "tiered" if $round->type eq "runoff";
		$settings{"prefs"} = "ordinals" if $round->name == 9;
	}

	undef $settings{"prefs"} if $settings{"prefs"} eq "none";

	$settings{"no_judge_codes"}++ if $category_settings{"no_codes"};
	$settings{"no_school_codes"}++ if $tourn_settings->{"school_codes"} eq "none";
	$settings{"diversity"}++ if $category_settings{"track_diversity"};

	my %rating_by_judge = ();
			
	$settings{"coach_ratings"} = $category_settings{"coach_ratings"};

	if ( $category_settings{"coach_ratings"} ) { 

		my @ratings = $m->comp(
			"/funclib/category_ratings.mas", 
			event => $event,
			type  => "coach"
		);

		my @tiers = $category->rating_tiers;
		my %tier_names = ();

		foreach my $tier (@tiers) { 
			$tier_names{$tier->id} = $tier->name;
		}

		foreach my $rating (@ratings) { 
			$rating_by_judge{$rating->judge->id} = $tier_names{$rating->rating_tier->id} 
				if $rating && $rating->rating_tier;
		}

	}

	$settings{"rating_by_judge_ref"} = \%rating_by_judge;
	$settings{"rounds_per"} = $category_settings{"rounds_per"};

	my $round_type = $round->type;

	undef $settings{"rounds_per"} 
		if $round_type eq "elim" 
		|| $round_type eq "final"
		|| $round_type eq "runoff";

	my $section = "Debate";
	$section = "Section" if $event->type eq "speech";
	$section = "Chamber" if $event->type eq "congress";

	my $room = $panel->room if $panel->room;
	my $panel_room = $room->id if $room;

	my $last_round;
	my $prelims_left; 

	foreach my $other_round (
		sort {$a->name <=> $b->name} $event->rounds
	) { 

		$last_round  = $other_round 
			unless $other_round->name >= $round->name;

		next if $other_round->name < $round->name;
		next if $other_round->type eq "elim";
		next if $other_round->type eq "final";
		next if $other_round->type eq "runoff";

		$prelims_left++;
	}

	my $judge_use_ref = $m->comp(
		"/funclib/judge_use.mas", 
			round      => $round,
			event      => $event,
			limit_past => 1
		); 

	$settings{"judge_use_ref"} = $judge_use_ref;

	my %judge_use = %{$judge_use_ref};

	$round_type = "flip" if $event_settings{"no_side_constraints"};

	my $judge_indicator;

	# Judges who are not judging this round

	my %clean_judges = $m->comp(
		"/funclib/clean_judges.mas", 
			panel => $panel,
			round => $round,
			event => $event
	);

	my @good_judges = keys %clean_judges;
	@good_judges = sort {$clean_judges{$b}{"strikes"} <=> $clean_judges{$a}{"strikes"}} @good_judges;
	@good_judges = sort {$clean_judges{$b}{"ballots"} <=> $clean_judges{$a}{"ballots"}} @good_judges;

	if ($settings{"coach_ratings"}) { 
		@good_judges = 
			sort { $rating_by_judge{$a} cmp $rating_by_judge{$b} } 
			@good_judges;

		@good_judges = 
			sort { length($rating_by_judge{$b}) <=> length($rating_by_judge{$a})} 
			@good_judges;
	}

	if ($settings{"tab_ratings"}) {
		@good_judges = 
			sort { $clean_judges{$a}{"tab_ratings"} <=> $clean_judges{$b}{"tab_ratings"} }
			@good_judges;
	}

	# These are judges who are already judging in this round but could be
	# stolen to judge this one. Useful for preffed divisions

	my %busy_judges = $m->comp(
		"/funclib/clean_judges.mas", 
			panel     => $panel,
			round     => $round,
			event     => $event,
			stealable => "daveroberts"
	);

	my @busy_judges = keys %busy_judges;
	@busy_judges = sort {$busy_judges{$b}{"strikes"} <=> $busy_judges{$a}{"strikes"}} @busy_judges;
	@busy_judges = sort {$busy_judges{$b}{"ballots"} <=> $busy_judges{$a}{"ballots"}} @busy_judges;

	if ($settings{"coach_ratings"}) { 
		@busy_judges = 
			sort { $rating_by_judge{$a} cmp $rating_by_judge{$b} } 
			@busy_judges;

		@busy_judges = 
			sort { length($rating_by_judge{$b}) <=> length($rating_by_judge{$a})} 
			@busy_judges;
	}

	if ($settings{"tab_ratings"}) {
		@busy_judges = 
			sort { $busy_judges{$a}{"tab_ratings"} <=> $busy_judges{$b}{"tab_ratings"} }
			@busy_judges;
	}

	my $affref;
	my $negref;
	my $diffref;

	my %others = $m->comp(
		"/funclib/round_judge_panels.mas", 
			round  => $round,
			event  => $event,
			flight => $panel->flight
	);

	$settings{"others_ref"} = \%others;

	if ($settings{"prefs"}) { 

		my $mutuality = $category_settings{"mutuality"};
		my $preference = $category_settings{"preference"};
		$mutuality = 40 unless $mutuality;
		$preference = 20 unless $preference;

		($affref, $negref, $diffref) = $m->comp(
			"/funclib/panel_ratings.mas", 
			panel => $panel,
			type  => $settings{"prefs"}
		);

		$settings{'affref'} = $affref;
		$settings{'negref'} = $negref;

		my %sort_score;

		foreach my $gj (@good_judges) { 
			${$diffref}{$gj} = 110 unless defined ${$diffref}{$gj};
			$sort_score{$gj} = ${$diffref}{$gj} * $mutuality 
				+ (${$affref}{$gj} + ${$negref}{$gj}) * $preference;
		}

		foreach my $bj (@busy_judges) { 
			${$diffref}{$bj} = 110 unless defined ${$diffref}{$bj};
			$sort_score{$bj} = ${$diffref}{$bj} * $mutuality 
				+ (${$affref}{$bj} + ${$negref}{$bj}) * $preference;
		}

		@good_judges = 
			sort {$sort_score{$a} <=> $sort_score{$b}} 
			@good_judges;

		@busy_judges = 
			sort {$sort_score{$a} <=> $sort_score{$b}} 
			@busy_judges;
	}

	@good_judges = 
		sort {$clean_judges{$b}{"standby"} <=> $clean_judges{$a}{"standby"}}
		@good_judges;

	my %burned;

	if ($settings{"rounds_per"} 
		&& $round_type ne "elim" 
		&& $round_type ne "final"
		&& $round_type ne "runoff"
	) { 

		foreach my $gj (@good_judges) { 
			$burned{$gj}++ if $judge_use{$gj}{'left'} < 1;
		}

		@good_judges = sort {$burned{$a} <=> $burned{$b}} @good_judges;
	}

	my $aff = $m->comp("/funclib/round_elim_dueaff.mas", panel => $panel);
	undef $aff if $round_type eq "flip";

	my %judge_strings; 
	my %judge_headers; 

	my $active;

	my $worlds++ if $event->setting('usa_wsdc');

	my %good_fields = $m->comp(
		"/funclib/judge_swaplabels.mas", 
		judges       => \%clean_judges,
		settings_ref => \%settings,
		worlds       => $worlds,
		category     => $category,
		anonymize    => \%anonymize
	);

	my %busy_fields = $m->comp(
		"/funclib/judge_swaplabels.mas", 
		judges       => \%busy_judges,
		settings_ref => \%settings,
		busy         => 1,
		category     => $category,
		anonymize    => \%anonymize
	);

</%init>

	<script>
	
		function showJudges() {

			var checkObjectId = "<% $panel->id %>_bye";
	
			if ($("#"+checkObjectId).prop("checked") ) {

				$(".judgebar").addClass('hidden');
				$(".coachover").removeClass('hidden');

			} else { 

				$(".judgebar").removeClass('hidden');
				$(".coachover").addClass('hidden');
			} 

		};

		$(document).ready(function(){
			showJudges();
		});

	</script>

	<div class="main">

		<span class="half nospace">
			<h3 class="nospace">
				<% $round->realname %> 
			</h3>
		</span>

		<span class="half nospace rightalign">
			<h4 class="nospace">
				<% $section %> 
				<% $panel->letter %> of <% $event->abbr %>
			</h4>
		</span>

%		if ($panel_room == -2) {

			<div class="warn smallish">

				NOTE: Hangouts On Air require multiple steps to properly set up
				and send out invitations. 
				
				<a 
					href    = "#"
					onClick = "$('#dialog').dialog({modal: true}); return false;"
					>Information 
					
					<img 
						src   = "/lib/images/info.png"
						alt   = "Info"
						style = "vertical-align:middle"
					></a>

			</div>

			<div 
				id    = "dialog"
				title = "Hangout On Air Setup Information"
				style = "display:none"
			>

				<p>
					A Hangout On Air needs to be created by a user that will be
					available during the scheduled debate time to Start and Run
					the Hangout On Air, and that is not the Hangout Chair.
				</p>

				<p>
					This person will be responsible for starting and managing
					the broadcast of the event, and for providing the Invite
					URL that will be sent to participants through Tabroom.
				</p>

				<p>
					If this is your first Hangout On Air debate read the 
					<a href="https://www.tabroom.com/docs/wiki/Hangouts_Integration" target="_blank">
						support documentation here
					</a>.
				</p>

			</div>
%		}

%		if ($panel_room == -1 && !$panel->invites_sent) {

			<div class="warn smallish">
				This round is set up as a Google Hangout. Once all entries and
				judges are finalized remember to "Send Invites". This will
				create the Hangout event and send out invite links to all
				participants.
			</div>
%		}

		<div class="coachover full nospace row padtopmore padbottommore hidden">

<%perl>

			if (
				$round->type eq "elim" 
				|| $round->type eq "final"
				|| $round->type eq "runoff"
			) { 

				my @scores = $m->comp("/funclib/panel_scores.mas", panel => $panel);

				my $winner;

				foreach my $score (@scores) { 
					$winner = $score->ballot->entry
						if $score->value == 1 
						&& $score->tag eq "ballot";
				}   
</%perl>

				<h5 class="centeralign redtext">
					This debate is an elimination walkover
				</h5>

				<p class="centeralign">
					To hold the debate, uncheck the "Walk Over" indicator at right.
				</p>

				<div class="full padtopmore padbottommore centeralign bluetext semibold">
%					if ($winner) { 
						<% $winner->code %> is marked as advancing
%					}
				</div>

				<div class="full padmore centeralign">
					<a 
						href="/tabbing/entry/closeout.mhtml?panel_id=<% $panel->id %>&from=panel"
						class="buttonwhite bluetext"
					>	
						Enter Walkover Result
					</a>
				</div>


%			} else { 

				<h5 class="centeralign redtext">This debate is an assigned bye</h5>

				<p class="centeralign semibold">
					All debaters in this section will earn a win and averaged points
				</p>

				<p class="centeralign semibold bluetext">
					To hold an actual debate, uncheck the "Walk Over" indicator at right
				</p>

%			}

		</div>

		<div class="judgebar full nospace">

			<h5 class="semibold"><% scalar @judges %> Judges</h6>

			<& "/funclib/tablesorter.mas", table => 'sortmebaby', nobuttons => 1 &>
			
			<table id="sortmebaby">

%				if (@judges) { 

					<thead>

					<tr class="yellowrow">

						<th class="smaller">
%							if ($event->type eq "congress") { 
								Parli
%							} else { 
								Chair
%							} 
						</th>

						<th class="smaller">
							Judge
						</th>

%		 				if ($settings{"online_ballots"}) { 
							<th class="smaller">
								Link
							</th>
%						} elsif ($live_updates) { 
							<th class="smaller">
								Foll
							</th>
%						}

%						if ($settings{"rounds_per"}) { 
							<th class="smaller">
								Use
							</th>
%						}

%		 				if ($settings{"diversity"}) { 
							<th class="smaller" title="Diverse">
								Div.
							</th>
%						}


%		 				if ($settings{"coach_ratings"} || $settings{"tab_ratings"}) { 
							<th class="smaller">
								Rating
							</th>
%						}

%		 				if ($settings{"prefs"}) { 
							<th class="smaller">
								Prefs
							</th>
							<th class="smaller">
								Avg
							</th>
%						}

						<th class="smaller">
							School
						</th>

%						if ($tourn_settings->{"nsda_nats"}) { 

							<th class="smaller">
								State
							</th>

							<th class="smaller">
								District
							</th>

%						} elsif ($tourn_settings->{"ncfl"}) { 

							<th class="smaller">
								Dio
							</th>

%							if ($settings{"dio_regions"}) { 
								<th class="smaller">
									Reg
								</th>
%							}

%						} elsif ($tourn_settings->{"regions"}) { 
							<th class="smaller">
								Region
							</th>
%						} 

						<th
							class="nosort smaller" 
							colspan="2"
						>
							Remove
						</th>

%						if ($panel_room < 0) {
							<th class="smaller">
								Hangout Chair
							</th>
%						}

					</tr>

					</thead>

%				}

				<tbody>

%	 			foreach my $judge (@judges) { 

%					my $url_args = "judge_id=".$judge->id."&panel_id=".$panel->id;

					<tr id="<% $judge->id %>">

						<td class="smaller centeralign padless">

							<a 
								id    = "chair_<% $judge->id %>"
								class = "chairs buttonwhite hover semibold bigger padless
									<% $judge->chair ? "greentext fa fa-gavel" : "redtext fa fa-times" %>"
								href="chair_switch.mhtml?<% $url_args %>"
							><% $event->type eq "congress" ? "" : $judge->chair ? "Y" : "N" %></a>

						</td>

						<td class="smallish nospace">
%							if ($blind_mode) { 
								<% $anonymize{"judge"}{$judge->id} %>

%							} else { 
%								unless ($entry_only) { 
									<a 
										class="padleft padtop padbottom white" 
										href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>"
									> 
%								}
									<% ($settings{"no_judge_codes"}) ? "" : '<span class="fifth nospace">'.$judge->code."</span>"  %>
									<% $judge->first." ".$judge->last %>
								</a>
%							}
						</td>

%	 					if ($settings{"online_ballots"} || $live_updates) { 
							
							<td class="smallish centeralign">
%							 	if ($judge->person > 0) { 
									<span 
										title="Linked online!"
										class="greentext semibold fa fa-sm fa-check"
									></span>
%								} else { 
									<span 
										title="LUDDITE!"
										class="redtext semibold"
									>L</span>-<%
										scalar $m->comp("/funclib/judge_follower.mas", judge => $judge) 
									%>
%								}
							</td>
%	 					}

%						if ($settings{"rounds_per"}) { 

							<td class="smallish centeralign nospace">

								<div class="full nospace">

									<span class="third nowrap">
										<% $judge_use{$judge->id}{'percentage'} %>%
									</span>

									<span class="threefifths nowrap">
										<% 
											$judge_use{$judge->id}{'left'} 
										%>/<%
											($judge_use{$judge->id}{'judged_already'} 
												+ $judge_use{$judge->id}{'will_judge'}
											) 
										%>/<%
											$judge_use{$judge->id}{'oblig'}
										%>
									</span>
								</div>
							</td>
%						}

%	 					if ($settings{"diversity"}) { 
							<td class="smallish" align="center">
								<% $judge->setting("diverse") ? "Y" : "N" %> 
							</td>
%	 					}

%	 					if ($settings{"coach_ratings"}) { 
							<td class="smallish" align="center">
								<% $rating_by_judge{$judge->id} %>
							</td>
%	 					}

%	 					if ($settings{"prefs"}) { 

							<td class="smallish centeralign">

								<span class="twofifth nospace rightalign">
									<% ${$affref}{$judge->id} ? ${$affref}{$judge->id} : "&ndash;" %>
%									${$affref}{"total"} += ${$affref}{$judge->id};
								</span>

								<span class="half nospace rightalign">
									<% ${$negref}{$judge->id} ? ${$negref}{$judge->id} : "&ndash;" %>
%									${$negref}{"total"} += ${$negref}{$judge->id};
								</span>

							</td>

							<td class="smallish centeralign">
%								my $avg = $m->comp("/funclib/judge_avg_rating.mas", judge => $judge);
								<% $avg %>
							</td>
%	 					}

%	 					if ($settings{"tab_ratings"}) { 
							<td class="smallish centeralign">
								<% $judge->setting("tab_rating") %>
							</td>
%	 					}

						<td class="smallish">
%							unless ($blind_mode) { 
								<% $judge->schoolname 
									? Tab::short_name($judge->schoolname)
									: "HIRED"
								%>
%		 					}
						</td>

%						unless ($blind_mode) { 

%							if ($tourn_settings->{"nsda_nats"}) { 

								<td class="smallish centeralign">
									<% $judge->regioncode %>
								</td>

								<td class="smallish centeralign">
									<% $judge->districtcode %>
								</td>

%							} elsif ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"}) { 

								<td class = "smallish centeralign" >
									<% $judge->regioncode %>
								</td>

%								if ($settings{"dio_regions"}) { 

									<td class="smallish centeralign">
										<% $settings{"dio_region"}{$judge->regioncode}  %>
									</td>
<%perl>
								}
							}
						}


						my $warn; 
						my $chair_warn; 
						my $rm_chair;

						if (@scores) { 

							$warn = "These ballots have scores entered.";
							$warn .= " If you remove the judge you will also delete those scores.";
							$warn .= " Continue?";

						}

						if ($judge->chair 
							&& $event->type eq "congress" 
							&& $round->type eq "prelim"
						) { 

							$chair_warn .= " Removing the parliamentarian with this button";
							$chair_warn .= " will also remove them from the other two sessions.";
							$chair_warn .= " Are you sure?";
							$rm_chair = "rm_chair=1";

						}
</%perl>

						<td class="centeralign nospace">

%							if ($rm_chair) { 
								<a 
									class = "buttonwhite redtext hover padless marrightmore"
									alt   = "Remove from All Chambers as Parliamentarian"
									title = "Remove from All Chambers as Parliamentarian"
%									if ($warn || $chair_warn) { 
										<& "/funclib/confirm.mas", warn => $warn.$chair_warn &>
%									}

									href="judge_rm.mhtml?from=<% $from %>&<% $url_args %>&<% $rm_chair %>">
									<span class="fa fa-gavel"></span>
								</a>
%							}

							<a 
								class         = "buttonwhite redtext hover padless marno"
								alt           = "Remove judge from this section"
								title         = "Remove judge from this section"
								target_id     = "<% $judge->id %>"
								property_name = "<% $panel->id %>"
%								if ($warn) { 
									<&
										"/funclib/confirm.mas", 
											url    => "judge_remove.mhtml",
											warn   => $warn,
											switch => 1
									&>
%								}
								on_success    = "destroy"
							>
								<span class="fa fa-trash"></span>
							</a>
						</td>
						
						<td class="centeralign nospace">
							<a 
								class         = "buttonwhite redtext hover padless marno"
								alt           = "Remove & Fine"
								title         = "Remove & Fine"
								target_id     = "<% $judge->id %>"
								property_name = "<% $panel->id %>"
								setting_name  = "cha-ching!"
								onClick       = "postSwitch(this, 'judge_remove.mhtml');"
								on_success    = "destroy"
%								if ($warn) { 
									<& "/funclib/confirm.mas", warn => $warn &>
%								}
							>
								<span class="fa fa-trash"></span>

								<span class="nospace">
									&amp;
								<% $tourn_settings->{"currency"} 
									? $tourn_settings->{"currency"} 
									: '&#36;'
								%>
								</span>
							</a>
						</td>

%						if ($panel_room < 0) {
							<td class="centeralign smaller">
%							if ($judge->hangout_admin) { 
					
								Yes&nbsp;&nbsp;<a 
									class="button dkgreen" 
									href="admin_unset.mhtml?<% $url_args %>"
								>&nbsp; Unset &nbsp;</a>

%							} else {
								No&nbsp;&nbsp;<a 
									class="button dkgreen" 
									href="admin_set.mhtml?<% $url_args %>"
								>&nbsp; Set &nbsp;</a>
%							}
%						}
							</td>

					</tr>
%	 			}

				</tbody>

%	 			if ($settings{"prefs"}) { 

					<tr class="row bordertopthin">

%	 					if ($live_updates) { 
							<td class="smallish centeralign">
							</td>
%	 					}

%	 					if ($settings{"coach_ratings"}) { 
							<td class="smallish" align="center">
							</td>
%	 					}

%	 					if ($settings{"diversity"}) { 
							<td class="smallish" align="center">
							</td>
%	 					}
						
						<td colspan="3" class="smallish rightalign">
							Pref Totals:
						</td>

						<td class="smallish centeralign">

							<span class="twofifth nospace padright rightalign">
								<% sprintf("%.1f", ${$affref}{"total"}) %>
							</span>

							<span class="twofifth nospace rightalign">
								<% sprintf("%.1f", ${$negref}{"total"}) %> 
							</span>

						</td>

						<td class="smallish" align="center">
							<% sprintf("%.1f", abs(${$affref}{"total"} - ${$negref}{"total"})) %>
						</td>

						<td colspan="8" class="smallish">
							Differential
						</td>

					</tr>
%				}

			</table>

			<form action="judge_add.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel_id %>"
			>

			<input 
				type  = "hidden"
				name  = "from"
				value = "<% $from %>"
			>

			<div class="row smallish martopmore">

				<span class="tenth nospace semibold padleft centeralign">
					Available
				</span>

				<span class="fourfifths padno centeralign"> 

					<select 
						name             = "judge_id"
						class            = "fixedmost chosen"
						data-placeholder = "Clean judges without assignments..."
					>

<%perl>
						my %used;
						my $in_standby;
						my $not_in_standby;
						my $wilderson;
</%perl>
						<option value=""></option>

						<optgroup class="key" label="<% $good_fields{"label"} %>">

<%perl>
						foreach my $judge_id (@good_judges) { 
							next if $used{$judge_id}++;
							if ($burned{$judge_id} && not defined $wilderson) {
</%perl>
								<option 
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges past commitment</option>
%	 							$wilderson++;
%							}

%							if ($clean_judges{$judge_id}{"standby"} && not defined $in_standby) { 
								<option 
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges in standby pool:</option>
<%perl>
								 $in_standby++;
							}

							if ($in_standby 
								&& (not defined $not_in_standby) 
								&& (not defined $clean_judges{$judge_id}{"standby"})
							) { 
</%perl>
								<option 
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges not in standby pool:</option>
%								undef $in_standby;
%							} 
							<option value="<% $judge_id %>"><% $good_fields{$judge_id} %></option>
%	 					} 

						</optgroup>
					</select> 
				</span>

				<span class="tenth centeralign">
					<input  
						type  = "submit"
						value = "Add"
						class = "thin"
					>
					</form>
				</span>

			</div>

			<form action="judge_add.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel_id %>"
			>

			<input 
				type  = "hidden"
				name  = "from"
				value = "<% $from %>"
			>

				<div class="row smallish">

					<span class="tenth nospace semibold padleft centeralign">
						Judging 
					</span>
						
					<span class="fourfifths padno centeralign"> 

						<input 
							type  = "hidden"
							name  = "steal"
							value = "yes"
						>

						<select 
							name             = "judge_id"
							class            = "fixedmost chosen"
							data-placeholder = "Clean judges who are judging already..."
						>

						<option value=""></option>
						<optgroup class="key" label="<% $busy_fields{"label"} %>">

%						foreach my $judge_id (@busy_judges) { 
%							next if $used{$judge_id}++;
							<option value="<%$judge_id %>"><% $busy_fields{$judge_id} %></option>
%	 					} 

						</optgroup>

					</select> 

					</span>

					<span class="tenth centeralign">
						<input 
							type  = "submit"
							value = "Add"
							class = "thin"
						>
					</span>

				</div>

			</form>

		</div>

		<h4><% scalar @entries %> Entries</h4>

		<table>

			<tr class="yellowrow">

%				if ($event->type eq "speech") { 
					<th class="smaller">
						Spks
					</th>
%				} elsif ($event->type eq "wudc") { 
					<th class="smaller">
						Pos
					</th>
%				} elsif ($event->type eq "congress") { 

%				} else { 
					<th class="smaller">
						Side
					</th>
					<th class="smaller">
						Record
					</th>
%				} 

				<th class="smaller">
					Entry
				</th>

% 				if ($live_updates) { 
					<th class="smaller">
						Followers
					</th>
%				} 

				<th class="smaller">
					School
				</th>

%				if ($tourn_settings->{"nsda_nats"}) { 

					<th class="smaller">
						State
					</th>

					<th class="smaller">
						District
					</th>

%				} elsif ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"}) { 

					<th class="smaller">
						<% $tourn_settings->{"ncfl"} ? "Dio" : "Region" %>
					</th>

%					if ($settings{"dio_regions"}) { 
						<th class="smaller">
							Reg
						</th>
%					}

%				}

				<th colspan="3">
				</th>


			</tr>

% 		foreach my $entry (@entries) { 

			<tr class="<% $entry->dropped ? "lirdrow" : "row" %>">

%				if ($event->type eq "speech") { 
					<td class="smallish">
						<% $entry->speaks 
							? Lingua::EN::Numbers::Ordinate::ordinate($entry->speaks) 
							: ""
						%>
					</td>
%				} elsif ($event->type eq "wudc") { 
					<td class="smallish">
						<% $entry->speaks == 1 ? "OG" : "" %>
						<% $entry->speaks == 2 ? "OO" : "" %>
						<% $entry->speaks == 3 ? "CG" : "" %>
						<% $entry->speaks == 4 ? "CO" : "" %>
					</td>
<%perl>

				} elsif ($event->type eq "congress" ) { 

				} else { 

					if ( 
							(
							$round_type eq "elim" 
							|| $round_type eq "final" 
							|| $round_type eq "runoff" 
							|| $round_type eq "flip") 
						&& scalar @scores < 1 && not defined $aff
					) { 

</%perl>
						<td class="smallish centeralign">
							Flip
						</td>

%					} else { 

						<td class="smallish centeralign">

%							if ($aff) { 

%								if ($entry == $aff && $entry->side == 1)  { 
									<% $entry->side == 1 ? "Locked ".$aff_string : ""%>
%								} elsif (($entry != $aff) && $entry->side == 2) { 
									<% $entry->side == 2 ? "Locked ".$neg_string : ""%>
%								} else { 
									<span class="redtext inline semibold">Sidelock broken.</span><br />
									<span class="redtext inline semibold">Locked <% $aff == $entry ? "Aff" : "Neg" %></span><br />
									but on the <% $entry->side == 1 ? $aff_string : $neg_string %>
%								}


%							} else { 
								<% $entry->side == 1 ? $aff_string : $neg_string %>
%							}

						</td>
%					}
					<td class="smallish centeralign">
						<% 
							$entry_wins{$entry->id} 
							? $entry_wins{$entry->id} 
							: 0 
						%>-<% 
							$entry_losses{$entry->id} 
							? $entry_losses{$entry->id} 
							: 0
						%>
					</td>
%				} 

				<td class="smallish nospace">

%				if ($blind_mode) { 

					<% $anonymize{"entry"}{$entry->id} %>


%				} else { 
%					unless ($entry_only) { 
						<a 
							class="white button leftalign" 
							href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
						>
%					}

%					if ($event_settings{"code_style"} eq "names" 
%						|| $event_settings{"code_style"} eq "names_lastfirst"
%					) {

						<% ($entry->dq) ? "DQ -" : "" %>
						<% ($entry->dropped) ? "DROP -" : "" %>
						<% $entry->name %>

%					} else {
					
						<span class="third marno">
							<% ($entry->dq) ? "DQ -" : "" %>
							<% ($entry->dropped) ? "DROP -" : "" %>
							<% $entry->code %>
						</span>

						<span class="threefifths marno padleft">
							<% $entry->name %>
						</span>
%					}
%				}

					</a>
				</td>

% 				if ($live_updates) { 
					<td class="smallish centeralign">
						<% scalar $m->comp("/funclib/entry_follower.mas", entry => $entry) %>
					</td>
%				}
					
				<td class="smallish">
%					unless ($blind_mode) { 
						<% (not defined $settings{"no_school_codes"}) 
							? $entry->schoolcode  
							: ""
						%>
						<% Tab::short_name($entry->schoolname) %> 
%					}
				</td>

%				unless ($blind_mode) { 
%					if ($tourn_settings->{"nsda_nats"}) { 
						<td class="smallish centeralign">
							<% $entry->regioncode %>
						</td>

						<td class="smallish centeralign">
							<% $entry->districtcode %>
						</td>
%					} elsif ($tourn_settings->{"regions"} || $tourn_settings->{"ncfl"} ) { 
						<td class="smallish centeralign">
							<% $entry->regioncode %>
						</td>

%						if ($settings{"dio_regions"}) { 
							<td class="smallish centeralign">
								<% $settings{"dio_region"}{$entry->regioncode} %>
							</td>
%						}
%					}
%				}

%				unless ($entry_only) { 
					<td class="smallish centeralign nospace">
						<a 
							class="buttonwhite bluetext smallish" 
							href="/panel/manipulate/entry_edit.mhtml?entry_id=<%$entry->id%>&round_id=<% $round->id %>"
						>Move</a>
					</td>
%				}

			</tr>

% 		}

		</table>

		<br />

<%perl>

		my $timestamp;

		foreach my $ballot ($panel->ballots) { 

			$timestamp = $ballot->timestamp 
				if $ballot->audit > 0 
				&& $ballot->timestamp > $timestamp;

			$timestamp = $ballot->timestamp 
				if $ballot->audit > 0 
				&& not defined $timestamp;
		}
</%perl>

		<div class="row semibold full centeralign">

			<span class="third">
				<% $panel->started 
					?  "Started: ".Tab::niceshortdayt($panel->started->set_time_zone($tz))
					: "" %>
			</span>

			<span class="third">
				<% $panel->confirmed 
					?  "Confirmed: ".Tab::niceshortdayt($panel->confirmed->set_time_zone($tz))
					: "" %>
			</span>

			<span class="third">
				<% $timestamp 
					?  "Entered: ".Tab::niceshortdayt($timestamp->set_time_zone($tz))
					: "" %>
			</span>

		</div>

%		if ($person->site_admin) { 
			<p style="text-align: center;" >
				<% $round->realname %> 
				<% $section %> 
				<% $panel->id %> 
				Event <% $event->id %> 
				<% $aff ? $aff." aff lock" : "" %>
			</p>
%		}

	</div>

	<div class="menu">

%		if ($entry_only) { 

	        <div class="sidenote">

				<h4>Return</h4>

				<a class="blue full" href="/tabbing/entry/index.mhtml">
					Return to Ballot Entry
				</a>
			</div>

%		} else { 

		<div class="sidenote">

			<h4>Pairings/Printouts</h4>

			<a class="blue full" href="show.mhtml?round_id=<% $round->id %>">
				<% $event->abbr %> <% $round->realname %> Pairing
			</a>

			<a class="blue full" href="/panel/report/master_single.mhtml?panel_id=<% $panel->id %>">
				Print Master Ballots
			</a>

			<a class="blue <% $round_type eq "elim" ? "half" : "full" %>" 
				href="/panel/report/postings.mhtml?panel_id=<% $panel->id %>">
				Print Posting
			</a>

%			if ($round_type eq "elim" || $round_type eq "final" || $round_type eq "runoff") { 
				<a class="blue half" href="/panel/report/strike_cards.mhtml?panel_id=<% $panel->id %>">
					Print Strike Cards
				</a>
%			}

			<a class="blue full" href="/panel/schemat/panel_blast.mhtml?panel_id=<% $panel->id %>">
				Text/email blast this section
			</a>

		</div>

		<div class="sidenote">

%			if ($panel->bye || (scalar (keys %schools) < 2) ) { 

				<div class="row full nospace">

					<span class="threequarters semibold marno padleft">

%						if ($round->type eq "elim" || $round->type eq "final" || $round->type eq "runoff") { 
							Elim Walk Over
%						} else { 
							Assigned Bye
%						}

					</span>

					<span class="quarter centeralign">
						<span class="hidden"><% $panel->bye %></span>
						<label class="switch">
							<input 
								type          = "checkbox"
								value         = "1"
								id            = "<% $panel->id %>_bye"
								property_name = "bye"
								target_type   = "panel"
								target_id     = "<% $panel->id %>"
								onChange      = "
									postSwitch( this, 'panel_switch.mhtml');
									showJudges( );
								"

								<% $panel->bye ? 'checked="checked"' : "" %>
							>
							<div class="onred slider"></div>
						</label>
					</span>

				</div>

%			}

			<div class="row nospace">

				<span class="quarter padleft semibold bigger marno">
					Start:
				</span>

				<span class="half nospace centeralign">
					<% $start->day_name %> 
				</span>

				<span class="quarter nospace">
					<% &Tab::nicetime($start) %> 
				</span>

			</div>

%			if ($settings{"flighted"} > 1) { 

				<div class="row nospace padvert">

					<span class="quarter padleft semibold bigger nospace">
						Flight
					</span>

					<span class="threequarters nospace">

						<form 
							action = "panel_flight_save.mhtml"
							method = "post"
						>

						<input 
							type  = "hidden"
							name  = "panel_id"
							value = "<% $panel_id %>"
						>

						<select 
							name     = "flight"
							class    = "fixedsmall"
							onchange = 'this.form.submit()' 
						>

							<option value="">None</option>

%							foreach my $flight ( 1 .. $settings{"flighted"} ) { 	
								<option value="<% $flight %>" 
									<% $flight == $panel->flight 
									? "selected" 
									: "" %>
								> <% $flight %> </option>
%							}

						</select>

						</form>

					</span>

				</div>

%			}

			<div class="row nospace">

				<span class="quarter padleft semibold bigger marno">
					Room
				</span>

				<span class="threequarters nospace">

					<form action="panel_room_save.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "panel_id"
						value = "<% $panel_id %>"
					>

					<select
						name             = "room_id"
						onchange         = 'this.form.submit()'
						class            = "fixedsmall chosen"
						data-placeholder = "Select room:"
					>  

%						if ($room) { 
							<option value="<% $panel_room %>" "selected"><% $room->name %></option>
%						}

						<option value="">--NONE--</option>

%						if ($tourn_settings->{"googleplus"}) { 
							<option value="-1">Google Hangout</option>
							<option value="-2">Hangout On Air</option>
%						}

%						foreach my $room (@reserved_rooms) { 
							<option value="<% $room->id %>"><% $room->name %></option>
%						}

<%perl>

						if ($event_settings{"wsdc_multiple_sites"}) { 
							foreach my $room (
								$m->comp( "/funclib/clean_multisite_rooms.mas", panel => $panel)
							) { 
</%perl>
								<option value="<% $room->id %>"><% $room->name %></option>
<%perl>
							}

						} else { 

							foreach my $room (
								$m->comp("/funclib/clean_rooms.mas", panel => $panel)
							) { 
</%perl>
								<option value="<% $room->id %>"><% $room->name %></option>
%							}
%						}

					</select>
					</form>
				</span>
			</div>

%			if ($panel_room == -2) {

				<form action="panel_hoa_save.mhtml" method="post">

				<input type="hidden" name="panel_id" value="<% $panel_id %>">

				<div class="row centeralign">

					<input 
						type  = "text"
						name  = "room_ext_id"
						value = "<% $panel->room_ext_id %>"
						style = "width:186px;margin: 5px 0"
					>
				</div>

			<a 
				href    = "#"
				onClick = "$('#dialog').dialog({modal: true});return false"
				style   = "float:right;margin:0 0 10px 5px"
			><img 
				src = "/lib/images/info_lrg.png"
				alt = "Info"
			></a>

				Paste in the Google Hangout On Air event URL. Note users still need
				to be invited at the time of the event.

				<div class="liblrow centeralign padless">
					<input type="submit" class="thin" value="Save">
				</div>

			</form>

%			} elsif ($panel_room == -1) {

%				if ($panel->invites_sent) {
					Re-Send invites to all participants.
%				} else {
					Once all entries in the round are finalized, hit
					"Send Invites" to create the Google Hangout and 
					invite all participants.
%				}
%			}

%			if ($panel_room == -1 || ($panel_room == -2 && $panel->room_ext_id)) {

				<form action="panel_send_gplus_invites.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "panel_id"
						value = "<% $panel_id %>"
					>
					<div class="liblrow centeralign padless">
						<input 
							type  = "submit"
							class = "thin"
							value = "<% ($panel->invites_sent)? 'Re-' : '' %>Send Invites"
						>
					</div>
				</form>
%			}



%			my @jpools = $round->jpools;

%			if (@jpools) { 

				<div class="nospace martop">

					<span class="twofifths padleft semibold biggish marno">
						Judge Pools:
					</span>

                    <span class="threefifths nospace centeralign">
					
%					foreach my $jpool (@jpools) { 
						<a 
							class = "bordertop borderbottom plain full hover"
							href  = "/panel/judge/jpool.mhtml?pool_id = <% $jpool->id %>"
						> <% $jpool->name %> </a>
%					}

					</span>

				</div>
%			}

		</div>

		<div class="sidenote">

			<h4>Make Changes</h4>

%			if ($round->published > 0 && $event_settings{"judge_publish_results"}) { 
				<label for="<% $panel->id %>_publish">
					<div class="row nospace padless hover marbottom">

						<span class="twothirds semibold bluetext">
							Results Published
						</span>

						<span class="third nospace centeralign">
							<span class="hidden"><% $panel->publish %></span>
							<label class="switch smaller">
								<input 
									type          = "checkbox"
									value         = "1"
									id            = "<% $panel->id %>_publish"
									property_name = "publish"
									target_type   = "panel"
									target_id     = "<% $panel->id %>"
									onChange      = "postSwitch( this, 'panel_switch.mhtml');"
									<% $panel->publish ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</div>
				 </label>
%			}

%			if ($event->type eq "speech" || $event->type eq "congress") { 

				<a 
					href="speaker_order.mhtml?panel_id=<% $panel->id %>" 
					class="yellow full"
				>
					Change Speaker Order
				</a>
%			} elsif ($event->type eq "wudc") { 
				<a 
					href="wudc_sides.mhtml?panel_id=<% $panel->id %>" 
					class="yellow full"
				>
					Change Team Positions
				</a>
%			} else { 
				<a 
					href="debate_sides_swap.mhtml?panel_id=<% $panel->id %>" 
					class="yellow full"
				>
					Change Sides
				</a>
%			} 

%			unless ($blind_mode) { 	
				<a 
					href="/tabbing/entry/panel.mhtml?panel_id=<% $panel->id %>" 
					class="yellow full"
				>
					View/Edit Results
				</a>

%				if ($settings{"prefs"}) { 
					<a 
						href="prefs_report.mhtml?panel_id=<% $panel->id %>" 
						class="yellow full"
					>
						Judge Pref Report
					</a>
%				}
%			}

% 			unless (@judges || @entries) { 
				<a 
					href="/panel/manipulate/panel_rm.mhtml?panel_id=<% $panel_id %>" 
					class="dkred full"
				>Delete <% $section %></a>
% 			}
% 		}

%		unless ($reg_only || $entry_only) { 

			<p class="padno semibold redtext">Add literally any judge:</p>

			<form action="judge_add.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

   			<input 
				type  = "hidden"
				name  = "bypass_check"
				value = "true"
			>

			<div class="row centeralign">

				<select name="judge_id" class="chosen fixedmed">
<%perl>

					my $dbh = Tab::DBI->db_Main();

					my $all_judges_sth = $dbh->prepare("
						select judge.id, judge.first, judge.last, judge.code, category.abbr
						from judge, category
						where judge.category = category.id
						and category.tourn = ? 
						order by category.abbr, judge.code, judge.last
					");

					$all_judges_sth->execute($tourn->id);

					while(
						
						my ($judge_id, $first, $last, $code, $abbr) = 
							$all_judges_sth->fetchrow_array()
					) { 

</%perl>
						<option 
							value="<% $judge_id %>"
						><% $abbr %>- <% $code %> <% $last %>, <% $first %></option>
%					}

				</select>
			</div>

			<div class="liblrow centeralign padless">
				<input 
					type  = "submit"
					class = "thin"
					value = "Add Judge & Tempt Fate"
				>
			</div>

			</form>

			<p class="padno semibold bluetext">
				Change to literally any room:
			</p>

			<form 
				action = "panel_room_save.mhtml"
				method = "post"
			>

				<input 
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel->id %>"
				>

				<div class="row centeralign">

					<select 
						name  = "room_id"
						class = "fixedmed"
					>

<%perl>
						foreach my $room (
							$m->comp("/funclib/tourn_rooms.mas", 
								tourn => $tourn
							)
						) { 
</%perl>
							<option 
								value="<% $room->id %>"
							> <% $room->name %> </option>
%						}

					</select>
				</div>

				<div class="liblrow centeralign padless">

					<input 
						type  = "submit"
						class = "thin"
						value = "Change Room &amp; Tempt Fate"
					>

				</div>

			</form>

%			my $warn = "This will delete this section, together with all results and records.  Are you sure?";

			<a 
				class="dkred full martop" 
				href="/panel/manipulate/panel_rm.mhtml?panel_id=<% $panel->id %>&from=schemat"
				<& "/funclib/confirm.mas", warn => $warn &>  
			>

				Delete This 
					<% $event->type eq "speech" ? "Section" : "" %>
					<% $event->type eq "congress" ? "Chamber" : "" %>
					<% $event->type ne "speech" && $event->type ne "congress" ? "Debate" : "" %>
			</a>


			<h6 class="martop">
				Move this section to
			</h6>

			<form action="move_panel.mhtml" method="post">

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

			<div class="full row">

				<span class="threequarters">

					<select 
						name  = "round_id"
						class = "fixedsmall"
					>
						<option value=""></option>

%						foreach my $round ($event->rounds) {
							<option 
								value="<% $round->id %>"
							><% $round->realname %> </option>
%						}
					</select>

				</span>

				<span class="quarters nospace centeralign">

					<input
						type  = "submit"
						value = "Go"
						class = "thin"
					>
				</span>

			</div>

			</form>
	
		</div>

%		}

	</div>

