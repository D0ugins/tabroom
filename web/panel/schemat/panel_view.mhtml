<%args>
	$tourn
	$tourn_settings
	$person
	$panel_id
	$judge_id => undef
	$from     => undef
	$perms    => undef
</%args>
<%init>

	use List::Util;
	use Math::Round;
	use POSIX;

	my $panel = Tab::Panel->retrieve($panel_id);
	my $dbh = Tab::DBI->db_Main();

	$m->redirect("/setup/tourn/main.mhtml?err=Could%20not%20retrieve%20requested%20panel.") unless $panel;

	# I do this because it makes it easy to pass all the options to the judge
	# menu formatter.  I am not proud of it.

	my %settings;
	$settings{"nsda_nats"} = $tourn_settings->{"nsda_nats"};
	$settings{"ncfl"}      = $tourn_settings->{"ncfl"};
	$settings{"region"}    = $tourn_settings->{"regions"};

	$m->comp("/funclib/panel_dedupe.mas", panel => $panel);

	my $entry_only++ if ${$perms}{"entry_only"};

	my $reg_only++
		if ${$perms}{"limited"}
		&! ${$perms}{"registration"};

	unless ($panel) {
		$m->print("You did not select an existing panel.  Hit back and try again");
		$m->abort;
	}

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $round      = $panel->round;
	my $timeslot   = $round->timeslot;
	my $event      = $round->event;
	my $event_type = $event->type;

	my $start      = $timeslot->start;

	if ($round->start_time) {
		$start = $round->start_time();
	}
	$start->set_time_zone("UTC");
	$start->set_time_zone($tz);

	my %event_settings = $event->all_settings();

	$settings{"flighted"} = $round->flighted;

	my %judge_scores;

	my $score_sth = $dbh->prepare("
		select judge.id, score.id

		from judge, ballot, score
		where ballot.panel = ?
		and ballot.judge = judge.id
		and ballot.id = score.ballot
		and score.tag in (
			'comments', 'point', 'rank', 'refute',
			'rfd', 'speech', 'categories', 'winloss'
		)
		group by judge.id
	");

	$score_sth->execute($panel->id);

	while (
		my ($judge_id, $score_id) = $score_sth->fetchrow_array()
	) {
		$judge_scores{$judge_id}++;
	}

	$score_sth->finish;

	my %judge_sites = ();

	my $blind_mode++ if $event_settings{"blind_mode"} && $round->published < 1;
	$settings{"blind_mode"} = $blind_mode;
	$settings{"online_ballots"}++ if $event_settings{"online_ballots"};

	my %anonymize = $m->comp(
		"/funclib/blind_mode.mas",
		round => $round
	) if $blind_mode;

	if ($event_settings{'wsdc_multiple_sites'}) {

		my @round_sites = $m->comp(
			"/funclib/round_sites.mas",
			round => $round
		);

		my %site_name =
			map {$_->id => $_->name}
			@round_sites;

		my $round_time = $round->timeslot->start;
		my $today_start_string = $round_time->year."-".$round_time->month."-".$round_time->day." 00:00:00";
		my $today_end_string = $round_time->year."-".$round_time->month."-".$round_time->day." 23:59:59";

		Tab::Round->set_sql( today => "
			select round.*
			from round, timeslot
			where round.timeslot = timeslot.id
			and timeslot.start > ?
			and timeslot.start < ?
			and round.event = ?
		");

		my @todays_rounds = Tab::Round->search_today(
			$today_start_string,
			$today_end_string,
			$event->id
		);

		foreach my $today (@todays_rounds) {

			next if $today->id == $round->id;
			my @today_judges = $m->comp("/funclib/round_judges.mas", round => $today);

			%judge_sites =
				map {$_->id => $site_name{$_->site}}
				@today_judges;

			undef @today_judges;
		}

		$settings{"judge_sites"} = \%judge_sites;
	}

	$settings{"region"}++ if $event_settings{"region_avoid"};
	$settings{"region"}++ if $event_settings{"region_constrain"};

	my $category = $event->category;
	my %category_settings = $category->all_settings();

	if ($category_settings{"conflict_region_judges"}) {

		$settings{"dio_regions"}++;

        foreach my $diocese (
			$m->comp(
				"/funclib/tourn_regions.mas",
				tourn => $tourn)
		) {
			$settings{"dio_region"}{$diocese->code}
				= $diocese->setting("region-".$event->id);
		}
	}

	my $aff_string = $event_settings{"aff_label"};
	my $neg_string = $event_settings{"neg_label"};

	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	$start->add(minutes => $event_settings{"flight_offset"} * ($panel->flight - 1));
	my $live_updates++ if $event_settings{'live_updates'};

	my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);

	my $all++ if $tourn_settings->{"nsda_nats"} && $event_settings{"supp"};

	my %entry_wins;
	my %entry_losses;

	my %tb_types = $m->comp("/funclib/tiebreak_types.mas", round => $round);

	if ($tb_types{"winloss"}) {

		my $last_round = Tab::Round->search(
			event => $event->id,
			name  => ($round->name - 1)
		)->first;

		%entry_wins = $m->comp(
			"/funclib/entry_wins.mas",
				event => $event,
				round => $last_round,
				all   => $all
			);

		%entry_losses = $m->comp(
			"/funclib/entry_losses.mas",
			event => $event,
			round => $last_round,
			all   => $all
		);
	}

	my @reserved_rooms;

	foreach my $judge (@judges) {
		my $r_id = $judge->setting('room_reserved');
		my $r2 = Tab::Room->retrieve($r_id) if $r_id;
		push @reserved_rooms, $r2 if $r2;
	}

	my %flips;

	my $entries_sth = $dbh->prepare("
		select
			entry.id, entry.code, entry.name, entry.dropped, entry.dq,
			student.last,
			ballot.id, ballot.side, ballot.speakerorder,
			flip.value_text,
			flip_at.value_date,
			flip_status.value,
			flip_winner.value,

			team_order.value,
			school.id, school.code, school.name, school.state,
			region.id, region.code, region.name,
			district.id, district.code, district.name,
			po.value,
			strike.person, strike.description, strike.timestamp,
			autostrike.description, autostrike.timestamp,
			count(follower.id), count(distinct student.person),
			video_link.value_text

		from (entry, ballot, panel)
			left join school on school.id = entry.school
			left join region on school.region = region.id
			left join district on school.district = district.id
			left join score po on po.ballot = ballot.id and po.tag = 'po'
			left join entry_student es on es.entry = entry.id
			left join student on es.student = student.id
			left join follower on follower.entry = entry.id

			left join change_log strike
				on strike.old_panel = panel.id
				and strike.entry = entry.id
				and strike.type     = 'strikecard'

			left join change_log autostrike
				on autostrike.old_panel = panel.id
				and autostrike.type     = 'autostrike'

			left join event_setting team_order
				on team_order.event = entry.event
				and team_order.tag = 'flip_team_order'

			left join entry_setting video_link
				on video_link.entry = entry.id
				and video_link.tag = 'video_link'

			left join panel_setting flip
				on flip.panel = panel.id
				and flip.tag = 'flip'

			left join panel_setting flip_winner
				on flip_winner.panel = panel.id
				and flip_winner.tag = 'flip_winner'

			left join panel_setting flip_at
				on flip_at.panel = panel.id
				and flip_at.tag = 'flip_at'

			left join panel_setting flip_status
				on flip_status.panel = panel.id
				and flip_status.tag = 'flip_status'

		where entry.id = ballot.entry
			and ballot.panel = panel.id
			and panel.id = ?
		group by ballot.id
		order by ballot.side, ballot.speakerorder, entry.code
	");

	$entries_sth->execute($panel->id);

	my %entries;
	my %schools;

	while (
		my (
			$entry_id, $entry_code, $entry_name, $entry_dropped, $entry_dq,
			$student_last,
			$ballot_id, $ballot_side, $ballot_speakerorder,
			$flip, $flip_at, $flip_status, $flip_winner,
			$team_order,
			$school_id, $school_code, $school_name, $school_state,
			$region_id, $region_code, $region_name,
			$district_id, $district_code, $district_name,
			$po_value,
			$strike_person, $strike_description, $strike_timestamp,
			$autostrike_description, $autostrike_timestamp,
			$follower_count, $person_count,
			$video_link
		) = $entries_sth->fetchrow_array()
	) {

		$entries{$entry_id}{"followers"}    = int($follower_count + $person_count + 0);
		$entries{$entry_id}{"dropped"}      = $entry_dropped;
		$entries{$entry_id}{"dq"}           = $entry_dq;
		$entries{$entry_id}{"code"}         = $entry_code;
		$entries{$entry_id}{"name"}         = $entry_name;
		$entries{$entry_id}{"school_code"}  = $school_code;
		$entries{$entry_id}{"school_name"}  = $school_name;
		$entries{$entry_id}{"school_state"} = $school_state;
		$entries{$entry_id}{"video_link"}   = $video_link;

		if ($strike_person) {
			$entries{$entry_id}{"strike_by"}   = $strike_person;
			$entries{$entry_id}{"strike_desc"} = $strike_description;
			$entries{$entry_id}{"strike_at"}   = $strike_timestamp;
		} elsif ($autostrike_description) {
			$entries{$entry_id}{"strike_auto"}  = 1;
			$entries{$entry_id}{"strike_desc"} = $autostrike_description;
			$entries{$entry_id}{"strike_at"}   = $autostrike_timestamp;
		}

		if ($flip) {
			unless (%flips) {
				%flips = eval {
					return %{JSON::decode_json($flip)};
				};
			}
		}

		$flips{"deadline"} = eval {
			my $dt = DateTime::Format::MySQL->parse_datetime($flip_at);
			$dt->set_time_zone("UTC");
			$dt->set_time_zone($tz);
		};

		$flips{"team_order"} = $team_order;

		if ($flip_winner == $entry_id) {
			$flips{"won"} = $entry_id;
			$flips{"winner"} = $entry_code;
		}

		$flips{"status"} = $flip_status;

		$entries{$entry_id}{"region_code"}   = $region_code;
		$entries{$entry_id}{"region_name"}   = $region_name;
		$entries{$entry_id}{"district_code"} = $district_code;
		$entries{$entry_id}{"district_name"} = $district_name;

		if ($event_type eq "speech") {
			$entries{$entry_id}{"speaks"} = $ballot_speakerorder;
		} elsif ($event_type eq "congress") {
			$entries{$entry_id}{"po"}   = $po_value;
			$entries{$entry_id}{"last"} = $student_last;
		} else {
			$entries{$entry_id}{"order"}  = $ballot_speakerorder;
			$entries{$entry_id}{"side"}   = $ballot_side;
			$entries{$entry_id}{"speaks"} = 0;
			$entries{$entry_id}{"po"}     = 0;
		}
	}

	$settings{"tab_ratings"}++ if $category_settings{"tab_ratings"};
	$settings{"prefs"} = $category_settings{"prefs"};

	if ($settings{"prefs"} eq "ndt") {
		$settings{"prefs"} = "ordinals";
		$settings{"prefs"} = "tiered" if $round->type eq "elim";
		$settings{"prefs"} = "tiered" if $round->type eq "final";
		$settings{"prefs"} = "tiered" if $round->type eq "runoff";
		$settings{"prefs"} = "ordinals" if $round->name == 9;
	}

	undef $settings{"prefs"} if $settings{"prefs"} eq "none";

	if ($settings{"prefs"}) {
		%{$settings{"averages"}} = $m->comp("/funclib/judge_averages.mas", category => $category, prefs => $settings{"prefs"});
	}

	$settings{"no_judge_codes"}++ if $category_settings{"no_codes"};
	$settings{"no_school_codes"}++ if $tourn_settings->{"school_codes"} eq "none";
	$settings{"diversity"}++ if $category_settings{"track_diversity"};

	my %rating_by_judge = ();

	$settings{"coach_ratings"} = $category_settings{"coach_ratings"};

	if ($category_settings{"coach_ratings"} ) {

		my $rating_sth = $dbh->prepare("

			select judge.id, rating_tier.name, subrt.name

			from (judge, round, event, rating_tier, rating)

			left join rating_subset on rating_subset.id = event.rating_subset
			left join rating subrating on subrating.rating_subset = rating_subset.id
				and subrating.judge = judge.id
				and subrating.type = 'coach'

			left join rating_tier subrt on subrt.id = subrating.rating_tier

			where round.id = ?
			and round.event = event.id
			and judge.id = rating.judge
			and rating.rating_tier = rating_tier.id
			and rating.type = 'coach'

			and (
				judge.category = event.category
				or judge.alt_category = event.category
			)
		");

		$rating_sth->execute($round->id);

		while (
			my ($judge_id, $rating_tier, $better_rating_tier) = $rating_sth->fetchrow_array()
		) {
			$rating_by_judge{$judge_id} = $rating_tier;
			$rating_by_judge{$judge_id} = $better_rating_tier if $better_rating_tier;
		}
	}

	$settings{"rating_by_judge_ref"} = \%rating_by_judge;
	$settings{"rounds_per"} = $category_settings{"rounds_per"};

	my $round_type = $round->type;

	undef $settings{"rounds_per"}
		if $round_type eq "elim"
		|| $round_type eq "final"
		|| $round_type eq "runoff";

	my $section = "Debate";
	$section = "Section" if $event_type eq "speech";
	$section = "Chamber" if $event_type eq "congress";

	my $room = $panel->room if $panel->room;
	my $panel_room = $room->id if $room;

	my $judge_use_ref = $m->comp(
		"/funclib/judge_use.mas",
			round      => $round,
			event      => $event,
			limit_past => 1
		);

	$settings{"judge_use_ref"} = $judge_use_ref;

	my %judge_use = %{$judge_use_ref};

	$round_type = "flip" if $event_settings{"no_side_constraints"};

	my $judge_indicator;

	# Judges who are not judging this round

	my %clean_judges = $m->comp(
		"/funclib/clean_judges.mas",
			panel => $panel,
			round => $round,
			event => $event
	);

	my @good_judges = List::Util::shuffle(keys %clean_judges);
	@good_judges = sort {$clean_judges{$b}{"strikes"} <=> $clean_judges{$a}{"strikes"}} @good_judges;
	@good_judges = sort {$clean_judges{$b}{"ballots"} <=> $clean_judges{$a}{"ballots"}} @good_judges;
	@good_judges = sort {$judge_use{$b}{"percentage"} <=> $judge_use{$a}{"percentage"}} @good_judges;

	if ($settings{"coach_ratings"}) {
		@good_judges =
			sort { $rating_by_judge{$a} cmp $rating_by_judge{$b} }
			@good_judges;

		@good_judges =
			sort { length($rating_by_judge{$b}) <=> length($rating_by_judge{$a})}
			@good_judges;
	}

	if ($settings{"tab_ratings"}) {
		@good_judges =
			sort { $clean_judges{$a}{"tab_ratings"} <=> $clean_judges{$b}{"tab_ratings"} }
			@good_judges;
	}

	# These are judges who are already judging in this round but could be
	# stolen to judge this one. Useful for preffed divisions

	my %busy_judges = $m->comp(
		"/funclib/clean_judges.mas",
			panel     => $panel,
			round     => $round,
			event     => $event,
			stealable => "daveroberts"
	);

	my @busy_judges = keys %busy_judges;
	@busy_judges = sort {$busy_judges{$b}{"strikes"} <=> $busy_judges{$a}{"strikes"}} @busy_judges;
	@busy_judges = sort {$busy_judges{$b}{"ballots"} <=> $busy_judges{$a}{"ballots"}} @busy_judges;

	if ($settings{"coach_ratings"}) {
		@busy_judges =
			sort { $rating_by_judge{$a} cmp $rating_by_judge{$b} }
			@busy_judges;

		@busy_judges =
			sort { length($rating_by_judge{$b}) <=> length($rating_by_judge{$a})}
			@busy_judges;
	}

	if ($settings{"tab_ratings"}) {
		@busy_judges =
			sort { $busy_judges{$a}{"tab_ratings"} <=> $busy_judges{$b}{"tab_ratings"} }
			@busy_judges;
	}

	my $affref;
	my $negref;
	my $diffref;
	my %others = ();

	unless ($event_settings{"online_mode"} eq "async") {
		%others = $m->comp(
			"/funclib/round_judge_panels.mas",
				round  => $round,
				event  => $event,
				flight => $panel->flight
		);
	}

	$settings{"others_ref"} = \%others;

	if ($settings{"prefs"}) {

		my $mutuality = $category_settings{"mutuality"};
		my $preference = $category_settings{"preference"};
		$mutuality = 40 unless $mutuality;
		$preference = 20 unless $preference;

		($affref, $negref, $diffref) = $m->comp(
			"/funclib/panel_ratings.mas",
			panel    => $panel,
			type     => $settings{"prefs"}
		);

		$settings{'affref'} = $affref;
		$settings{'negref'} = $negref;

		my %sort_score;

		foreach my $gj (@good_judges) {
			${$diffref}{$gj} = 110 unless defined ${$diffref}{$gj};
			$sort_score{$gj} = ${$diffref}{$gj} * $mutuality
				+ (${$affref}{$gj} + ${$negref}{$gj}) * $preference;
		}

		foreach my $bj (@busy_judges) {
			${$diffref}{$bj} = 110 unless defined ${$diffref}{$bj};
			$sort_score{$bj} = ${$diffref}{$bj} * $mutuality
				+ (${$affref}{$bj} + ${$negref}{$bj}) * $preference;
		}

		if ($event_settings{"max_pref"}) {

			foreach my $judge (@good_judges, @busy_judges) {

				$sort_score{$judge} += 50000000
					if (${$affref}{$judge} > $event_settings{"max_pref"});

				$sort_score{$judge} += 50000000
					if (${$negref}{$judge} > $event_settings{"max_pref"});
			}
		}

		@good_judges =
			sort {$sort_score{$a} <=> $sort_score{$b}}
			@good_judges;

		@busy_judges =
			sort {$sort_score{$a} <=> $sort_score{$b}}
			@busy_judges;
	}

	@good_judges =
		sort {$clean_judges{$b}{"standby"} <=> $clean_judges{$a}{"standby"}}
		@good_judges;

	my %burned;

	if ($settings{"rounds_per"}
		&& $round_type ne "elim"
		&& $round_type ne "final"
		&& $round_type ne "runoff"
	) {

		foreach my $gj (@good_judges) {
			$burned{$gj}++ if $judge_use{$gj}{'left'} < 1;
		}

		@good_judges = sort {$burned{$a} <=> $burned{$b}} @good_judges;
	}

	my $aff;

	if ($event_type eq "debate" && $round_type ne "flip") {
		$aff = $m->comp("/funclib/round_elim_dueaff.mas", panel => $panel);
	}

	my %judge_strings;
	my %judge_headers;

	my $active;
	my $worlds++ if $event->setting('usa_wsdc');

	my %good_fields = $m->comp(
		"/funclib/judge_swaplabels.mas",
			judges       => \%clean_judges,
			settings_ref => \%settings,
			worlds       => $worlds,
			category     => $category,
			anonymize    => \%anonymize
	);

	my %busy_fields = $m->comp(
		"/funclib/judge_swaplabels.mas",
			judges       => \%busy_judges,
			settings_ref => \%settings,
			busy         => 1,
			category     => $category,
			anonymize    => \%anonymize
	);

	my ($code_school, $code_name) = $m->comp("/funclib/code_style.mas", event => $event);

	my $show_async = $panel->setting("show_async");

</%init>

	<script>

		function showJudges() {

			var checkObjectId = "<% $panel->id %>_bye";

			if ($("#"+checkObjectId).prop("checked") ) {

				$(".judgebar").addClass('hidden');
				$(".coachover").removeClass('hidden');

			} else {

				$(".judgebar").removeClass('hidden');
				$(".coachover").addClass('hidden');
			}

		};

		$(document).ready(function(){
			showJudges();
		});

	</script>

	<div class="main">

		<span class="half nospace">
			<h3 class="nospace">
				<% $round->realname %>
			</h3>
		</span>

		<span class="half nospace rightalign">
			<h4 class="nospace">
				<% $section %>
				<% $panel->letter %> of <% $event->abbr %>
			</h4>
		</span>

%		if ($panel_room == -2) {

			<div class="warn smallish">

				NOTE: Hangouts On Air require multiple steps to properly set up
				and send out invitations.

				<a
					href    = "#"
					onClick = "$('#dialog').dialog({modal: true}); return false;"
					>Information

					<img
						src   = "/lib/images/info.png"
						alt   = "Info"
						style = "vertical-align:middle"
					></a>

			</div>

			<div
				id    = "dialog"
				title = "Hangout On Air Setup Information"
				style = "display:none"
			>

				<p>
					A Hangout On Air needs to be created by a user that will be
					available during the scheduled debate time to Start and Run
					the Hangout On Air, and that is not the Hangout Chair.
				</p>

				<p>
					This person will be responsible for starting and managing
					the broadcast of the event, and for providing the Invite
					URL that will be sent to participants through Tabroom.
				</p>

				<p>
					If this is your first Hangout On Air debate read the
					<a href="https://www.tabroom.com/docs/wiki/Hangouts_Integration" target="_blank">
						support documentation here
					</a>.
				</p>

			</div>
%		}

%		if ($panel_room == -1 && !$panel->invites_sent) {

			<div class="warn smallish">
				This round is set up as a Google Hangout. Once all entries and
				judges are finalized remember to "Send Invites". This will
				create the Hangout event and send out invite links to all
				participants.
			</div>
%		}

		<div class="coachover full nospace odd padtopmore padbottommore hidden">

<%perl>

			if (
				$round->type eq "elim"
				|| $round->type eq "final"
				|| $round->type eq "runoff"
			) {

				my $winner_sth = $dbh->prepare("
					select entry.code
					from entry, ballot, score
					where ballot.panel = ?
						and ballot.id = score.ballot
						and score.tag = 'winloss'
						and score.value = 1
						and ballot.entry = entry.id
				");

				$winner_sth->execute($panel->id);
				my $winner;

				while (
					my ($winner_code) = $winner_sth->fetchrow_array()
				) {
					$winner = $winner_code;
				}

</%perl>

				<h5 class="centeralign redtext">
					This debate is an elimination walkover
				</h5>

				<p class="centeralign">
					To hold the debate, uncheck the "Walk Over" indicator at right.
				</p>

				<div class="full padtopmore padbottommore centeralign bluetext semibold">
%					if ($winner) {
						<% $winner %> is marked as advancing
%					}
				</div>

				<div class="full padmore centeralign">
					<a
						href="/tabbing/entry/closeout.mhtml?panel_id=<% $panel->id %>&from=panel"
						class="buttonwhite bluetext"
					>
						Enter Walkover Result
					</a>
				</div>

%			} else {

				<h5 class="centeralign redtext">This debate is an assigned bye</h5>

				<p class="centeralign semibold">
					All debaters in this section will earn a win and averaged points
				</p>

				<p class="centeralign semibold bluetext">
					To hold an actual debate, uncheck the "Walk Over" indicator at right
				</p>

%			}

		</div>

		<div class="judgebar full nospace">

			<h5 class="semibold"><% scalar @judges %> Judges</h6>

			<& "/funclib/tablesorter.mas", table => 'sortmebaby', nobuttons => 1 &>

			<table id="sortmebaby">

%				if (@judges) {

					<thead>

					<tr class="yellowrow">

						<th class="smaller">
%							if ($event_type eq "congress") {
								Parli
%							} else {
								Chair
%							}
						</th>

						<th class="smaller">
							Judge
						</th>

%		 				if ($settings{"online_ballots"}) {
							<th class="smaller">
								Link
							</th>
%						} elsif ($live_updates) {
							<th class="smaller">
								Foll
							</th>
%						}

%						if ($settings{"rounds_per"}) {
							<th class="smaller">
								Use
							</th>
%						}

%		 				if ($settings{"diversity"}) {
							<th class="smaller" title="Diverse">
								Div.
							</th>
%						}

%		 				if ($settings{"coach_ratings"}) {
							<th class="smaller">
								Coach Rating
							</th>
%						}

%						if ($settings{"tab_ratings"}) {
							<th class="smaller">
								Tab Rating
							</th>
%						}

%		 				if ($settings{"prefs"}) {
							<th class="smaller">
								Prefs
							</th>
							<th class="smaller">
								Avg
							</th>
%						}

						<th class="smaller">
							School
						</th>

%						if ($tourn_settings->{"nsda_nats"}) {

							<th class="smaller">
								State
							</th>

							<th class="smaller">
								District
							</th>

%						} elsif ($tourn_settings->{"ncfl"}) {

							<th class="smaller">
								Dio
							</th>

%							if ($settings{"dio_regions"}) {
								<th class="smaller">
									Reg
								</th>
%							}

%						} elsif ($tourn_settings->{"regions"}) {
							<th class="smaller">
								Region
							</th>
%						}

						<th
							class="nosort smaller"
						>
							Remove
						</th>

						<th
							class="nosort smaller"
						>
							RM &amp; Fine
						</th>

%						if ($panel_room < 0) {
							<th class="smaller">
								Hangout Chair
							</th>
%						}

						<th
							class="nosort smaller"
						>
							Started
						</th>

%						if ($person->site_admin) {
							<th
								class="nosort smaller"
							>
								Ballot
							</th>
%						}
					</tr>

					</thead>

%				}

				<tbody>

%	 			foreach my $judge (@judges) {

%					my $url_args = "judge_id=".$judge->id."&panel_id=".$panel->id;

					<tr id="<% $judge->id %>">

						<td class="smaller centeralign padless">

							<a
								id    = "chair_<% $judge->id %>"
								class = "chairs buttonwhite hover semibold bigger padless
									<% $judge->chair ? "greentext fa fa-gavel" : "redtext fa fa-times" %>"
								href="chair_switch.mhtml?<% $url_args %>"
							><% $event_type eq "congress" ? "" : $judge->chair ? "Y" : "N" %></a>

						</td>

						<td class="smallish nospace">
%							if ($blind_mode) {
								<% $anonymize{"judge"}{$judge->id} %>

%							} else {
%								unless ($entry_only) {
									<a
										class="padleft padtop padbottom white"
										href="/register/judge/edit.mhtml?judge_id=<% $judge->id %>"
									>
%								}
									<% ($settings{"no_judge_codes"}) ? "" : '<span class="quarter nospace">'.$judge->code."</span>"  %>
									<% $judge->first." ".$judge->last %>
								</a>
%							}
						</td>

%	 					if ($settings{"online_ballots"}) {
							<td class="smallish centeralign">
%							 	if ($judge->person > 0) {
									<span
										title="Linked online!"
										class="greentext semibold fa fa-sm fa-check"
									></span>
%								} else {
									<span
										title="LUDDITE!"
										class="redtext semibold"
									>L</span>-
%								}
							</td>
%						} elsif ($live_updates) {
							<td class="smallish centeralign">
								<% scalar $m->comp("/funclib/judge_follower.mas", judge => $judge) %>
							</td>
%	 					}

%						if ($settings{"rounds_per"}) {
							<td class="smallish centeralign nospace">
								<span class="padrightmore">
									<% $judge_use{$judge->id}{'percentage'} %>%
								</span>

								<span>
									<%
										$judge_use{$judge->id}{'left'}
									%>/<%
										($judge_use{$judge->id}{'judged_already'}
											+ $judge_use{$judge->id}{'will_judge'}
										)
									%>/<%
										$judge_use{$judge->id}{'oblig'}
									%>
								</span>
							</td>
%						}

%	 					if ($settings{"diversity"}) {
							<td class="smallish" align="center">
								<% $judge->setting("diverse") ? "Y" : "N" %>
							</td>
%	 					}

%	 					if ($settings{"coach_ratings"}) {
							<td class="smallish" align="center">
								<% $rating_by_judge{$judge->id} %>
							</td>
%	 					}

%	 					if ($settings{"prefs"}) {
							<td class="smallish centeralign">
								<span class="twofifth nospace rightalign
									<% $event_settings{"max_pref"} && ${$affref}{$judge->id} > $event_settings{"max_pref"}
										? "semibold redtext"
										: ""
									%>
								">
									<% ${$affref}{$judge->id} ? ${$affref}{$judge->id} : "&ndash;" %>
%									${$affref}{"total"} += ${$affref}{$judge->id};
								</span>

								<span class="half nospace rightalign
									<% $event_settings{"max_pref"} && ${$negref}{$judge->id} > $event_settings{"max_pref"}
										? "semibold redtext"
										: ""
									%>
								">
									<% ${$negref}{$judge->id} ? ${$negref}{$judge->id} : "&ndash;" %>
%									${$negref}{"total"} += ${$negref}{$judge->id};
								</span>

							</td>

							<td class="smallish centeralign">
								<% $settings{"averages"}{$judge} %>
							</td>
%	 					}

%	 					if ($settings{"tab_ratings"}) {
							<td class="smallish centeralign">
								<% $judge->setting("tab_rating") %>
							</td>
%	 					}

						<td class="smallish">
%							unless ($blind_mode) {
								<% $judge->schoolname
									? Tab::short_name($judge->schoolname)
									: "HIRED"
								%>
%		 					}
						</td>

%						unless ($blind_mode) {

%							if ($tourn_settings->{"nsda_nats"}) {

								<td class="smallish centeralign">
									<% $judge->regioncode %>
								</td>

								<td class="smallish centeralign">
									<% $judge->districtcode %>
								</td>

%							} elsif ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"}) {

								<td class = "smallish centeralign" >
									<% $judge->regioncode %>
								</td>

%								if ($settings{"dio_regions"}) {

									<td class="smallish centeralign">
										<% $settings{"dio_region"}{$judge->regioncode}  %>
									</td>
<%perl>
								}
							}
						}

						my $warn;
						my $chair_warn;
						my $rm_chair;

						if ($judge_scores{$judge->id}) {
							$warn = $judge->first." ".$judge->last." has scores or feedback entered.";
							$warn .= " If you remove the judge, you will also delete those scores.";
							$warn .= " Continue?";
						}

						if ($judge->chair
							&& $event_type eq "congress"
							&& $round->type eq "prelim"
						) {

							$chair_warn .= " Removing the parliamentarian with this button";
							$chair_warn .= " will also remove them from the other two sessions.";
							$chair_warn .= " Are you sure?";
							$rm_chair = "rm_chair=1";

						}
</%perl>

						<td class="centeralign nospace">

%							if ($rm_chair) {
								<a
									class = "buttonwhite redtext hover padless marrightmore"
									alt   = "Remove from All Chambers as Parliamentarian"
									title = "Remove from All Chambers as Parliamentarian"
%									if ($warn || $chair_warn) {
										<& "/funclib/confirm.mas", warn => $warn.$chair_warn &>
%									}

									href="judge_rm.mhtml?from=<% $from %>&<% $url_args %>&<% $rm_chair %>">
									<span class="fa fa-gavel"></span>
								</a>
%							}

							<a
								class         = "buttonwhite redtext hover padless marno"
								alt           = "Remove judge from this section"
								title         = "Remove judge from this section"
								target_id     = "<% $judge->id %>"
								property_name = "<% $panel->id %>"
%								if ($warn) {
									<&
										"/funclib/confirm.mas",
											url    => "judge_remove.mhtml",
											warn   => $warn,
											switch => 1
									&>
%								} else {
									onClick  = "postSwitch(this, 'judge_remove.mhtml');"
%								}
								on_success    = "destroy"
							>
								<span class="fa fa-trash"></span>
							</a>
						</td>

						<td class="centeralign nospace">
							<a
								class         = "buttonwhite greentext hover padvertless marno bigger"
								alt           = "Remove & Fine"
								title         = "Remove & Fine"
								target_id     = "<% $judge->id %>"
								property_name = "<% $panel->id %>"
								setting_name  = "cha-ching!"
								onClick       = "postSwitch(this, 'judge_remove.mhtml');"
								on_success    = "destroy"
%								if ($warn) {
									<& "/funclib/confirm.mas", warn => $warn &>
%								} else {
									onClick  = "postSwitch(this, 'judge_remove.mhtml');"
%								}
							>
								<% $tourn_settings->{"currency"}
									? $tourn_settings->{"currency"}
									: '&#36;'
								%>
							</a>
						</td>

						<td
							class="centeralign nospace smallish"
							title="Started by <% $judge->started_by_name %>"
						>
							<& "/funclib/showtime.mas",
								string => $judge->started,
								tz     => $tz
							&>
						</td>

%						if ($person->site_admin) {
							<td
								class="centeralign nospace smallish"
								title="Started by <% $judge->started_by_name %>"
							>
								<a
									class  = "fa buttonwhite greentext fa-file-text"
									target = "_blank"
									href   = "/user/judge/ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
								></a>
							</td>
%						}

					</tr>
%	 			}

				</tbody>

%	 			if ($settings{"prefs"}) {

					<tr class="row bordertopthin">

%	 					if ($live_updates) {
							<td class="smallish centeralign">
							</td>
%	 					}

%	 					if ($settings{"coach_ratings"}) {
							<td class="smallish" align="center">
							</td>
%	 					}

%	 					if ($settings{"diversity"}) {
							<td class="smallish" align="center">
							</td>
%	 					}

						<td colspan="3" class="smallish rightalign">
							Pref Totals:
						</td>

						<td class="smallish centeralign">

							<span class="twofifth nospace padright rightalign">
								<% sprintf("%.1f", ${$affref}{"total"}) %>
							</span>

							<span class="twofifth nospace rightalign">
								<% sprintf("%.1f", ${$negref}{"total"}) %>
							</span>

						</td>

						<td class="smallish" align="center">
							<% sprintf("%.1f", abs(${$affref}{"total"} - ${$negref}{"total"})) %>
						</td>

						<td colspan="8" class="smallish">
							Differential
						</td>

					</tr>
%				}

			</table>

			<div class="row smallish martopmore">

				<form
					action="judge_add.mhtml"
					method="post"
				>

				<input
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel_id %>"
				>

				<input
					type  = "hidden"
					name  = "from"
					value = "<% $from %>"
				>

				<span class="tenth nospace semibold padleft centeralign">
					Available
				</span>

				<span class="fourfifths padno centeralign">

					<select
						name             = "judge_id"
						class            = "fixedmost"
						data-placeholder = "Clean judges <% $event_settings{"online_mode"} eq "async" ? "" : "without assignments..." %>"
					>

<%perl>
						my %used;
						my $in_standby;
						my $not_in_standby;
						my $wilderson;
</%perl>
						<option value=""></option>
						<optgroup class="key" label="<% $good_fields{"label"} %>">
<%perl>
						foreach my $judge_id (@good_judges) {
							next if $used{$judge_id}++;
							if ($burned{$judge_id} && not defined $wilderson) {
</%perl>
								<option
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges past commitment</option>
%	 							$wilderson++;
%							}

%							if ($clean_judges{$judge_id}{"standby"} && not defined $in_standby) {
								<option
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges in standby pool:</option>
<%perl>
								 $in_standby++;
							}

							if ($in_standby
								&& (not defined $not_in_standby)
								&& (not defined $clean_judges{$judge_id}{"standby"})
							) {
</%perl>
								<option
									value    = "x"
									disabled = "true"
									class    = "key"
								>Judges not in standby pool:</option>
%								undef $in_standby;
%							}
							<option value="<% $judge_id %>"><% $good_fields{$judge_id} %></option>
%	 					}

						</optgroup>
					</select>
				</span>

				<span class="tenth centeralign">
					<button
						value   = "Add"
						class   = "thin buttonwhite bluetext invert fa fa-lg fa-plus padleft"
					></button>
				</span>

				</form>
			</div>

%			unless ($event_settings{"online_mode"} eq "async") {

				<div class="even smallish">

					<form action="judge_add.mhtml" method="post">

					<input
						type  = "hidden"
						name  = "panel_id"
						value = "<% $panel_id %>"
					>

					<input
						type  = "hidden"
						name  = "from"
						value = "<% $from %>"
					>

						<span class="tenth nospace semibold padleft centeralign">
							Judging
						</span>

						<span class="fourfifths padno centeralign">

							<input
								type  = "hidden"
								name  = "steal"
								value = "yes"
							>

							<select
								name             = "judge_id"
								class            = "fixedmost"
								data-placeholder = "Clean judges who are judging already..."
							>

							<option value=""></option>
							<optgroup class="key" label="<% $busy_fields{"label"} %>">

%							foreach my $judge_id (@busy_judges) {
%								next if $used{$judge_id}++;
								<option value="<%$judge_id %>"><% $busy_fields{$judge_id} %></option>
%	 						}

							</optgroup>

						</select>

						</span>

						<span class="tenth centeralign">
							<button
								value   = "Add"
								class   = "thin buttonwhite bluetext invert fa fa-lg fa-plus padleft"
							></button>
						</span>
					</form>
				</div>
%			}
		</div>

		<h5 class="martopmore">
			<% scalar (keys %entries) %> Entries
		</h5>

		<table>
			<thead>

			<tr class="yellowrow">
%				if ($event_type eq "speech") {
					<th class="smaller centeralign">
						Spks
					</th>
%				} elsif ($event_type eq "wudc") {
					<th class="smaller">
						Pos
					</th>
%				} elsif ($event_type eq "congress") {
					<th class="smaller">
					</th>
%				} else {
					<th class="smaller">
						Side
					</th>

%					if ($flips{"team_order"}) {
						<th title="Speaker Position" class="smaller">
							Spks
						</th>
%					}

					<th class="smaller" title="Records">
						Rs
					</th>
%				}

				<th class="smaller">
					Entry
				</th>

%				if ($event_settings{"online_prep"}) {
					<th class="smaller">
						Prep
					</th>
%				}

% 				if ($live_updates) {
					<th title="Followers" class="smaller centeralign">
						Fs
					</th>
%				}

				<th class="smaller">
					School
				</th>

%				if ($tourn_settings->{"nsda_nats"}) {

					<th class="smaller">
						State
					</th>

					<th class="smaller">
						District
					</th>

%				} elsif ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"}) {

					<th class="smaller">
						<% $tourn_settings->{"ncfl"} ? "Dio" : "Region" %>
					</th>

%					if ($settings{"dio_regions"}) {
						<th class="smaller">
							Reg
						</th>
<%perl>
					}
				}

				if ($event_settings{"online_mode"} eq "async"
					|| $event_settings{"show_async_links"}
					|| $show_async
				) {
</%perl>
					<th>
						Move
					</th>

					<th class="smaller">
						Video Link
					</th>
%				} else {
					<th colspan="2">
					</th>
%				}

			</tr>
			</thead>
			<tbody>

<%perl>
 			foreach my $entry_id (
				sort {
					$entries{$b}{"po"} <=> $entries{$a}{"po"}
					|| $entries{$a}{"speaks"} <=> $entries{$b}{"speaks"}
					|| $entries{$a}{"side"} <=> $entries{$b}{"side"}
					|| $entries{$a}{"last"} cmp $entries{$b}{"last"}
					|| $entries{$a}{"code"} cmp $entries{$b}{"code"}
				} keys %entries
			) {
</%perl>
				<tr class="row">
<%perl>
					if (
						$entries{$entry_id}{"dq"}
						|| $entries{$entry_id}{"dropped"}
					) {
</%perl>
						<td class="semibold redtext centeralign">
							<% ($entries{$entry_id}{"dq"}) ? "DQ" : "" %>
							<% ($entries{$entry_id}{"dropped"}) ? "DROP" : "" %>
						</td>

%						if ($event_type eq "debate" || $event_type eq "wsdc") {
%							if ($flips{"team_order"}) {
								<td class="smallish centeralign">
									<% $entries{$entry_id}{"order"} %>
								</td>
%							}

							<td class="smallish centeralign padless">
							</td>
%						}

%					} elsif ($event_type eq "speech") {
						<td class="smallish centeralign">
							<% $entries{$entry_id}{"speaks"}
								? Lingua::EN::Numbers::Ordinate::ordinate($entries{$entry_id}{"speaks"})
								: ""
							%>
						</td>
%					} elsif ($event_type eq "wudc") {
						<td class="smallish centeralign">
							<% $entries{$entry_id}{"speaks"} == 1 ? "OG" : "" %>
							<% $entries{$entry_id}{"speaks"} == 2 ? "OO" : "" %>
							<% $entries{$entry_id}{"speaks"} == 3 ? "CG" : "" %>
							<% $entries{$entry_id}{"speaks"} == 4 ? "CO" : "" %>
						</td>

%					} elsif ($event_type eq "congress" ) {

						<td class="smallish centeralign bluetext semibold">
							<% $entries{$entry_id}{"po"} ? "PO" : "" %>
						</td>
<%perl>
					} else {

						if (
							( $round_type eq "elim"
								|| $round_type eq "final"
								|| $round_type eq "runoff"
								|| $round_type eq "flip"
							)
							&& (scalar (keys %judge_scores) < 1)
							&& (not defined $aff)
							&& (scalar (keys %flips) < 0 || $flips{'status'} ne "done")
						) {
</%perl>
							<td class="smallish centeralign">
								Flip
							</td>

%						} else {

							<td class="smallish centeralign">
%								if ($aff) {
%									if ($entry_id == $aff && $entries{$entry_id}{"side"} == 1)  {
										<% $entries{$entry_id}{"side"} == 1 ? "Locked ".$aff_string : ""%>
%									} elsif (($entry_id != $aff) && $entries{$entry_id}{"side"} == 2) {
										<% $entries{$entry_id}{"side"} == 2 ? "Locked ".$neg_string : ""%>
%									} else {
										<span class="redtext full marno padless semibold">
											Sidelock broken!
										</span>

										<span class="redtext full marno padless semibold">
											Locked <% $aff == $entry_id ? "Aff" : "Neg" %>
										</span>
										but on the
										<%
											$entries{$entry_id}{"side"} == 1
											? $aff_string
											: ""
										%>
										<%
											$entries{$entry_id}{"side"} == 2
											? $neg_string
											: ""
										%>
%									}
%								} else {
									<% $entries{$entry_id}{"side"} == 1 ? $aff_string : $neg_string %>
%								}
							</td>
%						}

%						if ($flips{"team_order"}) {
							<td class="smallish centeralign">
								<% $entries{$entry_id}{"order"} %>
							</td>
%						}

						<td class="smallish centeralign padless">
							<%
								$entry_wins{$entry_id}
								? $entry_wins{$entry_id}
								: 0
							%>-<%
								$entry_losses{$entry_id}
								? $entry_losses{$entry_id}
								: 0
							%>
						</td>
%					}

					<td class="smallish nospace padless">

%						if ($blind_mode) {

							<% $anonymize{"entry"}{$entry_id} %>

%						} else {
%							unless ($entry_only) {
								<a
									class="white button leftalign marno"
									href="/register/entry/edit.mhtml?entry_id=<% $entry_id %>"
								>
%							}

%							if ($code_name) {
								<span class="threequarters marno"
								><% $entries{$entry_id}{"code"} %></span>

%							} else {

								<span class="half nospace"
								><% $entries{$entry_id}{"code"} %></span>

								<span
									class="half nospace top"
								><% $entries{$entry_id}{"name"} %></span>
%							}
%							unless ($entry_only) {
								</a>
%							}
%						}
					</td>

%					if ($event_settings{"online_prep"}) {
						<td class="centeralign">
							<& "/funclib/online_room.mas",
                                entry  => $entry_id,
                                person => $person,
								role   => "Tab: ",
                                show   => 1,
                                class  => "fa-sm padless"
                            &>
						</td>
%					}

%	 				if ($live_updates) {
						<td class="smallish centeralign">
							<% $entries{$entry_id}{"followers"} %>
						</td>
%					}

					<td class="smallish padless nospace">
%						unless ($blind_mode) {
							<% (not defined $settings{"no_school_codes"})
								? '<span class="third">'.$entries{$entry_id}{"school_code"}.'</span><span class="twothirds">'
								: ""
							%>
							<% Tab::short_name($entries{$entry_id}{"school_name"}) %>
							<% (not defined $settings{"no_school_codes"})
								? '</span>'
								: ""
							%>
%						}
					</td>

%					unless ($blind_mode) {
%						if ($tourn_settings->{"nsda_nats"}) {
							<td class="smallish centeralign">
								<% $entries{$entry_id}{"region_code"} %>
							</td>

							<td class="smallish centeralign">
								<% $entries{$entry_id}{"district_code"} %>
							</td>
%						} elsif ($tourn_settings->{"regions"} || $tourn_settings->{"ncfl"} ) {
							<td class="smallish centeralign">
								<% $entries{$entry_id}{"region_code"} %>
							</td>

%							if ($settings{"dio_regions"}) {
								<td class="smallish centeralign">
									<% $settings{"dio_region"}{$entries{$entry_id}{"region_code"}} %>
								</td>
%							}
%						}
%					}

%					unless ($entry_only) {
						<td class="smallish centeralign nospace">
							<a
								class="buttonwhite bluetext smallish invert marno"
								href="/panel/manipulate/entry_edit.mhtml?entry_id=<%$entry_id%>&round_id=<% $round->id %>"
							>Move</a>
						</td>
%					}

<%perl>
					if ($event_settings{"online_mode"} eq "async"
						|| $event_settings{"show_async_links"}
						|| $show_async
					) {
</%perl>
						<td class="smallish centeralign nospace">
%							if ($entries{$entry_id}{"video_link"}) {
								<a
									class  = "buttonwhite greentext marno fa fa-video-camera"
									target = "_blank"
									href   = "<% $entries{$entry_id}{"video_link"} %>"
								></a>
%							} else {
								<span class="smaller semibold redtext centeralign nospace">
									NO VIDEO!
								</span>
%							}
						</td>
%					}
				</tr>
%	 		}
			</tbody>
		</table>
<%perl>

 		foreach my $entry_id (sort keys %entries) {

			if ($entries{$entry_id}{"strike_desc"}) {

				my $strike_by = Tab::Person->retrieve($entries{$entry_id}{"strike_by"});
</%perl>

				<span class="half centeralign smallish italic martop">

					<span class="third semibold rightalign">
						Strikes entered by
					</span>
					<span class="twothirds">
						<% $strike_by
							? $strike_by->first." ".$strike_by->last
							: ""
						%>
						<% $entries{$entry_id}{"strike_auto"}
							? "Autostrike process"
							: ""
						%>
						at <& "/funclib/showdt.mas",
							string => $entries{$entry_id}{"strike_at"},
							tz     => $tz,
							length => 'seconds'
						&>
					</span>
				</span>
%			}
%		}

%		if ($event_settings{"flip_online"}) {

			<div class="martopmore padno ">
				<span class="fourfifths nospace">
					<h6 class="nospace semibold">
						Flip Status
					</h6>
				</span>

				<span class="fifth rightalign nospace">
%					my $warn = "Are you sure you want to send notices of the flip status to this section?";
					<a
						class         = "submit redtext invert thin smaller"
						title         = "Blast this section only"
						value         = "1"
						id            = "<% $panel_id %>"
						property_name = "panel"
						setting_name  = "blast_only"
						target_id     = "<% $panel_id %>"
						onClick       = "postConfirm('<% $warn %>', this, 'flips.mhtml');"
					>Blast Flips</a>
				</span>
			</div>

			<span class="ltbordervert full nospace">

				<form
					action = "panel_flip_save.mhtml"
					method = "post"
				>

					<input
						type  = "hidden"
						name  = "panel_id"
						value = "<% $panel_id %>"
					>

					<div class="row smallish">
						<span class="fifth semibold bluetext">
							Flip Winner
						</span>

						<span class="threetenths centeralign">
							<select name="winner_id" class="fixedmost">
								<option value="">No flip performed (Resets flip)</option>
% 								foreach my $entry_id (sort keys %entries) {
									<option
										value="<% $entry_id %>"
										<% $flips{'won'} eq $entry_id ? "selected" : "" %>
									>
										<% $entries{$entry_id}{"code"} %>
									</option>
%								}
							</select>
						</span>

						<label for="side_locked">
							<span class="half nospace yellowhover">
								<span class="threefifths bluetext semibold padleft rightalign">
									Side Choice Locked
								</span>

								<span class="fifth centeralign">
									<input
										type  = "checkbox"
										name  = "side_locked"
										id    = "side_locked"
										value = 1
										<% $flips{"side_locked"} ? "checked" : "" %>
									>
								</span>
							</span>
						</label>
					</div>

					<div class="row smallish">
						<span class="fifth semibold bluetext">
							Choice Status
						</span>

						<span class="threetenths centeralign">

							<select
								name  = "flip_status"
								class = "fixedmost"
							>
								<option
									value="winner"
									<% (not defined $flips{"status"}) ?  "selected" : "" %>
								>
									No Flip Done
								</option>

								<option
									value="winner"
									<% $flips{"status"} eq "winner" ? "selected" : "" %>
								>
									Flip Winner's Choice
								</option>

								<option
									value="loser"
									<% $flips{"status"} eq "loser" ? "selected" : "" %>
								>
									Flip Loser's Choice
								</option>

								<option
									value="anyone"
									<% $flips{"status"} eq "anyone" ? "selected" : "" %>
								>
									Anyone's Choice
								</option>

								<option
									value="done"
									<% $flips{"status"} eq "done" ? "selected" : "" %>
								>
									Flip Done
								</option>
							</select>
						</span>

%						if ($flips{"team_order"}) {
							<label for="order_locked">
								<span class="half nospace yellowhover">
									<span class="threefifths bluetext semibold padleft rightalign">
										Order Choice Locked
									</span>

									<span class="fifth centeralign">
										<input
											type  = "checkbox"
											name  = "order_locked"
											id    = "order_locked"
											value = 1
											<% $flips{"order_locked"} ? "checked" : "" %>
										>
									</span>
								</span>
							</label>
%						}

					</div>

					<div class="row smallish">
						<span class="quarter semibold bluetext">
							Choice Deadline
						</span>

						<span class="twenty bluetext semibold">
							<% $flips{"deadline"}
								? $flips{"deadline"}->day_abbr
								: $start->day_abbr
							%>
						</span>

						<span class="fifth">
							<script type="text/javascript">
								 $(document).ready(function() {
									 $('#flip_at_time').timepicker({
										 showLeadingZero : false,
										 showPeriod      : true,
										 periodSeparator : ' '
									 });
								 });
							 </script>

							<input
								class = "notfirst"
								size  = "16"
								type  = "text"
								name  = "flip_at_time"
								id    = "flip_at_time"
								value = "<% Tab::pickertime($flips{"deadline"}) %>"
							>
						</span>

						<span class="fourtenths rightalign nospace">
							<span class="fifth centeralign nospace">
								<input
									class = "smallish thin"
									type  = "submit"
									value = "Save"
								>
							</span>
						</span>
					</div>
				</form>
			</span>

			<div class="padsetting marno italic smallish centeralign">

%				if ($flips{"side_locked"}) {
					<span class="eighth semibold bluetext rightalign">
						Side chosen
					</span>

					<span class="sixth centeralign">
						<% $flips{"side_chosen"} %>
%						my $chooser = Tab::Person->retrieve($flips{"side_chosen_by"});
						<% $chooser
							? "by ".$chooser->first." ".$chooser->last
							: ""
						%>
						<% $flips{"side_auto_chosen"}
							? "Chosen automatically at deadline"
							: ""
						%>
					</span>

					<span class="fifth">
						at <& "/funclib/showdt.mas",
							string => $flips{"side_chosen_at"},
							tz     => $tz,
							length => 'seconds'
						&>
					</span>
%				}

%				if ($event_settings{"flip_team_order"} && $flips{"order_locked"}) {
					<span class="eighth semibold bluetext rightalign">
						Order chosen
					</span>

					<span class="sixth centeralign">
						<% $flips{"order_chosen"} %>
%						my $chooser = Tab::Person->retrieve($flips{"order_chosen_by"});
						<% $chooser
							? "by ".$chooser->first." ".$chooser->last
							: ""
						%>
						<% $flips{"order_auto_chosen"}
							? "Chosen automatically at deadline"
							: ""
						%>
					</span>

					<span class="fifth">
						at <& "/funclib/showdt.mas",
							string => $flips{"order_chosen_at"},
							tz     => $tz,
							length => "seconds"
						&>
					</span>
%				}
			</div>
%		}

<%perl>

		if ($ARGS{"came_from"}) {

			my $came = Tab::Panel->retrieve($ARGS{came_from});
			my $taken = Tab::Judge->retrieve($ARGS{taken});

</%perl>
			<div class="full padvtop odd">

				<span class="redtext semibold rightalign threefifths">
					Judge <% $taken ? $taken->first." ".$taken->last : "" %> was taken from section:
				</span>

				<span class="twofifths">
					<a
						class  = "redtext buttonwhite invert"
						target = "_blank"
						href   = "panel_view.mhtml?panel_id=<% $came->id %>"
					>Section <% $came->letter %> <% $came->round->event->abbr %>
					</a>
				</span>

			</div>

%		}

<%perl>

		if ($event_settings{"online"} && $event_settings{"online_mode"} ne "async") {

			$m->print("<h5 class='semibold martopmore marbottom'>Room Entry Log</h5>");

			my $entry_sth = $dbh->prepare("
				select
					person.first, person.last,
					cl.description,
					CONVERT_TZ(cl.timestamp, '+00:00', tourn.tz)

				from (campus_log cl, person, tourn)
				where cl.panel = ?
					and cl.tourn = tourn.id
					and cl.person = person.id
				group by cl.id
				order by cl.timestamp DESC
			");

			$entry_sth->execute($panel->id);

			while (
				my (
					$person_first, $person_last,
					$description,
					$timestamp
				) = $entry_sth->fetchrow_array()
			) {

</%perl>
				<div class="row">

					<span class="quarter semibold padvert">
						<% $person_first." ".$person_last %>
					</span>
					<span class="quarter nospace">
						<& "/funclib/showtime.mas", length => "day", string => $timestamp &>
					</span>
					<span class="half padvertless marno">
						<% $description %>
					</span>
				</div>
%			}
%		}

	</div>

	<div class="menu">

%		if ($entry_only) {

	        <div class="sidenote">
				<h4>Return</h4>

				<a class="blue full" href="/tabbing/entry/index.mhtml">
					Return to Ballot Entry
				</a>
			</div>

%		} else {

		<div class="sidenote">

			<h4>Pairings/Printouts</h4>

			<a
				class="blue full"
				href="show.mhtml?round_id=<% $round->id %>"
			>
				<% $event->abbr %> <% $round->realname %> Pairing
			</a>

			<a class="blue full"
				href="/panel/report/print_ballots.mhtml?panel_id=<% $panel->id %>"
			>
				Print Master Ballots
			</a>

			<a class="blue <% $round_type eq "elim" ? "half" : "full" %>"
				href="/panel/report/postings.mhtml?panel_id=<% $panel->id %>">
				Print Posting
			</a>
<%perl>
			if (
				$round_type eq "elim"
				|| $round_type eq "final"
				|| $round_type eq "runoff"
			) {
</%perl>
				<a class="blue half"
					href="/panel/report/strike_cards.mhtml?panel_id=<% $panel->id %>"
				>
					Print Strike Cards
				</a>
%			}

			<a class="blue full"
				href="/panel/schemat/panel_blast.mhtml?panel_id=<% $panel->id %>"
			>
				Text/email blast this section
			</a>

%			if ($tourn_settings->{"nsda_nats"} && $round->type eq "final") {
				<a class="blue full martop"
					href="/panel/report/judge_bios.mhtml?panel_id=<% $panel->id %>"
				>
					Judge Biographies
				</a>
%			}

		</div>

		<div class="sidenote">

<%perl>
			if (
				$event->type ne "speech"
				&& $event->type ne "congress"
				&& ($panel->bye || (scalar (keys %schools) < 2))
			) {
</%perl>
				<div class="row full nospace">

					<span class="threefifths semibold marno padleft">
%						if ($round->type eq "elim" || $round->type eq "final" || $round->type eq "runoff") {
							Elim Walk Over
%						} else {
							Assigned Bye
%						}
					</span>

					<span class="quarter centeralign">
						<span class="hidden"><% $panel->bye %></span>
						<label class="switch">
							<input
								type          = "checkbox"
								value         = "1"
								id            = "<% $panel->id %>_bye"
								property_name = "bye"
								target_type   = "panel"
								target_id     = "<% $panel->id %>"
								onChange      = "
									postSwitch( this, 'panel_switch.mhtml');
									showJudges( );
								"

								<% $panel->bye ? 'checked="checked"' : "" %>
							>
							<div class="onred slider"></div>
						</label>
					</span>
				</div>
%			}

%			if ($event_settings{"online"} && $event_settings{"online_mode"} ne "async") {

				<div class="row full nospace">
					<span class="threefifths semibold marno padleft bigger">
						Async Section
					</span>

					<span class="quarter centeralign">
						<span class="hidden"><% $show_async %></span>
						<label class="switch">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $panel->id %>_g_event"
								setting_name = "show_async"
								target_type  = "panel"
								target_id    = "<% $panel->id %>"
								onChange     = "
									postSwitch( this, 'panel_switch.mhtml');
									showJudges( );
								"
								<% $show_async ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</span>
				</div>
%			}

			<div class="row nospace">

				<span class="quarter padleft semibold bigger marno padsetting">
					Start
				</span>

				<span class="half nospace centeralign">
					<% $start->day_name %>
				</span>

				<span class="quarter nospace">
					<% &Tab::nicetime($start) %>
				</span>

			</div>

%			if ($settings{"flighted"} > 1) {

				<div class="row nospace padvert">

					<span class="quarter padleft semibold bigger nospace">
						Flight
					</span>

					<span class="threequarters nospace">

						<form
							action = "panel_flight_save.mhtml"
							method = "post"
						>

						<input
							type  = "hidden"
							name  = "panel_id"
							value = "<% $panel_id %>"
						>

						<select
							name     = "flight"
							class    = "fixedsmall"
							onchange = 'this.form.submit()'
						>

							<option value="">None</option>

%							foreach my $flight ( 1 .. $settings{"flighted"} ) {
								<option value="<% $flight %>"
									<% $flight == $panel->flight
									? "selected"
									: "" %>
								> <% $flight %> </option>
%							}

						</select>
						</form>
					</span>
				</div>
%			}

<%perl>

			unless (
				$event_settings{"online_mode"} eq "nsda_jitsi"
				|| $event_settings{"online_mode"} eq "nsda_private"
				|| $event_settings{"online_mode"} eq "async"
			) {
</%perl>
				<div class="row nospace padvert">

					<span class="fifth padleft semibold bigger nospace">
						Room
					</span>

					<span class="threefifths nospace">

						<form
							action = "panel_room_save.mhtml"
							method = "post"
						>

						<input
							type  = "hidden"
							name  = "panel_id"
							value = "<% $panel_id %>"
						>

						<select
							name             = "room_id"
							onchange         = 'this.form.submit()'
							class            = "fixedmost"
							data-placeholder = "Select room"
						>

%							if ($room) {
								<option
									value="<% $panel_room %>" "selected"
								><% $room->name %></option>
%							}

							<option value="">--NONE--</option>

%							foreach my $room (@reserved_rooms) {
								<option
									value="<% $room->id %>"
								><% $room->name %></option>
<%perl>
							}

							if ($event_settings{"wsdc_multiple_sites"}) {

								foreach my $room (
									$m->comp( "/funclib/clean_multisite_rooms.mas", panel => $panel)
								) {
</%perl>
									<option
										value="<% $room->id %>"
									><% $room->name %></option>
<%perl>
								}

							} else {

								my %rooms =	$m->comp("/funclib/clean_rooms_hash.mas", panel => $panel);

								foreach my $room_id (
									sort {
										$rooms{$a}{"quality"} <=> $rooms{$b}{"quality"}
										|| $rooms{$a}{"string"} cmp $rooms{$b}{"string"}
										|| $rooms{$a}{"number"} <=> $rooms{$b}{"number"}
									} keys %rooms
								) {
</%perl>
									<option
										value="<% $room_id %>"
									><% $rooms{$room_id}{"name"} %></option>
%								}
%							}
						</select>
						</form>
					</span>

%					if ($event_settings{"online_mode"}) {
						<span class="tenth nospace centeralign">
							<& "/funclib/online_room.mas",
								panel  => $panel,
								person => $person,
								show   => 1,
								class  => "fa-sm"
							&>
						</span>
%					}

				</div>
<%perl>
			} elsif (
				$event_settings{"online_mode"} eq "nsda_jitsi"
				|| $event_settings{"online_mode"} eq "nsda_private"
				|| $event_settings{"online_mode"} eq "sync"
			) {
</%perl>
				<div class="row nospace">
					<span class="threefifths semibold bluetext padleft">
						Enter Meeting:
					</span>

					<span class="fifths padvertless centeralign">
						<& "/funclib/online_room.mas",
							panel  => $panel,
							person => $person,
							show   => 1,
							class  => "fa-lg"
						&>
					</span>
				</div>

				<div class="row nospace">
					<span class="threefifths semibold padleft smallish">
						Section Number/Letter
					</span>

					<span class="fifth centeralign padvertless">
						<input
							type          = "text"
							name          = "letter"
							value         = "<% $panel->letter %>"
							size          = 4
							target_id     = "<% $panel->id %>"
							property_name = "letter"
							onChange      = "postSwitch(this, 'panel_switch.mhtml');"
						>
					</span>
				</div>
%			}


%			my @jpools = $round->jpools;

%			if (@jpools) {

				<div class="nospace martop">

					<span class="third padleft semibold biggish marno">
						Judge Pools
					</span>

                    <span class="threefifths nospace">

%					foreach my $jpool (@jpools) {
						<a
							class = "ltborderbottom plain full hover"
							href  = "/panel/judge/jpool.mhtml?pool_id = <% $jpool->id %>"
						> <% $jpool->name %> </a>
%					}

					</span>

				</div>
%			}

		</div>

		<div class="sidenote">

			<h4>Constraint-Free Changes</h4>

%			if ($round->published > 0 && $event_settings{"judge_publish_results"}) {
				<label for="<% $panel->id %>_publish">
					<div class="row nospace padless hover marbottom">

						<span class="twothirds semibold bluetext">
							Results Published
						</span>

						<span class="third nospace centeralign">
							<span class="hidden"><% $panel->publish %></span>
							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $panel->id %>_publish"
									property_name = "publish"
									target_type   = "panel"
									target_id     = "<% $panel->id %>"
									onChange      = "postSwitch( this, 'panel_switch.mhtml');"
									<% $panel->publish ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</div>
				 </label>
%			}

%			if ($event_type eq "congress") {
				<a
					href="speaker_order.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					Change Precedence
				</a>

%			} elsif ($event_type eq "speech") {
				<a
					href="speaker_order.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					Change Speaker Order
				</a>
%			} elsif ($event_type eq "wudc") {
				<a
					href="wudc_sides.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					Change Team Positions
				</a>
%			} else {
				<a
					href="debate_sides_swap.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					Change Sides
				</a>

				<a
					href="debate_order_swap.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					Change Speaker Position
				</a>
%			}

%			unless ($blind_mode) {
				<a
					href="/tabbing/entry/panel.mhtml?panel_id=<% $panel->id %>"
					class="yellow full"
				>
					View/Edit Results
				</a>

%				if ($settings{"prefs"}) {
					<a
						href="prefs_report.mhtml?panel_id=<% $panel->id %>"
						class="yellow full"
					>
						Judge Pref Report
					</a>
%				}
%			}

% 			unless (@judges || keys %entries) {
				<a
					href="/panel/manipulate/panel_rm.mhtml?panel_id=<% $panel_id %>"
					class="dkred full"
				>Delete <% $section %></a>
% 			}
% 		}

%		unless ($reg_only || $entry_only) {

			<p class="padno semibold redtext martopmuchmore">Add literally any judge</p>

			<form action="judge_add.mhtml" method="post">

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

   			<input
				type  = "hidden"
				name  = "bypass_check"
				value = "true"
			>

			<div class="row centeralign">

				<span class="fourfifths nospace">

					<select
						name             = "judge_id"
						class            = "fixedmed"
						data-placeholder = "Select judge"
					>
						<option value=""></option>
<%perl>
						my $all_judges_sth = $dbh->prepare("
							select judge.id, judge.first, judge.last, judge.code, category.abbr
							from judge, category
							where judge.category = category.id
							and category.tourn = ?
							order by category.abbr, judge.code, judge.last
						");

						$all_judges_sth->execute($tourn->id);

						while(

							my ($judge_id, $first, $last, $code, $abbr) =
								$all_judges_sth->fetchrow_array()
						) {
</%perl>
							<option
								value="<% $judge_id %>"
							><% $abbr %>- <% $code %> <% $last %>, <% $first %></option>
%						}
					</select>
				</span>

				<span class="fifth rightalign nospace">
					<button
						class = "buttonwhite bluetext fa fa-lg fa-plus thin padless invert"
					></button>
				</span>
			</div>

			</form>

			<p class="padno semibold redtext">
				Change to literally any room
			</p>

			<form
				action = "panel_room_save.mhtml"
				method = "post"
			>

				<input
					type             = "hidden"
					name             = "panel_id"
					value            = "<% $panel->id %>"
					data-placeholder = "Select room"
				>

				<div class="row centeralign">

					<span class="fourfifths nospace">

						<select
							name  = "room_id"
							class = "fixedmed"
						>

							<option value=""></option>
<%perl>
							my $all_rooms_sth = $dbh->prepare("
								select room.id, room.name, room.quality, site.name
								from site, tourn_site, room
								where tourn_site.tourn = ?
									and tourn_site.site = room.site
									and tourn_site.site = site.id
								order by site.name, room.name
							");

							$all_rooms_sth->execute($tourn->id);

							while(
								my (
									$room_id, $room_name, $room_quality, $site_name
								) = $all_rooms_sth->fetchrow_array()
							) {

</%perl>
								<option
									value="<% $room_id %>"
								><% $room_name %> - <% $room_quality %> <% $site_name %></option>
%							}

						</select>

					</span>

					<span class="fifth rightalign nospace">
						<button
							class = "buttonwhite bluetext fa fa-lg fa-plus thin padless invert"
						></button>
					</span>
				</div>
			</form>

			<p class="padno semibold greentext">
				Move this
					<% $event_type eq "speech" ? "Section" : "" %>
					<% $event_type eq "congress" ? "Chamber" : "" %>
					<% $event_type ne "speech" && $event_type ne "congress" ? "Debate" : "" %>
				to
			</p>

			<form action="move_panel.mhtml" method="post">

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

			<div class="row centeralign">

				<span class="fourfifths nospace">
					<select
						name  = "round_id"
						class = "fixedmed"
					>
						<option value=""></option>

%						foreach my $round ($event->rounds) {
							<option
								value="<% $round->id %>"
							><% $round->realname %> </option>
%						}
					</select>

				</span>

				<span class="fifth rightalign nospace">
					<button
						class = "buttonwhite bluetext fa fa-lg fa-refresh thin padless invert"
					></button>
				</span>
			</div>

			</form>

%			my $warn = "This will delete this section, together with all results and records.  Are you sure?";
			<div class="full marbottom centeralign">
				<a
					class="buttonwhite redtext invert threequarters martopmuchmore centeralign marbottommore bigger"
					href="/panel/manipulate/panel_rm.mhtml?panel_id=<% $panel->id %>&from=schemat"
					<& "/funclib/confirm.mas", warn => $warn &>
				>

					Delete This
						<% $event_type eq "speech" ? "Section" : "" %>
						<% $event_type eq "congress" ? "Chamber" : "" %>
						<% $event_type ne "speech" && $event_type ne "congress" ? "Debate" : "" %>
				</a>
			</div>

%			if ($person->site_admin) {
%				foreach my $judge (@judges) {
					<a
						class="full yellow martopmore"
						href="/user/judge/ballot.mhtml?judge_id=<% $judge->id %>&panel_id=<% $panel->id %>"
					>
						See <% $judge->last %> Online Ballot
					</a>
%				}
%			}

		</div>

%		}

	</div>

