<%args>
	$round_id
	$session
	$record    => undef
	$firstname => undef
</%args>
<%init>
	
	my $round = Tab::Round->retrieve($round_id);
	my $timeslot = $round->timeslot;

	my $timeslot_name = $timeslot->name;

	my $dbh = Tab::DBI->db_Main();
	my $sth = $dbh->prepare("
		select 
			event.abbr, room.name, aff.code, neg.code, judge.first, judge.last

		from (round, event, panel, ballot, judge)

			left join ballot affballot on panel.id = affballot.panel 
				and affballot.side = 1
				and affballot.judge = judge.id

			left join entry aff on aff.id = affballot.entry

			left join ballot negballot on panel.id = negballot.panel 
				and negballot.side = 1
				and negballot.judge = judge.id

			left join entry neg on neg.id = negballot.entry

			left join room on panel.room = room.id

		where round.timeslot = ?
			and round.event = event.id
			and round.id = panel.round
			and panel.bye != 1
			and panel.id = ballot.panel
			and ballot.judge = judge.id

		group by judge.id
		order by room.name
	");

	my $filename = $timeslot->name;
    $filename =~ s/[\W_]//g;
	$filename = $filename.".csv";

    $m->clear_buffer;
    $r->content_type('application/csv');
    $r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	$sth->execute($timeslot->id);

	while (
		my ( 
			$event_abbr, $room_name, $aff_code, $neg_code, $judge_first, $judge_last
		) = $sth->fetchrow_array()
	) { 

		$m->print('"'.$event_abbr.'"');
		$m->print(',');
		$m->print('"'.$room_name.'"');

		$m->print(',');
		$m->print('"'.$aff_code.'"');
		$m->print(',');
		$m->print('"'.$neg_code.'"');
		$m->print(',');
		$m->print('"'.$judge_first.' '.$judge_last.'"');
		$m->print("\n");
	}

	$sth->finish();
	$dbh->disconnect();

	$m->abort;

</%init>


