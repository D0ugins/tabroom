<%args>
	$person
	$tourn
	$tourn_settings
	$show         => undef
	$show_regions => undef
	$done         => undef
	$disp         => undef
	$seeds        => undef
	$nowarn       => undef
	$settings     => undef
	$event_id     => undef
	$round_id     => undef
	$showbye      => undef
	$perms        => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) 
		if $event_id;

	my $round = Tab::Round->retrieve($round_id) 
		if $round_id;

	$event = $round->event if $round && not defined $event;

	$m->abort unless $event;


	my $ncfl++ if $tourn_settings->{"ncfl"};

	unless ($event || $round) { 
		my $msg = "Please pick an event or a round plz";
		$m->redirect("/register/index.mhtml?msg=$msg");
	}

	my $event_type = $event->type;
	$event_type = "debate" 
		if $event_type eq "policy" 
		|| $event_type eq "ld" 
		|| $event_type eq "pf" 
		|| $event_type eq "wsdc" 
		|| $event_type eq "parli";

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $category = $event->category if $event;
	$m->abort unless $category;

	my %category_settings = $category->all_settings;
	my %event_settings = $event->all_settings;
	my %round_settings = $round->all_settings if $round;

	my $round_robin = $event_settings{"round_robin"};
	my $multi_sites = $event_settings{"wsdc_multiple_sites"};
	my $no_side_constraints = $event_settings{"no_side_constraints"};

	my $rounds_per = $category_settings{"rounds_per"};
	my $tab_ratings = $category_settings{"tab_ratings"};
	my $coach_ratings = $category_settings{"coach_ratings"};

	my $prefs = $category_settings{"prefs"};
	undef $prefs if $prefs eq "none";
	undef $prefs if $event_settings{"no_prefs"};

	my $hihi_warn;

	if ($round) {

		my $oddround = $round->name % 2;

		if ( $round->type eq "highhigh" &! $oddround &! $no_side_constraints) { 
			$hihi_warn = " This round is set to pair high-high in a
			side-constrained round.  Pairing this way will lead to some weird
			brackets and results. If you don't have a very good reason you
			should probably change the settings to high-low and try again.";
		}

	}
	
	my @rounds = sort {$a->name <=> $b->name} $event->rounds;

	unless ($round) { 

		unless (@rounds) { 
			my $msg = "There are no rounds scheduled of ".$event->name.".  Try scheduling some?";
			$m->redirect("/setup/schedule/event.mhtml?event_id=$event_id&msg=$msg");
		}

		$round = $m->comp("/funclib/event_current_round.mas", 
			event => $event
		);

		$round = $m->comp("/funclib/event_current_round.mas", 
			event => $event, 
			done => "done"
		) unless $round;

		$round = $rounds[0] unless $round;

	}

	my $round_type = $round->type;
	$round_type = "elim" if $round_type eq "final";

	my $preset++ unless $m->comp('/funclib/round_entries.mas', round => $round);

	my @u_panels = $m->comp("/funclib/round_panels.mas", round => $round, not_in => "1");
	my $undone_panels = scalar @u_panels;
	undef @u_panels;

	Tab::Panel->set_sql( missing_rooms => "
		select panel.*
		from panel
		where panel.bye != 1
		and panel.round = ?
		and not exists (
			select room.id
			from room
			where room.id = panel.room
		)
		and exists (
			select ballot.id
			from ballot
			where ballot.panel = panel.id
			and ballot.bye != 1
			and ballot.forfeit != 1
		)
	");

	my @missing = Tab::Panel->search_missing_rooms($round->id);
	my $missing_rooms++ if @missing;
	my $all_missing_rooms++ if scalar @missing == scalar $round->panels;

	Tab::Panel->set_sql( missing_judges => "
		select panel.*
		from panel, ballot
		where panel.bye != 1
		and panel.round = ?
		and ballot.panel = panel.id
		and ballot.bye != 1
		and ballot.forfeit != 1
		and not exists (
			select judge.id
			from judge
			where judge.id = ballot.judge
		)
	");

	my $missing_judges++ if Tab::Panel->search_missing_judges($round->id);
	my $entered++ if $undone_panels == 0 && not defined $missing_judges;
	my $settings_visible++ if $missing_judges || $missing_rooms;

	my $start = $round->start_time;
	$start = $round->timeslot->start unless $start;
	$start->set_time_zone($tz);

	my $entry_only++ if ${$perms}{"entry_only"};

	$show = "schools" if $entry_only;

	my $gplus_warn = $m->comp("/funclib/gplus_check_round.mas", tourn_id => $tourn->id); 


</%init>

	<div class="menu">

%		if ($entry_only) { 

			<div class="sidenote">

				<h4>Return</h4>
				
				<a class="blue full" href="/tabbing/entry/index.mhtml">
					Return to Ballot Entry
				</a>

			</div>

%		} else { 

			<script>
				$(document).ready(function(){
					$("#hide").click(function(){
						$("#eraser").hide();
						$("#hide").hide();
						$("#show").show();
					});
					$("#show").click(function(){
						$("#eraser").show();
						$("#hide").show();
						$("#show").hide();
					});
				});
			</script>

			<div class="sidenote">

%				$settings_visible++ if $settings;
%				$settings_visible++ if $preset;
%				$settings_visible++ if $disp;
				
				<div style="border-bottom: 1px dashed #444;" class="nowrap">

					<span class="tenth">

						<a
							class = "notfirst fa fa-sm fa-eye-slash buttonwhite redtext"
							id    = "hide"
							style = "<% $settings_visible ? "" : "display: none;"%>"
						></a>

						<a 
							class = "notfirst fa fa-sm fa-eye buttonwhite"
							id    = "show"
							style = "<% $settings_visible ? "display: none;" : ""%>"
						></a>

					</span>

					<span class="ninetenth">
						<h4 class="marno">Change &amp; Destroy</h4>
					</span>

				</div>

				<div 
					id    = "eraser"
					style = "<% $settings_visible ? "" : "display: none;"%>
				">


<%perl> 
					my $warn;

					if ($preset) { 

						if ($event_type eq "wudc") { 

							my @entries = $event->entries( 
								dropped  => 0,
								waitlist => 0
							);

							$warn = "The field size is not divisible by 4.  This pairing will have byes." 
								if (scalar @entries % 4);	

						}

						if ($round_type ne "elim") { 

							if ($round_robin) { 

								$warn = "This button will pair the ENTIRE round robin ";
								$warn .= " AND delete any existing rounds.  Continue?";

</%perl>

								<a 
									class="dkgreen martop full padmore" 
									href="/panel/round/panel_master.mhtml?round_id=<% $round->id %>"
									<& "/funclib/confirm.mas", warn => $warn &> 
								>
									Auto-pair entire Round Robin
								</a>

%							} elsif ($event_type eq "speech" || $event_type eq "congress") { 

%								my $warn = "This button will panel just this";
%								$warn .= " round, ".$round->realname." of ".$event->name;
%								$warn .= " To panel the entire event go to the Paneling ";
%								$warn .= " menu and select Rounds";

								<a 
									class="dkgreen martop full" 
									href="/panel/round/panel_master.mhtml?round_id=<% $round->id %>"
									<& "/funclib/confirm.mas", warn => $warn &> 
								>
									Panel this round only
								</a>

%							} else { 

								<a 
									class="dkgreen martop full" 
									href="/panel/round/panel_master.mhtml?round_id=<% $round->id %>"
									<& "/funclib/confirm.mas", warn => $warn &> 
								>
									Auto-pair debaters
								</a>
%							}


%						} else { 

							<a 
								class="dkgreen full martop marbottom padmore" 
								href="/tabbing/break/index.mhtml?preset_id=<% $round->id %>&event_id=<% $event->id %>"
								<& "/funclib/confirm.mas", warn => $warn &> 
							>
								Auto-pair break round
							</a>


%						} 

%						if ($event_type eq "speech" || $event_type eq "congress") { 

							<a 
								class="yellow martopmore full" 
								href="/panel/manipulate/manual_speech.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>">
								Manually panel round
							</a>

%						} else { 

%                           if ($round_type eq "highlow" || $round_type eq "highhigh") { 

								<a 
									class="yellow full martopmore" 
									href="/panel/manipulate/manual_powermatch.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>&bracket=-1">
									Manual Powermatcher
								</a>
%							} 

							<a 
								class="yellow full martopmore" 
								href="/panel/manipulate/manual_debate.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>&bracket=-1">
								Manually pair debate
							</a>
%						} 

						<br />

%					} else { 

%						my $warn;

%						if ($round_type eq "elim") { 

							<a 
								class="yellow half" 
								<& "/funclib/confirm.mas", warn => $warn &> 
								href="/tabbing/break/index.mhtml?preset_id=<% $round->id %>&event_id=<% $event->id %>">
								Auto-pair round
							</a>

%							if ($event_type eq "speech" || $event_type eq "congress" || $event_type eq "wudc") { 

								<a 
									class="yellow half" 
									href="/panel/manipulate/manual_speech.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>">
									Hand-panel round
								</a>
%							}  else { 

								<a 
									class="yellow half" 
									href="/panel/manipulate/manual_debate.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>">
									Hand-pair debates
								</a>
%							}  


%						} else { 

%							if ($round_robin) { 

%								$warn = " Danger, Will Robinson! You are about to pair this ";
%								$warn .= " entire round robin.  Are you sure?";

								<a 
									class="yellow full" 
									<& "/funclib/confirm.mas", warn => $warn &> 
									href="/panel/round/panel_master.mhtml?round_id=<% $round->id %>"
								>
									Auto-pair all round robin prelims
								</a>

%							} else { 

<%perl>

								my $mantype = "debate";

								$mantype = "speech" 
									if $event_type eq "speech" 
									|| $event_type eq "congress";

								$warn = "Danger, Will Robinson! You are about to repanel ";
								$warn .= "this round entirely.  Are you sure?";

								$warn.= $hihi_warn;	
</%perl>

								<a 
									class="yellow half" 
									<& "/funclib/confirm.mas", warn => $warn &> 
									href="/panel/round/panel_master.mhtml?round_id=<% $round->id %>">
									Auto-pair round
								</a>
								
								<a class="yellow half" 
									href="/panel/manipulate/manual_<% $mantype %>.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>&bracket=-1">
									Hand pair debates
								</a>

%  	  	                       	if ($round_type eq "highlow" || $round_type eq "highhigh")  {

									<div class="truefull nospace">

										<a class="plain half">
										</a>

										<a class="yellow half nowrap" 
											href="/panel/manipulate/manual_powermatch.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>&bracket=-1">
											Hand powermatch
										</a>
									</div>
%								} 
%							} 
%						} 

%						$warn = "EEK! You are about to erase judges and re-assign them.  Are you sure?";

%						undef $warn if $missing_judges;

%						if ($event_type eq "speech" || $event_type eq "congress" || $event_type eq "wudc") { 

							<a 
								class="yellow half"  
								<& "/funclib/confirm.mas", warn => $warn &>  
								href="/panel/round/judges.mhtml?round_id=<% $round->id %>"
							>

%						} elsif ($multi_sites) { 

							<a 
								class="yellow half"  
								<& "/funclib/confirm.mas", warn => $warn &>  
								href="/panel/round/debate_judge_multisite.mhtml?round_id=<% $round->id %>"
							>

%						} elsif ($round_settings{"num_judges"} > 1 
%									&& $prefs
%									&& ($round_type eq "elim") 
%							) { 

							<a 
								class="yellow half"  
								<& "/funclib/confirm.mas", warn => $warn &>  
								href="/panel/round/debate_judge_panel.mhtml?round_id=<% $round->id %>"
							>

%						} else {

							<a 
								class="yellow half"  
								<& "/funclib/confirm.mas", warn => $warn &>  
								href="/panel/round/debate_judge_assign.mhtml?round_id=<% $round->id %>"
							>

%						} 

							Auto-assign judges

						</a>

						<a 
							class="yellow half"  
							href="/panel/round/manual_judges.mhtml?round_id=<% $round->id %>"
						>
							Hand place judges
						</a>

<%perl>

						$warn  = "This process will only fill in empty rooms.";
						$warn .= "To redo all rooms, erase rooms first below.";

						undef $warn if $all_missing_rooms;

						$warn = "This will assign rooms to any rounds without rooms for the whole day" 
							if $multi_sites;

</%perl>

						<a 
							class="yellow half" 
							<& "/funclib/confirm.mas", warn => $warn &> 
							href="/panel/round/rooms.mhtml?round_id=<% $round->id %>"
						>

							Auto-assign rooms
						</a>

						<a 
							class="yellow half"  
							href="/panel/round/manual_rooms.mhtml?round_id=<% $round->id %>"
						>
							Hand place rooms
						</a>

%						if ($m->comp('/funclib/round_unbalanced.mas', round => $round) 
%								&& $event_type eq "speech" ) {
							<a 
								class="dkgreen full" 
								href="/panel/manipulate/manual_rebalance.mhtml?round_id=<% $round->id %>"
							>
								Rebalance Sections
							</a>
%						}

%						if ($prefs eq "ordinals" || $prefs eq "ndt") {

							<a 
								class="yellow half"  
								href="/panel/round/debate_judge_assign_cat.mhtml?round_id=<% $round->id %>"
							>
								CAT/STA-Assign Judges
							</a>
%						}

%					}

%					if ($preset) { 

						<a
							class="full yellow marbottom"
							href="upload_backup.mhtml?round_id=<% $round->id %>"
						>
							Import Round Backup
						</a>


%					} else { 

						<a
							href="download_round.mhtml?round_id=<% $round->id %>"
							class="full green marbottom"
						>
							Download Round Backup
						</a>

%					} 


					<a 
						class="<% $settings ? "dk" : "" %>blue half" 
						href="/panel/schemat/show.mhtml?round_id=<% $round->id %>&settings=1"
					>
						Round Settings
					</a>

					<a 
						class="blue half" 
						href="/setup/schedule/event.mhtml?event_id=<% $event->id %>&settings=1"
					>
						Event Schedule
					</a>

%					foreach my $jpool ($round->jpools) { 
						<a 
							class="blue full" 
							href="/panel/judge/jpool.mhtml?jpool_id=<% $jpool->id %>&category_id=<% $category->id %>">
							Edit judge pool <% $jpool->name %> 
						</a>
%					}


%					unless ($preset) { 

%						$warn = "You are about to delete all entries from this
%						round.  You cannot get them back.  Please, for the love
%						of all that is good and holy, be certain you mean it";

						<a class="dkred full martop centeralign " <& "/funclib/confirm.mas", warn => $warn &> 
							href="round_dump_entries.mhtml?round_id=<% $round->id %>">
							Erase entries
						</a>

%						$warn = "You are about to delete all judges from this
%						round.  You cannot get them back.  Please, for the love
%						of all that is good and holy, be certain you mean
%						this";
						
						<a class="dkred full centeralign " <& "/funclib/confirm.mas", warn => $warn &> 
							href="round_dump_judges.mhtml?round_id=<% $round->id %>">
							Erase judges
						</a>

%						$warn = "You are about to delete all ROOMS from this
%						round.  You cannot get them back.  Please, for the love
%						of all that is good and holy, be certain you mean
%						this";

						<a class="dkred full centeralign " <& "/funclib/confirm.mas", warn => $warn &> 
							href="round_dump_rooms.mhtml?round_id=<% $round->id %>">
							Erase rooms
						</a>

%						$warn = "You are about to delete this ENTIRE ROUND. You
%						cannot get it back.  Please, for the love of all that
%						is good and holy, be certain you mean this!";
						
						<a class="dkred full centeralign " <& "/funclib/confirm.mas", warn => $warn &> 
							href="round_dump.mhtml?round_id=<% $round->id %>">
							Erase round
						</a>

%						if ($tourn->hidden) { 

							<br />
							<br />

%							$warn = "You are about to fake the ranks for an
%							entire round.  Existing ranks will be wiped out.
%							Please be sure.  There is no undo here.";

							<a 
								class="dkred full martop centeralign padmore" 
								<& "/funclib/confirm.mas", warn => $warn &> 
								href="/tabbing/entry/fake/<% $event_type %>.mhtml?round_id=<% $round->id %>">
								Fake Results
							</a>

%							$warn = "You are about to fake the ranks for the
%							ENTIRE EVENT.  ALL Existing ranks will be wiped
%							out.  Please be sure.  There is no undo here.";
							
							<a 
								class="dkred full martop centeralign padmore full" 
								<& "/funclib/confirm.mas", warn => $warn &> 
								href="/tabbing/entry/fake/<% $event_type %>.mhtml?event_id=<% $event->id %>">
								Whole Event
							</a>

%						}

%					}

				</div>
		
			</div>

			<div class="sidenote">

				<h4>Share & Enjoy</h4>

%				if ($event_type eq "debate") { 
					<a 
						class="marbottom yellow full" 
						href="debate_disaster_display.mhtml?round_id=<% $round->id %>"
					>
						Check for debate disasters
					</a>
%				} 

				<form action="start_time.mhtml" method="post">

				<div class="row full padless">

					<span class="fourfifths nospace">

						<span class="twofifth">
							Start time
						</span>

						<span class="threefifth centeralign">
							<input 
								type  = "hidden"
								name  = "round_id"
								value = "<% $round->id %>"
							>

							<& "/funclib/timepicker.mas", 
								name => "starttime",
								time => $start,
								size => 10 &>

						</span>

					</span>

					<span class="fifth rightalign nospace">
						<input 
							type  = "submit"
							class = "notfirst thinner"
							value = "Set">
						</form>
					</span>

				</div>

				<form action="publish.mhtml" method="post">

				<input type="hidden" name="round_id" value="<% $round->id %>">

<%perl>

				undef $warn;

				$warn = "This round has missing rooms.  Are you sure you want
				to publish it? " 
					if $missing_rooms;

				$warn = "This round has missing judges.  Are you sure you want
				to publish it? " 
					if $missing_judges;

				$warn = "This round has missing rooms AND judges.  Are you sure
				you want to publish it? " 
					if $missing_judges && $missing_rooms;

</%perl>
				<div class="row full padless">

					<span class="fourfifths nospace">
						<span class="quarter">
							Publish
						</span>

						<span class="threequarter nospace rightalign">

							<select 
								name  = "published"
								id    = "notfirst"
								class = "notfirst fixedtiny plain"
							>

								<option 
									value="0" 
									<% $round->published ? "" : "selected" %> 
								>Not Public</option>

								<option 
									value="1" 
									<% $round->published == 1 ? "selected" : "" %>
								>On Web</option>

								<option 
									value="2" 
									<% $round->published == 2 ? "selected" : "" %>
								>On Web w/o Judges</option>

%								if ($event_type eq "wudc") { 
									<option 
										value="3" 
										<% $round->published == 3 ? "selected" : "" %>
									>On Web w/Motion</option>
%								}
							</select>
						</span>
					</span>

					<span class="fifth rightalign nospace">
						<input 
							type  = "submit"
							value = "Go"
							class = "thinner notfirst"
							<& "/funclib/confirm.mas", warn => $warn &>
						>
						</form>
					</span>
				</div>

				<form action="blast.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "round_id"
					value = "<% $round->id %>"
				>

				<div class="row full padless">

					<span class="fourfifths nospace">
						<span class="full padmore">
							Blast Emails &amp; Texts
						</span>
					</span>
					<span class="fifth rightalign nospace">

						<input 
							type  = "submit"
							value = "Go"
							class = "thinner notfirst"
							<& "/funclib/confirm.mas", warn => $warn &>
						>
						</form>
					</span>
				</div>

				<form action="post_results.mhtml" method="post">
				<input type="hidden" name="round_id" value="<% $round->id %>">

				<div class="row full padless">

					<span class="fourfifths nospace ">
						<span class="third">
							Results:
						</span>

						<span class="twothird rightalign">
							<select name="post" id="notfirst" class="notfirst fixedtiny plain">

								<option 
									value = "0"
									<% $round->post_results ? "" : "selected" %>
								>Not Public</option>

								<option 
									value="1" 
									<% $round->post_results == 1 ? "selected" : "" %>
								>Only <% $event_type ne "debate" ? "Ranks" : "Win/Loss"%></option>



								<option value="2" <% $round->post_results == 2 ? "selected" : "" %>>Full Results</option>
							</select>
						</span>
					</span>

%					my $publish_warn = "You are publishing results before ballots are entered.  This will mean people can see each ballot as it is entered by panels or you.   Are you out of your mind?  Click OK to confirm you are nuts." if $undone_panels;

					<span class="fifth rightalign  nospace">
						<input type="submit" value="Go" <& "/funclib/confirm.mas", warn => $publish_warn &> class="thinner notfirst">
						</form>
					</span>

				</div>

%				if ($event_settings{"wsdc_subtotal_ballot"}) { 
				
					<form action="/panel/report/wsdc_email_ballot.mhtml" method="post">
					<input type="hidden" name="round_id" value="<% $round->id %>">

					<div class="row full padless">
					
						<span class="fourfifths nospace ">
							Email WSDC Ballot Scores
						</span>

						<span class="fifth rightalign  nospace">
							<input type="submit" value="Go" class="thinner notfirst">
						</span>

					</div>
							
					</form>
%				}

%				if ($round_type eq "elim") { 

					<form action="publish.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>

					<label for="listed">
						<div class="row full hover padless">

							<span class="fourfifths nospace">
								Publish clearing entries

								<input 
									type  = "hidden"
									name  = "clearing"
									value = "1"
								>

								<input 
									type  = "checkbox"
									class = " notfirst thin"
									id    = "listed"
									name  = "listed"
									value = "1"
									<% $round_settings{'publish_entry_list'} ? 'checked="checked"' : "" %>
								>
							</span>

							<span class="fifth rightalign nospace">
								<input 
									type  = "submit"
									value = "Go"
									class = "thinner notfirst"
								>
								</form>
							</span>

						</div>
					</label>
%				}

				<h4>Display & Print</h4>

				<a 
					class="<% $settings || $show_regions || $seeds ?  "" : "dk" %>blue full" 
					href="show.mhtml?round_id=<% $round->id %>"
				>
					Show Schematic
				</a>

				<a class="blue half" id="anonymize">Anonymize</a>

				<script> 
					$("#anonymize").click(function() {
						$(".anonymize").toggleClass("hidden");
						$(".identities").toggleClass("hidden");
						$(this).toggleClass("dkblue");
						$(this).toggleClass("blue");
						var text = $(this).text();
						$(this).text( text == "Anonymize" ? "Show Identities" : "Anonymize");
					});

				</script>

				<a class="blue half" id="schoolswitch">Show Schools</a>

				<script> 
					$("#schoolswitch").click(function() {
						$(".schools").toggleClass("hidden");
						$(this).toggleClass("dkblue");
						$(this).toggleClass("blue");
						var text = $(this).text();
						$(this).text( text == "Show Schools" ? "Hide Schools" : "Show Schools");
					});

				</script>

%				if ($event_type eq "speech") { 

					<a class="blue half" id="doubleEntrySwitch">Show Schools</a>

					<script> 
						$("#doubleEntrySwitch").click(function() {
							$(".doubled").toggleClass("hidden");
							$(this).toggleClass("dkblue");
							$(this).toggleClass("blue");
							var text = $(this).text();
							$(this).text( text == "Show Schools" ? "Hide Schools" : "Show Schools");
						});

					</script>


%				}

%				if ($tourn_settings->{"ncfl"}) { 

					<a class="blue half" id="regnameswitch">Show DioNames</a>

					<script> 
						$("#regnameswitch").click(function() {
							$(".regionnames").toggleClass("hidden");
							$(this).toggleClass("dkblue");
							$(this).toggleClass("blue");
							var text = $(this).text();
							$(this).text( text == "Show DioNames" ? "Hide  DioNames" : "Show  DioNames");
						});

					</script>

					<a class="blue half" id="regcodeswitch">Show DioCodes</a>

					<script> 
						$("#regcodeswitch").click(function() {
							$(".regioncodes").toggleClass("hidden");
							$(this).toggleClass("dkblue");
							$(this).toggleClass("blue");
							var text = $(this).text();
							$(this).text( text == "Show DioCodes" ? "Hide  DioCodes" : "Show  DioCodes");
						});

					</script>


%					if ($event_type eq "debate") { 

						<a class="blue half" id="dioregionswitch">Show DioRegions</a>

						<script> 
							$("#dioregionswitch").click(function() {
								$(".dioregions").toggleClass("hidden");
								$(this).toggleClass("dkblue");
								$(this).toggleClass("blue");
								var text = $(this).text();
								$(this).text( text == "Show  DioRegions" ? "Hide  DioRegions" : "Show  DioRegions");
							});

						</script>
%					}


%				}


%				if ($tourn_settings->{"regions"} || $event_settings{"region_avoid"}) { 

					<a class="blue half" id="regionswitch">Show Regions</a>

					<script> 
						$("#regionswitch").click(function() {
							$(".regions").toggleClass("hidden");
							$(this).toggleClass("dkblue");
							$(this).toggleClass("blue");
							var text = $(this).text();
							$(this).text( text == "Show Regions" ? "Hide Regions" : "Show Regions");
						});

					</script>

%				}

%				if ($event_type eq "debate") { 

%					my $norecord++ if $round->name == 1;
%					$norecord++ if $round_type eq "elim";

					<a 
						class = "<% $norecord ? "" : "dk" %>blue half"
						id    = "recordswitch"
					><% $norecord ? "Show" : "Hide" %> Records</a>

					<script> 
						$("#recordswitch").click(function() {
							$(".record").toggleClass("hidden");
							$(this).toggleClass("dkblue");
							$(this).toggleClass("blue");
							var text = $(this).text();
							$(this).text( text == "Show Records" ? "Hide Records" : "Show Records");
						});
					</script>

%					if ($prefs || $tab_ratings || $coach_ratings) { 

						<a class="dkblue half" id="prefsswitch">Hide Ratings</a>

						<script> 
							$("#prefsswitch").click(function() {
								$(".prefs").toggleClass("hidden");
								$(this).toggleClass("dkblue");
								$(this).toggleClass("blue");
								var text = $(this).text();
								$(this).text( text == "Show Ratings" ? "Hide Ratings" : "Show Ratings");
							});

						</script>
%					}

					<a class="blue half" id="decisionswitch">Hide Decisions</a>

					<script> 
						$("#decisionswitch").click(function() {
							$(".decisions").toggleClass("hidden");
							$(this).toggleClass("dkblue");
							$(this).toggleClass("blue");
							var text = $(this).text();
							$(this).text( text == "Hide Decisions" ? "Show Decisions" : "Hide Decisions");
						});
					</script>

<%perl>
					if (
						$round_type eq "prelim" 
						&& (
							$event_settings{"pair_seeds"}
							|| $event_settings{"apda"}
							|| $event_settings{'seed_presets'}
						)
					) { 
</%perl>

						<a 
							class = "<% $seeds ?  "dk" : "" %>blue half"
							id    = "seedswitch"
						>Show Seeds</a>

						<script> 
							$("#seedswitch").click(function() {
								$(".seeds").toggleClass("hidden");
								$(this).toggleClass("dkblue");
								$(this).toggleClass("blue");
								var text = $(this).text();
								$(this).text( text == "Show Seeds" ? "Hide Seeds" : "Show Seeds");
							});

						</script>
%					}
%				}

				<br />

%				if ($event_type eq "congress" || $event_type eq "speech") { 

%					if ($round_type eq "elim") { 
						<a 
							class="martop blue full" 
							href="/panel/report/postings.mhtml?timeslot_id=<% $round->timeslot->id %>&event_id=<% $round->event->id %>" 
							<& "/funclib/confirm.mas", warn => $warn &>
						>Print Elim Postings</a>
%					}
				
					<a 
						class="blue martop half" 
						href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $round->event->id %>" <& "/funclib/confirm.mas", warn => $warn &>>	
						Print Schematic
					</a>
					
					<a 
						class="blue half" 
						href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $round->event->id %>&schools=yep">	
						w/<% $ncfl ? "Dioceses" : "Schools" %>
					</a>

%				} else { 

					<a 
						class="martop blue half" <& "/funclib/confirm.mas", warn => $warn &> 
						href="/panel/report/schematic.mhtml?round_id=<% $round->id %>&event_id=<% $round->event->id %>">
						Print Schem
					</a>

					<a 
						class="blue half" 
						href="/panel/report/schematic.mhtml?record=sanchez&round_id=<% $round->id %>&event_id=<% $round->event->id %>" 
						<& "/funclib/confirm.mas", warn => $warn &>
					>
						w/Records
					</a>

					<a 
						class="blue half" 
						href="/panel/report/schematic.mhtml?by_judge=yaykansas&round_id=<% $round->id %>&event_id=<% $round->event->id %>" 
						<& "/funclib/confirm.mas", warn => $warn &>
					>
						Sort by judges
					</a>

					</a>
					<a 
						class="blue half" 
						href="/panel/report/schemat/round_csv_debate.mhtml?round_id=<% $round->id %>" 
						<& "/funclib/confirm.mas", warn => $warn &>
					> Spreadsheet
					</a>
%				}

				<a 
					class="martop blue half" 
					href="/panel/report/master_ballots.mhtml?timeslot_id=<% $round->timeslot ? $round->timeslot->id : "" %>&event_id=<% $event->id %>&sort_by=name" 
					<& "/funclib/confirm.mas", warn => $warn &>i
				>
					Ballots by Name
				</a>
				
				<a 
					class="blue  half" 
					href="/panel/report/master_ballots.mhtml?timeslot_id=<% $round->timeslot->id %>&event_id=<% $event->id %>&sort_by=panel" 
					<& "/funclib/confirm.mas", warn => $warn &>i
				>
					Ballots by Room
				</a>


%				if ($event_settings{"online_ballots"}) { 

%#					Warren Decker

					<a 
						class="blue full" 
						href="/panel/report/master_ballots.mhtml?timeslot_id=<% $round->timeslot->id %>&event_id=<% $event->id %>&sort_by=name&personless=1"i
					>
						Ballots for unlinked judges only
					</a>
%				} 


%				if ($event_type eq "congress") { 
					<a 
						class="blue full" 
						href="/panel/report/chamber_roster.mhtml?round_id=<% $round->id %>"
					>
						Print Roster with Chambers
					</a>
%				} 

			</div>


			<div class="sidenote">

				<h4>Stats & Data</h4>

%				my @idle = $m->comp("/funclib/round_idle_judges.mas", round => $round);

%				if ($event_type eq "wudc") { 
					<a 
						class = "blue full"
						href  = "/panel/manipulate/wudc_positions.mhtml?round_id=<% $round->id %>"
					>
						Check Team Positions
					</a>
%				}

<%perl>
				if ($round_type eq "prelim" 
					&& (
						$event_settings{"pair_seeds"}
						|| $event_settings{"apda"}
						|| $event_settings{'seed_presets'}
					)
				) { 
</%perl>
					<a 
						class="blue full" 
						href="/panel/report/preset_draw.mhtml?event_id=<% $event->id %>"
					>
						Preset Draw Report
					</a>
%				}

%				my $names;

%				foreach my $judge (@idle) { 
%					$names .= ", " if $names;
%					$names .= $judge->last;
%				}

				<a 
					class = "blue full"
					title = "<% $names %>"
					href  = "/panel/manipulate/free_judges.mhtml?round_id=<% $round->id %>"
				>
						List <% scalar @idle %> Unused Judges
				</a>

				<a 
					class="<% $done ? "dk" : "" %>blue half" 
					href="show.mhtml?round_id=<% $round->id %>&done=1"
				>
					Show Results
				</a>
				
				<a 
					class="<% $done ? "dk" : "" %>blue half" 
					href="/tabbing/report/print_pending.mhtml?round_id=<% $round->id %>&done=1"
				>
					Print Pending 
				</a>

%				if ($event_type eq "wudc") {
					<div class="oddd full">
						<span class="third full">
							Motion
						</span>
						<span class="twothird full">
							<% $round_settings{"motion"} ? "Entered" : "Not Entered" %>
						</span>
					</div>
%				}

				<div class="even full padless">

					<span class="half rightalign padless">
						Paired:
					</span>

					<span class="half padless">
						<% $round->created ? &Tab::niceshortdayt($round->created->set_time_zone($tz)) : "Not recorded" %>
					</span>
				</div>

<%perl>

				Tab::Score->set_sql( last_altered => "
					select score.*
					from panel, ballot, score
					where panel.round = ".$round->id."
					and panel.id = ballot.panel
					and ballot.id = score.ballot
					order by score.timestamp DESC limit 1
				") if $round;

				my $last_bv = Tab::Score->search_last_altered->first;

</%perl>
%				my $blasted = $round_settings{'blasted'};

				<div class="odd full padless">
					<span class="half rightalign padless">
						Blasted:
					</span>
					<span class="half padless">
						<% $blasted ?  &Tab::niceshortdayt($blasted->set_time_zone($tz)) : "Not yet blasted" %> 
					</span>
				</div>

				<div class="even full padless">
					<span class="half rightalign padless">
						Finished:
					</span>
					<span class="half padless">
						<% $last_bv && $last_bv->timestamp ? &Tab::niceshortdayt($last_bv->timestamp->set_time_zone($tz)) : "Not recorded" %>
					</span>
				</div>


%				if ($rounds_per > 0 ) { 

<%perl>

					my ($assigned_judges_past, $paired_panels_current, $assigned_judges_current, 
						$needed_panels_current, $needed_judges_current, $paired_panels_future, 
						$assigned_judges_future, $needed_panels_future, $needed_judges_future, 
						$category_rds_left, $assigned_to_last, $unassigned_burned_already, 
						$unassigned_one_plus_left, $unassigned_one_left, $total_in_category) 
					= $m->comp("/funclib/judge_oblig_count_by_category.mas", current_rd_id => $round->id );

</%perl>
					<h5>
						<% $category->abbr %> judge stats
					</h5>

					<div class="row full padless">
						<span class="sixth rightalign">
							<% $total_in_category %> 
						</span>
						<span class="fivesixth">
							total judges in <% $category->abbr %>
						</span>
					</div>

					<div class="row full padless">
						<span class="sixth rightalign">
							<% $assigned_judges_past %> 
						</span>
						<span class="fivesixth">
							assignments before <% $round->realname %>
						</span>
					</div>

					<h5>
						Current pairing
					</h5>

					<div class="row full padless marno">
						<span class="sixth rightalign">
							<% $assigned_judges_current %>
						</span>
						<span class="fivesixth">
							judges assigned
						</span>
					</div>

					<div class="row full padless marno">
						<span class="sixth rightalign">
							<% $needed_judges_current %>
						</span>
						<span class="fivesixth">
							judges needed this round
						</span>
					</div>

					<div class="row full padless marno">
						<span class="sixth rightalign">
							<% $assigned_to_last %> 
						</span>
						<span class="fivesixth">
							in for last rd of commitment
						</span>
					</div>

					<div class="row full padless marno">
						<span class="sixth rightalign">
							<% $unassigned_burned_already %> 
						</span>
						<span class="fivesixth">
							unassigned &amp; burned already
						</span>
					</div>

					<div class="row full padless marno">
						<span class="sixth rightalign">
							<% $unassigned_one_left %>
						</span>
						<span class="fivesixth">
							unassigned with 1 round left
						</span>
					</div>

					<div class="row full padless marno">
						<span class="sixth rightalign">
							<% $unassigned_one_plus_left %>
						</span>
						<span class="fivesixth">
							unassigned with &gt;1 round left
						</span>
					</div>

					<h5>
						To Infinity and Beyond!
					</h5>

					<div class="row full padless marno nowrap">
						<span class="twofifth nospace">
							Future Need:
						</span>
						<span class="tenth nospace">
							<% $needed_judges_future %>
						</span>
						<span class="twofifth nospace">
							Assigned:
						</span>
						<span class="tenth nospace">
							<% $assigned_judges_future %>
						</span>
					</div>

				 	<div class="row full padless marno nowrap">

						<span class="fourfifths">
							Future rounds of committment:
						</span>
						<span class="fifth">
							<% $category_rds_left %>
						</span>

					</div>

					<div class="row full padless marno">
						<span class="fourfifths">
							Individual judges not burned:
						</span>
						<span class="fifth">
							<% $total_in_category-$assigned_to_last-$unassigned_burned_already %>
						</span>
					</div>

%				}
				
%				if ($prefs eq "ordinals" || $prefs eq "ndt")  {

					<div class="row nospace">

<%perl>

						my ($avgpref, $avgmut, $worstpref, $worstmut) 
							= $m->comp("/funclib/mjp_diagnostics.mas", round => $round );				

						my $avg_pref = shift @{$avgpref};
						my $worst_pref = shift @{$worstpref};
						my $avg_mut = shift @{$avgmut};
						my $worst_mut = shift @{$worstmut};
					

</%perl>
						<span class="half smaller">
							MJP diagnostics
						</span>

						<span class="half smaller">

							<div class="full marno padless">
								<span class="twothirds">
									Avg Pref
								</span>
								<span class="third">
									<% sprintf("%.1f", $avg_pref) %>
								</span>
							</div>

							<div class="full marno padless">
								<span class="twothirds">
									Avg Mut
								</span>
								<span class="third">
									<% sprintf("%.1f", $avg_mut) %>
								</span>
							</div>

							<div class="full marno padless">
								<span class="twothirds">
									Worst pref:
								</span>
								<span class="third">
									<% sprintf("%.1f", $worst_pref) %>
								</span>
							</div>

							<div class="full marno padless">
								<span class="twothirds">
									Worst Mut:
								</span>
								<span class="third">
									<% sprintf("%.1f", $worst_mut) %>
								</span>
							</div>

						</span>
					</div>

%				}

%				if ($rounds_per > 0) {

					<a 
						class = "blue half"
						href  = "judge_fits.mhtml?round_id=<% $round->id %>">
						Judge fits
					</a>

					<a 
						class = "blue half"
						href  = "judge_use_status.mhtml?round_id=<% $round->id %>&event_id=<% $round->event %>">
						Judge Use
					</a>
%				}


%				if ($prefs eq "tiered_round") {
					<a 
						class = "blue half"
						href  = "pref_diagnostics.mhtml?event_id=<% $event->id %>"
					>
						Pref Diagnostics
					</a>

%				} elsif ($prefs eq "ordinals" || $prefs eq "ndt") {

					<a 
						class = "blue half"
						href  = "pref_diagnostics_mjp.mhtml?event_id=<% $event->id %>"
					>
						Pref Diagnostics
					</a>
%				} 

%				if ($prefs) { 
					<a 
						class = "blue half"
						href  = "/panel/report/round_prefs.mhtml?round_id=<% $round->id %>"
					>
						Entry Pref Totals
					</a>
%				} 

				<a class="blue half" href="round_entries.mhtml?round_id=<% $round->id %>&done=1">
					List of Entries
				</a>
			
			</div>

%		}

	</div>

	<div class="main">

		<div class="nospace">
		
			<span class="twofifth nowrap">
				<h4 class="nospace">
					<% $event->name %>
				</h4>
			</span>

			<span class="threefifth nowrap">
			
				<span class="threefifths leftalign">
					<h4 class="nospace">
						<% $round->realname %>:
						<% &Tab::nicetime($start) %>
					</h4>
				</span>

				<span class="twofifths rightalign">
					<h5 class="nospace <% $entered ? "greentext" : "" %> ">
						<% $entered ? "DONE" : $undone_panels ." panels not in" %>
					</h5>
				</span>

			</span>

		</div>

		<ul id="tabnav">

%			foreach my $allround (@rounds) {

<%perl>

				my $realname = $allround->realname;
				my $eventname = quotemeta $allround->event->name;
				my $eventabbr = quotemeta $allround->event->abbr;
				$realname =~ s/$eventname//g;
				$realname =~ s/$eventabbr//g;
				$realname =~ s/Round\ /Rd/g;
				$realname =~ s/Session\ /Sn/g;
				$realname =~ s/Doubles/Dubs/g;
				$realname =~ s/\s//g;

				my $test = $realname;
				eval { $test = $test + 0; };
				$realname = "R".$realname if $test;
				$realname = substr($realname, 0, 5);

</%perl>

%				if ($m->comp("/funclib/round_unbalanced.mas", round => $allround)) { 
					<li class="<% ($allround->id == $round->id) ? "selected" : "" %>warning">
%				} else { 
					<li class="<% ($allround->id == $round->id) ? "selected" : "" %>">
%				}

					<a href="show.mhtml?round_id=<% $allround->id %>&seeds=<%$seeds%>&show=<% $show %>&settings=<% $settings %>&disp=<% $disp %>"> 
						<% $realname %>
					</a>

				</li>
%			}

		</ul>

%		my $blast_setting = Tab::RoundSetting->search(round => $round->id, tag => "scheduled_blast")->first; 

%		if ($blast_setting) { 

			<div class="dkred row marbottom">

				<span class="threequarters martop">
					Round will be 
						<% $blast_setting->value eq "both" ? "both blasted &amp; published" : "" %>
						<% $blast_setting->value eq "blast" ? "blasted only" : "" %>
						<% $blast_setting->value eq "publish" ? "published only" : "" %>
							at <% $blast_setting->value_date ? Tab::niceshortdayt($blast_setting->value_date->set_time_zone($tz))." ".Tab::tzname($tz) : ""%>
				
					<% $blast_setting->value_text ? '<span class="padno full explain marbottom">Message: '.$blast_setting->value_text.'</span>' : "" %>
				</span>

				<span class="quarter">
					<a class="dkyellow button" href="schedule_delete.mhtml?setting_id=<% $blast_setting->id %>">
						Cancel Scheduled Blast
					</a>
				</span>


			</div>
%		}

%		if ($round) { 
%			unless ($round->tiebreak_set && $round->tiebreak_set->id) { 
				<div class="dkred bigger">
					<h4>Doom awaits you! No tiebreakers assigned!</h4>
				</div>

				<div class="padmore bigger centeralign">

					<p class="bigger redtext">Tiebreakers are how Tabroom knows which scores (win/loss,
					points, ranks) to ask for.</p>

					<p class="bigger redtext">Every round must have a tiebreaker set assigned</p>

					<p class="bigger redtext">Go to Setup :: Schedule to set tiebreakers for every round.
					Otherwise your ballots, both printed and online, will be
					blank.</p>
				</div>
%			}
%		}

%		if ($round && $settings) { 

			<& settings_edit.mas, round => $round, event_settings => \%event_settings &>

%		} elsif ($preset && ($event_type eq "speech" || $event_type eq "congress")) { 

			<& preset_edit.mas, round => $round &>

%			if ($person->site_admin) { 

				<h4 class="martopmore">Import a CSV round</h4>

				<div class="row">
					<form 
						enctype  = "multipart/form-data"
						onsubmit = "return uploadThis()"
						name     = "panels"
						action   = "upload_ie.mhtml"
						method   = "post"
					>

					<input 
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>

					<span class="quarter strong padtopmore padbottommore padleftmore">
						Crazy ass IE format
					</span>

					<span class="twofifth">

						<div class="uploader">

							<input 
								type  = "file"
								name  = "panels"
								style = "opacity: 0;" onchange = "uploaderName('panels', 'filename')"
								id    = "panels"
							>

							<span 
								id    = "filename"
								class = "filename"
								style = "-webkit-user-select: none;"
							>No file selected</span>

							<span 
								class="action" 
								style="-webkit-user-select: none;"
							>Choose File</span>

						</div>
					</span>

					<span class="quarter centeralign">
						<input type="submit" value="Upload" class="thin">
					</span>

					</form>
				</div>
%			} 

%		} elsif ($preset) {

%			if ($person->site_admin) { 

				<h4>Import a CSV round</h4>

				<div class="row">
					<form 
						enctype  = "multipart/form-data"
						onsubmit = "return uploadThis()"
						name     = "panels"
						action   = "upload_debate.mhtml"
						method   = "post"
					>

					<input 
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>

					<span 
						class="quarter strong padtopmore padbottommore padleftmore"
					>
						Upload round file:
					</span>

					<span class="twofifth">

						<div class="uploader">

							<input 
								type     = "file"
								name     = "panels"
								style    = "opacity: 0;"
								onchange = "uploaderName('panels', 'filename')"
								id       = "panels"
							>

							<span 
								id    = "filename"
								class = "filename"
								style = "-webkit-user-select: none;"
							>No file selected</span>

							<span 
								class = "action"
								style = "-webkit-user-select: none;"
							>Choose File</span>
						</div>
					</span>

					<span 
						class="quarter centeralign"
					>

						<input 
							type  = "submit"
							value = "Upload"
							class = "thin"
						>
					</span>

					</form>
				</div>

%			}

%		} elsif ($round) { 

%			if ($done) { 

% 				if ( $event_type eq "debate" ) { 
					<& debate_results.mas, round => $round &>
%				}

% 				if ( $event_type eq "speech" ) { 
					<& speech_results.mas, round => $round &>
%				}

% 				if ( $event_type eq "congress" ) { 
					<& congress_results.mas, round => $round &>
%				}

% 				if ( $event_type eq "wudc" ) { 
					<& wudc_results.mas, round => $round &>
%				}

%			} else { 

%				if ( ($gplus_warn)  && not defined $nowarn) { 
					<div class="dkred block centeralign marbottom">
						<h5>Warnings:</h5>
						<div class="block"><% $gplus_warn %></div>
					</div>
%				}

%				my $admin++ if $person->id == 1;
%				$admin++ if $person->id == 405;

%	 			if ( $event_type eq "speech" ) { 

					<& show_speech.mas, 
						entry_only     => $entry_only,
						round          => $round,
						show           => $show,
						admin          => $admin,
						event_settings => \%event_settings,
						entered        => $entered
					&>

%				} elsif ( $event_type eq "congress" ) { 
					<& 
						show_congress.mas, 
						entry_only => $entry_only,
						round      => $round,
						show       => $show,
						seeds      => $seeds
					&>

%				} elsif ( $event_type eq "wudc" ) { 
					<& 
						show_wudc.mas, 
						entry_only => $entry_only,
						round      => $round,
						show       => $show,
						seeds      => $seeds
					&>

%				} elsif ( $event_type eq "debate" ) { 
					<& 
						show_debate.mas, 
							entry_only   => $entry_only,
							round        => $round,
							seeds        => $seeds,
							admin        => $admin,
							showbye      => $showbye,
							nowarn       => $nowarn,
							entered      => $entered,
							show_regions => $show_regions
						&>

%				} else { 
		
					<p class='warning'> 
						You have not chosen an event type.
					</p>

					<p>
						Tabroom does not know how to show you this
						pairing/schematic because that depends on what type of
						event it is (debate, speech, etc).
					</p>

					<p>
						You have confused Tabroom.  Tabroom is lost, and scared.
						Please help it out.  Or it'll totally screw up your
						tournament and not even mean to. 
					</p>

					<p>
						You can change the event type from the 
							<a 
								href="/setup/events/edit.mhtml?event_id=<% $event->id %>"
							>Event Settings</a>
					</p>


%				}

%			}

%		}

	</div>

