<%args>
	$round
	$event
	$person
	$person_settings
	$tourn
	$tourn_settings
</%args>
<%init>
	
	my $event_type = $event->type;

	my %event_settings = $event->all_settings;
	my %round_settings = $round->all_settings;
	my $category = $event->category;

	$event_type = "debate" 
		if $event_type eq "ld"
		|| $event_type eq "parli"
		|| $event_type eq "pf"
		|| $event_type eq "policy"
		|| $event_type eq "wsdc"
		|| $event_type eq "wudc";

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $switch;

	my $start = $round->start_time;
	$start = $round->timeslot->start unless $start;

	my $round_type = $round->type;

	my %default_setting = $m->comp(
		"/funclib/default_rating_settings.mas", 
		type => $event->type
	);

	my @jpools = $category->jpools;
	my @rpools = $tourn->rpools;

	my %already;

	my $readonly;

	if ($tourn_settings->{"nsda_district"}) {
		$readonly = 'readonly = "true"';
		undef $readonly if $person->site_admin;
		undef $readonly if $person_settings->{"nsda_admin"};
	}

</%init>

%	if (@jpools || @rpools) { 

		<span class="pagehalf martopmore">
%			if (@jpools) { 
				<span class="padmore marrightmore">
					<a 
						title = "Edit and add judge pools"
						class = "buttonwhite fa fa-sm bluetext fa-edit"
						href="/panel/judge/edit_jpools.mhtml?category_id=<% $category->id %>"
					></a>
				</span>
				<span class="nospace threequarters">
					<h5 class="padless marno">Judge Pools</h5>
				</span>
%			}
		</span>

		<span class="pagehalf martopmore">
%			if (@rpools) { 
				<span class="padmore marrightmore">
					<a 
						title = "Edit and add room pools"
						class = "buttonwhite fa fa-sm bluetext fa-edit"
						href  = "/panel/room/edit_rpools.mhtml"
					></a>
				</span>
				<span class="nospace threequarters">
					<h5 class="padless marno">Room Pools</h5>
				</span>
%			}
		</span>

		<span class="pagehalf">
%			if (@jpools) { 
%				foreach my $jpool ($round->jpools) { 

%					$already{$jpool->id}++;

					<div 
						id    = "<% $jpool->id %>"
						class = "row smallish marno padless"
					>

						<span class="twothirds nospace">
							<a 
								class="white bluetext hover" 
								href="/panel/judge/jpool.mhtml?jpool_id=<% $jpool->id %>&category_id=<% $category->id %>"
							>
								<% $jpool->name %>
							</a>
						</span>

						<span class="third nospace centeralign">

							<a 
								class          = "buttonwhite redtext fa fa-trash"
								target_id      = "<% $jpool->id %>"
								property_name  = "judge"
								setting_name   = "<% $round->id %>"
								on_success     = "destroy"
								onClick        = "postSwitch(
									this, 'pool_switch.mhtml');"
							>
							</a>

						</span>

					</div>
%				}
%			}

		</span>

		<span class="pagehalf">

%			if (@rpools) { 

%				foreach my $rpool ($round->rpools) { 
%					next unless $rpool;
%					$already{$rpool->id}++;

					<div 
						id    = "<% $rpool->id %>"
						class = "row smallish marno padless"
					>

						<span class="twothirds nospace">
							<% $rpool->name %>
						</span>

						<span class="third nospace centeralign">
							<a 
								class          = "buttonwhite redtext fa fa-trash"
								target_id      = "<% $rpool->id %>"
								property_name  = "room"
								setting_name   = "<% $round->id %>"
								on_success     = "destroy"
								onClick        = "postSwitch(
									this, 'pool_switch.mhtml');"
							>
							</a>
						</span>

					</div>
%				}

%			}
		</span>

		<span class="pagehalf martop">
%			if (@jpools) { 

				<form action="jpool_add.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>

					<span class="nospace padleft quarter smallish">
						Add:
					</span>

					<span class="twothirds nospace">

						<select 
							name     = "jpool_id"
							onchange = 'this.form.submit()'
						>

							<option value=""></option>
%							foreach my $jpool (@jpools) { 
%								next if $already{$jpool->id}++;
								<option value="<% $jpool->id %>"><% $jpool->name %></option>
%							}
						</select>
					</span>

				</form>

%			}

		</span>

%		if (@rpools) { 

			<span class="pagehalf martop">

				<form action="rpool_add.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "round_id"
						value = "<% $round->id %>"
					>

					<span class="nospace padleft quarter smallish">
						Add:
					</span>

					<span class="twothirds nospace">

						<select 
							name     = "rpool_id"
							onChange = 'this.form.submit();'
							class    = "fixedmed">

							<option value=""></option>

%							foreach my $rpool (@rpools) { 
%								next if $already{$rpool->id}++;
								<option value="<% $rpool->id %>"><% $rpool->name %></option>
%							}

						</select>
					</span>

				</form>

			</span>

%		}

%	}

	<form action="settings_save.mhtml" method="post">

	<input 
		type  = "hidden"
		name  = "round_id"
		value = "<% $round->id %>"
	>

	<div class="full nospace martopmore">

		<span class="third nospace">
			<h5>Pairing & Times</h5>
		</span>

		<span class="twothirds rightalign">
		</span>

	</div>

%		if ($round_type eq "prelim") { 

%			my $seed_order = $round_settings{"tab_seed_priority"};

			<div class="row pagefull marbottom">

				<span class="threefifth">

					<div class="marno">
						Judge Assignment Seed Order (APDA)
					</div>

					<div class="smallish marno martop">
						List prelim seeding categories in order of importance
						for judge assignments.  Use numbers, not names, and
						separate with commas.
					</div>

					<div class="smaller marno <% $round_settings{"num_judges"} > 1 ? "" : "hidden" %> ">
						List seedings multiple times for paneled prelims.
					</div>
				</span>

				<span class="twofifth rightalign">
					<input 
						type  = "text"
						name  = "tab_seed_priority"
						value = "<% $seed_order %>"
						size  = "48"
					>
				</span>

			</div>

%		}

<%perl>

		unless ($round_type eq "prelim" 
			|| $round_type eq "elim" 
			|| $round_type eq "final"
			|| $round_type eq "runoff"
		) { 

			my $bracket_order = $round_settings{"tab_rating_priority"};

			$bracket_order = $default_setting{$round->name} unless $bracket_order;

</%perl>
			<div class="row pagefull marbottom">

				<span class="threefifth">

					<div class="marno">
						Judge Assignment Bracket Order
					</div>

					<div class="smaller marno padtop">
						<% $event->type eq "wudc" 
							? "List brackets by points earned" 
							: "List brackets by number of wins" 
						%>. Separate with commas.
					</div>

					<div class="smaller marno <% $round_settings{"num_judges"} > 1 ? "" : "hidden" %> ">
						List brackets multiple times for paneled prelims
					</div>
				</span>

				<span class="twofifth rightalign">
					<input 
						type  = "text"
						name  = "tab_rating_priority"
						value = "<% $bracket_order %>"
						size  = "32"
					>
				</span>

			</div>
%		}

		<span class="pagehalf">

            <div class="row">

				<span class="half">
					Event Schedule
				</span>

				<span class="fourtenths rightalign marless padless">
					<a 
						class="buttonwhite bluetext smallish"
						href="/setup/schedule/event.mhtml?event_id=<% $event->id %>&settings=1"
					>
						Edit Schedule
					</a>
					
				</span>
			</div>

            <div class="row">

				<span class="half">
					Round Backups &amp; Restore:
				</span>

				<span class="fourtenths rightalign padtop padbottomless marless">

					<span class="nospace half">
						<a
							class = "buttonwhite greentext fa fa-sm fa-arrow-down marno"
							title = "Download backup"
							href="download_round.mhtml?round_id=<% $round->id %>"
						>
						</a>
					</span>

					<span class="nospace half">
						<a
							title = "Upload & restore from backup"
							class = "buttonwhite orangetext fa fa-sm fa-arrow-up marno"
							href="upload_backup.mhtml?round_id=<% $round->id %>"
						>
						</a>
					</span>

				</span>

			</div>

            <div class="row">

				<span class="half">

					Round Label

					<div class="full explain marless padno">
						Default is "Round <% $round->name %>"
					</div>

				</span>

				<span class="half rightalign">
					<input 
						type        = "text"
						name        = "label"
						size        = "17"
						placeholder = "Round <% $round->name %>"
						value       = "<% $round->label %>"
					>
				</span>
			</div>


            <div class="row">

                <span class="half">
					Round Type
                </span>

				<span class="half rightalign"> 

%					if ($readonly) { 

						<input 
							type  = "hidden"
							name  = "type"
							value = "<% $round_type %>"
						>

						<span class="full centeralign marless">
							<% ucfirst($round_type) %>
						</span>

%					} else { 

						<select 
							name     = "type"
							class    = "fixedsmall"
						>

							<option
								value="prelim" 
								<% ( $round_type eq "prelim") ? "selected" : "" %> 
							> Prelim/Preset </option>

							<option 
								value="highlow" 
								<% ( $round_type eq "highlow") ? "selected" : "" %> 
							> Hi/Lo </option>   

							<option 
								value="highhigh" 
								<% ( $round_type eq "highhigh") ? "selected" : "" %> 
							> Hi/Hi </option>   

							<option 
								value="elim" 
								<% ( $round_type eq "elim") ? "selected" : "" %> 
							> Elim </option>

							<option 
								value="final" 
								<% ( $round_type eq "final") ? "selected" : "" %> 
							> Final </option>

							<option 
								value="runoff" 
								<% ( $round_type eq "runoff") ? "selected" : "" %> 
							> Runoff </option>

						</select>
	
%					} 

				</span>
            </div>

            <div class="row">

                <span class="half">
					Time Block
                </span>

				<span class="half rightalign">

					<select 
						name  = "timeslot_id"
						class = "fixedsmall chosen"
					>

%						foreach my $timeslot ($tourn->timeslots) { 

%							next if $timeslot->id != $round->timeslot->id 
%								&& Tab::Round->search( timeslot => $timeslot->id, event => $event->id);

%							my $start = $timeslot->start->set_time_zone($tz);

							<option 
								value="<% $timeslot->id %>" 
								<% $timeslot->id == $round->timeslot->id ? "selected" : "" %>
							> <% $timeslot->name %> &ndash; <% Tab::shorttime($start) %> </option>
%						}
					</select>
				</span>
            </div>

            <div class="row">
                <span class="half">
					Number of flights
                </span>
				<span class="half rightalign">
					<select 
						name  = "flighted"
						class = "fixedsmall"
					>

						<option 
							value="1"  
							<% $round->flighted == 1 ? "selected" : "" %> 
						>Single</option>

						<option 
							value="2"  
							<% $round->flighted == 2 ? "selected" : "" %>
						>Double</option>

						<option 
							value="3"  
							<% $round->flighted == 3 ? "selected" : "" %>
						>Triple</option>

					</select>
				</span>
			</div>

            <div class="row">

                <span class="half">
					Seeding tiebreakers 
                </span>
				<span class="half rightalign">

%					if ($readonly) { 

						<input 
							type  = "hidden"
							name  = "tiebreak_set"
							value = "<% $round->tiebreak_set ? $round->tiebreak_set->id : "" %>"
						>

						<span class="full centeralign marless">
							<% $round->tiebreak_set ? $round->tiebreak_set->name : "NONE!" %>
						</span>

%					} else { 

						<select 
							name  = "tiebreak_set"
							class = "fixedsmall"
						>

%							foreach my $tiebreak_set ($tourn->tiebreak_sets) { 
								<option 
									value="<% $tiebreak_set->id %>"  
									<% $round && $round->tiebreak_set == $tiebreak_set ? "selected" : "" %> 
								><% $tiebreak_set->name %></option>
%							}
						</select>
%					}
				</span>
			</div>

%			if ($event_type eq "debate") { 

				<div class="row">

					<span class="half">
						Sidelock against round
					</span>

					<span class="half rightalign">

						<select 
							name  = "sidelock_against"
							class = "fixedsmall"
						>

%							my $sidelock_against = $round_settings{'sidelock_against'} if $round;

							<option value="">Default (previous)</option>

							<option 
								value="NONE" 
								<% $sidelock_against eq "NONE" ? 'selected="selected"' : "" %>
							>Do Not Sidelock</option>

%							foreach my $sa_round ($event->rounds) { 

%								next if $round->name < $sa_round->name; 

								<option 
									value="<% $sa_round->id %>"  
									<% $sidelock_against  == $sa_round->id ? "selected" : "" %> 
								><% $sa_round->realname %></option>
%							}

							<option 
								value="RANDOM" 
								<% $sidelock_against eq "RANDOM" ? 'selected="selected"' : "" %>
							>Make Fully Random</option>

						</select>
					</span>

				</div>

%			} 

%			if ($event_type eq "debate" && $person->site_admin) { 

				<div class="row">

					<span class="third nospace">
						Merge timeslot:
					</span>

					<span class="third nospace rightalign">
						<a 
							href="/panel/round/timeslot_merge.mhtml?timeslot_id=<% $round->timeslot->id %>&on=1"
							class="redtext buttonwhite smallish"
						> Merge </a>
					</span>

					<span class="third nospace rightalign">
						<a 
							href="/panel/round/timeslot_merge.mhtml?timeslot_id=<% $round->timeslot->id %>"
							class="greentext buttonwhite smallish"
						>Un-merge </a>
					</span>

				</div>

%			}

%			if ($event->type eq "wsdc") { 

%				my $round_prep = $round_settings{'wsdc_round_type'};

				<div class="row">

					<span class="third nospace">
						Type of round
					</span>

					<label for="prepped">
						<span class="third hover">
							<input 
								type  = "radio"
								id    = "prepped"
								name  = "wsdc_round_type"
								value = "prepped"
								<% $round_prep eq "prepped" ? 'checked="checked"' : "" %>
							> Prepared
						</span>
					</label>

					<label for="impromptu">
						<span class="third hover">
							<input 
								type  = "radio"
								id    = "impromptu"
								name  = "wsdc_round_type"
								value = "impromptu"
								<% $round_prep eq "impromptu" ? 'checked="checked"' : "" %>
							> Impromptu
						</span>
					</label>
					
				</div>

%			}

%			if ($event_settings{'breakouts'}) { 

				<div class="row">

					<span class="half">
						Breakout for:
					</span>
					<span class="half rightalign">

						<select 
							name  = "use_for_breakout"
							class = "fixedsmall chosen"
						>

							<option value="">None</option>

%							foreach my $breakout (1 .. $event_settings{"breakouts"}) {

%								next if $event_settings{"breakout_".$breakout."_delete"};

								<option 
									value="<% $breakout %>" 
									<% $round_settings{"use_for_breakout"} == $breakout ? 'selected="selected"' : ""%>>
									<% $event_settings{"breakout_".$breakout."_label"} %>
								</option>
%							}
						</select>
					</span>
				</div>
%			}


		</span>

%		undef $switch;

		<span class="pagehalf">

            <div class="row">

                <span class="threequarters">
					Number of <% $event_type eq "congress" ? "scorers" : "judges" %>
					per <% $event_type eq "congress" ? "chamber" : "section" %>
                </span>

				<span class="quarter rightalign">
					<input 

						<% $readonly %>
						type  = "number"
						name  = "judges"
						min   = 0
						max   = 999
						size  = 8
						value = "<% $round_settings{"num_judges"} %>"
					>
				</span>
			</div>


            <div class="row">
                <span class="half">
					Start Time on pairings
                </span>
				<span class="half rightalign">
					<& "/funclib/timepicker.mas", 
						name => "start_time",
						time => $start,
						size => 12 
					&>
				</span>
            </div>

%			if ($round->flighted > 1) { 

				<div class="row">
					<span class="threefifth">
						<div class="marno">
							Round length in minutes
						</div>
						<div class="full nospace smallish explain">
							Offsets start time on Flt B ballots
						</div>
					</span>
					<span class="twofifth rightalign">
						<input 
							type  = "number"
							name  = "offset"
							min   = 0
							max   = 999
							size  = "12"
							class = "larger"
							value = "<% $event_settings{"flight_offset"} %>"
						>
					</span>
				</div>
%			} 


			<div class="row">

				<span class="half">
					Publish only for coaches
				</span>

				<span class="half nospace">

					<label for="coach_wins">
						<div class="marless padno full hover smallish">
							<span class="quarter nospace centeralign">
								<input
									class = "marno thinner"
									type  = "checkbox"
									name  = "coach_wins"
									id    = "coach_wins"
									value = "1"
									<% $round_settings{"coach_wins"} ? 'checked="checked"' : "" %>
								>
							</span>
							<span class="threequarters marno">
								<% $event->type eq "congress" 
									|| $event->type eq "speech" ? "Ranks" : "W/L" %>
							</span>

						</div>
					</label>

					<label for="coach_points">
						<div class="marless padno full hover smallish">
							<span class="quarter nospace centeralign">
								<input 
									class = "marno thinner"
									type  = "checkbox"
									name  = "coach_points"
									id    = "coach_points"
									value = "1"
									<% $round_settings{"coach_points"} ? 'checked="checked"' : "" %>
								>
							</span>
							<span class="threequarters marno">
								<% $event->type eq "congress" 
									|| $event->type eq "speech" ? "Points" : "Rks/Pts" %>
							<span>
						</div>
					</label>

					<label for="coach_feedback">
						<div class="marless padno full hover smallish">
							<span class="quarter nospace centeralign">
								<input
									class = "marno thinner"
									type  = "checkbox"
									name  = "coach_feedback"
									id    = "coach_feedback"
									value = "1"
									<% $round_settings{"coach_feedback"} ? 'checked="checked"' : "" %>
								>
							</span>

							<span class="threequarters marno">
								Comments/RFDs
							</span>

						</div>
					</label>


				</span>
			</div>


%			if ($event_type ne "speech" && $event_type ne "congress") { 

				<label for="reset_room_moves">

					<div class="hover row">

						<span class="threequarter">
							Do not minimize room moves
						</span>

						<span class="quarter rightalign">
							<input 
								type  = "checkbox"
								name  = "reset_room_moves"
								id    = "reset_room_moves"
								value = "1"
								<% $round_settings{"reset_room_moves"} ? 'checked="checked"' : "" %>
							>
						</span>

					</div>

				</label>

				<label for="flight_rooms_only">

					<div class="row hover">

						<span class="threequarter">
							Flight rooms but not judging
						</span>

						<span class="quarter rightalign">
							<input 
								type  = "checkbox"
								name  = "flight_rooms_only"
								id    = "flight_rooms_only"
								value = "1"
								<% $event_settings{"flight_rooms_only"} ? 'checked="checked"' : "" %>
							>
						</span>

					</div>

				</label>

				<label for="include_room_notes">

					<div class="row hover">

						<span class="threequarter">
							Include room notes on pairings
						</span>

						<span class="quarter rightalign">
							<input
								type  = "checkbox"
								name  = "include_room_notes"
								id    = "include_room_notes"
								value = "1"
								<% $round_settings{"include_room_notes"} ? 'checked="checked"' : "" %>
							>
						</span>

					</div>

				</label>

%				if ($round_type eq "elim" || $round_type eq "final" || $round_type eq "runoff") { 

					<label for="omit_from_bracket">

						<div class="row hover">

							<span class="threequarter">
								Omit from brackets
							</span>

							<span class="quarter rightalign">
								<input 
									type  = "checkbox"
									name  = "omit_from_bracket"
									id    = "omit_from_bracket"
									value = "1"
									<% $round_settings{"omit_from_bracket"} ? 'checked="checked"' : "" %>
								>
							</span>

						</div>

					</label>
%				}

				<label for="ignore_results">
					<div class="hover row">

						<span class="threequarter smallish padleft">
							I'm talking about practice, not a game. <br />
							Ignore this round's results
						</span>

						<span class="quarter rightalign">
							<input 
								type  = "checkbox"
								name  = "ignore_results"
								id    = "ignore_results"
								value = "1"
								<% $round_settings{'ignore_results'} ? 'checked="checked"' : "" %>
							>
						</span>
					</div>
				</label>
%			}

%			if ($person->site_admin) { 

				<label for="dontcare_aboutmissing">
					<div class="hover row">

						<span class="threequarter smallish padleft">
							No warning about debaters not in debates
						</span>

						<span class="quarter rightalign">
							<input 
								type  = "checkbox"
								name  = "dontcare_aboutmissing"
								id    = "dontcare_aboutmissing"
								value = "1"
								<% $round_settings{'dontcare_aboutmissing'} 
									? 'checked="checked"' 
									: ""
								%>
							>
						</span>
					</div>
				</label>

%			}

		</span>

		<div class="liblrow rightalign marmore">
			<input type="submit" value="Save Round Settings">
		</div>

		<h5>Labels and Information</h5>

		<& /funclib/editor.mas &>

		<div class="row full">

			<span class="third">
				Message on pairing/posting
			</span>

			<span class="twothird">
				<input 
					type  = "text"
					name  = "notes"
					value = "<% $round_settings{"notes"} %>"
					size  = "55"
				>
			</span>

		</div>

%		if ($event_type ne "speech" && $event_type ne "congress") { 

			<div class="row full">

				<span class="fifth">
					Resolution/Motion
				</span>

				<span class="threefifths marno">
					<input 
						type  = "text"
						name  = "motion"
						value = "<% $round_settings{"motion"} %>"
						size  = "55"
					>
				</span>

				<label for="motion_publish">

					<span class="fifth hover centeralign">
						Publish:
						<input 
							type  = "checkbox"
							name  = "motion_publish"
							id    = "motion_publish"
							value = "1"
							<% $round_settings{"motion_publish"} ? 'checked="checked"' : "" %>
						>
					</span>

				</label>

			</div>


%		}

		<h5>Message/Rules for Ballots</h5>

		<span class="full centeralign row">
			<textarea 
				name = "ballot_rules"
				rows = 10
				cols = "80"
				wrap = "virtual"
			><% $event_settings{"ballot_rules"} %></textarea>
		</span>

		<div class="liblrow rightalign marmore">
			<input type="submit" value="Save Round Settings">
			</form>
		</div>

