<%args>
	$tourn
	$tourn_settings
	$event_id
</%args>
<%init>

	# Get the upload and create the file handle.
	my $req = Apache2::Request->new($r);
	my @csv_handles = $r->upload;

	my $csv_file = $req->upload($csv_handles[0]);
	my $io = $csv_file->io;

	my @lines = <$io>;

	my @all_lines;

	foreach (@lines) {
		$_ =~ s/[\r]+/\n/g;
		$_ =~ s/[\r\n]+/\n/g;
		$_ =~ s/[\n]+/\n/g;
		push @all_lines, split (/\n/, $_);
	}

	my $event = Tab::Event->retrieve($event_id);

	unless ($event) {
		$m->comp("/funclib/abort.mas",
			message => "Event ID $event_id yielded no actual event"
		);
	}

	unless ($event->tourn == $tourn) {
		$m->comp("/funclib/abort.mas",
			message => "Event ID $event_id is not a part of this tournament"
		);
	}

	my %entries = map { $_->code => $_ } $event->entries(active => 1);

	my $counter;
	my $err;

	my %done;

	foreach my $line (@all_lines) {

		my ($code, $url) = split(/\,/, $line);

		$url = 0 unless $url;

		if ($entries{$code}) {
			$entries{$code}->setting("video_link", "text", $url);
			Tab::debuglog("Uploaded video for $code.");
			$counter++;
			$done{$code}++;
		} else {
			$err .= "No entry found for code $code";
		}
	}

	foreach my $code (keys %entries) { 
		next if $done{$code};
		Tab::debuglog("No video uploaded for $code. Dropped.");
		$entries{$code}->dropped(1);
		$entries{$code}->update();
	}

	my $msg = $counter." video URLs imported";

	$m->redirect("import_csv.mhtml?err=$err&msg=$msg");

</%init>


