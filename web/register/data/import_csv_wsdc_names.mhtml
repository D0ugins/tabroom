<%args>
	$tourn
	$person
	$event_id
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now(time_zone => $tz);

	# Get the upload and create the file handle.
	my $req = Apache2::Request->new($r);
	my @csv_handles = $r->upload; 
	my $csv_file = $req->upload($csv_handles[0]);
	my $io = $csv_file->io;

	my @lines = <$io>;

	my @entries;

	foreach (@lines) { 
		$_ =~ s/[\r]+/\n/g;
		$_ =~ s/[\r\n]+/\n/g;
		$_ =~ s/[\n]+/\n/g;
		push @entries, split (/\n/, $_);
	}

	my $err;

	my %entries;

	ENTRY:
	foreach my $entry (@entries) { 

		my ($first_name, $last_name, $nation, $role) = split(/,/, $entry);

		next unless $first_name;

		next if $first_name eq "First Name";

		foreach ($first_name, $last_name, $nation, $role) { 
			$_ =~ s/^"//;
			$_ =~ s/"$//g;
		}

		$last_name = lc($last_name);
		$last_name = ucfirst($last_name);

		my $entry = $entries{$nation};
		$entry = Tab::Entry->search( 
			code        => $nation,
			event       => $event_id,
			unconfirmed => 0
		)->first unless $entry;

		unless ($entry) { 
			
			$err = "Whoops!  Can't find ".$nation." <br />";

		} else { 

			my $school = $entry->school; 
			my $chapter = $school->chapter;

			if ($chapter) { 

				my $student = Tab::Student->search( first => $first_name, last => $last_name)->first;

				unless ($student) { 
					
					$student = Tab::Student->create({
						chapter   => $chapter->id,
						first     => $first_name,
						last      => $last_name,
						grad_year => 2016,
						novice    => 0,
						retired   => 0
					});

				} 

				Tab::EntryStudent->create({
					student => $student->id,
					entry   => $entry->id
				});

			} else { 

				$err = "Could not find chapter for $nation <br />";

			}

		}

	}	

	my $msg = scalar @entries ." names imported into ".$event->name;

	$m->redirect("import_csv.mhtml?msg=$msg&err=$err");

</%init>
