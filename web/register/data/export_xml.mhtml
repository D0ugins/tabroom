<%args>
	$tourn
	$tourn_settings
	$person
	$session
	$category_id => undef
</%args>
<%init>

	my $category = Tab::Category->retrieve($category_id) if $category_id;
	$category = $tourn->categories->first if (scalar $tourn->categories) == 1;
	$category_id = $category->id if $category;

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		person         => $person,
		whoami         => 'export_xml'
	&>

	<div class="main">

		<h2>Export Universal XML</h2>

%		if ($person->id == 1) {

		<h4>Download Complete Tournament</h4>

		<form
			action="/api/download_data.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="row rightalign">

				<span class="half semibold redtext">
					Download Entire Tournament
				</span>

				<span class="twofifths centeralign">
				</span>

				<span class="eighth centeralign">
					<button
						class   = "buttonwhite bluetext invert fa fa-arrow-down"
						onClick = "this.form.submit();"
					></button>
				</span>
			</div>

		</form>

		<form
			action="/api/download_data.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="row rightalign">

				<span class="half semibold bluetext">
					Download One School's Registration
				</span>
				<span class="twofifths centeralign">
					<select name="school_id" class='fixedbig'>
						<option value=""></option>
%						foreach my $school ($tourn->schools) {
							<option
								value="<% $school->id %>"
							><% $school->name %></option>
%						}
					</select>
				</span>

				<span class="eighth centeralign">
					<button
						class   = "buttonwhite bluetext invert fa fa-arrow-down"
						onClick = "this.form.submit();"
					></button>
				</span>
			</div>
		</form>

		<form
			action="/api/download_data.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="row rightalign">

				<span class="half semibold bluetext">
					Download One Judge Category's Rounds &amp; Results
				</span>
				<span class="twofifths centeralign">
					<select name="category_id" class='fixedbig'>
						<option value=""></option>
%						foreach my $category ($tourn->categories) {
							<option
								value="<% $category->id %>"
							><% $category->name %></option>
%						}
					</select>
				</span>

				<span class="eighth centeralign">
					<button
						class   = "buttonwhite bluetext invert fa fa-arrow-down"
						onClick = "this.form.submit();"
					></button>
				</span>
			</div>
		</form>

		<form
			action="/api/download_data.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="row rightalign">

				<span class="half semibold bluetext">
					Download One Event's Rounds &amp; Results
				</span>
				<span class="twofifths centeralign">
					<select name="event_id" class='fixedbig'>
						<option value=""></option>
%						foreach my $event ($tourn->events) {
							<option
								value="<% $event->id %>"
							><% $event->name %></option>
%						}
					</select>
				</span>

				<span class="eighth centeralign">
					<button
						class   = "buttonwhite bluetext invert fa fa-arrow-down"
						onClick = "this.form.submit();"
					></button>
				</span>
			</div>
		</form>

%		}

		<h4 class="martopmore">TabXML Downloads</h4>

		<table>

%			foreach my $jg ($tourn->categories) {

				<tr class="row <% $category_id == $jg->id ? "semibold redtext biggish italic" : "" %>">

					<th>
						<% $jg->name %>
					</th>

					<td class="centeralign">
						<% scalar $jg->events %> Events
					</td>

					<td class="centeralign semibold bluetext">

%						if ($category_id == $jg->id) {
							<span class="padvertmore">
								Category Selected
							</span>
%						} else {
							<a
								class="redtext buttonwhite hover padless invert"
								href="export_xml.mhtml?category_id=<% $jg->id %>"
							>Choose</a>
%						}
					</td>

				</tr>
%			}

		</table>

%		if ($category_id) {

			<h4 class="martop">Select events/divisions</h4>

			<form action="/api/download_tourn.mhtml">

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<input
				type  = "hidden"
				name  = "category_id"
				value = "<% $category->id %>"
			>

%			foreach my $event ($category->events) {

				<div class="row">

					<span class="quarter">
						<% $event->name %>
						<div class="padno smaller martop">
							<% scalar $event->entries( active => 1) %> Active Entries
						</div>
					</span>

					<span class="threequarters nospace">
						<label for="waitlist_<% $event->id %>">
							<span class="third hover centeralign padless">
								Include Waitlist
									<input
										type  = "checkbox"
										id    = "waitlist_<% $event->id %>"
										name  = "waitlist_<% $event->id %>"
										value = "1"
									>
							</span>
						</label>

						<label for="drops_<% $event->id %>">
							<span class="third hover centeralign">
								Include Drops
									<input
										type  = "checkbox"
										id    = "drops_<% $event->id %>"
										name  = "drops_<% $event->id %>"
										value = "1"
									>
							</span>
						</label>

						<label for="<% $event->id %>">
							<span class="third hover centeralign">
								Export:
								<input
									type    = "checkbox"
									id      = "<% $event->id %>"
									checked = "checked"
									name    = "<% $event->id %>"
									value   = "1"
								>
							</span>
						</label>
					</span>

				</div>
%			}

			<div class="libl rightalign padmore">
				<input type="submit" value="Export XML">
				</form>
			</div>

%		}

%		if ($person->site_admin) {

%#			This has been wonky and confusing for folks so needs another pass
%#			sometime before the muggles can get it -CLP

			<h5 class="martopmore">
				OR
			</h5>

			<form action="/api/export_tourn_json.mhtml?tourn_id=<% $tourn->id %>">

				<input
					type  = "hidden"
					name  = "session_id"
					value = "<% $session->id %>"
				>

				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>

				<div class="libl rightalign padmore">
					<span class="leftalign semibold redtext">
						Export the whole thing as a JSON file
					</span>
					<input type="submit" value="Export JSON">
				</div>

			</form>
%		}

	</div>

