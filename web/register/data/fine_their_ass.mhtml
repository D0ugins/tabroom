<%args>
	$tourn
</%args>
<%init>

	my $reason = 'Nationals Registration incomplete ';
	my $now = DateTime->now();
	my $dbh = Tab::DBI->db_Main();

    my $unrejected_sth = $dbh->prepare("
        select school.id, school.name
        from school, entry
            where school.id = entry.school
            and school.tourn = ?
            and school.chapter > 0
            and not exists (
                select es.id
                from entry_setting es
                where es.tag = 'rejected_by'
                and es.entry = entry.id
            )
            and not exists (
                select es.id
                from entry_setting es
                where es.tag = 'dropped_by'
                and es.entry = entry.id
            )
        group by school.id
    ");

    $unrejected_sth->execute($tourn->id);
	my %schools = ();

	while (
		my ($school_id, $name) = $unrejected_sth->fetchrow_array()
	) {
		$schools{$school_id}{"unrejected"}++;
	}

    my $not_already_sth = $dbh->prepare("
        select school.id,  school.name
        from school
            where school.tourn = ?
            and school.chapter > 0
            and exists (
				select fine.id
				from fine
				where fine.school = school.id
				and fine.reason like ?
            )
    ");

    $not_already_sth->execute($tourn->id, $reason.'%');

	while (
		my ($school_id, $name) = $not_already_sth->fetchrow_array()
	) {

		$schools{$school_id}{"exempt"}++;
		$schools{$school_id}{"name"} = $name;
	}

    my $unpaid_sth = $dbh->prepare("
        select school.id, school.name
        from school
			where school.tourn = ?
            and school.chapter > 0
            and exists (
                select ss.id
                from school_setting ss
                where ss.tag = 'balance'
                and ss.school = school.id
				and ss.value > 0
            )
    ");

    $unpaid_sth->execute($tourn->id);

	while (
		my ($school_id, $name) = $unpaid_sth->fetchrow_array()
	) {
		$schools{$school_id}{"unpaid"}++;
		$schools{$school_id}{"name"} = $name;
	}

    my $nojudge_sth = $dbh->prepare("
        select school.id, school.name
        from school
			where school.tourn = ?
            and school.chapter > 0
            and exists (
                select ss.id
                from school_setting ss
                where ss.tag = 'judging_unmet'
                and ss.school = school.id
				and ss.value > 0
            )
    ");

    $nojudge_sth->execute($tourn->id);

	while (
		my ($school_id, $name) = $nojudge_sth->fetchrow_array()
	) {
		$schools{$school_id}{"nojudge"}++;
		$schools{$school_id}{"name"} = $name;
	}

    my $incomplete_sth = $dbh->prepare("

        select school.id, school.name
            from school, entry
            where school.id = entry.school
            and school.tourn = ?
            and entry.active = 1
            and school.chapter > 0
            and not exists (
                select es.id
                from entry_setting es
                where es.tag = 'status'
				and es.value = 'complete'
				and es.entry = entry.id
            )
            and not exists (
                select evset.id
                from event_setting evset
                where evset.tag = 'supp'
				and evset.event = entry.event
            )
            and not exists (
                select evset.id
                from event_setting evset
                where evset.tag = 'conn'
				and evset.event = entry.event
            )

		group by school.id

    ");

	my $contacts_sth = $dbh->prepare("
		select person.email
		from person, permission
			where person.id = permission.person
			and permission.chapter = ?
			and permission.tag = 'chapter'
	");

    $incomplete_sth->execute($tourn->id);

	while (
		my ($school_id, $name) = $incomplete_sth->fetchrow_array()
	) {
		$schools{$school_id}{"incomplete"}++;
		$schools{$school_id}{"name"} = $name;
	}

	$m->clear_buffer();

	foreach my $school_id (keys %schools) {

		next if $schools{$school_id}{"exempt"};
		next unless $schools{$school_id}{"unrejected"};

		next unless ($schools{$school_id}{"nojudge"}
			|| $schools{$school_id}{"unpaid"}
			|| $schools{$school_id}{"incomplete"} );

		my $local_reason;
		$local_reason .= " Judging burden not met. " if $schools{$school_id}{"nojudge"};
		$local_reason .= " Fees unpaid. " if $schools{$school_id}{"unpaid"};
		$local_reason .= " Entry information incomplete. " if $schools{$school_id}{"incomplete"};

		$m->print("<p>Fees for $school_id ".$schools{$school_id}{"name"}." because : $local_reason</p>");
		$m->flush_buffer();

		my $msg;

		unless ($ARGS{"nofine"}) {

$msg = "

		Hello!

		This is an automated message to let you that your school registration
		at Nationals is overdue, and that the late fee of \$200 has been
		applied to your bill, because of:

		$local_reason

		This was the result of an automatic process so it is possible that you
		have issues in progress with the office or extenuating circumstances
		that were not caught.  If so, please reply to this email or contact the
		NSDA office.

		Otherwise, please complete your registration as quickly as possible to
		ensure your registration for Nationals is accepted, or alternates have
		the chance to make plans to attend if your students cannot.

";

			Tab::Fine->create({
				school    => $school_id,
				reason    => $reason.": ".$local_reason,
				amount    => "200",
				tourn     => $tourn->id,
				levied_at => $now,
				deleted   => 0,
				payment   => 0,
			});

		} else {

$msg = "
		Hello!

		This is an automated message to let you that your school registration
		at Nationals is overdue, and you are potentially liable for a \$200
		late charge, because of:

		$local_reason

		This was the result of an automatic process so it is possible that you
		have issues in progress with the office or extenuating circumstances
		that were not caught.  If so, please reply to this email or contact the
		NSDA office.

		Otherwise, please complete your registration as quickly as possible to
		avoid assessment of this charge and ensure your registration for
		Nationals is accepted, or alternates have the chance to make plans to
		attend if your students cannot.
";
		}

		if ($school_id && $msg) {

			$contacts_sth->execute($school_id);

			my $all_emails;
			my %done;

			while (
				my ($contact) = $contacts_sth->fetchrow_array()
			) {
				next if $done{$contact}++;
				$all_emails .= "," if $all_emails;
				$all_emails .= $contact;
			}

			$m->comp("/funclib/send_email.mas",
				raw         => $all_emails,
				subject     => "Alert: Nationals Registration Overdue",
				from_string => "nsda",
				body        => $msg
			);

		}
	}

	$m->abort();

</%init>
