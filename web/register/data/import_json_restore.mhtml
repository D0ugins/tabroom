<%args>
	$tourn
	$tourn_settings
	$person
	$session
</%args>
<%init>

	my $switch;

	my $ok;
	$ok++ if $person->site_admin;

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		person         => $person,
		whoami         => 'import_json_data',
		ok             => $ok
	&>

	<div class="main">

		<h2><% $tourn->name %></h2>

		Use the top option to MAKE a backup of all your tournament data.
		If sometthing is all messed up and you need to restore all or part
		of that backup file, select ONE of the options below and bask in
		triumph of how organized and responsible you are.  
        
		<h4>Create offline backup file of the tournament</h4>

			<form action="/api/export_tourn_json.mas?tourn_id=<% $tourn->id %>">
					
			<input 
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>
		
			<div class="libl padmore">

				<span class="threequarters leftalign">
					Export the whole thing as a JSON file 
				</span>

				<span class="quarter leftalign">
					<input type="submit" value="Export JSON">
					</form>
				</span>

			</div>

		<h4>Restore the registration for one school</h4>

		<p>
			
			Say one school mucked up its registration before the tournament
			started.  This will read it back in from your backup.  You'd only
			use this BEFORE a tournament started.  If you can, select the
			school from the drop-down list.  If it's not there, find the school
			ID in the backup file and type that in the box.  (If you use this
			after competition has started it will erase the results.)

		</p>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_partial.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input 
			type="hidden" 
			name="tourn_id" 
			value="<% $tourn->id %>"
		>

		<input 
			type="hidden" 
			name="person_id" 
			value="<% $person->id %>"
		>

		<input 
			type="hidden" 
			name="session_id" 
			value="<% $session->id %>"
		>

		<input 
			type  = "hidden"
			name  = "restore_mode"
			value = "school_reg"
		>

		<div class="even">

			<span class="quarter">

				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName()"
						id       = "upload"
					>

					<span 
						id    = "filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>

				</div>
			</span>

			<span class="threefifths">

				<div class="borderbottom nospace">

					<span class="third semibold redtext">
						Select School: 
					</span>

					<span class="twothirds">

						<select 
							class    = "notfirst fixedbig"
							name     = "school_id"
						>
<%perl>
						my @schools  = 
						sort {ucfirst($a->name) cmp ucfirst($b->name)}
							Tab::School->search(
								tourn  => $tourn->id,
						);
						
						foreach my $school (@schools) { 

</%perl>

							<option 
								value="<% $school->id %>" 
							> <% $school->name %>
							</option>
%						}

						</select>

					</span>

				</div>

				<span class="third semibold redtext">
					OR, Enter School ID:
				</span>

				<span class="third">
					<input 
						type  = "number"
						name  = "user_provided_school_id"
						size  = "12"
						step  = "1"
						class = "larger"
					>
				</span>
			</span>
			
			<span class="eighth rightalign">
				<input 
					type  = "submit"
					value = "Upload Data"
				>
			</span>

		</div>

		</form>

		<h4>Restore one round</h4>

		<p>
			Say you just need to import the pairings (and any results) from a
			single round.  This will restore that round from your backup and
			leave the rest alone.  If you only want to restore the results, and
			not re-create the rounds and settings, check the top checkbox.  If
			the round was tabbed on software outside of tabroom, such as the
			STA, click the bottom checkbox.  If you click the bottom box, you
			MUST click the top box.  If you don't the computer will do it
			before it starts working, but do it anyway out of a sense of
			thoroughness.
		</p>
        
		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_partial.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input 
			type  = "hidden"
			name  = "tourn_id"
			value = "<% $tourn->id %>"
		>

		<input 
			type  = "hidden"
			name  = "person_id"
			value = "<% $person->id %>"
		>

		<input 
			type  = "hidden"
			name  = "session_id"
			value = "<% $session->id %>"
		>

		<input 
			type  = "hidden"
			name  = "restore_mode"
			value = "round"
		>
		
		<div class="row">

			<span class="quarter">
				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName('round_xml','json_filename')"
						id       = "json_data"
					>

					<span 
						id    = "json_data_round"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>


					<span 	
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>

				</div>
			</span>

			<span class="threefifths">

				<div class="borderbottom nospace">

					<span class="third semibold redtext">
						Select School: 
					</span>

					<span class="twothirds">

						<select 
							class    = "notfirst fixedbig leftalign"
							name     = "round_id"
							id		 =	"round_select"
						>
<%perl>
						my @rounds = $m->comp(
							"/funclib/tourn_rounds.mas", 
							tourn=> $tourn
						);
						
						foreach my $round (@rounds) { 

</%perl>
							<option 
								value="<% $round->id %>" 
							> <% $round->event->name %> <% substr($round->name,0,25) %> <% $round->label %>
							</option>
%						}

%				
						</select>

					</span>

				</div>

				<label for="round_data_only">

					<div class="full nospace borderbottom hover">

						<span class="quarter nospace centeralign">
							<input 
								type    = "checkbox"
								name    = "round_data_only"
								id      = "round_data_only"
								checked = "true"
								value   = "1"
							>
						</span>
						<span class="threequarters nospace">
							Only update round results, not settings
						</span>

					</div>

				</label>

				<label for="foreign_round_data">

					<div class="full nospace hover">

						<span class="quarter nospace centeralign">
							<input 
								type  = "checkbox"
								name  = "foreign_round_data"
								id    = "foreign_round_data"
								value = "1"
							>
						</span>
						<span class="threequarters nospace">
							This data didn't come from tabroom
						</span>
					</div>

				</label>
				
			</span>

			<span class="eighth rightalign">
				<input 
					type  = "submit"
					value = "Upload Data"
				>
			</span>

		</div>

		</form>

		<h4>Restore an event</h4>

		<p>
			
			This will delete all event info (including entries and results) and replace them with whatever is in the backup file.
			If you can, select the event from the drop-down list.  If it's not there, find the event ID in the
			backup file and type that in the box.  You'll need to do one of those 2 things for this to work.
		</p>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_partial.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
		<input type="hidden" name="person_id" value="<% $person->id %>">
		<input type="hidden" name="session_id" value="<% $session->id %>">
		<input type="hidden" name="restore_mode" value="event">
		
		<div class="even">

			<span class="twofifth">
				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName()"
						id       = "upload"
					>

					<span 
						id    = "filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>

				</div>
			</span>

			<span class="twofifth hover">
				Select Event: 
				<select 
					class    = "notfirst fixedbig leftalign"
					name     = "event_id"
				>
<%perl>
				my @events  = 
				sort {ucfirst($a->name) cmp ucfirst($b->name)}
					Tab::Event->search(
						tourn  => $tourn->id,
				);
				
				foreach my $event (@events) { 

</%perl>

					<option 
						value="<% $event->id %>" 
					> <% substr($event->name,0,25) %>
					</option>
%					}
				</select>
				
				<br>OR, enter the event ID in the file you are restoring:        
				<input type="text" name="user_provided_event_id" >
					
			</span>

			<span class="fifth rightalign">
				<input type="submit" value="Upload Data">
			</span>

		</div>

		</form>

		<h4>Import a Whole Tournament from a FOREIGN source</h4>

		<p>
            This works for a file created outside of tabroom, such as the NSDA nationals.  In fact, that's all it will work for.  
			(The file still has to comply with the tabroom JSON format.)  Enter nothing in that box on the first run to create the generic files (stuff like schools, entries, judges and students).  Then enter each TRPC event number one at a time to upload the rest (like rounds, panels, ballots and scores). God help you.
        </p>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_tourn.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
		<input type="hidden" name="person_id" value="<% $person->id %>">
		<input type="hidden" name="session_id" value="<% $session->id %>">
		<input type="hidden" name="restore_mode" value="tourn">
		
		<div class="even">

			<span class="twofifth">
				<div class="uploader">
					<input type="file" name="json_data" style="opacity: 0;" onchange="uploaderName('scratch', 'scratch_filename')" id="scratch">
					<span id="scratch_filename" class="filename" style="-webkit-user-select: none;">No file selected</span>
					<span class="action" style="-webkit-user-select: none;">Choose File</span>
				</div>
			</span>
			
			<span class="twofifth">
				Enter the event ID for data restore:        
				<input type="text" name="event_id" >
			</span>	

			<span class="fifth rightalign">
				<input type="submit" value="Upload Data">
			</span>

		</div>

		</form>

		<h4>Import a Whole Tournament from a NATIVE source</h4>

		<p>
			This works for tournaments that have been on tabroom for their whole life cycle.  (The big difference is that
			this will retain the original ID numbers and not try to match entries to permanet records, like chapters.  It will just
			assume those things exist.)  Don't check the room box unless the problem you're having specifically involves rooms.
            This is going to blow away everything that is currently loaded for this tournament and replace
            it with the backup file you upload, and there will be NO FURTHER WARNINGS.  God help you.
        </p>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_tourn_native.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
		<input type="hidden" name="person_id" value="<% $person->id %>">
		<input type="hidden" name="session_id" value="<% $session->id %>">
		<input type="hidden" name="restore_mode" value="tourn">
		
		<div class="even">

			<span class="twofifth">
				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName('scratch', 'scratch_filename')"
						id       = "scratch"
					>
					<span 
						id    = "scratch_filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>
				</div>
			</span>

			<span class="twofifth">
				<input 
					type = "checkbox"
					name = "include_rooms"
				>Delete and restore rooms
			</span>	
			
			<span class="fifth rightalign">
				<input type="submit" value="Upload Data">
			</span>

		</div>

		</form>

	</div>
