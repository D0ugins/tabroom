<%args>
	$tourn
	$person
	$session
</%args>
<%init>

	my $switch;

	my $ok;
	$ok++ if $person->site_admin;

</%init>

	<& "menu.mas", tourn => $tourn, person => $person, whoami => 'import_json_data', ok => $ok &>

	<div class="main">

		<h2><% $tourn->name %></h2>

        Use this ONLY to import data directly downloaded from Tabroom in a JSON format.
        Select ONE of the options below.  And this will only work if you've made a JSON backup.
        
		<h4>Back Up a tournament</h4>

			<form action="/api/export_tourn_json.mas?tourn_id=<% $tourn->id %>">
					
			<input 
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>
		
			<div class="libl padmore">
				<span class="leftalign">Export the whole thing as a JSON file </span>
				<input type="submit" value="Export JSON">
				</form>
			</div>

		<h4>Restore the registration for one school</h4>

		<p>
			
            Say one school mucked up its registration before the tournament started.
            This will read it back in from your backup.  You'd only use this BEFORE a tournament started.
            
		</p>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
		<input type="hidden" name="person_id" value="<% $person->id %>">
		<input type="hidden" name="session_id" value="<% $session->id %>">
		<input type="hidden" name="restore_mode" value="school_reg">

		<div class="even">

			<span class="twofifth">
				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName()"
						id       = "upload"
					>

					<span 
						id    = "filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>

				</div>
			</span>

			<label for="no_prefs">
				<span class="twofifth hover">
					Select School: 
					<select 
                        class    = "notfirst fixedbig leftalign"
                    	name     = "school_id"
                    >
<%perl>
                    my @schools  = 
                    sort {ucfirst($a->name) cmp ucfirst($b->name)}
                        Tab::School->search(
                            tourn  => $tourn->id,
                    );
                    
                    foreach my $school (@schools) { 

</%perl>

						<option 
							value="<% $school->id %>" 
						> <% substr($school->name,0,25) %>
						</option>
%					}
                    </select>
                    
				</span>
			</label>

			<span class="fifth rightalign">
				<input type="submit" value="Upload Data">
			</span>

		</div>

		</form>

		<h4>Restore one round</h4>

		<p>
			
            You just need to import the pairings (and any results) from a single round.
            This will restore that round from your backup and leave the rest alone.
            
		</p>
        
		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
		<input type="hidden" name="person_id" value="<% $person->id %>">
		<input type="hidden" name="session_id" value="<% $session->id %>">
		<input type="hidden" name="restore_mode" value="round">
		
		<div class="even">

			<span class="twofifth">
				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName('round_xml','json_filename')"
						id       = "json_data"
					>

					<span 
						id    = "json_data"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>


					<span class="action" style="-webkit-user-select: none;">Choose File</span>
				</div>
			</span>

			<label for="no_prefs">
				<span class="twofifth hover">
					Select round: 
					<select 
                        class    = "notfirst fixedbig leftalign"
                    	name     = "round_id"
                    >
<%perl>
                	my @rounds = $m->comp(
                        "/funclib/tourn_rounds.mas", 
                        tourn=> $tourn
                    );
                    
                    foreach my $round (@rounds) { 

</%perl>

						<option 
							value="<% $round->id %>" 
						> <% $round->event->name %> <% substr($round->name,0,25) %> <% $round->label %>
						</option>
%					}
                    </select>
                    
				</span>
			</label>


			<span class="fifth rightalign">
				<input type="submit" value="Upload Data">
			</span>

		</div>

		</form>

		<h4>Restore an event</h4>

		<p>
			
			Things are going pretty well at the tournament but the one guy you hired because they knew tabroom
			has terminally mucked up the event.  This will delete all event info (including entries and restuls) and replace them.
            
		</p>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
		<input type="hidden" name="person_id" value="<% $person->id %>">
		<input type="hidden" name="session_id" value="<% $session->id %>">
		<input type="hidden" name="restore_mode" value="event">
		
		<div class="even">

			<span class="twofifth">
				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName()"
						id       = "upload"
					>

					<span 
						id    = "filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>

				</div>
			</span>

			<label for="no_prefs">
				<span class="twofifth hover">
					Select Event: 
					<select 
                        class    = "notfirst fixedbig leftalign"
                    	name     = "event_id"
                    >
<%perl>
                    my @events  = 
                    sort {ucfirst($a->name) cmp ucfirst($b->name)}
                        Tab::Event->search(
                            tourn  => $tourn->id,
                    );
                    
                    foreach my $event (@events) { 

</%perl>

						<option 
							value="<% $event->id %>" 
						> <% substr($event->name,0,25) %>
						</option>
%					}
                    </select>
                    
				</span>
			</label>

			<span class="fifth rightalign">
				<input type="submit" value="Upload Data">
			</span>

		</div>

		</form>

		<h4>Restore an entire tournament</h4>

		<p>
            This is going to blow away everything that is currently loaded for this tournament and replace
            it with the backup file you upload, and there will be no further warnings.  God help you.
        </p>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
		<input type="hidden" name="person_id" value="<% $person->id %>">
		<input type="hidden" name="session_id" value="<% $session->id %>">
		<input type="hidden" name="restore_mode" value="tourn">
		
		<div class="even">

			<span class="twofifth">
				<div class="uploader">
					<input type="file" name="json_data" style="opacity: 0;" onchange="uploaderName('scratch', 'scratch_filename')" id="scratch">
					<span id="scratch_filename" class="filename" style="-webkit-user-select: none;">No file selected</span>
					<span class="action" style="-webkit-user-select: none;">Choose File</span>
				</div>
			</span>

			<span class="fifth rightalign">
				<input type="submit" value="Upload Data">
			</span>

		</div>

		</form>

	</div>
