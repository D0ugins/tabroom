<%args>
	$tourn
	$tourn_settings
	$person
	$session
</%args>
<%init>

	my $switch;

	my $ok;
	$ok++ if $person->site_admin;

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		person         => $person,
		whoami         => 'import_json_data',
		ok             => $ok
	&>

	<div class="main">

		<h2><% $tourn->name %></h2>
        
		<h5>Create tournament backup file</h5>

		<form action="/api/export_tourn_json.mas?tourn_id=<% $tourn->id %>">
					
			<input 
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>
			
			<div class="row padmore">

				<span class="third semibold bluetext">
					Export tournament backup file 
				</span>

				<label for="exclude_results">
					<span class="third hover centeralign">
						<input 
							type  = "checkbox"
							name  = "exclude_results"
							id    = "exclude_results"
							value = 1
						>Exclude results 
					</span>	
				</label>

				<span class="third rightalign">
					<input type="submit" value="Export">
				</span>

			</div>

		</form>

		<h5>Import tournament backup file</h5>

		<p class="semibold redtext">
			Restoring will delete your WHOLE TOURNAMENT and replace it with the
			file contents.
		</p>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_native.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>
		
		<div class="even">

			<span class="threetenths padno centeralign">
				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						onchange = "uploaderName('full', 'full_filename')"
						id       = "full"
					>
					<span 
						id    = "full_filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>
				</div>
			</span>

			<label for="include_rooms">
				<span class="half hover">
					<input 
						type  = "checkbox"
						name  = "include_rooms"
						id    = "include_rooms"
						value = 1
					>Delete and restore rooms
				</span>	
			</label>
			
			<span class="fifth rightalign">
				<input type="submit" value="Upload">
			</span>

		</div>

		</form>

		<h5 class="martop">
			Restore the registration for one school
		</h5>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_partial.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input 
			type="hidden" 
			name="tourn_id" 
			value="<% $tourn->id %>"
		>

		<input 
			type="hidden" 
			name="person_id" 
			value="<% $person->id %>"
		>

		<input 
			type="hidden" 
			name="session_id" 
			value="<% $session->id %>"
		>

		<input 
			type  = "hidden"
			name  = "restore_mode"
			value = "school_reg"
		>

		<div class="even">

			<span class="threetenths padno centeralign">

				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						onchange = "uploaderName('school', 'school_filename')"
						id       = "school"
					>

					<span 
						id    = "school_filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>

				</div>
			</span>

			<span class="half">

				<div class="borderbottom nospace">

					<span class="quarter semibold redtext">
						School
					</span>

					<span class="threequarters">

						<select 
							class    = "notfirst fixedbig"
							name     = "school_id"
						>
<%perl>
						my @schools  = 
						sort {ucfirst($a->name) cmp ucfirst($b->name)}
							Tab::School->search(
								tourn  => $tourn->id,
						);
						
						foreach my $school (@schools) { 

</%perl>

							<option 
								value="<% $school->id %>" 
							> <% $school->name %>
							</option>
%						}

						</select>

					</span>

				</div>

				<span class="twothirds semibold redtext">
					OR, Enter School ID:
				</span>

				<span class="third">
					<input 
						type  = "number"
						name  = "user_provided_school_id"
						size  = "12"
						step  = "1"
						class = "larger"
					>
				</span>
			</span>
			
			<span class="fifth rightalign marno">
				<input 
					type  = "submit"
					value = "Upload"
				>
			</span>

		</div>

		</form>

		<h5>Restore one round</h5>
        
		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_partial.mhtml"
			method   = "post"
			onsubmit = "return uploadThis()"
		>

		<input 
			type  = "hidden"
			name  = "tourn_id"
			value = "<% $tourn->id %>"
		>

		<input 
			type  = "hidden"
			name  = "person_id"
			value = "<% $person->id %>"
		>

		<input 
			type  = "hidden"
			name  = "session_id"
			value = "<% $session->id %>"
		>

		<input 
			type  = "hidden"
			name  = "restore_mode"
			value = "round"
		>
		
		<div class="row">

			<span class="threetenths padno centeralign">
				<div class="uploader">
					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName('round_data','round_filename')"
						id       = "round_data"
					>

					<span 
						id    = "round_filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>


					<span 	
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>

				</div>
			</span>

			<span class="half">

				<div class="borderbottom nospace">

					<span class="quarter semibold redtext">
						Round
					</span>

					<span class="threequarters">

						<select 
							class    = "notfirst fixedbig leftalign"
							name     = "round_id"
							id		 =	"round_select"
						>
<%perl>
						my @rounds = $m->comp(
							"/funclib/tourn_rounds.mas", 
							tourn=> $tourn
						);
						
						foreach my $round (@rounds) { 
</%perl>
							<option 
								value="<% $round->id %>" 
							> <% $round->event->name %> <% substr($round->name,0,25) %> <% $round->label %>
							</option>
%						}
						</select>

					</span>

				</div>

				<label for="round_data_only">

					<div class="full nospace borderbottom hover">

						<span class="quarter nospace centeralign">
							<input 
								type    = "checkbox"
								name    = "round_data_only"
								id      = "round_data_only"
								checked = "true"
								value   = "1"
							>
						</span>
						<span class="threequarters nospace">
							Only update round results, not settings
						</span>

					</div>

				</label>

				<label for="foreign_round_data">

					<div class="full nospace hover">

						<span class="quarter nospace centeralign">
							<input 
								type  = "checkbox"
								name  = "foreign_round_data"
								id    = "foreign_round_data"
								value = "1"
							>
						</span>
						<span class="threequarters nospace">
							This data didn't come from tabroom
						</span>
					</div>

				</label>
				
			</span>

			<span class="fifth rightalign">
				<input 
					type  = "submit"
					value = "Upload"
				>
			</span>

		</div>

		</form>

		<h5>Restore an event</h5>

		<form 
			name     = "json_data"
			enctype  = "multipart/form-data"
			action   = "/api/upload_json_partial.mhtml"
			method   = "post"
			onsubmit = "return uploadThis();"
		>

		<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
		<input type="hidden" name="person_id" value="<% $person->id %>">
		<input type="hidden" name="session_id" value="<% $session->id %>">
		<input type="hidden" name="restore_mode" value="event">
		
		<div class="even">

			<span class="threetenths">

				<div class="uploader">

					<input 
						type     = "file"
						name     = "json_data"
						style    = "opacity: 0;"
						onchange = "uploaderName()"
						id       = "upload"
					>

					<span 
						id    = "filename"
						class = "filename"
						style = "-webkit-user-select: none;"
					>No file selected</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>

				</div>
			</span>

			<span class="half">

				<span class="quarter semibold redtext">
					Event
				</span>

				<span class="threequarters">

					<select 
						class    = "notfirst fixedbig leftalign"
						name     = "event_id"
					>

%					foreach my $event ($tourn->events) { 
						<option 
							value="<% $event->id %>" 
						> <% substr($event->name,0,25) %>
						</option>
%					}

					</select>

				</span>

				<span class="twothirds marless">
					Or enter an event ID:
				</span>

				<span class="third">
					<input 
						type="number" 
						name="user_provided_event_id"
					>
				</span>
					
			</span>

			<span class="fifth rightalign">
				<input type="submit" value="Upload">
			</span>

		</div>

		</form>

%		if ($person->site_admin) { 

			<h5>Import a Whole Tournament from a FOREIGN source</h5>

			<p>
				If you use this in a context other than the explicit direction of
				Jon or Chris at NSDA Nationals, you will definitely regret it. 
			</p>

			<p>
				(The file still has to comply with the tabroom JSON format.)  Enter
				nothing in that box on the first run to create the generic files
				(stuff like schools, entries, judges and students).  Then enter
				each TRPC event number one at a time to upload the rest (like
				rounds, panels, ballots and scores). God help you.
			</p>

			<form 
				name     = "json_data"
				enctype  = "multipart/form-data"
				action   = "/api/upload_json_tourn.mhtml"
				method   = "post"
				onsubmit = "return uploadThis()"
			>

			<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
			<input type="hidden" name="person_id" value="<% $person->id %>">
			<input type="hidden" name="session_id" value="<% $session->id %>">
			<input type="hidden" name="restore_mode" value="tourn">
			
			<div class="even">

				<span class="twofifth">
					<div class="uploader">
						<input 
							type     = "file"
							name     = "json_data"
							style    = "opacity: 0;"
							onchange = "uploaderName('scratch', 'scratch_filename')"
							id       = "scratch"
						>

						<span 
							id    = "scratch_filename"
							class = "filename"
						>No file selected</span>

						<span class="action">Choose File</span>
					</div>
				</span>
				
				<span class="twofifth">
					Enter the event ID for data restore:        
					<input type="number" name="event_id" >
				</span>	

				<span class="fifth rightalign">
					<input type="submit" value="Upload Data">
				</span>

			</div>

			</form>
%		}

	</div>
