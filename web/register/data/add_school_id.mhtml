<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$chapter_id  => undef
</%args>
<%init>

	if ($chapter_id) { 

		my $chapter = Tab::Chapter->retrieve($chapter_id);

		unless ($chapter) { 
			my $err = "Chapter ID $chapter_id did not find a valid chapter";
			$m->redirect("add_school.mhtml?err=$err");
		}

		my $already = Tab::School->search( 
			chapter => $chapter_id,
			tourn   => $tourn->id
		)->first;

		if ($already) { 
			my $err = $chapter->name." is already entered in your tournament.  Try again";
			$m->redirect("add_school.mhtml?err=$err");
		}

		my $school = Tab::School->create({
			chapter => $chapter->id,
			tourn   => $tourn->id,
			name    => $chapter->name
		});

		my $now = DateTime->now;

		$school->setting("entered_on", "date", $now);
		$school->setting("entered_by", $person->id);

		$m->comp("/funclib/chapter_conflicts.mas", 
			school => $school
		);

		my $msg = "School ".$chapter->name." has been added to your tournament entry.  It currently has no school code though so do something about that if you care.";
		$m->redirect("add_school.mhtml?msg=$msg");

	}

	my $err = "No chapter ID was sent so I'm not sure what expected to have happen here...";

	$m->redirect("/register/data/add_school.mhtml?err=$err");


</%init>
