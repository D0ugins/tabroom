<%args>
	$tourn
	$tourn_settings
	$person
	$session
	$category_id => undef
</%args>
<%init>

	my $category = Tab::Category->retrieve($category_id) if $category_id;

	$category = $tourn->categories->first if (scalar $tourn->categories) == 1;

	$category_id = $category->id if $category;

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		person         => $person,
		whoami         => 'export_data'
	&>

	<div class="main">

		<h4>Download Tabroom Data</h4>

		<form
			action="/api/download_data.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="row rightalign">

				<span class="quarter semibold redtext">
					Entire Tournament
				</span>

				<span class="twofifths centeralign">
				</span>

				<span class="quarter">
				</span>

				<span class="tenth centeralign">
					<button
						class   = "buttonwhite bluetext invert fa fa-arrow-down"
						onClick = "this.form.submit();"
					></button>
				</span>
			</div>

		</form>

		<form
			action="/api/download_data.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="row rightalign">

				<span class="quarter semibold bluetext">
					School Registration
				</span>

				<span class="twofifths centeralign">

					<select name="school_id" class='fixedbig'>

						<option value=""></option>
%						foreach my $school ($tourn->schools) {
							<option
								value="<% $school->id %>"
							><% $school->name %></option>
%						}
					</select>
				</span>

				<span class="quarter">
				</span>

				<span class="tenth centeralign">
					<button
						class   = "buttonwhite bluetext invert fa fa-arrow-down"
						onClick = "this.form.submit();"
					></button>
				</span>
			</div>
		</form>

		<form
			action="/api/download_data.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="row rightalign">

				<span class="quarter semibold bluetext">
					One Judge Category
				</span>

				<span class="twofifths centeralign">

					<select name="category_id" class='fixedbig'>

						<option value=""></option>
%						foreach my $category ($tourn->categories) {
							<option
								value="<% $category->id %>"
							><% $category->name %></option>
%						}
					</select>
				</span>

				<label for="rounds_only_cat">
					<span class="quarter centeralign hover semibold redtext">
						Rounds/Results Only
						<input
							type  = "checkbox"
							name  = "rounds_only"
							id    = "rounds_only_cat"
							value = "1"
						>
					</span>
				</label>

				<span class="tenth centeralign">
					<button
						class   = "buttonwhite bluetext invert fa fa-arrow-down"
						onClick = "this.form.submit();"
					></button>
				</span>
			</div>
		</form>

		<form
			action="/api/download_data.mhtml"
			method="post"
		>

			<input
				type  = "hidden"
				name  = "session_id"
				value = "<% $session->id %>"
			>

			<input
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

			<div class="row rightalign">

				<span class="quarter semibold bluetext">
					One Event
				</span>

				<span class="twofifths centeralign">
					<select name="event_id" class='fixedbig'>
						<option value=""></option>
%						foreach my $event ($tourn->events) {
							<option
								value="<% $event->id %>"
							><% $event->name %></option>
%						}
					</select>
				</span>

				<label for="rounds_only_event">
					<span class="quarter centeralign hover semibold redtext">
						Rounds/Results Only
						<input
							type  = "checkbox"
							name  = "rounds_only"
							id    = "rounds_only_event"
							value = "1"
						>
					</span>
				</label>

				<span class="tenth centeralign">
					<button
						class   = "buttonwhite bluetext invert fa fa-arrow-down"
						onClick = "this.form.submit();"
					></button>
				</span>

			</div>

		</form>

<%perl>

		my %categories;

		foreach my $category ($tourn->categories) {

			foreach my $event ($category->events) {
				$categories{$category->id}{events}{$event->id} = $event;
			}

			$categories{$category->id}{name} = $category->name;
			$categories{$category->id}{abbr} = $category->abbr;
		}

</%perl>

		<script>

			function pickEvents() {
				$(".eventlists").addClass("hidden");
				var catID = $("#category_id").val();
				$("#events_"+catID).removeClass("hidden");
			}

		</script>

		<div class="full nospace bottomalign martopmuchmore padbottom">
			<span class="third nospace">
				<h5 class="nospace">Legacy XML Downloads</h5>
			</span>

			<span class="twothirds graytext semibold rightalign nospace">
				Don't use XML unless you specifically have been instructed.
			</span>
		</div>

		<div class="row">

			<span class="third semibold bluetext">
				Judge Category
			</span>

			<span class="twothirds centeralign">
				<select
					id       = "category_id"
					name     = "category_id"
					onChange = "pickEvents();"
				>
<%perl>
					foreach my $cat (
						sort {
							$categories{$a}{"name"} <=> $categories{$b}{"name"}
						} keys %categories
					) {
</%perl>

						<option value=""></option>

						<option
							value="<% $cat %>"
						><%
							$categories{$cat}{"abbr"}." ".
							$categories{$cat}{"name"}." (".
							scalar(keys %{$categories{$cat}{events}})." events )"
						%>
						</option>
%					}
				</select>
			</span>
		</div>

%		foreach my $cat (keys %categories) {

			<div
				class = "hidden full eventlists martopmore"
				id    = "events_<% $cat %>"
			>

				<h5 class="marbottommore">
					<% $categories{$cat}{"name"} %>: Select event/division(s):
				</h5>

				<form action="/api/download_tourn.mhtml">

				<input
					type  = "hidden"
					name  = "session_id"
					value = "<% $session->id %>"
				>

				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>

				<input
					type  = "hidden"
					name  = "category_id"
					value = "<% $cat %>"
				>

<%perl>
				foreach my $event_id (
					sort {
						$categories{$cat}{"events"}{$a}->name cmp $categories{$cat}{"events"}{$b}->name
					} keys (%{$categories{$cat}{'events'}})
				) {

					my $event = $categories{$cat}{"events"}{$event_id};
</%perl>

					<div class="row">

						<span class="quarter">

							<div class="inline semibold bluetext">
								<% $event->name %>
							</div>

							<div class="padno smaller martop">
								<% scalar $event->entries( active => 1) %> Active Entries
							</div>

						</span>

						<span class="threequarters nospace">
							<label for="waitlist_<% $event->id %>">
								<span class="third hover centeralign padless">
									Include Waitlist
										<input
											type  = "checkbox"
											id    = "waitlist_<% $event->id %>"
											name  = "waitlist_<% $event->id %>"
											value = "1"
										>
								</span>
							</label>

							<label for="drops_<% $event->id %>">
								<span class="third hover centeralign">
									Include Drops
										<input
											type  = "checkbox"
											id    = "drops_<% $event->id %>"
											name  = "drops_<% $event->id %>"
											value = "1"
										>
								</span>
							</label>

							<label for="<% $event->id %>">
								<span class="third hover centeralign">
									Export
									<input
										type    = "checkbox"
										id      = "<% $event->id %>"
										checked = "checked"
										name    = "<% $event->id %>"
										value   = "1"
									>
								</span>
							</label>
						</span>

					</div>

%				}

				<div class="libl rightalign padmore">
					<input type="submit" value="Download XML Data">
				</div>

			</form>
			</div>
%		}

	</div>

