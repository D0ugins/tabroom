<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$perms
	$what          => undef
	$startdate     => undef
	$starttime     => undef
	$enddate       => undef
	$endtime       => undef
	$nowme         => undef
	$only_category => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now->set_time_zone($tz);

	my $start = $now->clone();
	$start->subtract(days => 7);

	$startdate = Tab::pickerdate($start) unless $startdate;

	$enddate = Tab::pickerdate($now) unless $enddate;

	$starttime = "12:00 AM" unless $starttime;
	$endtime = "11:59 PM" unless $endtime;

	my $startdt;
	my $enddt;

	eval {
		$startdt = Tab::dtme($startdate,$starttime,$tz)
			if $startdate;

		$enddt = Tab::dtme($enddate,$endtime,$tz)
			if $enddate;
	};

	unless ($startdt && $enddt) {
		$m->print("Invalid date selected.  Please use the date picker to ensure correct formatting");
		$m->abort;
	}

	unless ($startdt) {
		$startdt = $now->clone;
		$startdt->truncate( to => "day" );
	}

	unless ($enddt) {
		$enddt = $now->clone;
		$enddt->add(hours => 3);
	}

	$startdt->set_time_zone($tz);
	$enddt->set_time_zone($tz);

	my $delete_permission;

	if (
		$tourn_settings->{"nsda_district"}
		|| $tourn_settings->{"nsda_nats"}
		|| $tourn_settings->{"nsda_ms_nats"}
	) {
		$delete_permission++ if $person->site_admin;
		$delete_permission++ if $person_settings->{'nsda_admin'};
	} else {

		$delete_permission++ if $perms->{"owner"};
	}


</%init>

	<div class="main">

%		if ($what eq "register") {

			<&
				"registration_moves.mas",
					only_category     => $only_category,
					tourn             => $tourn,
					tourn_settings    => $tourn_settings,
					delete_permission => $delete_permission,
					what              => $what,
					start             => $startdt,
					perms             => $perms,
					end               => $enddt
				&>

%		} elsif ($what eq "moves") {

			<&
				"moves.mas",
				only_category     => $only_category,
				tourn             => $tourn,
				tourn_settings    => $tourn_settings,
				delete_permission => $delete_permission,
				what              => $what,
				perms             => $perms,
				start             => $startdt,
				end               => $enddt
			&>

%		} elsif ($what eq "judge_moves") {
			<&
				"judge_moves.mas",
					only_category     => $only_category,
					tourn             => $tourn,
					tourn_settings    => $tourn_settings,
					delete_permission => $delete_permission,
					what              => $what,
					start             => $startdt,
					perms             => $perms,
					end               => $enddt
			&>

%		} elsif ($what eq "drops") {

			<&
				"drops.mas",
					only_category     => $only_category,
					tourn             => $tourn,
					tourn_settings    => $tourn_settings,
					delete_permission => $delete_permission,
					what              => $what,
					start             => $startdt,
					perms             => $perms,
					end               => $enddt
			&>
%		} else {

			<&
				"tab.mas",
					tourn             => $tourn,
					what              => $what,
					person            => $person,
					start             => $startdt,
					end               => $enddt,
					tourn_settings    => $tourn_settings,
					perms             => $perms,
					delete_permission => $delete_permission,
					only_category     => $only_category
			&>
%		}


	</div>

	<div class="menu">

		<div class="sidenote">

<%perl>

			my $ps = Tab::pickerdate($startdt);
			my $pst = Tab::pickertime($startdt);
			my $pe = Tab::pickerdate($enddt);
			my $pet = Tab::pickertime($enddt);

			my $args = "nowme=".$nowme."&startdate=".$ps."&enddate=".$pe."&starttime=".$pst."&endtime=".$pet;

</%perl>

			<h4>Change logs:</h4>

%			# Here's an unholy mess of bad URLs I should clean up some day:

%			if ($tourn_settings->{"track_reg_changes"}) {
				<a
					class = "<% $what eq "register" ? "dk" : ""%>blue full"
					href  = "index.mhtml?<% $args %>&what=register"
				>Show Registration Changes</a>
%			}


			<a
				class="<% $what eq "drops" ? "dk" : ""%>blue half"
				href="index.mhtml?nowme=<% $nowme %>&what=drops"
			>Entry Drops</a>

			<a
				class="blue half"
				href="print_drops.mhtml"
			>Print</a>

			<a
				class = "<% $what eq "conflicts" ? "dk" : ""%>blue full martopmore"
				href  = "index.mhtml?<% $args %>&what=conflicts"
			>Conflicts</a>

			<a
				class="<% $what eq "moves" ? "dk" : ""%>blue half"
				href  = "index.mhtml?<% $args %>&what=moves"
			>Entry Moves</a>

			<a
				class="blue half"
				href="moves_print.mhtml?<% $args %>"
			>Print</a>

			<a
				class="<% $what eq "judge_moves" ? "dk" : ""%>blue half"
				href  = "index.mhtml?<% $args %>&what=judge_moves"
			>Judge Moves</a>

			<a
				class = "blue half"
				href  = "judge_moves_print.mhtml?startdate=<% $ps %>&enddate=<% $pe %>&starttime=<% $pst %>&endtime=<% $pet %>"
			>Print</a>

			<a
				class = "<% $what eq "tabbing" ? "dk" : ""%>blue full"
				href  = "index.mhtml?<% $args %>&what=tabbing"
			>Tabulation</a>

			<a
				class = "<% $what eq "strikecards" ? "dk" : ""%>blue full martopmore"
				href  = "index.mhtml?<% $args %>&what=strikecards"
			>Strike Cards</a>

%			if ($tourn_settings->{"nsda_district"})  {
				<a
					class = "<% $what eq "districts" ? "dk" : ""%>blue full martopmore"
					href  = "index.mhtml?<% $args %>&what=districts"
				>Districts</a>
%			}

%			if ($tourn_settings->{"nsda_nats"})  {

				<a
					class = "<% $what eq "legislation" ? "dk" : ""%>blue full martopmore"
					href  = "index.mhtml?<% $args %>&what=legislation"
				>Legislation Uploads</a>

				<a
					class = "<% $what eq "notification" ? "dk" : ""%>blue full"
					href  = "index.mhtml?<% $args %>&what=notification"
				>District Opening Mails</a>

				<a
					class = "<% $what eq "promotions" ? "dk" : ""%>blue full"
					href  = "index.mhtml?<% $args %>&what=promotions"
				>Promotions</a>

				<a
					class = "<% $what eq "rejections" ? "dk" : ""%>blue full"
					href  = "index.mhtml?<% $args %>&what=rejections"
				>Rejections</a>

				<a
					class = "<% $what eq "registration" ? "dk" : ""%>blue full"
					href  = "index.mhtml?<% $args %>&what=registration"
				>Registration</a>

				<a
					class = "<% $what eq "access" ? "dk" : ""%>blue full"
					href  = "index.mhtml?<% $args %>&what=access"
				>Access</a>

%			}

		</div>

%		unless ($what eq "drops") {

			<div class="sidenote">

				<form
					action = "index.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "what"
					value = "<% $what %>"
				>

				<h4>Date range</h4>

				<& /funclib/datepicker.mas, id => "start" &>

				<div class="full smallish evenrow">
					<span class="quarter padno">
						From
					</span>
					<span class="threequarter padno">

						<input
							type  = "text"
							name  = "startdate"
							id    = "start"
							size  = "7"
							value = "<% Tab::pickerdate($startdt) %>"
						>@<&
							"/funclib/timepicker.mas",
							size => "6",
							name => "starttime",
							time => $startdt
						&>
					</span>
				</div>


				<& /funclib/datepicker.mas, id => "end" &>

				<div class="full smallish evenrow">
					<span class="quarter padno">
						To
					</span>
					<span class="threequarter padno">
						<input
							type  = "text"
							name  = "enddate"
							id    = "end"
							size  = "7"
							value = "<% Tab::pickerdate($enddt) %>"
						>@<&
							"/funclib/timepicker.mas",
								size => "6",
								name => "endtime",
								time => $enddt
						&>
					</span>
				</div>

				<div class="full rightalign liblrow">
					<input
						type  = "submit"
						class = "thin"
						value = "Go"
					>
					</form>
				</div>

			</div>

%		}

	</div>

	<br style="clear: both;">
