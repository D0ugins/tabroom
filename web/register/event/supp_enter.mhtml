<%args>
	$tourn
	$tourn_settings
	$event_id
	$student_id
	$only_category => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);

	$m->abort unless $event;

	$m->abort if $only_category && $only_category->id != $event->category->id;

	my $student = Tab::Student->retrieve($student_id);

	my @alreadies = $m->comp(
		"/funclib/student_entries.mas", 
			tourn   => $tourn,
			student => $student 
	);

	my $set_code;
	my $school_id;

	foreach my $already (@alreadies) { 

		$school_id = $already->school->id unless $school_id;

		if ($already->code == int($already->code)) { 
			$set_code = $already->code;
		}

		if ($set_code) { 

			if ($already->setting("max_entry") > 1) { 

				my $letter = "A";

				foreach my $al_student ($already->students) { 

					$set_code = $set_code.$letter 
						if $al_student->id == $student->id;

					$letter++;
				}

			}

		}

	}

	$m->redirect("/register/school/entry_save.mhtml?1=".$student->id."&from=roster&code=$set_code&event_id=$event_id&school_id=".$school_id);


</%init>
