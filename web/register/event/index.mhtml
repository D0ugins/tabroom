<%args>
	$tourn
	$perms
	$tourn_settings
	$only_category => undef
</%args>
<%init>

	my $switch;

	my @events;
	my @supps;
	my @conns;
	my @stefans;

	if ($tourn_settings->{"nsda_nats"}) {

		@events = $m->comp(
			"/funclib/nationals_events.mas",
			tourn  => $tourn,
			status => "all",
			type   => "mains"
		);

		@supps = $m->comp(
			"/funclib/nationals_events.mas",
			tourn  => $tourn,
			status => "all",
			type   => "supp"
		);

		@stefans = $m->comp(
			"/funclib/nationals_events.mas",
			tourn  => $tourn,
			status => "all",
			type   => "stefan"
		);

		@conns = $m->comp(
			"/funclib/nationals_events.mas",
			tourn  => $tourn,
			status => "all",
			type   => "conn"
		);

	} else {

		if ($only_category) {
			@events = $only_category->events;
		} else {
			@events = $tourn->events;
		}

	}

	if ($perms->{'details'}) {

		@events = $m->comp( "/funclib/event_perms.mas",
			perms  => $perms,
			type   => "admin",
			events => \@events
		);

		@supps = $m->comp( "/funclib/event_perms.mas",
			perms => $perms,
			type  => "admin",
			supps => \@supps
		);


		@conns = $m->comp( "/funclib/event_perms.mas",
			perms => $perms,
			type  => "admin",
			conns => \@conns
		);
	}

	if (scalar @events == 1) {

		$m->redirect("nsda_roster.mhtml?event_id=".$events[0]->id)
			if $tourn_settings->{"nsda_nats"};
		$m->redirect("roster.mhtml?event_id=".$events[0]->id);
	}

	my $at_larges;

	foreach my $event (@events) {
		$at_larges++ if $event->setting("at_larges");
	}

	my %totals;

</%init>

	<& "menu.mas",
		only_category  => $only_category,
		tourn_settings => $tourn_settings,
		tourn          => $tourn,
		perms          => $perms
	&>

	<& "/funclib/tablesorter.mas",
		table => "entries"
	&>

	<div class="main">

		<span class="half nospace">
			<h2>Events / Divisions</h2>
		</span>

		<span
			id    = "entries_buttonarea"
			class = "half rightalign nospace"
		>
		</span>

		<table id="entries">

			<thead>

			<tr class="yellowrow">

				<th class="smaller">
					Event
				</th>

				<th class="smaller">
					Abbr
				</th>

%				if ($tourn_settings->{"nsda_nats"}) {

					<th class="smaller">
						Accepted
					</th>

					<th class="smaller">
						Pending
					</th>

					<th class="smaller">
						Rejected
					</th>

					<th class="smaller">
						Dropped/Inactive
					</th>

%				} else {

					<th class="smaller">
						Active
					</th>

					<th class="smaller">
						Drops
					</th>

					<th class="smaller">
						Waitlist
					</th>

%				}

%				if ($at_larges) {
					<th class="smaller">
						At Large
					</th>
%				}

				<th class="smaller">
					Total
				</th>

			</tr>
			</thead>
			<tbody>

<%perl>
			if ($tourn_settings->{"nsda_nats"}) {
				#This is super slow.  Fix it.
				my $dbh = Tab::DBI->db_Main();
			}

			foreach my $event (@events, @supps, @stefans, @conns) {

				next unless $event > 0 && $event->id;

				my $at_large++ if $event->setting("at_larges");
				my $normal++ if $event->setting("usa_wsdc") || $event->setting("stefan");

				my %entries;

				if ($tourn_settings->{"nsda_nats"} && (not defined $normal)) {

					@{$entries{'all'}} = Tab::Entry->search(
						event => $event->id
					);

					@{$entries{'active'}} = Tab::Entry->search(
						event  => $event->id,
						active => 1
					);

					@{$entries{'dropped'}} = Tab::Entry->search(
						event   => $event->id,
						dropped => 1
					);

					Tab::Entry->set_sql( rejected => "
						select entry.*
						from entry, entry_setting
						where entry.event = ?
						and entry.id = entry_setting.entry
						and entry_setting.tag = 'rejected_by'
					");

					@{$entries{'rejected'}} = Tab::Entry->search_rejected($event->id);

					Tab::Entry->set_sql( pending => "
						select entry.*
						from entry
						where entry.event = ?
						and entry.unconfirmed = 1
						and not exists (
							select entry_setting.id
							from entry_setting
							where entry.id = entry_setting.entry
							and entry_setting.tag = 'rejected_by'
						)
					");

					@{$entries{'pending'}} = Tab::Entry->search_pending($event->id);

				} else {

					@{$entries{'all'}} = Tab::Entry->search(
						event       => $event->id,
						unconfirmed => 0
					);

					@{$entries{"active"}} = Tab::Entry->search(
						event => $event->id,
						active => 1
					);

					@{$entries{"dropped"}} = Tab::Entry->search(
						event       => $event->id,
						unconfirmed => 0,
						dropped     => 1
					);

					@{$entries{"waitlist"}} = Tab::Entry->search(
						event       => $event->id,
						unconfirmed => 0,
						waitlist    => 1,
						dropped     => 0
					);

				}

				if ($at_large) {

					my @at_large_settings = $m->comp(
						"/funclib/event_entry_settings.mas",
							event => $event,
							tag   => "atlarge"
					);

					my %atl = map { $_->entry->id => 1} @at_large_settings;
					@{$entries{"at_large"}} = keys %atl;
				}

				foreach my $key (%entries) {
					next unless $entries{$key};
					$totals{$key} += scalar @{$entries{$key}};
				}

</%perl>
				<tr>

					<td class="nospace">
						<a class="white padleft padtop padbottom"
							href="<% $tourn_settings->{"nsda_nats"} && (not defined $normal) ? "nsda_" : ""
							%>roster.mhtml?event_id=<% $event->id %>">
							<% $event->name %>
						</a>
					</td>
					<td class="nospace centeralign smallish">
						<% $event->abbr %>
					</td>

%					if ($tourn_settings->{"nsda_nats"}) {

						<th class="smallish rightalign">
							<% scalar @{$entries{"active"}} %>
						</th>

						<th class="smallish rightalign">
							<% scalar @{$entries{"pending"}} %>
						</th>

						<th class="smallish rightalign">
							<% scalar @{$entries{"rejected"}} %>
						</th>

						<th class="smallish rightalign">
							<% scalar @{$entries{"dropped"}} %>
						</th>

%					} else {

						<td class="smallish rightalign">
							<% scalar @{$entries{"active"}} %>
						</td>

						<td class="smallish rightalign">
							<% scalar @{$entries{"dropped"}} %>
						</td>

						<td class="rightalign">

%							if ($event->setting("waitlist") || $event->setting("waitlist_all")) {
								<a
									class="white"
									href="roster.mhtml?waitlist=1&event_id=<% $event->id %>"
								>
									<% scalar @{$entries{"waitlist"}} %>
								</a>
%							}
						</td>

%						if ($at_larges) {
							<td class="smallish rightalign">
								<% scalar @{$entries{"at_large"}} %>
							</td>
%						}

%					}

					<td class="smallish rightalign">
						<% scalar @{$entries{"all"}} %>
					</td>

				</tr>

%			}

			</tbody>

			<tr class="ltyellow">

				<th>
					<span class="full padless">
						Total
					</span>
				</th>

				<th>
				</th>

%				if ($tourn_settings->{"nsda_nats"}) {

					<th class="rightalign">
						<% $totals{"active"} %>
					</th>

					<th class="rightalign">
						<% $totals{"pending"} %>
					</th>

					<th class="rightalign">
						<% $totals{"rejected"} %>
					</th>

					<th class="rightalign">
						<% $totals{"dropped"} %>
					</th>

%				} else {

					<th class="rightalign">
						<% $totals{"active"} %>
					</th>

					<th class="rightalign">
						<% $totals{"dropped"} %>
					</th>

					<th class="rightalign">
						<% $totals{"waitlist"} %>
					</th>

%				}

%				if ($at_larges) {
					<th class="rightalign">
						<% $totals{"at_large"} %>
					</th>
%				}

				<th class="rightalign">
					<% $totals{"all"} %>
				</th>

			</tr>

		</table>

	</div>


