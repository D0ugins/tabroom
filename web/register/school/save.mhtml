<%args>
	$tourn
	$tourn_settings
	$name                  => undef
	$school_id             => undef
	$district_id           => undef
	$individuals           => undef
	$contact_number        => undef
	$contact_name          => undef
	$contact_email         => undef
	$second_contact_number => undef
	$second_contact_name   => undef
	$second_contact_email  => undef
	$code                  => undef
	$region_id             => undef
	$state                 => undef
	$country               => undef
</%args>
<%init>

	my $err;

	my $school = Tab::School->retrieve($school_id) if $school_id;
	$m->abort unless $school;

	unless ($name) {
		$m->print("Every school deserves a name!  Please hit back and try again");
		$m->abort;
	}

	if ($tourn_settings->{"per_person_fee"}) {

		my $bodies = $m->comp(
			"/funclib/school_bodies.mas",
			school => $school
		);

		if ($individuals < $bodies) {
			$err = "You have set the number of individuals below the number of people on record ($bodies).  Be sure this is what you want."
		}
	}

	$school->name($name);
	$school->region($region_id);
	$school->district($district_id);
	$school->code($code);
	$school->update;

	$school->setting("individuals", $individuals);
	$contact_number =~ s/[\D_]//g;
	$school->setting("contact_number", $contact_number);
	$school->setting("contact_name", $contact_name);
	$school->setting("contact_email", $contact_email);

	$second_contact_number =~ s/[\D_]//g;
	$school->setting("second_contact_number", $second_contact_number);
	$school->setting("second_contact_name", $second_contact_name);
	$school->setting("second_contact_email", $second_contact_email);

    # Middle School
    $school->setting("second_contact_number", $ARGS{"second_contact_number"});
    $school->setting("contact_hotel", $ARGS{"contact_hotel"});
    $school->setting("contact_hotel_rooms", $ARGS{"contact_hotel_rooms"});

    $school->setting("hotel", $ARGS{"hotel"});
    $school->setting("tbook_coaches", "text", $ARGS{"tbook_coaches"});

    if ($ARGS{"contact_hotel_checkout"}) {

        my $dt;
        my $tz = $tourn->tz;
        $tz = "UTC" unless $tz;

        my $time = "00:00:00";

        eval {
            $dt = Tab::dtme($ARGS{"contact_hotel_checkout"}, $time, $tz);
        };

        $school->setting("contact_hotel_checkout", "date", $dt) if $dt;
    }

	my $chapter = $school->chapter;

	if ($tourn_settings->{'nsda_district'}) {

		$school->setting("nsda_trophy_points", $ARGS{"nsda_trophy_points"});

	}

	if ($chapter > 0) {

		eval{
			$chapter->country($country);
			$chapter->state($state);
			$chapter->update;
		};

	} else {

		$school->setting("country", $country);
		$school->setting("state", $state);

	}

	my $msg = "School changes saved";
	$m->redirect("edit.mhtml?school_id=$school_id&err=$err&msg=$msg");

</%init>

