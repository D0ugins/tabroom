<%args> 
	$tourn
	$tourn_settings
	$person
	$school_id   => undef
	$category_id => undef
</%args>
<%init>

	unless ($school_id) { 
		$m->print("School was not sent.  Go back and try again");
		$m->abort();
	}

	my $school = Tab::School->retrieve($school_id);

	my $category = Tab::Category->retrieve($category_id);
	my %category_settings;

	$m->abort unless $school;

	my @categories; 

	if ($category) { 
		@categories = ($category);
	} else { 
		@categories = $tourn->categories;
	}

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

</%init>

	<& "/register/menubar.mas",
		school         => $school,
		whoami         => "judges",
		tourn_settings => $tourn_settings,
		tourn          => $tourn &>

%		foreach my $category (@categories) { 

<%perl>
	
			my @requests = Tab::JudgeHire->search( 
				school   => $school->id,
				category => $category->id
			);

			%category_settings = $category->all_settings();

			my $judge_per  = $category_settings{"judge_per"};
			my $rounds_per = $category_settings{"rounds_per"};
			my $exchange   = $category_settings{"exchange"};
			my $frees_no   = $category_settings{"free_strikes_dont_count"};

			my $obligation = $m->comp(
				"/funclib/judgemath/judges_needed_by_category.mas", 
				school            => $school,
				category_settings => \%category_settings,
				tourn_settings    => $tourn_settings,
				category          => $category
			);

			my ($unc, $over) = $m->comp(
				"/funclib/judgemath/uncovered_burden_by_category.mas", 
				school            => $school,
				category          => $category,
				category_settings => \%category_settings,
				tourn_settings    => $tourn_settings
			);

			my @registered_judges = $m->comp(
				"/funclib/judgemath/judges_by_category.mas", 
				school            => $school,
				category_settings => \%category_settings,
				category          => $category,
				tourn_settings    => $tourn_settings
			);

			next unless ($obligation > 0 || $unc > 0 || @registered_judges );

			my $total_rounds;
			my $hired_rounds;

</%perl>

			<div class="martopmore borderbottom">

				<span class="half">
					<h5><% $category->name %> Judges</h5>
				</span>

   				<span class="quarter bigger semibold centeralign">
					<% $obligation %> 
					<% $rounds_per 
						? " round" 
						: " judge" 
					%><%
						$obligation != 1 
						? "s" : "" 
					%> owed
				</span>

<%perl> 

				# The following Somewhat Hideous Code replaced Even More
				# Hideous Code in a previous iteration so I apologize somewhat
				# for it but not that much.   -- CLP

				my $message_string;
				my $message_class; 

				if ($judge_per) { 

					if ($unc) { 
						
						$message_class  = "redtext";

						if ($category_settings{"uncovered_entry_fee"} > 0) { 
							$message_string = $unc." entries uncovered"; 
							$message_string = $unc." entry uncovered" if $unc == 1;
						} else { 
							$message_string = ceil($unc / $judge_per)." judge";
							$message_string .= "s" if (ceil($unc / $judge_per) > 1);
							$message_string .= " under";
						}
				
					} elsif ($over && @requests) { 

						$message_class  = "orangetext";
						$message_string = "Over-hired by ";

						if ($category_settings{"uncovered_entry_fee"} > 0) { 
							$message_string .= $over." entries" if $over > 1;
							$message_string .= $over." entry" if $over == 1;
						} else { 
   				 			$message_string .= ceil ($over / $judge_per)." judge";
							$message_string .= "s" if (ceil($over / $judge_per) > 1);
						}

					} else { 
						$message_string = "OK";
						$message_class  = "greentext"
					}

				} elsif ($rounds_per) { 

					if ($over && @requests) { 
						$message_string = "Over-hired ".$over." round"; 
						$message_string .= "s" if $over == 1;
						$message_class  = "orangetext";
					} elsif ($unc) { 
						$message_class  = "redtext";
						$message_string = "Under ".$unc." round"; 
						$message_string .= "s" if $unc == 1;
					} else { 
						$message_string = "OK";
						$message_class  = "greentext"
					}
				}

</%perl>

   				<span class="quarter <% $message_class %> bigger semibold centeralign">
					<% $message_string %>
   				</span>

			</div>

%			if (@registered_judges) { 

			<table>

				<tr class="yellowrow">

					<% 	
						$tourn_settings->{"hide_codes"} || $category_settings{"no_codes"}
						? "" 
						: '<th class="smallish">Code</th>' 
					%>

					<th class="smallish">
						Name
					</th>

%					if ($rounds_per) { 
						<th class="smallish">
							Rounds
						</th>
%					}

%					if ($exchange) { 
						<th class="smallish">
							Hired
						</th>
%					}

%					if ($category->shifts) { 
						<th class="smallish">
							Availability 
						</th>
%					}

%					if ($category_settings{"coach_ratings"}) { 
						<th class="smallish">
							Ratings
						</th>
%					}

					<th class="smallish">
					</th>

				</tr>

%				if ($rounds_per) { 

					<form action="rounds_save.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "category_id"
						value = "<% $category->id %>"
					>

					<input 
						type  = "hidden"
						name  = "school_id"
						value = "<% $school->id %>"
					>
%				}

%               my $first_free = 1;

%				foreach my $judge (@registered_judges) { 

%                   if ($frees_no && $first_free && $judge->setting("free_strike")) {

%                   	undef $first_free;
					
						<tr class="liblrow">

							<% $tourn_settings->{"hide_codes"}|| $category_settings{"no_codes"} 
								? "" 
								: '<td></td>' 
							%>

							<th class="padmore leftalign smallish">
								Rounds Provided
							</td>

							<td class="leftalign">
								<span class="full padmore">
									<% $total_rounds %>
								</span>
							</td>

%							if ($exchange) { 
								<td class="centeralign">
									<span class="full padmore">
										<% $hired_rounds %>
									</span>
								</td>
%							}

							<td colspan="8">
							</td>

						</tr>

                        <tr class="oddrow">
                            <td colspan="8">
                                <h4>Non-credited judging</h4>
                            </td>
                        </tr>

%					}

					<tr class="lightrow">

						<% $tourn_settings->{"hide_codes"} || $category_settings{"no_codes"} 
							? "" 
							: "<td>".$judge->code."</td>" 
						%>

						<td>
							<a class="white full padvert marleft"
								href="/register/judge/edit.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
								<% $judge->first." ".$judge->last%>
							</a>

%							if ($judge->category->id != $category->id) { 		
								<div class="smallish">
									(Covering <% $category->abbr %> obligation, 
									but judging in <% $judge->category->abbr %>)
								</div>
%							}
						</td>

%						if ($rounds_per) { 
							<td class="leftalign">
								<input 
									type  = "number"
									name  = "<% $judge->id %>"
									size  = "5"
									min   = "0"
									max   = "<% $category_settings{"max_rounds"} %>"
									value = "<% $judge->obligation %>"
								>
%								$total_rounds += $judge->obligation;
							</td>
%						}

%						if ($exchange) { 
							<td class="centeralign">
								<% $judge->hired %>
%								$hired_rounds += $judge->hired;
							</td>
%						}

%						if ($category->shifts) { 

%							my $shifted;

							<td class="smallish leftalign">
								<a 
									class="white" 
									href="judge_shifts.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">

%									foreach my $shift ($category->shifts) { 
%										if ($shift->strike($judge)) { 
%											$shifted++;
											Partial Availability: <% $shift->name %> 
											<br />
%										}
%									}

%									unless ($shifted) { 
										All rounds
%									}
								
								</a>

							</td>
%						}

%						if ($category_settings{"coach_ratings"}) { 

							<td class="smallish centeralign">
								<% $m->comp("/funclib/judge_rating.mas", print => 1, judge => $judge )%>
							</td>

%						}

<%perl>

						my $warn = "This will delete the judge, together with any past results, ballots, or assignments. If you want to keep old records and just stop using this judge, mark the judge as inactive instead";

</%perl>
						<td class="centeralign smallish padless">
							<a 
								class = "padmore redtext button buttonwhite fa fa-lg fa-trash"
								title = "Delete Request"
								href  = "/register/judge/drop.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>"
								<& "/funclib/confirm.mas", warn => $warn &> 
							>
							</a>
						</td>

					</tr>

% 				} 

%				if ($first_free && $rounds_per) { 
					
					<tr class="bordertopthin">

						<% 
							$tourn_settings->{"hide_codes"} || $category_settings{"no_codes"} 
							? "" 
							: '<td></td>' 
						%>

						<th class="rightalign semibold redtext">
							Total Rounds: 
						</td>

						<td class="leftalign">
							<span class="white padmore">
								<% $total_rounds %>
							</span>
						</td>

%						if ($exchange) { 
							<td class="centeralign">
								<% $hired_rounds %>
							</td>
%						}

						<td colspan="8">
						</td>

					</tr>

%				}

%				if ($rounds_per) { 

					<tr class="liblrow">

						<td colspan="10" class="rightalign">

							<input 
								type  = "submit"
								class = "thinnish"
								value = "Save Round Obligations"
							>

							</form>
						</td>

					</tr>

%				}

			</table>

%			}

%			if ($category_settings{"track_judge_hires"} ) { 

				<br />

%				if ($category_settings{"uncovered_entry_fee"} > 0) { 

					<h5><% $category->abbr %> Hired Judging</h5>

%					foreach my $request (@requests) { 

% 	                  next if $request->judge;
		            	
						<div class="lightrow">

							<span class="quarter smallish">
%								if ($request->judge) {
									<a href="/register/judge/edit.mhtml?judge_id=<% $request->judge->id %>" class="white padno">
										<% $request->judge->first." ".$request->judge->last %>
									</a>
%								} else { 
									Request made <% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
%								}
							</span>
							
							<span class="quarter centeralign smallish">

								<span class="half">
									<% $request->entries_requested %> asked
								</span>

								<span class="half">
									<% $request->entries_accepted ? $request->entries_accepted : 0 %> accepted
								</span>
							</span>

%							my $warn = "This will accept this judging request and email the coaches of the program.  Are you sure?";
%							my $nowarn = "This will accept this judging request but will NOT notify the coaches.  Are you sure?";

							<span class="centeralign smallish half">
								<span class="quarter nospace">
									<a 
										class="padmore dkblue button buttonwhite fa fa-lg fa-check-o" 
										title="Accept Request"
										href="hire_accept.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &> 
										>
									</a>
								</span>
								<span class="quarter nospace">
									<a 
										class="padmore greentext button buttonwhite fa fa-lg fa-check" 
										title="Accept Request without Notification"
										href="hire_accept.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>&no_email=1"
										<& "/funclib/confirm.mas", warn => $nowarn &> 
									>
									</a>
								</span>
								<span class="quarter nospace">
%									$warn = "This will reduce your judging request by 1.  Are you sure?";
									<a 
										class="padmore orangetext button buttonwhite fa fa-lg fa-arrow-down"
										title="Reduce Request by 1"
										href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &> 
									>
									</a>

								</span>
								<span class="quarter nospace">
%										$warn = "This will delete your judging request entirely. Are you sure?";
									<a 
										class="padmore redtext button buttonwhite fa fa-lg fa-trash"
										title="Delete Request"
										href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &> 
									>
									</a>
								</span>
							</span>
							
						</div>

%					}

					<form action="hire_save.mhtml" method="post">
					<input type="hidden" name="school_id" value="<% $school->id %>">
					<input type="hidden" name="category_id" value="<% $category->id %>">

					<div class="even bordertop borderbottom martopmore">
							
						<span class="third">
							New Hire  Request:
						</span> 

						<span class="third centeralign">
							Cover
							<input type="text" name="hired_number" size="2" value="">
							entries
						</span>
						
						<span class="third centeralign">
							<input class="thin" type="submit" value="   Request Hires   ">
							</form>
						</span>
						
					</div>



					<p class="explain padleftmore">
						This tournament hires judging by the entry, not the whole
						judge.  Enter hire requests for the number of entries who
						you do not have judging for.  Please note that a hire
						request does not mean the tournament has judges available
						for hire; Tabroom will email you when/if your request
						is accepted.
					</p>

%				}

<%perl>

				if ($category_settings{"hired_fee"} > 0 && $judge_per) { 

					my $hires_requested;
					my $hires_accepted;

					foreach my $request (@requests) { 
						$hires_requested += $request->entries_requested;
						$hires_accepted += $request->entries_accepted;
					}

					$hires_requested = ceil($hires_requested / $judge_per) if $judge_per;

					$hires_accepted = ceil($hires_accepted / $judge_per) if $judge_per;

</%perl>
					<h6 class="marleftmore">
						<% $category->abbr %> Hired Judging
					</h6>

%					foreach my $request (@requests) { 
		            	
%						next if $request->judge;

						<div class="lightrow">

							<span class="third smaller">
%								if ($request->judge) {
									<a href="/register/judge/edit.mhtml?judge_id=<% $request->judge->id %>" class="white padno">
										<% $request->judge->first." ".$request->judge->last %>
									</a>
%								} else { 
									Request made <% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
%								}
							</span>

							<span class="third smaller">
								<span class="half">
									<% ceil($request->entries_requested / $judge_per ) %> requested
								</span>
								<span class="half centeralign">
									<% $request->entries_accepted ? ceil($request->entries_accepted / $judge_per) : 0 %> accepted
								</span>
							</span>

%							my $warn = "This will accept this judging request and email the coaches of the program.  Are you sure?";
%							my $nowarn = "This will accept this judging request but will NOT notify the coaches.  Are you sure?";

							<span class="third smaller rightalign">

								<span class="quarter">
									<a 
										class = "padmore bluetext button buttonwhite fa fa-lg fa-check"
										title = "Accept Request"
										href="hire_accept.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &> 
									>
									</a>
								</span>

								<span class="quarter nospace">
									<a 
										class="padmore greentext button buttonwhite fa fa-lg fa-check" 
										title="Accept Request without Notification"
										href="hire_accept.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>&no_email=1"
										<& "/funclib/confirm.mas", warn => $nowarn &> 
										>
									</a>
								</span>
								<span class="quarter">
%									$warn = "This will reduce your judging request by 1.  Are you sure?";
									<a 
										class="padmore orangetext button buttonwhite fa fa-lg fa-arrow-down"
										title="Reduce Request by 1"
										href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &>  
										>
									</a>
								</span>
								<span class="quarter">
%									$warn = "This will delete your judging request entirely. Are you sure?";
									<a 
										class="padmore redtext button buttonwhite fa fa-lg fa-trash"
										title="Delete Request"
										href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &>  
									>
									</a>
								</span>
							</span>
						</div>

%					}

					<form action="hire_save.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "school_id"
						value = "<% $school->id %>"
					>

					<input 
						type  = "hidden"
						name  = "category_id"
						value = "<% $category->id %>"
					>

	            	<div class="lightrow martop">

 						<span class="third">
							New Request:
						</span>
 						<span class="third">

							<input 
								type  = "number"
								min   = "0"
								max   = "99"
								name  = "hired_number"
								size  = "2"
								value = <% $hires_requested %>
							>

							hired judges

						</span>
 						<span class="third rightalign">
							<input 
								type  = "submit"
								class = "thinnish"
								value = "Request"
							>
							</form>
						</span>

					</div>

%				}

<%perl>

				if ($category_settings{"round_hire_fee"} > 0 && $rounds_per) { 

					my @requests = Tab::JudgeHire->search( 
						school => $school->id, 
						category => $category->id 
					);

					my $hires_requested;
					my $hires_accepted;

					foreach my $request (@requests) { 
	    	   			$hires_requested += $request->rounds_requested;
   		    			$hires_accepted += $request->rounds_accepted;
						$total_rounds += $request->rounds_accepted;
					}
	
</%perl>
					<h5>Hired judging</h5>

					<table>

%					foreach my $request (@requests) { 

% 	   	     			next if $request->judge;

						<tr class="lightrow">

							<td class="smallish">

%								if ($request->judge) {

									<a 
										href="/register/judge/edit.mhtml?judge_id=<% $request->judge->id %>" 
										class="white padno"
									>
										<% $request->judge->first." ".$request->judge->last %>
									</a>
%								} else { 
									Request made <% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
%								}
							</td>
							
							<td class="centeralign smallish">
								<% $request->rounds_requested %> rounds asked
							</td>

							<td class="centeralign smallish">
								<% $request->rounds_accepted %> rounds accepted
							</td>

<%perl>

							my $warn = "This will accept this judging request
							and email the coaches of the program.  Are you
							sure?";

							my $nowarn = "This will accept this judging request
							but will NOT notify the coaches.  Are you sure?";

</%perl>
							<td class="centeralign smallish">

%								unless ($request->rounds_requested <= $request->rounds_accepted) {
									<a 
										class = "padmore bluetext button buttonwhite fa fa-lg fa-check"
										title = "Accept Request"
										href="hire_accept.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &> 
									>
										
									</a>
%								}
							</td>

							<td class="centeralign smallish">
%								unless ($request->rounds_requested <= $request->rounds_accepted) {
									<a 
										class="padmore greentext button buttonwhite fa fa-lg fa-check" 
										title="Accept Request without Notification"
										href="hire_accept.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>&no_email=1"
										<& "/funclib/confirm.mas", warn => $nowarn &> 
									>
									</a>
%								}
							</td>

%							$warn = "This will reduce your judging request by 1 round.  Are you sure?";

							<td class="centeralign smallish">
								<a 
									class="padmore orangetext button buttonwhite fa fa-lg fa-arrow-down"
									title="Reduce Request by 1"
									href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
									<& "/funclib/confirm.mas", warn => $warn &>  
								>
								</a>
							</td>

%							$warn = "This will delete your judging request entirely. Are you sure?";

							<td class="centeralign smallish">
								<a 
									class="padmore redtext button buttonwhite fa fa-lg fa-trash"
									title="Delete Request"
									href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
									<& "/funclib/confirm.mas", warn => $warn &>  
								>
								</a>
							</td>
						
						</tr>

%					}


						<tr>
							<td colspan="10">
							</td>
						</tr>

		            	<tr class="even bordertop borderbottom">

 							<td>
                			    <form action="hire_save.mhtml" method="post">

            		    	    <input 
									type  = "hidden"
									name  = "school_id"
									value = "<% $school->id %>"
								>

        		        	    <input 
									type  = "hidden"
									name  = "category_id"
									value = "<% $category->id %>">

    		            	    New Request:
            			    </td>

                			<td class="centeralign" colspan="2">
                			    <input 
									type  = "number"
									name  = "rounds"
									size  = "4"
									min   = "0"
									max   = "999"
									value = ""
								> rounds
							</td>

                			<td  colspan="4" class="centeralign">
                    			<input  
									type  = "submit"
									value = "Request"
									class = "thinnish"
								>
                			    </form>
            			    </td>

    		        	</tr>

					</table>

%				}

%			}

%           if ($category_settings{"exchange"}) { 

				<div class="full nospace martopmore lightrow">

					<span class="twofifths nospace padleft">
						<h5><% $category->abbr %> Hired Judge Exchange</h5>
					</span>

					<span class="threefifths rightalign nospace">

%  	            		my @judges = $m->comp("/funclib/exchange_judges.mas", category => $category);

%						if (@judges) {  

							<span class="threefifths rightalign">

								<% scalar @judges %> judge<% scalar @judges > 1 ? "s are" : " is" %> 
									offering hired rounds

							</span>

							<span class="twofifths rightalign">

								<a 
									class="buttonwhite bluetext" 
									href="hire_exchange.mhtml?school_id=<% $school->id %>&category_id=<% $category->id %>">
									Add Hires
								</a>

							</span>

%						} else { 

							No approved judges have hired rounds on offer.

%						}


					</span>

				</div>

%               foreach my $request (@requests) {

%                   next unless $request->judge;

                    <div class="lightrow full nospace">

                        <span class="threequarter padless">
                            Hired <% $request->judge->first." ".$request->judge->last %> 
							for <% $request->rounds_requested %> rounds
                        </span>

                        <span class="quarter centeralign padless">
							<a 
								class = "redtext buttonwhite fa fa-lg fa-trash" 
								href  = "hire_cancel.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>&back=roster">
							</a>
                        </span>
                    </div>

%               }

%           }

%		}


	</div>

	<& "judge_menu.mas", 
		tourn             => $tourn,
		school            => $school,
		whoami            => "judges",
		category          => $category,
		category_settings => \%category_settings,
	&>

