<%args>
	$person
	$tourn
	$tourn_settings
	$school_id => undef
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id) if $school_id;

	unless ($school) {
		$m->redirect("/register/index.mhtml");
	}

	my $symbol = $tourn_settings->{'currency'};

	my %school_settings = $school->all_settings;

	my $chapter = $school->chapter;

	my $district = $school->district;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @empties = $m->comp(
		"/funclib/school_empty_entries.mas", 
			school => $school
	);

    my $nsda_district = $tourn_settings->{"nsda_district"};

	my $now = DateTime->now();

    my %reasons;

    %reasons = $m->comp(
        "/funclib/judgemath/nats_check_judging.mas", 
        school => $school
    ) if $tourn_settings->{"nsda_nats"};



</%init>

	<& 
		"/register/menubar.mas", 
		school         => $school,
		whoami         => "tourn",
		tourn          => $tourn,
		reasons        => \%reasons,
		tourn_settings => $tourn_settings
	&>

%		if (@empties) { 

			<div class="full bluetext warnbox centeralign">

				<h5 class="redtext">
					Something has gone horribly, horribly wrong!
				</h5>

				<h6 class='normal'>
					There are no competitors assigned to entries: 
				</h6>

				<br />

%					foreach my $empty (@empties) { 
						<div class="twofifth semibold centeralign">
							<a 
								href="/register/entry/edit.mhtml?entry_id=<% $empty->id %>"
								class="dkred full"
							>
								<% $empty->code %> in
								<% $empty->event->abbr %>
							</a>
						</div>
						<br />
%					}

				Please assign competitors to these entries or they will not
				advance or receive points.

			</div>

%		}

		<table> 

			<tr class="row">

				<th>
					<form action="save.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "school_id"
						value = "<% $school->id %>"
					>
					School Name:
				</th>

				<td class="leftalign">
					<input 
						type  = "text"
						name  = "name"
						size  = "32"
						value = "<% $school->name %>"
					>
				</td>

			</tr>

%			if ($tourn_settings->{"school_codes"}) { 

				<tr class="row"> 

					<th>
						School Code:
					</th>
		
					<td class="leftalign">
						<input 
							type  = "text"
							name  = "code"
							size  = "6"
							value = "<% $school->code %>"
						>
					</td>

				</tr>
%			}

%			if ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"} ) { 

				<tr class="row"> 

					<th>
						<% $tourn_settings->{"regions"} ? "Region" : "Diocese" %>:
					</th>

					<td>

						<select 
							name  = "region_id"
							class = "fixedmed"
						>

							<option value=""></option>

%							foreach my $region ($m->comp("/funclib/tourn_regions.mas", tourn => $tourn)) {

%								my $existing = $school->region->id if $school->region;

								<option 
									value="<% $region->id %>" 
									<% $region->id == $existing ? "selected" : ""  %>
								> <% $region->name %> (<% $region->code %>) </option>
%							}

						</select>
					</td>
			
				</tr>
%			}

				<tr class="row"> 

					<th>
						Contact Name
					</td>

					<td >
						<input 
							type  = "text"
							name  = "contact_name"
							size  = "32"
							value = "<% $school_settings{"contact_name"} %>">
					</td>

				</tr>

				<tr class="row"> 

					<th>
						Contact Email:
					</td>	

					<td >
						<input 
							type  = "email"
							name  = "contact_email"
							size  = "32"
							value = "<% $school_settings{"contact_email"} %>">
					</td> 
			
				</tr>

				<tr class="row"> 

					<th>
						Contact Phone:
					</td>	

					<td >
						<input 
							type  = "tel"
							name  = "contact_number"
							size  = "32"
							value = "<% $school_settings{"contact_number"} %>">
					</td> 
			
				</tr>

%				if ($tourn_settings->{"nsda_ms_nats"}) { 

					<tr class="row"> 

						<th>
							2nd Contact Phone:
						</td>	

						<td >
							<input 
								type  = "tel"
								name  = "second_contact_number"
								size  = "32"
								value = "<% $school_settings{"second_contact_number"} %>">
						</td> 
				
					</tr>
%				}
%				if ($tourn_settings->{"nsda_ms_nats"}
%					|| $tourn_settings->{"nsda_nats"}) { 
					<tr class="row"> 

						<th>
							Hotel
						</td>	

						<td>
							<select name="hotel" class="fixedbig">

							<option value=""></option>

%                   		foreach my $hotel (sort {$a->name cmp $b->name} $tourn->hotels) { 

								<option value="<% $hotel->id %>" 
									<% $hotel->id == $school_settings{"hotel"}
										? 'selected="selected"' 
										: ""  
									%>
								><% $hotel->name %> <%  
										$hotel->multiple > 1 
										? "(Entry fee surcharge of ".$hotel->multiple."X applies)" 
										: ""  
								%> <%  
										$hotel->surcharge > 0
										? "(Per-competitor surcharge of \$".$hotel->surcharge." applies)" 
										: ""  
								%></option>
%                   		}

							</select>

						</td> 
				
					</tr>

%				}

%				if ($tourn_settings->{"nsda_ms_nats"}) { 
					<tr class="row"> 

						<th>
							Hotel Rooms
						</td>	

						<td >
							<input 
								type  = "number"
								name  = "contact_hotel_rooms"
								size  = "32"
								value = "<% $school_settings{"contact_hotel_rooms"} %>">
						</td> 
				
					</tr>

					<& "/funclib/datepicker.mas", 
						id  => "hotel_checkout",
						min => $tourn->start
					&>

					<tr class="row"> 

						<th>
							Hotel checkout date
						</th>
			
						<td>
							<input 
								id    = "hotel_checkout"
								size  = "16"
								type  = "text"
								name  = "contact_hotel_checkout"
								value = "<%
									$school_settings{"contact_hotel_checkout"} ? 
									Tab::pickerdate($school_settings{"contact_hotel_checkout"}) :
									Tab::pickerdate($tourn->end->add(days => 1)) 
								%>"
							>
						</td>

					</tr>

%				}

%				if ($tourn_settings->{"ncfl"} || $tourn_settings->{"nsda_ms_nats"} ) { 

					<tr class="row"> 

						<th>
							Coach credits
						</td>	

						<td >
							<input 
								type  = "text"
								name  = "coaches"
								size  = "64"
								value = "<% $chapter->setting("coaches") %>">
						</td> 
				
					</tr>
%				}

%				if ($tourn_settings->{"nsda_nats"} )  { 

					<tr class="row"> 

						<th>
							District
						</th>
				
						<td>
							<span class="half nospace">
								<select 
									name  = "district_id"
									class = "fixedmed"
								>
									<& "/funclib/district_select.mas", 
										district => $district 
									&>

								</select>
							</span>

%							my $state = $school_settings{"state"};
%							$state = $chapter->state if $chapter && $chapter->state;

							<span class="half nospace">
								<select 
									name="state" 
									class="fixedmed"
								>
									<& "/funclib/state_select.mas",
										state => $state
									&>
								</select>
							</span>

						</td>

					</tr>

%				} elsif ($chapter) { 

					<tr class="row"> 

						<th>
							School Location:
						</th>
				
						<td>
							<span class="half nospace">
								<select 
									name  = "country"
									class = "fixedmed"
								>
									<& "/funclib/country_select.mas",
										country => $chapter->country 
									&>
								</select>
							</span>

							<span class="half nospace">
								<select 
									name="state" 
									class="fixedmed"
								>
									<& 
										"/funclib/state_select.mas", 
										state => $chapter->state 
									&>
								</select>
							</span>
						</td>
					</tr>

%				}

%				if ($tourn_settings->{"per_person_fee"} ) { 

					<tr class="row"> 

						<th>
							Individuals
						</td> 
			
						<td class="padmuchmore">
							<input 
								type  = "number"
								name  = "individuals"
								min   = 0
								max   = 9999999
								value = "<% $school_settings{"individuals"} %>"
								size  = 7
							>
						</td> 

					</tr>

%				}

				<tr class="liblrow">

					<td colspan="2" class="rightalign padless">

						<input 
							type  = "submit"
							value = "Save School Info"
							name  = "register"
						>
						</form>
					</td>

				</tr>

			</table>

			<h4 class="martopmore">
				Money information
			</h4>

<%perl>

 			my ($fee, $feline_ref, $total_ref) 
				= $m->comp("/funclib/school_fees.mas", 
					school         => $school,
					tourn          => $tourn,
					tourn_settings => $tourn_settings,
					entry_fees     => 1
				);

</%perl>
				<div class="row"> 

					<span class="third semibold padmuchmore">
						Charges and Fees
					</span> 
			
					<span class="third rightalign mono <% $fee < 0 ? "ltredtext" : "" %>">
						<% $fee < 0 ? "&ndash;" : ""%><% $symbol %><%  sprintf ("%.2f", abs($fee)) %>
					</span> 

				</div>

<%perl>
				my ($concession_total, $conline_ref) = $m->comp(
					"/funclib/school_fees.mas", 
					concessions    => 1,
					school         => $school,
					tourn          => $tourn,
					tourn_settings => $tourn_settings,
				);

</%perl>

%				if ($tourn->concessions && $concession_total) { 

					<div class="row"> 

						<span class="third semibold padmuchmore">
							<% 
								$tourn_settings->{"concession_name"} 
								? $tourn_settings->{"concession_name"} 
								: "Concession" 
							%> Fees:
						</span> 
				
						<span class="third rightalign mono <% $concession_total < 0 ? "ltredtext" : "" %>">
							<% 
								$concession_total < 0 ? "&ndash;" : ""
							%><%
								$symbol 
							%><%  
								sprintf ("%.2f", abs($concession_total)) 
							%>
						</span> 

					</div>

%					$fee += $concession_total;

%				}

<%perl>

 				my ($payments, $payments_ref) = $m->comp(
					"/funclib/school_fees.mas", 
						school         => $school,
						tourn          => $tourn,
						tourn_settings => $tourn_settings,
						payments => 1
					);

</%perl>
				<div class="row"> 
			
					<span class="third semibold padmuchmore">
						Payments
					</span>
			
					<span class="third rightalign mono <% $payments < 0 ? "ltredtext" : "" %>">
						<% $symbol %><%  sprintf ("%.2f", abs($payments)) %>
					</span> 
			
				</div>

				<div class="row"> 
			
					<span class="third semibold padmuchmore">
						Outstanding Balance
					</span>

					<span class="third rightalign mono <% $fee + $payments < 0 ? "redtext" : "" %>">
						<% 
							$fee + $payments < 0 ? "&ndash;" : ""
						%><%
							$symbol
						%><%
							sprintf ("%.2f", abs($fee + $payments)) 
						%>
					</span> 
			
				</div>

				<form 
					action = "payment_save.mhtml"
					method = "post"
				>

				<input 
					type  = "hidden"
					name  = "from"
					value = "main"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<div class="row"> 
			
					<span class="fifth semibold padmuchmore">
						Record Payment
					</span>

					<span class="twothirds nospace">

						<span class="half">
							<input 
								type        = "text"
								size        = "32"
								name        = "reason"
								placeholder = "Payment notes, check #, etc"
							>
						</span>

						<span class="quarter centeralign nospace">
							<input 
								type        = "number"
								size        = "8"
								min         = "0"
								max         = "9999"
								step        = ".01"
								name        = "amount"
								placeholder = "Amount"
							>
						</span>

						<span class="fifth nospace rightalign">
							<input 
								type  = "submit"
								value = "Record"
								class = "thin"
							>
							</form>
						</span>

					</span>
				</div>

			</table>

%			if ($tourn_settings->{"refund_information"}) { 

				<h6 class="martopmore">
					Refund information
				</h6>

				<form 
					action = "refund_save.mhtml"
					method = "post"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<div class="row">

					<span class="half">
						Make refund checks payable to:
					</span>

					<span class="half">
						<input 
							type  = "text"
							name  = "refund_payable"
							size  = "34"
							value = "<% $school_settings{'refund_payable'} %>"
						>
					</span>

				</div>

				<div class="row">

					<span class="half">
						Address to send refund checks
					</span>

					<span class="half">
						<textarea 
							name="refund_address" 
							cols="32" 
							rows="3"
						><% $school_settings{"refund_address"} %></textarea>
					</span>

				</div>

				<div class="liblrow rightalign">
					<input type="submit" value="Save Refund Info">
					</form>
				</div>


%			}


			<h4 class="martopmore">
				Other Data
			</h4>


%			if ($person->site_admin && $chapter) { 

				<div class="row padmuchmore"> 

					<span class="third">
						Chapter:
					</span>
			
					<span class="third">
						<% $chapter->id %>
					</span>

					<span class="third">
						<% $chapter->name %>
					</span>


				</div>

%				if ($chapter->nsda) { 

					<div class="row padmuchmore"> 

						<span class="third">
							NSDA ID:
						</span>
				
						<span class="third">
							<% $chapter->nsda %>
						</span>

						<span class="third">
							<% $chapter->setting("nsda_degrees") %>
						</span>

					</div>
%				}
%			}

%			if ($school_settings{"entered_on"}) { 

				<div class="row padmuchmore"> 

					<span class="third">
						First Entered Online
					</span>
			
					<span class="twothird">
						<% Tab::nicedt($school_settings{"entered_on"}->set_time_zone($tz)) %>
					</span>

				</div>
%			}

<%perl>

			if ($tourn_settings->{"disclaimer"} && $school_settings{"disclaimed"}) { 

				my $disclaimed = Tab::Person->retrieve($school_settings{"disclaimed"});

				my $disclaimed_at = $school_settings{'disclaimed_at'};

				if ($disclaimed && $disclaimed_at) { 

				$disclaimed_at->set_time_zone($tz);

</%perl>

				<div class="row padmuchmore"> 

					<span class="third">
						Disclaimer Agreed:
					</span>
			
					<span class="third smallish">
						<% $disclaimed->first %>
						<% $disclaimed->last %>
						(<% $disclaimed->email %>)
					</span>

					<span class="third smallish">
						on <% Tab::nicedt($disclaimed_at) %>
					</span>

				</div>
<%perl>

				}

			}

			my $contact_id = $school_settings{"contact"};

			my $contact = Tab::Person->retrieve($contact_id) if $contact_id;

			if ($contact) { 

</%perl>
				<div class="row padmuchmore"> 

					<span class="third">
						Entered Online by
					</span>
			
					<span class="third">
						<% $contact->first." ".$contact->last %>
					</span>

					<span class="third nospace">
						<a 
							class="white marno" 
							href="mailto:<% $contact->email %>"
						><% $contact->email %></a>
					</span>

				</div>

%			}

%			my $registered_on = $school_settings{'registered_on'};

%			if ($registered_on) { 

				<div class="row padmuchmore"> 

					<span class="third">
						Registered Onsite
					</span>
			
					<span class="twothird">
						<% $registered_on->set_time_zone($tz) %>
					</span>

				</div>
%			}

%			my $registered_by_id = $school_settings{"registered_by"};
%			my $registered_by = Tab::Person->retrieve($registered_by_id) if $registered_by_id;

%			if ($registered_by) { 

				<div class="row padmuchmore"> 

					<span class="third">
						Registered By
					</span>

					<span class="twothird">
						<% $registered_by->first." ".$registered_by->last %> (<% $registered_by->email %>)
					</span>

				</div>

%			}

%			my @admins = $m->comp("/funclib/chapter_admins.mas", chapter => $chapter);

% 			if (@admins) { 

				<h4 class="martopmore">
					Accounts w/Access
				</h4>

% 				foreach my $coach (@admins) { 

%					next if $coach->prefs eq "prefs";

					<div class="row nowrap">

						<span class="third padtop padbottom">
							<% $coach->first." ".$coach->last %>
						</span>

						<span class="third nospace">
							<a 
								class="white" 
								href="mailto:<% $coach->email %>"
							><% $coach->email %></a>
						</span>

						<span class="third">
							<% $coach->phone %>
						</span>

					</div>
% 				} 

% 			} elsif ($chapter) { 

				<h4 class="martop">Grant administrator access</h4>

				<p class="explain padless">
					This team/school has no coach or administrator linked.
					Enter a tabroom.com account holder's email address to grant
					them access.  You cannot revoke access once granted.
				</p>


				<form action="chapter_access.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "chapter_id"
					value = "<% $chapter->id %>"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<div class="row full">

					<span class="twothirds">
						<input 
							type        = "text"
							name        = "email"
							size        = "50"
							value       = ""
							placeholder = "Tabroom.com account email..."
						>
					</span>

					<span class="third">

						<input 
							type  = "submit"
							class = "thin"
							value = "Grant Access"
						>

						</form>

					</span>

				</div>

%			}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Status</h4>

				<label for="<% $school->id %>_onsite">

					<div class="full lighteven nospace">

						<span class="twothirds semibold centeralign">
							Confirmed Onsite?
						</span>

						<span class="third centeralign">

							<span class="hidden"><% $school->onsite %></span>

							<label class="switch">
								<input 
									type          = "checkbox"
									value         = "1"
									id            = "<% $school->id %>_onsite"
									property_name = "onsite"
									target_type   = "school"
									target_id     = "<% $school->id %>" 
									onChange      = "postSwitch( this, 'school_switch.mhtml');"

									<% $school->onsite ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>

							</label>

						</span>

					</div>
				</label>

%				unless ($school->onsite) { 

%					my @waitlist = $school->entries( unconfirmed => 0, waitlist => 1);

%					if (@waitlist) { 

%						my $warn = "This will remove all ".scalar @waitlist." waitlisted entries from all events for this school and notify the school contacts.  Are you sure?";

						<a 
							class="yellow full martop" 
							href="waitlist_remove.mhtml?school_id=<% $school->id %>"
							<& "/funclib/confirm.mas", warn => $warn &> 
						>
							Admit all <% scalar @waitlist %> waitlisted entries
						</a>


						<form action="waitlist_remove.mhtml" method="post">

							<input
								type="hidden"
								name="school_id"
								value="<% $school->id %>"
							>

							<p class="martopmore padless semibold">
								Admit limited numbers off waitlist:
							</p>

							<div class="row">
								<span class="half padless marno">
									Number per event
								</span>
								<span class="quarter">
									<input
										type  = "number"
										class = "smaller"
										name  = "per_event_limit"
										min   = "0"
										max   = "99"
									>
								</span>
								<span class="quarter">
									<input
										type  = "submit"
										value = "Go"
									>
								</span>
							</div>

						</form>


%					}

%				}

%				if ($school->region) { 
					<br />
					<a 
						class="blue full" 
						href="/register/region/tourn.mhtml?region_id=<% $school->region->id%>"
					>
						Return to <% $school->region->name %>
					</a>
%				}


		</div>

		<div class="sidenote">

			<h4>Printouts</h4>

			<a 
				class  = "blue full marbottom"
				method = "post"
				href   = "invoice_and_reg_print.mhtml?school_id=<% $school->id %>"
			>
				Registration + Invoice
			</a>

			<a 
				class  = "blue full"
				method = "post"
				href   = "invoice_print.mhtml?school_id=<% $school->id %>"
			>
				Invoice
			</a>

			<a 
				class  = "blue full"
				method = "post"
				href   = "reg_print.mhtml?school_id=<% $school->id %>"
			>
				Registration
			</a>

			<a 
				class="blue full" 
				method="post"
				href="assignments_print.mhtml?school_id=<% $school->id %>" 
			>
				Assignments
			</a>

			<a 
				class="blue full" 
				method="post"
				href="dance_cards.mhtml?school_id=<% $school->id %>" 
			>
				Student Cards
			</a>

<%perl>
			if ($tourn_settings->{'nsda_district'}) { 

				my @weekends = sort 
					{$b->start->epoch <=> $a->start->epoch} 
					Tab::Weekend->search_where(
						tourn => $tourn,
						reg_start => {'<', $now},
					);

				if (scalar @weekends > 1) { 

					foreach my $weekend (@weekends) { 
</%perl>
						<h6 class="semibold"><% $weekend->name %> only</h6>

						<a 
							class  = "blue half"
							method = "post"
							href   = "reg_print.mhtml?weekend_id=<% $weekend->id %>&school_id=<% $school->id %>"
						>
							Registration
						</a>

						<a 
							class  = "blue half" 
							method = "post"
							href   = "assignments_print.mhtml?weekend_id=<% $weekend->id %>&school_id=<% $school->id %>" 
						>
							Assignments
						</a>

						<a 
							class  = "blue half" 
							method = "post"
							href   = "dance_cards.mhtml?weekend_id=<% $weekend->id %>&school_id=<% $school->id %>" 
						>
							Student Cards
						</a>

%					} 
%				} 
%			} 

		</div>

%		if ($nsda_district) { 

<%perl>

			my $district_limit = $m->comp(
				"/funclib/nsda_entry_limits.mas",
				chapter => $chapter
			);

			my $house_limit = $m->comp(
				"/funclib/nsda_entry_limits.mas",
				chapter => $chapter,
				house   => 1
			);

			my $senate_limit = $m->comp(
				"/funclib/nsda_entry_limits.mas",
				chapter => $chapter,
				senate   => 1
			);

			my %district_entry = $m->comp(
				"/funclib/district_entry.mas",
				chapter  => $chapter
			);

</%perl>


			<div class="sidenote">
		
				<h4>NSDA Entry Limits</h4>

				<div class="full row marno">
					<span class="threequarters">
						NSDA Degrees:
					</span>
					<span class="quarter">
						<% $chapter->setting('nsda_degrees') %>
					</span>
				</div>

				<div class="full row marno">
					<span class="threequarters">
						Districts slots limit:
					</span>
					<span class="quarter">
						<% $district_limit %>
					</span>
				</div>

				<div class="full row marno">
					<span class="threequarters">
						Districts slots used
					</span>
					<span class="quarter">
						<% $district_entry{"entry_total"} %>
					</span>
				</div>

				<div class="full row marno">
					<span class="threequarters">
						Senate/House slots limit:
					</span>
					<span class="quarter">
						<% $senate_limit %>/<% $house_limit %>
					</span>
				</div>

				<div class="full row marno">

					<span class="threequarters">
						Senate/House slots used:
					</span>

					<span class="quarter">
						<% $district_entry{"senate_total"} %>/<% $district_entry{"house_total"} %>
					</span>
				</div>

			</div>

%		}

%		my @forms = $tourn->files( type  => "school_form");

%		if (@forms) { 

			<div class="sidenote">

				<h4>Required School Forms</h4>

%				foreach my $form (@forms) {
					
					<& "/funclib/school_forms.mas", 
						school => $school, 
						form => $form
					&>

%				}

			</div>

%		}

		<div class="sidenote">

			<h4>Potential Damage</h4>
 
			<a 
				class = "dkred full"
				href  = "drop.mhtml?school_id=<% $school->id %>"
			>
				Drop Entire Entry 
			</a>

			<a 
				class = "<% $school_settings{"noprefs"} > 0 ? "dkred" : "yellow" %> full" 
				href  = "lose_prefs.mhtml?school_id=<% $school->id %>"
			>
				School will <% $school_settings{"noprefs"} ? "NOT" : "" %> get prefs
			</a>

		</div>

% 			if ($person->site_admin) { 

				<div class="sidenote">

					<h4>Superpowers</h4>

					<a class="blue full">
						School: <% $school->id %> | Chapter: <% $chapter ? $chapter->id : "" %>
					</a>

					<a 
						class  = "blue full"
						method = "post"
						href="/user/tourn/director.mhtml?school_id=<% $school->id %>"
					>
						View Online Registration
					</a>

				</div>
% 			}	
	
	</div>
