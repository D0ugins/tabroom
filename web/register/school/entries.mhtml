<%args> 
	$tourn
	$tourn_settings
	$school_id => undef
	$event_id  => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $school = Tab::School->retrieve($school_id);

	my %entry_settings = $m->comp(
		"/funclib/school_entry_settings.mas", 
		school => $school
	);

	my @entries = $school->entries( unconfirmed => 0 );
	
	push @entries, $m->comp(
		"/funclib/school_hybrids.mas", 
		school => $school
	);

	my %seen;
	@entries = grep { ! $seen{$_->id} ++ } @entries;

	my %types;
	my %events;
	my %event_settings;

	my $quals;

	foreach my $entry (@entries) { 

		my $event;

		$event = $events{$entry->event->id};

		unless ($event) { 
			$event = $entry->event;
			$events{$event->id} = $event;
			$quals++ if $event->setting('ask_quals');
		}

		$types{$entry->event->type}++;

	}

</%init>

	<& "/register/menubar.mas", 
		school         => $school,
		whoami         => "students",
		tourn          => $tourn,
		tourn_settings => $tourn_settings
	&>

		<script>

			function dropSwitch(checkObject) { 

				var dropStatus = $("#"+checkObject.id).prop("checked");
				var entryId = $("#"+checkObject.id).attr("target_id");

				console.log("Drop status is "+dropStatus);

				if (dropStatus) { 

					$("#delete_"+entryId).removeClass("hidden");
					$("#row_"+entryId).addClass("strike");

				} else { 

					$("#delete_"+entryId).addClass("hidden");
					$("#row_"+entryId).removeClass("strike");
				}

			}

			function showType(targetType) { 

				$(".type_button").removeClass("invert");
				$(".type_row").addClass("hidden");

				if (targetType === "all") { 

					$("#all_button").addClass('invert');
					$(".type_row").removeClass("hidden");

				} else { 

					$("#"+targetType+"_button").addClass('invert');
					$("."+targetType+"_row").removeClass("hidden");

				}

			    $('table').trigger('applyWidgets');

			}

		</script>

		<div class="full nospace martopmore">

			<span class="third">
				<h4>Competitors</h4>
			</span>

			<span class="twothirds rightalign">

%				if ( (scalar (keys %types)) > 1)  { 

					<a 
						id      = "all_button"
						class   = "buttonwhite greentext invert smallish type_button"
						onClick = "showType('all');"
					>
						All
					</a>

%					foreach my $type (sort keys %types) { 
						<a 
							id      = "<% $type %>_button"
							class   = "buttonwhite bluetext smallish hover type_button"
							onClick = "showType('<% $type %>');"
						>
							<% ucfirst($type) %>
						</a>
%					}
%				}
			</span>

		</div>

		<& "/funclib/tablesorter.mas", table => 'sortme' &>
		
		<table id="sortme">

			<thead>

				<tr class="yellowrow">

					<th class="smaller">
						Event
					</th>

					<th class="smaller">
						Code
					</th>

					<th class="smaller">
						Name
					</th>

%					if ($quals) { 
						<th class="smaller">
							Qualifiers
						</th>
%					}

					<th class="smaller">
						Registered
					</th>

					<th class="smaller">
						Notes
					</th>

					<th class="smaller">
						Dropped?
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

			my %used;

			foreach my $entry (@entries) { 

				my $event = $events{$entry->event->id};

				my $no_codes++ if $event->setting("code_style") eq "names";

				next if $used{$entry->id};
				$used{$entry->id}++;

				
</%perl>
				<tr id    = "row_<% $entry->id %>"
					class = "smallish 
							<% $entry->dropped ? "strike" : "" %> 
							<% $event->type %>_row type_row"
				>

					<td class="smallish">
						<% $event->abbr %>
					</td>

					<td class="smallish nospace <% $entry->dropped ? "centeralign" : "" %>">
%						unless ($no_codes) {
							<a 
								class = "leftalign button white"
								href  = "/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
								<% $entry->code %>
							</a>
%						} 
					</td>
	
					<td class="<% ($entry->dropped) ? "strike" : "" %> smallish" >
						<a 
							class="white" 
							href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>"
						>
							<% $entry->name %>
						</a>
					</td>

%					if ($quals) { 

						<td class="smallish">

%							my $notfirst;

%							foreach my $qual ($entry->qualifiers) { 

								<% ($notfirst++) ? "<br />" : "" %>

								<% $qual->name %> 

								<% ($qual->result) ? "(".$qual->result.")" : "" %> 

%							}

%							if ($entry_settings{$entry->id}{"registered_seed"} eq "atlarge") { 
								<% ($notfirst) ? "<br />" : "" %>
								*At Large Applicant*
%							}

						</td>
%					}

					<td class="centeralign smallish">
						<% 
							$entry->created_at 
							? Tab::niceshortdt($entry->created_at->set_time_zone($tz)) 
							: ""
						%>
					</td>

					<td class="smallish">

%						if ($entry->othername) { 
							<% $entry->othername %> Hybrid
%						}

						<% ($entry->waitlist) ? "On Waitlist" : "" %>

						<% ($entry->dq) ? "DISQUALIFIED" : "" %>
						
						<% $entry->dropped ? "Dropped" : "" %>

%						my $dropped_at = $entry_settings{$entry->id}{"dropped_at"};

						<% $dropped_at ? "at: ".Tab::niceshortdt($dropped_at->set_time_zone($tz)) : "" %>

%						if ($entry_settings{$entry->id}{"title"}) { 
							<div class="smaller">
								<% $entry_settings{$entry->id}{"title"} %>
							</div>
%						}

%						if ($entry_settings{$entry->id}{"author"}) { 
							<div class="smaller">
								<% $entry_settings{$entry->id}{"author"} %>
							</div>
%						}

					</td>

					<td class="nospace">

                        <span class="hidden"><% $entry->dropped %></span>

						<span 
							id    = "drop_<% $entry->id %>"
							class = "half marno centeralign"
						>

							<label class="switch">
								<input 
									type          = "checkbox"
									value         = "1"
									id            = "<% $entry->id %>_dropped"
									property_name = "dropped"
									target_type   = "entry"
									target_id     = "<% $entry->id %>" 
									onChange      = "postSwitch( this, 'entry_switch.mhtml'); dropSwitch(this);"

									<% $entry->dropped ? 'checked="checked"' : "" %>
								>
								<div class="onred slider"></div>

							</label>

						</span>

						<span 
							class = "fourtenths marno rightalign"
						>

							<div 
								id    = "delete_<% $entry->id %>"
								class = "full nospace <% $entry->dropped ? "" : "hidden" %>">

%								my $warn = "This will delete all record of ".$entry->code.". Are you sure?";

								<a 
									class="buttonwhite redtext fa fa-trash"
									href="/register/entry/delete.mhtml?entry_id=<% $entry->id %>"
									title = "Delete Entry Entirely.  No fees or judge obligation"
									 <& "/funclib/confirm.mas", warn => $warn &>
								>
								</a>

							</div>

						</span>

					</td>

				</tr>
%   		}

			</tbody>

		</table>

	</div>

	<& menu.mas, 
		tourn    => $tourn,
		school   => $school,
		event_id => $event_id
	&>

