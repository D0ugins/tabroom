<%args>
	$tourn
	$tourn_settings
	$person
	$email_id => undef
	$whoami   => undef
</%args>
<%init>

	my $email = Tab::Email->retrieve($email_id) if $email_id;

</%init>

	<& "/funclib/editor.mas" &>

	<form
		action = "send.mhtml"
		method = "post"
	>

	<input
		type  = "hidden"
		name  = "email_id"
		value = "<% $email_id %>"
	>

	<div class="menu">

		<div class="sidenote">

		<h4>Emails</h4>

		<a
			href  = "compose.mhtml"
			class = "dkyellow full"
		>Compose New Email</a>

%		if ($tourn_settings->{"nsda_nats"}) {
			<a
				href  = "nats_notices.mhtml"
				class = "<% $whoami eq "nats_notices" ? "dkblue" : "yellow"%> full martopmore marbottom"
			>Nationals Notices</a>
%		}

		<h4>Send email to</h4>

			<label for="everybody">

				<div class="row hover nospace marbottom padless">

					<span class="marleft fourfifths nospace semibold redtext centeralign">
						All coaches with entries
					</span>

					<span class="fifth nospace centeralign padtophalf">
						<input
							class = "marless martop"
							type  = "checkbox"
							id    = "everybody"
							name  = "everybody"
							value = "1"
						>
					</span>

				</div>

			</label>

			<label for="everybody_plus">

				<div class="row hover nospace marbottom padless">

					<span class="marleft fourfifths nospace semibold redtext centeralign">
						All coaches even w/o entries
					</span>

					<span class="fifth nospace centeralign padtophalf">
						<input
							class = "marless martop"
							type  = "checkbox"
							id    = "everybody_plus"
							name  = "everybody_plus"
							value = "1"
						>
					</span>
				</div>
			</label>

%			if ($tourn_settings->{"ncfl"}) {

				<label for="diodirs">
					<div class="row hover">

						<span class="marleft fourfifths nospace">
							Diocese Administrators
						</span>
						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless"
								type  = "checkbox"
								id    = "diodirs"
								name  = "diodirs"
								value = "1"
							>
						</span>
					</div>
				</label>
%			}

			<label for="short">
				<div class="row hover">

					<span class="marleft fourfifths nospace">
						Short on judges
					</span>

					<span class="fifth nospace centeralign padtophalf">
						<input
							class = "marless"
							type  = "checkbox"
							id    = "short"
							name  = "judge_short"
							value = "1"
						>
					</span>
				</div>
			</label>

			<label for="tba">

				<div class="row hover">

					<span class="marleft fourfifths nospace">
						w/TBA names
					</span>

					<span class="fifth nospace centeralign padtophalf">
						<input
							class = "marless"
							type  = "checkbox"
							id    = "tba"
							name  = "tba"
							value = "1"
						>
					</span>
				</div>
			</label>

			<label for="not_checked_in">
				<div class="row hover">

					<span class="marleft fourfifths nospace">
						Not checked in
					</span>

					<span class="fifth nospace centeralign padtophalf">
						<input
							class = "marless"
							type  = "checkbox"
							id    = "not_checked_in"
							name  = "not_checked_in"
							value = "1"
						>
					</span>
				</div>
			</label>

			<label for="moneyshort">
				<div class="row hover">
					<span class="marleft fourfifths nospace">
						Owing money
					</span>

					<span class="fifth nospace centeralign padtophalf">
						<input
							class = "marless"
							type  = "checkbox"
							id    = "moneyshort"
							name  = "money_short"
							value = "1"
						>
					</span>
				</div>
			</label>

<%perl>
			if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {

				my %badness = ();

				if ($tourn_settings->{nsda_ms_nats}) {

					%badness = (
						invoice_short      => "Uninvoiced balances",
					);

				} else {

					%badness = (
						invoice_short       => "Uninvoiced balances",
						unclaimed_entries   => "Unclaimed Entries",
						noncomplete_entries => "Incomplete Entries (forms, pieces, etc)",
						noncomplete_judges  => "Incomplete Judges (paradigms)",
					);
				}
</%perl>

%				foreach my $key (sort keys %badness) {
					<label for="<% $key %>">
						<div class="row hover">
							<span class="marleft fourfifths nospace">
								<% $badness{$key} %>
							</span>

							<span class="fifth nospace centeralign padtophalf">
								<input
									type  = "checkbox"
									class = "marless"
									id    = "<% $key %>"
									name  = "<% $key %>"
									value = "1"
								>
							</span>
						</div>
					</label>
%				}
%			}

			<h6>Schools with entries in</h6>

%			foreach my $event (sort {$a->abbr cmp $b->abbr} $tourn->events) {

				<div class="row">

					<label for="<% $event->id %>">
						<span class="twothirds hover">
							<span class="twothirds nospace">
								<% $event->abbr %>
							</span>

							<span class="third nospace">
								<input
								class = "marless"
									type  = "checkbox"
									id    = "<% $event->id %>"
									name  = "event_<% $event->id %>"
									value = "1"
								>
							</span>
						</span>
					</label>

					<label for="<% $event->id %>_wl">
						<span
							class = "third hover nospace"
							title = "Include waitlist"
						>
							<span class="twothirds marno smaller">
								Waitlist:
							</span>

							<span class="third nospace padtophalf">
								<input
									class = "marless"
									type  = "checkbox"
									id    = "<% $event->id %>_wl"
									name  = "wl_<% $event->id %>"
									value = "1"
								>
							</span>
						</span>
					</label>
				</div>

% 			}

			<h6 class="martopmore marbottom">
				Judges in category:
			</h6>

%			foreach my $category (sort {$a->name cmp $b->name} $tourn->categories) {

				<label for="<% $category->id %>">
					<div class="row hover">
						<span class="marleft fourfifths nospace">
							<% $category->name %>
						</span>

						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless"
								type  = "checkbox"
								id    = "<% $category->id %>"
								name  = "category_<% $category->id %>"
								value = "1"
							>
						</span>
					</div>
				</label>

<%perl>
				if ($category->setting("nats_category")) {

					foreach my $jpool (
						$m->comp("/funclib/category_jpools.mas",
							category => $category,
							limit    => "registrant"
						)
					) {

						my $inc++ if $jpool->setting("paradigm_form");

</%perl>
						<div class="row">

							<span class="tenths nospace fa fa-sm fa-long-arrow-right centeralign greytext">
							</span>

							<span class="marleft fourtenths nospace">
								<% $jpool->name %>
							</span>

							<label for="jpool_<% $jpool->id %>">
								<span
									title = "All judges in pool"
									class="fifth nospace leftalign padtophalf hover centeralign"
								>
									All
									<input
										class = "marless"
										type  = "checkbox"
										id    = "jpool_<% $jpool->id %>"
										name  = "jpool_<% $jpool->id %>"
										value = "1"
									>
								</span>
							</label>

%							if ($inc) {
								<label for="incomplete_jpool_<% $jpool->id %>">
									<span
										title = "Judges without complete paradigms"
										class = "threetenths nospace leftalign padtophalf hover centeralign"
									>
										Incomplete
										<input
											class = "marless"
											type  = "checkbox"
											id    = "incomplete_jpool_<% $jpool->id %>"
											name  = "incomplete_jpool_<% $jpool->id %>"
											value = "1"
										>
									</span>
								</label>
%							}

						</div>

%					}
%				}
% 			}

			<p class="smaller explain">
				*All tournament administrators will also receive all emails
			</p>

		</div>

	</div>

	<div class="main">

		<h2>
			Email registered coaches
		</h2>

		<h5>
			Subject Line:
		</h5>

		<div class="row full centeralign padmore">
			<input
				type  = "text"
				id    = "subject"
				name  = "subject"
				size  = "64"
				value = "<% ($email) ? $email->subject : "" %>"
			>

			<script>
				$(document).ready(function() {
					document.getElementById('subject').focus();
				});
			</script>
		</div>

		<h5>
			Text:
		</h5>

		<div class="row full centeralign">
			<textarea
				name = "content"
				cols = "45"
				rows = "20"
			><% ($email) ? $email->content : "" %></textarea>
		</div>

		<div class="libl full rightalign">
			<input type="submit" value="  Send Email ">
			</form>
		</div>

	</div>

