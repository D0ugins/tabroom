<%args>
	$tourn
	$tourn_settings
	$person
	$perms
	$email_id => undef
	$whoami   => undef
</%args>
<%init>

	my $email = Tab::Email->retrieve($email_id) if $email_id;

	my ($eventref, $catref) = $m->comp(
        "/funclib/allowed_events.mas",
        tourn => $tourn,
        perms => $perms,
        type  => "admin"
    );

    my @events = @{$eventref};
    my @categories = @{$catref};

</%init>

	<& "/funclib/editor.mas" &>

	<form
		action = "send.mhtml"
		method = "post"
	>

	<input
		type  = "hidden"
		name  = "email_id"
		value = "<% $email_id %>"
	>

	<div class="menu">

		<div class="sidenote">

		<h4>Emails</h4>

		<a
			href  = "compose.mhtml"
			class = "dkyellow full"
		>Compose New Email</a>

		<a
			href  = "index.mhtml"
			class = "blue full"
		>Email Archive</a>


		<h4 class="martop">Send email to</h4>

%			if ($perms->{owner} || $perms->{full_admin} || $perms->{registration}) {

				<label for="everybody">
					<div class="row hover nospace padless">
						<span
							title = "Does not included dropped, waitlisted or unconfirmed entries"
							class = "marleft fourfifths nospace semibold bluetext"
						>
							Coaches with active entries
						</span>

						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless martop"
								type  = "checkbox"
								id    = "everybody"
								name  = "everybody"
								value = "1"
							>
						</span>
					</div>
				</label>

				<label for="everybody_plus">
					<div class="row hover nospace padless marbottom">
						<span class="marleft fourfifths nospace semibold redtext">
							All coaches
						</span>

						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless martop"
								type  = "checkbox"
								id    = "everybody_plus"
								name  = "everybody_plus"
								value = "1"
							>
						</span>
					</div>
				</label>

%				if ($tourn_settings->{"ncfl"}) {

					<label for="diodirs">
						<div class="row hover nospace padless">

							<span class="marleft fourfifths nospace">
								Diocese Administrators
							</span>
							<span class="fifth nospace centeralign padtophalf">
								<input
									class = "marless"
									type  = "checkbox"
									id    = "diodirs"
									name  = "diodirs"
									value = "1"
								>
							</span>
						</div>
					</label>
%				}

				<label for="short">
					<div class="row hover nospace padless martopmore">
						<span class="marleft fourfifths nospace">
							Coaches under on judging
						</span>

						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless"
								type  = "checkbox"
								id    = "short"
								name  = "judge_short"
								value = "1"
							>
						</span>
					</div>
				</label>

				<label for="tba">
					<div class="row hover nospace padless">
						<span
							class = "marleft fourfifths nospace"
						>
							Coaches with TBA names
						</span>

						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless"
								type  = "checkbox"
								id    = "tba"
								name  = "tba"
								value = "1"
							>
						</span>
					</div>
				</label>

				<label for="waitlist_only">
					<div class="row hover nospace padless">
						<span class="marleft fourfifths nospace">
							Coaches with only waitlist entries
						</span>

						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless"
								type  = "checkbox"
								id    = "waitlist_only"
								name  = "waitlist_only"
								value = "1"
							>
						</span>
					</div>
				</label>

				<label for="not_checked_in">
					<div class="row hover nospace padless">
						<span class="marleft fourfifths nospace">
							Coaches not checked in
						</span>

						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless"
								type  = "checkbox"
								id    = "not_checked_in"
								name  = "not_checked_in"
								value = "1"
							>
						</span>
					</div>
				</label>

				<label for="moneyshort">
					<div class="row hover nospace padless">
						<span class="marleft fourfifths nospace">
							Coaches with balances owed
						</span>

						<span class="fifth nospace centeralign padtophalf">
							<input
								class = "marless"
								type  = "checkbox"
								id    = "moneyshort"
								name  = "money_short"
								value = "1"
							>
						</span>
					</div>
				</label>

<%perl>
				if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {

					my %badness = ();

					if ($tourn_settings->{nsda_ms_nats}) {

						%badness = (
							invoice_short      => "Uninvoiced balances",
						);

					} else {

						%badness = (
							invoice_short       => "Uninvoiced balances",
							unclaimed_entries   => "Unclaimed Entries",
							noncomplete_entries => "Incomplete Entries (forms, pieces, etc)",
							noncomplete_judges  => "Incomplete judges (paradigm/pools)",
						);
					}
</%perl>

%					foreach my $key (sort keys %badness) {
						<label for="<% $key %>">
							<div class="row hover nospace padless">
								<span class="marleft fourfifths nospace">
									<% $badness{$key} %>
								</span>

								<span class="fifth nospace centeralign padtophalf">
									<input
										type  = "checkbox"
										class = "marless"
										id    = "<% $key %>"
										name  = "<% $key %>"
										value = "1"
									>
								</span>
							</div>
						</label>
%					}
%				}
%			}

			<h6>Coaches with entries in</h6>

%			foreach my $event (sort {$a->abbr cmp $b->abbr} @events) {

				<div class="row">

					<span class="fifth semibold bluetext">
						<span class="halfspacer"></span>
						<% $event->abbr %>
					</span>

					<label for="<% $event->id %>">
						<span
							class = "twofifths hover"
							title = "Schools with confirmed entries in <% $event->name %>"
						>
							<span class="twothirds smaller nospace centeralign">
								Active
							</span>

							<span class="third nospace centeralign">
								<input
								class = "marless"
									type  = "checkbox"
									id    = "<% $event->id %>"
									name  = "event_<% $event->id %>"
									value = "1"
								>
							</span>
						</span>
					</label>

%					if ($perms->{owner} || $perms->{full_admin} || $perms->{registration}) {

						<label for="<% $event->id %>_wl">
							<span
								class = "twofifths yellowhover"
								title = "Schools with waitlisted entries in <% $event->name %>"
							>
								<span class="twothirds smaller nospace centeralign">
									Waitlisted
								</span>

								<span class="third nospace centeralign">
									<input
										class = "marless"
										type  = "checkbox"
										id    = "<% $event->id %>_wl"
										name  = "wl_<% $event->id %>"
										value = "1"
									>
								</span>
							</span>
						</label>
%					}
				</div>
% 			}

<%perl>
			if ($perms->{owner}
				|| $perms->{full_admin}
				|| $perms->{registration}
				|| (scalar @events > 1)
			) {
</%perl>

				<div class="full martopmore padvertno">

					<span class="quarter nospace">
						<h6 class="nospace semibold bluetext">
							Judges
						</h6>
					</span>

					<span
						class="threequarters explain smaller rightalign martopless"
						title="Live updates followers will not get these emails"
					>
						Emails go to linked accounts only
					</span>
				</div>

%				foreach my $category (sort {$a->name cmp $b->name} @categories) {

					<label for="<% $category->id %>">
						<div class="row hover padvertless padleft">
							<span class="fourfifths nospace">
								<% $category->name %>
							</span>

							<span
								title = "Send email to all judges and followers, posted online"
								class = "fifth nospace centeralign padtophalf"
							>
								<input
									class = "marless"
									type  = "checkbox"
									id    = "<% $category->id %>"
									name  = "category_<% $category->id %>"
									value = "1"
								>
							</span>
						</div>
					</label>

<%perl>
					if ($category->setting("nats_category")) {

						foreach my $jpool (
							$m->comp("/funclib/category_jpools.mas",
								category => $category,
								limit    => "registrant"
							)
						) {

							my $inc++ if $jpool->setting("paradigm_form");

</%perl>
							<div class="row">

								<span class="tenths nospace fa fa-sm fa-long-arrow-right centeralign greytext">
								</span>

								<span class="marleft fourtenths nospace">
									<% $jpool->name %>
								</span>

								<label for="jpool_<% $jpool->id %>">
									<span
										title = "All judges in pool"
										class="fifth nospace leftalign padtophalf hover centeralign"
									>
										All
										<input
											class = "marless"
											type  = "checkbox"
											id    = "jpool_<% $jpool->id %>"
											name  = "jpool_<% $jpool->id %>"
											value = "1"
										>
									</span>
								</label>

%								if ($inc) {
									<label for="incomplete_jpool_<% $jpool->id %>">
										<span
											title = "Judges without complete paradigms"
											class = "threetenths nospace leftalign padtophalf hover centeralign"
										>
											Inc
											<input
												class = "marless"
												type  = "checkbox"
												id    = "incomplete_jpool_<% $jpool->id %>"
												name  = "incomplete_jpool_<% $jpool->id %>"
												value = "1"
											>
										</span>
									</label>
%								}
							</div>
%						}
%					}
% 				}
%			}

			<p class="smallish explain semibold redtext centeralign">
				All tournament admins receive all emails
			</p>

		</div>
	</div>

	<div class="main">
		<h2>
			Email registered coaches
		</h2>

		<div class="row centeralign padmore">

			<span class="third semibold bluetext">
				Tournament
			</span>

			<span class="twothirds leftalign semibold redtext padsettingtext">
				<% $tourn->name %>

%#				Prevents the phenonmenon where folks log into a different
%#				tournament elsewhere and it jacks their session so they blast
%#				the wrong tournament
				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>
			</span>

		</div>

		<div class="row centeralign padmore">

			<span class="third semibold bluetext">
				Subject Line
			</span>

			<span class="twothirds leftalign">
				<input
					type  = "text"
					id    = "subject"
					name  = "subject"
					size  = "64"
					value = "<% ($email) ? $email->subject : "" %>"
				>
			</span>

			<script>
				$(document).ready(function() {
					document.getElementById('subject').focus();
				});
			</script>
		</div>

		<div class="row centeralign padmore">
			<span class="third semibold bluetext">
				Send as<span class="inline redtext">*</span>
			</span>

			<span class="twothirds leftalign">
				<select name="from" class="fixedmost">
					<option
						value="<% $person->id %>"
					><% $person->first." ".$person->last." (".$person->email.")"%></option>

%					foreach my $perm ($tourn->permissions(tag => "contact")) {
%						my $contact = $perm->person;
						<option
							value="<% $contact->id %>"
							<% $email && $email->sender == $contact ? "selected" : "" %>
						><% $contact->first." ".$contact->last." (".$contact->email.")"%></option>
%					}
				</select>
			</span>

			<script>
				$(document).ready(function() {
					document.getElementById('subject').focus();
				});
			</script>
		</div>

		<label for="hidden">
			<div class="row hover centeralign padmore">
				<span class = "third semibold bluetext">
					Do not post email on web
				</span>

				<span class="twothirds leftalign">
					<input
						type  = "checkbox"
						id    = "hidden"
						name  = "hidden"
						value = "1"
						<% $email && $email->hidden ? "checked" : "" %>
					>
				</span>
			</div>
		</label>

		<label for="all_admins">
			<div
				class = "row hover centeralign padmore"
				title = "All emails go to tournament owners.  This includes everyone else"
			>
				<span class = "third semibold bluetext">
					CC all tournament staff
				</span>

				<span class="twothirds leftalign">
					<input
						type  = "checkbox"
						id    = "all_admins"
						name  = "all_admins"
						value = "1"
					>
				</span>
			</div>
		</label>

		<h5>
			Text
		</h5>

		<div class="row centeralign">
			<textarea
				name = "content"
				cols = "45"
				rows = "20"
			><% ($email) ? $email->content : "" %></textarea>
		</div>

%		if ($email_id) {
			<label for="nosend">
				<div class="row hover centeralign padmore">
					<span class = "twothirds rightalign semibold bluetext">
						Update web archive only &ndash; do not send email
					</span>

					<span class="third leftalign">
						<input
							type    = "checkbox"
							id      = "nosend"
							name    = "nosend"
							value   = "1"
							checked = "checked"
						>
					</span>
				</div>
			</label>
%		}

		<div class="libl rightalign padvert">
			<span class="third centeralign">
				<input type="submit" value="Save &amp; Send Email">
			</span>
		</div>

		</form>

		<div class="centeralign martopmore padtopmore">
			<span class="redtext centeralign padtopmore semibold fourfifths biggish doublespaced">
				* Note that the person who actually sends this email is logged,
				so please restrain any impulse to commit pranks or shenanigans
				with this feature, because you will be caught out.
			</span>
		</div>

	</div>
