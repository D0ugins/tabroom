<%args>
	$tourn
	$tourn_settings
	$tag         => undef
	$category_id => undef
</%args>
<%init>

	use Switch;

	my $category = Tab::Category->retrieve($category_id);

	my @all_categories = $tourn->categories();
	$category = $all_categories[0] if scalar @all_categories == 1;

	my @keys;

	if ($category) { 

		foreach my $jpool (
			$m->comp("/funclib/category_jpools.mas", 
				category => $category,
				limit => "registrant"
			)
		) { 
			push @keys, $jpool->setting("paradigm_form") 
				if $jpool->setting("paradigm_form");
		}

		push @keys, $category->setting("paradigm_form") 
			if $category->setting("paradigm_form");
	}

	my %seen;
	@keys = grep { ! $seen{$_} ++ } @keys;

	if (scalar @keys == 1 || (not defined $tag)) {
		$tag = $keys[0];
	}

	my $rtag = $tag;

	$rtag =~ s/[\W_]//g;
	undef $rtag unless $category;

	my %form = $m->comp(
		"/funclib/questions.mas", 
		tag => $rtag
	) if $rtag;

	my %answer_settings = $m->comp(
		"/funclib/judge_settings.mas", 
		category => $category,
		tag      => "form_".$rtag
	) if $rtag;

</%init>

	<& "menu.mas", 
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "paradigms"
	&>

	<div class="main">

	<span class="third nospace">
		<h4 class="nospace">Paradigm Sheets</h4>
	</span>

	<form action="questionnaire.mhtml" method="post">

	<span class="third centeralign">
		<select 
			name     = "category_id"
			class    = "fixedmed"
			onChange = "this.form.submit();"
		>
%			foreach my $ocat (@all_categories) { 
				<option 
					value="<% $ocat->id %>"
					<% $ocat == $category ? 'selected' : "" %>
				><% $ocat->name %></option>
%			}
		</select>
	</span>

	<span class="third centeralign">

		<select 
			name     = "tag"
			class    = "fixedmed"
			onChange = "this.form.submit();"
		>
%			foreach my $key (@keys) { 
				<option 
					value="<% $key %>"
					<% $key eq $tag ? 'selected' : "" %>
				><% $key %></option>
%			}
		</select>
	</span>

<%perl>

	my $counter;

	if (keys %form) { 
		
		my @judges = $m->comp("/funclib/category_judges.mas", category => $category);

		foreach my $judge (@judges) { 

			next unless $answer_settings{$judge->id};

			my %answers = eval { 
				return %{JSON::decode_json($answer_settings{$judge->id})} if $judge;
			};

			last if $counter++ > 10;
</%perl>

			<div class="full martopmore">

				<span class="quarter nospace">
					<h6 class="nospace semibold">
					<% $judge->first %> <% $judge->last %>
					</h6>
				</span>

				<span class="half rightalign semibold bigger nospace">
					<% $judge->schname %>
				</span>
				<span class="quarter rightalign semibold bigger nospace">
					<% $judge->regname %>
					<% $judge->distcode %>
				</span>

			</div>
<%perl>

			my @keys = sort keys %{$form{"questions"}};

			@keys = 
				map  { $_->[0] } 
				sort { uc($a->[1]) cmp uc($b->[1]) } 
				map  { [$_, $_ =~ /(\D+)/] } 
				@keys;

			@keys = 
				map  { $_->[0] } 
				sort { $a->[1] <=> $b->[1] } 
				map  { [$_, $_ =~ /(\d+)/] } 
				@keys;


			foreach my $key (@keys) { 

				my $subquestion;
				$subquestion = 1 unless $key eq int($key);

				my $class = $form{"questions"}{$key}{"class"};

				next if $form{"questions"}{$key}{"type"} eq "title";

</%perl>

				<div class="row">

%					if ($subquestion) { 
						<span class="twenty marno">&nbsp;</span>
						<span class="nineteen">
%					}

%					if ($form{"questions"}{$key}{"type"}eq "textbox") { 

						<span class="full">
						<p class="bluetext semibold biggish">Additional remarks:</p>

%					} elsif ($form{"questions"}{$key}{"type"} eq "boolean") { 

						<span class="threequarters <% $subquestion ? "" : "semibold" %> marno bluetext padsetting">
							<p class="nospace marleftmore">
								<% $form{"questions"}{$key}{"question"} %>
							</p>
						</span>

						<span class="fifth">

%					} else { 

						<span class="fiveeighths <% $subquestion ? "" : "semibold" %> marno bluetext padsetting">
							<p class="nospace marleftmore">
								<% $form{"questions"}{$key}{"question"} %>
							</p>
						</span>
					
						<span class="threeeighths padvert marno">

%					}
					

<%perl>

					if ($form{"questions"}{$key}{"type"}eq "textbox") { 
						$m->print("<p>");
					} elsif ($form{"questions"}{$key}{"type"} eq "checkbox") { 
	
						my $notfirst;

						foreach my $answer (@{$form{"questions"}{$key}{"answers"}}) { 
							next unless $answers{$key."_".$answer};
							$m->print(", ") if $notfirst++;
							$m->print(ucfirst($answer));
						}


					} else { 
						$m->print( ucfirst($answers{$key}) );
					} 

					if ($form{"questions"}{$key}{"type"} eq "radio") { 
						my $max;
						foreach my $answer (@{$form{"questions"}{$key}{"answers"}}) { 
							next if $answer ne int($answer);
							$max = $answer if $max < $answer;
						}
						$m->print("/".$max) if $max;
					}
</%perl>

				</span>

%				unless ($subquestion) { 
					</span>
%				}

				</div>

%			}
%		}
%	}
				
	</div>

