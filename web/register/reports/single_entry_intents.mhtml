<%args>
	$tourn
	$tourn_settings
	$session
	$mode => "pdf"
</%args>
<%init>

	my %event_by_id = map {$_->id => $_} ($tourn->events);

    my $name = $tourn->name;
	$name =~ s/[\W_]//g; 

	my $filename = "SingleEntryIntents-".$name."-".$session->id;
	my $filepath = $Tab::file_root."/tmp/"; 

	my $tabular = "\\begin{tabular}{p{1in}p{.25in}p{1in}p{1in}p{.5in}p{.25in}p{1in}p{.5in}}\n";

	if ($mode eq "csv") { 

		$filename .= ".csv";
		$m->clear_buffer;
		$r->content_type('application/csv');
		$r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";
		
		$m->print("School , SCode , First , Last , Merit # , Event , Code , Priority \n");

	} elsif ($mode eq "pdf") { 

	    my $name = $tourn->name;
		$name =~ s/[\W_]//g; 
		
		my $filename = "SingleEntryIntents-".$name."-".$session->id;
		my $filepath = $Tab::file_root."/tmp/"; 
		
		$m->comp(
			"/funclib/printout.mas", 
			tourn     => $tourn,
			filename  => $filename,
			head      => 1
		);
		
		open (TEXOUT, ">>$filepath"."$filename.tex");

		print TEXOUT "\\noindent\n{\\LARGE \\bf ".Tab::texify($tourn->name)."\\hfill Single Entry Intents } \n";
		print TEXOUT "\\medskip\n";
		print TEXOUT "\\newline\n";

		print TEXOUT $tabular;
		print TEXOUT "\\rowcolor[rgb]{1,.95,.74}\n";
		print TEXOUT "School & SCode & First & Last & Merit \\# & Event & Code & Priority \n";
		print TEXOUT "\\end{tabular}\n";
		print TEXOUT "\\newline\n";
	}

	my $switch;

	foreach my $school ($tourn->schools) { 

		my $chapter = $school->chapter;

		my %district_entry = $m->comp(
			"/funclib/district_entry.mas", 
			chapter => $chapter 
		);

		my %already_entries = ();
		my %already_students = ();

		my %student_entries = ();
		my %student_partners = ();

		my @student_ids = sort keys %{$district_entry{"entries"}};

		@student_ids = 
			sort { $district_entry{'entries'}{$b} 
					<=> $district_entry{'entries'}{$a} 
				} @student_ids;

		foreach my $student_id (@student_ids) { 

			next if scalar @{$district_entry{"entries"}{$student_id}} < 2;

			my $student;

			$student = $already_students{$student_id};

			unless ($student) { 
				$student = Tab::Student->retrieve($student_id);
				$already_students{$student_id} = $student;
			}

			foreach my $entry_id ( @{$district_entry{"entries"}{$student_id}} ) { 

				my $entry;
				$entry = $already_entries{$entry_id};

				unless ($entry) { 
					$entry = Tab::Entry->retrieve($entry_id);
					$already_entries{$entry_id} = $entry;
				}


				if ($mode eq "csv") { 

					$m->print('"');
					$m->print($school->name);
					$m->print('","');
					$m->print($school->code);
					$m->print('","');
					$m->print($student->first);
					$m->print('","');
					$m->print($student->last);
					$m->print('","');
					$m->print($student->ualt_id);
					$m->print('","');
					$m->print($entry->event->abbr);
					$m->print('","');
					$m->print($entry->code);
					$m->print('","');
					$m->print($entry->setting("nsda_priority"));
					$m->print('"'."\n");

				} elsif ($mode eq "pdf") { 

					print TEXOUT $tabular;

					print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\n" unless $switch++ % 2;

					print TEXOUT "\\truncate{.9in}{".Tab::texify($school->name)."}";
					print TEXOUT " & ";
					print TEXOUT Tab::texify($school->code);
					print TEXOUT " & ";
					print TEXOUT Tab::texify($student->first);
					print TEXOUT " & ";
					print TEXOUT Tab::texify($student->last);
					print TEXOUT " & ";
					print TEXOUT Tab::texify($student->ualt_id);
					print TEXOUT " & ";
					print TEXOUT Tab::texify($entry->event->abbr);
					print TEXOUT " & ";
					print TEXOUT Tab::texify($entry->code);
					print TEXOUT " & ";
					print TEXOUT Tab::texify($entry->setting("nsda_priority"));
					print TEXOUT "\\end{tabular}\n";
					print TEXOUT "\\newline\n";
				}

			}

		}

	}

	if ($mode eq "csv") { 

		$m->abort();

	} elsif ($mode eq "pdf") { 

		$m->comp(
			"/funclib/printout.mas", 
			tourn     => $tourn,
			filename  => $filename,
			tail      => 1
		);

	}

</%init>

