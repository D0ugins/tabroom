<%args>
	$tourn
	$tourn_settings
	$category_id => undef
</%args>
<%init>

	my @pref_categories;

	foreach my $category ($tourn->categories) {

		if ($category->setting('prefs')) {
			push (@pref_categories, $category);
		}
	}

	my $category;

	if (@pref_categories && (not defined $category_id)) {
		$category = $pref_categories[0];
	} elsif ($category_id) {
		$category = Tab::Category->retrieve($category_id);
	}

	my %ratings;
	my %judges;

	if ($category) {

		my $dbh = Tab::DBI->db_Main();

		my $sth = $dbh->prepare("
			select
				entry.id, entry.name, entry.code,
				school.id, school.name, school.state,
				event.id, event.abbr,
				judge.id, judge.school

			from (entry, event, school)

			left join rating on entry.id = rating.entry
			left join judge on judge.id = rating.judge and judge.active = 1

			where entry.event = event.id
				and entry.school = school.id
				and event.category = ?
				and entry.active = 1
		");

		$sth->execute($category);

		while (
			my (
				$entry_id, $entry_name, $entry_code,
				$school_id, $school_name, $school_state,
				$event_id, $event_abbr,
				$judge_id, $judge_school
			) = $sth->fetchrow_array()
		) {

			$ratings{$entry_id}{"name"}         = $entry_name;
			$ratings{$entry_id}{"code"}         = $entry_code;
			$ratings{$entry_id}{"school_id"}    = $school_id;
			$ratings{$entry_id}{"school_name"}  = $school_name;
			$ratings{$entry_id}{"school_state"} = $school_state;
			$ratings{$entry_id}{"event_id"}     = $event_id;
			$ratings{$entry_id}{"event_abbr"}   = $event_abbr;

			$ratings{$entry_id}{"rated_total"}++;
			$ratings{$entry_id}{"rated"}{$judge_id}++;

			$judges{$judge_id} = $judge_school;
		}

		$sth->finish();

		$sth = $dbh->prepare("
			select
				entry.id, judge.id, strike.type
			from (entry, event, strike, judge)

			where entry.event = event.id
				and event.category = ?
				and entry.id = strike.entry
				and strike.judge = judge.id
				and judge.active = 1
				and entry.active = 1
		");

		$sth->execute($category->id);

		while (
			my (
				$entry_id, $judge_id, $strike_type
			) = $sth->fetchrow_array()
		) {
			if ($strike_type eq "conflict") {
				$ratings{$entry_id}{"conflicts"}++;
				$ratings{$entry_id}{"conflicted"}{$judge_id}++;
			} else {
				$ratings{$entry_id}{"strikes"}++;
				$ratings{$entry_id}{"struck"}{$judge_id}++;
			}
		}

		$sth->finish();
		$sth = $dbh->prepare("
			select
				entry.id, judge.id, strike.type

			from (entry, event, strike, judge)

			where entry.event = event.id
				and event.category = ?
				and entry.school = strike.school
				and strike.judge = judge.id
				and judge.active = 1
				and entry.active = 1
		");

		$sth->execute($category->id);

		while (
			my (
				$entry_id, $judge_id, $strike_type
			) = $sth->fetchrow_array()
		) {
			if ($strike_type eq "conflict") {
				$ratings{$entry_id}{"conflicts"}++;
				$ratings{$entry_id}{"conflicted"}{$judge_id}++;
			} else {
				$ratings{$entry_id}{"strikes"}++;
				$ratings{$entry_id}{"struck"}{$judge_id}++;
			}
		}

		$sth->finish();
	}

</%init>

	<&
		"menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "prefs"
	&>

	<div class="main">

		<& /funclib/tablesorter.mas, table => "prefs" &>

		<span class="third nospace">
			<h4>Pref status</h4>
		</span>

		<span class="third nospace centeralign">
			<form action="prefs.mhtml" method="post">
				<select
					name     = "category_id"
					class    = "fixedbig"
					onChange = "this.form.submit();"
				>
					<option value="">Select a category</option>
%					foreach my $pc (@pref_categories) {
						<option
							<% $pc->id == $category_id ? "selected" : "" %>
							value="<% $pc->id %>"
						><% $pc->name %></option>
%					}
				</select>
			</form>
		</span>

		<span
			class = "third rightalign"
			id    = "prefs_buttonarea"
		>
		</span>

		<table id="prefs">

			<thead>

				<tr class="yellowrow">

					<th class="smallish">
						Entry
					</th>

					<th class="smallish">
						Event
					</th>

					<th class="smallish">
						Institution
					</th>

					<th class="smallish">
						Own
					</th>

					<th class="smallish">
						Preffed
					</th>

					<th class="smallish">
						Struck
					</th>

					<th class="smallish">
						Conflicted
					</th>

					<th class="smallish">
						Unrated
					</th>

				</tr>

			</thead>

			<tbody>
<%perl>

				foreach my $entry_id (sort {$ratings{$a}{"code"} cmp $ratings{$b}{"code"}} keys %ratings) {

					my %stats;

					foreach my $judge_id (keys %judges) {

						if ($judges{$judge_id} == $ratings{$entry_id}{'school_id'}) {
							$stats{"own"}++;
						} elsif ($ratings{$entry_id}{"conflicted"}{$judge_id}) {
							$stats{"conflicted"}++;
						} elsif ($ratings{$entry_id}{"struck"}{$judge_id}) {
							$stats{"struck"}++;
						} elsif ($ratings{$entry_id}{"rated"}{$judge_id}) {
							$stats{"rated"}++;
						} else {
							$stats{"unrated"}++;
						}
					}

					$ratings{$entry_id}{"stats"} = \%stats;
				}

				foreach my $entry_id (sort {
						$ratings{$b}{"stats"}{"unrated"} <=> $ratings{$a}{"stats"}{"unrated"}
						|| $ratings{$a}{"code"} cmp $ratings{$b}{"code"}
					} keys %ratings
				) {
</%perl>

					<tr>

						<td title="<% $ratings{$entry_id}{"name"} %>" class="nospace">
							<a
								class="full white padleft padvertless"
								href="/register/entry/prefs.mhtml?entry_id=<% $entry_id %>"
							>
								<% $ratings{$entry_id}{"code"} %>
							</a>
						</td>

						<td class="centeralign">
							<% $ratings{$entry_id}{"event_abbr"} %>
						</td>

						<td>
							<% Tab::short_name($ratings{$entry_id}{"school_name"}) %>
						</td>

						<td class="centeralign">
							<% $ratings{$entry_id}{"stats"}{"own"} %>
						</td>

						<td class="centeralign">
							<% $ratings{$entry_id}{"stats"}{"rated"} %>
						</td>

						<td class="centeralign">
							<% $ratings{$entry_id}{"stats"}{"struck"} %>
						</td>

						<td class="centeralign">
							<% $ratings{$entry_id}{"stats"}{"conflicted"} %>
						</td>

						<td class="centeralign">
							<% $ratings{$entry_id}{"stats"}{"unrated"} %>
						</td>

					</tr>
%				}

			</tbody>

		</table>
	</div>

