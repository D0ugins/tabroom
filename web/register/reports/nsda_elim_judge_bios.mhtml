<%args>
	$tourn
	$tourn_settings
  $event_id => undef
</%args>
<%init>

  use JSON;

  my $dbh = Tab::DBI->db_Main();

  my $sql = "
     select j.first, j.last, jp.name, e.id, e.name, js.value_text 
    from jpool jp

    join category c       on c.id   = jp.category
    join jpool_judge jj   on jp.id  = jj.jpool
    join judge j          on j.id   = jj.judge
    join judge_setting js on j.id   = js.judge

    join jpool_round jr   on jp.id  = jr.jpool
    join round r          on r.id   = jr.round
    join event e          on e.id   = r.event

    where c.tourn = ?
  ";
  
  if (defined $event_id) {
    $sql .= "and e.id = ?";
  }
  
  $sql .= "
    and jp.name like \"%final%\"
    and js.tag like \"nomination\";
  ";


  my $sth = $dbh->prepare($sql);
  
  if (defined $event_id){
    $sth->execute($tourn->id,$event_id);
  } else {
    $sth->execute($tourn->id);
  }
  my %nomination;

  my %events;
</%init> 
  
  <div class="main">

    <table id="nominations">

      <thead>

        <tr class="yellowrow">
          
          <th>Judge</th>
          
          <th>Elim Pool</th>

          <th>Phonetic</th>

          <th>Event</th>
          
          <th>Bio</th>
        
        </tr>
      </thead>
      <tbody>
<%perl>
  while ( my ( $judge_first, $judge_last, $pool_name, $e_id, $event_name,
$bio_json ) = $sth->fetchrow_array() ) {
    
    $events{$e_id} = $event_name;

    if (defined $event_id) {
      next unless $event_id == $e_id;
    } 
          my %nomination = eval {
						return %{JSON::decode_json($bio_json) };
					};
</%perl>
	      <tr> 
          <td> <% $judge_first %> <% $judge_last %> </td>
          <td>
              <% $nomination{"phonetic"} %>
          </td> 
          <td> <% $pool_name %> </td>
          <td> <a href="nsda_elim_judge_bios.mhtml?event_id=<% $event_id %>"><% $event_name %></a></td>
          <td>
              <% $nomination{"bio"} %>
          </td>
        </tr>
% }
			</tbody>

		</table>

	</div>

<div class="menu">

  <div class="sidenote">
    <h4>Finals Pools</h4>
  
%   foreach my $event (keys %events) {
      <a class="blue full" href="nsda_elim_judge_bios.mhtml?event_id=<% $event %>"><%
$events{$event} %></a>
%   } 

  </div>
</div>
