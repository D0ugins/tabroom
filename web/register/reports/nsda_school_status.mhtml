<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

    my $dbh = Tab::DBI->db_Main();

    my %school_data = $m->comp(
		"/funclib/nationals_school_status.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings
	);

	my %school_settings = $m->comp(
		"/funclib/school_settings.mas",
		tourn => $tourn
	);

</%init>

	<div class="blankfull">

		<span class="half nospace">
			<h4>School status</h4>
		</span>

		<span
			class = "rightalign half nospace"
			id    = "status_buttonarea"
		>
			<a
				class      = "buttonwhite greentext nowrap smallish invert"
				on_success = "refresh"
				onClick    = "postSwitch(this, '/register/entry/nsda_entry_status.mhtml');"
			>
 				<span class="fa fa-sm fa-refresh"></span>
				Sync Entry Status
			</a>
			<a
				class      = "buttonwhite bluetext nowrap smallish invert"
				on_success = "refresh"
				onClick    = "postSwitch(this, '/register/judge/nsda_judge_status.mhtml');"
			>
 				<span class="fa fa-sm fa-refresh"></span>
				Sync Judge Status
			</a>
		</span>

		<& "/funclib/tablesorter.mas", table => "status" &>

		<table id="status">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						State
					</th>

					<th class="Contact info & agreements entered">
						Info?
					</th>

					<th title="Number of entries pending acceptance or rejection">
						Pend
					</th>
					<th title="Date of most recent entry in pending state">
						PSince
					</th>

					<th title="Number of entries that were accepted">
						Accept
					</th>

					<th title="Number of entries marked incomplete">
						Inc
					</th>

					<th title="Judging obligations not met">
						JObl?
					</th>

					<th title="Judges without a pool and/or a paradigm">
						IncJ
					</th>

					<th title="Contact name">
						Con
					</th>

					<th title="Contact email">
						Email
					</th>

					<th title="Contact email">
						Hotel
					</th>

				</tr>

			</thead>

			<tbody>
<%perl>
			foreach my $id (
				sort {$school_data{$a}{"short_name"} cmp $school_data{$b}{"short_name"}}
				keys %school_data
			) {

				next unless $school_data{$id}{"unrejected"};
				my $hotel = Tab::Hotel->retrieve($school_settings{$id}{"hotel"});
</%perl>

				<tr>

					<td class="nospace smallish">
						<a
							class="full padvert plain"
							target="_blank"
							href="/register/school/edit.mhtml?school_id=<% $id %>"
						><% $school_data{$id}{"short_name"} %></a>
					</td>

					<td class="nospace centeralign">
						<% $school_data{$id}{"state"} %>
					</td>

					<td class="contact centeralign redtext semibold">
						<%
							$school_settings{$id}{"contact_name"}
							&& $school_settings{$id}{"contact_number"}
							&& $school_settings{$id}{"contact_email"}
							? "" : "N"
						%>
					</td>

					<td class="pending centeralign smallish">
						<span class="hidden">
							<% $school_data{$id}{"pending"}
								? $school_data{$id}{"pending"}
								: 0
							%>
						</span>
						<% $school_data{$id}{"pending"}
							? $school_data{$id}{"pending"}
							: ""
						%>
					</td>
					<td class="pending centeralign smallish">
						<% $school_data{$id}{"last_created"}
							? $school_data{$id}{"last_created"}
							: ""
						%>
					</td>

					<td class="rejected centeralign">
						<% $school_data{$id}{"unrejected"}
							? $school_data{$id}{"unrejected"}
							: ""
						%>
					</td>

					<td class="incomplete centeralign">
						<span class="hidden">
						<% $school_data{$id}{"incomplete"}
							? $school_data{$id}{"incomplete"}
							: 0
						%>
						</span>
						<% $school_data{$id}{"incomplete"}
							? $school_data{$id}{"incomplete"}
							: ""
						%>
					</td>

					<td class="redtext centeralign semibold">
						<% $school_settings{$id}{"judging_unmet"} ? "N" : "" %>
					</td>

					<td class="incom_judges centeralign">
						<span class="hidden">
							<% $school_data{$id}{"incom_judges"}
								? $school_data{$id}{"incom_judges"}
								: 0
							%>
						</span>
						<% $school_data{$id}{"incom_judges"}
							? $school_data{$id}{"incom_judges"}
							: ""
						%>
					</td>

					<td class="smaller">
						<% $school_settings{$id}{"contact_name"} %>
					</td>

					<td class="smaller nospace">
						<a
							class = "plain padvert hover"
							href  = "mailto:<% $school_settings{$id}{"contact_email"} %>">
						<% $school_settings{$id}{"contact_email"} %>
						</a>
					</td>


					<td class="smaller nospace">
%						print $hotel->name if $hotel; 
					</td>

				</tr>
%			}

			</tbody>
		</table>
	</div>
