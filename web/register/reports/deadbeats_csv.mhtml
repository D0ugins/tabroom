<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

    my $name = $tourn->name;
    $name =~ s/[\W_]//g;
    my $filename = "NonZeroBalances-$name.csv";

	$m->clear_buffer;
    $r->content_type('application/csv');
    $r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	$m->print("School, Balance, Onsite Contact, Contact Number, ");
	$m->print("Contact Email, Refund Payable, Refund Address \n");

	foreach my $school (sort {$a->name cmp $b->name} $tourn->schools) {

		my ($total, $feline_ref, $total_ref) 
			= $m->comp("/funclib/school_fees.mas", 
				school         => $school,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				all            => 1
			);

		next if $total == -0;

		$m->print('"'.$school->name.'",');
		$m->print('"'.sprintf("%.2f", $total ).'",');
		$m->print('"'.$school->setting("contact_name").'",');
		$m->print('"'.$school->setting("contact_number").'",');
		$m->print('"'.$school->setting("contact_email").'",');
		$m->print('"'.$school->setting("refund_payable").'",');
		$m->print('"'.$school->setting("refund_address")."\"\n");


	} # end of foreach school

	$m->abort;

</%init>
