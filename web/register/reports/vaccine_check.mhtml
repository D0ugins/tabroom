<%args>
	$tourn
	$perms
	$person
	$tourn_settings
	$person_settings
</%args>
<%init>
	unless ($tourn_settings->{"vaccines"}) {
		$m->comp("/funclib/abort.mas", message => "VaccineCheck is not enabled for this tournament"
	};

	my $dbh = Tab::DBI->db_Main();

	my $tag = "vaccine_".$tourn->id;

	my $entry_sth = $dbh->prepare("
		select
			entry.id entry, entry.code, event.abbr,
			CONCAT('S',student.id) as id, student.first as altfirst, student.last as altlast,
			'Entry' as type,
			school.name schoolname, school.state,
			person.id person, person.first, person.last, person.email, person.phone, vaccine.value vaccine

		from (school, entry, entry_student es, student)

			left join person on student.person = person.id
			left join event on event.id = entry.event
			left join person_setting vaccine on vaccine.person = person.id and vaccine.tag = ?

		where school.tourn = ?
			and school.id = entry.school
			and entry.id = es.entry
			and es.student = student.id
			and entry.active = 1
		group by person.id, student.id
	");

	$entry_sth->execute($tag, $tourn->id);

	my $judge_sth = $dbh->prepare("
		select
			judge.id judge, judge.code, category.abbr, 'Judge' as type,
			CONCAT('j',judge.id) as id, judge.first as altfirst, judge.last as altlast,
			school.name schoolname, school.state,
			person.id person, person.first, person.last, person.email, person.phone, vaccine.value vaccine

		from (category, judge)

			left join person on judge.person = person.id
			left join school on school.id = judge.school
			left join person_setting vaccine on vaccine.person = person.id and vaccine.tag = ?

		where category.tourn = ?
			and category.id = judge.category
			and judge.active = 1
	");

	$judge_sth->execute($tag, $tourn->id);

	my $entref = $entry_sth->fetchall_hash();
	my $judref = $judge_sth->fetchall_hash();

	my %entries = map {$_->{"id"} =>  $_} @{$entref};
	my %judges = map {$_->{"id"} =>  $_} @{$judref};
	my %people = (%entries, %judges);

</%init>

	<div class="blankfull">

		<span class="threequarters nospace">
			<h4>VaccineCheck Status</h4>
		</span>
		<span class="quarter rightalign nospace" id="vaccine_buttonarea">
		</span>

		<& "/funclib/tablesorter.mas", table => "vaccine" &>

		<table id="vaccine">

			<thead>
				<tr class="yellowrow">
					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						School
					</th>

					<th>
						Type
					</th>

					<th>
						Event
					</th>

					<th>
						Email
					</th>

					<th class="hiddencsv">
						Tel
					</th>
					<th class="hide_fromcsv">
						Tel
					</th>

					<th class="hiddencsv">
						Status
					</th>

					<th class="hide_fromcsv">
						Status
					</th>
				</tr>
			</thead>

			<tbody>
<%perl>
				foreach my $pid (
					sort {
						$people{$a}{"state"} cmp $people{$b}{"state"}
						|| $people{$a}{"schoolname"} cmp $people{$b}{"schoolname"}
						|| $people{$a}{"type"} cmp $people{$b}{"type"}
						|| $people{$a}{"abbr"} cmp $people{$b}{"abbr"}
						|| $people{$a}{"last"} cmp $people{$b}{"last"}
					} keys %people
				) {

					$people{$pid}{"phone"} =~ s/^1//g;
</%perl>
					<tr>
						<td class="smallish">
							<% $people{$pid}{"first"} ? $people{$pid}{"first"} : $people{$pid}{"altfirst"} %>
						</td>

						<td class="smallish">
							<% $people{$pid}{"last"} ? $people{$pid}{"last"} : $people{$pid}{"altlast"} %>
						</td>

						<td class="smallish">
							<% $people{$pid}{"schoolname"}  %>
						</td>

						<td class="centeralign smallish">
							<% $people{$pid}{"type"}  %>
						</td>

						<td class="centeralign smallish">
							<% $people{$pid}{"abbr"}  %>
						</td>

						<td class="leftalign smallish">
							<a href="mailto: <% $people{$pid}{"email"} %>" class="plain hover padvertless marno">
							<% $people{$pid}{"email"} %>
							</a>
						</td>

						<td class="leftalign smallish hiddencsv">
							<% $people{$pid}{"phone"} %>
						</td>

						<td class="leftalign smallish hide_fromcsv">
							<% Tab::phoneme($people{$pid}{"phone"}) %>
						</td>

						<td class="hiddencsv">
							<% $people{$pid}{"vaccine"} %>
						</td>

						<td class="nospace hide_fromcsv nowrap smallish">
							<span class="hiddencsv"><% $people{$pid}{"vaccine"} %></span>
%							if ($people{$pid}{"person"}) {
								<label for="<% $people{$pid}{"person"} %>_done">
									<span title="Completed check" class="third nospace centeralign hover nowrap">
										<input
											type         = "radio"
											id           = "<% $people{$pid}{"person"} %>_done"
											name         = "<% $people{$pid}{"person"} %>"
											person_id    = "<% $people{$pid}{"person"} %>"
											setting_name = "vaccine"
											value        = "done"
											<% $people{$pid}{"vaccine"} eq "done" ? "checked" : "" %>
											onChange     = "postSwitch(this, 'vaccine_switch.mhtml');"
										> OK
									</span>
								</label>

								<label for="<% $people{$pid}{"person"} %>_in_progress">
									<span title="Process in progress" class="third nospace centeralign hover nowrap">
										<input
											type         = "radio"
											id           = "<% $people{$pid}{"person"} %>_in_progress"
											name         = "<% $people{$pid}{"person"} %>"
											person_id    = "<% $people{$pid}{"person"} %>"
											setting_name = "vaccine"
											value        = "in_progress"
											<% $people{$pid}{"vaccine"} eq "in_progress" ? "checked" : "" %>
											onChange     = "postSwitch(this, 'vaccine_switch.mhtml');"
										> IP
									</span>
								</label>

								<label for="<% $people{$pid}{"person"} %>_none">
									<span title="Process was not begun" class="third nospace centeralign hover nowrap">
										<input
											type         = "radio"
											id           = "<% $people{$pid}{"person"} %>_none"
											name         = "<% $people{$pid}{"person"} %>"
											person_id    = "<% $people{$pid}{"person"} %>"
											setting_name = "vaccine"
											value        = 0
											<% $people{$pid}{"vaccine"} ? "" : "checked"%>
											onChange     = "postSwitch(this, 'vaccine_switch.mhtml');"
										> NO
									</span>
								</label>

%							} else {
								<span title="Person must be linked to a Tabroom account to record vaccine status" class="full nospace centeralign redtext">
									UNLINKED
								</span>
%							}
						</td>
					</tr>
%				}
			</tbody>
		</table>
	</div>
