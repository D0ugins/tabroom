<%args>
	$tourn
	$tourn_settings
	$session
</%args>
<%init>

	Tab::Student->columns(TEMP => "years");
	Tab::Student->columns(TEMP => "schoolname");
	Tab::Student->columns(TEMP => "schoolstate");
	Tab::Student->columns(TEMP => "eventabbr");

	Tab::Student->set_sql(nationals_years => "

		select student.*, count(distinct(year(points.startdate))) as years, 
			chapter.name as schoolname, 
			chapter.state as schoolstate, 
			group_concat(distinct(event.abbr) SEPARATOR ', ') as eventabbr

		from (student, entry_student, entry, school, event, chapter) 

			left join points.NEW_USERS nsda_person
				on nsda_person.user_id = student.nsda

			left join points.NEW_POINTS points
				on nsda_person.ualt_id = points.student_id
				and points.event_cat_id = 4

		where student.id = entry_student.student
		and student.chapter = chapter.id
		and entry_student.entry = entry.id
		and entry.active = 1 
		and entry.school = school.id
		and school.tourn = ? 

		and entry.event = event.id

		group by student.id
		order by chapter.state, chapter.name, entry.id, entry.name

	");

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "nats_years"
	&>


	<div class="main">

		<span class="threequarters">
			<h4>Nationals Attendance</h4>
		</span>

		<span 
			class="quarter rightalign"
			id="attendance_buttonarea"
		></span>

		<& "/funclib/tablesorter.mas", table => "attendance" &> 

		<table id="attendance">

			<thead>
				<tr class="yellowrow smallish">

					<th>
						First
					</th>

					<th>
						Middle
					</th>

					<th>
						Last
					</th>

					<th>
						School
					</th>
					<th>
						State
					</th>

					<th>
						Event
					</th>

					<th>
						Nationals
					</th>

				</tr>
			</thead>

%		foreach my $student (Tab::Student->search_nationals_years($tourn->id)) { 

			<tr>
				<td>
					<% $student->first %>
				</td>

				<td>
					<% $student->middle %>
				</td>

				<td>
					<% $student->last %>
				</td>

				<td>
					<% $student->schoolname %>
				</td>
				<td>
					<% $student->schoolstate %>
				</td>

				<td>
					<% $student->eventabbr %>
				</td>

				<td class="centeralign">
					<% $student->years %>
				</td>

			</tr>

%		}

		</table>

	</div>
