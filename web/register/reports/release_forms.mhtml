<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "release_forms"
	&>

	<div class="main">

		<span class="threequarters nospace">
			<h4>Release Form Status</h4>
		</span>

		<span
			class = "quarter nospace rightalign"
			id    = "formy_buttonarea"
		> </span>

		<& "/funclib/tablesorter.mas", table => "formy" &>

		<table id="formy">

		<thead>

			<tr class="yellow">
				<th>
					School
				</th>

				<th>
					First
				</th>

				<th>
					Last
				</th>

				<th>
					Event
				</th>

				<th>
					Code(s)
				</th>

				<th title="Waitlist status">
					WL
				</th>

				<th>
					Forms
				</th>

				<th>
				</th>
			</tr>

		</thead>

		<tbody>

<%perl>

			foreach my $school ($tourn->schools) {

				my %release_forms = eval {
					return %{JSON::decode_json($school->setting("release_forms"))};
				};

				my $school_name = $school->short_name();

				my @students = $m->comp(
					"/funclib/school_students.mas",
						school   => $school,
						waitlist => 1
					);

				foreach my $student (@students) {

					my $events = $student->event;
					$events =~ s/,/, /g;

					my $codes = $student->code;
					$codes =~ s/,/, /g;

</%perl>
					<tr>
						<td class="nospace">
							<a
								href="/register/school/edit.mhtml?school_id=<% $school->id %>"
								class="white full padtop padbottom"
							>
								<% $school_name %>
							</a>
						</td>

						<td>
							<% $student->first %>
						</td>

						<td>
							<% $student->last %>
						</td>

						<td>
							<% $events %>
						</td>

						<td>
							<% $codes %>
						</td>

						<td class='centeralign'>
							<% $student->status ? "Y" : "N" %>
						</td>

						<td class='centeralign'>
							<span class="hidden">
								<% $release_forms{$student->id}
									? "1"
									: "0"
								%>
							</span>
							<span class="fa fa-lg padless
								<% $release_forms{$student->id}
									? "greentext fa-check"
									: "redtext fa-times"
								%>
							">
							</span>
						</td>

						<td class='centeralign'>
%							if ($release_forms{$student->id}) {
								<span class="hidden">1</span>
								<a
									class="fa-sm fa fa-arrow-down bluetext buttonwhite"
%									if ($tourn_settings->{"nsda_nats"}) {
	                               	href = "<% $Tab::s3_url %>/<% $tourn->id."/".$school->id."/releases/".$student->id."/".$release_forms{$student->id} %>"
%									} else {
	                               	href  = "<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$school->id."/".$student->id."/".$release_forms{$student->id} %>"
%									}
								></a>
%							} else {
								<span class="hidden">0</span>
%							}
						</td>

					</tr>

%				}

%			}

		</tbody>

		</table>

	</div>
