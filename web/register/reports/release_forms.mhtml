<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

	Tab::SchoolSetting->set_sql( releases => "
		select distinct school_setting.*
		from school_setting, school
		where school.tourn = ? 
		and school_setting.school = school.id
		and school_setting.tag like 'entry_release%'
		order by school.id
	");

	my @settings = Tab::SchoolSetting->search_releases($tourn->id);

	my %settings_by_tag = map {$_->tag => $_} @settings;

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "release_forms"
	&>

	<div class="main">

		<h4>Release Form Status</h4>

		<& "/funclib/tablesorter.mas", table => "formy" &>

		<table id="formy">

		<thead>

			<tr class="yellow"> 
				<th>
					School
				</th>

				<th>
					First
				</th>

				<th>
					Last
				</th>

				<th>
					Event
				</th>

				<th>
					Code(s)
				</th>

				<th title="Waitlist status">
					WL
				</th>

				<th>
					Forms
				</th>

				<th>
				</th>
			</tr>

		</thead>

		<tbody>

<%perl>

			foreach my $school ($tourn->schools) { 

				my $school_name = $school->short_name();

				my @students = $m->comp("/funclib/school_students.mas", school => $school, waitlist => 1);

				foreach my $student (@students) { 

					my $events = $student->event;
					$events =~ s/,/, /g;

					my $codes = $student->code;
					$codes =~ s/,/, /g;

</%perl>
					<tr>
						<td class="nospace">
							<a 
								href="/register/school/edit.mhtml?school_id=<% $school->id %>"
								class="white full padtop padbottom"
							>
								<% $school_name %>
							</a>
						</td>

						<td>
							<% $student->first %>
						</td>

						<td>
							<% $student->last %>
						</td>

						<td>
							<% $events %>
						</td>

						<td>
							<% $codes %>
						</td>

						<td class='centeralign'>
							<% $student->status ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<span class="hidden">
								<% $settings_by_tag{"entry_release_".$student->id}
									? "1"
									: "0"
								%>
							</span>
							<span class="buttonwhite fa fa-sm padless
								<% $settings_by_tag{"entry_release_".$student->id}
									? "greentext fa-check" 
									: "redtext fa-times"
								%>
							">
							</span>
						</td>

						<td class='centeralign'>
%							if ($settings_by_tag{"entry_release_".$student->id}) { 
								<span class="hidden">1</span>
								<a 
									class="fa-sm fa fa-arrow-down bluetext buttonwhite"
	                                href  = "<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$school->id."/".$student->id."/".$school->setting("entry_release_".$student->id) %>"
								></a>
%							} else { 

								<span class="hidden">0</span>
%							}
						</td>


					</tr>

%				}

%			}

		</tbody>

		</table>

	</div>
