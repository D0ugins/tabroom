<%args>
	$tourn
	$session
	$sort_by => "name"
</%args>
<%init>

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;

    my $filename = "SchoolList-".$name."-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`;

	open (CSVOUT, ">$filepath.csv");

	my $ncfl++ if $tourn->setting("ncfl");

	my @schools = $tourn->schools;
	@schools = sort { $a->name cmp $b->name } @schools;
	@schools = sort { $a->region->code cmp $b->region->code } @schools if ($ncfl);

	my $dbh = Tab::DBI->db_Main();

	my $category_sth = $dbh->prepare("
		select school.id, category.abbr, count(entry.id)
		from school, entry, event, category
		where category.tourn = ? 
		and category.id = event.category
		and event.id = entry.event
		and entry.school = school.id
		group by school.id
		order by school.code
	");

	$category_sth->execute($tourn->id);

	my %school_category_count;
	my %categories;

	while ( 
		my ($school_id, $category_abbr, $entry_count) = $sth->fetchrow_array()
	) { 

		$school_category_count{$school_id}{$category_abbr} = $entry_count;
		$categories{$category_abbr}++;
	}

	print CVSOUT "Name,School,State,Country,Contact,Number,Email";

	foreach my $key (sort {$a cmp $b} keys %categories) { 
		print CSVOUT ",".$key;
	}

	print CSVOUT "\n";

	foreach my $school (@schools) { 

		next if ($school->name eq "Unaffiliated");

		print CSVOUT '"'.$school->name.'",';
		print CSVOUT '"'.$school->code.'",' unless $ncfl;
		print CSVOUT '"'.$school->chapter->state.'",' unless $ncfl;
		print CSVOUT '"'.$school->chapter->country.'",' unless $ncfl;
		print CSVOUT '"'.$school->region->name.'",' if $ncfl;
		print CSVOUT '"'.$school->region->code.'",' if $ncfl;

		print CSVOUT '"'.$school->setting("contact_name").'",';
		print CSVOUT '"'.Tab::phoneme($school->setting("contact_number")).'",';
		print CSVOUT '"'.$school->setting("contact_email").'",';

		foreach my $key (sort {$a cmp $b} keys %categories) { 
			print CSVOUT $school_category_count{$school->id}{$key};
			print CSVOUT ",";
		}

		print CSVOUT "\n";
	}

	close CSVOUT;
	$m->redirect("$Tab::url_prefix/tmp/$filename.csv");


</%init>

