<%args>
	$tourn
	$session
	$sort_by => "name"
</%args>
<%init>

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;

    my $filename = "SchoolCodes-$name.csv";
    $m->clear_buffer;
    $r->content_type('text/csv');
    $r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	my $ncfl++ if $tourn->setting("ncfl");

	my @schools = $tourn->schools;
	@schools = sort { $a->name cmp $b->name } @schools;
	@schools = sort { $a->region->code cmp $b->region->code } @schools if ($ncfl);

	my $dbh = Tab::DBI->db_Main();

	my $category_sth = $dbh->prepare("
		select school.id, category.abbr, count(entry.id)
		from school, entry, event, category
		where category.tourn = ? 
		and category.id = event.category
		and event.id = entry.event
		and entry.school = school.id
		and entry.active = 1
		group by school.id, category.id
		order by school.code
	");

	$category_sth->execute($tourn->id);

	my %school_category_count;
	my %categories;

	while ( 
		my ($school_id, $category_abbr, $entry_count) 
		= $category_sth->fetchrow_array()
	) { 

		$school_category_count{$school_id}{$category_abbr} = $entry_count;
		$categories{$category_abbr}++;
	}

	$m->print("Name,School,State,Country,Contact,Number,Email");

	foreach my $key (sort {$a cmp $b} keys %categories) { 
		$m->print(",".$key);
	}

	$m->print("\n");

	foreach my $school (@schools) { 

		next if ($school->name eq "Unaffiliated");

		$m->print('"'.$school->name.'",');

		if ($ncfl) { 
			$m->print('"'.$school->region->name.'",' );
			$m->print('"'.$school->region->code.'",' );
		} else { 
			$m->print('"'.$school->code.'",' );
			$m->print('"'.$school->chapter->state.'",' );
			$m->print('"'.$school->chapter->country.'",' );
		}

		$m->print('"'.$school->setting("contact_name").'",');
		$m->print('"'.Tab::phoneme($school->setting("contact_number")).'",');
		$m->print('"'.$school->setting("contact_email").'",');

		foreach my $key (sort {$a cmp $b} keys %categories) { 
			$m->print($school_category_count{$school->id}{$key});
			$m->print(",");
		}

		$m->print("\n");
	}

	$m->abort();


</%init>

