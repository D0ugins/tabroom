<%args>
	$tourn
	$tourn_settings
	$mode => "pdf"
</%args>
<%init>

	our $pagesize = 45; 
	our $line = $pagesize + 2;
	our $counter;

	my $dbh = Tab::DBI->db_Main(); 

	my $sth = $dbh->prepare("

		select school.name, school.state, district.name, district.code, 
			(SELECT sum(appear) FROM points.NAT_APPEARANCES WHERE school_id = chapter.nsda) 
			as appearances

		from (school, district, chapter)

		where school.tourn = ? 
		and school.chapter = chapter.id
		and school.district = district.id

		and exists ( 
			select entry.id
			from entry
			where entry.school = school.id
			and entry.active = 1 
		)

		order by school.state, school.name
	");

	$sth->execute($tourn->id);

	my %school;

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "nats_attended"
	&>

	<div class="main">

		<span class="threequarters nospace">
			<h4>Schools &amp; Appearances</h4>
		</span>

		<span 	
			class = "quarter rightalign"
			id    = "school_appearances_buttonarea"
		></span>

		<& "/funclib/tablesorter.mas", table => "school_appearances" &>

		<table id="school_appearances">

			<thead>
				<tr class="yellowrow">

					<th>
						School
					</th>

					<th>
						State
					</th>

					<th>
						District
					</th>

					<th>
						DCode
					</th>

					<th>
						Appearances
					</th>

				</tr>
			</thead>

			<tbody>
<%perl>
				while ( 
				
					my (
						$school_name, $school_state, $district_name, $district_code, $appearances
					) = $sth->fetchrow_array()

				) { 
</%perl>


				<tr>

					<td>
						<% $school_name %>
					</td>

					<td>
						<% $school_state %>
					</td>

					<td>
						<% $district_name %>
					</td>

					<td>
						<% $district_code %>
					</td>

					<td class='rightalign'>
						<% $appearances + 1 %>
					</td>

				</tr>

%				}

			</tbody>

		</table>

	</div>


