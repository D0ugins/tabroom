<%args>
	$tourn
	$tourn_settings
	$session
</%args>
<%init>

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;

    my $filename = "ContactSheets-".$name."-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`;

    $m->comp("/funclib/printout.mas", 
		tourn    => $tourn,
		filename => $filename,
		head     => 1,
		array    => 3.2 
	);

    my $now = DateTime->now;    
    $now->set_time_zone($tourn->tz);

	my $tourn_start = $tourn->start;
    
    open (TEXOUT, ">>$filepath.tex");

	my %school_settings = 
		$m->comp("/funclib/school_settings.mas", 
			tourn => $tourn,
			value => 1
	);

    my $logo_file = $tourn_settings->{"logo"};

	if ($logo_file && (not defined -e "$Tab::file_root/tmp/".$logo_file)) { 
	    system "cd $Tab::file_root/tmp; 
		$Tab::latex_path_prefix/wget ".$Tab::s3_url."/".$tourn->id."/".$logo_file;
	}

	my $logo_block;

	if ($logo_file && -e "$Tab::file_root/tmp/".$logo_file) { 

        $logo_block .= "\\vspace{-8mm}\n";
        $logo_block .= "\\begin{center}\n";
        $logo_block .= "\\includegraphics[width=1.5in,height=1in,keepaspectratio]{".$logo_file."}\n";
        $logo_block .= "\\end{center}\n";

        $logo_block .= "\\vspace{-4mm}\n";
		$logo_block .= "{\\bf \\normalsize \\color{black!64} ".Tab::texify(uc($tourn->name))." } \n";

    } else { 
		$logo_block .= "{\\bf \\normalsize \\color{black!64} ".Tab::texify(uc($tourn->name))." } \n";
		undef $logo_file;
    }   

	my $notfirst;

	print TEXOUT "\\large\n";

	foreach my $school (
		sort { $a->short_name cmp $b->short_name } 
		$tourn->schools
	) {

		print TEXOUT "\\newpage\n" if $notfirst++;

		print TEXOUT "\\noindent\n";

		print TEXOUT "\\begin{minipage}{5in}\n";

		print TEXOUT "{\\bf \\huge ".Tab::texify($school->short_name)." } \n";

		print TEXOUT "\\medskip\n";
		print TEXOUT "\\newline\n";

		print TEXOUT "{\\Large \\bf \\color{black!64} SCHOOL CONTACT SHEET }\n";

		print TEXOUT "\\end{minipage}\n";

		print TEXOUT "\\hspace{8mm}\n";

		print TEXOUT "\\begin{minipage}{2in}\n";

		print TEXOUT "\\raggedleft\n" unless $logo_file;
		print TEXOUT "\\centering\n" if $logo_file;

			print TEXOUT $logo_block;

		print TEXOUT "\\end{minipage}\n";

		print TEXOUT "\\vspace{.25in}\n";
		print TEXOUT "\\newline\n";

		print TEXOUT "\\begin{tabular}{|p{2.0in}|p{5in}|}\n";

		print TEXOUT "\\hline\n";
		print TEXOUT  "School name: & ";
		print TEXOUT &Tab::texify($school->short_name);
		print TEXOUT " \\\\ \\hline\n";

		print TEXOUT  "School code: & ";
		print TEXOUT &Tab::texify($school->code);
		print TEXOUT " \\\\ \\hline\n";

		print TEXOUT  "Primary Contact: & ";
		print TEXOUT &Tab::texify($school_settings{$school->id}{"contact_name"});
		print TEXOUT " \\\\ \\hline\n";

		print TEXOUT  "Contact Email: & ";
		print TEXOUT &Tab::texify($school_settings{$school->id}{"contact_email"});
		print TEXOUT " \\\\ \\hline\n";

		my $number = $school_settings{$school->id}{"contact_number"};
		$number =~ s/[\D_]//g;

		print TEXOUT  "Contact Phone: & ";
		print TEXOUT &Tab::texify(Tab::phoneme($number));
		print TEXOUT " \\\\ \\hline\n";

		if ($tourn_settings->{"nsda_ms_nats"}) { 

			$number = $school_settings{$school->id}{"second_contact_number"};
			$number =~ s/[\D_]//g;

			print TEXOUT "Backup Contact Phone: & ";
			print TEXOUT &Tab::texify(Tab::phoneme($number));
			print TEXOUT " \\\\ \\hline\n";

			print TEXOUT  "Hotel & ";
			print TEXOUT &Tab::texify($school_settings{$school->id}{"contact_hotel"});
			print TEXOUT " \\\\ \\hline\n";

			print TEXOUT  "Number of Hotel Rooms & ";
			print TEXOUT &Tab::texify($school_settings{$school->id}{"contact_hotel_rooms"});
			print TEXOUT " \\\\ \\hline\n";

			my $checkout_date = $school_settings{$school->id}{"contact_hotel_checkout"};
			undef $checkout_date if $checkout_date < $tourn_start;

			print TEXOUT "Hotel Checkout Date & ";
			print TEXOUT &Tab::texify(Tab::niceshortdayte($checkout_date));
			print TEXOUT " \\\\ \\hline\n";

			if ($school->chapter) { 
				print TEXOUT "Coach Credits: & ";
				print TEXOUT &Tab::texify($school->chapter->setting("coaches"));
				print TEXOUT " \\\\ \\hline\n";
			}

		}


		print TEXOUT "\\end{tabular}\n";

	}

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		tail     => 1 );

</%init>

