<%args>
	$tourn
	$person
	$session
</%args>
<%init>
	use POSIX;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now;    
    $now->set_time_zone($tz);

    my $name = $tourn->name;
    $name =~ s/[\W_]//g;

    my $filename = "PersonsInAttendance-$name.csv";
	$m->clear_buffer;
    $r->content_type('application/csv');
    $r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

    my $dbh = Tab::DBI->db_Main(); 
	
	my $student_sth = $dbh->prepare('
		select student.first, student.last, 
			event.abbr, 
			chapter.id,chapter.name, chapter.state, 
			region.name

		from (student, entry_student, event, entry, school, chapter)
		left join region on region.id = school.region

		where event.tourn = ? 
		and event.id = entry.event
		and entry.id = entry_student.entry
		and entry_student.student = student.id
		and entry.school = school.id
		and school.chapter = chapter.id
		group by student.id
		order by school.id 
	');

	$student_sth->execute($tourn->id);

	my %bodies_by_school = ();
	my %chapters;

    while( 
		my (
			$student_first, $student_last, 
			$event_code, 
			$chapter_id, $chapter_name, $chapter_state, 
			$region_name
		)
		= $student_sth->fetchrow_array() 
	) { 

		my $person = ({
			first  => $student_first,
			last   => $student_last,
			type   => "student",
			event  => $event_code,
			school => $chapter_name,
			state  => $chapter_state,
			region => $region_name
		});

		push @{$bodies_by_school{$chapter_id}}, $person;

		$chapters{$chapter_id} = $chapter_name;

	}

	my $judge_sth = $dbh->prepare('
		select judge.first, judge.last, 
			category.abbr,
			chapter.id, chapter.name, chapter.state, 
			region.name

		from (judge, category)

		left join school on school.id = judge.school
		left join region on region.id = school.region
		left join chapter on chapter.id = school.chapter

		where category.tourn = ? 
		and category.id = judge.category
		group by judge.id
		order by school.id 
	');

	$judge_sth->execute($tourn->id);

    while( 
		my (
			$judge_first, $judge_last, 
			$event_code, 
			$chapter_id, $chapter_name, $chapter_state, 
			$region_name
		)
		= $judge_sth->fetchrow_array() 
	) { 

		$chapter_name =~ s/Hired //g;

		my $person = ({
			first  => $judge_first,
			last   => $judge_last,
			type   => "judge",
			event  => $event_code,
			school => $chapter_name,
			state  => $chapter_state,
			region => $region_name
		});


		$chapter_id = 0 unless $chapter_id;

		$chapters{$chapter_id} = $chapter_name;

		push @{$bodies_by_school{$chapter_id}}, $person;
	}

	$m->print("First,Last,School,State,Type,Event,Diocese\n");

	foreach my $chapter_id (
		sort {$chapters{$a} cmp $chapters{$b}} 
		keys %bodies_by_school
	) { 

		foreach my $person (@{$bodies_by_school{$chapter_id}}) { 

			$m->print('"'.$person->{"first"}.'"');
			$m->print(',');
			$m->print('"'.$person->{"last"}.'"');
			$m->print(',');
			$m->print('"'.$person->{"school"}.'"');
			$m->print(',');
			$m->print('"'.$person->{"state"}.'"');
			$m->print(',');
			$m->print('"'.$person->{"type"}.'"');
			$m->print(',');
			$m->print('"'.$person->{"event"}.'"');
			$m->print(',');
			$m->print('"'.$person->{"region"}.'"');
			$m->print("\n");

		}

	}

	$m->flush_buffer();
	$m->abort;

</%init>
