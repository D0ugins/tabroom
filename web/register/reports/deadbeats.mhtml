<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

	my $whoami = "deadbeats";

	my %category_settings;
	my %event_settings;

	my @categories = $tourn->categories();
	my @events = $tourn->events();
	my @concessions = $tourn->concessions();

	foreach my $category (@categories) { 
		%{$category_settings{$category->id}} = $category->all_settings();
		$category_settings{$category->id}{"shifts"} = $category->shifts(type => "strike");
	}

	foreach my $event (@events) { 
		%{$event_settings{$event->id}} = $event->all_settings();
		$event_settings{$event->id}{"fee"} = $event->fee;
	}

	my @entries = $m->comp(
		"/funclib/tourn_entries.mas", 
			tourn => $tourn,
			all   => 1
	);

	my %school_entries;

	foreach my $entry (@entries) { 
		push @{$school_entries{$entry->schoolid}}, $entry;
	}

	my @judges = $m->comp(
		"/funclib/tourn_judges.mas", 
			tourn => $tourn,
			all   => 1
	);

	my %school_judges;

	foreach my $judge (@judges) { 
		push @{$school_judges{$judge->schoolid}{$judge->categoryid}}, $judge;
		push @{$school_judges{$judge->schoolid}{"all"}}, $judge;
	}

	my @fines = $m->comp(
		"/funclib/tourn_fines.mas", 
			tourn => $tourn,
			all   => 1
	);

	my %school_fines;

	foreach my $fine (@fines) { 
		push @{$school_fines{$fine->schoolid}}, $fine;
	}

	my @hotels = $tourn->hotels;

	if (@hotels) { 
		%{$tourn_settings->{$tourn->id}{"hotels"}} =
			map {$_->id => $_} @hotels;
	}

	my @hires = $m->comp(
		"/funclib/tourn_hires.mas",
		tourn => $tourn 
	);

	my %school_hires;
	foreach my $hire (@hires) { 
		push @{$school_hires{$hire->schoolid}{$hire->categoryid}}, $hire;
		push @{$school_hires{$hire->schoolid}{"all"}}, $hire;
	}


</%init>

	<script>

		function showOwed () { 

			$(".owed").removeClass('hidden');
			$(".owed").addClass('row');

			$(".owing").addClass('hidden');
			$(".owing").removeClass('row');

			$(".controls").removeClass("invert");
			$("#showOwed").addClass('invert');

			zebraRows();
		};

		function showOwing () { 

			$(".owing").removeClass('hidden');
			$(".owing").addClass('row');

			$(".owed").addClass('hidden');
			$(".owed").removeClass('row');

			$(".controls").removeClass("invert");
			$("#showOwing").addClass('invert');

			zebraRows();
		};

		function showBoth () { 
			$(".owing").removeClass('hidden');
			$(".owed").removeClass('hidden');

			$(".owing").addClass('row');
			$(".owed").addClass('row');

			$(".controls").removeClass("invert");
			$("#showBoth").addClass('invert');

			zebraRows();
		}

	</script>


	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => $whoami
	&>

	<div class="main">

		<div class="full nospace">

			<span class="half">
				<h4>Schools with non zero balances </h4>
			</span>

			<span class="half nospace rightalign">

				<a 
					id="showOwing"
					class="buttonwhite bluetext controls hover smallish"
					onClick="showOwing();";
				>
					Owing
				</a>

				<a 
					id="showOwed"
					class="buttonwhite bluetext controls hover smallish"
					onClick="showOwed();";
				>
					Refunds
				</a>

				<a 
					id="showBoth"
					class="buttonwhite bluetext invert controls hover smallish"
					onClick="showBoth();";
				>
					Show Both
				</a>

				<a 
					href="deadbeats_csv.mhtml" 
					class="buttonwhite greentext fa fa-lg fa-file-excel-o"
				></a>
			</span>

		</div>

		<& "/funclib/tablesorter.mas", 
			table     => "sortme",
			nobuttons => 1
		&>

		<table id="sortme">

			<thead>

				<tr class="smallish yellowrow">

					<th>
						School Name
					</th>

					<th>
						Direction
					</th>

					<th>
						Amount
					</th>

					<th>
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

			foreach my $school (sort {$a->name cmp $b->name} $tourn->schools) {


				my ($total, $feline_ref, $total_ref) = 
					$m->comp("/funclib/school_fees.mas", 
						school            => $school,
						tourn             => $tourn,
						tourn_settings    => $tourn_settings,
						categories        => \@categories,
						category_settings => \%category_settings,
						events            => \@events,
						concession_array  => \@concessions,
						event_settings    => \%event_settings,
						all               => 1,
						bulk              => 1,
						entries           => $school_entries{$school->id},
						judges            => $school_judges{$school->id},
						fines             => $school_fines{$school->id},
						hires             => $school_hires{$school->id}
					);

				next if $total == -0;
				next if $total > 0 && $whoami eq "owed_only";
				next if $total < 0 && $whoami eq "owing_only";

</%perl>
				<tr class="row <% $total < 0 ? "owed" : "owing" %>">
					
					<td>
						<a 
							class="white" 
							target="_blank"
							href="/register/school/edit.mhtml?school_id=<% $school->id %>"
						>
							<% $school->name %>
						</a>
					</td>
				
					<td>
						<% ($total < 0) ? "Refund Due:" : "Owes:" %>
					</td> 
				
					<td class="rightalign code">
						<% sprintf ("%.2f", $total ) %>
					</td>

					<td class="centeralign nospace">
						<a 
							class  = "bluetext buttonwhite fa fa-lg fa-credit-card"
							target = "_blank"
							title  = "Edit money screen"
							href   = "/register/school/invoice.mhtml?school_id=<% $school->id %>"
						>
						</a>
						<a 
							class  = "redtext buttonwhite fa fa-lg fa-file-pdf-o"
							target = "_blank"
							title  = "Printable invoice"
							href   = "/register/school/invoice_print.mhtml?school_id=<% $school->id %>"
						>
						</a>
					</td>
					
				</tr>

%			} # end of foreach school

			</tbody>

		</table>

	</div>


