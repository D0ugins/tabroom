<%args> 
	$session
	$tourn
	$tourn_settings
	$person
</%args>
<%init>

    my @students = $m->comp("/funclib/tourn_students.mas", tourn => $tourn); 
	my @judges = $m->comp("/funclib/tourn_judges.mas", tourn => $tourn);
	my @schools = $tourn->schools;
	my @regions = $m->comp("/funclib/tourn_regions.mas", tourn => $tourn); 
	
	my @jpools = $m->comp("/funclib/tourn_jpools.mas", tourn => $tourn);

	my $switch = 1;
	
	my $now = DateTime->now;    
	$now->set_time_zone($tourn->tz);

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;

    my $filename = "TournStats-$name-".$session->id;
	my $filepath = $Tab::file_root."tmp/".$filename;
	`rm -f $filepath.*`; 
	
	$m->comp("/funclib/printout.mas", 
		tourn    => $tourn,
		filename => $filename,
		head     => 1 
	);

	open (TEXOUT, ">>$filepath.tex");

	print TEXOUT "\\noindent\n";
	print TEXOUT "\\hfill {\\LARGE \\bf ".Tab::texify($tourn->name)." } \n ";
	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\strut \\hfill {\\bf \\normalsize Printed: ". Tab::nicedt($now)." } \n";
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\newline\n";

	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\begin{tabular}{p{3in}p{3.5in}}\n";
	print TEXOUT "\\multicolumn{2}{l}{\\bf Overall Statistics }\\\\ \n";
	print TEXOUT "\\hline \n";

	if ($tourn_settings->{"ncfl"} || $tourn_settings->{"regions"} ) { 

		print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
		print TEXOUT "Total number of Dioceses" if $tourn_settings->{"ncfl"};
		print TEXOUT "Total number of regions" if $tourn_settings->{"regions"};
		print TEXOUT " & ". scalar @regions." \\\\ \n";

	}

	print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
	print TEXOUT "Total number of schools & ".scalar @schools." \\\\ \n";

	print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
	print TEXOUT "Total number of students & ".scalar @students." \\\\ \n";

	print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
	print TEXOUT "Total number of judges & ".scalar @judges." \\\\ \n";

	print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
	print TEXOUT "Total number of people & ".(scalar @students + scalar @judges)." \\\\ \n";

	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\medskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\begin{tabular}{p{3in}p{3.5in}}\n";
	print TEXOUT "\\multicolumn{2}{l}{\\bf Entry numbers by event }\\\\ \n";
	print TEXOUT "\\hline \n";

	foreach my $event (sort {$a->name cmp $b->name} $tourn->events) { 

		print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\[5.5pt\]\[5.5pt\]\n" if $switch++ % 2;

		print TEXOUT $event->name." & ";

		print TEXOUT scalar Tab::Entry->search( 
			event  => $event,
			active => 1
		);

	 	print TEXOUT " \\\\ \n";
	}

	print TEXOUT "\\end{tabular}\n";

	print TEXOUT "\\medskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\medskip\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\begin{tabular}{p{3in}p{3.5in}}\n";
	print TEXOUT "\\multicolumn{2}{l}{\\bf Judge numbers by category }\\\\ \n";
	print TEXOUT "\\hline \n";

	foreach my $category ($tourn->categories) { 

		print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

		print TEXOUT $category->name." & ".scalar $category->judges." \\\\ \n";;

	}

	print TEXOUT "\\end{tabular}\n";

	if (@jpools) { 

		print TEXOUT "\\medskip\n";
		print TEXOUT "\\newline\n";
		print TEXOUT "\\medskip\n";
		print TEXOUT "\\normalsize\n";
		print TEXOUT "\\begin{tabular}{p{2.5in}p{3.75in}}\n";
		print TEXOUT "\\multicolumn{2}{l}{\\bf Judge numbers by jpool }\\\\ \n";
		print TEXOUT "\\hline \n";

		foreach my $jpool (@jpools) { 

			print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);
			print TEXOUT $jpool->name." & ".scalar $jpool->judges." \\\\ \n";;

		}
		
		print TEXOUT "\\end{tabular}\n";

	}

	$m->comp("/funclib/printout.mas", 
		tourn    => $tourn,
		filename => $filename,
		tail     => 1 
	);

</%init>
