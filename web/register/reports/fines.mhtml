<%args>
	$tourn
	$tourn_settings
	$show_deleted => undef
	$all          => undef
</%args>
<%init>

    my %balances = $m->comp(
        "/funclib/balances.mas",
        tourn          => $tourn,
        tourn_settings => $tourn_settings
    );

	my %dts;

</%init>

	<div class="blankfull">

		<& "/funclib/tablesorter.mas",
			table => "fines"
		&>

		<span class="threequarters nospace">
			<h4>Fines &amp; Payments</h4>
		</span>

		<span
			class = "quarter nospace rightalign"
			id    = "fines_buttonarea"
		> </span>

		<table id="fines">

			<thead>

				<tr class="ltyellow">

					<th>
						School
					</th>

					<th>
						Reason
					</th>

					<th>
						Amount
					</th>

					<th>
						Levied
					</th>

					<th>
						Levied by
					</th>

					<th>
						Payment?
					</th>

					<th>
						Balance
					</th>

				</tr>

			</thead>

			<tbody>
<%perl>

				my $dbh = Tab::DBI->db_Main();

				my $sth = $dbh->prepare("
					select fine.id, fine.reason, fine.amount, fine.payment, fine.levied_at,
						school.id, school.name, school.code,
						levied.email, levied.first, levied.last

					from (fine)

						left join school on fine.school = school.id
						left join person levied on levied.id = fine.levied_by

					where fine.tourn = ?
					and fine.deleted != 1

					order by fine.levied_at desc
				");

				$sth->execute($tourn->id);

				while (
					my (
						$fine_id, $fine_reason, $fine_amount, $fine_payment, $fine_levied_at,
						$school_id, $school_name, $school_code,
						$levied_email, $levied_first, $levied_last
					) = $sth->fetchrow_array()
				) {

					my $levied_dt;
					my $tag = substr($fine_levied_at, 0, 16);

					if ($dts{$tag}) {
						$levied_dt = $dts{$tag};
					} else {
						$levied_dt = eval {
							return DateTime::Format::MySQL->parse_datetime($fine_levied_at);
						};

						if ($levied_dt) {
							$levied_dt->set_time_zone("UTC");
							$levied_dt->set_time_zone($tourn->tz);
							$dts{$tag} = $levied_dt;
						}
					}

</%perl>
					<tr>
						<td class="nospace">
							<a
								class  = "white full padvert"
								target = "_blank"
								href   = "/register/school/invoice.mhtml?school_id=<% $school_id %>"
							> <% Tab::short_name($school_name) %></a>
						</td>

						<td>
							<% $fine_reason %>
						</td>

						<td class="rightalign">
							<% sprintf "%.2f", $fine_amount %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $levied_dt ? $levied_dt->epoch : "" %></span>
							<& "/funclib/showdt.mas", dt => $levied_dt, length => "csv" &>
						</td>

						<td>
							<% $levied_email %>
						</td>

						<td class="centeralign">
							<span class="hidden"><% $fine_payment ? "1" : "0" %></span>
							<% $fine_payment ? "Y" : "" %>
						</td>

						<td class="rightalign">
							<% $balances{$school_id}{"balance"} %>
						</td>

					</tr>
%				}
			</tbody>
		</table>
	</div>

