<%args>
	$tourn
	$tourn_settings
	$show_deleted => undef
	$all          => undef
</%args>
<%init>

    my %balances = $m->comp(
        "/funclib/balances.mas",
        tourn          => $tourn,
        tourn_settings => $tourn_settings
    );

</%init>

	<div class="blankfull">

		<& "/funclib/tablesorter.mas",
			table => "fines"
		&>

		<span class="threequarters nospace">
			<h4>Fines &amp; Payments</h4>
		</span>

		<span
			class = "quarter nospace rightalign"
			id    = "fines_buttonarea"
		> </span>

		<table id="fines">

			<thead>

				<tr class="ltyellow">

					<th>
						School
					</th>

					<th>
						Reason
					</th>

					<th>
						Amount
					</th>

					<th>
						Levied
					</th>

					<th>
						Levied by
					</th>

					<th>
						Payment?
					</th>

					<th>
						Balance
					</th>

				</tr>

			</thead>

			<tbody>
<%perl>

				my $dbh = Tab::DBI->db_Main();

				my $sth = $dbh->prepare("
					select fine.id, fine.reason, fine.amount, fine.payment, fine.levied_at, fine.deleted,
						school.id, school.name, school.code,
						levied.email, levied.first, levied.last

					from (fine)

						left join school on fine.school = school.id
						left join person levied on levied.id = fine.levied_by

					where fine.tourn = ?

					order by fine.levied_at desc
				");

				$sth->execute($tourn->id);

				while (
					my (
						$fine_id, $fine_reason, $fine_amount, $fine_payment, $fine_levied_at, $fine_deleted,
						$school_id, $school_name, $school_code,
						$levied_email, $levied_first, $levied_last
					) = $sth->fetchrow_array()
				) {

</%perl>
					<tr>
						<td class="nospace">
							<a
								class  = "white full padvert"
								target = "_blank"
								href   = "/register/school/invoice.mhtml?school_id=<% $school_id %>"
							> <% Tab::short_name($school_name) %></a>
						</td>

						<td>
							<% $fine_reason %>
						</td>

						<td class="rightalign">
							<% sprintf "%.2f", $fine_amount %>
						</td>

						<td class="rightalign">
							<% $fine_levied_at %>
						</td>

						<td>
							<% $levied_email %>
						</td>

						<td class="centeralign">
							<span class="hidden"><% $fine_payment ? "1" : "0" %></span>
							<% $fine_payment ? "Y" : "" %>
						</td>

						<td class="rightalign">
							<% $balances{$school_id}{"balance"} %>
						</td>

					</tr>

%				}

			</tbody>


		</table>

	</div>




