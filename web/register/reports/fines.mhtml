<%args>
	$tourn
	$tourn_settings
	$show_deleted => undef
	$all          => undef
</%args>

	<div class="blankfull">

		<& "/funclib/tablesorter.mas", 
			table => "fines"
		&>

		<span class="threequarters nospace">
			<h4>Fines and Fees Register</h4>
		</span>

		<span 
			class = "quarter nospace rightalign"
			id    = "fines_buttonarea"
		>
			<a 
				href  = "fines.mhtml?all=1"
				class = "buttonwhite <% $all ? "invert" : "" %> bluetext fa fa-plus"
				title = "Show all deleted"
			></a>
		</span>

		<table id="fines">

			<thead>
				
				<tr class="ltyellow">

					<th>
						School
					</th>

					<th>
						Reason
					</th>

					<th>
						Amount
					</th>

					<th>
						Levied
					</th>

					<th>
						Levied by
					</th>

%					if ($all) { 

						<th>
							Payment?
						</th>
		
						<th>
							Deleted?
						</th>

						<th>
							Deleted by
						</th>

						<th>
							Deleted at
						</th>
%					}

					<th>
						Balance
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
				foreach my $school (sort {$a->name cmp $b->name} $tourn->schools) { 

					my @fines = Tab::Fine->search( 
						school  => $school->id,
						deleted => 0
					);

					@fines = Tab::Fine->search( 
						school => $school->id
					) if $show_deleted;

					next unless @fines;

					my ($fee_total, $feline_ref) = $m->comp(
						"/funclib/school_fees.mas",
							entry_fees     => 1,
							payments       => 1,
							show_deleted   => $show_deleted,
							ignore_judging => $tourn_settings->{"ncfl"},
							school         => $school,
							tourn          => $tourn,
							tourn_settings => $tourn_settings,
						);

					foreach my $fine (@fines) { 

						unless ($all) { 
							next if $fine->deleted;
							next if $fine->payment;
						}

</%perl>
						<tr>

							<td>
								<% $school->short_name %>
							</td>

							<td>
								<% $fine->reason %>
							</td>

							<td class="rightalign">
								<% sprintf "%.2f", $fine->amount %>
							</td>

							<td class="rightalign">
								<% Tab::csvdt($fine->levied_at) %>
							</td>

							<td>
								<% $fine->levied_by ? $fine->levied_by->email : "" %>
							</td>

%							if ($all) { 

								<td class="rightalign">
									<% $fine->payment ? "Y" : "" %>
								</td>

								<td class="rightalign">
									<% $fine->deleted ? "Y" : "" %>
								</td>

								<td class="rightalign">
									<% $fine->deleted_by ? $fine->deleted_by->email : "" %>
								</td>

								<td class="rightalign">
									Tab::csvdt(<% $fine->deleted_at %>)
								</td>
%							}

							<td class="rightalign">
								<% $fee_total %>
							</td>

						</tr>

%					}

%				}
			</tbody>


		</table>

	</div>




