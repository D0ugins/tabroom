<%args>
	$tourn
	$tourn_settings
	$session
	$event_id => undef
</%args>
<%init>

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;

    my $now = DateTime->now;    
    $now->set_time_zone($tourn->tz) if $tourn->tz;

    my $filename = "USADebate-RegSheets-".$name."-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`;

	my $event = Tab::Event->retrieve($event_id);

    $m->comp("/funclib/printout.mas", 
		tourn    => $tourn,
		filename => $filename,
		head     => 1 
	);
    
    open (TEXOUT, ">>$filepath.tex");

	my $logo_file = $tourn_settings{"logo"};

	if ($logo_file && (not defined -e "$Tab::file_root/tmp/".$logo_file)) { 
		system "cd $Tab::file_root/tmp; 
		$Tab::latex_path_prefix/wget ".$Tab::s3_url."/".$tourn->id."/".$logo_file;
	}

	unless ($logo_file && -e "$Tab::file_root/tmp/".$logo_file) { 
		undef $logo_file;
	}

    my $dbh = Tab::DBI->db_Main();

    my $student_registration_sth = $dbh->prepare("

	    select student.first, student.middle, student.last, student.ualt_id,
        entry.code, entry.name,
        chapter.id, chapter.name, chapter.state,
        school.id, school.name, school.code, region.name, region.code

        from entry, entry_student, student, school,region, chapter
        where entry.event = ?  

        and entry_student.entry = entry.id
        and entry_student.student = student.id
        and entry.school = school.id

        and school.region = region.id
        and student.chapter = chapter.id

        group by student.id   
        order by region.code, chapter.name

	");

	$student_registration_sth->execute($event->id);

	my %schools; 
	my %entries; 

	my @keys_in_order; 

	while (my ($first, $middle, $last, $merit_id, 
		$entry_code, $entry_name,
		$chapter_id, $chapter_name, $chapter_state,
		$district_id, $district_name, $district_code,
		$state_name, $state_code) = 

			$student_registration_sth->fetchrow_array()  ) {

		$schools{$chapter_id}{"district_id"} = $district_id;
		$schools{$chapter_id}{"district_name"} = $district_name;
		$schools{$chapter_id}{"district_code"} = $district_code;

		$schools{$chapter_id}{"chapter_state"} = $chapter_state;
		$schools{$chapter_id}{"chapter_name"} = $chapter_name;

		$schools{$chapter_id}{"state_name"} = $state_name;
		$schools{$chapter_id}{"state_code"} = $state_code;

		my %student = ();

		$student{"first"} = $first;
		$student{"middle"} = $middle;
		$student{"last"} = $last;
		$student{"merit_id"} = $merit_id;
		$student{"entry_code"} = $entry_code;
		$student{"entry_name"} = $entry_name;
		$student{"chapter_id"} = $chapter_id;
		$student{"chapter_name"} = $chapter_name;

		push @{$schools{$chapter_id}{"students"}}, \%student;
		push @{$schools{$chapter_id}{"entries"}}, $entry_code;

		push @{$entries{$entry_code}{"students"}}, \%student;
		push @{$entries{$entry_code}{"entry_name"}}, $entry_name;

		push @keys_in_order, $chapter_id;

	}

	my $message = $tourn->setting("disclaimer");

	if ($message) { 
		my $strip = HTML::Strip->new();
		$message =~ s/\<li\>//g;
		$message =~ s/\<\/li\>/\n/g;
		$message =~ s/\n/\n\n/g;
		$message =~ s/\r/\n\n/g;
		$message =~ s/<br \/>/\n\n/g;
		$message =~ s/<strong>/GERFLUCKBOLDFACE/g;
		$message =~ s/<\/strong>/ENDBOLDFACEPLZ/g;
		$message =~ s/\&nbsp;/ /g;
		$message = $strip->parse( $message );
		$message =~ s/^\s+//;
		$message =~ s/\s+$//;
		chomp $message;
		$message = &Tab::texify($message);
		$message =~ s/\n\n\n\n/\n\n/g;
		$message =~ s/\n\n\n\n/\n\n/g;
		$message =~ s/\n\n/\n\\vspace{.1in}\n\\newline\n/g;
		$message =~ s/GERFLUCKBOLDFACE/{\\bf /g;
		$message =~ s/ENDBOLDFACEPLZ/ }/g;
	}

	my %seen = (); 
	@keys_in_order = grep { ! $seen{$_} ++ } @keys_in_order;

	my $tabular = "\\begin{tabular}{p{.75in}p{2.75in}p{3in}}\n";

	foreach my $chapter_id (@keys_in_order) { 

		print TEXOUT "\\noindent\n";

		if ($logo_file) {
			print TEXOUT "\\begin{minipage}[l]{1.5in}\n";
			print TEXOUT "\\includegraphics[height=1in,width=1in,keepaspectratio]{".$logo_file."}\n";
			print TEXOUT "\\end{minipage}\n";
			print TEXOUT "\\begin{minipage}[r]{5in}\n";
		} else { 
			print TEXOUT "\\begin{minipage}[r]{6.5in}\n";
		}

		print TEXOUT "{\\huge \\bf ".$tourn->start->year." ".Tab::texify($tourn->name)." } \n";
		print TEXOUT "\\medskip\n\\newline\n";
		print TEXOUT "{\\Large \\bf \\color{black!64}  REGISTRATION } \n";
		print TEXOUT "\\end{minipage}\n";

		print TEXOUT "\\vspace{.2in}\n";
		print TEXOUT "\\newline\n";

		print TEXOUT "\\begin{minipage}[l]{5in}\n";
			
		print TEXOUT "{\\bf \\Huge ";
		print TEXOUT Tab::texify($schools{$chapter_id}{"chapter_name"});
		print TEXOUT "}  \n";

		print TEXOUT "\\end{minipage}\n";

		print TEXOUT "\\begin{minipage}[r]{2in}\n";

		print TEXOUT "\\hfill ";

		print TEXOUT "{\\bf \\color{black!64}  \\Large ";
		print TEXOUT Tab::texify($schools{$chapter_id}{"district_name"}); 
		print TEXOUT "} \n";
		print TEXOUT "\\smallskip\n";
		print TEXOUT "\\newline\n";

		print TEXOUT "\\noindent ";
		print TEXOUT "\\strut \\hfill ";
		print TEXOUT "{\\bf \\color{black!64}  \\Large ";
		print TEXOUT Tab::texify($schools{$chapter_id}{"state_name"}); 
		print TEXOUT "} \n";

		print TEXOUT "\\newline\n";

		print TEXOUT "\\noindent ";
		print TEXOUT "\\strut \\hfill ";
		print TEXOUT "{\\bf \\color{black!64}  \\large ";
		print TEXOUT Tab::texify($schools{$chapter_id}{"district_code"}); 
		print TEXOUT "/".Tab::texify($schools{$chapter_id}{"state_code"}); 
		print TEXOUT "} \n";

		print TEXOUT "\\end{minipage}\n";

		my $switch;
		my %done;

		foreach my $entry_code (@{$schools{$chapter_id}{"entries"}}) { 

			next if $done{$entry_code}++;

			print TEXOUT "\\vspace{.2in}\n";
			print TEXOUT "\\newline\n";
			print TEXOUT "\\normalsize\n";


			print TEXOUT "{\\bf \\color{black!64}  \\Large Team ".Tab::texify($entry_code)." } \n";
			print TEXOUT "\\smallskip\n";
			print TEXOUT "\\newline\n";

			foreach my $student_ref (@{$schools{$chapter_id}{"students"}}) {

				next unless ${$student_ref}{"entry_code"} eq $entry_code; 

				print TEXOUT "\\newline\n";
				print TEXOUT $tabular;
				print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" unless ($switch++ % 2);

				print TEXOUT Tab::texify(${$student_ref}{"merit_id"});
				print TEXOUT " & ";
				print TEXOUT Tab::texify(${$student_ref}{"first"})." ";
				print TEXOUT Tab::texify(${$student_ref}{"middle"})." ";
				print TEXOUT Tab::texify(${$student_ref}{"last"});
				print TEXOUT " & ";
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\end{tabular}\n";
			}

			my $notfirst;
			undef $switch;

			foreach my $other_student_ref (@{$entries{$entry_code}{"students"}}) { 

				next if ${$other_student_ref}{"chapter_id"} eq $chapter_id;

				unless ($notfirst++) {
					print TEXOUT "\\vspace{.2in}\n";
					print TEXOUT "\\newline\n";
					print TEXOUT "{\\large \\bf \\color{black!64} ";
					print TEXOUT "District Teammates"; 
					print TEXOUT " } \n ";
					print TEXOUT "\\smallskip\n";
					print TEXOUT "\\newline\n";
				}

				print TEXOUT "\\newline\n";
				print TEXOUT $tabular;
				print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" unless ($switch++ % 2);

				print TEXOUT Tab::texify(${$other_student_ref}{"merit_id"});
				print TEXOUT " & ";
				print TEXOUT Tab::texify(${$other_student_ref}{"first"})." ";
				print TEXOUT Tab::texify(${$other_student_ref}{"middle"})." ";
				print TEXOUT Tab::texify(${$other_student_ref}{"last"});
				print TEXOUT " & ";
				print TEXOUT Tab::texify(${$other_student_ref}{"chapter_name"});
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\end{tabular}\n";
		
			}

			undef $notfirst;
			undef $switch;

			my @judges = Tab::Judge->search( 
				school => $schools{$chapter_id}{"district_id"}
			);

			foreach my $judge (@judges) { 

				unless ($notfirst++) {
					print TEXOUT "\\vspace{.2in}\n";
					print TEXOUT "\\newline\n";
					print TEXOUT "{\\large \\bf \\color{black!64} ";
					print TEXOUT " District Judging ";
					print TEXOUT " } \n ";
					print TEXOUT "\\smallskip\n";
					print TEXOUT "\\newline\n";
				}

				print TEXOUT "\\newline\n";
				print TEXOUT $tabular;
				print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" unless ($switch++ % 2);

				print TEXOUT " & ";
				print TEXOUT Tab::texify($judge->first." ".$judge->last); 
				print TEXOUT " & ";
				print TEXOUT Tab::texify($judge->setting("real_school"));
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\end{tabular}\n";

			}

		}

		if ($message) { 
			print TEXOUT "\\vspace{.4in}\n";
			print TEXOUT "\\newline \n ";

			print TEXOUT "\\noindent\n ";
			print TEXOUT $message;
		}

		print TEXOUT "\\newpage\n";

	}

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		tail     => 1 );

</%init>

