<%args>
	$tourn
	$session
	$event_id => undef
</%args>
<%init>

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;

    my $now = DateTime->now;    
    $now->set_time_zone($tourn->tz) if $tourn->tz;

    my $filename = "USADebate-RegSheets-".$name."-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`;

	my $event = Tab::Event->retrieve($event_id);

    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, head => 1 );
    
    open (TEXOUT, ">>$filepath.tex");

	my $logo_file = $tourn->setting("logo");
	system "cd $Tab::file_root/tmp; $Tab::latex_path_prefix/wget ".$Tab::s3_url."/".$tourn->id."/".$logo_file if $logo_file;

    my $dbh = Tab::DBI->db_Main();

    my $student_registration_sth = $dbh->prepare("
		select student.first, student.middle, student.last, student.ualt_id,
			entry.code, entry.name,
			chapter.name, chapter.state,
			school.id, school.name, school.code, region.name, region.code

			from student, chapter, school, region, entry_student, entry

			where entry.event = ? 
			and entry.school = school.id
			and school.region = region.id

			and entry.id = entry_student.student
			and entry_student.student = student.id
			and student.chapter = chapter.id

			group by student.id
			order by region.code, chapter.name
	");

	$student_registration_sth->execute($event->id);

	my %schools; 
	my %entries; 

	my @keys_in_order; 

	while (my ($first, $middle, $last, $merit_id, 
		$entry_code, $entry_name,
		$chapter_name, $chapter_state,
		$district_id, $district_name, $district_code,
		$state_name, $state_code) = 

			$student_registration_sth->fetchrow_array()  ) {

		$schools{$chapter_name}{"district_id"} = $district_id;
		$schools{$chapter_name}{"district_name"} = $district_name;
		$schools{$chapter_name}{"district_code"} = $district_code;

		$schools{$chapter_name}{"chapter_state"} = $chapter_state;
		$schools{$chapter_name}{"chapter_name"} = $chapter_name;

		$schools{$chapter_name}{"state_name"} = $state_name;
		$schools{$chapter_name}{"state_code"} = $state_code;

		my %student = ();

		$student{"first"} = $first;
		$student{"middle"} = $middle;
		$student{"last"} = $last;
		$student{"merit_id"} = $merit_id;
		$student{"entry_code"} = $entry_code;
		$student{"entry_name"} = $entry_name;

		push @{$schools{$chapter_name}{"students"}}, \%student;
		push @{$schools{$chapter_name}{"entries"}}, $entry_code;

		push @{$entries{$entry_code}{"students"}}, \%student;
		push @{$entries{$entry_code}{"entry_name"}}, $entry_name;

		push @keys_in_order, $chapter_name;

	}

	my $message = $tourn->setting("disclaimer");

	if ($message) { 
		my $strip = HTML::Strip->new();
		$message =~ s/\<li\>//g;
		$message =~ s/\<\/li\>/\n/g;
		$message =~ s/\r/\n\n/g;
		$message =~ s/\n/\n\n/g;
		$message =~ s/<br \/>/\n\n/g;
		$message =~ s/\&nbsp;/ /g;
		$message = $strip->parse( $message );
		$message =~ s/^\s+//;
		$message =~ s/\s+$//;
		chomp $message;
	}

	my %seen = (); 
	@keys_in_order = grep { ! $seen{$_} ++ } @keys_in_order;

	my $tabular = "\\begin{tabular}{p{.5in}p{1in}p{3in}}\n";

	foreach my $chapter_name (@keys_in_order) { 

		if ($logo_file && -e "$Tab::file_root/tmp/".$logo_file) { 
			print TEXOUT "\\begin{minipage}[c]{1.5in}\n";
			print TEXOUT "\\includegraphics[height=1in]{".$logo_file."}\n";
			print TEXOUT "\\end{minipage}\n";
			print TEXOUT "\\begin{minipage}[c]{5in}\n";
		} else { 
			print TEXOUT "\\begin{minipage}[c]{6.5in}\n";
		}

		print TEXOUT "{\\Large ".$tourn->start->year." ".Tab::texify($tourn->name)." } \n";
		print TEXOUT "\\medskip\n\\newline\n";
		print TEXOUT "{\\large \\bf \\color{black!64} ";
		print TEXOUT "REGISTRATION";
		print TEXOUT "\\end{minipage}\n";

		print TEXOUT "\\vspace{.2in}\n";
		print TEXOUT "\\newline\n";

		print TEXOUT Tab::texify($schools{$chapter_name}{"district_name"}); 
		print TEXOUT " \\hfill ";
		print TEXOUT "{\\large \\bf ".Tab::texify($chapter_name)." } ";
		print TEXOUT " \\hfill ";
		print TEXOUT Tab::texify($schools{$chapter_name}{"state_name"});

		print TEXOUT "\\vspace{.2in}\n";
		print TEXOUT "\\newline\n";

		my $switch;

		foreach my $entry_code (@{$schools{$chapter_name}{"entries"}}) { 

			print TEXOUT "{\\bf large Team ".Tab::texify($entry_code)." } \n";


			foreach my $student_ref (@{$schools{$chapter_name}{"students"}}) {

				next unless ${$student_ref}{"entry_code"} eq $entry_code; 

				print TEXOUT " & ";
				print TEXOUT Tab::texify(${$student_ref}{"merit_id"});
				print TEXOUT " & ";
				print TEXOUT Tab::texify(${$student_ref}{"first"})." ";
				print TEXOUT Tab::texify(${$student_ref}{"middle"})." ";
				print TEXOUT Tab::texify(${$student_ref}{"last"});
				print TEXOUT " & ";
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\end{tabular}\n";
			}

			my $notfirst;

			foreach my $other_student_ref (@{$entries{$entry_code}{"students"}}) { 

				next unless ${$other_student_ref}{"chapter_name"} eq $chapter_name;

				unless ($notfirst++) {
					print TEXOUT "\\vspace{.1in}\n";
					print TEXOUT "\\newline\n";
					print TEXOUT "{\\large \\bf \\color{black!64} ";
					print TEXOUT " Your teammates: ";
					print TEXOUT " } \n ";
				}

				print TEXOUT "\\newline\n";
				print TEXOUT $tabular;
				print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

				print TEXOUT " & ";
				print TEXOUT Tab::texify(${$other_student_ref}{"merit_id"});
				print TEXOUT " & ";
				print TEXOUT Tab::texify(${$other_student_ref}{"first"})." ";
				print TEXOUT Tab::texify(${$other_student_ref}{"middle"})." ";
				print TEXOUT Tab::texify(${$other_student_ref}{"last"});
				print TEXOUT " & ";
				print TEXOUT Tab::texify(${$other_student_ref}{"chapter_name"});
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\end{tabular}\n";
		
			}

			print TEXOUT "\\vspace{.1in}\n";
			print TEXOUT "\\newline\n";

			undef $notfirst;
			undef $switch;

			my @judges = Tab::Judge->search( school => $schools{$chapter_name}{"district_id"});

			foreach my $judge (@judges) { 

				unless ($notfirst++) {
					print TEXOUT "\\vspace{.1in}\n";
					print TEXOUT "\\newline\n";
					print TEXOUT "{\\large \\bf \\color{black!64} ";
					print TEXOUT " Your district judging: ";
					print TEXOUT " } \n ";
				}

				print TEXOUT "\\newline\n";
				print TEXOUT $tabular;
				print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" if ($switch++ % 2);

				print TEXOUT " & ";
				print TEXOUT Tab::texify($judge->first." ".$judge->last); 
				print TEXOUT " & ";
				print TEXOUT Tab::texify($judge->setting("real_school"));
				print TEXOUT "\\\\ \n";
				print TEXOUT "\\end{tabular}\n";

			}

		}

		if ($message) { 
			print TEXOUT "\\vspace{.2in}\n";
			print TEXOUT "\\newline \n ";

			print TEXOUT "\\footnotesize\n ";
			print TEXOUT "\\noindent\n ";
			print TEXOUT &Tab::texify($message);
		}

		print TEXOUT "\\newpage\n";

	}

    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1 );

</%init>

