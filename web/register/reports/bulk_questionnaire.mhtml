<%args>
	$tourn
	$tourn_settings
	$tag         => undef
	$category_id => undef
</%args>
<%init>

	use Switch;

	my $category = Tab::Category->retrieve($category_id);

	my @all_categories = $tourn->categories();
	$category = $all_categories[0] if scalar @all_categories == 1;

	my @keys;

	if ($category) { 

		foreach my $jpool (
			$m->comp("/funclib/category_jpools.mas", 
				category => $category,
				limit => "registrant"
			)
		) { 
			push @keys, $jpool->setting("paradigm_form") 
				if $jpool->setting("paradigm_form");
		}

		push @keys, $category->setting("paradigm_form") 
			if $category->setting("paradigm_form");
	}

	my %seen;
	@keys = grep { ! $seen{$_} ++ } @keys;

	if (scalar @keys == 1) { 
		$tag = $keys[0];
	}

	my $rtag = $tag;

	$rtag =~ s/[\W_]//g;
	undef $rtag unless $category;

	my %form = $m->comp(
		"/funclib/questions.mas", 
		tag => $rtag
	) if $rtag;

	my %answer_settings = $m->comp(
		"/funclib/judge_settings.mas", 
		category => $category,
		tag      => "form_".$rtag
	) if $rtag;

	my %diverse = $m->comp(
		"/funclib/judge_settings.mas",
		category => $category,
		tag      => "diverse"
	);

	push @keys, "NSDADiversity" if $tourn_settings->{"nsda_nats"};

</%init>

	<div class="blankfull">

	<span class="twenty">
		<a 
			href="index.mhtml" 
			title="return to reports"
			class="fa fa-lg fa-arrow-left bluetext buttonwhite"
		></a>
	</span>

	<span class="quarter">
		<h4 class="nospace">Paradigm Sheets</h4>
	</span>

	<form action="bulk_questionnaire.mhtml" method="post">

	<span class="threetenths centeralign">
		<select 
			name     = "category_id"
			class    = "fixedmed"
			onChange = "this.form.submit();"
		>
%			foreach my $ocat (@all_categories) { 
				<option 
					value="<% $ocat->id %>"
					<% $ocat == $category ? 'selected' : "" %>
				><% $ocat->name %></option>
%			}
		</select>
	</span>

	<span class="threetenths centeralign">

		<select 
			name     = "tag"
			class    = "fixedmed"
			onChange = "this.form.submit();"
		>
%			foreach my $key (@keys) { 
				<option 
					value="<% $key %>"
					<% $key eq $tag ? 'selected' : "" %>
				><% $key %></option>
%			}
		</select>
	</span>

	<span class="marno tenth rightalign"
		id="<% $tag %>_buttonarea"
	></span>

	<& "/funclib/tablesorter.mas", table => $tag &>

<%perl>

	if (keys %form) { 

		my @all_keys = sort keys %{$form{"questions"}};

		my @keys;

		foreach my $key (@all_keys) { 
			next if $form{"questions"}{$key}{"type"} eq "title";
			push @keys, $key;
		}

		@keys = 
			map  { $_->[0] } 
			sort { uc($a->[1]) cmp uc($b->[1]) } 
			map  { [$_, $_ =~ /(\D+)/] } 
			@keys;

		@keys = 
			map  { $_->[0] } 
			sort { $a->[1] <=> $b->[1] } 
			map  { [$_, $_ =~ /(\d+)/] } 
			@keys;

		my @judges = $m->comp("/funclib/category_judges.mas", category => $category);

</%perl>

		<table id="<% $tag %>">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						School
					</th>

					<th>
						Reg/St
					</th>

					<th>
						Div
					</th>

%					foreach my $key (@keys) { 
						<th title="<% $form{"questions"}{$key}{"question"} %>" >
							<% $key %>
						</th>
%					}

				</tr>

			</thead>

			<tbody>
<%perl>

			foreach my $judge (@judges) { 

				next unless $answer_settings{$judge->id};

				my %answers = eval { 
					return %{JSON::decode_json($answer_settings{$judge->id})} if $judge;
				};

</%perl>

				<tr>

					<td>
						<% $judge->first %>
					</td>

					<td>
						<% $judge->last %>
					</td>

					<td>
						<% $judge->schname %>
					</td>
					
					<td>
						<% $judge->regname %>
					</td>

					<td class='centeralign'>
						<% $diverse{$judge->id} ? "Y" : "" %>
					</td>

%					foreach my $key (@keys) { 
						<td class="<% $key == 4 ? 'nowrap rightalign' : "" %>">
							<% ucfirst($answers{$key}) %>
						</td>
%					}

				</tr>

%			}

		</tbody>

	</table>

%	}

	</div>
