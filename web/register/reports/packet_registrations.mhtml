<%args>
	$tourn
	$tourn_settings
	$session
	$judges     => undef
	$entries    => undef
	$no_invoice => undef
</%args>
<%init>

    my $name = $tourn->name;
    $name =~ s/[\W_]//g;

    my $filename = "EntryPackets-".$name."-".$session->id;
    $filename = "JudgePackets-".$name."-".$session->id if $judges;
    my $filepath = $Tab::file_root."tmp/".$filename;

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		head     => 1
	);

    my $now = DateTime->now;
    $now->set_time_zone($tourn->tz);

	my @schools;

	if ($session->weekend) {

		@schools = $m->comp(
			"/funclib/weekend_schools.mas",
			weekend => $session->weekend
		);

	} else {

		@schools =
			sort { $a->name cmp $b->name }
			$tourn->schools;
	}

    my $logo_file = $tourn_settings->{"logo"};

    if ($logo_file && (not defined -e "$Tab::file_root/tmp/".$logo_file)) {
        system "cd $Tab::file_root/tmp;
        $Tab::latex_path_prefix/wget ".$Tab::s3_url."/".$tourn->id."/".$logo_file;
    }

    unless ($logo_file && -e "$Tab::file_root/tmp/".$logo_file) {
        undef $logo_file;
    }

	my $notfirst;

	foreach my $school (@schools) {

		open (TEXOUT, ">>$filepath.tex");

		if ($notfirst++) {
			print TEXOUT "\\newpage\n";
		}

		print TEXOUT "\\noindent\n";

		if ($logo_file) {
			print TEXOUT "\\begin{minipage}[l]{1.5in}\n";
			print TEXOUT "\\includegraphics[height=1in,width=1in,keepaspectratio]{".$logo_file."}\n";
			print TEXOUT "\\end{minipage}\n";
			print TEXOUT "\\begin{minipage}[r]{5.65in}\n";
		} else {
			print TEXOUT "\\begin{minipage}[r]{7.15in}\n";
		}

		print TEXOUT "\\noindent\n";
		print TEXOUT "\\strut\n";
		print TEXOUT "\\hfill\n";

		print TEXOUT "{\\LARGE \\bf ".$tourn->start->year." ".Tab::texify($tourn->name)." } \n";
		print TEXOUT "\\medskip\n\\newline\n";
		print TEXOUT "\\noindent\n";
		print TEXOUT "\\strut\n";
		print TEXOUT "\\hfill\n";
		print TEXOUT "{\\Large \\bf \\color{black!64}  ".Tab::texify($school->name)." } \n";
		print TEXOUT "\\medskip\n\\newline\n";
		print TEXOUT "\\noindent\n";
		print TEXOUT "\\strut\n";
		print TEXOUT "\\hfill\n";
		print TEXOUT "{\\scriptsize \\color{black!64}  ";
		print TEXOUT "Code ".Tab::texify($school->code)." -- " if $school->code;
		print TEXOUT "Printed ".Tab::nicefulldate($now)." at ".Tab::nicetime($now)." } \\hspace{1mm} \n";
		print TEXOUT "\\end{minipage}\n";

		print TEXOUT "\\vspace{.2in}\n";
		print TEXOUT "\\newline\n";

		close TEXOUT;

		if ($tourn_settings->{'wsdc'}) {

			$m->comp("/register/school/print/reg_longform.mas",
				school_id => $school->id,
				filename  => $filename,
				judges    => $judges,
				entries   => $entries
			);

		} else {

			$m->comp("/register/school/print/registration.mas",
				school_id => $school->id,
				filename  => $filename,
				judges    => $judges,
				entries   => $entries,
				weekend   => $session->weekend
			);

			unless ($judges || $entries) {

				$m->comp("/register/school/print/housing.mas",
					school_id => $school->id,
					filename  => $filename
				) if $tourn_settings->{"housing"};
			}
		}


		unless ($no_invoice) {

			open (TEXOUT, ">>$filepath.tex");
			print TEXOUT "\\newpage\n";
			close TEXOUT;

			$m->comp("/register/school/print/invoice.mas",
				school         => $school,
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				filename       => $filename
			);
		}
	}

    $m->comp("/funclib/printout.mas",
		tourn    => $tourn,
		filename => $filename,
		tail     => 1
	);

</%init>
