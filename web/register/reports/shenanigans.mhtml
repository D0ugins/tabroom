<%args>
	$tourn
	$tourn_settings
	$person
	$session
	$debug
</%args>
<%init>

	my @judges = $m->comp("/funclib/tourn_judges.mas", tourn => $tourn);
	my %judges_by_name = ();

	foreach my $judge (@judges) {
		push (@{$judges_by_name{$judge->first.":".$judge->last}}, $judge);
	}

	my $switch;
	my $count = 1;

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			judge.id, judge.code, judge.first, judge.last, category.abbr, school.name, school.id,
			judge2.id, judge2.code, judge2.first, judge2.last, category2.abbr, school2.name, school2.id

		from (judge, category, judge judge2, category category2)
			left join school on judge.school = school.id
			left join school school2 on judge2.school = school2.id

		where category.tourn = ?
		and category2.tourn = category.tourn

        and judge.category = category.id
        and judge2.category = category2.id

		and judge.id > judge2.id

		and judge.first = judge2.first
		and judge.last = judge2.last
	");

	my %double_names;

	$sth->execute($tourn->id);

	while (
		my (
			$judge_id, $judge_code, $judge_first, $judge_last, $category_abbr, $school_name, $school_id,
			$judge2_id, $judge2_code, $judge2_first, $judge2_last, $category2_abbr, $school2_name, $school2_id
		) = $sth->fetchrow_array()
	) {

		my $namestring = $judge_first." ".$judge_last;

		unless ($double_names{$namestring}{$judge_id}) {
			$double_names{$namestring}{$judge_id}{'first'}     = $judge_first;
			$double_names{$namestring}{$judge_id}{'last'}      = $judge_last;
			$double_names{$namestring}{$judge_id}{'category'}  = $category_abbr;
			$double_names{$namestring}{$judge_id}{'school'}    = $school_name;
			$double_names{$namestring}{$judge_id}{'school_id'} = $school_id;
		}

		unless ($double_names{$namestring}{$judge2_id}) {
			$double_names{$namestring}{$judge2_id}{'first'}     = $judge2_first;
			$double_names{$namestring}{$judge2_id}{'last'}      = $judge2_last;
			$double_names{$namestring}{$judge2_id}{'category'}  = $category2_abbr;
			$double_names{$namestring}{$judge2_id}{'school'}    = $school2_name;
			$double_names{$namestring}{$judge2_id}{'school_id'} = $school2_id;
		}
	}

	$sth->finish();

	$sth = $dbh->prepare("
		select
			judge.id, judge.code, judge.first, judge.last, category.abbr, school.name, school.id,
			judge2.id, judge2.code, judge2.first, judge2.last, category2.abbr, school2.name, school2.id,
		  person.email, person.id

		from (judge, category, judge judge2, category category2, person)
			left join school on judge.school = school.id
			left join school school2 on judge2.school = school2.id

		where category.tourn = ?
		and category2.tourn = category.tourn

        and judge.category = category.id
        and judge2.category = category2.id

		and judge.id > judge2.id

		and judge.person = person.id
		and judge.person = judge2.person
	");

	my %double_accounts;

	$sth->execute($tourn->id);

	while (
		my (
			$judge_id, $judge_code, $judge_first, $judge_last, $category_abbr, $school_name, $school_id,
			$judge2_id, $judge2_code, $judge2_first, $judge2_last, $category2_abbr, $school2_name, $school2_id,
			$person_email, $person_id
		) = $sth->fetchrow_array()
	) {

		unless ($double_accounts{$person_id}{email}) {
			$double_accounts{$person_id}{email} = $person_email;
			$double_accounts{$person_id}{id} = $person_id;
		}

		unless ($double_accounts{$person_id}{$judge_id}) {
			$double_accounts{$person_id}{$judge_id}{'first'}     = $judge_first;
			$double_accounts{$person_id}{$judge_id}{'last'}      = $judge_last;
			$double_accounts{$person_id}{$judge_id}{'category'}  = $category_abbr;
			$double_accounts{$person_id}{$judge_id}{'school'}    = $school_name;
			$double_accounts{$person_id}{$judge_id}{'school_id'} = $school_id;
		}

		unless ($double_accounts{$person_id}{$judge2_id}) {
			$double_accounts{$person_id}{$judge2_id}{'first'}     = $judge2_first;
			$double_accounts{$person_id}{$judge2_id}{'last'}      = $judge2_last;
			$double_accounts{$person_id}{$judge2_id}{'category'}  = $category2_abbr;
			$double_accounts{$person_id}{$judge2_id}{'school'}    = $school2_name;
			$double_accounts{$person_id}{$judge2_id}{'school_id'} = $school2_id;
		}
	}

	$sth->finish();

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "shenanigans"
	&>

	<div class="main">

		<h2>
			I disapprove of your shenanigans
		</h2>

		<h4>Judges with matching names</h4>

%		foreach my $namestring (keys %double_names) {

			<div class="row">

				<span class="quarter semibold bluetext">
					<% $namestring %>
				</span>

				<span class="threequarters nospace">

%					foreach my $judge_id (keys %{$double_names{$namestring}}) {

%						next if $judge_id eq "email" || $judge_id eq "id";

						<div class="ltborderbottom nospace">

							<span class="fifth">
								<% $double_names{$namestring}{$judge_id}{'category'} %>
							</span>

							<span class="twofifths nospace">
								<a
									class="white full padvert"
									target="_blank"
									href="/register/judge/edit.mhtml?judge_id=<% $judge_id %>"
								><%
									$double_names{$namestring}{$judge_id}{'first'}
								%> <%
									$double_names{$namestring}{$judge_id}{'last'}
								%></a>
							</span>

							<span class="twofifths">
%								if ($double_names{$namestring}{$judge_id}{'school'}) {
									<a
										class  = "white full padvert"
										target = "_blank"
										href   = "/register/school/edit.mhtml?school_id=<% $double_names{$namestring}{$judge_id}{'school_id'} %>"
									><%
										$double_names{$namestring}{$judge_id}{'school'}
									%></a>
%								}
							</span>
						</div>
%					}
				</span>
			</div>
%		}

		<h4>Judges linked to a common account</h4>

%		foreach my $person_id (keys %double_accounts) {

			<div class="row">

				<span class="quarter semibold bluetext">
					<% $double_accounts{$person_id}{email} %> <br />
					ID <% $double_accounts{$person_id}{id} %>
				</span>

				<span class="threequarters nospace">

%					foreach my $judge_id (keys %{$double_accounts{$person_id}}) {

%						next if $judge_id eq "email" || $judge_id eq "id";

						<div class="ltborderbottom nospace">

							<span class="fifth">
								<% $double_accounts{$person_id}{$judge_id}{'category'} %>
							</span>

							<span class="twofifths nospace">
								<a
									class="white full padvert bluetext"
									target="_blank"
									href="/register/judge/edit.mhtml?judge_id=<% $judge_id %>"
								><%
									$double_accounts{$person_id}{$judge_id}{'first'}
								%> <%
									$double_accounts{$person_id}{$judge_id}{'last'}
								%></a>
							</span>

							<span class="twofifths">
%								if ($double_accounts{$person_id}{$judge_id}{'school'}) {
									<a
										class  = "white full padvert"
										target = "_blank"
										href   = "/register/school/edit.mhtml?judge_id=<% $double_accounts{$person_id}{$judge_id}{'school_id'} %>"
									><%
										$double_accounts{$person_id}{$judge_id}{'school'}
									%></a>
%								}
							</span>
						</div>
%					}
				</span>
			</div>
%		}

	</div>
