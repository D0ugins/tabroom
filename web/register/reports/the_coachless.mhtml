<%args>
	$tourn
</%args>
<%init>

	Tab::Entry->columns( TEMP => "chapternsda");
	Tab::Entry->columns( TEMP => "eventabbr");
	Tab::Entry->columns( TEMP => "schoolstate");
	Tab::Entry->columns( TEMP => "schoolname");

	Tab::Entry->set_sql( "coachless" => "
		select entry.*, chapter.nsda  as chapternsda, 
			event.abbr as eventabbr, school.name as schoolname,
			school.state as schoolstate

		from entry, school, chapter, event
		where school.tourn = ? 
		and school.chapter = chapter.id
		and school.id = entry.school
		and event.id = entry.event
		and entry.active = 1

		and not exists ( 
			select point.id
			from entry_setting point
			where point.entry = entry.id
			and point.tag = 'coach_points'
		)

		order by school.state, school.name, entry.name
	");

	my %coach_cache; 

</%init>

	<div class="blankfull">

		<span class="half">
			<h4>The Coachless</h4>
		</span>
		<span
			class="half rightalign"
			id="coachless_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas", table => "coachless" &> 

		<table id="coachless">

			<thead>
				<tr class="yellowrow">

					<th class='smallish'>
						Entry
					</th>

					<th class='smallish'>
						Event
					</th>

					<th class='smallish'>
						School
					</th>

					<th class='smallish'>
						State
					</th>

					<th class='smallish'>
						ID
					</th>

					<th class='smallish'>
						Coaches
					</th>
				</tr>

			</thead>

			<tbody>

<%perl>

				foreach my $entry (Tab::Entry->search_coachless($tourn->id)) {

					my @coaches;

					@coaches = @{$coach_cache{$entry->chapternsda}} 
						if $coach_cache{$entry->chapternsda};

					unless (@coaches) { 

						@coaches = $m->comp(
							"/funclib/nsda_school_coaches.mas", 
							nsda => $entry->chapternsda
						);

						$coach_cache{$entry->chapternsda} = \@coaches if @coaches;
					}

</%perl>
					<tr id="<% $entry->id %>">

						<td>
							<% substr($entry->name,0,32) %>
						</td>

						<td>
							<% $entry->eventabbr %>
						</td>

						<td>
							<% substr(Tab::short_name($entry->schoolname),0,16) %>
						</td>

						<td>
							<% $entry->schoolstate %>
						</td>

						<td class="rightalign">
							<% $entry->chapternsda %>
						</td>

						<td class="nospace">
%							foreach my $coach (@coaches) { 

								<div class="full nospace hover smallish">
									<span class="threefifths marno padless">
										<% $coach->ufname." ".$coach->ulname %>
									</span>
									<span class="true quarter rightalign marno">
										#<% $coach->ualt_id %>
									</span>
									<span class="eighth centeralign nospace smaller">
										<a 
											target_id    = "<% $entry->id %>"
											value        = "<% $coach->ualt_id %>"
											setting_name = "coach_points"
											on_success   = "destroy"
											class        = "fa fa-sm fa-plus buttonwhite bluetext padless smaller"
											onClick      = "postSwitch(this, '/register/entry/entry_switch.mhtml');"
										></a>
									</span>
								</div>
%							}

						</td>
					</tr>
%				}

			</tbody>

		</table>


	</div>
