<%args>
	$tourn
	$tourn_settings
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $bond_sth = $dbh->prepare("
		select school.id, school.name, fine.amount, chapter.nsda
		from school, fine, chapter
		where school.tourn = ?
			and fine.deleted != 1
			and school.id = fine.school
			and school.chapter = chapter.id
			and fine.reason = 'Judge bond'
	");

	my %schools;

	$bond_sth->execute($tourn->id);

	while (
		my ($school_id, $school_name, $fine_amount, $nsda_id) =
		$bond_sth->fetchrow_array()
	) {
		$schools{$school_id}{"name"} = $school_name;
		$schools{$school_id}{"id"}   = $nsda_id;
		$schools{$school_id}{"bond"} = $fine_amount;
	}

	my $lost_sth = $dbh->prepare("
		select school.id, school.name, fine.amount, chapter.nsda
		from school, fine, chapter
		where school.tourn = ?
			and school.id = fine.school
			and school.chapter = chapter.id
			and fine.reason like 'BOND REVOKED:%'
			and fine.deleted != 1
	");

	$lost_sth->execute($tourn->id);

	while (
		my ($school_id, $school_name, $fine_amount, $nsda_id) =
		$lost_sth->fetchrow_array()
	) {
		$schools{$school_id}{"name"}   = $school_name;
		$schools{$school_id}{"id"}     = $nsda_id;
		$schools{$school_id}{"revoke"} = $fine_amount;
	}

	my $more_sth = $dbh->prepare("
		select school.id, school.name, fine.amount, chapter.nsda
		from school, fine, chapter
		where school.tourn = ?
			and school.id = fine.school
			and school.chapter = chapter.id
			and fine.reason like 'JUDGE FINE%'
			and fine.deleted != 1
	");

	$more_sth->execute($tourn->id);

	while (
		my ($school_id, $school_name, $fine_amount, $nsda_id) =
		$more_sth->fetchrow_array()
	) {
		$schools{$school_id}{"name"}   = $school_name;
		$schools{$school_id}{"id"}     = $nsda_id;
		$schools{$school_id}{"more"}  += $fine_amount;
	}

	my $refund_sth = $dbh->prepare("
		select school.id, school.name, fine.amount, chapter.nsda
		from school, fine, chapter
		where school.tourn = ?
			and school.id = fine.school
			and school.chapter = chapter.id
			and fine.reason like 'Bond Refunded%'
			and fine.deleted != 1
	");

	$refund_sth->execute($tourn->id);

	while (
		my ($school_id, $school_name, $fine_amount, $nsda_id) =
		$refund_sth->fetchrow_array()
	) {
		$schools{$school_id}{"name"}   = $school_name;
		$schools{$school_id}{"id"}     = $nsda_id;
		$schools{$school_id}{"refund"} = $fine_amount;
	}

</%init>

	<div class="main">

		<span class="half">
			<h4>Bond Report</h4>
		</span>

		<span
			class = "half rightalign"
			id    = "bonds_buttonarea"
		></span>

		<& "/funclib/tablesorter.mas", table => "bonds" &>

		<table id="bonds">

			<thead>
				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						NSDA ID
					</th>

					<th>
						Bond
					</th>

					<th>
						Revoked
					</th>

					<th>
						Additional
					</th>

					<th>
						Refunded
					</th>

				</tr>
			</thead>

			<tbody>

%				foreach my $school_id (keys %schools) {

					<tr>

						<td class="nospace">
							<a
								href  = "/register/school/invoice.mhtml?school_id=<% $school_id %>"
								class = "full padvert marno"
							><% $schools{$school_id}{"name"} %></a>
						</td>

						<td>
							<% $schools{$school_id}{"id"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"bond"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"revoke"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"more"} %>
						</td>

						<td class="rightalign">
							<% $schools{$school_id}{"refund"} %>
						</td>

					</tr>

%				}

			</tbody>
		</table>
	</div>
