<%args> 
	$tourn
	$tourn_settings
	$person
	$region
	$category_id => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now(time_zone => $tz);

	my $hide_code = $tourn_settings->{"hide_codes"};

	my $category = Tab::Category->retrieve($category_id) 
		if $category_id;

	my %category_settings = $category->all_settings() 
		if $category;

	if ($category) { 

		my @judges = $m->comp(
			"/funclib/ncfl/covering_judges.mas",
			 diocese  => $region,
			 category => $category);

		my $tab_room++ if $category_settings{"tab_room"};

		my @elim_jpools = $m->comp(
			"/funclib/category_jpools.mas",
			 category => $category,
			 limit    => "ncfl_elims");

		my @prelim_jpools = $m->comp(
			"/funclib/category_jpools.mas",
			 category => $category,
			 limit    => "ncfl_prelims");

		my %judges_by_jpool = ();

		my @jpoolless_judges;

		if (@prelim_jpools) { 

			foreach my $judge (@judges) { 

				push (@jpoolless_judges, $judge) 
					unless $judge->setting("prelim_jpool");

				next unless $judge->setting("prelim_jpool");

				push (@{$judges_by_jpool{$judge->setting("prelim_jpool")}}, $judge);

			}

		}

		my $jpool_obligation;

		my @chapters = sort {$a->name cmp $b->name} $region->chapters;

		my $judge_burden = $m->comp(
			"/funclib/ncfl/judge_obligation.mas", 
			diocese  => $region,
			category => $category
		);

		my @events = sort {$a->name cmp $b->name} 
			$m->comp("/funclib/tourn_events.mas", tourn => $tourn);

	</%init>

		<& "menubar.mas",
			 tourn  => $tourn,
			 region => $region,
			 whoami => "judges" 
		&>
			
			<table>

				<tr class="yellowrow">

					<th class="smaller">
						<% $hide_code ? "" : "Code" %>
					</td>

					<th class="smaller">
						First
					</th>

					<th class="smaller">
						Last
					</th>

					<th class="smaller">
						School
					</th>

					<th class="smaller">
						Exp
					</th>

					<th class="smaller" colspan="2">
						Functions
					</th>

				</tr>

<%perl>
				if (@prelim_jpools) { 

					foreach my $jpool (@prelim_jpools) { 

						my @jpool_judges = @{$judges_by_jpool{$jpool->id}} 
							if $judges_by_jpool{$jpool->id};

						my $jpool_burden = $m->comp(
							"/funclib/ncfl/prelim_jpool_obligation.mas", 
								diocese => $region,
								jpool   => $jpool
							);

						my $needed = $jpool_burden - scalar @jpool_judges;
						$needed = 0 if $needed < 0;

						$jpool_obligation = "Short in ".$jpool->name if $needed > 0; 
				
</%perl>
						<tr>

							<th class="smallish" colspan="5">

								<span class="half">
									<h6>
										Judges in <% $jpool->name %>:
									</h6>
								</span>
								<span class="half centeralign">
									Minimum <% $jpool_burden %> owed
								</span>
							</td>

							<td class   = "smallish centeralign padtop"
								colspan = "2"
							>
								<span class="<% ($needed) ? "redtext" : "greentext" %> full strong">
									<% ($needed) ? $needed." more needed " : "Obligation met!" %>
								</span>
							</td>
						</tr>

	<%perl>
						foreach my $judge (@{$judges_by_jpool{$jpool->id}}) {

							print_judge($judge, $category, $hide_code);

						}

					}

					if (@jpoolless_judges) { 

	</%perl>

						<tr class="row"> 

							<td 
								class   = "smallish padtopmore padbottommore strong redtext"
								colspan = "5"
								style   = "padding-top: 2px;"
							>
								Judges without prelim pools:
							</td>

							<td 
								class   = "centeralign smallish"
								colspan = "2"
							>
							</td>
						</tr>

	<%perl>


						foreach my $judge (@jpoolless_judges) { 

							print_judge($judge, $category, $hide_code);

						}

					}

				} else { 

					foreach my $judge (@judges) {

						print_judge($judge, $category, $hide_code);

					}

				}

	</%perl>

				<tr class="row">

					<th
						colspan="3" 
						class="rightalign strong padrightmore"
					>
						<% $judge_burden %> total <% $tab_room ? "tabber " : "prelim judges"  %> owed

					</td>

					<td 
						colspan = "4"
						class   = "centeralign"
					>

						<span 
							class="<% ($judge_burden - scalar (@judges) > 0) 
										? "redtext" 
										: "greentext" 
									%> full strong">

							<% ($judge_burden - scalar (@judges) > 0) 
								? ($judge_burden - scalar (@judges))." more needed" 
								: ($jpool_obligation) ? $jpool_obligation : "Obligation met!"
							%>
						</span>

					</td>

				</tr>

				<tr class="liblrow">

					<td colspan="7" class="rightalign">

					<form 
						action = "<% ($tab_room) ? "tourn_tab_edit.mhtml" : "tourn_judge_edit.mhtml" %>"
						method = "post"
					>

						<input 
							type  = "hidden"
							name  = "category_id"
							value = "<% $category->id %>"
						>

						<input 
							type  = "hidden"
							name  = "tourn_id"
							value = "<% $category->tourn->id %>"
						>

						<input 
							type  = "hidden"
							name  = "region_id"
							value = "<% $region->id %>"
						>

						<input 
							type  = "submit"
							class = "thin"
							value = "Add another <% ($tab_room) ? "Tabber" : "Judge" %>"
						>
						</form>
					</td>

				</tr>


			</table>

%			if (@elim_jpools) { 

				<a name="elims"></a>

				<h4>Judges for <% $category->abbr %> Elims:</h4>

				<p class="explain">Note: "D" judges may not judge elim rounds and
				will not appear below.  Judges can only judge in one division
				during elims, but may judge a different division than they judged
				in prelims.</p>

				<table cellpadding="4" cellspacing="1" width="98%" border="0" style="margin-left: 5px;">

					<tr class="yellowrow">

						<th class="smaller">
							<form action="tourn_judge_elims_save.mhtml" method="post">
							<input type="hidden" name="category_id" value="<% $category->id %>">
							<input type="hidden" name="tourn_id" value="<% $tourn->id %>">
							<input type="hidden" name="region_id" value="<% $region->id %>">
							Judge
						</th>

%						foreach my $jpool (@elim_jpools) { 

							<th class="smaller centeralign">
								<% $jpool->name %>
							</th>

%						}

					</tr>

<%perl>

				foreach my $judge ($m->comp(
					"/funclib/region_judges.mas", 
						tourn  => $tourn,
						region => $region,
						elim   => $category)
				) {

					next unless $judge->category;
					next if $judge->category->setting("tab_room");
					next if (index($judge->avg, "D") != -1);

					my %jpool_yes = map {$_->id => 1} $judge->jpools;

</%perl>
						<tr class="row">

							<td class="smallish">

								<span class="medspan padless">
									<% $judge->first." ".$judge->last %>
								</span>

								<span class="finespan padless">
									<% $judge->category->abbr %>
								</span>

							</td>

%							foreach my $jpool (@elim_jpools) { 
								<td align="center">
									<input 
										type  = "checkbox"
										name  = "<% $judge->id %>_<% $jpool->id %>"
										value = "1"
										<% $jpool_yes{$jpool->id} ? "checked" : "" %> 
									>
								</td>
%							}

						</tr>
%					}

	<%perl>

					# Calculate the total owed if the region is small enough to
					# qualify for the Alternative Maximum Tax.

					my ($total_owed, $style) = $m->comp(
						"/funclib/ncfl/jpool_obligation.mas", 
							diocese  => $region,
							category => $category
					);

	</%perl>

					<tr class="row">
						
						<th class="padtopmore padbottommore">
							Elim Rounds Owed:
						</td>

%						if ($style eq "overall") { 

							<td 
								colspan="6" 
								class="strong centeralign <% $total_owed ? "redtext" : "" %>"
							>
								<% ($total_owed) ? $total_owed." more elim round(s)" : "All set for elims!" %>
							</td>

%						} else { 


<%perl>

							foreach my $jpool (@elim_jpools) { 

								my ($owed, $ditch) = $m->comp(
									"/funclib/ncfl/jpool_obligation.mas", 
									diocese => $region,
									jpool   => $jpool
								);

</%perl>
								<td class="strong centeralign <% $owed ? "red" : "green" %>text ">
									<% ($owed) ? $owed." more " : "OK" %> 
								</td>
%							}
	
%						}

					</tr>

					<tr class="liblrow">
						<td colspan="9" align="right">
							<input 
								type  = "submit"
								class = "thin"
								value = "Save Elim Assignments"
							>
							</form>
						</td>
					</tr>

				</table>

%			}

%	} else { 

		<& "menubar.mas",
			 tourn  => $tourn,
			 region => $region,
			 whoami => "judges"
		&>

		<h4>Choose a judge category at right</h4>

%	} 

%	if ($category_settings{'judge_policy'}) { 

		<h4>Note:</h4>

		<p><% $category_settings{'judge_policy'}  %></p>

%	} 

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Judge Categories</h4>

<%perl>

				foreach my $other_category (sort {$a->name cmp $b->name} $tourn->categories) { 

					my @judges = $m->comp(	
						"/funclib/ncfl/covering_judges.mas", 
							diocese => $region, 
							category => $other_category
						);

					my $judge_burden = $m->comp(
						"/funclib/ncfl/judge_obligation.mas", 
							diocese  => $region,
							category => $other_category
					);

					my $remainder = $judge_burden - scalar @judges;

					my ($total_owed, $style) = $m->comp(
						"/funclib/ncfl/jpool_obligation.mas", 
							diocese => $region, 
							category => $other_category
					);

</%perl>
					<a 
						class="<% $remainder > 0 ? "red" : $other_category == $category_id ? "dkblue" : "blue" %> full noline" 
						href="tourn_judges.mhtml?category_id=<% $other_category->id %>&region_id=<% $region->id %>&tourn_id=<% $tourn->id %>">

						<span class="threequarters padno">
							<% $other_category->name %>
						</span>

						<span class="quarter  padno">
							<% scalar @judges %>/<% $judge_burden %>
						</span>
					</a>

%					if ($remainder <= 0 && $total_owed > 0) { 
						<div class="dkred centeralign full bigger marbottom">
							<% $total_owed %> <% $other_category->abbr %> Elims Still Owed
						</div>
%					}

%				}

		
		</div>

%	sub print_judge { 

<%perl>

		my ($judge, $category, $hide_code) = @_;

		my $rating = $judge->avg;
		$rating =~ s/\d//g;

		my $tourn = $category->tourn;

		my $tz = $tourn->tz;
		$tz = "UTC" unless $tz;

		my $now = DateTime->now(time_zone => $tz);

		my $region = $judge->school->region;

</%perl>

		<tr class="row">

			<td class="smallish centeralign">
				<% $judge->code ? $judge->code : "." %>
			</td>

			<td class="smallish">
				<% $judge->first %>
			</td>

			<td class="smallish">
				<% $judge->last %>
			</td>

			<td class="smallish">
				<% $judge->school ? $judge->school->name : "Hired" %>
			</td>

			<td class="smallish centeralign">
				<% $rating %>
			</td>

%			if ($judge && $judge->alt_category && $judge->alt_category->id == $category->id ) { 

				<td colspan="2" class="smallish centeralign">
					<a 
						class="dkblue full" 
						href="tourn_judges.mhtml?tourn_id=<% $tourn->id %>&region_id=<% $region->id %>&category_id=<% $judge->category->id %>">
						From <% $judge->category->name %>
					</a>
				</td>

%			} else { 

				<td class="centeralign smallish">
					<a 
						class="bluetext buttonwhite fa fa-lg fa-edit"
						href="/register/judge/edit.mhtml?tourn_id=<% $category->tourn->id %>&region_id=<% $region->id %>&judge_id=<% $judge->id %>">
					</a>
				</td>

				<td class="centeralign smallish">

%					my $warn = "You are about to drop that judge entirely.  Are you sure?";

					<a 
						class="redtext buttonwhite fa fa-lg fa-arrow-down"
						href="tourn_judge_drop.mhtml?tourn_id=<% $category->tourn->id %>&region_id=<% $region->id %>&judge_id=<% $judge->id %>" 
						<& "/funclib/confirm.mas", warn => $warn &> >

					</a>
				</td>

%			}

		</tr>


%	}

	</div>


