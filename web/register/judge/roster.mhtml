<%args>
	$person
	$tourn
	$tourn_settings
	$jpool_id      => undef
	$category_id   => undef
	$hires         => undef
	$only_category => undef
</%args>
<%init>

	my $jpool;
	my $category;

	if ($jpool_id) { 
		$jpool = Tab::JPool->retrieve($jpool_id);
		$category = $jpool->category();
	} else { 
		$category = Tab::Category->retrieve($category_id); 
		$category = $only_category if $only_category;
	}

	$m->abort unless $category;

	my %category_settings = $category->all_settings;

	my @judges;
	
	if ($jpool)  {
		@judges = $m->comp(
		"/funclib/jpool_judges.mas", 
			jpool => $jpool,
			hires    => $hires
		);

	} else { 
		@judges = $m->comp(
		"/funclib/category_judges.mas", 
			category => $category,
			hires    => $hires
		);
	}

	my %judge_settings = $m->comp(
		"/funclib/category_judge_settings.mas", 
			category => $category,
			value    => 1,
			all      => 1
	);

	my %paradigms = ();

	if ($category_settings{"ask_paradigm"}) { 
	 	%paradigms = $m->comp(
			"/funclib/judge_paradigms.mas", 
			category => $category
		);
	}

	my @events = $category->events;

	my $regions++ if $tourn_settings->{"ncfl"};
	$regions++ if $tourn_settings->{"regions"};

	Tab::Judge->set_sql( check_rounds => 
		"select coalesce(sum(obligation),0) + coalesce(sum(hired),0) from judge where judge.category = ? "
	);

	my $rounds = Tab::Judge->sql_check_rounds->select_val($category->id) 
		if $category_settings{"rounds_per"};

	my %rating_name = ();

	foreach my $tier ($category->rating_tiers) { 
		$rating_name{$tier->id} = $tier->name;
	}

	my %rating_by_judge = ();

	foreach my $rating (
		$m->comp("/funclib/category_ratings.mas", 
			category => $category,
			type     => "coach"
		)
	){

		$rating_by_judge{$rating->judge->id} = $rating_name{$rating->rating_tier->id} 
			if $rating->rating_tier && $rating->judge;

	}

	my $tab_rating = $category_settings{"tab_ratings"};
	my $total_obligation;
	my $total_hired;

</%init>

	<& 
		menu.mas, 
		tourn_settings => $tourn_settings,
		tourn          => $tourn,
		whoami         => "roster",
		category       => $category,
		jpool          => $jpool,
		hires          => $hires,
		only_category  => $only_category
	&>

	<div class="main">

		<div>

			<span class="half nospace">
				<h4 class="nospace">
%					if ($jpool) { 
						<% ($hires) ? "Hired" : "" %> <% $jpool->name %> Judges 
%					} else { 
						<% ($hires) ? "Hired" : "" %> <% $category->name %> Judges 
%					} 
				</h4>
			</span>

			<span class="half rightalign nospace">
				<span class="threequarters nospace">
					<h6 class="nospace normalweight">
						<% ($rounds) ? $rounds." rounds - " : "" %><% scalar @judges." judges" %>
					</h6>
				</span>

				<span 
					id    = "judges_buttonarea"
					class = "quarter marno"
				> </span>
			</span>

		</div>

	</span>

	<& /funclib/tablesorter.mas, table => "judges" &>

	<table id="judges" class="narrow smallish">

		<thead>

			<tr class="yellowrow">

%				unless ($category_settings{"no_codes"}) { 
					<th>
						Code
					</th>
%				}

				<th>
					First
				</th>

				<th>
					Last
				</th>

				<th>
					School
				</th>

%				if ($tab_rating) { 
					<th class="centeralign">
						Rating
					</th>
%				}


%				if ($category_settings{"rounds_per"} || $rounds) { 
					<th class="centeralign">
						Rds
					</th>

					<th class="centeralign">
						Hire
					</th>
%				}

%				if ($category_settings{"coach_ratings"}) { 
					<th class="centeralign">
						Rtng	
					</th>
%				}

%				if ($tourn_settings->{"nsda_nats"}) { 
					<th title="District" class="centeralign">
						Dist
					</th>
					<th title="State" class="centeralign">
						ST
					</th>
%				}

%				if ($category_settings{"ask_parli"}) { 

					<th class="centeralign">
						Parl
					</th>

%					if ($tourn_settings->{"nsda_nats"}) { 
						<th 
							class="centeralign" 
							title="Prefers to judge Congress">
							Pref
						</th>
%					}
%				}

%				if ($category_settings{"ask_paradigm"}) { 
					<th class="centeralign">
						Paradigm?
					</th>
%				}

%				$m->print("<th>Dio</th>") if $tourn_settings->{"ncfl"};

				<th class="centeralign">
					Coach Notes
				</th>

%				if ($person->id == 6425){
					<th class="centeralign">
						Activate/Deactivate
					</th>
%				}
			</tr>
		</thead>

		<tbody>

%		foreach my $judge (@judges) { 

%			my $region = $judge->school->region if $judge->school && $regions;

			<tr <% $judge->active ? "" : 'class="lirdrow"' %>>

%				unless ($category_settings{"no_codes"}) { 

					<td class="centeralign">
						<a 
							class="white" 
							href="/register/judge/edit.mhtml?from=list&judge_id=<% $judge->id %>"
						>
							<% ($judge->code) ? $judge->code : "Edit"%>
						</a>
					</td>
%				}

				<td >
					<a 
						class="white" 
						href="/register/judge/edit.mhtml?from=list&judge_id=<% $judge->id %>"
					>
						<% $judge->first %>
					</a>
				</td>

				<td >
					<a 
						class="white" 
						href="/register/judge/edit.mhtml?from=list&judge_id=<% $judge->id %>"
					>
						<% $judge->last %>
					</a>
				</td>

				<td class="padleft">

					<a 
						class="white" 
						href="<% $judge->school > 0 ? "/register/school/judges.mhtml?from=list&category_id=".$category_id."&school_id=".$judge->school : "/register/judge/roster.mhtml?hires=1&category_id=".$category_id %>"
					>

						<% ($judge_settings{$judge}{"neutral"}) 
							? "Neutral (" 
								: "" %><% ($judge->school && $judge->school->short_name) 
								? substr($judge->school->short_name,0,25) 
							: "Hired" %><% ($judge_settings{$judge}{"neutral"}) ? ")" : "" %>

					</a>
				</td>

%				if ($tab_rating) { 
					<td class="centeralign">
						<% $judge_settings{$judge}{"tab_rating"} %>
					</td>
%				}

%				if ($category_settings{"rounds_per"} || $rounds) { 

%					$total_obligation += $judge->obligation;
%					$total_hired += $judge->hired;
					<td class="centeralign">
						<% $judge->obligation %>
					</td>
					<td class="centeralign">
						<% $judge->hired %>
					</td>
%				}

%				if ($category_settings{"coach_ratings"}) { 
					<td class="centeralign">
						<% $rating_by_judge{$judge->id} %>
					</td>
%				}	

%				if ($tourn_settings->{"nsda_nats"}) { 
					<td class="centeralign">
						<% $jpool ? $judge->districtcode : $judge->distcode %>
					</td>
					<td class="centeralign">
						<% $jpool ? $judge->regioncode : $judge->state %>
					</td>
				
%				}	

%				if ($category_settings{"ask_parli"}) { 

					<td class="centeralign">
						<% $judge_settings{$judge}{"parli"} ? "Y" : "" %>
					</td>

%					if ($tourn_settings->{"nsda_nats"}) { 
						<td class="centeralign">
							<% $judge_settings{$judge}{"prefers_congress"} ? "Y" : "" %>
						</td>
%					}
%				}	

%				if ($tourn_settings->{"ncfl"}) { 

					<td class="centeralign padno">
						<% $region ? $region->code : "" %>
					</td>

%				}	

%				if ($category_settings{"ask_paradigm"}) { 
					<td class="centeralign">
						<% $paradigms{$judge->id}{"paradigm"} 
							? "Y" 
							: '<span class="redtext semibold">N</span>'
						%>
					</td>
%				}

				<td class="smallish">
					<% $judge_settings{$judge}{'notes'} %>
				</td>

%				if ($person->id == 6425){
				<td class="centeralign">
					<span class="quarter nospace">

						<span class="hidden"><% $judge->active %></span>

						<label class="switch">
							<input 
								type          = "checkbox"
								value         = "1"
								id            = "<% $judge->id %>_active"
								property_name = "active"
								target_type   = "judge"
								target_id     = "<% $judge->id %>" 
								onChange      = "postSwitch( this, 'judge_switch.mhtml');
												statusSwitch('active');"
								<% $judge->active ? 'checked="checked"' : "" %>
							>
							<div class="slider offred"></div>
						</label>

						</span>
					</div>
				</td> 
%				}



			</tr>

% 		} 

		<tbody>

%		if ($category_settings{"rounds_per"} || $rounds) { 

			<tr class="liblrow">

				<th colspan="3" class="rightalign">
					Totals:
				</th>

%				if ($tab_rating) { 
					<th class="centeralign">
					</th>
%				}

				<th class="centeralign">
					<% $total_obligation %>
				</th>

				<th class="centeralign">
					<% $total_hired %>
				</th>

				<th class="centeralign">
					<% $total_obligation + $total_hired %>
				</th>

%				if ($tourn_settings->{"nsda_nats"}) { 

					<th class="centeralign">
					</th>
					<th class="centeralign">
					</th>
%				}

				<th class="centeralign">
				</th>

			</tr>
% 		} 

	</table>

</div>

