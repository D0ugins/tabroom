<%args>
	$person
	$tourn
	$tourn_settings
	$jpool_id      => undef
	$category_id   => undef
	$only_category => undef
	$sort_by       => undef
</%args>
<%init>

	my $jpool;
	my $category;

	$jpool = Tab::JPool->retrieve($jpool_id) if $jpool_id;

	if ($jpool) {
		$category = $jpool->category;
		if ($only_category && ($category != $only_category)) {
			$m->comp("/funclib/abort.mas", message => "You do not have access to pools in category ".$category->abbr);
		}
	} elsif ($only_category) {
		$category = $only_category;
	} else {
		$category = Tab::Category->retrieve($category_id);
	}

	my $dbh = Tab::DBI->db_Main();

	my $from;
	my $limit;

	if ($jpool) {
		$from = "(judge, jpool_judge, category, tourn)";
		$limit = "where jpool_judge.jpool = ? and jpool_judge.judge = judge.id";
	} else {
		$from = "(judge, category, tourn)";
		$limit = "where judge.category = ?";
	}

	if ($ARGS{"hires"}) {
		$limit .= " and judge.school = 0 "
	}

	my %has;

	my $sth = $dbh->prepare("
		select
			judge.id, judge.code, judge.first, judge.middle, judge.last,
				judge.obligation, judge.hired, judge.active,
				judge.ada, notes.value_text,
				chapter_judge.notes, chapter_judge.notes_timestamp,
				notes_processed.value, CONVERT_TZ(notes_processed.timestamp, '+00:00', tourn.tz),
			school.id, school.code, school.name, school.state,
			region.id, region.name, region.code,
			district.id, district.name, district.code,
			diverse.value, tab_rating.value, parli.value, neutral.value, prefers_congress.value,
			person.email, person.id,
			paradigm.value

			from $from

			left join person on judge.person = person.id
			left join person_setting paradigm on paradigm.person = person.id and paradigm.tag = 'paradigm'
			left join chapter_judge on chapter_judge.id = judge.chapter_judge
			left join school on school.id = judge.school
			left join region on region.id = school.region
			left join district on district.id = school.district
			left join judge_setting notes on notes.judge = judge.id
				and notes.tag = 'notes'
			left join judge_setting notes_processed on notes_processed.judge = judge.id
				and notes_processed.tag = 'notes_processed'
			left join judge_setting diverse on diverse.judge = judge.id
				and diverse.tag = 'diverse'
			left join judge_setting tab_rating on tab_rating.judge = judge.id
				and tab_rating.tag = 'tab_rating'
			left join judge_setting parli on parli.judge = judge.id
				and parli.tag = 'parli'
			left join judge_setting neutral on neutral.judge = judge.id
				and neutral.tag = 'neutral'
			left join judge_setting prefers_congress on prefers_congress.judge = judge.id
				and prefers_congress.tag = 'prefers_congress'

			$limit

			and judge.category = category.id
			and category.tourn = tourn.id
	");

	my %judges;
	my $total_rounds;
	my $total_judges;

	my %category_settings = $category->all_settings;

	if ($jpool) {
		$sth->execute($jpool->id);
		$category_settings{'ask_parli'}++ if $jpool->setting("parli");
	} else {
		$sth->execute($category->id);
	}

	while (
		my (
			$judge_id, $judge_code, $judge_first, $judge_middle, $judge_last,
			$judge_obligation, $judge_hired, $judge_active, $judge_ada,
			$notes_value, $chapter_judge_notes, $chapter_judge_notes_timestamp,
			$notes_processed, $notes_timestamp,
			$school_id, $school_code, $school_name, $school_state,
			$region_id, $region_name, $region_code,
			$district_id, $district_name, $district_code,
			$diverse_value, $tab_rating_value, $parli_value, $neutral_value, $prefers_congress_value,
			$person_email, $person_id,
			$paradigm_value
		) = $sth->fetchrow_array()
	) {

		next if $judges{$judge_id};

		if ($judge_active) {
			$total_rounds += $judge_obligation + $judge_hired;
			$total_judges++;
		}

		$judges{$judge_id}{"code"}   = $judge_code;
		$judges{$judge_id}{"first"}  = $judge_first;
		$judges{$judge_id}{"middle"} = $judge_middle;
		$judges{$judge_id}{"last"}   = $judge_last;
		$judges{$judge_id}{"active"} = $judge_active;
		$judges{$judge_id}{"ada"}    = $judge_ada;
		$judges{$judge_id}{"hired"}  = $judge_hired;
		$judges{$judge_id}{"total"}  = $judge_hired + $judge_obligation;
		$judges{$judge_id}{"notes"}  = $notes_value;
		$judges{$judge_id}{"notes_processed"}  = $notes_processed;
		$judges{$judge_id}{"notes_proc_timestamp"}  = $notes_timestamp;

		$judges{$judge_id}{"obligation"}      = $judge_obligation;

		if ($chapter_judge_notes eq $notes_value) {
			$judges{$judge_id}{"notes_timestamp"} = $chapter_judge_notes_timestamp;
		} elsif ($chapter_judge_notes && (not defined $notes_value)) {
			$judges{$judge_id}{"notes"}  = $chapter_judge_notes;
			$judges{$judge_id}{"notes_timestamp"} = $chapter_judge_notes_timestamp;
		}

		#shutup. string sorting is the stooopid.
		if ($judges{$judge_id}{"notes"}) {
			$judges{$judge_id}{notes_exist} = 2;
		} else {
			$judges{$judge_id}{notes_exist} = 1;
		}

		$has{"middle"}++ if $judge_middle;

		if ($school_id) {
			$judges{$judge_id}{"school_state"} = $school_state;
			$judges{$judge_id}{"school_name"}  = $school_name;
			$judges{$judge_id}{"school_code"}  = $school_code;
			$judges{$judge_id}{"school_id"}    = $school_id;

			$has{"school_code"}++ if $school_code;
		} else {
			$judges{$judge_id}{"school_name"} = "Hired";
			$judges{$judge_id}{"school_code"} = "00";
		}

		if ($region_id) {
			$judges{$judge_id}{"region_id"} = $region_id;
			$judges{$judge_id}{"region_name"} = $region_name;
			$judges{$judge_id}{"region_code"} = $region_code;
		}

		if ($district_id) {
			$judges{$judge_id}{"district_id"} = $district_id;
			$judges{$judge_id}{"district_name"} = $district_name;
			$judges{$judge_id}{"district_code"} = $district_code;
		}

		$judges{$judge_id}{"diverse"} = $diverse_value;
		$judges{$judge_id}{"tab_rating"} = $tab_rating_value;
		$judges{$judge_id}{"parli"} = $parli_value;
		$judges{$judge_id}{"neutral"} = $neutral_value;
		$judges{$judge_id}{"prefers_congress"} = $prefers_congress_value;

		$judges{$judge_id}{"person_id"} = $person_id;
		$judges{$judge_id}{"person_email"} = $person_email;
		$judges{$judge_id}{"paradigm"} = $paradigm_value;
	}

	my $regions++ if $tourn_settings->{"ncfl"};
	$regions++ if $tourn_settings->{"regions"};

</%init>

	<&
		"menu.mas",
		tourn_settings => $tourn_settings,
		tourn          => $tourn,
		whoami         => "roster",
		category       => $category,
		jpool          => $jpool,
		hires          => $ARGS{"hires"},
		only_category  => $only_category
	&>

	<div class="main">

		<div>
			<span class="half nospace">
				<h4 class="nospace">
					<% $ARGS{'hires'} ? "&ndash; Hired " : "" %>
					Judges in
%					if ($jpool) {
						Pool <% $jpool->name %>
%					} else {
						<% $category->name %>
%					}
				</h4>
			</span>

%			if ($category_settings{"rounds_per"} || $category_settings{"nats_category"}) {
				<span class="threeeighths nospace centeralign bigger semibold">
					<span class="fifth">
						Active:
					</span>
					<span class="twofifths redtext">
						<% $total_rounds %> rounds
					</span>
					<span class="twofifths bluetext">
						<% $total_judges %> judges
					</span>
				</span>
%			} else {
				<span class="threeeighths nospace centeralign bigger semibold bluetext">
					<% $total_judges %> active judges
				</span>
%			}

			<span
				id    = "judge_roster_buttonarea"
				class = "eighth nospace rightalign"
			> </span>

		</div>

	</span>

	<& /funclib/tablesorter.mas, table => "judge_roster" &>

	<table id="judge_roster" class="narrow smallish">

		<thead>

			<tr class="yellowrow">

%				unless ($category_settings{"no_codes"}) {
					<th>
						Code
					</th>
%				}

				<th>
					First
				</th>

%				if ($has{middle}) {
					<th>
						M
					</th>
%				}

				<th>
					Last
				</th>

%				if (($tourn_settings->{"school_codes"} ne "none") && $has{school_code})  {
					<th title="School Code">
						SCode
					</th>
%				}

%				unless ($ARGS{"hired"}) {
					<th>
						School
					</th>
%				}

%				if ($category_settings{"tab_rating"}) {
					<th class="centeralign">
						Rating
					</th>
%				}

%				if ($category_settings{"rounds_per"} || $category_settings{"nats_category"}) {
					<th title="Rounds obligated for the school" class="centeralign">
						Rds
					</th>
					<th title="Rounds hired out to others/the tournament" class="centeralign">
						Hire
					</th>
					<th title = "Total round obligation" class="centeralign">
						Tot
					</th>
%				}

%				if ($tourn_settings->{"nsda_nats"}) {
					<th title="District" class="centeralign">
						Dist
					</th>
					<th title="State" class="centeralign">
						St
					</th>
%				}

%				if ($tourn_settings->{"ncfl"}) {
					<th title="Diocese" class="centeralign">
						Dio
					</th>
%				}

%				if ($tourn_settings->{"nsda_nats"} && $category_settings{"nats_category"}) {
					<th
						class="centeralign"
						title="Prefers Congress">
						PrefCon
					</th>
%				}

%				if ($category_settings{"ask_parli"}) {
					<th title="Marked as Parliamentarian" class="centeralign">
						Parl
					</th>
%				}

%				if ($category_settings{"ask_paradigm"}) {
					<th title="Has a Paradigm" class="centeralign">
						Para
					</th>
%				}

				<th>
					Notes
				</th>

				<th class="centeralign">
					ADA
				</th>

				<th class="centeralign">
					Active
				</th>

%				if ($person->site_admin){
					<th>
						Luddite
					</th>
%				}
			</tr>

		</thead>

		<tbody>

<%perl>

		my @ids = sort {$judges{$a}{last} cmp $judges{$b}{last}} keys %judges;

		if ($sort_by eq "notes") {
			@ids = sort {
				$judges{$b}{notes_exist} cmp $judges{$a}{notes_exist}
				|| $judges{$a}{notes_processed} <=> $judges{$b}{notes_processed}
			} @ids;
		}

		foreach my $judge_id (@ids) {

</%perl>
			<tr class="<% $judges{$judge_id}{"active"} ? "" : "italic redrow" %>">

%				unless ($category_settings{"no_codes"}) {
					<td>
						<a
							href ="/register/judge/edit.mhtml?judge_id=<% $judge_id %>"
							class="full marno padless padvertless white"
						><% $judges{$judge_id}{"code"} %></a>
					</td>
%				}

				<td>
					<a
						href ="/register/judge/edit.mhtml?judge_id=<% $judge_id %>"
						class="full marno padless padvertless white"
					><% $judges{$judge_id}{"first"} %></a>
				</td>

%				if ($has{middle}) {
					<td>
%						if ($judges{$judge_id}{"middle"}) {
							<a
								href ="/register/judge/edit.mhtml?judge_id=<% $judge_id %>"
								class="full marno padless padvertless white"
							><% $judges{$judge_id}{"middle"} %></a>
%						}
					</td>
%				}
				<td>
					<a
						href ="/register/judge/edit.mhtml?judge_id=<% $judge_id %>"
						class="full marno padless padvertless white"
					><% $judges{$judge_id}{"last"} %></a>
				</td>

%				if (($tourn_settings->{"school_codes"} ne "none") && $has{school_code})  {
					<td title="School Code" class="centeralign">
						<% $judges{$judge_id}{"school_code"} %>
					</td>
%				}

%				unless ($ARGS{"hired"}) {
					<td class='nospace'>
						<a
							href ="/register/school/judges.mhtml?category_id=<% $category->id %>&school_id=<% $judges{$judge_id}{"school_id"} %>"
							class="full marno padless padvertless white"
						><% $judges{$judge_id}{"school_name"} %></a>
					</td>
%				}

%				if ($category_settings{"tab_rating"}) {
					<td class="centeralign">
						<% $judges{$judge_id}{"tab_rating"} %>
					</td>
%				}

%				if ($category_settings{"rounds_per"} || $category_settings{"nats_category"}) {

					<td title="Rounds obligated for the school" class="centeralign">
						<% $judges{$judge_id}{"obligation"} %>
					</td>

					<td title="Rounds hired out to others/the tournament" class="centeralign">
						<% $judges{$judge_id}{"hired"} %>
					</td>

					<td title = "Total round obligation" class="centeralign">
						<% $judges{$judge_id}{"total"} %>
					</td>
%				}

%				if ($tourn_settings->{"nsda_nats"}) {
					<td title="<% $judges{$judge_id}{"district_name"} %>" class="centeralign">
						<% $judges{$judge_id}{"district_code"} %>
					</td>
					<td title="State" class="centeralign">
						<% $judges{$judge_id}{"school_state"} %>
					</td>
%				}

%				if ($tourn_settings->{"ncfl"}) {
					<td title="<% $judges{$judge_id}{"region_name"} %>" class="centeralign">
						<% $judges{$judge_id}{"region_code"} %>
					</td>
%				}

%				if ($tourn_settings->{"nsda_nats"} && $category_settings{"nats_category"}) {
					<td
						class = "centeralign greentext semibold"
						title = "Prefers Congress"
					>
						<% $judges{$judge_id}{"prefers_congress"} ? "Y" : "" %>
					</td>
%				}

%				if ($category_settings{"ask_parli"}) {
					<td
						class = "centeralign semibold bluetext"
						title = "Marked as Parliamentarian"
					>
						<% $judges{$judge_id}{"parli"} ? "Y" : "" %>
					</td>
%				}

%				if ($category_settings{"ask_paradigm"}) {
					<td
						class = "centeralign semibold redtext"
						title = "Has a Paradigm"
					>
						<% $judges{$judge_id}{"paradigm"} ? "Y" : "" %>
					</td>
%				}

				<td class = "limithalf nospace"
					title = "
						<% $judges{$judge_id}{"notes_proc_timestamp"}
							?  "Processed ".$judges{$judge_id}{"notes_proc_timestamp"}
							:  "Last changed ".$judges{$judge_id}{"notes_timestamp"}
						%>"
				>
%					if ($judges{$judge_id}{"notes"} && $judges{$judge_id}{"notes_processed"}) {
						<span class='hidden'>ZZZZZZZZZZZZZZZZZZ</span>
						<a
							href  = "/register/judge/judge_strikes.mhtml?judge_id=<% $judge_id %>"
							class = "full marno plain hover <% $judges{$judge_id}{"notes_processed"} ? "strike" : "" %>"
						> <% $judges{$judge_id}{"notes"} %> </a>
%					} elsif ($judges{$judge_id}{"notes"}) {
						<a
							href  = "/register/judge/judge_strikes.mhtml?judge_id=<% $judge_id %>"
							class = "full marno plain hover <% $judges{$judge_id}{"notes_processed"} ? "strike" : "" %>"
						> <% $judges{$judge_id}{"notes"} %> </a>

%					} else {
						<span class='hidden'>ZZZZZZZZZZZZZZZZZZZZZZ</span>
%					}
				</td>

				<td class="centeralign semibold">
					<% $judges{$judge_id}{"ada"} ? "Y" : "" %>
				</td>
				<td class="centeralign semibold">
					<% $judges{$judge_id}{"active"} ? "Y" : "N" %>
				</td>

%				if ($person->site_admin){
					<td class="centeralign">
						<% $judges{$judge_id}{"person_email"} ? "N" : "Y" %>
					</td>
%				}

			</tr>

%		}

		<tbody>
	</table>

</div>

