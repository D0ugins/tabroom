<%args>
	$tourn
	$category_id
	$sort_by       => "code"
	$only_category => undef
	$hires         => undef
</%args>
<%init>

	my $category = Tab::Category->retrieve($category_id); 
	$category = $only_category if $only_category;

	my %category_settings = $category->all_settings;

	my @judges = $m->comp(
		"/funclib/category_judges.mas", 
		category => $category,
		hires    => $hires
	);

	my @events = $category->events;

	@judges = sort {$a->last cmp $b->last} @judges;

	Tab::Judge->set_sql( check_rounds => " 
		select sum(obligation + hired ) from judge where judge.category = ? 
	");

	my $rounds = Tab::Judge->sql_check_rounds->select_val($category->id);

	my %rating_name = ();

	foreach my $tier ($category->rating_tiers) { 
		$rating_name{$tier->id} = $tier->name;
	}

	my %rating_by_judge = ();

	foreach my $rating ($m->comp(
		"/funclib/category_ratings.mas", 
			category => $category,
			type     => "coach"
		)
	) { 
		$rating_by_judge{$rating->judge->id} = $rating_name{$rating->rating_tier->id} 
			if $rating->rating_tier && $rating->judge;
	}

	my $tab_rating = $category_settings{"tab_ratings"};

	my $prefs++ if (
		$category_settings{"conflicts"}
		|| $category_settings{"prefs"}
		|| $category_settings{"entry_strikes"}
		|| $category_settings{"school_strikes"}
	);

</%init>

	<& "menu.mas", 
		only_category => $only_category,
		tourn         => $tourn,
		whoami        => "diversity",
		category      => $category,
		hires         => $hires 
	&>

	<div class="main">

		<div class="full nospace">

			<span class="half">
				<h4> Diversity Report: <% ($hires) ? "Hired" : "" %> 
					<% $category->abbr %> Judges </h4>
			</span>

			<span class="fifth nospace centeralign bigger semibold">
				<% ($rounds) ? $rounds." rounds" : "" %>
			</span>
			<span class="fifth nospace centeralign bigger semibold">
				<% scalar @judges." judges" %>
			</span>

			<span 
				id="diversity_buttonarea"
				class="tenth rightalign">
			</span>
		</div>

		<& /funclib/tablesorter.mas, table => "diversity" &>

		<form 
			action = "diversity_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "category_id"
			value = "<% $category->id %>"
		>

		<table id="diversity">

			<thead>

			<tr class="yellowrow">

%				unless ($category_settings{"no_codes"}) { 
					<th class="smaller">
						Code
					</th>
%				}

				<th class="smaller">
					First
				</th>

				<th class="smaller">
					Last
				</th>

				<th class="smaller">
					School
				</th>

%				if ($tab_rating) { 
					<th class="centeralign smaller">
						Rating
					</th>
%				}


%				if ($category_settings{"rounds_per"} || $rounds) { 
					<th class="centeralign smaller">
						Rounds
					</th>
%				}

				<th class="centeralign smaller">
					Diverse
				</th>

%				if ($prefs) { 
					<th class="smaller">
						Prefs
					</th>
%				}

			</tr>

		</thead>

		<tbody>

%		foreach my $judge (@judges) { 

			<tr>

%			unless ($category_settings{"no_codes"}) { 

				<td class="centeralign">
					<a 
						class    = "white"
						tabindex = "-1"
						href="/register/judge/edit.mhtml?from=list&judge_id=<% $judge->id %>" 
					>
						<% ($judge->code) ? $judge->code : "Edit"%>
					</a>
				</td>
%			}

			<td class="nospace">
				<a 
					class    = "leftalign white button"
					tabindex = "-1"
					href="/register/judge/edit.mhtml?from=list&judge_id=<% $judge->id %>" 
				>
					<% $judge->first %>
				</a>
			</td>

			<td class="nospace">
				<a 
					class    = "leftalign white button"
					tabindex = "-1"
					href="/register/judge/edit.mhtml?from=list&judge_id=<% $judge->id %>" 
				>
					<% $judge->last %>
				</a>
			</td>

			<td class="nospace">

				<a 
					class    = "leftalign white button"
					tabindex = "-1"
					href="/register/school/judges.mhtml?from=list&school_id=<% ($judge->school) ? $judge->school->id : "" %>" 
				>
					<% $judge->setting("neutral")
						? "Neutral (" 
						: "" 
					%><% 
						$judge->school && $judge->school->short_name
							? substr($judge->school->short_name,0,25) 
							: "Hired" 
					%><% 
						$judge->setting("neutral")
							? ")" 
							: ""
					%>
				</a>
			</td>

%			if ($tab_rating) { 
				<td class="smallish centeralign">
					<% $judge->tab_rating %>
				</td>
%			}

%			if ($category_settings{"rounds_per"} || $rounds) { 

				<td class="smallish centeralign nospace">
					<% $judge->obligation + $judge->hired %>
				</td>
%			}

			<td class="smaller centeralign nospace">
				<span class="hidden"><% $judge->setting("diverse") %></span>

				<label for="<% $judge->id %>">

					<span class="padleftbit padrightbit hover">

						<input 
							type  = "checkbox"
							id    = "<% $judge->id %>"
							name  = "<% $judge->id %>"
							value = "1"
							<% $judge->setting("diverse") ? 'checked="checked"' : "" %>
						>
					</span>

				</label>

			</td>

%			if ($prefs) { 

				<td class="centeralign nospace">

					<a 
						class    = "buttonwhite smallish invert bluetext"
						tabindex = "-1"
						href="prefs.mhtml?judge_id=<% $judge->id %>&roster=hello" 
					>
						Pref Sheet
					</a>
				</td>
%			}

		</tr>

% 		} 

		</tbody>

		<tr class="liblrow">
			<td colspan="6" class="rightalign">
				<input type="submit" value=" Save Ratings">
				</form>
			</td>
		</tr>

	</table>

</div>

