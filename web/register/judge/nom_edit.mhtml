<%args>
	$tourn
	$perms
	$tourn_settings
	$judge_id    => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;
	my $category = $judge->category();

	my %judge_settings = $judge->all_settings();
	my %category_settings = $category->all_settings();

	my %nomination = eval {
		return %{JSON::decode_json($judge_settings{"nomination"}) };
	};

	my @jpools = $m->comp(
		"/funclib/category_jpools.mas",
		category => $category,
		limit    => "registrant"
	);

	my %jpool_settings = $m->comp(
		"/funclib/jpool_settings.mas",
		category => $category
	);

	my %in_jpools = map {$_->id => $_} $judge->jpools();
	my %options;

	foreach my $jpool (@jpools) {

		$options{"parli"} .= " ".$jpool->id
			if $jpool_settings{$jpool->id}{"parli"};

		$options{"prefer"} .= " ".$jpool->id
			if $jpool_settings{$jpool->id}{"prefer"};

		$options{$jpool_settings{$jpool->id}{"paradigm_form"}} .= " ".$jpool->id;

		$options{$jpool_settings{$jpool->id}{"paradigm_form"}."_name"} =  $jpool->name;

	}

	my $school = $judge->school;

</%init>

%	if ( (not defined $school) || $perms->{"details"}) {
		<div class="main">
			<% $school ? "<h2>".$school->name."</h2>" : "" %>
%	} else {
    	<&
			"/register/menubar.mas",
			school         => $school,
			whoami         => "judges",
			tourn          => $tourn,
			tourn_settings => $tourn_settings
		&>
%	}

	<span class="half marno padless padvert judgeactive <% $judge->active ? "" : "redtext" %>">
		<h5 class="inline">
			<% $judge ? $judge->first." ".$judge->last : "Add Judge" %>
			<h6 class="active semibold redtext inline <% $judge->active ? "hidden" : "" %>">
				&ndash; INACTIVE
			</h6>
		</h5>
	</span>
	<span class="half marno rightalign bluetext">
		<h6 class="semibold">
			Nomination Form
		</h6>
	</span>

		<form
			action = "nom_save.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "judge_id"
			value = "<% $judge %>"
		>
		<label for="diverse">
			<div class="row hover">
				<span class="threefifths semibold bluetext bigger">
					Identify as a diversity-enhancing judge
				</span>
				<span class="fifth">
					<input
						type  = "checkbox"
						name  = "diverse"
						value = "1"
						id    = "diverse"
						<% $judge_settings{"diverse"}
							? 'checked="checked"'
							: ""
						%>
					>
				</span>
			</div>
		</label>

		<div class="martopmore nospace hidden full options <% $options{"parli"} %> <% $options{"prefer"} %>">

			<h6>Congress options:</h6>

			<div class="row full marno">

				<label for="parli">
					<span class="options half nospace <% $options{"parli"} %> hover">
						<span class="fourfifths">
							Qualified parliamentarian:
						</span>
						<span class="fifth">
							<input
								type  = "checkbox"
								name  = "parli"
								value = "1"
								id    = "parli"
								<% $judge_settings{"parli"}
									? 'checked="checked"'
									: ""
								%>
							>
						</span>
					</span>
				</label>

				<label for="prefers_congress">
					<span class="options half nospace <% $options{"prefer"} %> hover">
						<span class="fourfifths">
							Would prefer to judge Congress:
						</span>
						<span class="fifth">
							<input
								type  = "checkbox"
								name  = "prefers_congress"
								value = "1"
								id    = "prefers_congress"
								<% $judge_settings{"prefers_congress"}
									? 'checked="checked"'
									: ""
								%>
							>
						</span>
					</span>
				</label>
			</div>
		</div>

		<span class="martopmore nospace full">
			<h6>Finals/semifinals self nominations</h6>

			<label for="self_nominated">
				<div class="row marno martopmore hover">
					<span class="threefifths semibold bluetext bigger">
						I would like to be considered to judge a semi or final:
					</span>

					<span class="fifth">
						<input
							type  = "checkbox"
							name  = "self_nominated"
							id    = "self_nominated"
							value = "1"
							<% $nomination{"self_nominated"}
								? 'checked="checked"'
								: ""
							%>
						>
					</span>
				</div>
			</label>

			<div class="row marno">
				<span class="twofifths semibold">
					Phonetic pronuncation guide:
				</span>
				<span class="threefifths">
					<input
						type  = "text"
						name  = "phonetic"
						size  = "64"
						value = "<% $nomination{"phonetic"} %>"
					>
				</span>
			</div>

			<div class="row marno">
				<span class="twofifths semibold">
					Brief bio for introductions:
				</span>
				<span class="threefifths">
					<input
						type  = "text"
						name  = "bio"
						size  = "64"
						value = "<% $nomination{"bio"} %>"
					>
				</span>
			</div>
<%perl>

#			I should make this dynamic but right now I give negative fucks.
#			That's right, I give so few fucks I took one back.

			my @types = (
				"Policy",
				"LD",
				"PF",
				"Congress",
				"Address IEs",
				"Interp IEs",
				"Big Questions",
				"Worlds Debate"
			);

</%perl>

			<div class="row marno">
				<span class="semibold third">
					Which events would you be best suited to judge?
				</span>

				<span class="twothirds nospace">
%					foreach my $type (@types) {
						<label for="<% $type %>">
							<span class="third hover nospace padleft">
								<span class="fourfifths">
									<% $type %>
								</span>

								<span class="fifth">
									<input
										type  = "checkbox"
										name  = "<% $type %>"
										id    = "<% $type %>"
										value = 1
										<% $nomination{"type"}{$type} ? 'checked="checked"' : "" %>
									>
								</span>
							</span>
						</label>
%					}
				</span>
			</div>

			<div class="full">
				<& "/funclib/editor.mas" &>
				<div class="semibold full nospace martopmore marbottom">
					Please list supporting information/details for us to
					consider in pooling you for semis and finals.
				</div>

				<div class="semibold full nospace centeralign">

					<textarea
						name    = "text"
						rows    = 5
						columns = 70
					><% $nomination{"text"} %></textarea>

				</div>
			</div>

			<div class="full libl rightalign marvertno marno">
				<span class="third centeralign">
					<input
						type  = "submit"
						value = "Save Nomination Details"
					>
				</span>
			</div>
		</span>

		</form>
<%perl>

		my $bio = $judge->setting("final_bio");

		unless ($bio) {

			my $diamond = $judge->person->setting("diamonds");

			$bio .= "A ";
			if ($diamond) {
				$bio .= $diamond." diamond ";
			}

			$bio .= " coach ";

			if ($judge->school) {
				my $state = $judge->school->chapter->state;
				unless ($state) {
					$state = $judge->school->region->name;
				}
				$bio .= " from ".$judge->school->name." in $state"
			}
		}

</%perl>

		<form
			action = "bio_save.mhtml"
			method = "post"
		>
			<input
				type  = "hidden"
				name  = "judge_id"
				value = "<% $judge->id %>"
			>

			<h5 class="martopmore">Bio for Finals</h5>

			<textarea
				name = "bio_text"
				rows = "5"
			><% $bio %></textarea>

			<div class="row rightalign liblrow">
				<span class="centeralign third">
					<input type="submit" value="Save Final Bio">
				</span>

			</div>
		</form>
	</div>

	<div class="menu">
		<div class="sidenote">

			<h4>Judge Data</h4>

			<a
				href="edit.mhtml?judge_id=<% $judge->id %>"
				class="full blue marbottommore martopmore"
			>
				Return to <% $judge->last %> judge details
			</a>

%			if ($school && (not defined $perms->{"details"})) {
				<a
					href="/register/school/judges.mhtml?category_id=<% $category->id %>&school_id=<% $school->id %>"
					class="full blue martopmore"
				>
					Return to <% $school->name %>'s judge roster
				</a>
%			}

			<p class="row padvert marno bigger semibold bluetext martopmore">
				<% $judge->code %>
			</p>

			<p class="row padvert marno bigger semibold bluetext">
				<% $judge->first." ".$judge->last %>
			</p>

			<p class="padvert marno row bigger semibold bluetext">
				<% $judge->category->name %>
			</p>

			<p class="padvert marno row bigger semibold bluetext">
				<% $judge->school ? $judge->school->short_name : "Hired Judge" %>
				<% $judge->school && $judge->school->region ? ", ".$judge->school->region->name : ""%>
			</p>

%			if ($judge->person > 0 ) {
				<p class="padvert marno row centeralign bigger semibold greentext">
					Tabroom account: <% $judge->person->email %>
				</p>
%			}
		</div>
	</div>

	<script>
		function revealOptions() {
			$(".options").addClass("hidden");
			$(".jpools:checked").each(function(jpoolbox) {
				$("."+this.id).removeClass('hidden');
			});
		}

		$(document).ready(function() {
			revealOptions();
		});
	</script>
