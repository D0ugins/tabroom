<%args>
	$tourn
	$tourn_settings
	$person
	$session
	$category_id => 0
	$hires    => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @categories = $tourn->categories unless $category_id;
	push (@categories, Tab::Category->retrieve($category_id)) if $category_id;

	@categories = sort {$a->abbr cmp $b->abbr} @categories;

	my $string = $categories[0]->abbr if $category_id;
	$string = "ALL-Categories" unless $category_id;
	$string .= "-judges.csv";

	my $school_code = $tourn_settings->{"school_codes"};
	my $ncfl = $tourn_settings->{"ncfl"};

	my $ask_parlis;
	my $congress_pref;

	$m->clear_buffer;
	$r->content_type('application/csv');
	$r->headers_out->{'Content-Disposition'} = "attachment; filename=$string";

	foreach my $category (@categories) {

		if ($tourn_settings->{"nsda_nats"}) {
			$congress_pref++ if $category->events( type => "congress");
		}

		$ask_parlis++ if $category->setting('ask_parli');
	}

	undef $school_code if $ncfl;
	my $regions = $tourn_settings->{"regions"};

	$m->print("Code,");
	$m->print("Category,") unless $category_id;
	$m->print("DioCode,") if $ncfl;
	$m->print("Diocese,") if $ncfl;

	if ($tourn_settings->{"nsda_nats"}) {
		$m->print("State,");
		$m->print("District,");
		$m->print("Dist Code,");
		$m->print("Diamonds,");
		$m->print("Tab Staff,");
	}

	$m->print("RegCode,") if $regions;
	$m->print("Region,") if $regions;
	$m->print("Schcode,") if $school_code;
	$m->print("School,");
	$m->print("First,Last,");
	$m->print("Phone,");
	$m->print("ADA,");
	$m->print("Email,");
	$m->print("Timestamp,");

	$m->print("Parli,") if $ask_parlis;
	$m->print("Pref Con,") if $congress_pref;
	$m->print("Avg Pref,");
	$m->print("Diverse,");
	$m->print("Coach Rating,");
	$m->print("Tab Rating,");

	$m->print("Active,");
	$m->print("Notes,");
	$m->print("Special Duty,");
	$m->print("Not Available,");

	my $jpools_yes;
	my @jpools;

	foreach my $category (@categories) {
		foreach my $jpool ($m->comp(
			"/funclib/category_jpools.mas",
			category => $category,
			limit    => "registrant")
		) {
			push @jpools, $jpool;
			$jpools_yes++;
			$m->print('"'.$jpool->name.'",');
		}
	}

	$m->print("\n");

	foreach my $category (@categories) {

		my $no_code = $category->setting("no_codes");

		my @judges = $m->comp(
			"/funclib/category_judges.mas",
			category => $category,
			hires    => $hires
		);

		my %judge_settings = $m->comp(
			"/funclib/category_judge_settings.mas",
			category => $category,
			value    => 1,
			all      => 1
		);

		foreach my $judge (@judges) {

			my $judge_id = $judge->id;

			my %jpools = map{$_->id => 1} $judge->jpools if @jpools;

			$m->print($judge->code) unless $no_code;
			$m->print(",");
			$m->print($category->abbr.",") unless $category_id;

			if ($tourn_settings->{"nsda_nats"}) {
				$m->print($judge->state.",");
				$m->print($judge->distname.",");
				$m->print($judge->distcode.",");
				$m->print($judge_settings{$judge->id}{"diamonds"}.",");
				$m->print("Y") if $judge_settings{$judge->id}{"tab_room"};
				$m->print(",");
			}

			if ($regions) {
				$m->print($judge->regname.",");
				$m->print($judge->regcode.",");
			}

			if ($ncfl) {
				$m->print($judge->regname.",");
				$m->print($judge->regcode.",");
			} elsif ($school_code) {
				$m->print($judge->schcode.",");
			}

			$m->print('"'.Tab::short_name($judge->schname).'",');
			$m->print('"'.$judge->first.'",');
			$m->print('"'.$judge->last.'",');

			if ($judge->perphone){
				$m->print(Tab::phoneme($judge->perphone).",");
			} else {
				$m->print(Tab::phoneme($judge_settings{$judge_id}{"phone"}).",");
			}

			$m->print("ADA") if $judge->ada;
			$m->print(",");

			$m->print($judge->timestamp);
			$m->print(",");

			if ($judge->peremail) {
				$m->print($judge->peremail.",");
			} else {
				$m->print($judge_settings{$judge_id}{"email"}.",");
			}

			if ($ask_parlis) {
				$m->print("Y") if $judge_settings{$judge_id}{'parli'};
				$m->print(",");
			}

			if ($congress_pref) {
				$m->print("Y") if $judge_settings{$judge_id}{'prefers_congress'};
				$m->print(",");
			}

			$m->print($judge->avg.",");
			$m->print("Y") if $judge_settings{$judge_id}{'diverse'};
			$m->print(",");

			my $rating = $m->comp('/funclib/judge_rating.mas',
				judge => $judge,
				print => 1
			);

			$m->print('"'.$rating.'",');
			$m->print('"'.$judge_settings{$judge_id}{"tab_rating"}.'",');

			if ($judge->active) {
				$m->print("Y,");
			} else {
				$m->print("N,");
			}

			$m->print('"'.$judge_settings{$judge_id}{'notes'}.'",');
			$m->print('"'.$judge_settings{$judge_id}{'special_job'}.'",');
			$m->print('"');

			foreach my $strike (
				Tab::Strike->search(
					judge => $judge_id,
					type  => "time"
				)
			) {
				$m->print("Between ".Tab::niceshortdt($strike->start->set_time_zone($tz)));
				$m->print("and ".Tab::niceshortdt($strike->end->set_time_zone($tz))." ");
			}

			foreach my $strike (
				Tab::Strike->search(
					judge => $judge_id,
					type  => "departure"
				)
			) {
				$m->print("Depart at ".Tab::niceshortdt($strike->start->set_time_zone($tz)));
			}

			$m->print('",');

			foreach my $jpool (@jpools) {
				$m->print("Y") if $jpools{$jpool->id};
				$m->print(",");
			}
			$m->print("\n");
		}
	}

	$m->abort();

</%init>

