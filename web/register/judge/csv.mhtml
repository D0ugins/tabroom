<%args>
	$tourn
	$tourn_settings
	$person
	$session
	$category_id => 0
	$hires    => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my @categories = $tourn->categories unless $category_id;
	push (@categories, Tab::Category->retrieve($category_id)) if $category_id;

	@categories = sort {$a->abbr cmp $b->abbr} @categories;

	my $string = $categories[0]->abbr if $category_id;
	$string = "ALL-Categories" unless $category_id;

	$string .= "-HIRES" if $hires;

	my $filename = $Tab::file_root."/tmp/judges-".$string."-".$session->id;
	my $garbage = `rm -f $filename.*`;

	my $school_code = $tourn_settings->{"school_codes"};
	my $ncfl = $tourn_settings->{"ncfl"};

	my $ask_parlis;
	my $congress_pref;

	foreach my $category (@categories) { 

		if ($tourn_settings->{"nsda_nats"}) { 
			$congress_pref++ if $category->events( type => "congress");
		}

		$ask_parlis++ if $category->setting('ask_parli');
	}

	undef $school_code if $ncfl;
	my $regions = $tourn_settings->{"regions"};

	open (CSVOUT, ">$filename.csv");

	print CSVOUT "Group,";
	print CSVOUT "Code,";
	print CSVOUT "Group," unless $category_id;
	print CSVOUT "DioCode," if $ncfl;
	print CSVOUT "Diocese," if $ncfl;

	print CSVOUT "State," if $tourn_settings->{"nsda_nats"};
	print CSVOUT "District," if $tourn_settings->{"nsda_nats"};
	print CSVOUT "Dist Code," if $tourn_settings->{"nsda_nats"};

	print CSVOUT "RegCode," if $regions;
	print CSVOUT "Region," if $regions;
	print CSVOUT "Schcode," if $school_code;
	print CSVOUT "School,";
	print CSVOUT "First,Last,";
	print CSVOUT "Phone,";
	print CSVOUT "ADA,";
	print CSVOUT "Email,";

	print CSVOUT "Parli," if $ask_parlis;
	print CSVOUT "Pref Con," if $congress_pref;
	print CSVOUT "Avg Pref,";
	print CSVOUT "Diverse,";
	print CSVOUT "Coach Rating,";
	print CSVOUT "Tab Rating,";

	print CSVOUT "Active,";
	print CSVOUT "Notes,";
	print CSVOUT "Special Duty,";
	print CSVOUT "Not Available,";

	my $jpools_yes;
	my @jpools;

	foreach my $category (@categories) { 
		foreach my $jpool ($m->comp(
			"/funclib/category_jpools.mas", 
			category => $category,
			limit    => "registrant")
		) { 
			push @jpools, $jpool;
			$jpools_yes++;
			print CSVOUT '"'.$jpool->name.'",';
		}
	}

	print CSVOUT "\n";

	foreach my $category (@categories) { 

		my $no_code = $category->setting("no_codes");

		my @judges = $m->comp(
			"/funclib/category_judges.mas", 
			category => $category,
			hires    => $hires
		);

		my %judge_settings = $m->comp(
			"/funclib/category_judge_settings.mas",
			category => $category,
			value => 1,
			all => 1
		);

		foreach my $judge (@judges) { 

			my $judge_id = $judge->id;

			my %jpools = map{$_->id => 1} $judge->jpools if @jpools;

			print CSVOUT $judge->category->abbr.",";
			print CSVOUT $judge->code unless $no_code;
			print CSVOUT ",";
			print CSVOUT $category->abbr."," unless $category_id;

			if ($tourn_settings->{"nsda_nats"}) { 
				print CSVOUT $judge->state.",";
				print CSVOUT $judge->distname.",";
				print CSVOUT $judge->distcode.",";
			}

			if ($regions) { 
				print CSVOUT $judge->regname.",";
				print CSVOUT $judge->regcode.",";
			}

			if ($ncfl) { 
				print CSVOUT $judge->regname.",";
				print CSVOUT $judge->regcode.",";
			} elsif ($school_code) { 
				print CSVOUT $judge->schcode.",";
			}

			print CSVOUT "\"".Tab::short_name($judge->schname)."\",";
			print CSVOUT '"'.$judge->first.'",';
			print CSVOUT '"'.$judge->last.'",';

			if ($judge->perphone){ 
				print CSVOUT $judge->perphone.",";
			} else { 
				print CSVOUT $judge_settings{$judge_id}{"phone"}.",";
			}

			print CSVOUT "ADA" if $judge->ada;
			print CSVOUT ",";

			if ($judge->peremail) { 
				print CSVOUT $judge->peremail.",";
			} else { 
				print CSVOUT $judge_settings{$judge_id}{"email"}.",";
			}

			if ($ask_parlis) { 
				print CSVOUT "Y" if $judge_settings{$judge_id}{'parli'};
				print CSVOUT ",";
			}

			if ($congress_pref) { 
				print CSVOUT "Y" if $judge_settings{$judge_id}{'prefers_congress'};
				print CSVOUT ",";
			}

			print CSVOUT $judge->avg.",";
			print CSVOUT "Y" if $judge_settings{$judge_id}{'diverse'};
			print CSVOUT ",";

			print CSVOUT "\"".$m->comp('/funclib/judge_rating.mas', judge => $judge, print => 1)."\",";
			print CSVOUT "\"".$judge_settings{$judge_id}{"tab_rating"}."\",";

			if ($judge->active) { 
				print CSVOUT "Y,";
			} else { 
				print CSVOUT "N,";
			}
	
			print CSVOUT "\"".$judge_settings{$judge_id}{'notes'}."\",";
			print CSVOUT "\"".$judge_settings{$judge_id}{'special_job'}."\",";

			print CSVOUT "\"";

			foreach my $strike (
				Tab::Strike->search( 
					judge => $judge_id, 
					type => "time"
				)
			) { 
				print CSVOUT "Between ".Tab::niceshortdt($strike->start->set_time_zone($tz));
				print CSVOUT "and ".Tab::niceshortdt($strike->end->set_time_zone($tz))." ";
			}

			print CSVOUT "\",";
		
			foreach my $jpool (@jpools) { 
				print CSVOUT "Y" if $jpools{$jpool->id};
				print CSVOUT ",";
			}
			print CSVOUT "\n";

		}

	}

	close CSVOUT;

	$m->redirect("$Tab::url_prefix/tmp/judges-".$string."-".$session->id.".csv");

</%init>

<div id="content">

<p><% $filename %></p>
