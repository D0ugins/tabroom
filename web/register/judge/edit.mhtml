 <%args> 
	$tourn
	$tourn_settings
	$person
	$judge_id => undef
	$default  => "edit"
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	$m->abort unless $judge;

	my %judge_settings = $judge->all_settings;

	my $school = $judge->school;

	my $district = $school->district if $tourn_settings->{"nsda_nats"};
	my $diocese = $school->region if $tourn_settings->{"ncfl"};

	my $category = $judge->category;
	my %category_settings = $category->all_settings;

	my $cap_repel;
	my $usa_wsdc;

	foreach my $event ($category->events) { 
		$cap_repel++ if $event->setting("wsdc_cap_repel");
		$usa_wsdc++ if $event->setting("usa_wsdc");
	}

	my @schools = sort {$a->name cmp $b->name} $tourn->schools;

	my @districtschools;

	if ($district) { 
		@districtschools = 
			sort {$a->name cmp $b->name} 
			$district->schools(tourn => $tourn->id);
	}

	my @dioschools;

	if ($diocese) { 
		@dioschools = 
			sort {$a->name cmp $b->name} 
			$diocese->schools(tourn => $tourn->id);
	}

 	my @panels = $m->comp('/funclib/judge_panels.mas', judge => $judge);

	my @online = $m->comp(
		"/funclib/category_online.mas", 
		category => $category
	);

	my $hired++ unless $judge->school && $judge->school->id;

	my $num_sites = scalar($tourn->sites);

	my @this_jpools;
	push @this_jpools, $judge->category->jpools;
	push @this_jpools, $judge->alt_category->jpools if $judge->alt_category > 0;

	@this_jpools = sort {$a->name cmp $b->name} @this_jpools;

	my @other_jpools;

	foreach my $category (sort {$a->abbr cmp $b->abbr} $tourn->categories) { 
		next if $category == $judge->category;
		next if $category == $judge->alt_category;
		push @other_jpools, sort {$a->name cmp $b->name} $category->jpools;
	}

	my %seen = (); 
	@this_jpools = grep { ! $seen{$_->id} ++ } @this_jpools;
	@other_jpools = grep { ! $seen{$_->id} ++ } @other_jpools;

	my @tabs;
	push @tabs, "edit";
	push @tabs, "pools" if @this_jpools || @other_jpools;

	push @tabs, "rounds" if @panels;
	push @tabs, "paradigm" if ($category_settings{"ask_paradigm"} && $judge->person);

	my %links;
	$links{"strikes"} = "judge_strikes.mhtml?judge_id=".$judge->id;
	
</%init>

	<script>
	
		function statusSwitch(targetStatus) { 
			$("."+targetStatus).toggleClass('hidden');
		}

		function submitLink() { 

			var accountEmail = $("#accountEmail").val();
			var judgeId      = $("#accountEmail").attr("judge");
			var replyUrl     = 'link.mhtml';

			console.log("Submitting to "+replyUrl);

			$.ajax({ 
				type    : 'POST',
				url     : replyUrl,
				data    : { 
					judge_id : judgeId,
					email    : accountEmail
				},
				success : function(data) {

					if (data.error) { 

						alertify.error(data.message);

					} else {

						if (data.reply) { 

							var replyContent = '<a href="mailto: '+data.reply+'"';
							replyContent += 'class = "white bluetext">';
							replyContent += data.reply+'</a>';

							$(".replybucket").html(replyContent);

							$("#identityBox").removeClass("hidden");
							$("#linkBox").addClass("hidden");
							$("#linkBox").removeClass("row");
							$("#identityBox").addClass("row");
						}

						if (data.message) { 

							alertify.notify(data.message, "custom");

						}

						zebraRows();

					}

				}
			});



		};

		$(document).ready(function() {
			$('.noEnterSubmit').keypress(function(e){
				if ( e.which == 13 ) { 
					e.preventDefault();
					submitLink();
				}
			});
		});

	</script>

	<& "/funclib/editor.mas" &>

%	if ($hired) { 
		<div class="main">
%	} else {
    	<& 
			"/register/menubar.mas", 
			school         => $school,
			whoami         => "judges",
			tourn          => $tourn,
			tourn_settings => $tourn_settings
		&>
%	}

	<span class="third nospace">
		<h4>Judge <% $judge ? $judge->first." ".$judge->last : "Add Judge" %></h4>
	</span>

	<span class="third nospace centeralign">
		<span class="active buttonwhite redtext <% $judge->active ? "hidden" : "" %>">
			INACTIVE
		</span>
	</span>

	<span class="third nospace rightalign">

		<&
			"/funclib/tabs.mas",
				tabs    => \@tabs,
				links   => \%links,
				default => $default,
				right   => "true",
				buttons => "true",
				large   => "true"
		&>

	</span>

	<div id="edit" class="edit screens hidden">

	<form action="save.mhtml" method="post">

	<input 
		type  = "hidden"
		name  = "judge_id"
		value = "<% ($judge) ? $judge->id : "" %>"
	>

	<span class="pagehalf padtop">


		<div class="row">
			<span class="third">
				First:
			</span>

			<span class="twothirds rightalign">
				<input 
					type        = "text"
					name        = "first"
					size        = "24"
					value       = "<% $judge->first %>"
					placeholder = "First Name"
				>
			</span>
		</div>

		<div class="row">
			<span class="third">
				Last:
			</span>

			<span class="twothirds rightalign">

				<input 
					type        = "text"
					name        = "last"
					size        = "24"
					value       = "<% $judge->last %>"
					placeholder = "Last Name"
				>

			</span>
		</div>

%			unless ($category_settings{"no_codes"}) { 

				<div class="row">

					<span class="third">
						Code
					</span>

					<span class="twothirds rightalign">
						<input
							type  = "text"
							name  = "code"
							size  = "24"
							value = "<% $judge->code %>"
						>
					</span>
	
				</div>
%			}


		<div class="row">

			<span class="third">
				School
			</span>
				
			<span class="twothird">

				<select name="school" class="fixedmed">

					<option value="">Hired</option> 

%					my %school_already;

%					if ($district) { 

% 						foreach my $school (@districtschools) { 

%							$school_already{$school->id}++;

								<option 
									value="<% $school->id %>" 
									<% ($school->id eq $judge->school->id) ? 'selected' : '' %> 
								> <% $school->short_name %> </option>
%						} 
						<option value="">
							---Other Districts:---
						</option>

%					}

% 					if ($diocese) { 

% 						foreach my $school (@dioschools) { 

%							$school_already{$school->id}++;

								<option 
									value="<% $school->id %>" 
									<% ($school->id eq $judge->school->id) ? 'selected' : '' %> 
								> <% $school->short_name %> </option>
%						} 
						<option value="">
							---Other Dioceses:---
						</option>
%					}

% 					foreach my $school (@schools) { 
%						next if $school_already{$school->id}++;
						<option 
							value="<% $school->id %>" 
							<% ($school->id eq $judge->school->id) ? 'selected' : '' %> 
						> <% $school->name%> </option> 

%					} 
	
				</select>

			</span>

		</div>

%		if ($tourn_settings->{"nsda_nats"}) { 
			<div class="row">

				<span class="third">
					District
				</span>
					
				<span class="twothird padsetting">
					<% $district ? $district->code." ".$district->name : "" %>
				</span>

			</div>
%		}

% 			if ($category_settings{"ask_parli"}) { 

				<div class="row">

					<span class="threequarters">
						Qualified Parliamentarian
					</span>

					<span class="quarter">

						<span class="hidden"><% $judge_settings{"parli"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_parli"
								setting_name = "parli"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"parli"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>

						</label>

					</span>
				
				</div>

% 			}

% 			if ($tourn_settings->{"nsda_nats"}) { 

				<div class="row">

					<span class="threequarters">
						Prefers Congress at Nats?
					</span>

					<span class="quarter">

						<span class="hidden"><% $judge_settings{"prefers_congress"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_prefers_congress"
								setting_name = "prefers_congress"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"prefers_congress"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>

						</label>

					</span>
				
				</div>

% 			}


%			if ($category_settings{"rounds_per"}) { 

%			  	my $max_rounds = $category_settings{"max_rounds"};

				<div class="row">

					<span class="threequarters">
						Round Obligation
					</span>

					<span class="quarter">
						<input
							type  = "number"
							name  = "obligation"
							min   = "0"
							max   = "<% $max_rounds %>"
							size  = "10"
							value = "<% $judge->obligation %>">
					</span>
	
				</div>

				<div class="row">

					<span class="threequarters">
						Hired Rounds
					</span>

					<span class="quarter">
						<input
							type  = "number"
							name  = "hired"
							min   = "0"
							max   = "<% $max_rounds %>"
							size  = "10"
							value = "<% $judge->hired %>">
					</span>
	
				</div>

%				if ($category_settings{"exchange"}) { 

					<div class="row">

						<span class="threequarters">
							Hired Rds On Offer
						</span>

						<span class="quarter">
							<input
								type  = "number"
								name  = "hire_offer"
								min   = "0"
								max   = "<% $max_rounds - $judge->obligation %>"
								size  = "10"
								value = "<%
								$judge_settings{'hire_offer'} %>">
						</span>
		
					</div>
%				}

%			}
			
%			if ($category_settings{"tab_ratings"}) { 

				<div class="row">

					<span class="threequarters">
						Tab Rating:
					</span>

					<span class="quarter">
						<input 
							type  = "number"
							name  = "tab_rating"
							min   = "0"
							max   = "999"
							value = "<% $judge_settings{"tab_rating"} %>"
						>
					</span>
		
				</div>

%			}

%			if ($tourn_settings->{"nsda_nats"}) { 

				<div class="row">

					<span class="threequarters">
						# Diamonds
					</span>

					<span class="quarter">

						<input
							type  = "number"
							name  = "diamonds"
							min   = "0"
							max   = "99"
							size  = "10"
							value = "<% $judge_settings{"diamonds"} %>"
						>
					</span>
		
				</div>

%			}

%			if ($usa_wsdc) { 

				<div class="row">
		
					<span class="third">
						Real School:
					</span>	
					
					<span class="twothirds">
						<input 
							type  = "text"
							name  = "real_school"
							size  = "24"
							value = "<% $judge_settings{"real_school"} %>"
						>
					</span>

				</div>

%			}

%			if ($tourn_settings->{"ncfl"}) { 

				<div class="row padmore">
				
					<span class="third">
						Diocese
					</span> 
				
					<span class="twothird">
						<span class="threequarters">
							<% $judge->school 
								&& $judge->school->region 
								? $judge->school->region->name 
								: ""
							%>
						</span>

						<span class="quarter">
							<% $judge->school 
								&& $judge->school->region 
								? $judge->school->region->code 
								: ""
							%>
						</span>
					</span> 

				</div>

%			}

			<div class="row">

				<span class="threequarters">
					Assign to ADA accessible rooms
				</span>

				<span class="quarter">

					<span class="hidden"><% $judge->ada %></span>

					<label class="switch">
						<input 
							type          = "checkbox"
							value         = "1"
							id            = "<% $judge->id %>_ada"
							property_name = "ada"
							target_type   = "judge"
							target_id     = "<% $judge->id %>" 
							onChange      = "postSwitch( this, 'judge_switch.mhtml');"

							<% $judge->ada ? 'checked="checked"' : "" %>
						>
						<div class="slider"></div>
					</label>

				</span>

			</div>

%			if ($cap_repel) { 

				<div class="row">

					<span class="threequarters">
						Chief Adjudicator's Panelist
					</span>

					<span class="quarter">

						<span class="hidden"><% $judge_settings{"chief_adjudicator"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_chief_adjudicator"
								setting_name = "chief_adjudicator"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"chief_adjudicator"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

%			}

% 			if ($category_settings{"neutrals"}) { 

				<div class="row">

					<span class="threequarters">
						Neutral: May judge own school's entries
					</span>

					<span class="quarter">

						<span class="hidden"><% $judge_settings{"neutral"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_neutral"
								setting_name = "neutral"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"neutral"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

% 			}

% 			if ($category_settings{"track_diversity"}) { 

				<div class="row">

					<span class="threequarters">
						Diversity enhancing judge
					</span>

					<span class="quarter">

						<span class="hidden"><% $judge_settings{"diverse"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_diverse"
								setting_name = "diverse"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"diverse"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

% 			}

% 			if ($category_settings{"exchange"} && $judge_settings{'hire_offer'}) { 

				<div class="row">

					<span class="threequarters">
						Approved for Exchange Hire
					</span>

					<span class="quarter">

						<span class="hidden"><% $judge_settings{"hire_approved"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_hire_approved"
								setting_name = "hire_approved"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"hire_approved"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>


%			}

% 			if ($category_settings{"first_year_outs"}) { 

				<div class="row">

					<span class="threequarters">
						First Year Out
%	 					if ($category_settings{"fyo_free_strikes"}) { 
							(Free strike)
%						}
					</span>

					<span class="quarter">

						<span class="hidden"><% $judge_settings{"first_year"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_first_year"
								setting_name = "first_year"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"first_year"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

% 			}

% 			if ($category_settings{"prefs"} || $category_settings{"free_strikes_dont_count"}) { 

				<div class="row">

					<span class="threequarters">
						Free Strike
% 						if ($category_settings{"free_strikes_dont_count"}) { 
							(Does not meet obligation)
% 						}
					</span>

					<span class="quarter">

						<span class="hidden"><% $judge_settings{"free_strike"} %></span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $judge->id %>_free_strike"
								setting_name = "free_strike"
								target_type  = "judge"
								target_id    = "<% $judge->id %>"
								onChange     = "postSwitch( this, 'judge_switch.mhtml');"

								<% $judge_settings{"free_strike"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>
				
				</div>

% 			}

		</span>

		<span class="pagehalf padtop">

%			if ($judge && $judge->person_request > 0) { 

%				my $request = $judge->person_request;

				<div class="row">

					<span class="third semibold red">
						Access Request:
						<% $request->first." ".$request->last %>
					</span>

					<span class="third">
						<a class="white" href="mailto:<% $request->email %>">
							<% $request->email %>
						</a>
					</span>

					<span class="sixth centeralign">
						<a 
							class="greentext buttonwhite fa fa-check"
							href="permit.mhtml?judge_id=<% $judge->id %>&person_id=<% $request->id %>"
						>
						</a>
					</span>

					<span class="sixth centeralign">
						<a 
							class="redtext buttonwhite fa fa-times"
							href="deny.mhtml?judge_id=<% $judge->id %>&person_id=<% $request->id %>"
						>
						</a>
					</span>

				</div>

%			} 

				<div 
					id="identityBox"
					class="<% ($judge->person > 0) ? "row" : "hidden" %>"
				>

					<span class="fifth">
						Linked to:
					</span>

					<span class="replybucket fiveeighths semibold pademail centeralign">
%						if ($judge->person > 0) { 
							<a 
								href  = "mailto:<% $judge->person->email %>"
								class = "white bluetext"
								title = "<% $judge->person->email %>"
							>
								<% $judge->person->email %>
							</a>
%						}
					</span>

					<span class="eighth rightalign">

%						my $warn = "This will render this person unable to access online ballots. You sure, now?";
				
						<a 
							class = "buttonwhite redtext fa fa-chain-broken fa-sm"
							title = "<% $warn %>"
							href="unlink.mhtml?judge_id=<% $judge->id %>" 
							<& "/funclib/confirm.mas", warn => $warn &> 
						>
						</a>
					</span>
				</div>

%			unless ($judge->person > 0) { 

				<div 
					id="linkBox"
					class = "row"
					title = "Link this user to an online Tabroom account"
				>

					<span class="quarter marno padleft">
						Link To 
					</span>

					<span class="fiveeighths">
						<input 
							id          = "accountEmail"
							judge       = "<% $judge->id %>"
							type        = "email"
							name        = "email"
							class       = "noEnterSubmit"
							size        = "24"
							placeholder = "Tabroom login/email"
							onBlur      = "submitLink();"
						>
					</span>

					<span class="eighth">
						<input 
							type    = "button"
							class   = "thin button"
							value   = "Link"
							onClick = "submitLink();"
						>
					</span>

				</div>

%			}

			<div class="row">

				<span class="twofifths">
					Judge category
				</span> 
			
				<span class="threefifths">

					<select name="category" class="fixedsmall">
% 						foreach my $tcategory (sort {$a->name cmp $b->name} $tourn->categories) { 
							<option value="<% $tcategory->id %>" 
								<% ($category && $category->id == $tcategory->id) ? 'selected' : '' %> >
								<% $tcategory->name %> 
							</option>
%						} 

						<option>-----------------------------</option>

					</select> 
				</span> 

			</div> 

			<div class="row">
		
				<span class="twofifths">
					Covers entries in
				</span> 
				
				<span class="threefifths">
					<select name="covers" class="fixedsmall ">

						<option value="">
							None Selected
						</option> 

%	 					foreach my $tcategory (sort {$a->name cmp $b->name} $tourn->categories) {
							<option value="<% $tcategory->id %>"
								<% ($judge->covers && $tcategory->id == $judge->covers->id) 
									? 'selected' : '' %> 

								<% ($category && $category->id == $tcategory->id) &! $judge->covers 
									? 'selected' : '' %>
							>

								<% $tcategory->name %> 
							</option>
%						}  

						<option>-----------------------------</option>
					</select>
				</span>

			</div>

			<div class="row">
	
				<span class="twofifths">
					Phone
				</span>	
				
				<span class="threefifths">

					<input 
						type  = "tel"
						name  = "phone"
						size  = "24"
						value = "<% $judge->person > 0 
									? Tab::phoneme($judge->person->phone)
									: Tab::phoneme($judge_settings{"phone"})
								%>">
				</span>

			</div>

			<div class="row">
	
				<span class="twofifths">
					Email
				</span>	
				
				<span class="threefifths">
					<input 
						type  = "email"
						name  = "email"
						size  = "24"
						value = "<% $judge->person > 0
									? $judge->person->email 
									: $judge_settings{"email"} 
								%>">
				</span>

			</div>

			<div class="row">

				<span class="twofifths">
					Special Job
				</span>
				
				<span class="threefifths">
					<input
						type  = "text"
						name  = "special"
						size  = "24"
						value = "<% $judge_settings{'special_job'} %>"
					>
				</span>

			</div> 
			
			<div class="row">

				<span class="twofifths">
					Coach Notes
				</span>

				<span class="threefifths">
					<input 
						type  = "text"
						name  = "notes"
						size  = "24"
						value = "<% $judge_settings{'notes'} %>"
					>
				</span>

			</div>

% 			if ($category_settings{"ask_alts"}) {

				<div class="row">

					<span class="twofifths">
						Also judges
					</span>
				
					<span class="threefifths">
						<select 
							name  = "alt_category"
							class = "fixedsmall"
						>

							<option value="">
								None Selected
							</option>

%	 						foreach my $tcategory (sort {$a->name cmp $b->name} $tourn->categories) {

%								next if $tcategory->id == $category->id;
	
								<option value="<% $tcategory->id %>" <% ($judge->alt_category && $tcategory->id == $judge->alt_category->id) ? 'selected' : '' %> >
									<% $tcategory->name %> 
								</option>
%							}  

						</select>

					</span>

				</div>

%			}

%			if ($person->site_admin) { 

%				if ($tourn_settings->{"nsda_nats"}) { 

					<div class="row">

						<span class="twofifth">
							NSDA import ID
						</span>

						<span class="threefifths">
							<input 
								type  = "number"
								name  = "nsda_id"
								size  = "16"
								class = "larger"
								value = "<% $judge_settings{"nsda_id"} %>"
							>
						</span>

					</div>

					<div class="row">

						<span class="twofifth">
							NSDA Judge Type
						</span>

						<span class="threefifths">
							<input 
								type  = "text"
								name  = "tmp"
								size  = "4"
								value = "<% $judge->tmp %>"
							>
						</span>

					</div>

%				} else { 

					<div class="row">

						<span class="twofifth">
							CAT import ID
						</span>

						<span class="threefifths">
							<input
								type  = "number"
								name  = "cat_id"
								size  = "16"
								class = "larger"
								value = "<% $judge_settings{"cat_id"} %>"
							>
						</span>

					</div>

					<div class="row">

						<span class="twofifth">
							JOT import ID
						</span>

						<span class="threefifths">
							<input 
								type  = "number"
								name  = "jot_id"
								size  = "16"
								class = "larger"
								value = "<% $judge_settings{"jot_id"} %>"
							>
						</span>

					</div>

%				}
%			}

		</span>

% 		if ($category_settings{"judge_quals"}) {
			
			<div class="row marno">

				<span class="full padless">
					Qualifications:
				</span>

				<span class="full centeralign padless marno">
					<textarea 
						name="qual_history" 
						rows="5" 
						cols="45"
					><% $judge_settings{"qual_history"} %></textarea>
				</span>

			</div>
%		}

		<div class="libl full rightalign martopno">
			<input  
				type  = "submit"
				value = "Save Judge Information"
			>
			</form>
		</div>

	</div>

%	if (@panels) { 

		<div 
			id    = "rounds"
			class = "rounds hidden screens"
		>

			<span class="half">
				<h5>Round Assignments:</h5> 
			</span>

			<span 
				id    = "assignments_buttonarea"
				class = "half rightalign"
			>

				<a 
					href  = "print_sheet.mhtml?judge_id=<% $judge->id %>"
					class = "buttonwhite bluetext fa fa-sm fa-list"
					title = "Info Sheet/Dance Card"
				>
				</a> 
		
%				if ($tourn_settings->{"ncfl"}) { 
					<a 
						class = "buttonwhite orangetext fa fa-sm fa-address-card"
						title = "NCFL Judge Card"
						href  = "/funclib/ncfl/print_judge_card.mhtml?judge_id=<% $judge->id %>" 
					>
					</a>
%				}
			</span>

			<& "/funclib/tablesorter.mas", table => "assignments" &>

			<table id="assignments">

				<thead>

					<tr class="yellowrow smallish">

						<th>
							Event
						</th>

						<th>
							Round
						</th>

						<th>
							Start
						</th>

						<th>
							Room
						</th>

						<th>	
							Entries
						</th>

						<th>
							
						</th>

					</tr>

				</thead>

				<tbody>

<%perl>
				
			foreach my $panel (
				sort {$a->round->timeslot->start <=> $b->round->timeslot->start} 
				$m->comp("/funclib/judge_panels.mas", judge => $judge)
			) { 

				my $round = $panel->round;

				my $start_time = $round->start_time;

				unless ($start_time) { 
					my $start_time = $round->timeslot->start;
					$start_time->set_time_zone($tourn->tz);
				}

</%perl>

				<tr>

					<td>
						<% $panel->eventname %>
					</td>

					<td>
						<span class="hidden"><% $round->name %>-<% $panel->flight %></span>
						<% $round->realname %>
						<% $panel->flight > 1 ? "Flt ".$panel->flight : "" %>
					</td>

					<td>
						<span class="hidden"><% $start_time->epoch %></span>
						<% Tab::niceshortdayt($start_time) %>
					</td>

					<td>
						<% $panel->roomname %>
					</td>

					<td>
%						foreach my $entry ($m->comp("/funclib/panel_entries.mas", panel => $panel)) { 
							<span class="padless">
								<% $entry->code %>
							</span>
%						}
					</td>

					<td class="centeralign padless">
						<a 
							class = "buttonwhite bluetext fa fa-lg fa-eye"
							target= "_blank"
							href  = "/panel/schemat/panel_view.mhtml?panel_id=<% $panel->id %>"
						>
						</a>
					</td>

				</tr>
				
% 			} 

			</tbody>

			</table>

		</div>

% 	} 

% 	if (@this_jpools || @other_jpools) { 
				
%		my @in_pools = sort {$a->name cmp $b->name} $judge->jpools;
%		my %used;

		<div id="pools" 
			class="screens pools hiddden"
		>

			<span class="pagehalf">

				<h5>In <span class="incount"></span>:</h5>

				<& "/funclib/tablesorter.mas", table => "insort", nobuttons => 1 &>

				<table id="insort">

					<thead>

						<tr class="yellowrow smallish">

							<th>
								Pool
							</th>

							<th>
								Cat
							</th>

%							if ($num_sites > 1) { 
								<th>
									Site
								</th>
%							}

							<th>
								#
							</th>
						</tr>

					</thead>

					<tbody id="in">
<%perl>
					foreach my $pool (@in_pools) { 

						$used{$pool->id}++;
</%perl>

						<tr
							class    = "judge smallish hover"
							pool_id  = "<% $pool->id %>"
							judge_id = "<% $judge->id %>"
							id       = "<% $pool->id %>"
							onClick  = "togglePool(this);"
						>

							<td>
								<% $pool->name %>
							</td>

							<td>
								<% $pool->category->abbr %>
							</td>

%							if ($num_sites) { 
								<td class="cellmax nowrap">
									<% $pool->site->name %>
								</td>
%							}

							<td class="nowrap rightalign">
								<% scalar $pool->judges %>
							</td>

						</tr>
%					}

					</tbody>

				</table>

			</span>

			<span class="pagehalf">

				<h5>Not in <span class="outcount"></span>:</h5>

				<& "/funclib/tablesorter.mas", table => "outsort", nobuttons => 1 &>

				<table id="outsort">

					<thead>

						<tr class="yellowrow smallish">

							<th>
								Pool
							</th>

							<th>
								Cat
							</th>

%							if ($num_sites > 1) { 
								<th>
									Site
								</th>
%							}

							<th>
								#
							</th>
						</tr>

					</thead>

					<tbody id="out">
<%perl>
					foreach my $pool (@this_jpools, @other_jpools) { 

						next if $used{$pool->id}++;
</%perl>

						<tr
							class    = "judge smallish hover"
							pool_id  = "<% $pool->id %>"
							judge_id = "<% $judge->id %>"
							id       = "<% $pool->id %>"
							onClick  = "togglePool(this);"
						>

							<td>
								<% $pool->name %>
							</td>

							<td>
								<% $pool->category->abbr %>
							</td>

%							if ($num_sites) { 
								<td class="cellmax nowrap">
									<% $pool->site->name %>
								</td>
%							}

							<td class="nowrap rightalign">
								<% scalar $pool->judges %>
							</td>

						</tr>
%					}

					</tbody>

				</table>

			</span>

		<script type="text/javascript">

			$(document).ready( function(){
				countPools();
			});

			function countPools() { 

				var countIn = $("#in .judge:visible").length;
				var countOut = $("#out .judge:visible").length;

				$("#outcount").text(countOut);
				$("#incount").text(countIn);

				$("#insort").trigger("applyWidgets");
				$("#insort").trigger("update");
				$("#insort").trigger('resort');

				$("#outsort").trigger("applyWidgets");
				$("#outsort").trigger("update");
				$("#outsort").trigger('resort');

			}

			function togglePool(judgeSpan) { 

				var parentID = $(judgeSpan).closest("tbody").attr("id");
				var judgeID  = $(judgeSpan).attr("judge_id");
				var poolID   = $(judgeSpan).attr("pool_id");

				var postValue, newParent;

				console.log("Parent is "+parentID);

				if (parentID === "in") { 

					postValue = 0;
					newParent = "out";

				} else { 

					postValue = 1;
					newParent = "in";

				}

				$.ajax({
					url: '/panel/judge/jpool_judge_switch.mhtml',
					type: 'POST',
					data: { 
						judge_id : judgeID,
						value    : postValue,
						jpool_id : poolID,

					}, success: function(data) { 

						if (data.error) { 
							
							alertify.error(data.message);

						} else { 

							alertify.set('notifier','delay', 2);
							alertify.notify(data.message, "custom");
							alertify.set('notifier','delay', 5);

							$("#"+poolID).prependTo("#"+newParent)

						}

						countPools();
					}

				});
			}

		</script>

		</div>

% 	}

%	if ($category_settings{"ask_paradigm"} && $judge->person) { 

		<div 
			id    = "paradigm"
			class = "screens paradigm hidden"
		>
			<h4>Paradigm</h4>
				
			<div class="lighteven full">
				<% $judge->person->setting("paradigm") %>
			</div>

		</div>
%	 }

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Information</h4>

%			if ($hired) { 

				<a 
					class="blue full" 
					href="/register/judge/roster.mhtml?category_id=<% $category->id %>&hires=1">
					Hired Judges
				</a>

%			} elsif ($judge->school && $category) { 

				<a 
					class="blue full" 
					href="/register/school/judges.mhtml?school_id=<% $judge->school->id %>&category=<% $category->id %>">
					<% $judge->school->short_name %> <% $category->abbr %> Judges
				</a>

%			}

%			if ($category) { 
				<a 
					class="blue full" 
					href="/register/judge/roster.mhtml?category_id=<% $category->id %>">
					All <% $category->abbr %> judges
				</a>
%			}
			
			<div class="row martopmore padno">

				<span class="twothirds marno">
					Active
				</span>

				<span class="third rightalign marno">

					<span class="hidden"><% $judge->active %></span>

					<label class="switch">
						<input 
							type          = "checkbox"
							value         = "1"
							id            = "<% $judge->id %>_active"
							property_name = "active"
							target_type   = "judge"
							target_id     = "<% $judge->id %>" 
							onChange      = "postSwitch( this, 'judge_switch.mhtml'); statusSwitch('active');"

							<% $judge->active ? 'checked="checked"' : "" %>
						>
						<div class="slider"></div>
					</label>

				</span>

			</div> 

		</div>

		<div class="sidenote">

			<h4>Strikes & Prefs</h4>

			<a class="blue full" 
				href="prefs.mhtml?judge_id=<% $judge->id %>">
				Pref Sheets
			</a>

			<a class="blue full" 
				href="conflict_sheet.mhtml?judge_id=<% $judge->id %>">
				Conflict Sheet
			</a>

		</div> 

%       if ($judge->category->strike_timeslots) { 

			<div class="sidenote">
    
	            <h4>Times unavailable</h4>

				<p class="explain centeralign">
					*Will incur fines if below obligation in a block
				</p>
    
				<form action="strike_save.mhtml" method="post">
				<input type="hidden" value="strike_timeslot" name="type"> 
				<input type="hidden" value="<% $judge->id %>" name="judge_id">
				<input type="hidden" value="1" name="from">

<%perl>

				foreach my $strike_timeslot ( 
					sort {$a->start->epoch <=> $b->start->epoch} 
					$judge->category->strike_timeslots) {
</%perl>

                    <div class="smallish row hover"> 
					<label for="strike_timeslot_<% $strike_timeslot->id %>">

                        <span class="threequarter marno">
                            <% $strike_timeslot->name %>
						</span>

                        <span class="quarter marno">
                            <input 
								type  = "checkbox"
								id    = "strike_timeslot_<% $strike_timeslot->id %>"
								name  = "strike_timeslot_<% $strike_timeslot->id %>"
								value = "1"
								<% ($judge) ? ($strike_timeslot->strike($judge) ) ? "checked" : "" : "" %>> 
                        </span>

					</label>
                    </div>
%               }

                <div class="libl rightalign pagefull">
					<input type="submit" class="thin" value=" Save ">
                </div>

				</form>

			</div>
%      	}

%		if ($category_settings{'exchange'}) { 

			<div class="sidenote">

				<h4>Hired Rounds</h4>

				<p>Tap a request to cancel</p>

<%perl>

				foreach my $hire ($judge->hires) { 

					my $warn = "This action will break a judge hire arrangement
					between that school and that judge.  Are you sure?";

</%perl>
					<a 
						class="nowrap blue full" 
						href="hire_cancel.mhtml?hire_id=<% $hire->id %>&back=judge"
					>
						<% $hire->rounds_requested %> rounds to <% $hire->school->short_name %>
					</a>
%				}

			</div>

%		}

% 		if ($category_settings{"coach_ratings"}) { 

			<div class="sidenote">

			<h4>Ratings</h4>
			
			<form 
				action = "rating_save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				value = "<%$judge->id%>"
				name  = "judge_id"
			>

<%perl>

			if ($category->rating_subsets) { 

				foreach my $subset ($category->rating_subsets) { 

					my $rating = $m->comp(
						"/funclib/judge_rating.mas", 
						judge  => $judge,
						subset => $subset
					);

</%perl>

					<div class="row">

						<span class="quarter">
							<% $subset->name %>
						</span>
						
						<span class="threequarters centeralign">

							<select 
								class    = "fixedsmall plain"
								name     = "<% $subset->id %>_rating"
								onchange = 'this.form.submit()'
							>

								<option value="">Unrated Judge</option>

%								foreach my $tier (
%									sort {$a->name cmp $b->name} 
%									$category->rating_tiers(type => "coach")
%								) { 

									<option value="<% $tier->id %>"
										<% ($rating 
												&& $rating->rating_tier 
												&& $tier->id == $rating->rating_tier->id) 
											? "selected" 
											: "" 
										%>
									>
										<% $tier->name %> - <% substr($tier->description,0,15) %>
									</option>
%								}

							</select>

						</span>

					</div>

%				} 

%			}  else { 

%				my $rating = $m->comp("/funclib/judge_rating.mas", judge => $judge);

				<div class="row">

					<span class="quarter">
						<% $category->abbr %>
					</span>
						
					<span class="threequarters nospace centeralign">

						<select 
							name     = "rating"
							onChange = 'this.form.submit()'
							class    = "fixedsmall"
						>

							<option value="">
								Unrated
							</option>

<%perl>
							foreach my $tier (
								sort {$a->name cmp $b->name} 
								$category->rating_tiers(type => "coach")
							) { 
</%perl>
								<option value="<% $tier->id %>" 
									<% $rating 
											&& $rating->rating_tier 
											&& ($tier->id == $rating->rating_tier->id) 
										? "selected" 
										: "" 
									%>
								>
									<% $tier ? $tier->name : "" %> -
									<% $tier ? substr($tier->description,0,15) : "" %>
								</option>
%							}

						</select>
					</span>

				</div>

%			}

			<noscript>
				<div class="libl full rightalign"> 
					<input 
						class = "thin"
						type  = "submit"
						value = "Save Ratings"
					>
				</div>
			</noscript>

			</form>
		</div>

		<div class="sidenote">
			<h4>Wreak Havoc</h4>

				<a 
					href="drop.mhtml?judge_id=<% $judge->id %>" 
					class="dkred full"
				>
					Delete Judge Altogether
				</a>

		</div>

% 		} 


	</div> 
