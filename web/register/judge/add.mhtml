<%args>
	$tourn
	$tourn_settings
	$category_id
	$from          => undef
	$last_id       => undef
	$school_id     => undef
	$only_category => undef
</%args>
<%init>

	my $category = Tab::Category->retrieve($category_id);
	$category = $only_category if $only_category;

	my %category_settings = $category->all_settings();

	my $school = Tab::School->retrieve($school_id) if $school_id;
	my $last = Tab::Judge->retrieve($last_id) if $last_id;

	my %reasons;

	%reasons = $m->comp(
		"/funclib/judgemath/nats_check_judging.mas", 
		school => $school
	) if $tourn_settings->{"nsda_nats"} && $school;

</%init>

%	if ($school) { 

		<& 
			"/register/menubar.mas", 
			school         => $school,
			whoami         => "judges",
			tourn          => $tourn,
			reasons        => \%reasons,
			tourn_settings => $tourn_settings
		&>

%	} else { 

		<& 	"menu.mas",
			only_category  => $only_category,
			category       => $category,
			whoami         => "add",
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			last           => $last
		&>
		<div class="main">
%	}

		<span class="half">
			<h4><% $school 
				? "Add ".$category->abbr." judge for ".$school->short_name 
				: "Add ".$category->abbr." hired judge" 
			%></h4>
		</span>

		<span class="quarter rightalign bigger semibold bluetext">
			School:
		</span>

		<span class="quarter centeralign">

			<form 
				action = "add.mhtml"
				method = "post"
			>

				<input 
					type  = "hidden"
					name  = "category_id"
					value = "<% $category->id %>"
				>

				<select 
					name     = "school_id"
					class    = "fixedsmall"
					tabindex = "-1"
					onChange = "this.form.submit();"
				>

					<option value="">Hired Judge</option>

%					foreach my $oschool ($tourn->schools) { 
						<option 
							value="<% $oschool->id %>" 
							<% $oschool->id == $school ? "selected" : "" %>
						> <% $oschool->name %> </option>
%					}
				</select>

			</form>
		</span>

%		if ($tourn_settings->{"nsda_nats"}) { 
			<form 
				action = "nats_judge_save.mhtml"
				method = "post"
			>

				<input 
					type  = "hidden"
					name  = "return"
					value = "1"
				>

%		} else { 
			<form action="add_save.mhtml" method="post">
%		}

			<input 
				type  = "hidden"
				name  = "category_id"
				value = "<% $category->id %>"
			>
			<input 
				type  = "hidden"
				name  = "from"
				value = "1"
			>

			<input	
				type  = "hidden"
				name  = "school_id"
				value = "<% $school %>"
			>

			<span class="pagehalf">
			
				<div class="row centeralign redtext semibold padvertoption">
					For a judge not in the system:
				</div>

				<div class="row">

					<span class="fifth semibold padleftmore">
						First
					</span>

					<span class="threequarters">	
						<input 
							type  = "text"
							name  = "first"
							size  = "32"
						>
					</span>
				</div>

				<div class="row">

					<span class="fifth semibold padleftmore">
						Last
					</span>

					<span class="threequarters">	
						<input 
							type  = "text"
							name  = "last"
							size  = "32"
						>
					</span>
				</div>

				<div class="row">

					<span class="fifth semibold padleftmore">
						Phone
					</span>

					<span class="threequarters">	
						<input 
							type  = "tel"
							name  = "phone"
							size  = "32"
						>
					</span>
				</div>

				<div class="row">

					<span class="fifth semibold padleftmore">
						Email
					</span>

					<span class="threequarters">
						<input 
							type  = "email"
							name  = "email"
							size  = "32"
						>
					</span>
				</div>

			</span>

			<span class="pagehalf">

				<div class="row centeralign redtext semibold padvertoption">
					Or, select all that apply to this judge:
				</div>

%				if ($school) { 
				<div class="row">

					<span class="third semibold padleft">
						Tabroom judge
					</span>

					<span class="twothirds centeralign">
						<select 
							name  = "chapter_judge_id"
							class = "fixedbiggish"
						>
							
						<option value=""></option>
%							foreach my $chapter_judge (
%								$school->chapter->chapter_judges(retired => 0)
%							) { 

								<option 
									value="<% $chapter_judge->id %>"
								><% $chapter_judge->first." ".$chapter_judge->last %></option>
%							}

						</select>
					</span>

				</div>

%               }

%				if ($school && $school->chapter && $school->chapter->nsda) { 

					<div class="row">

						<span class="third semibold padleft">
							NSDA Coach:
						</span>

						<span class="twothirds centeralign">

							<select 
								name  = "nsda_ualt_id"
								class = "fixedbiggish"
							>
								<option value=""></option>
								<option value="0">None</option>

<%perl>
								foreach my $coach (
									$m->comp(
										"/funclib/nsda_school_coaches.mas",
										school => $school
									)
								) { 

</%perl>
									<option 
										value="<% $coach->ualt_id %>"
									><% $coach->ufname." ".$coach->ulname %> (#<% $coach->ualt_id %>)</option>
%								}
							</select>
						</span>
					</div>
%				}

				<div class="row">
					<span class="third semibold padleft">
						Tabroom email
					</span>

					<span class="twothirds centeralign">
						<input 
							type        = "email"
							name        = "tabroom_email"
							size        = "24"
							placeholder = "Email used for a Tabroom.com account"
						>
					</span>
				</div>

			</span>

			<h5>Further Details</h5>

			<span class="pagehalf">

				<label for="ada">
					<div class="row hover">

						<span class="twothirds">
							ADA access required?
						</span>

						<span class="third centeralign">
							<input 
								type  = "checkbox"
								id    = "ada"
								name  = "ada"
								value = "1"
							>
						</span>

					</div>
				</label>

%				if ($category_settings{"tab_ratings"}) { 

					<div class="row">

						<span class="twothirds">
							Tab Rating
						</span>

						<span class="third centeralign">
							<input 
								type  = "number"
								name  = "tab_rating"
								value = ""
							>
						</span>

					</div>
%				}

%				if ($category_settings{"track_diversity"}) { 

					<label for="diversity">
						<div class="row hover">

							<span class="twothirds">
								Diversity Enhancing
							</span>

							<span class="third centeralign">
								<input 
									type  = "checkbox"
									id    = "diversity"
									name  = "diversity"
									value = "1"
								>
							</span>

						</div>
					</label>

%				}

			</span>

			<span class="pagehalf">

%				if ($category_settings{"rounds_per"} || $category_settings{"nats_category"}) { 

					<div class="row">

						<span class="threequarters">
							Round Obligation:
						</span>

						<span class="quarter">
							<input 
								type = "number"
								name = "obligation"
								size = "5"
							>
						</span>

					</div>
%				}

%				if ($category_settings{"rounds_per"}) { 

					<div class="row">

						<span class="threequarters">
							Rounds hired:
						</span>

						<span class="quarter">
							<input 
								type = "number"
								name = "hired"
								size = "5"
							>
						</span>

					</div>

%				}

%				if ($category_settings{"coach_ratings"}) { 

					<div class="row">

						<span class="third">
							Coach Rating
						</span>

						<span class="twothirds">

%						if ($category->rating_subsets) { 

% 							foreach my $subset ($category->rating_subsets) { 

									<span class="smallspan">
										<% $subset->name %>
									</span>
						
									<select name="<% $subset->id %>_rating" class="fixedsmall">
										<option value="">Unrated</option>
	
%										foreach my $tier (sort {$a->name cmp $b->name} $category->rating_tiers(type => "coach")) { 

											<option value="<% $tier->id %>">
												<% $tier->name %> - <% substr($tier->description,0,15) %>
											</option>
%										}

									</select>
%							} 

%						}  else { 

							<select name="rating">

								<option value="">
									Unrated
								</option>

%								foreach my $tier (sort {$a->name cmp $b->name} $category->rating_tiers(type => "coach")) { 
									<option value="<% $tier->id %>">
										<% $tier->name %> - <% substr($tier->description,0,15) %>
									</option>
%								}

							</select>
		
%						}

						</span>

					</div>

%				}

%				if ($category_settings{"first_year_outs"}) {

					<div class="row">

						<span>
							First year judging?
						</span>

						<span>
							<input type="checkbox" name="first_year" value="1">
						</span>

 					</div>

%				}

				<div class="row nospace">

					<span class='third'>
						Tab/Special Job 
					</span>
		
					<span class="twothirds">
						<input type="text" name="special" size="24">
					</span>

				</div> 
		
				<div class="row nospace">

					<span class="third">
						Coaches Notes
					</span>

					<span class="twothird">
						<input type="text" name="notes" size="24">
					</span>

				</div>

		</span>

<%perl>
    my @jpools = $m->comp(
        "/funclib/category_jpools.mas",
        category => $category,
        limit   => "registrant"
    ); 

		if (@jpools) {
</%perl>
		
			<div class="row">

				<span class="sixth semibold bluetext">
					Judge Pools
				</span>

				<span class="fivesixths nospace centeralign">

%					foreach my $jpool (@jpools) { 

						<label for="<% $jpool->id %>">

							<span class="hover third nospace ltborder">
								<span class="threequarter nowrap padleft leftalign">
									<% $jpool->name %>
								</span>
								<span class="fifth centeralign">
									<input 
										type  = "checkbox"
										class = "largecheck"
										name  = "<% $jpool->id %>"
										value = "1"
										id    = "<% $jpool->id %>"
									>
								</span>

							</span>
						</label>

%					} 
				</span>

				</div>
%		} 

		<div  class="liblrow rightalign">
			<input 
				type  = "submit"
				value = "Save Judge"
			>
		</div>

	</div>

%	if ($school) { 
		<&  
            "/register/school/judge_menu.mas", 
            school         => $school,
            tourn          => $tourn,
			reasons        => \%reasons,
            tourn_settings => $tourn_settings
        &>
%	}
