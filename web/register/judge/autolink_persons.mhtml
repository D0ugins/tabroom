<%args>
	$tourn
	$tourn_settings
	$person
	$category_id   => undef
	$only_category => undef
</%args>
<%init>

	$m->abort unless $person->site_admin;

	my $category = Tab::Category->retrieve($category_id); 
	$category = $only_category if $only_category;

	my @judges = sort {$a->last cmp $b->last } 
		Tab::Judge->search(  
			person   => 0,
			category => $category->id
		);

</%init>

	<& menu.mas,
		only_category  => $only_category,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		whoami         => "link",
		category       => $category
	&>

	<div class="main">

		<span class="threequarters">
			<h2>Link judges to accounts</h4>
		</span>

		<span 
			id="sortable_buttonarea"
			class="quarter rightalign"
		></span>

		<& "/funclib/tablesorter.mas",
			table => "sortable"
		&>

		<form 
			action = "autolink_persons_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "category_id"
			value = "<% $category->id %>"
		>

		<table id="sortable">

			<thead>

			<tr class="smallish yellowrow">

				<th>
				</th>

				<th>
					Judge
				</th>

				<th>
					School
				</th>

				<th>
					Email address of account
				</th>

			</tr>
			</thead>

			<tbody>

<%perl>
			my $counter++;

			foreach my $judge (@judges) { 

				my @persons = Tab::Person->search( 
					first => $judge->first,
					last  => $judge->last
				);

				next unless @persons;

</%perl>
				<tr>

					<td class="centeralign smallish">
						<% $counter++ %>
					</td>

					<td>
						<% $judge->first." ".$judge->last %>
					</td>

					<td>
						<% $judge->school > 0 ? $judge->school->name : "Hired" %>
					</td>

					<td class="nospace">

%						my $notfirst;

%						foreach my $person (@persons) { 

							<label for="<% $person->id %>">

						 	<div class="full hover nospace padleft">

								<span class="threefifths nowrap nospace">
									<div class="full padless"> <% $person->email %> </div>
									<div class="full padless"> <% $person->phone %> </div>
								</span>

								<span class="fifth centeralign">
									<% $person->state."/".$person->country %>
								</span>

								<span class="eighth centeralign">
									<input 
										type  = "radio"
										name  = "<% $judge->id %>"
										value = "<% $person->id %>"
										id    = "<% $person->id %>"

										<% $notfirst++ ? "" : 'checked="checked"' %>
									>
								</span>
							</div>
							</label>
%						}

						<label for="J<% $judge->id %>">
						 	<div class="full hover nospace padleft">
								<span class="threefifths nowrap nospace">
									None of these:
								</span>
								<span class="fifth centeralign">
								</span>
								<span class="eighth centeralign">
									<input 
										type  = "radio"
										name  = "<% $judge->id %>"
										value = "0"
										id    = "J<% $judge->id %>"
										<% $notfirst++ ? "" : 'checked="checked"' %>
									>
								</span>
							</div>
						</label>
					</td>

				</tr>

%			}
			</tbody>

			<tr class="liblrow">

				<td colspan="4" class="rightalign">
					<input type="submit" value=" Link Accounts">
				</td>
			</tr>

		</table>

		</form>
	</div>

