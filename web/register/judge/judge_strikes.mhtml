<%args>
	$judge_id
	$tourn
	$perms
	$tourn_settings
	$only_category => undef
</%args>
<%init> 

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	$m->comp("/funclib/abort.mas", 
		warning => "No judge found with id $judge_id"
	) unless $judge;

	my $category = $judge->category;

    my $start = $tourn->start;
    my $end = $tourn->end;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	$start->set_time_zone($tz);
	$end->set_time_zone($tz);

	my $morning = DateTime->new(
		hour      => 8,
		minute    => 00,
		second    => 00,
		year      => $start->year,
		month     => $start->month,
		day       => $start->day,
		time_zone => $tz
	);

	my $night = DateTime->new(
		hour      => 20,
		minute    => 00,
		second    => 00,
		year      => $end->year,
		month     => $end->month,
		day       => $end->day,
		time_zone => $tz
	);

	my %entries = $m->comp(
		"/funclib/tourn_entries_hash.mas",
		tourn => $tourn
	);

	my %judges = $m->comp(
		"/funclib/tourn_judges_hash.mas",
		tourn => $tourn
	);

	my %students = $m->comp(
		"/funclib/tourn_students_hash.mas",
		tourn => $tourn
	);

	my %schools = $m->comp(
		"/funclib/tourn_schools.mas", 
		tourn   => $tourn,
		actives => 1
	);

	my @timeslots = $m->comp(
		"/funclib/category_timeslots.mas",
		category => $category
	);

	my @days = $m->comp(
		"/funclib/tourn_days.mas",
		tourn => $tourn
	);

	my @pools = $m->comp(
		"/funclib/tourn_jpools.mas",
		tourn => $tourn
	);

    my %links;

	$links{"edit"} = "edit.mhtml?judge_id=".$judge->id;
	
	$links{"pools"} = $links{"edit"}."&default=pools" if @pools;

	$links{"noms"} = $links{"edit"}."&default=noms" if $judge->setting("nomination");

	$links{"rounds"} = $links{"edit"}."&default=rounds"
		if $m->comp("/funclib/judge_panels.mas", judge => $judge);

	$links{"paradigm"} = $links{"edit"}."&default=paradigm"
		if ($category->setting("ask_paradigm") && $judge->person);

	$links{"strikes"} = "judge_strikes.mhtml?judge_id=".$judge->id;

	my $default = "strikes";

</%init>

%  	unless ($judge->hired || $only_category || $perms->{"details"}) {

		<& 
			"/register/menubar.mas", 
			school         => $judge->school,
			whoami         => "judges",
			tourn          => $tourn,
			tourn_settings => $tourn_settings
		&>
%	} else { 
		<div class="main"> 
		
		<% $judge->school ? '<h2>'.$judge->school->name.'</h2>' : "" %>

%	}

		<span class="half marno padless padvert judgeactive <% $judge->active ? "" : "redtext" %>">
			<h5 class="inline">
				<% $category->setting("no_codes") ? "" : $judge->code %>
				<% $judge ? $judge->first." ".$judge->last : "Add Judge" %>
				<h6 class="active semibold redtext inline <% $judge->active ? "hidden" : "" %>">
					&ndash; INACTIVE
				</h6>
			</h5>
		</span>

		<span class="half rightalign">

			<&
				"/funclib/tabs.mas",
					links   => \%links,
					default => $default,
					right   => "true",
					buttons => "true",
					large   => "true"
			&>

		</span>

		<span class="pagehalf">

%		if ($category->shifts) { 

			<h5>Set time blocks unavailable</h5>
			
<%perl>

	   		foreach my $shift ( 
				sort {$a->start->epoch <=> $b->start->epoch} 
				$category->shifts
			) {

				my $start = $shift->start->set_time_zone($tz);
				my $end = $shift->end->set_time_zone($tz);

				my $start_string = $start->day_abbr." ".$start->hour_12.":".$start->strftime('%M');
				my $end_string = $end->hour_12.":".$end->strftime('%M')." ".$end->strftime('%p');;
</%perl>

				<label for="shift_<% $shift->id %>">

					<div class="row hover">

						<span class="threetenths marno padleft smallish">
							<% $shift->name %>
						</span>

						<span class="fifth marno padleft">
							<% $start_string %>
						</span>-<span class="fifth marno padleft">
							<% $end_string %>
						</span>
						
						<span class="eighth fullheight marvert marbottomless">
							<% $shift->fine  > 0
								? $tourn_settings->{"currency"}.$shift->fine 
								: '$300'
							%>
						</span>

						<span class="eighth marno">

							<label class="switch smaller">
								<input 
									type          = "checkbox"
									value         = "1"
									id            = "<% $shift->id %>"
									target_id     = "<% $judge->id %>"
									setting_name  = "<% $shift->id %>"
									property_name = "shift"
									onChange      = "postSwitch(this, 'strike_switch.mhtml');"
									<% $shift->strike($judge) ? 'checked="checked"' : "" %>
								>
								<div class="slider onred smallish"></div>
							</label>

						</span>

					</div>

				</label>

				</form>

%			}


%   	}

		<h5>Time block based</h5>

%		if (scalar @days > 1) { 

			<form 
				action = "strike_save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				value = "day"
				name  = "type"
			>

			<input 
				type  = "hidden"
				value = "<% $judge->id %>"
				name  = "judge_id"
			>

			<div class="row">

				<span class="quarter marno padleft smallish">
					No rounds on
				</span>

				<span class="threequarters nospace padless">

<%perl>

					my $first;

					foreach my $day (@days)  { 

						my $start_time = "00:00:00";
						my $end_time = "23:59:00";

						$day->set_time_zone($tz);

						my $start_dt = $day->clone;
						my $end_dt = $day->clone;

						$start_dt->set( 
							hour      => "00",
							minute    => "00",
							second    => "00"
						);

						$end_dt->set( 
							hour      => "23",
							minute    => "59",
							second    => "00"
						);

						next unless ($start_dt && $end_dt);

						my $existing = Tab::Strike->search(
							judge => $judge->id,
							tourn => $tourn->id,
							type  => "time",
							start => $start_dt,
							end   => $end_dt
						)->first;
</%perl>

						<label for="day_<% $day->mdy %>">
							<span class="twothirdlimit hover">

								<span class="half marno">
									<% $day->day_abbr %>
								</span>

								<span class="half marno">

									<label class="switch smaller right">
										<input 
											type          = "checkbox"
											value         = "1"
											id            = "day_<% $day->mdy %>"
											target_id     = "<% $judge->id %>"
											setting_name  = "<% $day->mdy %>"
											property_name = "day"
											onChange      = "postSwitch(this, 'strike_switch.mhtml');"
											<% $existing ? 'checked="checked"' : "" %>
										>
										<div class="slider onred smallish"></div>
									</label>
								</span>
							</span>
						</label>

%	   				}

				</span> 
				
			</div>

			</form>

%		}

		<form 
			action = "strike_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			value = "timeslot"
			name  = "type"
		>

		<input 
			type  = "hidden"
			value = "<% $judge->id %>"
			name  = "judge_id"
		>

		<div class="row">

			<span class="threeeighths marno padleft ">
				No rounds during
			</span>

			<span class="half">

				<select 
					onChange = "this.form.submit();"
					name     = "timeslot_id"
					class    = "fixedmed"
				>
				<option value=""></option>

<%perl>
					foreach my $timeslot (@timeslots) { 

						my $start = $timeslot->start->set_time_zone($tz);
						my $end = $timeslot->end->set_time_zone($tz);

						my $start_string = $start->day_abbr." ".$start->hour_12.":".$start->strftime('%M');
						my $end_string = $end->hour_12.":".$end->strftime('%M')." ".$end->strftime('%p');;
</%perl>
						<option 
							value="<% $timeslot->id %>"
						><% $timeslot->name %> (<% $start_string."-".$end_string %>)</option>
%					}
				</select>
			</span> 

			</form>
			
		</div>

		<h5>Event/division</h5>

		<form 
			action="strike_save.mhtml" 
			method="post"
		>

		<input 
			type  = "hidden"
			value = "event"
			name  = "type"
		>

		<input 
			type  = "hidden"
			value = "<% $judge->id %>"
			name  = "judge_id"
		>

		<div class="row">

			<span class="threeeighths marno padleft ">
				No rounds in
			</span>

			<span class="half">
				<select 
					onChange = "this.form.submit();"
					name     = "event"
					class    = "fixedmed"
				>
					<option value=""></option>
%					foreach my $event ($category->events) { 
						<option 
							value="<% $event->id %>"
						><% $event->name %></option>
%					}
				</select>
			</span> 

		</div>

		</form>

		<form 
			action="strike_save.mhtml" 
			method="post"
		>

		<input 
			type  = "hidden"
			value = "elim"
			name  = "type"
		> 
		<input 
			type  = "hidden"
			value = "<% $judge->id %>"
			name  = "judge_id"
		>

		<div class="row">

			<span class="threeeighths marno padleft ">
				Elims rounds only in
			</span>

			<span class="half">

				<select 
					onchange = "this.form.submit();"
					name     = "event"
					class    = "fixedmed"
				>

					<option value=""></option>
%					foreach my $event ($category->events) { 
						<option 
							value="<% $event->id %>"
						> <% $event->name %> </option>
%					}
				</select>
			</span> 
			
		</div>
		</form>

	</span>

	<span class="pagehalf">

		<h5>Competitor conflict</h5>

			<form 
				action="strike_save.mhtml" 
				method="post"
			>

			<input 
				type  = "hidden"
				value = "entry"
				name  = "type"
			>

			<input 
				type  = "hidden"
				value = "<% $judge->id %>"
				name  = "judge_id"
			>

			<div class="row">
	
				<span class="threeeighths marno padleft ">
					Search by entry:
				</span> 
				
				<span class="half">
					<select 
						onchange = "this.form.submit();"
						name     = "entry_id"
						class    = "fixedmed"
					>

					<option value=""></option>
<%perl>
					foreach my $entry_id (
						sort {$entries{$a}{"code"} <=> $entries{$b}{"code"}}
						keys %entries
					) { 
</%perl>
						<option 
							value="<% $entry_id %>"
						><% 
							$entries{$entry_id}{"region_code"} 
						%> <% 
							$entries{$entry_id}{"school_code"} 
						%> <% 
							$entries{$entry_id}{"code"} 
						%> <% 
							$entries{$entry_id}{"name"} 
						%></option>
%					}
					</select>
				</span>

			</div> 
			</form>

			<form 
				action="strike_save.mhtml" 
				method="post"
			>

			<input 
				type  = "hidden"
				value = "student"
				name  = "type"
			>

			<input 
				type  = "hidden"
				value = "<% $judge->id %>"
				name  = "judge_id"
			>

			<div class="row">
	
				<span class="threeeighths marno padleft ">
					Search by person:
				</span> 
				
				<span class="half">
					<select 
						onchange = "this.form.submit();"
						name     = "student_id"
						class    = "fixedmed"
					>

					<option value=""></option>
<%perl>
					foreach my $student_id (
						sort {$students{$a}{"code"} <=> $students{$b}{"code"}}
						keys %students
					) { 
</%perl>
						<option 
							value="<% $student_id %>"
						><% 
							$students{$student_id}{"region_code"} 
						%> <% 
							$students{$student_id}{"school_code"} 
						%> <% 
							$students{$student_id}{"code"} 
						%> <% 
							$students{$student_id}{"name"} 
						%></option>
%					}
					</select>
				</span>
			</div> 
		</form>

		<h5>School conflict</h5>

			<form 
				action = "strike_save.mhtml"
				method = "post"
			>

			<input 
				type    = "hidden"
				value   = "school"
				name    = "type"
			>

			<input 
				type  = "hidden"
				value = "<% $judge->id %>"
				name  = "judge_id"
			>

			<div class="row">

				<span class="threeeighths marno padleft">
					Judge no one from
				</span>

				<span class="half">

					<select 
						onchange = "this.form.submit();"
						name     = "school"
						class    = "fixedmed"
					>
					<option value=""></option>

<%perl>

						foreach my $school_id (
							sort {$schools{$a}{"name"} cmp $schools{$b}{"name"}}
							keys %schools
						) { 
</%perl>

%							next unless $schools{$school_id}{"chapter_id"};

							<option 
								value="<% $school_id %>"
							> <% 
								$schools{$school_id}{"code"}
							%> <% 
								$schools{$school_id}{"name"}
							%> <% 
								$schools{$school_id}{"region_name"}
							%> <%
								$schools{$school_id}{"region_code"} 
							%> </option>
%						}
					</select>
				</span>

			</div>
			</form>

% 			if ($tourn_settings->{"regions"}) {

				<h5>Region Conflict</h5>

				<form action="strike_save.mhtml" method="post">
				<input 
					type  = "hidden"
					value = "region"
					name  = "type"
				>
				<input 
					type  = "hidden"
					value = "<% $judge->id %>"
					name  = "judge_id"
				>

				<div class="row">

					<span class="threeeighths marno padleft">
						Judge no one from
					</span>

					<span class="half">
						<select 
							onchange = "this.form.submit();"
							name     = "region"
							class    = "fixedmed"
						>
							<option value=""></option>
%							foreach my $region (sort {$a->name cmp $b->name} $tourn->regions) { 
								<option value="<% $region->id %>"> <% $region->name %> </option>
%							}
						</select>
					</span>

				</div>
			
				</form>

%			}

% 			if ($tourn_settings->{"nsda_nats"}) {

				<h5>District Conflict</h5>

				<form action="strike_save.mhtml" method="post">

				<input 
					type  = "hidden"
					value = "district"
					name  = "type"
				>

				<input 
					type  = "hidden"
					value = "<% $judge->id %>"
					name  = "judge_id"
				>

				<div class="row">

					<span class="threeeighths marno padleft">
						Judge no one from
					</span>

					<span class="half">
						<select 
							onchange = "this.form.submit();"
							name     = "district"
							class    = "fixedmed"
						>
							<option value=""></option>
<%perl>
						foreach my $district (
							sort {$a->name cmp $b->name} 
							$m->comp("/funclib/tourn_districts.mas", tourn => $tourn)
						) { 
</%perl>
								<option 
									value="<% $district->id %>"
								><% $district->code %> <% $district->name %> </option>
%						}
						</select>
					</span>

				</div>

				</form>	

%			}

%			if ($tourn_settings->{"ncfl"}) {

				<form 
					action = "strike_save.mhtml"
					method = "post"
				>

				<input 
					type  = "hidden"
					value = "region"
					name  = "type"
				>

				<input 
					type  = "hidden"
					value = "<% $judge->id %>"
					name  = "judge_id"
				>

				<h5 class="martopmore">
					Diocese Conflict
				</h5>

				<div class="row">

					<span class="threeeighths marno padleft">
						Judge no one from
					</span>

					<span class="half">
				
						<select onchange="this.form.submit();" 
							name  = "region"
							class = "fixedmed"
						>
							<option value=""></option>
<%perl>
						foreach my $region (
							sort {$a->name cmp $b->name} 
							$m->comp("/funclib/tourn_regions.mas", tourn => $tourn)
						) { 
</%perl>
							<option 
								value="<% $region->id %>"
							> <% $region->name %> <% sprintf("%2s", $region->code) %> </option>
%						}
						</select>
					</span>

				</div>
				</form>
		
%			}

	</span>

		<h5 class="martopmore">
			Custom Time based
		</h5>
	
		<form 
			action = "strike_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			value = "time"
			name  = "type"
		>

		<input 
			type  = "hidden"
			value = "<% $judge->id %>"
			name  = "judge_id"
		>

		<div class="row">

			<span class="fifth">
				No rounds between
			</span>

			<span class="threefifths marno">

%	  			if (scalar @days > 1) { 

%					my $first;

%					foreach my $day (@days)  { 

						<label for="start_<% $day->ymd %>">

							<span class="fifth hover marno">

								<input 
									type  = "radio"
									name  = "start_date"
									value = "<% $day->mdy('/') %>"
									id    = "start_<% $day->ymd %>"
									<% ($first++ < 1) ? "checked" : "" %>
								>
								<% $day->day_abbr %>
							</span>

						</label>
%	   				}

%			   	} else { 

					<input 
						type  = "hidden"
						name  = "start_date"
						value = "<% $start->mdy('/') %>"
					>

					<input 
						type  = "hidden"
						name  = "end_date"
						value = "<% $start->mdy('/') %>"
					>

%	   			}
			</span>

			<span class="eighth check">
				<& "/funclib/timepicker.mas", 
					name => "start_time",
					size => 8,
					time => $morning
				&>
			</span> 

		</div>
		
		<div class="row">

			<span class="fifth">
				And
			</span>

			<span class="threefifths marno">

%   			if (scalar @days > 1) { 

%					my $first;

%					foreach my $day (@days) { 
						<label for="end_<% $day->ymd %>">
							<span class="fifth marno hover">
								<input 
									type  = "radio"
									name  = "end_date"
									value = "<% $day->mdy('/') %>"
									id    = "end_<% $day->ymd %>"
									<% ($first++ < 1) ? "checked" : "" %>
								>
									<% $day->day_abbr %>
							</span>
						</label>
%	  				}
%	 			}
			</span>

			<span class="eighth">
				<& "/funclib/timepicker.mas", 
					name => "end_time",
					size => 8,
					time => $night 
				&>
			</span>

			<span class="twentieth padno marno rightalign">
				<input  
					type  = "submit"
					class = "thin"
					value = "Go"
				>
				</form>
			</span>

		</div>

		<h5 class="martopmore">	
			Clone Strikes &amp; Conflict
		</h5>

		<form 
			action = "conflict_copy.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "to_id"
			value = "<% $judge->id %>"
		>

		<div class="row">

			<span class="quarter">
				Clone strikes/conflicts from:
			</span>

			<span class="half">

				<select 
					onchange = "this.form.submit();"
					name     = "from_id"
					class    = "fixedbig"
				>

					<option value=""></option>
<%perl>
					foreach my $judge_id (
						sort {$judges{$a}{"last"} <=> $judges{$b}{"last"}}
						keys %judges
					) { 
</%perl>
						<option 
							value="<% $judge_id %>"
						><% 
							$judges{$judge_id}{"region_code"} 
						%> <% 
							$judges{$judge_id}{"school_code"} 
						%> <% 
							$judges{$judge_id}{"code"} 
						%> <% 
							$judges{$judge_id}{"name"} 
						%></option>
%					}
					</select>

		
			</span>

			<span class="quarter">

			</span>

		</div>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>
				Existing strikes
			</h4>

			<p>
				Click a strike to delete
			</p>

% 			foreach my $strike (sort {$a->type cmp $b->type} $judge->strikes) { 

				<a 
					class="yellow full" 
					href="strike_rm.mhtml?strike_id=<% $strike->id %>"
					title="<% $m->comp("/funclib/strike_name.mas", 
						strike => $strike, 
						nohtml => 1
					) %>"
				>
					<% $m->comp("/funclib/strike_name.mas", strike => $strike) %>
				</a>

%			}

		</div>

	</div>


	<br style="clear: both;">


