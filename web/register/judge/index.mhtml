<%args>
	$tourn
	$perms
	$tourn_settings
	$only_category => undef
</%args>
<%init>

	use POSIX;

	my @categories;

	if ($perms->{"details"}) { 

		my @events = $tourn->events();

		@events = $m->comp(
			"/funclib/event_perms.mas", 
			perms  => $perms,
			type   => "admin",
			events => \@events
		);

		my %done;

		foreach my $event (@events) { 
			push @categories, $event->category 
				unless $done{$event->category->id}++;
		}

	} elsif ($only_category && $only_category->id) {
		@categories = ($only_category);
	} else { 
		@categories = $tourn->categories;
	}

	if (scalar @categories == 1) { 
		$m->redirect("roster.mhtml?category_id=".$categories[0]->id);
	}

	my $some_rounds_per;

	foreach my $category (sort {$a->name cmp $b->name} @categories) { 
		$some_rounds_per++ if $category->setting("rounds_per");
	}

	my @jpools = $m->comp(
		"/funclib/tourn_jpools.mas",
		tourn => $tourn,
		limit => "registrant"
	);

</%init>

	<& "menu.mas", 
		tourn_settings => $tourn_settings,
		tourn         => $tourn,
		only_category => $only_category
	&>

	<div class="main">

		<h2>Judge Categories</h2>

		<table>

			<tr class="yellowrow">

				<th class="smaller">
					Category
				</th>

				<th class="smaller">
					Judges
				</th>

%				if ($some_rounds_per) { 
					<th class="smaller">
						Rounds
					</th>
%				}

				<th class="smaller">
					Hire Requests
				</th>

			</tr>

<%perl>

			my $total;
			my $total_hires;
			my $total_rounds;

			foreach my $category (sort {$a->name cmp $b->name} @categories) { 

				my $judge_per  = $category->setting("judge_per");
				my $rounds_per = $category->setting("rounds_per");
				my $by_entry++ if $category->setting("uncovered_entry_fee");

				my @judges = Tab::Judge->search( category => $category->id );
				my @hires = Tab::JudgeHire->search( category => $category->id );

				my $hire_total = 0;
				my $hire_rounds_total = 0;

				my $round_total;
				foreach my $judge (@judges) { 
					$round_total += $judge->obligation;
					$round_total += $judge->hired;
				}

				$total_rounds += $round_total;

				foreach my $hire (@hires) {
					if ($by_entry) { 
						$hire_total += $hire->entries_requested;
					} else { 
						$hire_total += ceil($hire->entries_requested / $judge_per) if $judge_per;
						$hire_rounds_total += $hire->rounds_requested;
					}
				}

				$total += scalar @judges;
</%perl>

				<tr class="row">

					<td class="nospace">
						<a 
							class="marno white leftalign" 
							href="roster.mhtml?category_id=<% $category->id %>">
							<% $category->name %>
						</a>
					</td>

					<td class="rightalign">
						<% scalar @judges %>
					</td>

%					if ($some_rounds_per) { 
						<td class="rightalign">
							<% $rounds_per ? $round_total : "" %>
						</td>
%					}

					<td class="nospace">

						<a class="marno white leftalign" 
							href="hire_requests.mhtml?category_id=<% $category->id %>"
						>
							<span class="sixth">
								<% $rounds_per ? $hire_rounds_total : $hire_total %>
							</span>
							<span class="threequarters">
								<% $rounds_per ? "rounds" : " judges" %>
							</span>
						</a>
					</td>

				</tr>

%			}

			<tr class="liblrow">

				<th class="padmuchmore padtopmore padbottommore">
					Total
				</th>

				<th class="rightalign padmuchmore">
					<% $total %>
				</th>

%				if ($some_rounds_per) { 
					<th class="rightalign  padmuchmore">
						<% $total_rounds %>
					</th>
%				}

				<th class="rightalign  padmuchmore">
					<% $total_hires %>
				</th>

			</tr>

		</table>

%		if (@jpools) { 

			<h3 class="martopmore">Registration Pools</h3>

			<table>

				<tr class="yellowrow">

					<th class="smaller">
						Pool
					</th>

					<th class="smaller">
						Judges
					</th>

					<th class="smaller">
					</th>

				</tr>

%				foreach my $jpool (sort {$a->name cmp $b->name} @jpools) { 

					<tr class="row">

						<td class="nospace">
							<a 
								class="marno white padsetting leftalign" 
								href="roster.mhtml?jpool_id=<% $jpool->id %>">
								<% $jpool->name %>
							</a>
						</td>

						<td class="rightalign">
							<% $jpool->judgecount %>
						</td>

						<td class="nospace">

						</td>
					</tr>

%				}

				</tr>

			</table>

%		}

	</div>


