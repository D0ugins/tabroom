<%args>
	$tourn
	$perms
	$tourn_settings
	$person
	$person_settings
	$event_id      => undef
	$entry_id      => undef
	$school_id     => undef
	$student_id    => undef
	$only_category => undef
</%args>
<%init>

	use Tab::NSDA::Person;

	my $student = Tab::Student->retrieve($student_id);

	# Find the chapter either passed to me, or given as part of the student.
	# Barf if we don't have one.

	my $school = Tab::School->retrieve($school_id) if $school_id;
	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;

	my $chapter = $student->chapter if $student && $student->chapter;

	$chapter = $school->chapter if $school && (not defined $student);

	if ($entry) {
		$school = $entry->school unless $school;
	}

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	$event = $entry->event if $entry;

	#Default year is this school year, if there isn't one already

	my $now = DateTime->now;
	my $year = $now->year;
	$year++ if $now->month > 6;

	my @student_requests = Tab::Student->search_where({
		chapter        => $chapter->id,
		person_request => { ">", 0 }
	}) if $chapter;

    my $demo;

	if ($chapter) {
		foreach my $circuit ($chapter->circuits) {

			next if $demo;

			if ($circuit->setting("demographics")) {
				$demo++;
			}
		}
    }

	undef $demo if $event && $event->setting("usa_wsdc");

    my %release_forms = eval {
		return %{JSON::decode_json($school->setting("release_forms"))};
	};

</%init>

%	my $name;

%	if ($only_category || $perms->{"details"}) {

		<div class="main">

			<h2><% $school->short_name %></h2>


%	} else {
		<& "/register/menubar.mas",
			school         => $school,
			whoami         => "students",
			tourn          => $tourn,
			perms          => $perms,
			tourn_settings => $tourn_settings &>
%	}

		<h4>
			<% ($student) ? "Edit ".$student->first." ".$student->last : "Create Student in ". $name %>
		</h4>

			<form
				action  = "student_save.mhtml"
				enctype = "multipart/form-data"
				method  = "post"
			>

			<input
				type  = "hidden"
				name  = "school_id"
				value = "<% $school ? $school->id : "" %>"
			>

			<input
				type  = "hidden"
				name  = "student_id"
				value = "<% $student_id %>"
			>

			<input
				type  = "hidden"
				name  = "event_id"
				value = "<% $event_id %>"
			>

			<input
				type  = "hidden"
				name  = "entry_id"
				value = "<% $entry_id %>"
			>

		<span class="pagehalf">

            <div class="row">

				<span class="third semibold">
					First Name
				</span>

				<span class="twothirds">
					<input
						type  = "text"
						name  = "first"
						value = "<% ($student) ? $student->first : "" %>">
				</span>

			</div>

            <div class="row">

				<span class="third semibold">
					Middle
				</span>

				<span class="twothirds">
					<input
						type  = "text"
						name  = "middle"
						value = "<% ($student) ? $student->middle : "" %>">
				</span>

			</div>

            <div class="row">

				<span class="third semibold">
					Last
				</span>

				<span class="twothirds">
					<input
						type  = "text"
						name  = "last"
						value = "<% ($student) ? $student->last : "" %>">
				</span>

			</div>

            <div class="row">

				<span class="third semibold">
					Phonetic
				</span>

				<span class="twothirds">
					<input
						type  = "text"
						name  = "phonetic"
						value = "<% ($student) ? $student->phonetic : "" %>">
				</span>

			</div>

            <div class="row">

				<span class="third semibold">
					Graduation Year
				</span>

				<span class="twothirds">
					<input
						type  = "text"
						name  = "grad_year"
						value = "<% ($student) ? $student->grad_year : $year %>">
				</span>

			</div>

			<label for="novice">
				<div class="row hover">

					<span class="third semibold">
						Novice
					</span>

					<span class="twothirds">
						<input
							type  = "checkbox"
							name  = "novice"
							id    = "novice"
							value = "1"
							<% ($student) ? ($student->novice) ? "checked" : "" : "" %> >
					</span>

				</div>
			</label>

            <div class="row">

				<span class="quarter semibold">
					Gender
				</span>

				<span class="threequarters nospace padless">
					<label for="F">
						<span class="third hover marno">
						<input
							type  = "radio"
							name  = "gender"
							id    = "F"
							value = "F"
							<% ($student) ? ($student->gender eq "F") ? "checked" : "" :""%>
						>

						Female
						</span>
					</label>

					<label for="M">
						<span class="third hover marno">
						<input
							type  = "radio"
							name  = "gender"
							id    = "M"
							value = "M"
							<% ($student) ? ($student->gender eq "M") ? "checked" : "" :""%>
						>
						Male
						</span>
					</label>

					<label for="O">
						<span class="third hover marno">
						<input
							type  = "radio"
							name  = "gender"
							id    = "O"
							value = "O"
							<% ($student) ? ($student->gender eq "O") ? "checked" : "" :""%>
						>
						Other
						</span>
					</label>
				</span>
			</div>
		</span>
		<span class="pagehalf">

%			if ($event && $event->setting("usa_wsdc")) {

				<div class="row">

					<span class="third semibold">
						Actual School
					</span>

					<span class="twothirds">
						<input
							type  = "text"
							name  = "school_sid"
							size  = "30"
							value = "<% $student ? $student->school_sid : "" %>"
						>
					</span>
				</div>

%			}

%			unless ($person->site_admin) {

%				if ($student && $student->person > 0) {

					<div class="row">

						<span class="threequarters semibold">
							Linked Tabroom account?
						</span>

						<span class="quarter centeralign padsetting">
							<span class="fa greentext fa-large fa-check"></span>
						</span>
					</div>

%				} else {

					<div class="row">

						<span class="third semibold">
							Link to Tabroom:
						</span>

						<span class="twothirds">
							<input
								type  = "text"
								name  = "email"
								size  = "30"
							>
						</span>
					</div>

<%perl>
				}
			}

			if ($student && (($event && $event->setting("usa_wsdc")) || $person->site_admin)) {

				my $nsda_person_id = $student->setting("coach_points");

				my $nsda_person = Tab::NSDA::Person->search(user_id => $nsda_person_id)->first;

				if ($person->site_admin) {
</%perl>
					<div class="row">

						<span class="third semibold">
							Linked to:
						</span>

						<span class="twothirds">
							<input
								type  = "text"
								name  = "email"
								size  = "30"
								value = "<% $student && $student->person ? $student->person->email : "" %>"
							>
						</span>
					</div>
%				}

				<div class="row">

					<span class="third semibold">
						NSDA ID
					</span>

					<span class="twothirds">
						<input
							type  = "text"
							name  = "nsda"
							size  = "30"
							value = "<% $student ? $student->nsda : "" %>"
						>
					</span>
				</div>

				<div class="row">

					<span class="third semibold">
						NSDA School ID
					</span>

					<span class="twothirds padsettingtext">
						ID: <% $student && $student->chapter ? $student->chapter->nsda : "" %>
					</span>
				</div>

				<div class="row">

					<span class="third semibold">
						NSDA Coach ID
					</span>

					<span class="twothirds">
						<input
							type  = "text"
							name  = "coach_points"
							size  = "30"
							value = "<% $student ? $student->setting("coach_points") : "" %>"
						>
					</span>

				</div>

				<div class="row">

					<span class="third semibold">
						Coach Found:
					</span>

					<span class="twothirds padsettingtext">
						<% $nsda_person
							? $nsda_person->ufname." ".$nsda_person->umname." ".$nsda_person->ulname
							: "Not Found" %>
					</span>
				</div>

%			}

%			if ($demo) {

				<h6 class="button">
					Demographic Data
				</h6>

				<div class="row">

					<span class="third semibold">
						Student ID
					</span>

					<span class="twothirds">
						<input
							type        = "text"
							name        = "school_sid"
							size        = "32"
							placeholder = "School-issued student ID number"
							value       = "<% $student ? $student->school_sid : "" %>">
					</span>
				</div>

				<div class="row">

					<span class="third semibold">
						Date of Birth
					</span>

					<& /funclib/datepicker.mas, id => "birthdate" &>

					<span class="twothirds">
						<input
							type  = "text"
							name  = "birthdate"
							id    = "birthdate"
							size  = "16"
							value = "<%
								$student->birthdate
								? Tab::pickerdate($student->birthdate)
								: ""
								%>"
							>
					</span>
				</div>

				<div class="row">

% 	              my $race = $student->race if $student;

					<span class="third semibold">
						Background
					</span>

					<span class="twothirds">
						<select name="race" class="fixedmed">

							<option value="">Choose one</option>

							<option
								value="white"
								<%$race eq "white" ? "selected" : "" %>
							> White, non-Hispanic/Latino</option>

							<option
								value="black"
								<%$race eq "black" ? "selected" : "" %>
							> Black, non-Hispanic/Latino</option>

							<option
								value="latino"
								<%$race eq "latino" ? "selected" : "" %>
							> Hispanic/Latino</option>

							<option
								value="amerindian"
								<%$race eq "amerindian" ? "selected" : "" %>
							> American Indian/Native Alaskan</option>

							<option
								value="asian"
								<%$race eq "asian" ? "selected" : "" %>
							> Asian</option>

							<option
								value="pacific"
								<%$race eq "pacific" ? "selected" : "" %>
							> Native Hawaiian/Pacific Islander</option>

							<option
								value="dual"
								<%$race eq "dual" ? "selected" : "" %>
							> Two or more races</option>

							<option
								value="other"
								<%$race eq "other" ? "selected" : "" %>
							> Other</option>

						</select>
					</span>
				</div>

%			}

            <div class="row">

				<span class="third semibold">
                    Diet Notes
                </span>

                <span class="twothirds">
                    <input
						type  = "text"
						name  = "diet"
						size  = "32"
						value = "<% $student ? $student->diet : "" %>"
					>
                </span>
            </div>

%			if ($person->site_admin || $person_settings->{"nsda_admin"}) {

				<div class="row">

					<span class="third semibold">
						Chapter
					</span>

					<span class="twothirds">
						<select name="chapter_id" class="fixedmed">
							<option value=""></option>
%							foreach my $ochapter ($m->comp("/funclib/tourn_chapters.mas", tourn => $tourn)) {
							<option
								value="<% $ochapter->id %>"
								<% $chapter == $ochapter ? "selected" : "" %>
							><% $ochapter->name." ".$ochapter->state %></option>
%							}
						</select>
					</span>
				</div>

%				if ($tourn_settings->{"nsda_nats"}) {

					<div class="row">

						<span class="third semibold">
							Release:
						</span>

						<span class="twothirds">
%                           if ($release_forms{$student->id}) {
                                <a
                                    class="bluetext semibold"
                                    href  = "<% $Tab::s3_url %>/<% $tourn->id."/".$school->id."/releases/".$student->id."/".$release_forms{$student->id} %>"
                                ><% $release_forms{$student->id} %></a>
%                           } else {
                                <span class="redtext padsetting semibold">Nope!</span>
%                           }
						</span>
					</div>

					<div class="row">

						<span class="third semibold">
							Upload:
						</span>

						<span class="twothirds">
							<div class="uploader thinner">

								<input
									type     = "file"
									name     = "entry_release_<% $student->id %>"
									style    = "opacity: 0;"
									onchange = "uploaderName(
										'entry_release_<% $student->id %>',
										'entry_release_<% $student->id %>_file'
									)"
									id     = "entry_release_<% $student->id %>"
								>

								<span
									id  = "entry_release_<% $student->id %>_file"
									class = "filename"
									style = "-webkit-user-select: none;"
								>Upload File</span>

								<span
									class = "action"
									style = "-webkit-user-select: none;"
								>Choose File</span>
							</div>
						</span>

					</div>

%				}

%			}

		</span>

		<div class="libl rightalign">
			<input  type="submit" value="Save Student">
			</form>
		</div>

	</div>

	<div class="menu">

%		unless ($only_category || $perms->{"details"}) {

			<div class="sidenote">

				<h4>School</h4>

%				if ($tourn_settings->{"ncfl"}) {
					<a
						class="blue full"
						href="diocese/entry.mhtml?diocese_id=<% $school->region->id %>"
					>
						Return to <% $school->region->name %>
					</a>
%				}

%				if ($school) {
					<a class="blue full"
						href="/register/school/entries.mhtml?school_id=<% $school->id %>">
						Return to <% $school->short_name %>'s Entry
					</a>
%				}

			</div>
%		}

%		if ($student) {
			<div class="sidenote">

				<h4>Student's Entries</h4>
<%perl>

				my %ok_events = $m->comp("/funclib/event_perms.mas",
					type  => "admin",
					perms => $perms
				);

				ENTRY:
				foreach my $entry ($m->comp(
					"/funclib/student_entries.mas",
					student => $student,
					tourn   => $tourn
					)
				) {

					if ($perms->{'details'}) {
						next ENTRY unless $ok_events{$entry->event->id};
					}
</%perl>

					<a class="blue full"
						href="/register/entry/edit.mhtml?entry_id=<% $entry->id %>">
						<% $entry->code %> in <% $entry->event->abbr %>
						<% ($entry->waitlist) ? "Waitlisted" : "" %>
						<% ($entry->dropped) ? "Dropped" : "" %>
					</a>

%				}

			<hr>

			<a class="blue block"
				href="/register/student_print.mhtml?student_id=<% $student->id %>">
				Print Student Dance Card
			</a>

%			}

		</div>

	</div>

