<%args>
	$tourn
	$person
	$first
	$last
	$middle        => undef
	$chapter_id    => undef
	$event_id      => undef
	$phonetic      => undef
	$grad_year     => undef
	$student_id    => undef
	$novice        => 0
	$retired       => 0
	$gender        => undef
    $birthdate     => undef
    $race          => undef
    $school_sid    => undef
    $ualt_id       => undef
	$coach_ualt_id => undef
	$school_id     => undef
	$entry_id      => undef
</%args>
<%init>

	my $birth_dt;

	if ($birthdate) {
		$birth_dt = Tab::dateme($birthdate);
	}

	unless ($student_id) { 
	
		my $school = Tab::School->retrieve($school_id);

		$chapter_id = $school->chapter->id unless $chapter_id;

		unless ($school) { 
			my $err = "That school is not entered in your tournament";
			$m->redirect("/register/index.mhtml?err=$err");
		}

		my $student = Tab::Student->create({ 
			first      => $first,
			last       => $last,
			phonetic   => $phonetic,
			grad_year  => $grad_year,
			chapter    => $chapter_id,
			novice     => $novice,
			retired    => $retired,
			gender     => $gender,
            birthdate  => $birth_dt,
            school_sid => $school_sid,
            ualt_id    => $ualt_id,
            race       => $race,
		});

		$student->setting("nsda_coach", $coach_ualt_id);

		my $msg = "Student $first $last saved in ". $school->name;

		if ($event_id) { 
			$m->redirect("/register/school/entry_add.mhtml?school_id=".$school->id."&event_id=$event_id&msg=$msg");
		} else {
			$m->redirect("/register/school/entries.mhtml?school_id=".$school->id."&msg=$msg");
		}
		
	}  else  {

		my $student = Tab::Student->retrieve($student_id); 
		my $school = Tab::School->retrieve($school_id);

		if ($student->first ne $first || $student->last ne $last) { 

			my $description = $student->first." ".$student->last." name changed to $first $last.";
			
    	    my $change = $m->comp("/funclib/log.mas",  
    	        tourn       => $tourn->id,
	            type        => "registration",
	            description => $description,
				person      => $person->id
	        );

		}
		
		$student->first($first);
		$student->middle($middle);
		$student->last($last);
		$student->phonetic($phonetic);
		$student->grad_year($grad_year); 
		$student->novice($novice);
		$student->ualt_id($ualt_id);
		$student->retired($retired);
		$student->gender($gender);
		$student->birthdate($birth_dt);
		$student->school_sid($school_sid);
		$student->ualt_id($ualt_id);
		$student->chapter($chapter_id);
		$student->race($race);
		$student->update;

		$student->setting("nsda_coach", $coach_ualt_id);

	  	foreach my $entry ($m->comp("/funclib/student_entries.mas", student => $student, tourn => $tourn)) { 
            my $name = $m->comp("/funclib/entry_name.mas", entry => $entry, full => 1); 
			$entry->name($name);
            $entry->update;
        }

		my $msg = "Changes saved to student $first $last.  Entries renamed in this tournament to follow suit.";
		$m->redirect("/register/entry/student_edit.mhtml?msg=$msg&student_id=$student_id&entry_id=$entry_id");
	
	}

</%init>

