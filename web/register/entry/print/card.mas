<%args>
	$tourn
	$student
	$filename
	$linebreaks => undef
	$weekend    => undef
</%args>
<%init>

    my $filepath = $Tab::file_root."/tmp/";

	my @entries = $m->comp(
		"/funclib/student_entries.mas", 
			student => $student,
			tourn   => $tourn, 
			weekend => $weekend
	);

	my @days = $m->comp(
		"/funclib/tourn_days.mas", 
		tourn => $tourn
	);

	return unless @entries;

	my $school = $entries[0]->school;

	open (TEXOUT, ">>$filepath"."$filename.tex");

	print TEXOUT "\\begin{flushright}\n";
	print TEXOUT "\\Huge {\\bf ".Tab::texify($student->first." ".$student->last)."} \\\\ \n";
	print TEXOUT "\\LARGE ".Tab::texify($school->short_name)." ".Tab::texify($school->code)." \\\\ \n";
	print TEXOUT "\\large ".Tab::texify($tourn->name)." \\\\ \n";
	print TEXOUT "\\large ".Tab::texify($weekend->name)." \\\\ \n" if $weekend;
	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\normalsize\n";
	print TEXOUT "\\end{flushright}\n\n";

	my %categories;

	ENTRY:
	foreach my $entry (@entries) { 

		my $code = $entry->code;

		$categories{$entry->event->category->id} = $entry->event->category;

		my @panels = $m->comp(
			"/funclib/entry_panels.mas", 
			entry => $entry
		);

		print TEXOUT "\\noindent\n";
		print TEXOUT "\\textsb{ \\large Entry ".Tab::texify($code)." \\hfill ".$entry->event->name." } \n\n";
		print TEXOUT "\\hrule\n\n";

		if (@panels) { 

			my $switch;
		
			print TEXOUT "\\strut\n";
			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";
			print TEXOUT "\\begin{tabular}{p{.75in}p{1.0in}p{.75in}p{1.5in}p{2in}} \n";

			foreach my $panel (@panels) {

				my $start = $panel->round->timeslot->start;
				$start->set_time_zone($tourn->tz); 
			 
				if ($panel->round->type eq "elim" || $panel->round->type eq "final") {
					print TEXOUT "\\hline\n";
				}

				print TEXOUT "\\rowcolor[rgb]{.92,.92,.92}\n" unless $switch++ % 2;
			 
				print TEXOUT "{\\bf ".$panel->round->realname." }";
				print TEXOUT " & ";
				print TEXOUT $start->day_abbr." "  if scalar @days > 1;
				print TEXOUT $start->hour_12.":".$start->strftime("%M")." ";
				print TEXOUT $start->strftime("%p");
				print TEXOUT " & ";
				print TEXOUT "Sect: ".$panel->letter." & ";
				print TEXOUT "Room: ".Tab::texify($panel->room->name)." " if $panel->room > 0;
				print TEXOUT " & ";

				foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

					print TEXOUT "\\scriptsize\n";
					print TEXOUT "\\parbox[c]{1.95in}{ \\truncate{1.85in}{";

					print TEXOUT Tab::texify($judge->code)." ";
					print TEXOUT Tab::texify($judge->first." ".$judge->last)." ";
					print TEXOUT "\\hfill ";

					print TEXOUT Tab::texify($judge->school->short_name) if $judge->school;
					print TEXOUT " (Hire) " unless $judge->school;

					print TEXOUT "}} ";

				}

				 print TEXOUT "\\\\ \n";
			}	
		
			print TEXOUT "\\end{tabular}\n";

		} else { 
			print TEXOUT "\\strut\n";
			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";
			print TEXOUT "\\hfill \\textsb{\\large No sections yet assigned for this entry} \\hfill \n";
		}

		print TEXOUT "\\strut\n";
		print TEXOUT "\\bigskip\n";
		print TEXOUT "\\newline\n";

	}

	foreach my $cat_id (keys %categories) { 

		print TEXOUT "\\strut\n";
		print TEXOUT "\\medskip\n";
		print TEXOUT "\\newline\n";
		print TEXOUT "\\normalsize\n";

		my $message = $categories{$cat_id}->setting("student_sheet_notice");

		print TEXOUT $m->comp(
			"/funclib/print_format.mas", 
			message => $message
		) if $message;
	
	}

	print TEXOUT "\\newpage\n" if $linebreaks;
	return;

</%init>
