<%args>
	$tourn
	$tourn_settings
	$perms
	$what         => undef
	$sweep_set_id => undef
</%args>
<%init>

	use Tab::NSDA::MundtPoint;
	use Tab::NSDA::MundtDetail;
	use Tab::NSDA::BrunoPoint;
	use Tab::NSDA::BrunoDetail;

	if ($what eq "Print") { 	
		$m->redirect("sweep_students_print.mhtml?sweep_set_id=$sweep_set_id");
	}   

	my @sweep_sets;

	my $master_set = Tab::SweepSet->retrieve($sweep_set_id);

	unless ($master_set) { 
		my $err = "You must select a set of sweepstakes rules to run this report";
		$m->redirect("index.mhtml?err=$err");
	}

	my @results = $m->comp(
		"/tabbing/results/sweep_tourn.mas",
		sweep_set => $master_set,
		tourn     => $tourn
	);

	my $entries_ref = pop @results;
	my %event_by_id = map {$_->id => $_} $tourn->events;
	my $now = DateTime->now();

	my $award;

	foreach my $rule ($master_set->rules) { 
		$award = $rule->value if $rule->tag eq "cumulative";
	}

	if ($award eq "mundt") { 

		foreach my $entry_id (@{$entries_ref->{"entries"}}) { 
			
			next unless $entries_ref->{$entry_id}{"nsda_school_id"};

			foreach my $student_id (keys %{$entries_ref->{$entry_id}{"students"}}) { 

				my $ualt_id = $entries_ref->{$entry_id}{"students"}{$student_id}{"ualt_id"};
				next unless $ualt_id;
				my $num_rounds = scalar( keys %{$entries_ref->{$entry_id}{"rounds"}});

				my $detail = Tab::NSDA::MundtDetail->create({
					DistID         => $entries_ref->{$entry_id}{"districtid"},
					DistName       => $entries_ref->{$entry_id}{"districtname"},
					SchoolName     => $entries_ref->{$entry_id}{"schoolname"},
					CompetitorCode => $entries_ref->{$entry_id}{"code"},
					CompetitorName => $entries_ref->{$entry_id}{"name"},
					tourn_year     => $tourn->start->year,
					Rounds         => $num_rounds,
					nfl_ualt_id    => $entries_ref->{$entry_id}{"students"}{$student_id}{"ualt_id"},
					nfl_school_id  => $entries_ref->{$entry_id}{"nsda_school_id"}
				});

				my $points = Tab::NSDA::MundtPoint->create({
					school_id  => $entries_ref->{$entry_id}{"nsda_school_id"},
					postcode   => "NATS",
					postDate   => $now,
					tourn_year => $tourn->start->year,
					points     => $entries_ref->{$entry_id}{"points"},
					comment    => $tourn->start->year." National Rounds",
					user_id    => "10382636"
				});

				$m->print("<p>Posted ".$detail." and points ".$points." to student ".$student_id." ualt $ualt_id</p>");

			}
		}

		Tab::NSDA::MundtDetail->set_sql(mundt_school_sync => "
			update mundt_detail, NEW_SCHOOLS
			set mundt_detail.SchoolState = NEW_SCHOOLS.school_state,
			 mundt_detail.CharterType = NEW_SCHOOLS.school_charter_status

			 where NEW_SCHOOLS.school_id = mundt_detail.nfl_school_id
			 and mundt_detail.tourn_year = ? 
		");

		Tab::NSDA::MundtDetail->sql_mundt_school_sync->execute($tourn->start->year);

		my $msg = "You must select a set of sweepstakes rules to run this report";
		$m->redirect("index.mhtml?msg=$msg");
	}

	if ($award eq "bruno") { 

		foreach my $entry_id (@{$entries_ref->{"entries"}}) { 

			next unless $entries_ref->{$entry_id}{"nsda_school_id"};

			foreach my $student_id (keys %{$entries_ref->{$entry_id}{"students"}}) { 

				my $ualt_id = $entries_ref->{$entry_id}{"students"}{$student_id}{"ualt_id"};
				next unless $ualt_id;

				my $num_rounds = scalar( keys %{$entries_ref->{$entry_id}{"rounds"}});

				my $detail = Tab::NSDA::BrunoDetail->create({
					DistID         => $entries_ref->{$entry_id}{"districtid"},
					DistName       => $entries_ref->{$entry_id}{"districtname"},
					SchoolName     => $entries_ref->{$entry_id}{"schoolname"},
					CompetitorCode => $entries_ref->{$entry_id}{"code"},
					CompetitorName => $entries_ref->{$entry_id}{"name"},
					tourn_year     => $tourn->start->year,
					Rounds         => $num_rounds,
					nfl_ualt_id    => $ualt_id,
					nfl_school_id  => $entries_ref->{$entry_id}{"nsda_school_id"}
				});

				my $points = Tab::NSDA::BrunoPoint->create({
					school_id  => $entries_ref->{$entry_id}{"nsda_school_id"},
					postcode   => "NATS",
					postDate   => $now,
					tourn_year => $tourn->start->year,
					points     => $entries_ref->{$entry_id}{"points"},
					comment    => $tourn->start->year." National Rounds",
					user_id    => "10382636"
				});

				$m->print("<p>Posted ".$detail." and points ".$points." to student ".$student_id." ualt $ualt_id</p>");

			}
		}

		Tab::NSDA::BrunoDetail->set_sql(bruno_school_sync => "
			update bruno_detail, NEW_SCHOOLS
			set bruno_detail.SchoolState = NEW_SCHOOLS.school_state,
			 bruno_detail.CharterType = NEW_SCHOOLS.school_charter_status

			 where NEW_SCHOOLS.school_id = bruno_detail.nfl_school_id
			 and bruno_detail.tourn_year = ? 
		");

		Tab::NSDA::BrunoDetail->sql_bruno_school_sync->execute($tourn->start->year);
		
		my $msg = "You must select a set of sweepstakes rules to run this report";
		$m->redirect("index.mhtml?msg=$msg");

	}

</%init>
