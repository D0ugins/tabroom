<%args>
	$tourn
</%args>
<%init>

	Tab::Entry->columns(TEMP => "eventid");
	Tab::Entry->columns(TEMP => "schcode");
	Tab::Entry->columns(TEMP => "catcode");

	Tab::Entry->set_sql( last_rounds => "
		select entry.*, school.code as schcode, school.name as schname, school.code as regname,
				max(round.name) as panelid,
				category.abbr as catcode, event.abbr as regcode, event.id as eventid
			from (entry, school, round, panel, ballot, event, category)
			where entry.school = school.id
			and school.tourn = ?
			and entry.active = 1
			and entry.id = ballot.entry
			and entry.event = event.id
			and event.category = category.id
			and ballot.panel = panel.id
			and panel.round = round.id
			and (round.type = 'elim' or round.type = 'final' or round.type = 'runoff')
			group by entry.id
			order by school.name, round.name DESC
	");

	my @all_entries = Tab::Entry->search_last_rounds($tourn->id);

	my @rounds =
		$m->comp("/funclib/tourn_rounds.mas", tourn => $tourn);

	my %round_label =
		map {$_->name."-".$_->event->id => $_->label}
		@rounds;

	my $usa_wsdc;
	foreach my $event ($tourn->events(type => "wsdc")) {
		$usa_wsdc = $event if $event->setting("usa_wsdc");
	}

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;

	my $filename = "LastRoundActive-".$name.".csv";

    $m->clear_buffer;

	$r->content_type('application/csv');

	$r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	$m->print("School,SchCode,Code,Name,Entry Code,Event,Category,Last Round\n");

	my $counter;

	foreach my $entry (@all_entries) {

		next if $usa_wsdc && $entry->event->id == $usa_wsdc->id;

		$m->print('"'.$entry->schname);
		$m->print('","');
		$m->print($entry->schcode);
		$m->print('","');
		$m->print($entry->regname);
		$m->print('","');
		$m->print($entry->name);
		$m->print('","');
		$m->print($entry->code);
		$m->print('","');
		$m->print($entry->regcode);
		$m->print('","');
		$m->print($entry->catcode);
		$m->print('","');
		$m->print($round_label{$entry->panelid."-".$entry->eventid});
		$m->print('","');
		$m->print("Round ".$entry->panelid);
		$m->print('"'."\n");

	}

	if ($usa_wsdc) {

		foreach my $entry (@all_entries) {

			next unless $entry->event->id == $usa_wsdc->id;

			foreach my $student (sort {$a->last cmp $b->last} $entry->students) {

				$m->print('"'.$student->chapter->name);
				$m->print('","');
				$m->print('","');
				$m->print($student->first." ".$student->middle." ".$student->last);
				$m->print('","');
				$m->print($entry->code);
				$m->print('","');
				$m->print($entry->regcode);
				$m->print('","');
				$m->print($round_label{$entry->panelid."-".$entry->eventid});
				$m->print('","');
				$m->print("Round ".$entry->panelid);
				$m->print('"'."\n");


			}

		}

	}

	$m->flush_buffer();
	$m->abort();

</%init>


