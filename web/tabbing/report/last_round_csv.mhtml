<%args>
	$tourn
</%args>
<%init>

	Tab::Entry->set_sql( last_rounds => "
		select entry.*, school.name as schname, school.code as regname, 
				round.name as panelid, round.label as othername
			from (entry, school, round, panel, ballot)
			where entry.school = school.id
			and school.tourn = ?
			and entry.active = 1 
			and entry.id = ballot.entry
			and ballot.panel = panel.id
			and panel.round = round.id
			order by school.name
	");

	my @all_entries = Tab::Entry->search_last_rounds($tourn->id);

	my $name = $tourn->name;
	$name =~ s/[\W_]//g;
	my $filename = "LastRoundActive-".$name;

    $m->clear_buffer;
	$r->content_type('application/csv');
	$r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	$m->print("School,Code,Name,Last Round\n");

	foreach my $entry (@all_entries) { 

		$m->print('"'.$entry->schname);
		$m->print('","');
		$m->print($entry->regname);
		$m->print('","');
		$m->print($entry->name);
		$m->print('","');
		if ($entry->othername) { 
			$m->print($entry->othername);
		} else { 
			$m->print("Round ".$entry->panelid);
		}
		$m->print('"'."\n");

	}

	$m->flush_buffer();
	$m->abort();

</%init>

	
