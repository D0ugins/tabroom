<%args>
	$tourn
	$tourn_settings
	$sweep_set_id => undef
	$what         => undef
</%args>
<%init>

	if ($what eq "Print") { 	
		$m->redirect("sweep_schools_print.mhtml?sweep_set_id=$sweep_set_id");
	}   

	my @sweep_sets;

	my $ncfl++ if $tourn_settings->{"ncfl"};
	my $regions++ if $tourn_settings->{"regions"};
	
	my $master_set = Tab::SweepSet->retrieve($sweep_set_id);

	$m->print("No sweepstakes set selected") unless $master_set;
	$m->abort() unless $master_set;

	my ($points_ref, $count_ref, $countstring_ref) = 
		$m->comp(
			"/tabbing/results/sweep_schools.mas", 
			sweep_set => $master_set
		);

</%init>

	<& menu.mas &>

	<div class="main">

		<div>

			<span class="half nospace">
				<h4><% $master_set->name %></h4>
			</span>


			<span class="half nospace rightalign">

				<form action="sweep_schools.mhtml" method="post">

				<select 
					name     = "sweep_set_id"
					class    = "fixedmed"
					onchange = 'this.form.submit();'
				> 

%					foreach my $set (sort {$a->name cmp $b->name} $tourn->sweep_sets) {

						<option 
							<% $set->id eq $sweep_set_id ? 'selected="selected"' : "" %> 
							value="<% $set->id %>"
						> <% $set->name %> </option>
%					}
				</select>
				</form>
			</span>

			<div class="full centeralign padless marno explain">
				Hover over a school to see breakdown
			</div>

		</div>


		<& /funclib/tablesorter.mas, table => "sortme" &>

		<table id="sortme">

			<thead>
				<tr class="yellowrow">

					<th class="smallish">
					</th>

					<th class="smallish">
						School
					</th>

%					if ($ncfl) { 
						<th class="smallish">
							Diocese
						</th>
%					} elsif ($regions) { 
						<th class="smallish">
							Region
						</th>
%					} else { 
						<th class="smallish">
							State
						</th>
%					} 

					<th class="smallish">
						Total Entries
					</th>

					<th class="smallish">
						Counted Entries* 
					</th>

					<th class="smallish">
						Points
					</th>

				</tr>

			</thead>

			<tbody>


<%perl>

				my $count = 1;

				my $switch;
				my $place;
				my $last_points;
				my $add_to_place;

				foreach my $school (
					sort {${$points_ref}{$b->id} <=> ${$points_ref}{$a->id}} 
					$tourn->schools
				) { 

					next unless ${$points_ref}{$school->id};

					my $tie;

					if ($last_points == ${$points_ref}{$school->id}) { 
						$add_to_place++;
						$tie++;
					} elsif ($add_to_place) { 
						$place++;
						$place += $add_to_place;
						undef $add_to_place;
					}  else { 
						$place++;
					}

					$last_points = ${$points_ref}{$school->id};

</%perl>

			
					<tr 
						class = "hover"
						title = "<% ${$countstring_ref}{$school->id} %>"
					> 

						<td class="smallish">
							<% $tie ? "T-" : "" %><% $place %>
						</td>

						<td class="smallish">
							<% $school->short_name %>
						</td>

						<td class="smallish">
							<% $regions 
								|| $ncfl 
									? $school->region->code 
									: $school->chapter 
										? $school->chapter->state 
										: "" 
							%>
						</td>

						<td class="smallish rightalign">
							<% scalar ($school->entries( active => 1)) %>
						</td>

						<td class="smallish rightalign">
							<% ${$count_ref}{$school->id} %>
						</td>

						<td class="smallish rightalign">
							<% ${$points_ref}{$school->id} %>
						</td>

					</tr>

%				}

			</tbody>

		</table>


	</div>

