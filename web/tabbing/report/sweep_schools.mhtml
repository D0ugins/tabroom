<%args>
	$tourn
	$tourn_settings
	$perms
	$sweep_set_id => undef
	$what         => undef
</%args>
<%init>

	if ($what eq "Print") {
		$m->redirect("sweep_schools_print.mhtml?sweep_set_id=$sweep_set_id");
	}

	my @sweep_sets;

	my $ncfl++ if $tourn_settings->{"ncfl"};
	my $regions++ if $tourn_settings->{"regions"};

	my $master_set = Tab::SweepSet->retrieve($sweep_set_id);

	$m->print("No sweepstakes set selected") unless $master_set;

	$m->abort() unless $master_set;

	my ($points_ref, $count_ref, $countstring_ref, $results) =
		$m->comp(
			"/tabbing/results/sweep_schools.mas",
			sweep_set => $master_set
		);

	my $cumulatives = $master_set->rules(tag => "cumulative")->first;

	my %cumulative_points = $m->comp(
		"cumulative_sweeps.mas",
		set => $master_set,
		tourn => $tourn
	) if $cumulatives;

	my %last_round;

	if ($tourn_settings->{nsda_nats}) {

		my $dbh = Tab::DBI->db_Main();
		my $sth = $dbh->prepare("
			select entry.id, max(round.name)
			from entry, ballot, panel, round, event
			where event.tourn = ?
			and event.id = round.event
			and round.id = panel.round
			and panel.id = ballot.panel
			and ballot.entry = entry.id
			and entry.active = 1
			group by entry.id
		");

		$sth->execute($tourn->id);

		while (
			my ($entry_id, $round_name) = $sth->fetchrow_array()
		) {
			$last_round{$entry_id} = $round_name;
		}
	}

</%init>

	<& "menu.mas",
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		perms          => $perms
	&>

	<div class="main">

		<div>

			<span class="half nospace">
				<h4>Sweepstakes Report: <% $what %></h4>
			</span>

			<span class="threeeighths nospace rightalign">

				<form
					action = "sweep_schools.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "what"
					value = "<% $what %>"
				>

				<select
					name     = "sweep_set_id"
					class    = "fixedbig"
					onchange = 'this.form.submit();'
				>


%					foreach my $set (sort {$a->name cmp $b->name} $tourn->sweep_sets) {

						<option
							<% $set->id eq $sweep_set_id ? 'selected="selected"' : "" %>
							value="<% $set->id %>"
						> <% $set->name %> </option>
%					}
				</select>
				</form>
			</span>

			<span
				id="sweeps_table_buttonarea"
				class="eighth nospace rightalign"
			>

			</span>

			<div class="full centeralign padless marno explain">
				Hover over a school to see breakdown
			</div>

		</div>

		<& "/funclib/tablesorter.mas", table => "sweeps_table" &>

		<table id="sweeps_table">

			<thead>
				<tr class="yellowrow">

					<th class="smallish">
					</th>

					<th class="smallish">
						School
					</th>

%					if ($ncfl) {
						<th class="smallish">
							Diocese
						</th>
%					} elsif ($regions) {
						<th class="smallish">
							Region
						</th>
%					} else {
						<th class="smallish">
							State
						</th>
%					}

					<th class="smallish">
						Total Entries
					</th>

					<th class="smallish">
						Counted Entries*
					</th>

%				 	if ($cumulatives) {

						<th class="smallish">
							This Year
						</th>

						<th class="smallish">
							Cumulated
						</th>

						<th class="smallish">
							Total
						</th>

%					} else {

						<th class="smallish">
							Average
						</th>

						<th class="smallish">
							Total
						</th>

%					}

				</tr>

			</thead>

			<tbody>
<%perl>

				my $count = 1;

				my $switch;
				my $place;
				my $last_points;
				my $add_to_place;

				foreach my $school (
					sort {${$points_ref}{$b->id} <=> ${$points_ref}{$a->id}}
					$tourn->schools
				) {

					my $school_id = $school->id;

					next unless ${$points_ref}{$school_id};

					my $tie;

					if ($last_points == ${$points_ref}{$school_id}) {
						$add_to_place++;
						$tie++;
					} elsif ($add_to_place) {
						$place++;
						$place += $add_to_place;
						undef $add_to_place;
					}  else {
						$place++;
					}

					$last_points = ${$points_ref}{$school_id};

</%perl>


					<tr
						class = "hover"
						title = "<% ${$countstring_ref}{$school_id} %>"
					>

						<td class="smallish">
							<span class="hidden"><% $place %></span>
							<% $tie ? "T-" : "" %><% $place %>
						</td>

						<td class="smallish">
							<% $school->name %>
						</td>

						<td class="smallish">
							<% ($regions || $ncfl) && $school->region
								? $school->region->code
								: $school->chapter
									? $school->chapter->state
									: ""
							%>
						</td>

						<td class="smallish rightalign">
							<% scalar ($school->entries( active => 1)) %>
						</td>

						<td class="smallish rightalign">
							<% ${$count_ref}{$school_id} %>
						</td>

%					 	unless ($cumulatives) {
							<td class="smallish rightalign">
								<% ${$count_ref}{$school_id}
									?  sprintf("%.2f", (${$points_ref}{$school_id} /  ${$count_ref}{$school_id} ))
									: 0
								%>
							</td>
%						}

						<td class="smallish rightalign">
							<% ${$points_ref}{$school_id} %>
						</td>

%					 	if ($cumulatives) {

							<td class="smallish rightalign">
								<% $cumulative_points{$school_id} %>
							</td>

							<td class="smallish rightalign">
								<% (${$points_ref}{$school_id} + $cumulative_points{$school_id}) %>
							</td>
%						}

					</tr>

%					if ($what eq "Audit") {

%						foreach my $entry_id (sort keys %{$results->{$school_id}}) {

							<tr>

								<td>
									<span class="hidden"><% $place %></span>
								</td>

								<td class="smallish">
									<span class="hidden"><% $school->name %></span>
								</td>

								<td class="smallish">
									<% $results->{$school_id}{$entry_id}{"code"} %>
								</td>

								<td class="smallish">
									<% $results->{$school_id}{$entry_id}{"event"} %>
								</td>

								<td class="smallish">
									Rd <% $last_round{$entry_id} %>
								</td>

								<td class="smallish">
									Pts
								</td>
								<td class="smallish">
									<% $results->{$school_id}{$entry_id}{"points"} %>
								</td>
							</tr>
%						}

						<tr>
							<td colspan="10">
								<span class="hiddencsv">-</span>
							</td>
						</tr>

%					}

%				}

			</tbody>

		</table>


	</div>

