<%args>
	$tourn
	$tourn_settings
	$perms
	$only_category => undef
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("

		select
			event.id, event.abbr, event.name,
			round.id, round.name, round.label, round.type,
			panel.id, panel.letter,
			ballot.id,
			score.id,
			entry.id, entry.code, entry.name,
			school.code, school.name, school.state,
			sum(speech.value),
			GROUP_CONCAT(speech.value)

			from (event, round, panel, ballot, score, entry)

			left join score speech
				on speech.ballot = ballot.id
				and speech.tag = 'speech'

			left join school
				on entry.school = school.id

			where event.tourn = ?
				and event.type = 'congress'
				and event.id = round.event
				and round.id = panel.round
				and panel.id = ballot.panel
				and ballot.id = score.ballot
				and score.tag = 'po'
				and ballot.entry = entry.id

			group by entry.id, panel.letter
			order by event.id, round.name, panel.letter
	");

	$sth->execute($tourn->id);

</%init>

	<& menu.mas,
		perms          => $perms,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		only_category  => $only_category,
		whoami         => "po_report"
	&>

	<div class="main">

	<& "/funclib/tablesorter.mas", table => "po" &>

	<span class="threequarters nospace">
		<h5>Presiding Officers</h5>
	</span>
	<span
		class = "quarter rightalign nospace"
		id    = "po_buttonarea"
	>
	</span>

	<table id="po">

		<thead>

			<tr class="yellowrow smallish">

				<th>
					Event
				</th>

				<th>
					Session
				</th>

				<th>
					Chamber
				</th>

				<th>
					Entry
				</th>

				<th>
					School
				</th>

				<th>
					ST
				</th>

				<th>
					PO Total
				</th>

				<th>
					PO Scores
				</th>
			</tr>
		</thead>

		<tbody>

<%perl>
			while (
				my (
					$event_id, $event_abbr, $event_name,
					$round_id, $round_name, $round_label, $round_type,
					$panel_id, $panel_letter,
					$ballot_id,
					$score_id,
					$entry_id, $entry_code, $entry_name,
					$school_code, $school_name, $school_state,
					$speech_string, $speech_total
				) = $sth->fetchrow_array()
			) {
</%perl>

				<tr>

					<td class="centeralign">
						<% $event_abbr%>
					</td>

					<td class="centeralign">
						<span class="hidden"><% $round_name %></span>
						<% $round_label ? substr($round_label, 0, 7) : $round_name %>
					</td>

					<td class="centeralign">
						<% $panel_letter %>
					</td>

					<td class="nospace">
						<a
							class="white full padvert marno"
							title="<% $entry_name %>"
							href="/register/entry/edit.mhtml?entry_id=<% $entry_id %>"
						><% $entry_code %></a>
					</td>

					<td
						title = "<% $school_name %>"
					>
						<% substr($m->comp('/funclib/short_name.mas', name => $school_name), 0, 16) %>
					</td>

					<td class="centeralign">
						<% $school_state %>
					</td>

					<td class="rightalign">
						<% $speech_string %>
					</td>

					<td class="rightalign">
						<% $speech_total %>
					</td>
				</tr>
%			}

%			$sth->finish();
%			$dbh->disconnect();

		</tbody>

	</table>

	</div>


