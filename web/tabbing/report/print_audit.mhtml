<%args>
	$tourn
	$session
	$timeslot_id
	$no_points => undef
</%args>
<%init>

	my $session_category = $session->category;

	my $session_event = $session->event 
		if $session->event && $session->event->id;

	my $name;

	my @events;

	if ($session_event) { 
		$name = $session_event->name;
		push @events, $session_event;
	} else { 
		$name = $session_category->name;
		push @events, $session_category->events;
	}

	$name =~ s/[\W_]//g;

    my $filename = "BallotAudit-$name-".$session->id;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`; 

	my $no_codes++ if $session_category->setting("no_codes");
    
    $m->comp("/funclib/printout.mas", 
		tourn    => $tourn,
		filename => $filename,
		head     => 1,
		array    => '1.2',
		wide     => 1 
	);

    open (TEXOUT, ">>$filepath.tex");

	print TEXOUT "\\renewcommand {\\TruncateMarker}{} \n";

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id);

	my @ballots = $m->comp(
		"/funclib/timeslot_ballots.mas", 
		timeslot => $timeslot
	);

	my %panel_ballots;

	foreach my $ballot (@ballots) { 
		push @{$panel_ballots{$ballot->panel->id."-".$ballot->judge->id}}, $ballot;
	}

	foreach my $event (@events) {  
	
		print TEXOUT "\\noindent\n";
		print TEXOUT "{\\LARGE \\bf ".Tab::texify($event->name);
		print TEXOUT " \\hfill ".Tab::texify($timeslot->name)." ballot check }\n";
		print TEXOUT "\\bigskip\n";
		print TEXOUT "\\newline\n";
		print TEXOUT "\\footnotesize\n";

		my $switch;

		my $limit = "and round.event = ".$event->id."\n";

		my @judges = sort {$a->last cmp $b->last} $m->comp(
			"/funclib/timeslot_judges.mas", 
			timeslot => $timeslot,
			limit    => $limit
		);
	
		my $tabular;

		my $aff_string = $event->setting("aff_label");
		my $neg_string = $event->setting("neg_label");

		$aff_string = "Aff" unless $aff_string;
		$neg_string = "Neg" unless $neg_string;

		my $event_type = $event->type;

		$event_type = "debate" 
			if $event_type eq "debate" 
			|| $event_type eq "policy" 
			|| $event_type eq "pf" 
			|| $event_type eq "ld" 
			|| $event_type eq "parli";

		if ($event_type) { 

			$tabular = "\\begin{tabular}{p{.75in}p{1in}p{1.25in}p{1in}p{1.25in}p{1in}}\n";

		} elsif ($event_type eq "wudc") { 

			$tabular = "\\begin{tabular}{p{.75in}p{.25in}p{.75in}p{.25in}p{1.25in}p{.25in}p{.75in}p{.25in}p{1.25in}}\n";

		} elsif ($event_type eq "speech" || $event_type eq "congress") { 

			$tabular = "\\begin{tabular}{p{.75in}p{.5in}p{6in}}\n";
		}

		foreach my $judge (@judges) {  

			my @panels = $m->comp("/funclib/judge_panels.mas", 
				judge    => $judge,
				timeslot => $timeslot
			);

			foreach my $panel (@panels) { 
				
				next if $panel->round->event->id != $event->id;

				my @scores = $m->comp("/funclib/panel_scores.mas", judge => $judge, panel => $panel);

				my @ballots = 
					sort {$a->side <=> $b->side} @{$panel_ballots{$panel->id."-".$judge->id}} 
					if $panel_ballots{$panel->id."-".$judge->id};

				next unless @ballots;

				if ($event_type eq "debate" || $event_type eq "wsdc") { 

					print TEXOUT $tabular;
					print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" unless $switch++ % 2;

					if ($panel->bye) { 

						print TEXOUT "BYE & \\truncate{.95in}{ ";

						my $first = shift @ballots if @ballots;
						print TEXOUT $first->entry->code if $first;
						print TEXOUT " } & & \\truncate{.95in}{ ";

						my $second = shift @ballots if @ballots;
						print TEXOUT $second->entry->code if $second;
						print TEXOUT " } & & \n";

					} else { 

						print TEXOUT "\t\\truncate{.75in}{".Tab::texify($judge->code." ".$judge->last)."}\n & " 
							unless $no_codes;

						print TEXOUT "\t\\truncate{.75in}{".Tab::texify($judge->last.", ".$judge->first)."}\n &" 
							if $no_codes;

						my $aff_bye;
						my $neg_bye;

						my $first = shift @ballots if @ballots;
						my $second = shift @ballots if @ballots;

						my $winner;

						$aff_bye = uc($aff_string)." FFT" if $first && $first->forfeit;
						$aff_bye = uc($aff_string)." BYE" if $first && $first->bye;

						$neg_bye = uc($neg_string)." FFT" if $second && $second->forfeit;
						$neg_bye = uc($neg_string)." BYE" if $second && $second->bye;

						print TEXOUT "\\truncate{.95in}{ \t\t".Tab::texify($first->entry->code)." } & ";

						print TEXOUT "\\begin{minipage}[c]{1.2in} ";
						print TEXOUT "\\vspace{.04in} \n";

						my $notfirst;

						my %student_order = ();

						my $counter;

						my @students = $first->entry->students;

						foreach my $student (@students) { 
							
							my $rank;
							my $points;
							my $reply_points;

							my $position;
							$counter++; 

							foreach my $score (@scores) { 

								$rank = $score->value 
									if $score->tag eq "rank" 
									&& $score->student->id == $student->id;

								$points = $score->value 
									if $score->tag eq "points" 
									&& $score->student->id == $student->id;


								# WSDC
								$position = $score->position 
									if $score->tag eq "points" 
									&& $score->student->id == $student->id
									&& $score->position;  

								$reply_points = $score->value 
									if $score->tag eq "rebuttal_points" 
									&& $score->student->id == $student->id;

								next if $winner;

								next unless $score->tag eq "ballot" && $score->value == 1;

								$winner = $aff_bye." ".$neg_bye if $aff_bye || $neg_bye;

								my $winner_break = "\\textendash ";

								if ($event_type eq "wsdc") { 
									$winner_break = " } \\newline \\truncate{.95in}{\t\t ";
								}

								$winner .= $aff_string." ".$winner_break if $score->ballot->side == 1;
								$winner .= $neg_string." ".$winner_break if $score->ballot->side == 2;

								$winner .= Tab::texify($score->ballot->entry->code);

							}

							$points .= " \\hfill ".$reply_points if $points && $reply_points;

							if ($rank || $points) { 
								$position = $counter unless $position; 
								$student_order{$position}{"rank"} = $rank;
								$student_order{$position}{"points"} = $points;
								$student_order{$position}{"name"} = $student->last;
							}


						} 

						foreach my $order (sort(keys %student_order)) { 

							print TEXOUT "\\newline " if $notfirst++;

							if ($event_type eq "wsdc") { 

								print TEXOUT "\\makebox[.64in]{\\truncate{.58in}{".Tab::texify($student_order{$order}{"name"})."}}";

								unless ($no_points) { 

									print TEXOUT "\\makebox[.50in][l]{".$student_order{$order}{"points"}."} " 
										if $student_order{$order}{"points"};

								}

							} else { 

								print TEXOUT "\\makebox[.72in]{\\truncate{.7in}{".Tab::texify($student_order{$order}{"name"})."}}";

								unless ($no_points) { 

									print TEXOUT "\\makebox[.44in][l]{".$student_order{$order}{"points"}."} " 
										if $student_order{$order}{"points"};

								}
							}


							print TEXOUT "\\makebox[.1in][l]{".$student_order{$order}{"rank"}."} " 
								if $student_order{$order}{"rank"};

						}

						print TEXOUT "\\end{minipage} \n \\vspace{.075in}\n";

						print TEXOUT " & ";

						print TEXOUT "\\truncate{.95in}{ \t\t".Tab::texify($second->entry->code)."} \n " 
							if $second && $second->entry;

						print TEXOUT " & ";

						print TEXOUT "\\begin{minipage}[c]{1.2in} ";
						print TEXOUT "\\vspace{.04in} \n";

						undef $notfirst;

						undef %student_order; 

						if ($second && $second->entry) { 

							my @students = $second->entry->students;

							my $counter;

							foreach my $student (@students) { 

								$counter++;

								my $rank;
								my $points;
								my $reply_points;

								my $position;

								foreach my $score (@scores) { 

									$rank = $score->value 
										if $score->tag eq "rank" 
										&& $score->student->id == $student->id;

									$points = $score->value 
										if $score->tag eq "points" 
										&& $score->student->id == $student->id;

									# WSDC
									$position = $score->position 
										if $score->tag eq "points" 
										&& $score->student->id == $student->id
										&& $score->position;  

									$reply_points = $score->value 
										if $score->tag eq "rebuttal_points" 
										&& $score->student->id == $student->id;
								}

								$points .= " \\hfill ".$reply_points if $points && $reply_points;

								if ($rank || $points) { 
									$position = $counter unless $position;
									$student_order{$position}{"rank"} = $rank;
									$student_order{$position}{"points"} = $points;
									$student_order{$position}{"name"} = $student->last;
								}


							}

						}

						foreach my $order (sort(keys %student_order)) { 

							print TEXOUT "\\newline \n" if $notfirst++;

							if ($event_type eq "wsdc") { 

								print TEXOUT "\\makebox[.64in]{\\truncate{.58in}{".Tab::texify($student_order{$order}{"name"})."}}";

								unless ($no_points) { 

									print TEXOUT "\\makebox[.50in][l]{".$student_order{$order}{"points"}."} " 
										if $student_order{$order}{"points"};

								}

							} else { 

								print TEXOUT "\\makebox[.72in]{\\truncate{.7in}{".Tab::texify($student_order{$order}{"name"})."}}";

								unless ($no_points) { 
									print TEXOUT "\\makebox[.44in][l]{".$student_order{$order}{"points"}."} " 
										if $student_order{$order}{"points"};
								}
							}

							print TEXOUT "\\makebox[.1in][l]{".$student_order{$order}{"rank"}."} " if $student_order{$order}{"rank"};

						}

						print TEXOUT "\\end{minipage} \n";

						print TEXOUT " & ";

						print TEXOUT "\\vspace{.075in}\n" unless $event_type eq "wsdc";
						print TEXOUT "\\vspace{-.15in}\n" if $event_type eq "wsdc";

						$winner = "\\bf {\\color{red} WOE IS ME! }} \\newline \\truncate{.95in}{ \\bf {\\color{red}  NO WINNER! }" unless $winner;

						print TEXOUT "\\truncate{.95in}{".$winner."} \n" if $winner;

					}

					print TEXOUT "\\end{tabular}\n";
					print TEXOUT "\\newline\n";

				} elsif ($event_type eq "wudc") { 
				
					@ballots = sort {$a->speakerorder <=> $b->speakerorder} @ballots;
					
					print TEXOUT $tabular;
					print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" if $switch % 2;

					print TEXOUT "\t\\truncate{.75in}{".Tab::texify($judge->code." ".$judge->last)."}\n & " unless $no_codes;
					print TEXOUT "\t\\truncate{.75in}{".Tab::texify($judge->last.", ".$judge->first)."}\n &" if $no_codes;

					my @positions = ( "1G", "1O", "2G", "2O" );

					foreach my $ballot (@ballots) { 

						my $order = shift @positions;

						print TEXOUT $order.". & ";
						print TEXOUT "\\truncate{.73in}{".Tab::texify($ballot->entry->code)."} & ";

						my $rank;
						foreach my $score (@scores) { 
							$rank = $score->value if $score->tag eq "rank" && $score->ballot->id == $ballot->id;
						}
						print TEXOUT (4 - $rank)." & ";

						print TEXOUT "\\begin{minipage}{1.25in}\n";

						my $notfirst;

						foreach my $student ($ballot->entry->students) { 

							print TEXOUT "\\newline " if $notfirst++;

							my $points;
							foreach my $score (@scores) { 
								$points = $score->value 
									if $score->tag eq "points" 
									&& $score->student->id == $student->id;
							}

							print TEXOUT "\\makebox[.95in]{\\truncate{.90in}{";
							print TEXOUT Tab::texify($student->last.", ".$student->first)."}}";
							print TEXOUT "\\makebox[.25in][l]{".$points."} " if $points;
						}

						print TEXOUT "\\end{minipage}\n";

						if ($order eq "1O") {
							print TEXOUT "\\\\ \n";
							print TEXOUT "\\rowcolor[rgb]{.84,.84,.84}\[5.5pt\]\[5.5pt\]\n" if $switch % 2;
							print TEXOUT " & ";
						} elsif ($order eq "2O") {

						} else { 
							print TEXOUT " & ";
						}

					}

					$switch++;
					
					print TEXOUT "\\end{tabular}\n";
					print TEXOUT "\\newline\n";

				} elsif ($event_type eq "speech" || $event_type eq "congress") { 

					$tabular = "\\begin{tabular}{p{.75in}|p{6.25in}}\n";

					@ballots = sort {$a->speakerorder <=> $b->speakerorder} @ballots;

					$switch++;

					print TEXOUT $tabular;
					print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" if $switch % 2;

					print TEXOUT "\\hline\n" if $switch % 2;

					print TEXOUT "\t\\truncate{1in}{".Tab::texify($judge->code." ".$judge->last)."}\n & " 
						unless $no_codes;

					print TEXOUT "\t\\truncate{1in}{".Tab::texify($judge->last.", ".$judge->first)."}\n &" 
						if $no_codes;

					print TEXOUT " \\mbox{ ";

					my $balcount;

					foreach my $ballot (@ballots) { 

						if ($balcount++ > 4) { 
							
							print TEXOUT "} \n";
							print TEXOUT "\\end{tabular}\n";
							print TEXOUT "\\newline\n";
							print TEXOUT $tabular;
							print TEXOUT "\\rowcolor[rgb]{.90,.90,.90}\[5.5pt\]\[5.5pt\]\n" if $switch % 2;
							print TEXOUT "\t & ";
							print TEXOUT " \\mbox{ ";

							$balcount = 1;

						}

						print TEXOUT "\n \\makebox[.75in][r]{\\emph{".Tab::texify($ballot->entry->code).":} } ";

						my $rank;
						my $points;

						foreach my $score (@scores) { 

							$rank = $score->value if $score->tag eq "rank" 
								&& $score->ballot->id == $ballot->id;

							$points = $score->value if $score->tag eq "points" 
								&& $score->ballot->id == $ballot->id;

						}

						if ($ballot->forfeit) { 
							print TEXOUT "\\makebox[.45in][c]{\\bf FFT }";
						} else { 
							print TEXOUT "\\makebox[.2in][c]{\\bf ".$rank;
							print TEXOUT " tv" if $ballot->tv;
							print TEXOUT "}";
							print TEXOUT "\\makebox[.2in][c]{--".$points."} " if $points;
						}

					}

					print TEXOUT "} \\\\ \n";
					print TEXOUT "\\hline\n" if $switch % 2;
					print TEXOUT "\\end{tabular}\n";
					print TEXOUT "\\newline\n";

				} 
			}
		}	
	}	

	close TEXOUT;
    $m->comp("/funclib/printout.mas", tourn => $tourn, filename => $filename, tail => 1 );

</%init>

