<%args>
	$tourn
	$person
	$target_id => undef
	$parent_id => undef
</%args>
<%init>

	$m->clear_buffer();
	$r->content_type('application/json');

	unless ($target_id) {
		$m->print('{ "error": true, "message": "No ballot ID sent"}');
		$m->abort();
	}

	my $ballot = Tab::Ballot->retrieve($target_id);

	unless ($ballot) {
		$m->print('{ "error": true, "message": "No ballot ID retrieved"}');
		$m->abort();
	}

	my $judge = $ballot->judge;
	my $panel = $ballot->panel;

	Tab::Ballot->set_sql( sanitize_ballot => "
		delete from ballot
		where ballot.panel = ?
		and (
			ballot.entry = 0
			or ballot.entry is null
			or ballot.entry = ''
		)
	");

	Tab::Ballot->sql_sanitize_ballot->execute($panel->id);

	Tab::Ballot->set_sql( clear_ballot_start => "
		update panel, ballot
		set ballot.judge_started = NULL, panel.started = NULL
		where ballot.judge = ?
		and ballot.panel = panel.id
		and panel.id = ?
	");

	Tab::Ballot->set_sql( set_ballot_start => "
		update panel, ballot
		set ballot.judge_started = ?, panel.started = ?
		where ballot.judge = ?
		and ballot.panel = panel.id
		and panel.id = ?
	");

	my $message;
	my $reply;
	my $return_to;

	if ($parent_id eq "started_body") {

		Tab::Ballot->sql_clear_ballot_start->execute($judge->id, $panel->id);

		$message = $judge->last." section ".$panel->letter;
		$message .= " Flight ".$panel->flight if $panel->flight > 1;
		$message .= " marked unstarted";

		$reply = "-";

		$return_to = "unstarted_body";

	} elsif ($parent_id eq "unstarted_body") {

		my $now = DateTime->now(time_zone => $tourn->tz);

		Tab::Ballot->sql_set_ballot_start->execute(
			DateTime::Format::MySQL->format_datetime($now),
			DateTime::Format::MySQL->format_datetime($now),
			$judge->id,
			$panel->id
		);

		$message = $judge->last." section ".$panel->letter;
		$message .= " Flight ".$panel->flight if $panel->flight > 1;
		$message .= " marked started";
		$return_to = "started_body";

		$reply = $now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p');

	} else {

		$m->print('{
			"error": true,
			"message": "No valid value sent for starting this round"
		}');

		$m->abort();

	}

	$m->print('{
		"error"     : false,
		"message"   : "'.$message.'",
		"reply"     : "'.$reply.'",
		"newParent" : "'.$return_to.'"
	}');

	$m->abort();

</%init>

