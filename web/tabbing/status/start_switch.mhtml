<%args>
	$person
	$target_id => undef
	$parent_id => undef
</%args>
<%init>

	$m->clear_buffer();
	$r->content_type('application/json');

	unless ($target_id) { 
		$m->print('{ "error": true, "message": "No ballot ID sent"}');
		$m->abort();
	}

	my $ballot = Tab::Ballot->retrieve($target_id);

	unless ($ballot) { 
		$m->print('{ "error": true, "message": "No ballot ID retrieved"}');
		$m->abort();
	}

	my @ballots = Tab::Ballot->search(
		judge => $ballot->judge->id,
		panel => $ballot->panel->id
	);

	my $message;
	my $reply;

	Tab::Ballot->set_sql( update_ballot_start => "
		update ballot
		set judge_started = NULL
		where id = ? 
	");

	my $counter;
	my $return_to;

	foreach my $ballot (@ballots) { 
		
		next unless $ballot->entry;
		next unless $ballot->entry->event;
		next unless $ballot->entry->event->tourn;

		$counter++;

		if ($parent_id eq "started_body") { 

			$reply = $ballot->panel->round->event->abbr unless $reply;
			$message = $ballot->judge->last." ballots marked unstarted" unless $message;

			Tab::Ballot->sql_update_ballot_start->execute($ballot->id);

			$return_to = "unstarted_body";

		} elsif ($parent_id eq "unstarted_body") { 

			my $tz = $ballot->entry->event->tourn->tz;
			$tz = "UTC" unless $tz;

			my $now = DateTime->now(time_zone => $tz);

			$ballot->judge_started($now);
			$ballot->update();

			unless ($ballot->panel->started) { 
				$ballot->panel->started($now);
				$ballot->panel->update();
			}

			$reply = Tab::nicetime($now) unless $reply;
			$message = $ballot->judge->last." ballots marked started" unless $message;
			$return_to = "started_body";
 
		} else { 

			$m->print('{ "error": true, "message": "No other value sent"}');
			$m->abort();
		}

	}

	$m->print('{ 
		"error": false,
		"message": "'.$message.'",
		"reply": "'.$reply.'",
		"newParent": "'.$return_to.'"
	}');

	$m->abort();

</%init>

