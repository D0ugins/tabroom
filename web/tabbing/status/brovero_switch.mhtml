<%args>
	$tourn
	$person
	$target_id     => undef
	$parent_id     => undef
	$property_name => undef
</%args>
<%init>

	$m->clear_buffer();
	$r->content_type('application/json');

	unless ($target_id) {
		$m->print('{ "error": true, "message": "No judge ID sent"}');
		$m->abort();
	}

	my $judge = Tab::Judge->retrieve($target_id);

	unless ($judge) {
		$m->print('{ "error": true, "message": "No judge retrieve for ID '.$target_id.'"}');
		$m->abort();
	}

	unless ($property_name) {
		$m->print('{ "error": true, "message": "No timeslot ID sent"}');
		$m->abort();
	}

	my $timeslot = Tab::Timeslot->retrieve($property_name);

	unless ($timeslot) {
		$m->print('{ "error": true, "message": "No timeslot retrieve for ID '.$property_name.'"}');
		$m->abort();
	}

	my $return_to;
	my $reply;
	my $message;

	Tab::JudgeSetting->set_sql( conditional => "
		select judge_setting.*
		from judge_setting
		where judge_setting.judge = ?
		and judge_setting.tag = 'adri_saw_you'
		and judge_setting.conditional = ?
	");

	my $existing = Tab::JudgeSetting->search_conditional($judge->id, $timeslot->id)->first;

	if ($existing) {

		$existing->delete();
		$return_to = "unseen_body";
		$message = $judge->last." marked as NOT having been seen";
		$reply = "-";

	} else {

		my $now = DateTime->now();

		eval { 
			Tab::JudgeSetting->create({
				judge       => $judge->id,
				tag         => "adri_saw_you",
				conditional => $timeslot->id,
				value       => "date",
				value_date  => $now
			});
		};

		$now->set_time_zone($tourn->tz);
		$message = $judge->last." marked as spotted at ".$now->datetime();
		$return_to = "seen_body";
		$reply = $now->hour_12.":".$now->strftime('%M')." ".$now->strftime('%p');
	}

	$m->print('{
		"error"     : false,
		"message"   : "'.$message.'",
		"reply"     : "'.$reply.'",
		"newParent" : "'.$return_to.'"
	}');

	$m->abort();

</%init>
