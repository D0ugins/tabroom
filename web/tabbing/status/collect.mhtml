<%args>
	$tourn
	$perms
	$person
	$session
	$timeslot_id   => undef
	$category_id   => undef
	$entry_only    => undef
	$only_category => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas", 
		tourn => $tourn,
		perms => $perms
	);

	my @events = @{$eventref};
	my @categories = @{$catref};

	if ($category_id) { 
		$session->category($category_id);
		$session->update;
	}

	my $session_category = $session->category;

    if ($session_category && $session_category->tourn != $tourn) { 
        $session->category("");
        $session->update;
        undef $session_category;
    }   

    unless ($session_category) { 
      	$session_category = $categories[0];
        $session->category($session_category->id) if $session_category;
        $session->update;
    }   

	unless ($session_category) {

		$m->print("Your tournament has no judging groups, and cannot run like this.  ");
		$m->print("Please collect from the Setup menu to proceed");
		$m->abort;
	}

</%init>

	<script>

		function statusCounter() { 
			
			var uncollected = $("#uncollected_body").children().length;
			var collected = $("#collected_body").children().length;

			$("#uncollected_count").text(uncollected);
			$("#collected_count").text(collected);

		};

		$(document).ready(function() {
			statusCounter();
		});

	</script>

	<div class="menu">
	
		<div class="sidenote">

%			if ($entry_only) {
				<a 
					href  = "/tabbing/entry/index.mhtml"
					class = "yellow full"
				>Return to Ballot Entry</a>
				<br />
%			}


%			unless ($only_category) { 

			<span class="evenrow full marbottom centeralign">

				<form action="collect.mhtml" method="post">
				<input 
					type  = "hidden"
					name  = "timeslot"
					value = "<% $timeslot ? $timeslot->id : "" %>"
				>

				<select 
					name     = "category_id"
					onchange = 'this.form.submit()'
					class    = "chosen fixedmed notfirst"
				>

					<option value="">Choose judge category:</option>

%					foreach my $other_category (@categories) { 
						<option 
							value="<% $other_category->id %>" 
							<% ($session_category && $other_category->id == $session_category->id) 
								? "selected" 
								: ""
							%>><% $other_category->name %></option>
%					}
				</select>
				</form>
			</span>

%			}


			<h4>Timeslots:</h4>

<%perl>
				my %timeslot_uncollected = ();
				my %timeslot_collected = ();

				my @timeslots = $m->comp(
					"/funclib/category_timeslots.mas", 
			  		category => $session_category,
					events   => \@events
				);
			
				foreach my $ts (@timeslots) { 

					my @uncollected = $m->comp(
						'/funclib/timeslot_ballots.mas',
						timeslot => $ts,
						style    => "uncollected",
						category => $session_category
					);

					my @collected = $m->comp(
						'/funclib/timeslot_ballots.mas',
						timeslot => $ts,
						style    => "collected",
						category => $session_category
					);

					@{$timeslot_uncollected{$ts->id}} = @uncollected; 
					@{$timeslot_collected{$ts->id}} = @collected; 

					$timeslot = $ts if @uncollected 
						&& not defined $timeslot;

					$timeslot_id = $timeslot->id if $timeslot;

</%perl>

					<a href="collect.mhtml?timeslot_id=<% $ts->id %>" 
						class="<%
							$ts->id == $timeslot_id ? "dk" : ""
						%><% 
							(@uncollected) ? "yellow" : "green" 
						%> full martop"
					>

						<span class="half ">
							<% $ts->name %>
						</span>

						<span class="quarter  rightalign">
							<% scalar @uncollected %>
						</span>

						<span class="quarter  padleft">
							left/<% scalar @collected %>
						</span>
					</a>

%				}


		</div>

	</div>

	<div class="main">

		<h2><% $tourn->name %></h2>

		<& "tabbar.mas", 
			whoami => 'collect',
			tourn  => $tourn
		&>

%		if ($timeslot) { 
			
			<h4 class="centeralign">
				Ballots collected in timeslot <% $timeslot->name %>
			</h4>

			<p class="italic semibold redtext centeralign">
				Click a judge to move their round to the other column
			</p>

<%perl>

			my @uncollected = @{$timeslot_uncollected{$timeslot->id}};
			my @collected = @{$timeslot_collected{$timeslot->id}};

</%perl>

			<span class="pagehalf">

				<div class="full nospace semibold bigger">
					<span
						class="quarter" 
						id="uncollected_count"
					></span>

					<span class="half">
						Ballots Not Started
					</span>

					<span class="quarter rightalign smallish"
						id="uncollected_buttonarea"
					> </span>

				</div>


				<& "/funclib/tablesorter.mas", 
					table => "uncollected"
				&>

				<table id="uncollected">

					<thead>
						<tr class="yellowrow smallish">

							<th>
							</th>
							<th>
								Room
							</th>
							<th>
								Judge
							</th>
							<th>
								Event
							</th>
						</tr>
					</thead>

					<tbody id="uncollected_body">

%					foreach my $ballot (@uncollected) { 

						<tr 
							class         = "hover countme"
							id            = "<% $ballot->id %>"
							target_id     = "<% $ballot->id %>"
							reply_target  = "<% $ballot->id %>_status"
							onClick       = 'postSwitch(this, "collect_switch.mhtml", statusCounter);'
						>

							<td>
								<% $ballot->flighted > 1 ? "Fl".$ballot->flight : ""%>
							</td>

							<td class="padvertmore">
								<% $ballot->roomname %>
							</td>

							<td>
								<% $ballot->lastname.", ".$ballot->firstname %>
							</td>

							<td
								id="<% $ballot->id %>_status"
							>
								<% $ballot->eventabbr %>
							</td>

						</tr>

%					}

					</tbody>

				</table>

			</span>


			<span class="pagehalf">

				<div class="full nospace semibold bigger">

					<span 
						class="quarter" 
						id="collected_count"
					></span>

					<span class="half">
						Ballots Started 
					</span>

					<span class="quarter rightalign smallish"
						id="collected_buttonarea"
					>
					</span>
				</div>

				<& "/funclib/tablesorter.mas", 
					table => "collected"
				&>

				<table id="collected">

					<thead>
						<tr class="yellowrow smallish">

							<th>
							</th>
							<th>
								Room
							</th>
							<th>
								Judge
							</th>
							<th>
								Started
							</th>
						</tr>
					</thead>

					<tbody id="collected_body">

%					foreach my $ballot (@collected) { 

						<tr 
							class         = "hover countme"
							id            = "<% $ballot->id %>"
							target_id     = "<% $ballot->id %>"
							reply_target  = "<% $ballot->id %>_status"
							onClick       = 'postSwitch(this, "collect_switch.mhtml", statusCounter);'
						>

							<td>
								<% $ballot->flighted > 1 ? "Fl".$ballot->flight : ""%>
							</td>

							<td class="padvertmore">
								<% $ballot->roomname %>
							</td>

							<td>
								<% $ballot->lastname.", ".$ballot->firstname %>
							</td>

							<td
								id="<% $ballot->id %>_status"
							>
								<% 	Tab::nicetime(
										Tab::DBI::date_inflate($ballot->collected)->set_time_zone($tz)
									)	
								%>
							</td>

						</tr>

%					}

					</tbody>

				</table>

			</span>

%		}

	</div>

