<%args>
	$tourn
	$person
	$session
	$timeslot_id   => undef
	$category_id   => undef
	$entry_only    => undef
	$only_category => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id) if $timeslot_id;

	if ($category_id) { 
		$session->category($category_id);
		$session->update;
	}

	my $session_category = $session->category;

    if ($session_category && $session_category->tourn != $tourn) { 
        $session->category("");
        $session->update;
        undef $session_category;
    }   

    unless ($session_category) { 
      	$session_category = $tourn->categories->first;
        $session->category($session_category->id) if $session_category;
        $session->update;
    }   

	unless ($session_category) {

		$m->print("Your tournament has no judging groups, and cannot run like this.  ");
		$m->print("Please start from the Setup menu to proceed");
		$m->abort;
	}

</%init>

	<div class="menu">
	
		<div class="sidenote">

%			if ($entry_only) {
				<a href="/tabbing/entry/index.mhtml" class="yellow full">Return to Ballot Entry</a>
				<br />
%			}


%			unless ($only_category) { 
			<span class="bluenohover full centeralign" style="margin-bottom: 2px;">

				<form action="starts.mhtml" method="post">
				<input type="hidden" name="timeslot" value="<% $timeslot_id %>">

				<select name="category_id" onchange='this.form.submit()' class="chosen fixedmed notfirst">

					<option value="">Choose judge category:</option>

%					foreach my $other_category ($tourn->categories) { 
						<option 
							value="<% $other_category->id %>" 
							<% ($session_category && $other_category->id == $session_category->id) ? "selected" : "" %>>
							<% $other_category->name %>
						</option>
%					}
				</select>
				</form>
			</span>
%			}


			<h4>Timeslots:</h4>

<%perl>

				my @timeslots = $m->comp("/funclib/category_timeslots.mas", 
			  		category => $session_category);
			
				foreach my $ts (@timeslots) { 

					my @unstarted = $m->comp('/funclib/timeslot_panels.mas', 
						timeslot  => $ts,
						unstarted => "yes",
						category  => $session_category);

					$timeslot = $ts if @unstarted && not defined $timeslot;
					$timeslot_id = $timeslot->id if $timeslot;

</%perl>

					<a href="starts.mhtml?timeslot_id=<% $ts->id %>" 
						class="<% $ts->id == $timeslot_id ? "dk" : ""%><% (@unstarted) ? "yellow" : "green" %> full martop">
						<span class="half ">
							<% $ts->name %>
						</span>
						<span class="quarter  rightalign">
							<% scalar @unstarted %>
						</span>
						<span class="quarter  padleft">
							left
						</span>
					</a>

%				}
%			$timeslot = $timeslots[0] unless $timeslot;
%			$timeslot_id = $timeslot->id if $timeslot;

		</div>

	</div>

	<div class="main">

		<h2><% $tourn->name %></h2>

		<& "tabbar.mas", whoami => 'starts', tourn => $tourn &>

%		if ($timeslot) { 
			
			<h4 class="centeralign">
				Rounds started in timeslot <% $timeslot->name %>
			</h4>

<%perl>

			my @started = $m->comp('/funclib/timeslot_panels.mas', 
				timeslot => $timeslot,
				started  => "yes",
				category => $session_category
			);

			my @unstarted = $m->comp('/funclib/timeslot_panels.mas', 
				timeslot  => $timeslot,
				unstarted => "yes",
				category  => $session_category
			);

	   		@unstarted = map { $_->[0] } sort { $a->[1] <=> $b->[1] } 
						 map  { [$_, $_->roomname=~/(\d+)/] } @unstarted;

			@unstarted = map { $_->[0] } sort { $a->[1] cmp $b->[1] } 
						 map  { [$_, $_->roomname=~/(\w+)/] } @unstarted;

</%perl>


			<span class="pagehalf">

				<h5><% scalar @unstarted %> Not Started:</h5>

%				foreach my $panel (@unstarted) { 

					<a 
						class="smallish full yellow padless" 
						href="starts_switch.mhtml?panel_id=<% $panel->id %>">

						<span class="twofifths padtop padbottom smallish">
							<% $panel->room ? $panel->room->name : "" %>
						</span>

						<span class="twofifths  padleft nowrap">
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
								<div class="padless">
									<% $judge->last %>, <% $judge->first %>
								</div>
%							}
						</span>
						<span class="fifth nowrap rightalign nospace">
							<% $panel->flight > 1 ? "Flt ".$panel->flight : ""  %>
							<% $panel->eventname %>
						</span>
					</a>
%				}

			</span>

			<span class="pagehalf">

				<h5><% scalar @started %> Started:</h5>

%				foreach my $panel (@started) { 

%					my $started = $panel->started->set_time_zone($tz);

					<a class="smallish full padless green" 
						href="starts_switch.mhtml?panel_id=<% $panel->id %>">

						<span class="third  nowrap padtop padbottom">
							<% $panel->room ? $panel->room->name : "" %>
						</span>

						<span class="third  nowrap">
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
								<div class="padless">
									<% $judge->last %>, <% $judge->first %>
								</div>
%							}
						</span>

						<span class="quarter nowrap rightalign nospace">
							<% $started ? Tab::nicetime($started) : "" %>
						</span>
					</a>
%				}

			</div>

%		}

	</div>

