<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
</%args>
<%init>

	use Tab::NSDA::MemberSchool;

	my @all_schools = $tourn->schools;
	my @events = $tourn->events;

	my %schools = ();

	my %events = ();

	foreach my $school (@all_schools) { 

		my $member = 
			Tab::NSDA::MemberSchool->retrieve($school->chapter->nsda);

		if ($member) {

		$schools{$school->id}{"past_cumulative_points"} 
			= $member->school_trophy_points;
		}

		$schools{$school->id}{"nsda_trophy_points"} = $school->setting("nsda_trophy_points");

		$schools{$school->id}{"object"} = $school;

	}

	my $cumulative_set = Tab::SweepSet->search(
		tourn => $tourn->id,
		name  => "Cumulative Award"
	)->first;

	if ($cumulative_set) { 

	    my ($points_ref, $count_ref, $countstring_ref) = 
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas", 
	            sweep_set => $cumulative_set
	        );

		foreach my $school_id (keys %schools) { 

			$schools{$school_id}{"cumulative"} = ${$points_ref}{$school_id};
			$schools{$school_id}{"cumulative_count"} = ${$count_ref}{$school_id};

		}

	}

	my $yearly_set = Tab::SweepSet->search( 
		tourn => $tourn->id,
		name => "Yearly Sweeps"
	)->first;

	my $speech_set = Tab::SweepSet->search( 
		tourn => $tourn->id,
		name => "Speech"
	)->first;

	my $debate_set = Tab::SweepSet->search( 
		tourn => $tourn->id,
		name => "Debate"
	)->first;

	if ($yearly_set) { 

	    my ($yearly_ref, $yearly_count_ref, $yearly_countstring_ref) = 
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas", 
	            sweep_set => $yearly_set
	        );

		foreach my $school_id (keys %schools) { 
			$schools{$school_id}{"yearly"} = ${$yearly_ref}{$school_id};
			$schools{$school_id}{"yearly_count"} = ${$yearly_count_ref}{$school_id};
		}

	    my ($speech_ref, $speech_count_ref, $speech_countstring_ref) = 
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas", 
	            sweep_set => $speech_set
	        );

		foreach my $school_id (keys %schools) { 
			$schools{$school_id}{"speech"} = ${$speech_ref}{$school_id};
			$schools{$school_id}{"speech_count"} = ${$speech_count_ref}{$school_id};
		}

	    my ($debate_ref, $debate_count_ref, $debate_countstring_ref) = 
	        $m->comp(
	            "/tabbing/results/sweep_schools.mas", 
	            sweep_set => $debate_set
	        );

		foreach my $school_id (keys %schools) { 
			$schools{$school_id}{"debate"} = ${$debate_ref}{$school_id};
			$schools{$school_id}{"debate_count"} = ${$debate_count_ref}{$school_id};
		}

	}

</%init>

	<div class="blankfull">

		<h4>Cumulative Sweepstakes</h4>

		<& "/funclib/tablesorter.mas", table => "sweepssort" &>

		<table id="sweepssort">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						Past Trophy Points
					</th>

					<th>
						Trophy Points
					</th>

					<th>
						Entries
					</th>

					<th>
						Non-Tabroom <br /> Trophy Points
					</th>

					<th>
						Total Trophy Points
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $school_id (keys %schools) { 

%					my $school = $schools{$school_id}{"object"};

					<tr>

						<td>
							<% $school->name %>
						</td>

						<td>
							<% $schools{$school_id}{"past_cumulative_points"} %>
						</td>

						<td>
							<% $schools{$school_id}{"cumulative"} %>
						</td>

						<td>
							<% $schools{$school_id}{"nsda_trophy_points"} %>
						</td>

						<td>
							<% $schools{$school_id}{"cumulative_count"} %>
						</td>

						<td>
							<% ($schools{$school_id}{"past_cumulative_points"} +
								$schools{$school_id}{"nsda_trophy_points"} +
							    $schools{$school_id}{"cumulative"} ) %>
						</td>

					</tr>

%				}

			</tbody>

		</table>

		<h4>This Year's Sweepstakes</h4>

		<& "/funclib/tablesorter.mas", table => "yearlysort" &>

		<table id="yearlysort">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						School
					</th>

					<th>
						IE
						Entries
					</th>

					<th>
						IE
						Points
					</th>

					<th>
						Debate
						Entries
					</th>

					<th>
						Debate
						Points
					</th>

					<th>
						Total
						Entries
					</th>

					<th>
						Total
						Points
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $school_id (keys %schools) { 

%					my $school = $schools{$school_id}{"object"};

					<tr>

						<td>
							<% $school->name %>
						</td>

						<td>
							<% $schools{$school_id}{"speech_count"} %>
						</td>

						<td>
							<% $schools{$school_id}{"speech"} %>
						</td>

						<td>
							<% $schools{$school_id}{"debate_count"} %>
						</td>

						<td>
							<% $schools{$school_id}{"debate"} %>
						</td>

						<td>
							<% $schools{$school_id}{"yearly_count"} %>
						</td>

						<td>
							<% $schools{$school_id}{"yearly"} %>
						</td>

					</tr>

%				}


			</tbody>

		</table>

	</div>

	




