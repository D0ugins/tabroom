<%args>
	$person
	$tourn
	$event_id      => undef
	$round_id      => undef
	$only_category => undef
	$nsda          => undef
	$composite_id  => undef
</%args>
<%init>

	use POSIX;

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my $round = Tab::Round->retrieve($round_id) if $round_id;

	$event = $round->event if $round;

	my @events = $only_category->events if $only_category;
	@events = $tourn->events unless $only_category;
	@events = sort {$a->name cmp $b->name} @events;

	unless ($event) { 
		foreach my $candidate (@events) { 
			$event = $candidate if $candidate->rounds;
		}
	}

	$m->abort unless $event;

	my @rounds = $m->comp(
		"/funclib/event_rounds.mas", 
			event => $event, 
			done => "yes"
	);

	$round = $m->comp(
		"/funclib/event_current_round.mas", 
			event => $event, 
			done => "done"
	) unless $round;

	$round = $rounds[0] unless $round;

	my @composites;
	
	if ($round) { 

		if ($round->tiebreak_set) { 
			foreach my $tiebreak ($round->tiebreak_set->tiebreaks) { 
				push @composites, $tiebreak->child if $tiebreak->child > 0;
			}
		}

	}

	my %seen;
	@composites = grep { ! $seen{$_->id} ++ } @composites;

	my $composite_set = Tab::TiebreakSet->retrieve($composite_id) 
		if $composite_id;

</%init>

	<div class="blankfull">

		<& "/funclib/tablesorter.mas", table => "sortme", nobuttons => 1 &>

		<div class="full nospace">

			<span class="fifth nowrap">
				<h4 
					class="padno marless"> 
					<% $event->abbr %> 
					<% $nsda ? "NSDA Point Order" : "" %>
				</h4>
			</span>

			<span class="third marno centeralign">

				<form 
					action = "index.mhtml"
					method = "post"
				>

				<input 
					type  = "hidden"
					name  = "type"
					value = "Speakers"
				>

				<input 
					type  = "hidden"
					name  = "nsda"
					value = "<% $nsda %>"
				>

					<h5 class="inline marright">
						Event:
					</h5>

					<select 
						name="event_id" 
						onchange='this.form.submit()' 
						class="fixedmed chosen">

%						foreach my $oevent (sort {$a->type cmp $b->type} @events) { 
							<option 
								value="<% $oevent->id %>" 
								<% $oevent->id == $event->id ? 'selected="selected"' : "" %>
							> <% $oevent->name %> </option>
%						}
					</select>
				</form>
			</span>

			<span class="third marno centeralign">

%				if (@rounds) { 

					<h5 class="inline marright">
						As of
					</h5>

					<form action="index.mhtml" method="post">	
					<input type="hidden" name="nsda" value="<% $nsda %>">

					<input 
						type  = "hidden"
						name  = "event_id"
						value = "<% $event->id %>"
					>

					<input 
						type  = "hidden"
						name  = "composite_id"
						value = "<% $composite_id %>"
					>

					<select 
						name     = "round_id"
						onchange = 'this.form.submit();'
						class    = "fixedmed chosen"
					>

%						foreach my $oround (sort {$b->name <=> $a->name} @rounds) {

%							next unless $oround && $oround->id;
%							next unless $round && $round->id;

							<option 
								value="<% $oround->id %>" 
								<% $round && $oround->id == $round->id ? "selected" : "" %>
							> <% $oround->realname %> </option>
%						}

					</select>
					</form>
%				}

			</span>

			<span class="eighth rightalign nospace">

%				if ($round) { 
					<a 
						class="buttonwhite greentext fa fa-lg fa-file-excel-o"
						href="csv.mhtml?round_id=<% $round->id %>" >
					</a>

					<a 
						class="buttonwhite redtext fa fa-lg fa-file-pdf-o"
						href="/tabbing/report/prelims_order.mhtml?round_id=<% $round->id %>" >
					</a>
%				}

			</span>

		</div>

<%perl>

       if ($round) { 

				if (@composites 
					|| $event->setting("speaker_tbset") 
					|| $event->setting("po_tbset")
				) { 

</%perl>
					<ul id="tabnav" class="padno">

						<li class="<% $composite_id ? "" : "selected" %>">
							<a 
								href="index.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>"
							>Entries in Order</a>
						</li>

%						foreach my $composite (@composites) { 

							<li class="<% $composite_id == $composite->id ? "selected": "" %>">
								<a 
									href="index.mhtml?composite_id=<% $composite->id %>&event_id=<% $event->id %>&round_id=<% $round->id %>"
								>
									<% $composite->name %>
								</a>
							</li>

%						}

%						if ($event->setting("speaker_tbset")) { 
							<li>
								<a 
									href="speakers.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>"
								>Speakers in Order</a>
							</li>
%						}

%						if ($event->setting("po_tbset")) { 
							<li>
								<a 
									href="index.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>&composite_id=<% $event->setting("po_tbset") %>"
								>Presiding Officers</a>
							</li>
%						}

					</ul>
%           	}

%          	}

		<& "results_table.mas", 
			round        => $round,
			nsda         => $nsda,
			tiebreak_set => $composite_set,
			section_rank => $composite_set
		&>
	
	</div>


