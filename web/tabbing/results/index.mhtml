<%args>
	$person
	$tourn
	$perms
	$session
	$defaults      => undef
	$event_id      => undef
	$round_id      => undef
	$only_category => undef
	$nsda          => undef
	$composite_id  => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my $round = Tab::Round->retrieve($round_id) if $round_id;

	$event = $round->event if $round;

	my ($eventref, $catref) = $m->comp(
		"/funclib/allowed_events.mas",
		tourn => $tourn,
		perms => $perms,
		type  => "admin"
	);

	my @events = @{$eventref};
	my @categories = @{$catref};

	unless ($event) {
		foreach my $candidate (@events) {
			$event = $candidate if $defaults->{event} == $candidate;
		}
	}

	unless ($event) {
		foreach my $candidate (@events) {
			$event = $candidate if $candidate->rounds;
		}
	}

	$m->abort unless $event;
	$defaults->{event} = $event->id;
	$defaults->{category} = $event->category->id;
	$session->default($defaults);

	my %event_settings  = $event->all_settings() if $event;

	my @rounds = $m->comp(
		"/funclib/event_rounds.mas",
			event => $event,
			done => "yes"
	);

	$round = $m->comp(
		"/funclib/event_current_round.mas",
			event => $event,
			done => "done"
	) unless $round;

	$round = $rounds[0] unless $round;
	my @composites;

	if ($round) {
		if ($round->tiebreak_set) {
			foreach my $tiebreak ($round->tiebreak_set->tiebreaks) {
				push @composites, $tiebreak->child if $tiebreak->child > 0;
			}
		}
	}

	my %seen;
	@composites = grep { ! $seen{$_->id} ++ } @composites;

	my $composite_set = Tab::TiebreakSet->retrieve($composite_id)
		if $composite_id;

</%init>

	<div class="blankfull">

		<& "/funclib/tablesorter.mas",
			table     => "sortme",
			nobuttons => 1
		&>

		<div class="full nospace">

			<span class="fifth nowrap">
				<h4
					class="padno marless">
					<% $event->abbr %>
					<% $nsda ? "NSDA Point Order" : "" %>
				</h4>
			</span>

			<span class="third marno centeralign">

				<form
					action = "index.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "type"
					value = "Speakers"
				>

				<input
					type  = "hidden"
					name  = "nsda"
					value = "<% $nsda %>"
				>

					<span class="quarter nospace bluetext rightalign padbottomless">
						<h5 class="nospsace">
							Event
						</h5>
					</span>

					<span class="threequarter nospace centeralign">
						<select
							name     = "event_id"
							onchange = 'this.form.submit();'
							class    = "fixedmost">

%							foreach my $oevent (sort {$a->type cmp $b->type} @events) {
								<option
									value="<% $oevent->id %>"
									<% $oevent->id == $event->id ? 'selected="selected"' : "" %>
								> <% $oevent->name %> </option>
%							}
						</select>
					</span>
				</form>
			</span>

			<span class="third marno centeralign">

%				if (@rounds) {

					<span class="quarter nospace bluetext rightalign padbottom">
						<h5 class="nospsace">
							As of
						</h5>
					</span>

					<form action="index.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "nsda"
						value = "<% $nsda %>"
					>

					<input
						type  = "hidden"
						name  = "event_id"
						value = "<% $event->id %>"
					>

					<input
						type  = "hidden"
						name  = "composite_id"
						value = "<% $composite_id %>"
					>

					<span class="threequarter nospace centeralign">
						<select
							name     = "round_id"
							onchange = 'this.form.submit();'
							class    = "fixedmost"
						>
%							foreach my $oround (sort {$b->name <=> $a->name} @rounds) {
%								next unless $oround && $oround->id;
%								next unless $round && $round->id;

								<option
									value="<% $oround->id %>"
									<% $round && $oround->id == $round->id ? "selected" : "" %>
								> <% $oround->realname %> </option>
%							}
						</select>
					</span>

					</form>
%				}
			</span>

			<span class="eighth rightalign nospace">
%				if ($round) {
					<a
						class="buttonwhite greentext fa fa-lg fa-file-excel-o"
						href="csv.mhtml?round_id=<% $round->id %>" >
					</a>

					<a
						class="buttonwhite redtext fa fa-lg fa-file-pdf-o"
						href="/tabbing/report/prelims_order.mhtml?round_id=<% $round->id %>" >
					</a>
%				}
			</span>

		</div>


%       if ($round) {

			<span class="twothirds">
<%perl>
			if (@composites
				|| $event_settings{"speaker_tbset"}
				|| $event_settings{"po_tbset"}
				|| $event_settings{"leadership_tbset"}
			) {

				my $args = "event_id=".$event->id."&round_id=".$round->id;
</%perl>

				<ul id="tabnav" class="padno">

					<li class="<% $composite_id ? "" : "selected" %>">
						<a href="index.mhtml?<% $args %>"
						>Entries in Order</a>
					</li>

%					foreach my $composite (@composites) {
						<li class="<% $composite_id == $composite->id ? "selected": "" %>">
							<a href="index.mhtml?composite_id=<% $composite->id %>&<% $args %>">
								<% $composite->name %>
							</a>
						</li>
%					}

%					if ($event_settings{"speaker_tbset"}) {
						<li>
							<a href="speakers.mhtml?<% $args %>">
								Speakers in Order
							</a>
						</li>
%					}

%					if ($event_settings{"po_tbset"}) {
						<li class="<% $composite_id eq $event_settings{"po_tbset"} ? "selected" : "" %>">
							<a
								href="index.mhtml?<% $args %>&composite_id=<% $event_settings{"po_tbset"} %>"
							>Presiding Officers</a>
						</li>
%					}

%					if ($event_settings{"leadership_tbset"}) {
						<li class="<% $composite_id eq $event_settings{"leadership_tbset"} ? "selected" : "" %>">
							<a
								href="index.mhtml?<% $args %>&composite_id=<% $event_settings{"leadership_tbset"} %>"
							>Leadership Bowl</a>
						</li>
%					}

				</ul>
%			}

			</span>

			<span class="third rightalign bluetext semibold">
				Basis: <% $composite_set ? $composite_set->name :
					$round && $round->tiebreak_set
					? $round->tiebreak_set->name : "" %>
			</span>

%		}

%		my $style = "leadership" if $composite_id eq $event_settings{"leadership_tbset"};
%		$style = "speakers" if $composite_id eq $event_settings{"speaker_tbset"};
%		$style = "po" if $composite_id eq $event_settings{"po_tbset"};

		<& "results_table.mas",
			round        => $round,
			nsda         => $nsda,
			style        => $style,
			tiebreak_set => $composite_set,
			section_rank => $composite_set
		&>

	</div>

