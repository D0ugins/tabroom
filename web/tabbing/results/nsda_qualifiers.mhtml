<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$session
	$event_id => undef
	$format   => undef
	$all      => undef
	$full     => undef
</%args>
<%init>

	my @events; 

	my $one_event = Tab::Event->retrieve($event_id) if $event_id;

	use Tab::NSDA::NationalsInstance;
	use Tab::NSDA::NationalsEvent;
	use Tab::NSDA::NationalsEntry;
	use Tab::NSDA::NationalsStanding;
	use Tab::NSDA::NationalsUpEvent;

	if ($one_event) { 
		push @events, $one_event;
	} else { 
	
		@events = $tourn->events;
		unless ($all) { 
			my $one = shift @events;
			@events = ($one);
		}
	}

	my $limit = 14 
		if $tourn_settings->{"nsda_nats"} 
		&& $full < 1;

	$limit = 16 if $one_event && $one_event->setting("usa_wsdc");

	my $year = &Tab::school_year();
	my $school_year = $year->year + 1;

	my $district = Tab::District->retrieve($tourn_settings->{"nsda_district"});

	my $nsda_districts++ if $district;

	my $qual_string = "Qualifier";
	$qual_string = "Placement" if $tourn_settings->{"nsda_nats"};

	# Per request by Lisa V, the Weird Sorting Matrix:

	my %wsm = (
		PF  => 1,
		CX  => 2,
		DUO => 3,
		OO  => 4,
		USX => 5,
		IX  => 6,
		DI  => 7,
		HI  => 8,
		LD  => 9,
		POI => 10,
		INF => 11,
		HOU => 12,
		SEN => 13
	);

	@events = sort {$wsm{$a->abbr} <=> $wsm{$b->abbr}} @events;

	$m->print('<div class="blankfull">');

	my $name = $tourn->name;
	$name .= "-".$one_event->name if $one_event;
	$name =~ s/[\W_]//g;
	my $filename = "NSDA-".$qual_string."s-$name-".$session->id;

	$qual_string = "Top ".$limit." Place" if $limit;

	if ($format eq 'csv' || $format eq 'simplecsv') { 

		$filename = $filename.".csv"; 
		$m->clear_buffer;

		$r->content_type('application/csv');

		$r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	} elsif ($format eq "pdf") { 

		$m->comp("/funclib/printout.mas", 
			tourn    => $tourn,
			filename => $filename,
			wide     => 1,
			head     => 1
		);
	}

	my $headers_print;

	EVENT:
	foreach my $event (@events) { 

		next unless $event;

		my $hidden = "hidden"
			unless $event->setting("nsda_audited");

		undef $hidden if $person->site_admin;

		undef $hidden if $person_settings->{"nsda_admin"};

		my @rounds = sort {$b->name <=> $a->name} 
			$m->comp("/funclib/event_rounds.mas", 
				event      => $event,
				had_rounds => 1
			);

		my $final;
		my $semi;
		my $last_nonelim;
		my $first_nonelim;
		my @prelims;

		my $runoffs; 

		foreach my $round (@rounds) { 

			if ($round->type eq "runoff") { 
				$runoffs++;
				next;
			}

			if ($round->type eq "final"
				&& (not defined $final) 
			) {

				$final = $round;

			} elsif ($round->type eq "elim" 
				&& (not defined $semi)
			){

				$semi = $round;

			} else { 

				$last_nonelim = $round if (not defined $last_nonelim);
				$first_nonelim = $round;
				push @prelims, $round;
			}
		}

		my $separate_sections;

		if ($event->abbr eq "HOU" || $event->abbr eq "SEN") { 

			unless ($semi || $final) { 

				$final = $last_nonelim;
				undef @prelims;

				if ($event->abbr eq "HOU") { 

					# In the House if there are no elims, we must report each
					# prelim session as a separate qualifier

					$separate_sections++;
				}

			}

		}

		my $final_tiebreaks = $final->tiebreak_set if $final;

		if ($event->type eq "debate" 
		    && (not defined $tourn_settings->{"nsda_nats"}) 
		) { 

			$final_tiebreaks = Tab::TiebreakSet->search(
				tourn => $tourn->id,
				name  => "Debate Final"
			)->first;

		}

		my ($num_qualifiers, $num_alternates, $num_active) 
			= $m->comp(
				"/funclib/nsda_qualifier_count.mas", 
				event => $event
			);

		my $count_quals = $num_qualifiers;

		my $count_alts = $num_alternates;

		my @final_results = $m->comp(
			"/tabbing/results/order_entries.mas",
				round       => $final,
				all_entries => 1,
				runoffs     => $runoffs
			) if $final;

		my %entry_ballots = $m->comp(
			"/funclib/round_ballot_strings.mas",
			round => $final
	   ) if $final;

		my @schools = $m->comp(
			"/funclib/round_schools.mas",
			round => $first_nonelim
		) if $first_nonelim;

		my @vacate_slots = $m->comp(
			"/funclib/event_entry_settings.mas",
			event => $event,
			tag   => "nsda_vacate"
		);

		my %vacate_slot = map {$_->entry->id => $_->value } @vacate_slots;

		my %school_name = 
			map {$_->id => &Tab::short_name($_->name)} 
			@schools if @schools;

		my $final_entries_ref = pop @final_results 
			if @final_results;

		my %qualifiers = ();
		my %alternates = ();
		my %others = ();
		my %vacated = ();

		my %in_finals = ();
		my %in_elims = ();
		my %in_round = ();
		my %round_count = ();

		my %last_prelim = ();

		my $alt = 1;

		if (${$final_entries_ref}{"by_place"}) { 

			foreach my $key (sort {$a <=> $b} keys %{${$final_entries_ref}{"by_place"}}) { 
			
				my $tie++ if scalar @{${${$final_entries_ref}{"by_place"}}{$key}} > 1; 
			
				foreach my $entry_id (@{${${$final_entries_ref}{"by_place"}}{$key}}) { 

					next if $in_elims{$entry_id};

					$in_finals{$entry_id} = $key;
					$in_elims{$entry_id} = $key;

					next if $qualifiers{$entry_id} && $qualifiers{$entry_id}{"place"};
					next if $alternates{$entry_id} && $alternates{$entry_id}{"place"};
					next if $others{$entry_id} && $others{$entry_id}{"place"};

					if ($vacate_slot{$entry_id}) { 

						$vacated{$entry_id}{"tie"}++ if $tie;
						$vacated{$entry_id}{"place"} = $key;
						$vacated{$entry_id}{"last_round"} = $final->name;

					} elsif ($count_quals > 0) { 

						$qualifiers{$entry_id}{"tie"}++ if $tie;
						$qualifiers{$entry_id}{"place"} = $key;

						$count_quals--;

					} elsif ($count_alts > 0) { 

						$alternates{$entry_id}{"tie"}++ if $tie;
						$alternates{$entry_id}{"place"} = $alt++;
						$count_alts--;

					} else {

						$others{$entry_id}{"tie"}++ if $tie;
						$others{$entry_id}{"place"} = $key;

					}
				}
			}

		}

		if ($final && $semi)  { 

			my @semi_results = $m->comp(
				"/tabbing/results/order_entries.mas",
				round        => $semi,
				tiebreak_set => $final_tiebreaks,
				runoffs      => $runoffs,
				all_entries  => 1
			);

			my $semi_entries_ref = pop @semi_results 
				if @semi_results;

			if (${$semi_entries_ref}{"by_place"}) { 

				foreach my $key (sort {$a <=> $b} keys %{${$semi_entries_ref}{"by_place"}}) { 

					my $tie++ if scalar @{${${$semi_entries_ref}{"by_place"}}{$key}} > 1; 

					my $delayed_alt;
				
					foreach my $entry_id (@{${${$semi_entries_ref}{"by_place"}}{$key}}) { 

						next if $in_elims{$entry_id};
						$in_elims{$entry_id} = $key;

						next if $qualifiers{$entry_id} && $qualifiers{$entry_id}{"place"};
						next if $alternates{$entry_id} && $alternates{$entry_id}{"place"};

						next if $others{$entry_id} && $others{$entry_id}{"place"};
						next if $vacated{$entry_id} && $others{$entry_id}{"place"};

						if ($vacate_slot{$entry_id}) { 

							$vacated{$entry_id}{"tie"}++ if $tie;
							$vacated{$entry_id}{"place"} = $key;

						} elsif ($count_quals > 0) { 

							$qualifiers{$entry_id}{"tie"}++ if $tie;
							$qualifiers{$entry_id}{"place"} = $key;
							$count_quals--;

						} elsif ($count_alts > 0) { 

							$alternates{$entry_id}{"tie"}++ if $tie;
							$alternates{$entry_id}{"place"} = $alt;

							$delayed_alt++;
							$count_alts--;

						} else { 

							$others{$entry_id}{"tie"}++ if $tie;
							$others{$entry_id}{"place"} = $key;

						}
					}

					$alt += $delayed_alt;
				}
			}
		}

		unless ($event->abbr eq "HOU" || $event->abbr eq "SEN") { 

			if ($final && @prelims) { 

				foreach my $prelim (@prelims) { 

					my @previous_results = $m->comp(
						"/tabbing/results/order_entries.mas",
							round        => $prelim,
							runoffs      => $runoffs,
							tiebreak_set => $final_tiebreaks,
					);

					my $previous_entries_ref = 
						pop @previous_results 
						if @previous_results;

					if (${$previous_entries_ref}{"by_place"}) { 

						foreach my $key (
							sort {$a <=> $b} 
							(keys %{${$previous_entries_ref}{"by_place"}})
						) { 
						
							my $tie++ 
								if scalar @{${${$previous_entries_ref}{"by_place"}}{$key}} > 1; 

							my $delayed_alt;
						
							foreach my $entry_id (@{${${$previous_entries_ref}{"by_place"}}{$key}}) { 

								unless ($in_finals{$entry_id}) {

									unless ($in_elims{$entry_id}) { 

										unless ($in_round{$entry_id}) { 

											$in_round{$entry_id} = $prelim->name;
											$round_count{$prelim->name}++;
										}
									}
								}

								next if $qualifiers{$entry_id} && $qualifiers{$entry_id}{"place"};
								next if $alternates{$entry_id} && $alternates{$entry_id}{"place"};
								next if $others{$entry_id} && $others{$entry_id}{"place"};
								next if $vacated{$entry_id} && $others{$entry_id}{"place"};

								$last_prelim{$entry_id} = $prelim->name;

								if ($vacate_slot{$entry_id}) { 

									$vacated{$entry_id}{"tie"}++ if $tie;
									$vacated{$entry_id}{"place"} = $key;

								} elsif ($count_quals > 0) { 

									$qualifiers{$entry_id}{"tie"}++ if $tie;
									$qualifiers{$entry_id}{"place"} = $key;
									$count_quals--;

								} elsif ($count_alts > 0) { 

									$alternates{$entry_id}{"tie"}++ if $tie;
									$alternates{$entry_id}{"place"} = $alt;

									$delayed_alt++;
									$count_alts--;

								} else { 
									$others{$entry_id}{"tie"}++ if $tie;
									$others{$entry_id}{"place"} = $key;
								}
							}

							$alt += $delayed_alt;
						}
					}
				}
			}
		}

		if ($format eq "csv" || $format eq "simplecsv") {

			if ($tourn_settings->{"nsda_district"}) { 

				$m->print("\n");
				$m->print('"'.$district->name.'"');
				$m->print("\n");
				$m->print('"'.$event->name.'"');
				$m->print("\n");

			} else { 

				$m->print(",,,,");
				$m->print('"'.$event->name.'"');
				$m->print(",");
				$m->print('"'.$qual_string.'"');
				$m->print("\n");
			}

			my $simplecsv++ if $format eq "simplecsv";

			if ($simplecsv) { 

				Tab::Entry->set_sql(event_spoke => "
					select distinct entry.id
					from entry, ballot, score
					where entry.event = ? 
					and entry.id = ballot.entry
					and ballot.id = score.ballot
				");

				my @total_entries = Tab::Entry->search_event_spoke($event->id);
			
				$m->print('"Entries: '.scalar @total_entries.'"');
				$m->print("\n");

			}

			$m->flush_buffer();

			if ($separate_sections) { 

				foreach my $section ($final->panels) { 

					$m->comp("results_csv.mas", 
						round          => $final,
						nsda_districts => $nsda_districts,
						nsda_nats      => $tourn_settings->{"nsda_nats"},
						num_qualifiers => 1,
						vacated        => \%vacated,
						vacate_option  => $nsda_districts,
						filename       => $filename,
						section        => $section,
						nofinish       => "yes",
						simple         => $simplecsv,
						contact        => $ARGS{"contact"}
					);

				}

			} else { 

				$m->comp("results_csv.mas", 
					round          => $final,
					filename       => $filename,
					nsda_districts => $nsda_districts,
					nsda_nats      => $tourn_settings->{"nsda_nats"},
					qualifiers     => \%qualifiers,
					vacated        => \%vacated,
					alternates     => \%alternates,
					others         => \%others,
					nofinish       => "Yes",
					contact        => $ARGS{"contact"},
					limit          => $limit,
					simple         => $simplecsv
				);

				my $placement = scalar( keys %in_finals) + 1;

				my $limit_done = $limit - $placement;
				$limit_done = 1 unless $limit;

				$m->comp("results_csv.mas", 
					round           => $semi,
					filename        => $filename,
					tiebreak_set    => $final_tiebreaks,
					nsda_districts  => $nsda_districts,
					nsda_nats       => $tourn_settings->{"nsda_nats"},
					qualifiers      => \%qualifiers,
					vacated         => \%vacated,
					alternates      => \%alternates,
					others          => \%others,
					exclude         => \%in_finals,
					noheader        => "Yes",
					nofinish        => "Yes",
					limit           => $limit,
					contact         => $ARGS{"contact"},
					start_placement => $placement,
					simple          => $simplecsv
				) if $limit_done > 0;

				$placement = scalar( keys %in_elims) + 1;

				$limit_done = $limit - $placement;
				$limit_done = 1 unless $limit;

				foreach my $prelim (@prelims) { 

					$m->comp("results_csv.mas", 
						round           => $prelim,
						filename        => $filename,
						tiebreak_set    => $final_tiebreaks,
						nsda_districts  => $nsda_districts,
						nsda_nats       => $tourn_settings->{"nsda_nats"},
						qualifiers      => \%qualifiers,
						vacated         => \%vacated,
						alternates      => \%alternates,
						others          => \%others,
						exclude         => \%in_elims,
						none_above      => \%last_prelim,
						start_placement => $placement,
						noheader        => "Yes",
						nofinish        => "Yes",
						limit           => $limit,
						contact         => $ARGS{"contact"},
						simple          => $simplecsv
					) if $limit_done > 0;

				}

			}

			$m->print("\n\n");
				
		} elsif ($format eq "pdf") { 

			my $filepath = $Tab::file_root."tmp/".$filename;

			open (TEXOUT, ">>$filepath.tex");

			my $logo_file = $tourn_settings->{"logo"};

			if ($logo_file) {

				unless (-e "$Tab::file_root/tmp/".$logo_file) { 
					system("cd $Tab::file_root/tmp; 
					$Tab::latex_path_prefix/wget ".$Tab::s3_url."/".$tourn->id."/".$logo_file);
				}
			}

			if ($logo_file && -e "$Tab::file_root/tmp/".$logo_file) { 

				print TEXOUT "\\begin{minipage}[c]{3.65in}\n";
				print TEXOUT "\\includegraphics[height=1.2in,width=1.2in,keepaspectratio]{".$logo_file."}\n";
				print TEXOUT "\\end{minipage}\n";

			} else { 

				print TEXOUT "\\vspace{-4mm}\n";
				print TEXOUT "\\begin{minipage}[c]{3.65in}\n";
				print TEXOUT "{\\bf \\LARGE \\color{black!64} ".&Tab::texify($tourn->name)." }\n";
				print TEXOUT "\\end{minipage}\n";

			}

			print TEXOUT "\\begin{minipage}[c]{4.0in}\n";
			print TEXOUT "\\strut \\hfill {\\LARGE\\bf ".uc(&Tab::texify($event->name))." } \n";
			print TEXOUT "\\medskip\n";
			print TEXOUT "\\newline\n";

			print TEXOUT "\\noindent\n";
			print TEXOUT "\\strut \\hfill {\\Large \\color{black!64} ".uc($qual_string)."S }\n";
			print TEXOUT "\\end{minipage}\n";
			print TEXOUT "\\vspace{5mm}\n";
			print TEXOUT "\\newline\n";
		
			close TEXOUT;

			if ($separate_sections) { 

				foreach my $section ($final->panels) { 

					$m->comp("/tabbing/report/results_table_print.mas", 
						round          => $final,
						nsda_districts => $nsda_districts,
						nsda_nats      => $tourn_settings->{"nsda_nats"},
						num_qualifiers => 1,
						vacated        => \%vacated,
						vacate_option  => $nsda_districts,
						filename       => $filename,
						ballots        => $ARGS{"ballots"},
						section        => $section
					);

				}

			} else { 

				$m->comp("/tabbing/report/results_table_print.mas", 
					round          => $final,
					filename       => $filename,
					nsda_districts => $nsda_districts,
					nsda_nats      => $tourn_settings->{"nsda_nats"},
					qualifiers     => \%qualifiers,
					vacated        => \%vacated,
					alternates     => \%alternates,
					limit          => $limit,
					ballots        => $ARGS{"ballots"},
					others         => \%others
				);

				my $placement = scalar( keys %in_finals) + 1;
				my $limit_done = $limit - $placement;
				$limit_done = 1 unless $limit;

				$m->comp("/tabbing/report/results_table_print.mas", 
					round           => $semi,
					filename        => $filename,
					tiebreak_set    => $final_tiebreaks,
					nsda_districts  => $nsda_districts,
					nsda_nats       => $tourn_settings->{"nsda_nats"},
					qualifiers      => \%qualifiers,
					vacated         => \%vacated,
					alternates      => \%alternates,
					others          => \%others,
					exclude         => \%in_finals,
					ballots         => $ARGS{"ballots"},
					limit           => $limit,
					start_placement => $placement,
					noheader        => $tourn_settings->{"nsda_nats"},
					nofinish        => "Yes"
				) if ($limit_done > 0);

				my $noheaders;
				$noheaders++ unless (scalar (keys %in_elims)) == scalar (keys (%in_finals));

				$placement = scalar( keys %in_elims) + 1;
				$limit_done = $limit - $placement;
				$limit_done = 1 unless $limit;

				foreach my $prelim (@prelims) { 

					next if $limit_done < 1;

					$m->comp("/tabbing/report/results_table_print.mas", 
						round           => $prelim,
						filename        => $filename,
						tiebreak_set    => $final_tiebreaks,
						nsda_districts  => $nsda_districts,
						nsda_nats       => $tourn_settings->{"nsda_nats"},
						qualifiers      => \%qualifiers,
						vacated         => \%vacated,
						limit           => $limit,
						ballots         => $ARGS{"ballots"},
						alternates      => \%alternates,
						others          => \%others,
						exclude         => \%in_elims,
						none_above      => \%last_prelim,
						start_placement => $placement,
						noheader        => $noheaders++,
						nofinish        => 1
					);

				}
				
			}

			open (TEXOUT, ">>$filepath.tex");
			print TEXOUT "\\newpage\n";
			close TEXOUT;

		} elsif ($format eq "post") { 

			if ($separate_sections) { 

				# The House is treated differently in all kinds of
				# horrifying ways. 

				foreach my $section ($final->panels) { 

					my $code = "H".$section->letter;

					my $result_set  = Tab::ResultSet->search(
						label => "District Qualifiers: $code"
						tourn => $tourn,
						event => $event
					)->first;

					unless ($result_set) { 

						$result_set  = Tab::ResultSet->create({
							label => "District Qualifiers: $code"
							tourn => $tourn,
							event => $event
						});
					}

					my (@results) = $m->comp(
						"order_entries.mas", 
							long_names   => 1,
							round        => $final,
							tiebreak_set => $final_tiebreaks,
							runoffs      => $runoffs,
							section      => $section
					);  

					my $entries_ref = pop @results if @results;

					my @tiebreak_keys =
						sort {$a <=> $b}
						keys %{$entries_ref->{"tier_description"}};

					Tab::ResultSet->set_sql(
						delete_results => "
							delete from result
								where result_set_id = ?
					");

					Tab::ResultSet->sql_delete_standings->execute(
						$result_set->id
					);

					my $qualled;

					my %integer_tbs = $m->comp("/funclib/tiebreaks.mas");

					if (${$entries_ref}{"by_place"}) {

						foreach my $key (sort {$a <=> $b} keys %{${$entries_ref}{"by_place"}}) { 

							foreach my $entry_id (@{${${$entries_ref}{"by_place"}}{$key}}) {

								my $entry = Tab::Entry->retrieve($entry_id);

								my $result = Tab::Result->create({
									rank       => $key,
									result_set => $result_set->id,
									entry      => $entry_id,
									school     => $entry->school->id
								});

								if ($vacated{$entry_id}{"place"}) { 
									Tab::ResultValue->create({
										result      => $result->id,
										tag         => "vacated",
										no_sort     => 1,
										priority    => 0,
										description => "Entry Slot Vacated or Dropped"
										value       => 1
									});
								}

								foreach my $student ($entry->students) { 

									Tab::ResultValue->create({
										result      => $result->id,
										tag         => $student->id,
										no_sort     => 1,
										priority    => 0,
										description => $student->first." ".$student->last." merit number",
										value       => $student->ualt_id
									});

								}	

								foreach my $key (@tiebreak_keys) { 

									my $value = ${$entries_ref}{"tiebreak"}{$key}{$entry_id};

									my $sort_desc;
									$sort_desc = 1 if $ARGS{"threshold_direction"};

									$value =~ s/\.(?:|.*[^0]\K)0*\z//;

									$value = sprintf("%.2f", $value) 
										unless $integer_tbs{${$entries_ref}{"tier_description"}{$key}};

									Tab::ResultValue->create({ 
										tag         => ${$entries_ref}{"tier_description"}{$key},
										description => ${$entries_ref}{"tier_long_description"}{$key},
										result      => $value,
										priority    => $key,
										sort_desc   => $sort_desc,
										result      => $result->id
									})
								}
							}
						}
					} #End of entries by place
				}

			} else { 

				my $result_set  = Tab::ResultSet->search(
					label => "District Qualifiers"
					tourn => $tourn,
					event => $event
				)->first;

				unless ($result_set) { 

					$result_set  = Tab::ResultSet->create({
						label => "District Qualifiers"
						tourn => $tourn,
						event => $event
					});
				}

					my (@results) = $m->comp(
						"order_entries.mas", 
							long_names   => 1,
							round        => $final,
							tiebreak_set => $final_tiebreaks,
							runoffs      => $runoffs,
							section      => $section
					);  

					my $entries_ref = pop @results if @results;

					my @tiebreak_keys =
						sort {$a <=> $b}
						keys %{$entries_ref->{"tier_description"}};

					Tab::ResultSet->set_sql(
						delete_results => "
							delete from result
								where result_set_id = ?
					");

					Tab::ResultSet->sql_delete_standings->execute(
						$result_set->id
					);

					my $qualled;

					my %integer_tbs = $m->comp("/funclib/tiebreaks.mas");

					if (${$entries_ref}{"by_place"}) {

						foreach my $key (sort {$a <=> $b} keys %{${$entries_ref}{"by_place"}}) { 

							foreach my $entry_id (@{${${$entries_ref}{"by_place"}}{$key}}) {

								my $entry = Tab::Entry->retrieve($entry_id);

								my $result = Tab::Result->create({
									rank       => $key,
									result_set => $result_set->id,
									entry      => $entry_id,
									school     => $entry->school->id
								});

								if ($vacated{$entry_id}{"place"}) { 
									Tab::ResultValue->create({
										result      => $result->id,
										tag         => "vacated",
										no_sort     => 1,
										priority    => 0,
										description => "Entry Slot Vacated or Dropped"
										value       => 1
									});
								}

								foreach my $student ($entry->students) { 

									Tab::ResultValue->create({
										result      => $result->id,
										tag         => $student->id,
										no_sort     => 1,
										priority    => 0,
										description => $student->first." ".$student->last." merit number",
										value       => $student->ualt_id
									});

								}	

								foreach my $key (@tiebreak_keys) { 

									my $value = ${$entries_ref}{"tiebreak"}{$key}{$entry_id};

									my $sort_desc;
									$sort_desc = 1 if $ARGS{"threshold_direction"};

									$value =~ s/\.(?:|.*[^0]\K)0*\z//;

									$value = sprintf("%.2f", $value) 
										unless $integer_tbs{${$entries_ref}{"tier_description"}{$key}};

									Tab::ResultValue->create({ 
										tag         => ${$entries_ref}{"tier_description"}{$key},
										description => ${$entries_ref}{"tier_long_description"}{$key},
										result      => $value,
										priority    => $key,
										sort_desc   => $sort_desc,
										result      => $result->id
									})

								}

							}

						}

					} #End of entries by place

				}


					if ($up_event) { 

						my $qual_count = scalar(keys %qualifiers);
						$up_event->nAdvancing($qual_count);
						$up_event->update();

					} else { 

						# THIS SO OFFENDS ME.  WHY NOT A UNIQUE ID LIKE EVERY DB ON
						# EARTH WHY WHY WHY WHYYYYYY....

						my $debate = "N";
						my $congress = "N";
						my $seli = 0;
						
						$debate = "Y" if $event->type eq "debate";
						$congress = "N" if $event->type eq "congress";

						my %used;
						my $entry_count = 0;

						foreach my $key (
							keys %qualifiers, 
							keys %vacated, 
							keys %alternates, 
							keys %others
						) { 
							$entry_count++ unless $used{$key}++;
						}
						
						my $qual_count = scalar(keys %qualifiers);

						$up_event = Tab::NSDA::NationalsUpEvent->create({
							web_event_id => $event->id,
							instance_id  => $instance->id,
							event_id     => $nationals_event->event_id,
							abbr         => $event_abbr,
							name         => $event->name,
							isdebate     => $debate,
							iscongress   => $congress,
							nRounds      => (scalar @rounds),
							nEntries     => $entry_count,
							nAdvancing   => $qual_count
						});

					} 

					my $starting_place = scalar(keys(%in_elims));

					foreach my $prelim (sort {$b->name <=> $a->name} @prelims) { 

						my $debate_all++ 
							if $event->type eq "debate";

						my $section_rank++ 
							if $final_tiebreaks->setting("equal_elims");

						my (@results) = $m->comp(
							"order_entries.mas", 
								long_names   => 1,
								round        => $prelim,
								tiebreak_set => $final_tiebreaks,
								all_entries  => $debate_all,
								runoffs      => $runoffs,
								section_rank => $section_rank
						);  

						my $entries_ref = pop @results if @results;

						if (${$entries_ref}{"by_place"}) {

							foreach my $key (sort {$a <=> $b} keys %{${$entries_ref}{"by_place"}}) { 

								my $key_count;

								foreach my $entry_id (@{${${$entries_ref}{"by_place"}}{$key}}) {
									next if $in_elims{$entry_id};
									$in_elims{$entry_id} = $key + $starting_place;
								}

								$starting_place += $key_count;

							}

						}

					}

					my $counter;

					Tab::NSDA::NationalsStanding->set_sql( 
						delete_standings => "
							delete from final_standings 
								where district_id = ?
								and instance_event_id = ? 
						");

					Tab::NSDA::NationalsStanding->sql_delete_standings->execute(
						$district->id,
						$up_event->event_id
					);

					foreach my $entry_id (
						sort {$in_elims{$a} <=> $in_elims{$b}} (keys %in_elims)
					) { 

						my $entry = Tab::Entry->retrieve($entry_id);
						my @students = $entry->students;

						next unless @students;

						my $student = shift @students;
						my $partner = shift @students if @students;

						my $student_ualt = $student->ualt_id;
						my $partner_ualt = $partner->ualt_id if $partner;

						my $place = $in_elims{$entry_id};

						unless ($student_ualt) { 

							$m->print('<div class="full marno row redtext strong centeralign padtop padbottom">
								Entry '.$entry->code." student $student is NOT REGISTERED AS AN NSDA MEMBER.  
								Position: $place  not recorded
							</div>");

						} else { 

							my $chapter_nsda = $student->chapter->nsda;

							my $seli = 0;
							$seli++ if $vacated{$entry_id}{"place"};

							Tab::NSDA::NationalsStanding->create({
								district_id       => $district->id,
								src_instance_id   => $instance->id,
								abbr              => $event_abbr,
								place             => $place,
								seli              => $seli,
								school_id         => $chapter_nsda,
								ualt_id           => $student_ualt,
								partner_ualt_id   => $partner_ualt,
								instance_event_id => $up_event->event_id,
								skip              => 0
							});
						}

						$counter++;

						if ($qualifiers{$entry_id}) { 

							next unless $qualifiers{$entry_id}{"place"};

							my $string = "<span class='threequarters padmore'>";
							$string .= "Entry ".$entry->code." from ".$entry->school->name." qualified: ";

							foreach my $schmoe ($student, $partner) { 
								next unless $schmoe;
								$string .= $schmoe->first." ".$schmoe->last." Merit ID: ".$schmoe->ualt_id." ";
							}

							my %creation = (
								tourn_id    => $school_year,
								event_id    => $nationals_event->event_id,
								district_id => $tourn_settings->{"nsda_district"},
								school_id   => $entry->school->chapter->nsda,
								student_id  => $student_ualt,
								partner_id  => $partner_ualt
							);

							$creation{"partner_id"} = $partner->ualt_id if $partner;

							my $eligible;
							my $err;

							foreach my $schmoe ($student, $partner) { 

								next unless $schmoe;

								my @already;

								push @already, Tab::NSDA::NationalsEntry->search(
									tourn_id   => $school_year,
									event_id   => $nationals_event->event_id,
									student_id => $schmoe->ualt_id
								);

								push @already, Tab::NSDA::NationalsEntry->search(
									tourn_id   => $school_year,
									event_id   => $nationals_event->event_id,
									partner_id => $schmoe->ualt_id
								);

								if (@already) { 
									foreach my $yo (@already) { 
										$err .= "<br />" if $err;
										$err .= $schmoe->first." ".$schmoe->last;
										$err .= " is already registered in ".$event->abbr;
										$err .= " as entry ID ".$yo->eligible_id;
									}
								}

							} 
							
							unless ($err) { 
								$err = eval { 
									$eligible = Tab::NSDA::NationalsEntry->create(\%creation);
								};

							}

							$string .= "</span>";

							if ($eligible && ( (not defined $err) || $err eq int($err))  ) { 

								$string .= "<span class='quarter rightalign greentext strong'>Succeeded!</span>";

							} else { 

								$string .= "<p><span class='third rightalign redtext strong'>Alert!</span>";
								$string .= "</span><span class='redtext twothirds'>".$err."</span>";

							}

							$m->print("<div class='full marno row'>".$string."</div>");
		
						}
					

					}

					$m->print('<p class="bluetext">Uploaded '.$counter.' entry standings</p>');
				}

			} else { 

				$m->print("<h5 class='redtext'>No nationals event found corresponding to ".$event->abbr."</h5>");
			}

			$m->flush_buffer();
		
		} else {


</%init>

			<script>
				function confirmAudit(event_id) { 
					$("."+event_id).removeClass('hidden');
					$("#"+event_id).addClass('hidden');
					$('table').trigger('applyWidgets');
				}
			</script>


			<div
				class="full nospace borderbottom"
			>

				<span class="third nospace">
					<h4><% $qual_string %>s</h4>
				</span>

				<span class="third">

					<form 
						action = "nsda_qualifiers.mhtml"
						method = "post"
					>

					<input
						type  = "hidden"
						name  = "full"
						value = "<% $full %>"
					>


					<select
						name     = "event_id"
						class    = "fixedbig"
						onChange = "this.form.submit();"
					>
%						foreach my $oevent ($tourn->events) { 
							<option 
								value="<% $oevent->id %>"
								<% $oevent == $event ? 'selected="true"' : "" %>
							><% $oevent->name %></option>
%						}

					</select>

					</form>
				</span>

				<span class="third rightalign <% $hidden %> <% $event->id %>">

					<% $event->abbr %>:

%					if ($event->abbr eq "HOU" || $event->abbr eq "SEN") { 

						<a 
							title = "Congress Speech Scores"
							class = "buttonwhite fa fa-lg fa-sort-numeric-asc orangetext hover"
							href  = "/tabbing/report/congress_scores.mhtml?event_id=<% $event->id %>"
							target = "_blank"
						></a>
%					}

					<a 
						title = "PDF Printout Report"
						class = "buttonwhite fa fa-lg fa-file-pdf-o redtext hover"
						href  = "nsda_qualifiers.mhtml?event_id=<% $event->id %>&format=pdf&full=<% $full %>"
						target = "_blank"

					></a>

					<a 
						title = "Full Excel Report"
						class = "buttonwhite fa fa-lg fa-file-excel-o greentext hover"
						href  = "nsda_qualifiers.mhtml?event_id=<% $event->id %>&format=csv&full=<% $full %>"
					></a>
<%perl>
					if (
						$tourn_settings->{'nsda_district'} 
						&& (
							$person_settings->{"nsda_admin"} 
							|| $person->site_admin
						)
						&& (1 == 0) #Not ready for new system yet
					) { 
</%perl>

						<a 
							title = "Post Results to Nationals Dashboard"
							class = "buttonwhite fa fa-lg fa-arrow-up orangetext hover"
							href  = "nsda_qualifiers.mhtml?format=registration&event_id=<% $event->id %>&full=<% $full %>"
						></a>

%					}

%					unless ($tourn_settings->{"nsda_nats"}) { 

						ALL:

						<a 
							title = "PDF Printout Report"
							class = "buttonwhite fa fa-lg fa-file-pdf-o redtext hover"
							href  = "nsda_qualifiers.mhtml?format=pdf&all=1"
							target = "_blank"

						></a>

						<a 
							title = "Full Excel Report"
							class = "buttonwhite fa fa-lg fa-file-excel-o greentext hover"
							href  = "nsda_qualifiers.mhtml?format=csv&all=1"
						></a>

						<a 
							title = "Excel Download for NSDA"
							class = "buttonwhite fa fa-lg fa-file-excel-o purpletext hover"
							href  = "nsda_qualifiers.mhtml?format=simplecsv&all=1"
						></a>

%						if ( 
%						($person_settings->{"nsda_admin"} || $person->site_admin)
%						&& (1 == 0) #Not ready for new system yet
%						) { 

							<a 
								title = "Post Results to Nationals Dashboard"
								class = "buttonwhite fa fa-lg fa-arrow-up orangetext hover"
								href  = "nsda_qualifiers.mhtml?format=registration&all=1"
							></a>

%						}

%					} elsif ($person_settings->{"nsda_admin"} || $person->site_admin) { 

						<a 
							title = "Full Report Excel Download"
							class = "buttonwhite fa fa-lg fa-file-excel-o purpletext hover"
							href  = "nsda_qualifiers.mhtml?format=csv&event_id=<% $event->id %>&contact=1"
						></a>

%						if ($full) { 

							<a 
								title = "View Only Top 14"
								class = "buttonwhite fa fa-lg fa-asterisk orangetext hover invert"
								href  = "nsda_qualifiers.mhtml?event_id=<% $event->id %>"
							></a>


%						} else { 

							<a 
								title = "View All Qualifiers"
								class = "buttonwhite fa fa-lg fa-asterisk orangetext hover"
								href  = "nsda_qualifiers.mhtml?event_id=<% $event->id %>&full=1"
							></a>

%						} 

%					}

				</span>

			</div>

<%perl>

			my $confirmer;

			unless ($person->site_admin 
				|| $person_settings->{"nsda_admin"} 
				|| $event->setting("nsda_audited")
				|| $tourn_settings->{"nsda_nats"}
			) { 

</%perl>
				<div 
					id    = "<% $event->id %>"
					class = "cover centeralign padtopmore"
				>

					<div class="padmuchmore full padtopmore padbottommore marbottommore">
					</div>


					<h3 class="centeralign nospace">
						Confirm Audit &amp; Doublecheck
					</h3>

					<p class="strong bluetext padtopmore martopmore">
						To see qualifiers for <% $event->name %>, please first confirm the following:
					</p>

					<p>
						1.  All ballot entry has been double checked, and ballots
						have been made available to attending coaches for
						confirmation.
					</p>

					<p> 
						2.  You pledge to check the system's results and calculations
						before announcing or reporting qualifiers.
					</p>

					<div class="padmuchmore centeralign martopmore">

						<a 
							id             = "event_<% $event->id %>"
							class          = "buttonwhite redtext invert padmuchmore"
							target_id      = "<% $event->id %>"
							setting_name   = "nsda_audited"
							property_value = "1"
							value          = "1"
							onClick        = "postSwitch(this, 'event_switch.mhtml'); 
								confirmAudit(<% $event->id %>);"
						>
							Mark As Confirmed by <% $person->first." ".$person->last %>
						</a>

					</div>

				</div>

<%perl>

				$hidden = "hidden";

			} else { 

				$confirmer = Tab::Person->retrieve($event->setting("nsda_audited"))
					if $event->setting("nsda_audited");

				$hidden = "hidden" unless $confirmer;

			}

			undef $hidden if $person->site_admin;
			undef $hidden if $person_settings->{"nsda_admin"};
			undef $hidden if $tourn_settings->{'nsda_nats'};


</%perl>
			<div class = "mask <% $hidden %> <% $event->id %>" >

%			unless ($tourn_settings->{'nsda_nats'}) { 

				<div class="explain nospace martop centeralign">

					<span class="smallish explain nospace replybucket confirmed"> 
%						if ($confirmer) { 
							Audit confirmed by 
							<% $confirmer ? $confirmer->first." ".$confirmer->last : "" %>
%						} else { 
							Audit not yet confirmed
%						} 
					</span>


				</div>
<%perl>
			} 

			if ($separate_sections && $final)  { 

				foreach my $section ($final->panels) { 

					$m->comp("results_table.mas", 
						round          => $final,
						nsda_districts => $nsda_districts,
						nsda_nats      => $tourn_settings->{"nsda_nats"},
						num_qualifiers => 1,
						vacated        => \%vacated,
						vacate_option  => $nsda_districts,
						section        => $section,
						limit          => $limit
					);

				}

			} else { 
</%perl>


				<span class="half">
					<h4 class="padno padleft marno">Finalists:</h4>
				</span>

%				if ($final) { 
					<span class="half rightalign">
						<a 
							class="buttonblue whitetext smallish padless"
							href="/panel/round/runoff.mhtml?round_id=<% $final->id %>&nsda=1&tiebreak_set_id=<% $final_tiebreaks->id %>"
						>Schedule Runoffs</a>

					</span>
%				}

				<& 
					"results_table.mas", 
						round          => $final,
						nsda_districts => $nsda_districts,
						nsda_nats      => $tourn_settings->{"nsda_nats"},
						qualifiers     => \%qualifiers,
						vacated        => \%vacated,
						alternates     => \%alternates,
						others         => \%others,
						limit          => $limit,
						vacate_option  => $nsda_districts
				&>
<%perl>

			}

			my $placement = scalar( keys %in_finals) + 1;

			my $limit_done = $limit - $placement;
			$limit_done = 1 unless $limit;

			my $finals_left = ($num_alternates + $num_qualifiers) - (scalar (keys %in_finals));

			my $semis_left = ($num_alternates + $num_qualifiers) - (scalar (keys %in_elims));

			my $both = 1 if $semi && $last_nonelim;

			if ($final && ($semi || @prelims)) { 

				my $runoff = $semi if $semi;
				$runoff = $prelims[0] unless $runoff;
					
				undef $both unless $semis_left > 0;
			
</%perl>
%					if ($limit_done > 0) { 

						<span class="half">
							<h4 class="padno padleft marno">Others</h4>
						</span>

%						if ($runoff) { 
							<span class="half rightalign">
								<a 
									class="buttonblue whitetext smallish padless"
									href="/panel/round/runoff.mhtml?round_id=<% $runoff->id %>&nsda=1&tiebreak_set_id=<% $final_tiebreaks->id %>"
								>Schedule Runoffs</a>

							</span>
%						}

						<& 
							"results_table.mas", 
							round           => $semi,
							tiebreak_set    => $final_tiebreaks,
							nsda_districts  => $nsda_districts,
							nsda_nats       => $tourn_settings->{"nsda_nats"},
							qualifiers      => \%qualifiers,
							vacated         => \%vacated,
							alternates      => \%alternates,
							limit           => $limit,
							others          => \%others,
							exclude         => \%in_finals,
							start_placement => $placement,
							vacate_option   => $nsda_districts,
							nofinish        => "Yes"
						&>
%					}

<%perl>

					$placement = scalar( keys %in_elims) + 1;

					$limit_done = $limit - $placement;
					$limit_done = 1 unless $limit;

					my $noheaders;

					$noheaders++ 
						unless (scalar (keys %in_elims)) == scalar (keys (%in_finals));

					foreach my $prelim (@prelims) { 

						next if $limit_done < 1;

						$noheaders++ if $tourn_settings->{"nsda_nats"};

						if ($separate_sections) { 

							foreach my $section ($prelim->panels) { 

								$m->comp("results_table.mas", 
									round           => $prelim,
									tiebreak_set    => $final_tiebreaks,
									nsda_districts  => $nsda_districts,
									nsda_nats       => $tourn_settings->{"nsda_nats"},
									limit           => $limit,
									qualifiers      => \%qualifiers,
									vacated         => \%vacated,
									alternates      => \%alternates,
									others          => \%others,
									exclude         => \%in_elims,
									start_placement => $placement,
									none_above      => \%last_prelim,
									noheader        => $noheaders++,
									vacate_option   => $nsda_districts,
									nofinish        => "Yes",
									section         => $section
								);

							}

						} else { 

							$m->comp("results_table.mas", 
								round           => $prelim,
								tiebreak_set    => $final_tiebreaks,
								nsda_districts  => $nsda_districts,
								nsda_nats       => $tourn_settings->{"nsda_nats"},
								qualifiers      => \%qualifiers,
								vacated         => \%vacated,
								alternates      => \%alternates,
								others          => \%others,
								exclude         => \%in_elims,
								start_placement => $placement,
								noheader        => $noheaders++,
								vacate_option   => $nsda_districts,
								limit           => $limit,
								nofinish        => "Yes"
							);

						}

						$placement += $round_count{$prelim->name};

					}

</%perl>

					</tbody>

				</table>

				</div>

<%perl>

			}

		}

	}

	if ($format eq "csv" || $format eq "simplecsv") { 

		$m->flush_buffer();
		$m->abort();

	} elsif ($format eq "pdf") { 

		$m->comp("/funclib/printout.mas", 
			tourn    => $tourn,
			filename => $filename,
			tail     => 1 
		);

	} else { 

		$m->print("</div>");
		$m->print("</div>");

	}

</%perl>

