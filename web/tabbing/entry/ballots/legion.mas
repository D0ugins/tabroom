<%args>
	$judge
	$panel
	$session
	$person
	$person_settings
	$timeslot
</%args>
<%init>

	my $round = $panel->round;
	my $event = $round->event;

	my @ballots = Tab::Ballot->search( 
		judge => $judge->id,
		panel => $panel->id
	);

	my $min = $event->setting('min_points') if $event;  
	my $max = $event->setting('max_points') if $event;

	my @categories = ( 
		"content",
		"speaking",
		"penalties"
	);

</%init>

	<div class="full nospace">

		<span class="half nospace">
			<h4>
				<% ($judge->school && $judge->school->code) ? $judge->school->code : "" %> 
				<% $judge->code %> 
				<% ($judge) ? $judge->first." ".$judge->last : ""  %>
			</h4>
		</span>

		<span class="half right rightalign">

			<a 	class="bluetext buttonwhite"
				href="/panel/schemat/show.mhtml?from=entry&round_id=<% $round->id %>">
				<% $round->realname %>
			</a>

			<a 	class="bluetext buttonwhite"
				href="/panel/schemat/panel_view.mhtml?from=entry&judge_id=<% $judge->id %>&panel_id=<% $panel->id %>">
				<% $panel->room ? "Section in ".$panel->room->name : " Section ".$panel->letter %>
			</a>
		</span>

	</div>

	<form action="ballots/legion_save.mas" method="post">

	<input 
		type  = "hidden"
		name  = "judge_id"
		value = "<% $judge->id %>"
	>

	<input 
		type  = "hidden"
		name  = "panel_id"
		value = "<% $panel->id %>"
	>

	<h5>A. Content</h5>

		<div class="row ltyellow semibold">

			<span 
				class = "twenty hover centeralign semibold bluetext padvert"
			></span>

			<span class="fifth nospace padvert">
				&nbsp;
			</span>
				
			<span class="threequarters nospace centeralign">
%				foreach my $ballot (sort {$a->speakerorder <=> $b->speakerorder} @ballots) {
					<span class="sixth nospace semibold bluetext">
						<% $ballot->speakerorder %>.
					</span>
%				}
			</span>

		</div>

<%perl>

		my %content = %{ JSON::decode_json($event->setting("content_points") ) }
			if $event->setting("content_points");

		foreach my $key (sort keys %content) { 

			my %limits; 

			foreach my $type ("prepared", "assigned", "total") { 
				if ($content{$key}{$type}) { 
					if ($content{$key}{$type} < 0) { 
						$limits{$type."_min"} = $content{$key}{$type};
						$limits{$type."_max"} = 0;
					} else { 
						$limits{$type."_max"} = $content{$key}{$type};
						$limits{$type."_min"} = 0;
					}
				}
			}

</%perl>
			<div class="row">

				<span 
					title = "<% $content{$key}{"text"} %>"
					class = "twenty hover centeralign semibold bluetext padvert"
				><% $key %></span>

				<span class="fifth nospace">

%					if ($content{$key}{"total"}) { 

						<div class="padless full">
							<span class="threefifths">
								Total 
							</span>
							<span class="twofifths smallish nowrap rightalign">
								(<% $limits{"total_min"} %> - <% $limits{"total_max"} %>)
							</span>
						</div>

%					} else { 

						<div class="nospace padvert full borderbottom">
							<span class="threefifths">
								Prepared
							</span>
							<span class="twofifths smallish nowrap rightalign">
								(<% $limits{"prepared_min"} %> - <% $limits{"prepared_max"} %>)
							</span>
						</div>

						<div class="full nospace padvert">
							<span class="threefifths">
								Assigned 
							</span>
							<span class="twofifths smallish nowrap rightalign">
								(<% $limits{"assigned_min"} %> - <% $limits{"assigned_max"} %>)
							</span>
						</div>
%					} 

				</span>
				
				<span class="threequarters nospace centeralign">

%					foreach my $type ("prepared", "assigned") { 

						<div class="nospace <% $type eq "prepared" ? 'borderbottom' : "" %>">

%						foreach my $ballot (sort {$a->speakerorder <=> $b->speakerorder} @ballots) {

							<span class="sixth marno padless">
							
								<input 
									type     = "number"
									class    = "<% $ballot->id %> <% $key %> content smallish"
									name     = "content_<% $key %>_<% $ballot->id %>"
									id       = "content_<% $key %>_<% $ballot->id %>"
									ballot   = "<% $ballot %>"
									category = "content"
									key      = "<% $key %>"
									min      = <% $limits{$type."_min"} %>
									max      = <% $limits{$type."_max"} %>
									onBlur   = "addTotals();"
								>
							</span>
%						}

						</div>

%					}

				</span>

			</div>

%		}

	<h5>B. Speaking Skills</h5>

<%perl>

		my %speaking = %{ JSON::decode_json($event->setting("speaking_points") ) }
			if $event->setting("speaking_points");

		foreach my $key (sort keys %speaking) { 

			my %limits; 

			foreach my $type ("prepared", "assigned", "total") { 
				if ($speaking{$key}{$type}) { 
					if ($speaking{$key}{$type} < 0) { 
						$limits{$type."_min"} = $speaking{$key}{$type};
						$limits{$type."_max"} = 0;
					} else { 
						$limits{$type."_max"} = $speaking{$key}{$type};
						$limits{$type."_min"} = 0;
					}
				}
			}

</%perl>
			<div class="row">

				<span 
					title = "<% $speaking{$key}{"text"} %>"
					class = "twenty hover centeralign semibold bluetext padvert"
				><% $key %></span>

				<span class="fifth nospace">

%					if ($speaking{$key}{"total"}) { 

						<div class="padless full">
							<span class="threefifths">
								Total 
							</span>
							<span class="twofifths smallish nowrap rightalign">
								(<% $limits{"total_min"} %> - <% $limits{"total_max"} %>)
							</span>
						</div>

%					} else { 

						<div class="nospace padvert full borderbottom">
							<span class="threefifths">
								Prepared
							</span>
							<span class="twofifths smallish nowrap rightalign">
								(<% $limits{"prepared_min"} %> - <% $limits{"prepared_max"} %>)
							</span>
						</div>

						<div class="full nospace padvert">
							<span class="threefifths">
								Assigned 
							</span>
							<span class="twofifths smallish nowrap rightalign">
								(<% $limits{"assigned_min"} %> - <% $limits{"assigned_max"} %>)
							</span>
						</div>
%					} 

				</span>
				
				<span class="threequarters nospace centeralign">

%					foreach my $type ("prepared", "assigned") { 

						<div class="nospace <% $type eq "prepared" ? 'borderbottom' : "" %>">

%						foreach my $ballot (sort {$a->speakerorder <=> $b->speakerorder} @ballots) {

							<span class="sixth marno padless">
							
								<input 
									type     = "number"
									class    = "<% $ballot->id %> <% $key %> speaking smallish"
									name     = "speaking_<% $key %>_<% $ballot->id %>"
									id       = "speaking_<% $key %>_<% $ballot->id %>"
									ballot   = "<% $ballot %>"
									category = "speaking"
									key      = "<% $key %>"
									min      = <% $limits{$type."_min"} %>
									max      = <% $limits{$type."_max"} %>
									onBlur   = "addTotals();"
								>
							</span>
%						}

						</div>

%					}

				</span>

			</div>

%		}

		<div class="row bordervert">

			<span 
				class = "twenty hover centeralign semibold bluetext padvert"
			></span>

			<span class="fifth nospace padvert">
				<h6 class="semibold bluetext">SUBTOTALS:</h6>
			</span>
				
			<span class="threequarters nospace centeralign">

%				foreach my $ballot (sort {$a->speakerorder <=> $b->speakerorder} @ballots) {

					<span 
						class="sixth nospace semibold bluetext centeralign bigger"
						class    = "<% $ballot->id %> subtotal smallish"
						name     = "subtotal_<% $ballot->id %>"
						id       = "subtotal_<% $ballot->id %>"
					>
						0
					</span>
%				}
			</span>

		</div>

<%perl>

		my %penalties = %{ JSON::decode_json($event->setting("penalties_points") ) }
			if $event->setting("penalties_points");

		foreach my $key (sort keys %penalties) { 

			my %limits; 

			foreach my $type ("prepared", "assigned", "total") { 
				if ($penalties{$key}{$type}) { 
					if ($penalties{$key}{$type} < 0) { 
						$limits{$type."_min"} = $penalties{$key}{$type};
						$limits{$type."_max"} = 0;
					} else { 
						$limits{$type."_max"} = $penalties{$key}{$type};
						$limits{$type."_min"} = 0;
					}
				}
			}

</%perl>
			<div class="row">

				<span 
					title = "<% $penalties{$key}{"text"} %>"
					class = "twenty hover centeralign semibold bluetext padvert"
				><% $key %></span>

				<span class="fifth nospace">

%					my @types;

%					if ($penalties{$key}{"total"}) { 

%						@types = ('total');

						<div class="padless full">
							<span class="threefifths">
								Total 
							</span>
							<span class="twofifths smallish nowrap rightalign">
								(<% $limits{"total_min"} %> - <% $limits{"total_max"} %>)
							</span>
						</div>

%					} else { 

%						@types = ('prepared', 'assigned');

						<div class="nospace padvert full borderbottom">
							<span class="threefifths">
								Prepared
							</span>
							<span class="twofifths nowrap smallish">
								(<% $limits{"prepared_min"} %> - <% $limits{"prepared_max"} %>)
							</span>
						</div>

						<div class="full nospace padvert">
							<span class="threefifths">
								Assigned 
							</span>
							<span class="twofifths nowrap smallish">
								(<% $limits{"assigned_min"} %> - <% $limits{"assigned_max"} %>)
							</span>
						</div>
%					} 

				</span>
				
				<span class="threequarters nospace centeralign">

%					foreach my $type (@types) { 

						<div class="nospace <% $type eq "prepared" ? 'borderbottom' : "" %>">

%						foreach my $ballot (sort {$a->speakerorder <=> $b->speakerorder} @ballots) {

							<span class="sixth marno padless">
							
								<input 
									type     = "number"
									class    = "<% $ballot->id %> <% $key %> total smallish"
									name     = "total_<% $key %>_<% $ballot->id %>"
									id       = "total_<% $key %>_<% $ballot->id %>"
									ballot   = "<% $ballot %>"
									category = "total"
									key      = "<% $key %>"
									min      = <% $limits{$type."_min"} %>
									max      = <% $limits{$type."_max"} %>
									onBlur   = "addTotals();"
								>
							</span>
%						}

						</div>

%					}

				</span>

			</div>

%		}

		<div class="row bordervert">

			<span 
				class = "twenty hover centeralign padvert"
			></span>

			<span class="fifth nospace padvert">
				<h6 class="semibold redtext">FINAL TOTAL:</h6>
			</span>
				
			<span class="threequarters nospace centeralign">

%				foreach my $ballot (sort {$a->speakerorder <=> $b->speakerorder} @ballots) {

					<span 
						class="sixth nospace semibold redtext centeralign bigger"
						class    = "<% $ballot->id %> total smallish"
						name     = "total_<% $ballot->id %>"
						id       = "total_<% $ballot->id %>"
					>0
					</span>
%				}
			</span>

		</div>

		<div class="row bordervert">

			<span 
				class = "twenty hover centeralign padvert"
			></span>

			<span class="fifth nospace padvert">
				<h6 class="semibold redtext">Ranking:</h6>
			</span>
				
			<span class="threequarters nospace centeralign">

%				foreach my $ballot (sort {$a->speakerorder <=> $b->speakerorder} @ballots) {

					<span 
						class="sixth nospace semibold redtext centeralign bigger"
						class    = "<% $ballot->id %> subtotal smallish"
						name     = "subtotal_<% $ballot->id %>"
						id       = "subtotal__<% $ballot->id %>"
					>
						<% $ballot->speakerorder %>
					</span>
%				}
			</span>

		</div>

	</div>

	<script>

		function autoAdvance(eventObject) { 

		}

		function addTotals() { 

			var scoreTotals = {};
			var scoreSubTotals = {};

			$(".content").each(function() { 

				var ballot =  $(this).attr("ballot");
				
				if (scoreTotals[ballot]) { 
				} else { 
					scoreTotals[ballot] = 0;
				}
				if (scoreSubTotals[ballot]) { 
				} else { 
					scoreSubTotals[ballot] = 0;
				}

				if ($(this).val()) { 
					var score = parseInt($(this).val());
					scoreTotals[ballot] += score;
					scoreSubTotals[ballot] += score;
				}

			});

			$(".speaking").each(function() { 
				var ballot =  $(this).attr("ballot");
				if ($(this).val()) { 
					var score = parseInt($(this).val());
					scoreTotals[ballot] += score;
					scoreSubTotals[ballot] += score;
				}

			});

			$(".penalties").each(function() { 
				var ballot =  $(this).attr("ballot");
				if ($(this).val()) { 
					var score = parseInt($(this).val());
					scoreTotals[ballot] += score;
				}
			});


			Object.keys(scoreTotals).forEach(function(key, index) { 
				$("#subtotal_"+key).text(scoreSubTotals[key]);
				$("#total_"+key).text(scoreTotals[key]);
			
				console.log("Ballot "+key+" is score Total "+scoreTotals[key]);
			});

		}

	</script>
