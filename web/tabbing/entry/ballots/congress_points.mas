<%args>
	$panel 
    $session
    $person
    $all         => undef
    $entered     => undef
    $rank_err    => undef
    $judge       => undef
    $rank_string => undef
    $timeslot    => undef
</%args>
<%init>

	$timeslot = $panel->round->timeslot unless $timeslot;

	my $tourn = $timeslot->tourn;

	my @timeslots = 
		sort {$a->start->epoch <=> $b->start->epoch} 
		$tourn->timeslots;

	$timeslot = $timeslots[0] unless $timeslot;

	my @ballots;
	my @scores;
	my %entry_ballot;
	my %entry_speech;

	if ($judge) { 

		@ballots = $m->comp(
			'/funclib/judge_ballots.mas', 
			judge    => $judge,
			timeslot => $timeslot
		);

		@scores = $m->comp(
			'/funclib/judge_scores.mas',
			judge    => $judge,
			timeslot => $timeslot,
			tag      => "congress_speech"
		);

		%entry_ballot = map {$_->entry => $_} @ballots;

		foreach my $score (@scores) { 
			$entry_speech{$score->entryid}{$score->speech} = $score;
		}

	}

	my @entries = $m->comp(
		"/funclib/panel_entries.mas", 
		panel => $panel
	) if $panel;

	@entries = sort {$a->school->name cmp $b->school->name} @entries;

</%init>

%		if ($panel) { 

%			my $chamber = $panel->letter;
%			my $event = $panel->round->event;

			<div class="nopad">

				<span class="third">

					<a 
						class="white" 
						href="/panel/schemat/panel_view.mhtml?from=entry&judge_id=<% $judge->id %>&panel_id=<% $panel->id %>">

						<h5>

%						unless ($event->category->setting("no_codes")) { 
							<% $judge->code %> 
%						}
						<% ($judge) ? $judge->first." ".$judge->last : ""  %>

						</h5>
					</a>
				</span>

				<span class="third centeralign">

					<a 
						class="buttonwhite smallish redtext hover" 
						href="/panel/schemat/show.mhtml?from=entry&round_id=<% $panel->round->id %>"
					>
						<% $event->abbr %>
						<% ($panel->round->label) ? $panel->round->label : "Rnd ".$panel->round->name %>
					</a>
				</span>

				<span class="third centeralign">

					<a 
						class="buttonwhite smallish greentext hover"
						href="/panel/schemat/panel_view.mhtml?from=entry&judge_id=<% $judge->id %>&panel_id=<% $panel->id %>">
						<% $panel->room ? "Chamber ". $panel->letter ." in ".$panel->room->name : "" %>  
					</a>
				</span>

			</div>

			<h5 class="centeralign">Individual Speech Scores</h5>

			<& "/funclib/tablesorter.mas" , table => "sortmebaby" &>

			<form 
				action="ballots/congress_points_save.mas" 
				method="post"
			>

			<input 
				type="hidden" 
				name="judge_id" 
				value="<% $judge->id %>"
			>

			<input 
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

			<table id="sortmebaby">

				<thead>

				<tr class="yellowrow">

					<th class="smallish">
						Code
					</th>
		
					<th class="smallish">
						Name
					</th>

					<th class="smallish">
						Speech 1
					</th>

					<th class="smallish">
						Speech 2
					</th>

					<th class="smallish">
						Speech 3
					</th>

					<th class="smallish">
						Speech 4
					</th>

					<th class="smallish">
						Speech 5
					</th>

				</tr>

				</thead>

				<tbody>

%	      		foreach my $entry (@entries) {


%					next if $entry->dropped;

%	          		if ($entry->dq) {
						<tr class="lirdrow">
%	          		} else {
						<tr>
%	          		}

						<td class="smallish padleftmore <% $entry->dq ? "redtext strong" : "" %>">
							<% $entry->code %><% ($entry->dq) ? "-- DQ" : "" %>
						</th>

						<td class="smallish padleftmore">
							<% $entry->name %>
						</td>

%						my @keys = sort keys %{$entry_speech{$entry->id}};

%						foreach my $key (1 .. 5) {

%							my $speech_position = shift @keys if @keys;	
%							my $score = $entry_speech{$entry->id}{$speech_position} if $speech_position;  

							<td class="centeralign nospace smallish">

								<% $score ? $score->speech : "" %>

							   <input 
							   		type      = "text"
									size      = "4"
									maxlength = "2"
									onKeyUp   = "return autoTab(this, 2, event);"
									name      = "<% $entry->id %>_<% $key %>"
									value     = "<% $score ? $score->value : "" %>"
								>
							</td>

%						} 

					</tr>

%				} 

				</tbody>

				<tr class="liblrow">
					<td colspan="7" class="rightalign">
						<input type="submit" value="    Save Scores    ">
						</form>
					</td>
				</tr>

			</table>

%		} else { 

			<h2>Congress Scores</h2>

			<h4 class="centeralign">Choose a judge code at right to enter</h4>
%		} 


