<%args>
	$person
	$perms
	$target_id      => undef
	$property_name  => undef
	$setting_name   => undef
	$property_value => 0
</%args>
<%init>

	$m->clear_buffer();
	$r->content_type('application/json');

	unless ($target_id) {
		$m->print('{ "error": true, "message": "No entry ID sent"}');
		$m->abort();
	}

	my $entry = eval {
		return Tab::Entry->retrieve($target_id);
	};

	unless ($entry) {
		$m->print('{ "error": true, "message": "No valid entry found for ID '.$target_id.'"}');
		$m->abort();
	}

	unless ($property_name) {
		$m->print('{ "error": true, "message": "No chamber ID sent"}');
		$m->abort();
	}

	my $panel = eval {
		return Tab::Panel->retrieve($property_name);
	};

	unless ($panel) {
		$m->print('{ "error": true, "message": "No valid chamber found for ID '.$property_name.'"}');
		$m->abort();
	}

	unless ($setting_name) {
		$m->print('{ "error": true, "message": "No tag to change sent"}');
		$m->abort();
	}

	my $message;

	if ($setting_name eq "ballot") {

		my $existing = Tab::StudentBallot->search(
			entry => $entry->id,
			panel => $panel->id,
			tag   => "winloss"
		)->first;

		if ($property_value == 1) {

			if ($existing) {
				$existing->value(1);
				$existing->entered_by($person->id);
				$existing->update();
			} else {
				$existing = Tab::StudentBallot->create({
					entry      => $entry->id,
					panel      => $panel->id,
					tag        => "winloss",
					entered_by => $person->id,
					value      => 1
				});
			}

			$message = "added to student vote ballot";

		} elsif ($existing) {
			$existing->delete();
			$message = "removed from student vote ballot";
		}

	} elsif ($setting_name eq "rank" && $property_value > 0) {

		my $existing = Tab::StudentBallot->search(
			entry => $entry->id,
			panel => $panel->id,
			tag   => "rank"
		)->first;

		my @others = Tab::StudentBallot->search(
			panel => $panel->id,
			tag   => "rank",
			value => $property_value,
		);

		my $collision;

		while (@others) {
			my $test = shift @others;
			next if $test->entry->id == $entry->id;
			$collision++;
		}

		if ($collision) {
			$m->print('{ "error": true, "message": "Another competitor was given the same rank in that chamber.  Try again"}');
			$m->abort();
		}

		if ($property_value > 0) {

			if ($existing) {
				$existing->value($property_value);
				$existing->entered_by($person->id);
				$existing->update();
			} else {
				$existing = Tab::StudentBallot->create({
					entry      => $entry->id,
					panel      => $panel->id,
					tag        => "rank",
					entered_by => $person->id,
					value      => $property_value
				});
			}

			$message = "given student vote rank of $property_value";

		} elsif ($existing) {
			$existing->delete();
		}

	} else {

		return;

	}

	$m->print('{
		"error": false,
		"message": "'.$entry->name.' '.$message.'",
		"norefresh": true
	}');

	$m->abort();

</%init>

