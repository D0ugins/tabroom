<%args>
	$tourn
	$tourn_settings
	$event_id => undef
	$round_id => undef
	$voter_id => undef
	$panel_id => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my $round = Tab::Round->retrieve($round_id) if $round_id;
	my $chamber = Tab::Panel->retrieve($panel_id) if $panel_id;
	my $voter = Tab::Entry->retrieve($voter_id) if $voter_id;

	my $voter_student;
	$voter_student = $voter->students->first if $voter;
	my $lastname;
	$lastname = $voter_student->last if $voter_student;

	$round = $chamber->round if $chamber && (not defined $round);
	$event = $round->event if $round && (not defined $event);

	my %votes;
	my $truncate;
	$truncate = $event->setting("student_truncate_fill") if $event;

	my @congresses = $tourn->events(type => "congress");
	$event = $congresses[0] unless $event;

	my $dbh = Tab::DBI->db_Main();

	if ($round) {
		my $sth = $dbh->prepare("
			select voter.id, ballot.panel, count(distinct entry.id), count(distinct student_vote.entry)
			from student_vote, entry voter, ballot, ballot b2, entry, panel

			where ballot.panel = panel.id
				and panel.round = ?
				and voter.active = 1
				and student_vote.voter = voter.id
				and student_vote.panel = ballot.panel
				and ballot.entry = voter.id

			and b2.panel = ballot.panel
			and b2.entry = entry.id
			and entry.id != voter.id
			group by voter.id
		");

		$sth->execute($round->id);

		while (
			my ($voter, $panel, $entry_count, $vote_count) = $sth->fetchrow_array()
		) {
			$votes{$voter}{"votes"} = $vote_count;
			$votes{$voter}{"total"} = $entry_count;
		}
		$sth->finish();
	}


</%init>

	<div class="main">

		<h4>Student Vote</h4>

<%perl>

		if ($round) {

			foreach my $chamber ($round->panels) {

				next if $panel_id && $chamber->id != $panel_id;

				if ($ARGS{"all"}) {

					my %student_ballot =
						map {$_->entry->id => 1}
						$chamber->student_ballots(
							tag   => "winloss",
							value => 1
						);

					my %student_rank =
						map {$_->entry->id => $_->value}
						$chamber->student_ballots(
							tag => "rank"
						);

</%perl>
					<span class="twofifths nospace">
						<h5 class="normalweight nospace">
							<% $event->name %> Chamber <% $chamber->letter %>
						</h5>
					</span>

					<span class="twofifths nospace">
						<h5 class="normalweight nospace">
							<% $round->realname %>
						</h5>
					</span>

					<span
						class = "fifth rightalign nospace"
						id    = "<% $chamber->id %>_buttonarea"
					></span>

					<& "/funclib/tablesorter.mas", table => $chamber->id &>

					<table id="<% $chamber %>">

						<thead>

							<tr class="yellowrow smallish">
								<th>
									Entry
								</th>

								<th>
									Name
								</th>

								<th>
									On Ballot
								</th>

								<th>
									Vote
								</th>
							</tr>

						</thead>

						<tbody>
<%perl>
							my @entries = $m->comp("/funclib/panel_entries.mas", panel => $chamber);

							@entries = sort {$student_rank{$a} <=> $student_rank{$b}} @entries;
							@entries = sort {$student_ballot{$b} <=> $student_ballot{$a}} @entries;

							foreach my $entry (@entries) {
</%perl>
								<tr>

									<td>
										<% $entry->code %>
									</td>

									<td>
										<span class="hidden"><% $entry->lastname %></span>
										<% $entry->name %>
									</td>

									<td class="centeralign nospace">
										<span class="hidden">
											<% $student_ballot{$entry->id} ? 1 : 3.14159 %>
										</span>
										<label
											class='full hover marno padvertless'
											for="<% $entry->id %>_<% $chamber->id %>"
										>
											<input
												type          = "checkbox"
												id            = "<% $entry->id %>_<% $chamber->id %>"
												name          = "<% $entry->id %>_<% $chamber->id %>"
												target_id     = "<% $entry->id %>"
												property_name = "<% $chamber->id %>"
												setting_name  = "winloss"
												value         = 1
												tabindex      = -1
												onChange      = "postSwitch(this, 'student_vote_switch.mhtml');"
												<% $student_ballot{$entry->id} ? 'checked' : "" %>
											>
										</label>
									</td>

									<td class="centeralign">
										<span class="hidden">
											<% $student_rank{$entry->id} ? 1 : 9129299 %>
										</span>
										<input
											type          = "number"
											name          = "<% $entry->id %>"
											target_id     = "<% $entry->id %>"
											property_name = "<% $chamber->id %>"
											setting_name  = "rank"
											min           = "0"
											max           = "<% scalar @entries %>"
											onBlur        = "postSwitch(this, 'student_vote_switch.mhtml');"
											value         = "<% $student_rank{$entry->id} %>"
										>
									</td>


								</tr>
%							}

						</tbody>

					</table>

					<div class="full"></div>

<%perl>
				} elsif ($voter) {

					my $sth = $dbh->prepare("
						select voter.id, vote.entry, vote.id, vote.rank
							from (student_vote vote, entry voter)

							left join entry_student es on es.entry = voter.id
							left join student on es.student = student.id
						where vote.panel = ?
						and vote.voter = ?
						and vote.voter = voter.id
					");

					$sth->execute($chamber->id, $voter->id);

					my %ballot;

					while (
						my ($voter, $entry_id, $vote_id, $rank) = $sth->fetchrow_array()
					) {
						$ballot{$entry_id} = $rank;
					}

					$sth->finish();

</%perl>
					<form action="student_vote_save.mhtml" method="post">

					<input
						type  = "hidden"
						name  = "panel_id"
						value = "<% $chamber->id %>"
					>

					<input
						type  = "hidden"
						name  = "voter_id"
						value = "<% $voter->id %>"
					>

					<span class="third nospace">
						<h5 class="normalweight nospace">
							<% $event->abbr %> Chamber <% $chamber->letter %>
						</h5>
					</span>

					<span class="third nospace semibold redtext centeralign">
%					if ($truncate) {
						Blanks fill with a <% $truncate %>
%					}
					</span>

					<span class="third nospace rightalign">
						<h5 class="normalweight nospace">
							<% $voter->code %> <% $lastname %>
						</h5>
					</span>

					<& "/funclib/tablesorter.mas", nobuttons => 1, table => $chamber->id &>

					<table id="<% $chamber %>">

						<thead>

							<tr class="yellowrow smallish">
								<th>
									Entry
								</th>

								<th>
									Name
								</th>

								<th>
									Placement
								</th>
							</tr>

						</thead>

						<tbody>
<%perl>
							my $counter = 1;
							my @entries = $m->comp("/funclib/panel_entries.mas", panel => $chamber);
							my $panel_size = scalar @entries;

							foreach my $entry (@entries) {
</%perl>
								<tr>

									<td>
										<% $entry->code %>
									</td>

									<td>
										<span class="hidden"><% $entry->lastname %></span>
										<% $entry->name %>
									</td>

									<td class="centeralign nospace">
										<span class="hidden">
											<% $ballot{$entry->id} ? $ballot{$entry->id} : "-1" %>
										</span>

%										if ($truncate) {
%											foreach my $rank (1 ..  $truncate) {

%												my $picked = $ballot{$entry->id};
%												$picked = $truncate unless $picked;

												<label for="<% $entry->id %>_<% $rank %>">
													<span class="eighth hover ltborderright
														<% $rank == $truncate ? "redtext semibold" : "" %>"
													>
														<% $rank %>
														<input
															type  = "radio"
															id    = "<% $entry->id %>_<% $rank %>"
															name  = "<% $entry->id %>"
															value = "<% $rank %>"
															<% $rank == $picked ? "checked" : "" %>
														>
													</span>
												</label>
%											}

%										} else {
											<input
												type          = "number"
%												if ($counter == 1) {
													class         = "starthere"
%												}
												tabindex = "<% $counter++ %>"
												name     = "<% $entry->id %>"
												value    = "<% $ballot{$entry->id} %>"
												min      = 1
												max      = "<% $truncate ? $truncate : $panel_size %>"
											>
%										}
									</td>

								</tr>
%							}

						</tbody>

					</table>

					<div class="libl rightalign pagefull">
						<input type="submit" value="Save Ballot">
					</div>

					</form>

%				}
%			}
%		}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Round &amp; Session</h4>

			<form action="student_vote.mhtml" method="post">

				<div class="row centeralign">

					<span class="fifth semibold">
						Event
					</span>

					<span class="fourfifths">
						<select
							name     = "event_id"
							class    = "fixedmed"
							onChange = "this.form.submit();"
						>
							<option value=""></option>

%							foreach my $congress (@congresses) {
								<option
									value="<% $congress->id %>"
									<% $congress == $event ? "selected" : "" %>
								><% $congress->name %></option>
%							}
						</select>
					</span>
				</div>

%				if ($event) {
					<div class="row centeralign">

						<span class="fifth semibold">
							Session
						</span>

						<span class="fourfifths">

							<select
								name     = "round_id"
								class    = "fixedmed"
								onChange = "this.form.submit();"
							>
								<option value=""></option>
%								foreach my $session ($event->rounds()) {
									<option
										value="<% $session->id %>"
										<% $session == $round ? "selected" : "" %>
									><% $session->name %> <% $session->label %></option>
%							}

							</select>
						</span>

					</div>
%				}

%				if ($round) {
					<div class="row centeralign">

						<span class="fifth semibold">
							Chamber
						</span>

						<span class="fourfifths">

							<select
								name     = "panel_id"
								class    = "fixedmed"
								onChange = "this.form.submit();"
							>
								<option value=""></option>
%								foreach my $chamber ($round->panels()) {
									<option
										value="<% $chamber->id %>"
										<% $chamber == $panel_id ? "selected" : "" %>
									><% $chamber->letter %> <% $chamber->room ? $chamber->room->name : "" %></option>
%							}

							</select>
						</span>
					</div>
%				}

%				if ($chamber) {

					<div class="row centeralign">

						<h5>Ballots:</h5>
<%perl>

						my @entries = $m->comp("/funclib/panel_entries.mas", panel => $chamber);

						@entries = sort {$a->code cmp $b->code || $a->code <=> $b->code} @entries;
						@entries = sort {$votes{$a->id}{"votes"} <=> $votes{$b->id}{"votes"}} @entries;

						my $name = $event->setting("code_style");
						my $online_ballots = $event->setting("student_online_ballots");
						my $skip_last;

						if (index($name, "name") != -1) {
							$skip_last++;
						}

						foreach my $entry (@entries) {
</%perl>
							<span class="<% $skip_last ? "full" : "half" %> nospace leftalign">
%								if ($online_ballots) {
%									if ($entry->personid > 0) {
										<span class="eighth"></span>
%									} else {
										<a
											class="eighth white"
											href="/register/entry/student_edit.mhtml?student_id=<% $entry->studentid %>"
										><span
												title="LUDDITE: Entry not linked"
												class="semibold redtext biggish nospace"
											>L</span>
										</a>
%									}
%								}
								<a class="biggish white seveneighths marno
<%perl>
									if ($votes{$entry->id}{"votes"}
										&& $votes{$entry->id}{"votes"} == $votes{$entry->id}{"total"}
									) {
										$m->print("redtext");
									} elsif ($votes{$entry->id}{"votes"}
										&& $votes{$entry->id} < $votes{$entry->id}{"total"}
									) {
										$m->print("orangetext");
									} else {
										$m->print("bluetext");
									}
</%perl>
									semibold"
									href="student_vote.mhtml?panel_id=<% $chamber->id %>&voter_id=<% $entry->id %>"
								><% $entry->code %> <% $skip_last ? "" : $entry == $voter ? $lastname : $entry->lastname %></a>
							</span>
%						}

					</div>
%				}

			</form>

		</div>

%		if ($event && $round) {

			<div class="sidenote">

				<h4>Results and Printouts</h4>

				<a
					href   = "/panel/report/congress_student_ballots.mhtml?round_id=<% $round->id %>"
					class  = "blue full"
					target = "_blank"
				>
					Printed Ballots for <% $round->realname %>
				</a>

				<a
					href   = "/tabbing/results/index.mhtml?event_id=<% $event->id %>&round_id=<% $round->id %>"
					class  = "blue full"
					target = "_blank"
				>
					Entries seeded in order
				</a>

			</div>

%		}

	</div>
