<%args>
	$tourn
	$tourn_settings
	$event_id => undef
	$round_id => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my $round = Tab::Round->retrieve($round_id) if $round_id;

	$event = $round->event if $round && (not defined $event);

</%init>

	<div class="main">

		<h4>Congress: Student Vote</h4>

<%perl>

		if ($round) { 

			foreach my $chamber ($round->panels) { 

				my %student_ballot = 
					map {$_->entry->id => 1} 
					$chamber->student_ballots(tag => "ballot", value => 1);

				my %student_rank = 
					map {$_->entry->id => $_->value}
					$chamber->student_ballots(tag => "rank");

</%perl>
				<span class="twofifths nospace">
					<h5 class="normalweight nospace">
						<% $event->name %> Chamber <% $chamber->letter %>
					</h5>
				</span>

				<span class="twofifths nospace">
					<h5 class="normalweight nospace">
						<% $round->realname %>
					</h5>
				</span>

				<span 
					class = "fifth rightalign nospace"
					id    = "<% $chamber->id %>_buttonarea"
				></span>

				<& "/funclib/tablesorter.mas", table => $chamber->id &>

				<table id="<% $chamber %>">

					<thead>

						<tr class="yellowrow smallish">
							<th>
								Entry
							</th>

							<th>
								Name
							</th>

							<th>
								On Ballot
							</th>

							<th>
								Placement
							</th>
						</tr>

					</thead>

					<tbody>

<%perl>

						my @entries = $m->comp("/funclib/panel_entries.mas", panel => $chamber);

						@entries = sort {$student_rank{$a} <=> $student_rank{$b}} @entries;

						@entries = sort {$student_ballot{$b} <=> $student_ballot{$a}} @entries;

						foreach my $entry (@entries) { 

</%perl>
							<tr>

								<td>
									<% $entry->code %>
								</td>

								<td>
									<% $entry->name %>
								</td>

								<td class="centeralign nospace">
									<span class="hidden">
										<% $student_ballot{$entry->id} ? 1 : 3.14159 %>
									</span>
									<label 
										class='full hover marno padvertless'
										for="<% $entry->id %>_<% $chamber->id %>"
									>
										<input
											type          = "checkbox"
											id            = "<% $entry->id %>_<% $chamber->id %>"
											name          = "<% $entry->id %>_<% $chamber->id %>"
											target_id     = "<% $entry->id %>"
											property_name = "<% $chamber->id %>"
											setting_name  = "ballot"
											value         = 1
											tabindex      = -1
											onChange      = "postSwitch(this, 'student_vote_switch.mhtml');"
											<% $student_ballot{$entry->id} ? 'checked' : "" %>
										>
									</label>
								</td>

								<td class="centeralign">
									<span class="hidden">
										<% $student_rank{$entry->id} ? 1 : 9129299 %>
									</span>
									<input
										type          = "number"
										name          = "<% $entry->id %>"
										target_id     = "<% $entry->id %>"
										property_name = "<% $chamber->id %>"
										setting_name  = "rank"
										min           = "0"
										max           = "<% scalar @entries %>"
										onBlur        = "postSwitch(this, 'student_vote_switch.mhtml');"
										value         = "<% $student_rank{$entry->id} %>"
									>
								</td>


							</tr>
%						}

					</tbody>

				</table>

				<div class="full"></div>

%			}
%		}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Round &amp; Session</h4>

			<form action="student_vote.mhtml" method="post">

				<div class="row centeralign">
					<select 
						name     = "event_id"
						class    = "fixedmed"
						onChange = "this.form.submit();"
					>
						<option value=""></option>
%						foreach my $congress ($tourn->events(type => "congress")) { 
							<option 
								value="<% $congress->id %>"
								<% $congress == $event ? "selected" : "" %>
							><% $congress->name %></option>
%						}
					</select>
				</div>

%				if ($event) { 
					<div class="row centeralign">

						<select 
							name     = "round_id"
							class    = "fixedmed"
							onChange = "this.form.submit();"
						>
							<option value=""></option>
%							foreach my $session ($event->rounds()) { 
								<option 
									value="<% $session->id %>"
									<% $session == $round ? "selected" : "" %>
								><% $session->name %></option>
%						}

						</select>

					</div>
%				}

			</form>

		</div>

%		if ($event && $round) { 

			<div class="sidenote">

				<h4>Results and Printouts</h4>

				<a 
					href   = "/tabbing/results/index.mhtml?event_id = <% $event->id %>&round_id = <% $round->id %>"
					class  = "blue full"
					target = "_blank"
				>
					Entries seeded in order
				</a>

			</div>

%		}

	</div>
