<%args>
	$tourn
	$tourn_settings
	$category_id => undef
</%args>
<%init>

	my @sites = $m->comp("/funclib/tourn_sites.mas", tourn => $tourn);

	my $category = Tab::Category->retrieve($category_id) if $category_id;

	$m->abort unless $category;

	unless (@sites) { 

		my $err = "You have to set up a site/location for your tournament ";
		$err .= "before you can create judge pools.";

		$m->redirect("/setup/rooms/manage_sites.mhtml?err=$err");

	}

</%init>

    <script type="text/javascript"> 

		function showMe() { 

			$(".peekaboo").each(function() { 

				var jpoolID = this.id;

				if ($(this).prop("checked")) { 
					console.log(this.id+" is checked so removing hidden");
					$("."+jpoolID).removeClass('hidden');
				} else {
					console.log(this.id+" is not checked so adding hidden");
					$("."+jpoolID).addClass('hidden');
				}

			});
		} 

    </script>

	<& "menu.mas",
		category_id    => $category_id,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		page           => "pools"
	&>

	<div class="main">

		<h2>
			<% $category->name %>
		</h2>

		<& "tabbar.mas", 
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			whoami         => "pools",
			category       => $category
		&>

		<h4>Registration Judge pools</h4>

		<p>
			Use pools to only pull judges in that jpool for a certain round, as
			in an elim.  You can add judges to a jpool under Paneling &rarr;
			Judge Pools.  Assign pools to a round under Settings &rarr;
			Schedule, or under Paneling &rarr; Assign Judges &rarr; Settings.
		</p>

		<form 
			action = "pool_save.mhtml"
			method = "post"
		>

		<table>

			<tr class="yellowrow">
				
				<th class="smallish">
					Pool Name
				</th>

				<th class="smaller">
					Standby
				</th>

				<th class="smaller">
					Publish
				</th>

				<th class="smallish centeralign">
					Registrants assign judges to pools
				</th>

%				if (scalar @sites > 1) { 
					<th class="smallish">
						Site
					</th>
%				}

				<th>

					<input 
						type  = "hidden"
						name  = "category_id"
						value = "<% $category->id %>"
					>

				</th>

			</tr>

<%perl>

			my $registration_jpool_count;

			my %jpool_settings = $m->comp(
				"/funclib/jpool_settings.mas", 
				category => $category
			);

			foreach my $jpool (
				sort {$a->name cmp $b->name} 
				$category->jpools
			) { 

				$registration_jpool_count++ 
					if $jpool_settings{$jpool->id}{"registrant"};

</%perl>
				<tr class="row">

					<td class="centeralign">
						<input 
							type  = "text"
							name  = "<% $jpool->id %>_name"
							size  = "24"
							value = "<% $jpool->name %>"
						>
					</td>

					<td class="centeralign nospace">

						<span class="quarter marno padvert">
							<input 
								type    = "checkbox"
								class   = "peekaboo"
								id      = "<% $jpool->id %>_standby"
								name    = "<% $jpool->id %>_standby"
								onClick = "showMe()"
								value   = "1"
								<% $jpool_settings{$jpool->id}{"standby"} ? "checked" : ""  %> 
							>
						</span>

						<span 
							class = "threequarters smallish <% $jpool->id %>_standby hidden"
							id    = "standby_<% $jpool->id %>"
						>

							<select 
								name  = "<% $jpool->id %>_timeslot"
								class = "fixedsmallest plain"
							>

								<option value="">Choose When:</option>

%								foreach my $timeslot ($tourn->timeslots) { 

									<option value="<% $timeslot->id %>" 
										<% $jpool_settings{$jpool->id}{"standby_timeslot"} 
											&& $timeslot->id == $jpool_settings{$jpool->id}{"standby_timeslot"} 
											? "selected" 
											: ""
										%>
									><% $timeslot->name %> </option>
%								}
							</select>
						</span>
					</td>

					<td class="centeralign">

						<input 
							type  = "checkbox"
							name  = "<% $jpool->id %>_publish"
							value = "1"
							<% $jpool_settings{$jpool->id}{"publish"} ? "checked" : ""  %> 
						>
					</td>

					<td class="leftalign nospace">

						<label for="<% $jpool->id %>_registrant">

							<span class="eighth nospace hover centeralign padvert">

								<input 
									type    = "checkbox"
									class   = "peekaboo"
									id      = "<% $jpool->id %>_registrant"
									name    = "<% $jpool->id %>_registrant"
									onClick = "showMe()"
									value   = "1"
									<% $jpool_settings{$jpool->id}{"registrant"} ? "checked" : ""  %>
								>
							</span>
						</label>

						<span 
							class = "seveneighths smallish nospace <% $jpool->id %>_registrant ltborder"
						>

							<label for="<% $jpool->id %>_event_based">
								<span class="half hover nospace">
									By Event
									<input 
										type  = "checkbox"
										id    = "<% $jpool->id %>_event_based"
										name  = "<% $jpool->id %>_event_based"
										value = "1"
										<% $jpool_settings{$jpool->id}{"event_based"} ? "checked" : ""  %> 
									>
								<span>
							</label>

							<span class="half nospace">
								Burden
								<input 
									type  = "text"
									name  = "<% $jpool->id %>_burden"
									size  = "2"
									value = "<% $jpool_settings{$jpool->id}{"burden"} %>"
								>%
							</span>

						</span>
					</td>

%					if (scalar @sites > 1) { 
						<td class="centeralign smallish">

							<select 
								name  = "<% $jpool->id %>_site"
								class = "fixedsmallest plain"
							>

%								foreach my $site (@sites) { 
									<option value="<% $site->id %>" 
										<% $site->id == $jpool->site->id ? "selected" : "" %>
									> <% $site->name %> </option>
%								}
							</select>
						</td>
%					} else { 
						<input 
							type  = "hidden"
							name  = "<% $jpool->id %>_site"
							value = "<% $sites[0]->id %>"
						>
%					}

					<td class="smallish centeralign nospace">

%						my $warn = "You are about to delete this jpool and all its judges.  Are you sure?";

						<a 
							class="redtext buttonwhite fa fa-lg fa-trash"
							href="pool_rm.mhtml?jpool_id=<% $jpool->id %>" 
							<& "/funclib/confirm.mas", warn => $warn &>  
						>
						</a>
					</td>

				</tr>

%			}

%			if ($category->jpools) { 
	
				<tr>
					<td colspan="8">
						<hr />
					</td>
				</tr>

%			}

			<tr class="row">

				<td class="centeralign">
					<input 
						type        = "text"
						name        = "new_name"
						size        = "24"
						placeholder = "New judge jpool"
					>
				</td>

				<td class="centeralign">

					<input 
						type    = "checkbox"
						class   = "peekaboo"
						id      = "new_standby"
						name    = "new_standby"
						value   = "1"
						onClick = "showMe()"
					>

					<span 
						class = "smallish hidden new_standby"
						id    = "standby_new"
					>

						<select 
							name="new_timeslot" 
							class='fixedtiny'
						>

							<option value="">Choose When:</option>

%							foreach my $timeslot ($tourn->timeslots) { 
								<option 
									value="<% $timeslot->id %>"
								><% $timeslot->name %></option>
%							}
						</select>

					</span>

				</td>

				<td class="centeralign">
					<input 
						type  = "checkbox"
						name  = "new_publish"
						value = "1"
					>
				</td>

				<td class="leftalign nospace">

					<label for="new_registrant">
						<span class="eighth nospace hover centeralign padvert">
							<input 
								type    = "checkbox"
								name    = "new_registrant"
								class   = "peekaboo"
								id      = "new_registrant"
								onClick = "showMe()"
								value   = "1"
							>
						</span>
					</label>

					<span 
						class = "seveneighths smallish nospace new_registrant ltborder hidden"
					>

						<label for="new_event_based">
							<span class="half hover nospace">
								By Event
								<input 
									type  = "checkbox"
									name  = "new_event_based"
									id    = "new_event_based"
									value = "1"
								>
							</span>
						</label>

						<span class="half nospace">
							Burden
							<input 
								type = "text"
								name = "new_burden"
								size = "2"
							>%
						</span>
					</span>

				</td>

%				if (scalar @sites > 1) { 
					<td class="centeralign smallish">
						<select 
							name  = "new_site"
							class = "fixedtiny"
						>
%							foreach my $site (@sites) { 
								<option 
									value="<% $site->id %>"
								><% $site->name %> </option>
%							}
						</select>
					</td>
%				} else { 
					<input 
						type  = "hidden"
						name  = "new_site"
						value = "<% $sites[0]->id %>"
					>
%				} 

				<td>
				</td>

			</tr>

			<tr class="liblrow">

				<td class="rightalign" colspan="9">
					<input 
						type  = "submit"
						class = "thin"
						value = " Save Changes "
					>
				</td>

			</tr>

		</table>

%	if ($registration_jpool_count ) { 

			<h4>Minimum Pool Requirement</h4>

			<div class="row">


				<span class="half">
					Minimum number of pools a judge must register for:
				</span>

				<span class="quarter centeralign">
					<input
						type  = "number"
						name  = "min_registrant_jpools"
						min   = "0"
						max   = "<% $registration_jpool_count %>"
						value = "<% $category->setting("min_registrant_jpools") %>"
					>
				</span>

				<span class="quarter rightalign">
					<input
						type = "submit"
						name = "Save"
					>
				</span>

			</div>

%		}

		</form>

	</div>

