<%args>
	$person
	$tourn
	$tourn_settings
	$new         => undef
	$page        => undef
	$category_id => undef
</%args>
<%perl>

	my $category = Tab::Category->retrieve($category_id) if $category_id;

	$category = $tourn->categories->first
		if scalar $tourn->categories == 1
		&& not defined $new;

	$category_id = $category->id
		if $category
		&& not defined $new;

	my %category_settings = $category->all_settings if $category;

	if ($page) {

		$m->redirect("edit.mhtml?category_id=".$category->id) if $page eq "edit";
		$m->redirect("hires.mhtml?category_id=".$category->id) if $page eq "hires";
		$m->redirect("tabbing.mhtml?category_id=".$category->id) if $page eq "tabbing";
		$m->redirect("ratings.mhtml?category_id=".$category->id) if $page eq "ratings";
		$m->redirect("tiers.mhtml?category_id=".$category->id) if $page eq "tiers";
		$m->redirect("coach_tiers.mhtml?category_id=".$category->id) if $page eq "coach_tiers";
		$m->redirect("shifts.mhtml?category_id=".$category->id) if $page eq "shifts";
		$m->redirect("pools.mhtml?category_id=".$category->id) if $page eq "pools";

	}

	my $judge_per++ if $category_settings{"judge_per"};
	my $rounds_per++ if $category_settings{"rounds_per"};

	$page = "edit";
	$page = "new" if $new;

</%perl>

	<&
		"menu.mas",
		category_id    => $category_id,
		tourn          => $tourn,
		tourn_settings => $tourn_settings,
		page           => $page
	&>

	<div class="main">

%	if ($category || $new) {

		<h2>
			<% ($category) ? $category->name : "Add New Judging Group" %>
		</h2>

%		if ($category) {
			<&
				"tabbar.mas",
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				whoami         => "edit",
				category       => $category
			&>
%		}

		<h4>Registration settings</h4>

		<form action="edit_save.mhtml" method="post">

		<input
			type  = "hidden"
			value = "<% $category_id %>"
			name  = "category_id"
		>

		<span class="pagehalf">

			<div class="row">
				<span class="quarter">
					Name:
				</span>

				<span class="threequarter rightalign">
					<input
						type  = "text"
						name  = "name"
						value = "<% $category ?  $category->name : ""%>"
						size  = "25">
				</span>
			</div>

			<label for="no_codes">
				<div class="row hover">
					<span class="fivesixth">
						Suppress judge codes (names only)
					</span>
					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "no_codes",
                            value   => $category_settings{"no_codes"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

			<div class="row">
				<span class="threequarter">
					Start judge codes with
				</span>

				<span class="quarter rightalign ">
					<input
						type  = "number"
						name  = "code_start"
						size  = "5"
						min   = "1"
						max   = "99999"
						value = "<% $category_settings{"code_start"} %>"
					>
				</span>
			</div>

			<label for="field_report">
				<div class="row hover">
					<span class="fivesixth">
						Publish the list of judges online
					</span>

					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "field_report",
                            value   => $category_settings{"field_report"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

%			if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {

				<label for="publish_paradigms">

					<div class="row hover">

						<span class="fivesixth">
							Publish paradigms
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "publish_paradigms",
								value   => $category_settings{"publish_paradigms"},
								target  => $category,
								smaller => 1,
							&>
						</span>

					</div>

				</label>
%			}

			<label for="linked_only">

				<div class="row hover">

					<span class="fivesixth">
						Require judges to have linked accounts
					</span>

					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "linked_only",
                            value   => $category_settings{"linked_only"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>

				</div>

			</label>

			<label for="judge_cells">
				<div class="row hover">

					<span class="fivesixth">
						Ask for judge phone #s at registration
					</span>

					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "judge_cells",
                            value   => $category_settings{"judge_cells"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

			<label for="departure_times">
				<div class="row hover">

					<span class="fivesixth">
						Ask for judge departure times at registration
					</span>

					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "departure_times",
                            value   => $category_settings{"departure_times"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

% 			if ($tourn_settings->{"ncfl"}) {

				<label for="tab_room">

					<div class="row">

						<span class="fivesixth">
							Flat obligation (tab room)
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "tab_room",
								value   => $category_settings{"tab_room"},
								target  => $category,
								smaller => 1,
							&>
						</span>

					</div>

				</label>

				<div class="row">

					<span class="threefifths">
						Minimum per diocese
					</span>

					<span class="twofifth rightalign">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "dio_min"
							value = "<% $category_settings{"dio_min"} %>"
							size  = "4">
					</span>

				</div>

% 			}

		</span>

		<span class="pagehalf">

			<div class="row">

				<span class="twothird">
					Abbreviation, max 4 letters:
				</span>

				<span class="third rightalign">
					<input
						type      = "text"
						maxlength = "4"
						name      = "abbr"
						value     = "<% $category ? $category->abbr : "" %>"
						size      = "7"
					>
				</span>
			</div>

			<label for="show_judge_contacts">

				<div class="row hover">

					<span class="fivesixth">
						Show judge contact info on reg sheets
					</span>

					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "show_judge_contacts",
                            value   => $category_settings{"show_judge_contacts"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

			<label for="judge_quals">
				<div class="row hover">
					<span class="fivesixth">
						Ask for judge qualifications and histories
					</span>

					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "judge_quals",
                            value   => $category_settings{"judge_quals"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>


%			if ( $category && $category->events( type => "congress") ) {

				<label for="ask_parli">
					<div class="row hover">
						<span class="fivesixth">
							Ask for parliamentarians
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "ask_parli",
								value   => $category_settings{"ask_parli"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

%			unless ($tourn_settings->{"nsda_district"}) {

				<label for="first_year_outs">
					<div class="row hover">
						<span class="fivesixth">
							Registrants can mark first year outs
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "first_year_outs",
								value   => $category_settings{"first_year_outs"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<div class="row hover">

					<span class="third">
						Label for FYOs:
					</span>

					<span class="twothirds rightalign">
						<input
							type  = "text"
							name  = "fyo_label"
							id    = "fyo_label"
							size  = "24"
							value = "<% $category_settings{"fyo_label"}  %>"
						>
					</span>
				</div>

%			}

			<label for="neutrals">
				<div
					class = "row hover"
					title = "Neutral judges will be able to judge their own school's entries"
				>
					<span class="fivesixth ">
						Registrants can mark neutral judges
					</span>
					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "neutrals",
                            value   => $category_settings{"neutrals"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

			<label for="double_entry">
				<div class="row hover">
					<span class="fivesixth">
						Allow judge double-entry in other categories
					</span>
					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "double_entry",
                            value   => $category_settings{"double_entry"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

			<label for="ask_alts">
				<div class="row hover">
					<span class="fivesixth">
						Ask to specify an alternate judge category
					</span>
					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "ask_alts",
                            value   => $category_settings{"ask_alts"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

%			if ($tourn_settings->{"nsda_district"}) {

				<div class="row hover">
					<span class="half">
						District dates:
					</span>
<%perl>

					my $alert;

					if ($category) {
						$alert = " Changing the weekend of a judge category will also change ";
						$alert .= "the weekend of the ".scalar $category->events()." events in ";
						$alert .= "this category.  Events in one category must all be on the same ";
						$alert .= "weekend.  Are you sure?";
					}

</%perl>

					<span class="half centeralign">
						<select
							<& "/funclib/warn.mas", warning => $alert, change => 1 &>
							name  = "weekend"
							class = "fixedsmall"
						>
						<option value="nope">Not Held</option>
%						foreach my $weekend ($tourn->weekends) {
							<option
								value="<% $weekend->id %>"
								<% $weekend->id == $category_settings{"weekend"}
									? 'selected="selected"'
									: ""
								%>><% $weekend->name %></option>
%						}
						</select>
					</span>
				</div>
%			}

		</span>

		<span class="pagehalf">

			<h5>
				Burden method, pick one
			</h5>

%			if ($tourn_settings->{"nsda_nats"}) {

				<label for="nats_category">
					<div class="row hover">
						<span class="fivesixth">
							Main NSDA Nats Judge Category
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "nats_category",
								value   => $category_settings{"nats_category"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<label for="usa_wsdc">
					<div class="row hover">
						<span class="fivesixth">
							NSDA Nats Worlds Schools
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "usa_wsdc",
								value   => $category_settings{"usa_wsdc"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}


			<div class="row">
			    <span class="threefifths">
					Entries per judge owed
				</span>
				<span class="twofifth rightalign">
					<input
						type     = "number"
						step     = ".01"
						min      = 0
						max      = 99
						name     = "judge_per"
						id       = "judge_per"
						class    = "burdens"
						onChange = "checkBurdens(this)";
						value    = "<% $category_settings{"judge_per"} %>"
						size     = "4">
				</span>
			</div>

			<div class="row">

			    <span class="threefifths">
					Rounds owed per entry
				</span>
				<span class="twofifth rightalign">
					<input
						type     = "number"
						min      = 0
						max      = 99
						step     = ".01"
						name     = "rounds_per"
						id       = "rounds_per"
						class    = "burdens"
						onChange = "checkBurdens(this)";
						value    = "<% $category_settings{"rounds_per"} %>"
						size     = "4">
				</span>

			</div>

%			unless ($tourn_settings->{"nsda_district"}) {

				<div
					class = "row"
					title = "Not hires; per-head fee"
				>

					<span class="threefifths">
						Fee for a judge to attend:
					</span>

					<span class="twofifth rightalign">
						<input
							type  = "number"
							size  = "4"
							min   = "0"
							max   = "999"
							name  = "attending_judge_fee"
							value = "<% $category_settings{"attending_judge_fee"} %>"
						>
					</span>
				</div>
% 			}

			<div class="full <% $category_settings{"rounds_per"} ? "" : "hidden" %> custom_roundsper">

				<h5>Custom Round Obligations</h5>

				<p class="explain">
					Overrides the normal burden for specific entry numbers.
					Any number of entries not listed below will be obligated at
					the usual rate above.
				</p>

<%perl>
					my %customs =
						%{JSON::decode_json $category_settings{'custom_rounds_per'}}
						if $category_settings{'custom_rounds_per'};

					my @keys = sort keys %customs;
					my $limit = scalar @keys;
					$limit++;
					$limit = 5 if $limit < 5;

					foreach my $tick (1 .. $limit) {

						my $key = shift @keys if @keys;

</%perl>
						<div class="row">

							<span class="third">
								Entries:
							</span>

							<span class="sixth centeralign">
								<input
									type  = "number"
									name  = "entries_<% $tick %>"
									min   = "0"
									max   = "999"
									class = "smaller"
									value = "<% $key %>"
								>
							</span>

							<span class="third">
								Round Burden:
							</span>

							<span class="sixth centeralign">
								<input
									type  = "number"
									name  = "rounds_<% $tick %>"
									min   = "0"
									max   = "999"
									class = "smaller"
									value = "<% $key ? $customs{$key} : "" %>"
								>
							</span>

						</div>

%					}

			</div>

		</span>

		<span class="pagehalf">

			<h5>
				Alter burden
			</h5>

			<label for="drops_no_burden">
				<div class="row hover">
					<span class="fivesixth">
						Drops do not count against judge burden
					</span>
					<span class="sixth centeralign">
                        <& "/funclib/bool_switch.mas",
                            tag     => "drops_no_burden",
                            value   => $category_settings{"drops_no_burden"},
                            target  => $category,
                            smaller => 1,
                        &>
					</span>
				</div>
			</label>

%			if ($judge_per || $rounds_per) {

				<div class="row">
					<span
						class="threequarters"
						title="Not hires; will print a warning"
					>
						Fine per missing <% $judge_per ? "judge" : "round" %>
					</span>

					<span class="quarter centeralign">
						<input
							type  = "number"
							size  = "4"
							min   = "0"
							max   = "999"
							name  = "missing_judge_fee"
							value = "<% $category_settings{"missing_judge_fee"} %>"
						>
					</span>

				</div>

%			}

%			if ($category_settings{"rounds_per"}
%				|| $category_settings{"nats_category"}
%			) {

				<div class="row">
					<span class="threequarter">
						Maximum rounds for one judge:
					</span>
					<span class="quarter centeralign">
						<input
							type  = "number"
							min   = 0
							max   = 99
							name  = "max_rounds"
							value = "<% $category_settings{"max_rounds"} %>"
							size  = "4">
					</span>
				</div>
%			}

%			if ($category_settings{"rounds_per"}) {

				<label for="sections_per">
					<div class="row hover">
						<span class="fivesixth">
							Count obligation by debate flight, not round
						</span>
						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "sections_per",
								value   => $category_settings{"sections_per"},
								target  => $category,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<div class="row">
					<span class="threequarter">
						Free rounds: reduce total burden by
					</span>
					<span class="quarter centeralign">
						<input
							type  = "number"
							min   = -99
							max   = 99
							name  = "free"
							value = "<% $category_settings{"free"} %>"
							size  = "4">
					</span>
				</div>

				<div class="row">
					<span class="threequarter">
						Large entry threshold
					</span>
					<span class="quarter centeralign">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "commitment_bump_after"
							value = "<% $category_settings{"commitment_bump_after"} %>"
							size  = "4"
						>
					</span>
				</div>

				<div class="row">
					<span class="threequarters">
						Add rounds per entry above threshold
					</span>
					<span class="quarter centeralign">
						<input
							type  = "number"
							min   = -99
							max   = 99
							name  = "commitment_bump_unit"
							value = "<% $category_settings{"commitment_bump_unit"} %>"
							size  = "4"
						>
					</span>
				</div>

%			} elsif ($category_settings{"judge_per"}) {

				<div class="row">
					<span class="threequarters">
						Minimum judges owed
						<p class="explain marno padless">
							If a school has entries
						</p>
					</span>

					<span class="quarter centeralign">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "min_burden"
							value = "<% $category_settings{"min_burden"} %>"
							size  = "4"
						>
					</span>

				</div>

%				if ($tourn_settings->{"nsda_nats"}) {

					<div class="row">

						<span class="threequarters">
							Penalty fine for not meeting minimum
						</span>

						<span class="quarter centeralign">

							<input
								type  = "number"
								min   = 0
								max   = 99999
								name  = "min_burden_fine"
								value = "<% $category_settings{"min_burden_fine"} %>"
								size  = "8"
							>
						</span>

					</div>
%				}

				<div class="row">
					<span class="threequarters">
						Maximum judges a school can owe
					</span>
					<span class="quarter centeralign">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "max_burden"
							value = "<% $category_settings{"max_burden"} %>"
							size  = "4">
					</span>
				</div>

				<div class="row">
					<span class="threequarters">
						Free judges: reduce judge burden by
					</span>
					<span class="quarter centeralign">
						<input
							type  = "number"
							min   = -99
							max   = 99
							name  = "free"
							value = "<% $category_settings{"free"}  %>"
							size  = "4">
					</span>
				</div>

				<div class="row">

					<span class="threequarters smallish">
						Maximum number of judges that can <br />count for their alternate category
					</span>
					<span class="quarter centeralign">
						<input
							type  = "number"
							min   = 0
							max   = 999
							name  = "alt_max"
							value = "<% $category_settings{"alt_max"}  %>"
							size  = "4">
					</span>

				</div>

%			}

		</span>

        <div class="liblrow rightalign">
            <input
				type  = "submit"
				value = "Save Registration Settings">
		</div>

%	} else {

		<h2>Judge Categories</h2>

		<p>
			Add judge categories or edit judge category information.
		</p>

<%perl>

		Tab::Tourn->set_sql(other => "
			select tourn.*
			from tourn, category, category_setting
			where category_setting.value = ?
			and category_setting.tag = 'original_tourn'
			and category_setting.category = category.id
			and category.tourn = tourn.id
		");

		my $whered_they_go = Tab::Tourn->search_other($tourn->id)->first;

		if ($whered_they_go) {

			my @contacts = Tab::Permission->search(
				tourn => $whered_they_go->id,
				tag   => "contact"
			);

</%perl>
			<h3 class="martopmuchmore centeralign">
				Where's your data?!
			</h3>

			<h6 class="redtext centeralign">
				This tournament has been merged for tabbing!
			</h6>

			<p class="bigger semibold bluetext centeralign">
				Your data is in <% $whered_they_go->name %>
			</p>

			<p>
				To access rounds, results, and registration data you have to
				have admin access to that tournament.  If you do, leave this
				tournament (click your email address at top right) and enter
				the <% $whered_they_go->name %>.
			</p>

			<p>

				If you do not have access the other tournament, an admin of
				that tournament will have to grant you access.  The public
				contact info of that tournament is listed as:

			</p>

%			foreach my $contact (@contacts) {
				<a
					class="plain semibold bluetext centeralign martopmore"
					href="mailto:<% $contact->person->email %>"
				><% $contact->person->first." ".$contact->person->last.": ".$contact->person->email %></a>
%			}

%		}

%	}

	</div>

	<script>

		function checkBurdens(mememe) {

			var nonzero = 0;

			$(".burdens").each(function() {

				if ($(this).val()) {
					nonzero++;
				}

			});

			if (nonzero > 1) {

				$(".burdens").each(function() {
					if (this.id !== mememe.id) {
						$(this).val("");
					}
				});

				alertify.warning("You can only have one judge burden method, not both active at once");
			}

			if ($("#rounds_per").val()) {
				$(".custom_roundsper").removeClass("hidden");
			} else {
				$(".custom_roundsper").addClass("hidden");
			}

		};

	</script>
