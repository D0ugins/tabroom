<%args>
	$tourn
	$category_id           => 0
	$name                  => 0
	$abbr                  => 0
	$no_codes              => 0
	$show_names            => 0
	$code_start            => 0
	$field_report          => 0
	$judge_contacts        => 0
	$judge_cells           => 0
	$judge_quals           => 0
	$first_year_outs       => 0
	$show_judge_contacts   => 0
	$fyo_label             => 0
	$neutrals              => 0
	$double_entry          => 0
	$ask_alts              => 0
	$linked_only           => 0
	$drops_no_burden       => 0
	$judge_per             => 0
	$rounds_per            => 0
	$tab_room              => 0
	$ask_parli             => 0
	$dio_min               => 0
	$missing_judge_fee     => 0
	$attending_judge_fee   => 0
	$max_rounds            => 0
	$free                  => 0
	$commitment_bump_after => 0
	$commitment_bump_unit  => 0
	$min_burden            => 0
	$max_burden            => 0
	$alt_max               => 0
	$nats_category    => undef
	$weekend               => undef
</%args>
<%init>

	my $msg;
	my $category;

	if ($rounds_per > 0 && $judge_per > 0 && (not defined $nats_category)) { 

		my $err = "You must EITHER use number of entries per judge, OR number
		of rounds owed.  Both methods don\'t work together";

		$m->redirect("edit.mhtml?category_id=$category_id&err=$err");
	}

	if ($category_id) { 

		$category = Tab::Category->retrieve($category_id);
		$category->name($name);
		$category->abbr($abbr);
		$category->update();

		$msg = "$name judge category changes saved";

	} else { 

        $category = Tab::Category->create({
            tourn => $tourn->id,
            name => $name,
            abbr => $abbr,
        });

		$msg = "$name judge category created";

	}

	$max_rounds = 8 if $max_rounds < 1;

	$category->setting("no_codes", $no_codes);
	$category->setting("show_names", $show_names);
	$category->setting("code_start", $code_start);
	$category->setting("field_report", $field_report);
	$category->setting("judge_contacts", $judge_contacts);
	$category->setting("judge_cells", $judge_cells);
	$category->setting("judge_quals", $judge_quals);
	$category->setting("first_year_outs", $first_year_outs);
	$category->setting("show_judge_contacts", $show_judge_contacts);
	$category->setting("fyo_label", $fyo_label);
	$category->setting("neutrals", $neutrals);
	$category->setting("double_entry", $double_entry);
	$category->setting("ask_alts", $ask_alts);
	$category->setting("linked_only", $linked_only);
	$category->setting("drops_no_burden", $drops_no_burden);

	if ($weekend != $category->setting('weekend')) { 

		$category->setting("weekend", $weekend);

		foreach my $event ($category->events) {
			$event->setting("weekend", $weekend);
		}
	}

	$category->setting("commitment_bump_after", $commitment_bump_after);
	$category->setting("commitment_bump_unit", $commitment_bump_unit);

	if ($nats_category) { 

		$category->setting("judge_per", 0);
		$category->setting("hired_rounds", 0);
		$category->setting("round_hire_fee", 0);
		$category->setting("rounds_per", 0);
		$category->setting("judge_per", 0);
		$category->setting("hired_jpool", 0);
		$category->setting("hired_fee", 0);
		$category->setting("uncovered_entry_fee", 0);

		$category->setting("nats_category", 1);

	} elsif ($judge_per) { 

		$category->setting("judge_per", $judge_per);
		$category->setting("hired_rounds", 0);
		$category->setting("round_hire_fee", 0);
		$category->setting("rounds_per", 0);

	} else {

		$category->setting("rounds_per", $rounds_per);
		$category->setting("judge_per", 0);
		$category->setting("hired_jpool", 0);
		$category->setting("hired_fee", 0);
		$category->setting("uncovered_entry_fee", 0);


		my %customs = {};

		my @keys = keys %customs;
		my $limit = scalar @keys;
		$limit = 5 if $limit < 5;

		foreach my $tick (1 .. $limit) { 

			if ($ARGS{"entries_".$tick} && $ARGS{"rounds_".$tick}) { 
				$customs{$ARGS{"entries_".$tick}} = $ARGS{"rounds_".$tick};
			}
		}

		$category->setting("custom_rounds_per", "text", JSON::encode_json(\%customs));

	}

	$category->setting("tab_room", $tab_room);

	$category->setting("ask_parli", $ask_parli);
	$category->setting("dio_min", $dio_min);
	$category->setting("missing_judge_fee", $missing_judge_fee);
	$category->setting("attending_judge_fee", $attending_judge_fee);
	$category->setting("max_rounds", $max_rounds);
	$category->setting("free", $free);
	$category->setting("min_burden", $min_burden);
	$category->setting("max_burden", $max_burden);
	$category->setting("alt_max", $alt_max);

	$m->redirect("edit.mhtml?category_id=".$category->id."&msg=$msg");

</%init>
