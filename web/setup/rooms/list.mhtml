<%args>
	$tourn
	$site_id => undef
	$add     => undef
</%args>
<%init>

	my $site = Tab::Site->retrieve($site_id);

	my @rooms;

    my @all_sites = $tourn->sites;

    $site = shift @all_sites if @all_sites && not defined $site;
	$site_id = $site->id if $site && (not defined $site_id);

	if ($site) {

		@rooms = $site->rooms( deleted => 0);

		@rooms =
			map  { $_->[0] }
			sort { $a->[1] <=> $b->[1] }
			map  { [$_, $_->name=~/(\d+)/] }
			@rooms;

		@rooms =
			map  { $_->[0] }
			sort { uc($a->[1]) cmp uc($b->[1]) }
			map  { [$_, $_->name =~ /(\D+)/] }
			@rooms;

	}

</%init>

	<& menu.mas,
		tourn => $tourn,
		mysite => $site
	&>

	<div class="main">

%	if ($site && $site->id) {

		<h2>Rooms at <% $site->name %></h2>

		<& "tabbar.mas",
			site_id => $site_id,
			add     => $add
		&>

		<& "/funclib/tablesorter.mas",
			table     => "roomlist",
			nobuttons => 1
		&>

%		if (@rooms && not defined $add) {

			<form action="site_rooms_save.mhtml" method="post">

			<input
				type  = "hidden"
				name  = "site_id"
				value = "<% $site->id %>"
			>

			<table id="roomlist">

				<thead>

				<tr class="yellowrow">

					<th class="smaller">
					</th>

					<th class="smaller">
						Name
					</th>

					<th class="tiny">
						Quality
					</th>

					<th class="tiny">
						Capacity
					</th>

					<th class="smaller">
						Notes
					</th>

					<th
						title="The Boltizar Center for the Prevention of Lost Kids & Judges"
						class="smaller"
					>
						Map Link
					</th>

					<th class="tiny">
						Accessible
					</th>

					<th class="smaller">
						Active
					</th>

				</tr>

				</thead>
				<tbody>

% 				foreach my $room (@rooms) {

					<tr id="<% $room->id %>">

						<td class="centeralign">
							<a
								id             = "<% $room->id %>_delete"
								on_success     = "destroy"
								property_name  = "deleted"
								value          = "1"
								target_id      = "<% $room->id %>"
								onClick        = "postSwitch( this, 'room_switch.mhtml');"
								class          = "fa-sm padless fa fa-trash buttonwhite redtext"
							></a>
						</td>

						<td class="centeralign">

							<span class="hidden">
								<% $room->name %>
							</span>

							<input
								type  = "text"
								name  = "<% $room->id %>_name"
								value = '<% $room->name %>'
								size  = "20"
							>
						</td>

						<td class="centeralign">
							<span class="hidden"><% $room->quality %></span>
							<input
								type  = "number"
								class = "smaller"
								name  = "<% $room->id %>_quality"
								value = "<% ($room->quality) ? $room->quality : ""%>"
								size  = "3"
							>
						</td>

						<td class="centeralign">
							<span class="hidden"><% $room->capacity %></span>
							<input
								type  = "number"
								class = "smaller"
								name  = "<% $room->id %>_capacity"
								value = "<% ($room->capacity) ? $room->capacity : "" %>"
								size  = "3"
							>
						</td>

						<td class="centeralign">
							<span class="hidden"> <% $room->notes %> </span>
							<input
								type  = "text"
								name  = "<% $room->id %>_notes"
								value = "<% $room->notes %>"
							>
						</td>

						<td class="centeralign">
							<span class="hidden"> <% $room->url ? $room->url : 0 %> </span>
							<input
								type      = "url"
								name      = "<% $room->id %>_url"
								value     = "<% $room->url %>"
								maxlength = "255"
							>
						</td>
						<td class="centeralign">

							<span class="hidden"><% $room->ada %></span>

							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $room->id %>_ada"
									property_name = "ada"
									target_type   = "room"
									target_id     = "<% $room->id %>"
									onChange      = "postSwitch( this, 'room_switch.mhtml');"

									<% $room->ada ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>

						</td>

						<td class="centeralign">

							<span class="hidden"><% $room->inactive %></span>

							<label class="switch smaller">
								<input
									type          = "checkbox"
									value         = "1"
									id            = "<% $room->id %>_inactive"
									property_name = "inactive"
									target_type   = "room"
									target_id     = "<% $room->id %>"
									onChange      = "postSwitch( this, 'room_switch.mhtml');"

									<% $room->inactive ? "" : 'checked="checked"' %>
								>
								<div class="slider"></div>

							</label>
                	    </td>
					</tr>
%				}

				</tbody>

			</table>

			<div class="libl rightalign">
				<input
					type="submit"
					value="Save Room Changes"
				>
			</div>

			</form>

%		} else {

			<form action="site_rooms_add.mhtml" method="post">

			<input
				type  = "hidden"
				name  = "site_id"
				value = "<% $site->id %>"
			>

			<table id="roomlist">

				<thead>

					<tr class="yellowrow">

						<th class="smaller">
							Name
						</th>

						<th class="tiny">
							Quality
						</th>

						<th class="tiny">
							Capacity
						</th>

						<th class="smaller">
							Notes
						</th>

						<th class="smaller">
							Map URL
						</th>

						<th class="smaller">
							Accessible
						</th>
					</tr>

				</thead>

				<tbody>

%				foreach my $room (1 .. 10) {

					<tr>

						<td class="centeralign">
							<input
								type = "text"
								name = "new_<% $room %>_name"
								size = "20"
							>
						</td>

						<td class="centeralign">
							<input
								type="text"
								name="new_<% $room %>_quality"
								size="5"
							>
						</td>

						<td class="centeralign">
							<input
								type = "text"
								name = "new_<% $room %>_capacity"
								size = "5"
							>
						</td>

						<td class="centeralign">
							<input
								type = "text"
								name = "new_<% $room %>_notes"
								size = "24"
							>
						</td>

						<td class="centeralign">
							<input
								type      = "url"
								name      = "new_<% $room %>_url"
								size      = "32"
								maxlength = "255"
							>
						</td>

						<td class="centeralign nospace">

							<label for="new_<% $room %>_ada">
								<span class="padvertless full hover">
									<input
										type  = "checkbox"
										name  = "new_<% $room %>_ada"
										id    = "new_<% $room %>_ada"
										value = 1
									>
								</span>
							</label>
						</td>

					</tr>

%				}

				</tbody>

				<tr class="liblrow">
					<td colspan="6" class="rightalign">
						<input type="submit" value="Save New Rooms">
					</td>
				</tr>

			</table>
			</form>

%		}

%	} else {

		<h2>Rooms for <% $tourn->name %></h2>
%	}

	</div>
