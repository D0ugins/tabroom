<%args>
	$tourn
	$site_id => undef
</%args>
<%init>

	my $site = Tab::Site->retrieve($site_id) if $site_id;

	unless ($site) {
		$m->comp("/funclib/abort.mas",
			message => "No site found for site $site_id"
		);
	}

	my $err;

	foreach my $room ($site->rooms) {

		my $name = $ARGS{$room->id."_name"};
		$name =~ s/\s+$//;
		$name =~ s/^\s+//;
		$name =~ s/\"//g;
		$name =~ s/\'//g;


		my $taken = Tab::Room->search(
			name => $name,
			site => $site_id
		)->first;

		if ($taken && $taken->deleted) {

			$taken->deleted(0);
			$taken->update();
			next;

		} elsif ($taken && $taken->id != $room->id) {
			next;
		}

		if ($name) {
			$room->name($name);
		} else {
			$room->deleted(1);
		}

		my $url = $ARGS{$room->id."_url"};
		$url =~ s/\s+$//;
		$url =~ s/^\s+//;

		$room->quality($ARGS{$room->id."_quality"});
		$room->capacity($ARGS{$room->id."_capacity"});
		$room->notes($ARGS{$room->id."_notes"});
		$room->url($url);

		$room->password($ARGS{$room->id."_password"});
		$room->judge_password($ARGS{$room->id."_judge_password"});

		$room->update();
	}

	$m->redirect("/setup/rooms/list.mhtml?site_id=$site_id&err=$err");

</%init>
