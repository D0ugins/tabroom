<%args>
	$person
	$set_id
	$tourn
	$tag
	$points          => undef
	$place           => 0
	$count           => "all"
	$tiebreak_set_id => undef
</%args>
<%init>

	if ($points
		|| $tag eq "manual"
		|| $tag eq "nsda_place"
		|| $tag eq "nsda_rounds"
		|| $tag eq "rev_overall"
		|| $tag eq "rev_overall_base"
	) {

		my $err;

		if ($tiebreak_set_id) {
			my $tiebreak_set = Tab::TiebreakSet->retrieve($tiebreak_set_id);

			if ($tiebreak_set->tourn != $tourn) {
				my $actual = $tourn->tiebreak_sets(name => $tiebreak_set->name);
				undef $tiebreak_set;
				$tiebreak_set = $actual if $actual;
			}

			unless ($tiebreak_set) {
				$err = "Warning: Tiebreak set linked to was not in your tournament and none with the same name could be found.";
			}
		}

		my $count_round;

		if ($tag eq "points_per" && $count eq "specific") {
			$count_round = $ARGS{'count_round'};

			unless ($count_round) {
				$m->comp('/funclib/abort.mas', message => "You must select a specific round number for that to work");
			}
		}

		Tab::SweepRule->create({
			tag          => $tag,
			value        => $points,
			sweep_set    => $set_id,
			place        => $place,
			count        => $count,
			count_round  => $count_round,
			tiebreak_set => $tiebreak_set_id
		});

		my $msg = "Sweepstakes rule $set_id created for $tag in $count rounds, place $place points $points";

		my $now = DateTime->now();

		Tab::ChangeLog->create({
			type        => 'tabbing',
			tourn       => $tourn->id,
			person      => $person->id,
			description => $msg,
			created     => $now
		});

		$m->redirect("sweeps.mhtml?set_id=$set_id&msg=$msg&err=$err")

	} else {

		my $err = "You cannot create a sweepstakes rule without points";
		$m->redirect("sweeps.mhtml?set_id=$set_id&err=$err")

	}

</%init>
