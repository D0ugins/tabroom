<%args>
	$tourn
	$tourn_settings
	$set_id => undef
</%args>
<%init>

	my (%cume_settings) = $m->comp(
		"/funclib/tourn_cume_sweeps.mas",
		tourn => $tourn
	);

	my (%place_settings) = $m->comp(
		"/funclib/tourn_place_sweeps.mas",
		tourn => $tourn
	);

    my $numero = keys %cume_settings;

</%init>

	<div class="main">

		<h2>Team Awards &amp; Bids</h2>

		<&
			"tabbar.mas",
			tourn  => $tourn,
			whoami => "sweeps"
		&>

%		my $set;
%		$set = Tab::SweepSet->retrieve($set_id) if $set_id;

%		if ($set) {

			<span class="half nospace">
				<h5>Setup</h5>
			</span>

			<span class="half rightalign nospace">
				<a
					class="redtext buttonwhite invert"
					<&
						"/funclib/confirm.mas",
						warn => "Deleting this set. Are you sure?"
					&>
					href="sweep_set_delete.mhtml?set_id=<% $set_id %>"
				>Delete Ruleset <% $set->name %></a>
			</span>

			<form
				action="sweep_set_save.mhtml"
				method="post"
			>

			<input
				type  = "hidden"
				name  = "set_id"
				value = "<% $set->id %>"
			>

			<div class="full nospace">

				<span class="pagehalf padno">

					<div class="row">
						<span class="third semibold bluetext">
							Name of ruleset
						</span>

						<span class="twothirds rightalign">
							<input
								type  = "text"
								name  = "name"
								value = "<% $set->name %>"
								size  = "32"
							>
						</span>
					</div>

					<div class="row">

						<span class="fourfifths">
							Entries counted across all events
						</span>

						<span class="fifth">
							<input
								type  = "number"
								min   = "0"
								max   = "999"
								size  = "4"
								name  = "entries"
								value = "<% $set->rule("entries") %>"
								class = "thin smaller"
							>
						</span>
					</div>

					<div class="row">

						<span class="fourfifths">
							Entries counted per event
						</span>

						<span class="fifth">
							<input
								type  = "number"
								min   = "0"
								max   = "999"
								class = "thin smaller"
								size  = "4"
								name  = "event_entries"
								value = "<% $set->rule("event_entries") %>"
							>
						</span>

					</div>

					<div class="row">

						<span class="fourfifths">
							Number of events to count
						</span>

						<span class="fifth">
							<input
								type  = "number"
								min   = "0"
								max   = "999"
								size  = "4"
								class = "smaller thin smaller"
								name  = "events"
								value = "<% $set->rule("events") %>"
							>
						</span>
					</div>

					<div class="row">
						<span class="fourfifths">
							Wildcards (entries counted beyond limits)
						</span>

						<span class="fifth">
							<input
								type  = "number"
								min   = "0"
								max   = "999"
								class = "thin smaller"
								size  = "4"
								name  = "wildcards"
								value = "<% $set->rule("wildcards") %>"
							>
						</span>
					</div>
				</span>

				<span class="pagehalf padno marleft">
					<div class="row">
						<span class="fourfifths">
							Number of schools to print on reports
						</span>

						<span class="fifth">
							<input
								type  = "number"
								min   = "0"
								max   = "999"
								class = "thin smaller"
								size  = "4"
								name  = "print_limit"
								value = "<% $set->rule("print_limit") %>"
							>
						</span>
					</div>

					<label for="novice_only">
						<div class="row hover">
							<span class="fourfifths">
								Only count entries marked novice
							</span>

							<span class="fifth centeralign">
								<input
									type  = "checkbox"
									id    = "novice_only"
									class = "largecheck"
									name  = "novice_only"
									value = "1"
									<% $set->rule("novice_only") ? 'checked="checked"' : "" %>
								>
							</span>
						</div>
					</label>

					<label for="by_person">
						<div
							class="row hover"
							title="Count only 1 entry per competitor"
						>
							<span class="fourfifths">
								Points by individual competitor, not by entry
							</span>

							<span class="fifth centeralign">
								<input
									type  = "checkbox"
									id    = "by_person"
									class = "largecheck"
									name  = "by_person"
									value = "1"
									<% $set->rule("by_person") ? 'checked="checked"' : "" %>
								>
							</span>
						</div>
					</label>

					<label for="one_per_person">
						<div
							class="row hover"
							title="Count only 1 entry per competitor"
						>
							<span class="fourfifths">
								Count only 1 entry per individual competitor
							</span>

							<span class="fifth centeralign">
								<input
									type  = "checkbox"
									id    = "one_per_person"
									class = "largecheck"
									name  = "one_per_person"
									value = "1"
									<% $set->rule("one_per_person") ? 'checked="checked"' : "" %>
								>
							</span>
						</div>
					</label>

					<div
						class="row"
						title="In sweeps by person, this limits how many people can claim points for an entry"
					>
						<span class="fourfifths">
							Maximum competitors an entry counts for
						</span>

						<span class="fifth">
							<input
								type  = "number"
								min   = "0"
								max   = "999"
								size  = "4"
								class = "smaller thin"
								name  = "max_entry_persons"
								value = "<% $set->rule("max_entry_persons") %>"
							>
						</span>
					</div>
				</span>

				<div class="libl pagefull row rightalign">
					<span class="third centeralign">
						<input
							type  = "submit"
							value = "Save Rules"
						>
					</span>
				</div>
			</div>

			</form>

			<div class="full nospace martopmore">
				<span class="third nospace">
					<h5>Scope</h5>
				</span>
				<span class="twothirds rightalign semibold italic redtext nospace martop">
					Click on a event, round or ruleset to remove it from the scope of this ruleset.
				</span>
			</div>

			<div class="full row marvertno padless">

				<span class="quarter semibold bluetext biggish">
					Events Counted
				</span>

				<span id = "events_list" class="half marno padless">
<%perl>
					my $dbh = Tab::DBI->db_Main();

					my $sth = $dbh->prepare("
						delete sweep_event.*
						from sweep_event, event
						where sweep_event.sweep_set = ?
							and sweep_event.event = event.id
							and event.tourn != ?
					");

					$sth->execute($set->id, $tourn->id);

					$sth = $dbh->prepare("
						select event.id, event.abbr, event.name
						from event, sweep_event
						where sweep_event.sweep_set = ?
							and sweep_event.event = event.id
						group by event.id
					");

					$sth->execute($set->id);
					my $event_ref = $sth->fetchall_hash();
					my %events = convert($event_ref);

					$sth->finish();

					foreach my $event_id (
						sort {
							$events{$a}{"abbr"} cmp $events{$b}{"abbr"}
							|| $events{$a}{"name"} cmp $events{$b}{"name"}
						} keys %events
					) {
</%perl>
						<span
							class         = "hover eighth padvert centeralign semibold bluetext nowrap"
							id            = "event_<% $event_id %>"
							target_id     = "<% $event_id %>"
							property_name = "event"
							related_thing = '<% $set_id %>'
							onClick       = "postSwitch(this, 'sweep_rm.mhtml');"
						>
							<% $events{$event_id}{"abbr"}
								? $events{$event_id}{"abbr"}
								: $events{$event_id}{"name"}
							%>
						</span>
%					}

				</span>

<%perl>
				my @types;
				my @events = sort {$a->type cmp $b->type || $a->abbr cmp $b->abbr} $tourn->events;

				foreach my $event (@events) {
					push @types, $event->type;
				}

</%perl>
				<span class="quarter centeralign nospace">

					<select
						name          = "event_id"
						class         = "fixedmed"
						target_id     = "<% $set->id %>"
						property_name = "event"
						related_thing = '<% $set_id %>'
						reply_append  = "events_list"
						onchange      = "postSwitch(this, 'sweep_add.mhtml')"
					>
						<option value="">Select to add</option>
						<option value="all">All</option>

%						foreach my $type (sort {$a cmp $b} @types) {
							<option value="<% $type %>"><% ucfirst($type) %> events</option>
%						}

<%perl>
						foreach my $event (@events) {
							next if $events{$event->id};
</%perl>
							<option
								id   ="event_<% $event %>_selector"
								value="<% $event->id %>"
							><% $event->abbr %></option>
%						}
					</select>
				</span>
			</div>

<%perl>
			$sth = $dbh->prepare("
				select
					sweep_set.id, sweep_set.name
				from sweep_set
				where sweep_set.tourn = ?
				and sweep_set.id != ?
			");

			$sth->execute($tourn->id, $set->id);
			my $other_ref = $sth->fetchall_hash();
			my %others = convert($other_ref);

			$sth->finish();

			if (%others) {

				$sth = $dbh->prepare("
					select
						child.id, child.name
					from sweep_set parent, sweep_set child, sweep_include
					where parent.id = ?
						and parent.id = sweep_include.parent
						and child.id = sweep_include.child
					group by child.id
				");

				$sth->execute($set->id);
				my $childrenref = $sth->fetchall_hash();
				my %children = convert($childrenref);
				$sth->finish();

</%perl>
				<div class="full row marvertno padless">

					<span class = "redtext semibold quarter" >
						Included Rule Sets
					</span>

					<span
						class = "half marno padless"
						id    = "children"
					>
<%perl>
						foreach my $child_id (
							sort {
								$children{$a}{"name"} cmp $children{$b}{"name"}
							} keys %children
						) {
</%perl>
							<span
								class         = "hover third padvert semibold bluetext nowrap"
								id            = "child_<% $child_id %>"
								target_id     = "<% $child_id %>"
								property_name = "child"
								related_thing = '<% $set_id %>'
								onClick       = "postSwitch(this, 'sweep_rm.mhtml');"
							>
								<% $children{$child_id}{"name"} %>
							</span>
%						}
					</span>

					<span class="quarter centeralign nospace">
						<select
							name          = "child_id"
							class         = "fixedmed"
							target_id     = "<% $set->id %>"
							property_name = "child"
							related_thing = '<% $set_id %>'
							reply_append  = "children"
							onChange      = "postSwitch(this, 'sweep_add.mhtml')"
						>
								<option value="">Select to add</option>
<%perl>
								foreach my $set_id (
									sort {$others{$a}{"name"} cmp $others{$b}{"name"}}
									keys %others
								) {
									next if $children{$set_id};
</%perl>
									<option
										id   ="child_<% $set_id %>_selector"
										value="<% $set_id %>"
									><% $others{$set_id}{"name"} %></option>
%								}
							</select>
						</span>
					</span>
				</div>
%			}

			<div class="full row marvertno padless">

				<span class="quarter semibold bluetext">
					Rounds not counted
				</span>

				<span
					class = "half marno padless"
					id    = "excludeds"
				>
<%perl>
					$sth = $dbh->prepare("
						select
							round.id, round.name, round.label,
							event.id eventid, event.abbr eventabbr, event.name eventname
						from event, sweep_event, round
						where sweep_event.sweep_set = ?
						and sweep_event.event = event.id
						and event.id = round.event
						group by round.id
					");

					$sth->execute($set->id);
					my $round_ref = $sth->fetchall_hash();
					my %rounds = convert($round_ref);

					$sth->finish();

					$sth = $dbh->prepare("
						select
							round.id, round.name, round.label,
							event.id eventid, event.abbr eventabbr, event.name eventname
						from round, event, sweep_rule
						where sweep_rule.sweep_set = ?
							and sweep_rule.tag = 'ignore_round'
							and sweep_rule.value = round.id
							and round.event = event.id
						group by round.id
						order by event.abbr, round.name
					");

					$sth->execute($set->id);

					my $exclude_ref = $sth->fetchall_hash();
					my %excludes = convert($exclude_ref);
					$sth->finish();

					$dbh->disconnect();

					foreach my $round_id (
						sort {
							$excludes{$a}{"eventabbr"} cmp $excludes{$b}{"eventabbr"}
							|| $excludes{$a}{"name"} cmp $excludes{$b}{"name"}
						} keys %excludes
					) {
</%perl>

						<span
							class         = "yellowhover sixth padvert centeralign semibold redtext nowrap"
							id            = "round_<% $round_id %>"
							target_id     = "<% $round_id %>"
							property_name = "round"
							related_thing = '<% $set_id %>'
							onClick       = "postSwitch(this, 'sweep_rm.mhtml');"
						>
							<%
								$excludes{$round_id}{"eventabbr"}
								? $excludes{$round_id}{"eventabbr"}
								: substr($excludes{$round_id}{"eventname"}, 0, 4)
							%>-<%
								$excludes{$round_id}{"label"}
								? $excludes{$round_id}{"label"}
								: "Rd ".$excludes{$round_id}{"name"}
							%>
						</span>
%					}
				</span>

				<span class="quarter centeralign nospace">
					<select
						name          = "round_id"
						class         = "fixedmed"
						target_id     = "<% $set->id %>"
						property_name = "round"
						related_thing = '<% $set_id %>'
						reply_append  = "excludeds"
						onChange      = "postSwitch(this, 'sweep_add.mhtml')"
					>

						<option value="">Select to add</option>
<%perl>
						my $last_event;

						foreach my $round_id (
							sort {
								$rounds{$a}{eventabbr} cmp $rounds{$b}{eventabbr}
								|| $rounds{$a}{name} <=> $rounds{$b}{name}
							} keys %rounds
						) {

							next if $excludes{$round_id};

							if ($last_event ne $rounds{$round_id}{"eventid"}) {
								$m->print('<optgroup label="'.$rounds{$round_id}{"eventname"}.'">');
								$last_event = $rounds{$round_id}{"eventid"};
							}
</%perl>
							<option
								id   ="round_<% $rounds{$round_id}{"id"} %>_selector"
								value="<% $rounds{$round_id}{"id"} %>"
							><%
								$rounds{$round_id}{"label"}
								? $rounds{$round_id}{"label"}
								: "Round ".$rounds{$round_id}{"name"}
							%></option>
%						}
					</select>
				</span>
			</div>

%			if ($set->rules) {

				<h5>Rules in set</h5>
%			}

%			my $counter = 1;

			<table>
<%perl>

				foreach my $rule (sort {$a->id <=> $b->id}  $set->rules) {

					my $tag = $rule->tag;

					next if $tag eq "novice_only";
					next if $tag eq "one_per_person";
					next if $tag eq "by_person";
					next if $tag eq "events";
					next if $tag eq "entries";
					next if $tag eq "event_entries";
					next if $tag eq "wildcards";
					next if $tag eq "print_limit";
					next if $tag eq "ignore_round";
					next if $tag eq "max_entry_persons";

					my $index = index($tag, 'rev_');
					my $count = $rule->count;

</%perl>
					<tr class="row">

						<td>
							<% $counter++ %>.
						</td>

						<td class="smallish">
%							if ($rule->value && $index != 0 ) {
								<% $rule->value %> point<% $rule->value == 1 ? "" : "s" %> for
%							}
						</td>

						<td class="smallish">

							<% $tag eq "points_per"
								? "Appearance "
								: ""
							%>

							<% $tag eq "points_per_po_round"
								? "Elected PO "
								: ""
							%>

							<% $tag eq "rev_per_rank"
								? "6 minus each rank in"
								: ""
							%>

							<% $tag eq "points_per_composite_rank"
								? "Points per composite rank in"
								: ""
							%>

							<% $tag eq "rev_overall" && $rule->tiebreak_set
								? "Size of field minus overall rank based on ".$rule->tiebreak_set->name
								: ""
							%>

							<% $tag eq "rev_overall_base" && $rule->tiebreak_set
								? $rule->place." minus overall rank based on ".$rule->tiebreak_set->name
								: ""
							%>

							<% $tag eq "rev_overall" && (not defined $rule->tiebreak_set)
								? "INVALID SCORE: Size of field rule: no basis for determining rank set"
								: ""
							%>

							<% ($tag eq "rev_overall" || $tag eq "rev_overall_base") && $rule->value
								? ", multiplied by ".$rule->value
							 	: ""
							%>

							<% $tag eq "rev_composite"
								? "6 minus each composite rank from ".$rule->tiebreak_set->name
								: ""
							%>

							<% $tag eq "rev_per_rank_sansworst"
								? "6 minus each rank, dropping the worst"
								: ""
							%>

							<% $tag eq "points_per_rank"
								? Lingua::EN::Numbers::Ordinate::ordinate($rule->place)." rank in prelim"
								: ""
							%>

							<% $tag eq "rev_per_place"
								? "6 minus placement in "
								: ""
							%>

							<% $tag eq "rev_per_round_place"
								? "6 minus round placement in "
								: ""
							%>

							<% $tag eq "rev_per_overall_place"
								? "6 minus placement overall"
								: ""
							%>

							<% $tag eq "debate_win"
								? "Ballot won (debate)"
								: ""
							%>

							<% $tag eq "debate_loss"
								? "Ballot lost (debate)"
								: ""
							%>

							<% $tag eq "debate_round_win"
								? "Debate round won"
								: ""
							%>

							<% $tag eq "debate_round_loss"
								? "Debate round lost"
								: ""
							%>

							<% $tag eq "debate_round_bye"
								? "Debate round bye"
								: ""
							%>

							<% $tag eq "place"
								? Lingua::EN::Numbers::Ordinate::ordinate($rule->place)." place overall"
								: ""
							%>
							<% $tag eq "place_above"
								? Lingua::EN::Numbers::Ordinate::ordinate($rule->place)." place or better"
								: ""
							%>

							<% $tag eq "cume"
								? "Prelim cumulative ranks of ".$rule->place
								: ""
							%>

							<% $tag eq "cumulative"
								? "Past points for the ".ucfirst($rule->value)." award"
								: ""
							%>

							<% $tag eq "prelim_seed"
								? "Prelim seed better than ".$rule->place
								: ""
							%>

							<% $tag eq "percentage"
								? "Placement in the top ".$rule->place."% based on ".$rule->tiebreak_set->name
								: ""
							%>

							<% $tag eq "manual"
								? "Count manually-entered sweeps points (under Tabulation)"
								: ""
							%>

							<% $tag eq "troll"
								? "Never gonna give you up, never gonna let you down"
								: ""
							%>

							<% $tag eq "troll2"
								? "Never gonna run around and desert you"
								: ""
							%>

							<% $tag eq "nsda_place"
								? "NSDA District Placement Points"
								: ""
							%>

<%perl>

							my $count_string;

							if ($count eq "specific") {
								$count_string = "in Round #".$rule->count_round;
							} elsif ($count eq "last_prelim") {
								$count_string = "in the last prelim round";
							} elsif ($count eq "all") {
								$count_string = "in the tournament";
							} else {
								$count_string = "in any ".ucfirst($count)." round";
							}
</%perl>

							<% $count_string %>

						</td>

						<td class="centeralign">
							<a
								class = "redtext fa fa-trash fa-sm hover buttonwhite"
								href  = "sweep_rule_rm.mhtml?rule_id=<% $rule->id %>">
							</a>
						</td>

					</tr>
%				}

			</table>

			<h4>
				Add new rule:
			</h4>

%			if ($tourn_settings->{"nsda_district"}) {

				<form action="sweep_rule_save.mhtml">

				<input
					type    = "hidden"
					name    = "set_id"
					value   = "<% $set->id %>"
				>

				<input
					type  = "hidden"
					name  = "tag"
					value = "nsda_place"
				>

				<div class="row">
					<span class="half">
						NSDA Placement Points
					</span>

					<span class="half rightalign">
						<input
							type="submit"
							class="thin"
						>
					</span>
				</div>
				</form>
%			}

			<h6 class="semibold bluetext">Seeding or Placement</h6>

			<table>

				<tr>
					<td colspan="4" class="nospace">
					</td>
				</tr>

				<tr class="row">

					<td class="smallish">
						<form action="sweep_rule_save.mhtml">
						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "points_per"
						>

						Points Per Round Participated In

					</td>

					<td class="nospace centeralign">

						<script>

							function showRound() {
								if ($("#per_round_selector").val() === "specific") {
									$("#per_round").removeClass('hidden');
								} else {
									$("#per_round").addClass('hidden');
								}
							};

							$(document).ready(function() {
								showRound();
							});

						</script>

						<span class="quarter smallish">
							Type:
						</span>

						<span class="threequarters">
							<select
								name     = "count"
								class    = "fixedmed"
								id       = "per_round_selector"
								onChange = "showRound();"
							>
								<option value="all">All</option>
								<option value="prelim">Prelims</option>
								<option value="elim">Elims</option>
								<option value="final">Finals</option>
								<option value="specific">Specific Round</option>
							</select>

						</span>

						<div id="per_round" class="full nospace hidden">

							<span class="quarter smallish">
								Round #:
							</span>

							<span class="threequarters">
								<input
									type  = "number"
									class = "marno"
									name  = "count_round"
									size  = "5"
									min   = "1"
									step  = "1"
									max   = "99"
								>
							</span>
						</div>

					</td>

					<td class="smallish">
						Points:
						<input
							type = "number"
							name = "points"
							size = "5"
							min  = "1"
							step = ".1"
							max  = "999"
						>
					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>
				</tr>

				<tr class="row">
					<td class="smallish">
						Give points for prelim cumulative score
						<form action="sweep_rule_save.mhtml">

						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "cume"
						>

					</td>

					<td class="smallish">
						<span class="fifth">
							Score:
						</span>
						<span class="fourfifths">

						<input
							type = "number"
							name = "place"
							max  = "999"
							min  = "1"
							size = "5"
						>
					</td>

					<td class="smallish">
						<span class="fifth">
							Points:
						</span>
						<span class="fourfifths">
						<input
							type = "number"
							name = "points"
							max  = "999"
							min  = "1"
							step = ".1"
							size = "5"
						>
					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>

				</tr>

				<tr class="row">

					<td class="smallish">

						Points for prelim seed rank equal or better than:

						<form action="sweep_rule_save.mhtml">

						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "prelim_seed"
						>

					</td>

					<td class="smallish">

						<span class="fifth">
							Seed:
						</span>

						<span class="fourfifths">

						<input
							type = "number"
							name = "place"
							max  = "999"
							min  = "1"
							size = "5"
						>
					</td>

					<td class="smallish">

						<span class="fifth">
							Points:
						</span>

						<span class="fourfifths">
						<input
							type = "number"
							name = "points"
							max  = "999"
							min  = "1"
							step = ".1"
							size = "5"
						>
					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>

				</tr>

				<tr class="row">

					<td class="smallish">
						Give points for final overall placement
						<form action="sweep_rule_save.mhtml">

						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "place"
						>

					</td>

					<td class="smallish">
						<span class="fifth">
							Place:
						</span>
						<span class="fourfifths">
						<input
							type = "number"
							name = "place"
							max  = "999"
							min  = "1"
							size = "5"
						>
					</td>

					<td class="smallish">
						<span class="fifth">
							Points:
						</span>
						<span class="fourfifths">
						<input
							type = "number"
							name = "points"
							max  = "999"
							min  = "1"
							step = ".1"
							size = "5"
						>
					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>

				</tr>

				<tr class="row">

					<td class="smallish">
						Give points for final placement on or above
						<form action="sweep_rule_save.mhtml">

						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "place_above"
						>

					</td>

					<td class="smallish">
						<span class="fifth">
							Place:
						</span>
						<span class="fourfifths">
						<input
							type = "number"
							name = "place"
							max  = "999"
							min  = "1"
							size = "5"
						>
					</td>

					<td class="smallish">
						<span class="fifth">
							Points:
						</span>
						<span class="fourfifths">
						<input
							type = "number"
							name = "points"
							max  = "999"
							min  = "1"
							step = ".1"
							size = "5"
						>
					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>
				</tr>

			<tr class="row">
				<td class="smallish">

					Give points for percentage placement

					<form action="sweep_rule_save.mhtml">

					<input
						type  = "hidden"
						name  = "set_id"
						value = "<% $set->id %>"
					>

					<input
						type  = "hidden"
						name  = "tag"
						value = "percentage"
					>
				</td>

				<td class="nospace">
					<span class="half nospace">
						<span class="third rightalign marno">
							Top
						</span>

						<span class="fourfifths marno">
							<input
								type  = "number"
								class = "thinner"
								name  = "place"
								min   = "1"
								max   = "99"
								step  = "1"
								size  = "3"
								placeholder = "1-99%"
							>
						</span>
					</span>

					<span class="half marno">
						<div class="full nospace">

							<span class="third marno">
								Basis
							</span>

							<span class="fourfifths marno">

								<select
									name  = "tiebreak_set_id"
									class = "fixedtiny plain"
								>
%										foreach my $tb_set ($tourn->tiebreak_sets) {
											<option
												value="<% $tb_set->id %>"
											><% $tb_set->name %></option>
%										}
								</select>
							</span>
						</div>

						<div class="full nospace">
							<span class="third marno">
								As of
							</span>

							<span class="fourfifths marno">
								<select name="count"
									class="fixedtiny plain"
								>
									<option value="all">All</option>
									<option value="last_prelim">Last Prelim</option>
									<option value="prelim">Each Prelim</option>
									<option value="elim">Each Elim</option>
									<option value="final">Finals</option>
								</select>
							</span>
						</div>

						</span>
					</td>

					<td class="smallish">

						<span class="fifth">
							Points:
						</span>

						<span class="fourfifths">
							<input
								type = "number"
								name = "points"
								max  = "999"
								step = ".1"
								min  = "1"
								size = "5"
							>
						</span>

					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>

				</tr>

				<tr class="row">

					<td class="smallish">
						<form action="sweep_rule_save.mhtml">
						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "points_per_po_round"
						>

						Points Per Round Elected Presiding Officer

					</td>

					<td class="smallish">

						<span class="fifth">
							In:
						</span>

						<span class="fourfifths">

							<select name="count"
								class="fixedsmall plain"
							>
								<option value="all">All</option>
								<option value="prelim">Prelims</option>
								<option value="elim">Elims</option>
								<option value="final">Finals</option>
							</select>

						</span>

					</td>

					<td class="smallish">

						Points:

						<input
							type = "number"
							name = "points"
							size = "5"
							min  = "1"
							step = ".1"
							max  = "999"
							size = "5"
						>

					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>
				</tr>

				<tr class="row">
					<td class="smallish">
						<form action="sweep_rule_save.mhtml">

						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "rev_overall"
						>
							Size of field minus final overall place
					</td>

					<td class="centeralign nospace">
						<span class="quarter">
							Basis:
						</span>

						<span class="threequarters">
							<select
								name  = "tiebreak_set_id"
								class = "fixedmed"
							>
%								foreach my $tb_set ($tourn->tiebreak_sets) {
									<option
										value="<% $tb_set->id %>"
									><% $tb_set->name %></option>
%								}
							</select>
						</span>

					</td>

					<td class="smallish">
						<span class="threefifths">
							Multiplied by
						</span>

						<span class="twofifths">
							<input
								type  = "number"
								name  = "points"
								class = "smallish"
								min   = "0"
								max   = "999"
								step = .01
							>
						</span>
					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>
				</tr>

				<tr class="row">
					<td class="smallish">
						<form action="sweep_rule_save.mhtml">

						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "rev_overall_base"
						>
							Baseline score minus final overall rank
					</td>

					<td class="centeralign nospace">

						<span class="twofifths nospace">

							<span class="quarter rightalign marno">
								Baseline
							</span>

							<span class="threequarters marno">
								<input
									type = "number"
									name = "place"
									max  = "999"
									min  = "1"
									size = "5"
								>
							</span>
						</span>

						<span class="threefifths nospace">

							<span class="quarter">
								Basis
							</span>

							<span class="threequarters">
								<select
									name  = "tiebreak_set_id"
									class = "fixedsmall"
								>
%										foreach my $tb_set ($tourn->tiebreak_sets) {
										<option
											value="<% $tb_set->id %>"
										><% $tb_set->name %></option>
%										}
								</select>
							</span>

						</span>
					</td>

					<td class="smallish">

						<span class="threefifths">
							Multiplied by
						</span>

						<span class="twofifths">
							<input
								type  = "number"
								name  = "points"
								class = "smallish"
								min   = "0"
								max   = "999"
								step = .01
							>
						</span>

					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add"
						>
						</form>
					</td>

				</tr>


				<tr>
					<td colspan="4" class="nospace">
						<h6 class="semibold bluetext">IE Ranks</h6>
					</td>
				</tr>

					<tr class="row">

						<td class="smallish">
							<form action="sweep_rule_save.mhtml">
							<input
								type  = "hidden"
								name  = "set_id"
								value = "<% $set->id %>"
							>

							<input
								type  = "hidden"
								name  = "points"
								value = "1"
							>
							Count reverse points (6-rank) for
						</td>

						<td class="centeralign">
							<select name="tag" class="fixedmed">

								<option value="rev_per_rank">Each Rank</option>
								<option value="rev_per_rank_sansworst">Each Rank, drop worst</option>
								<option value="rev_per_round_place">Placement in Rounds</option>
								<option value="rev_per_overall_place">Placement Overall</option>

							</select>
						</td>

						<td class="smallish">

							<span class="third">
								Count
							</span>

							<span class="fourfifths">
								<select name="count" class="fixedtiny plain">
									<option value="all">All</option>
									<option value="prelim">Prelim</option>
									<option value="elim">Elim</option>
									<option value="final">Final</option>
								</select>
							</span>

						</td>

						<td class="centeralign">
							<input
								type  = "submit"
								class = "thin"
								value = "Add"
							>
							</form>
						</td>

					</tr>

					<tr class="row">

						<td class="smallish">

							<form action="sweep_rule_save.mhtml">

							<input
								type  = "hidden"
								name  = "set_id"
								value = "<% $set->id %>"
							>

							<input
								type  = "hidden"
								name  = "points"
								value = "1"
							>

							<input
								type  = "hidden"
								name  = "tag"
								value = "rev_composite"
							>
							Count reverse composite ranks
						</td>

						<td class="centeralign nospace">

							<span class="quarter">
								Basis:
							</span>

							<span class="threequarters">
								<select
									name="tiebreak_set_id"
									class="fixedmed"
								>
%									foreach my $tb_set ($tourn->tiebreak_sets) {
										<option
											value="<% $tb_set->id %>"
										><% $tb_set->name %></option>
%									}
								</select>
							</span>

						</td>

						<td class="smallish">

							<span class="third">
								Count
							</span>

							<span class="fourfifths">

								<select
									name  = "count"
									class = "fixedtiny plain"
								>
									<option value = "all">All</option>
									<option value = "prelim">Prelims</option>
									<option value = "elim">Elims</option>
									<option value = "final">Final</option>
								</select>

							</span>

						</td>

						<td class="centeralign">
							<input
								type  = "submit"
								class = "thin"
								value = "Add"
							>
							</form>
						</td>

					</tr>

					<tr class="row">

						<td class="smallish">

							Give points for individual rank

							<form action="sweep_rule_save.mhtml">

							<input
								type  = "hidden"
								name  = "set_id"
								value = "<% $set->id %>"
							>

							<input
								type  = "hidden"
								name  = "tag"
								value = "points_per_rank"
							>

						</td>

						<td class="nospace">
							<span class="half nospace">

								<span class="third rightalign marno">
									Rank:
								</span>

								<span class="fourfifths marno">
									<input
										type = "number"
										name = "place"
										max  = "999"
										min  = "1"
										size = "5"
									>
								</span>
							</span>

							<span class="half nospace">

								<span class="quarter">
									In
								</span>

								<span class="threequarters">
									<select name="count" class="fixedtiny plain">
										<option value="all">All</option>
										<option value="prelim">Prelims</option>
										<option value="elim">Elims</option>
										<option value="final">Finals</option>
									</select>
								</span>
							</span>
						</td>

						<td class="smallish">
							Points:
							<input
								type = "number"
								name = "points"
								max  = "999"
								min  = "0"
								size = "5"
								step = ".1"
							>
						</td>

						<td class="centeralign">
							<input
								type="submit"
								class="thin"
								value="Add">
							</form>
						</td>
					</tr>

					<tr class="row">
						<td class="smallish">

							Give points for composite rank

							<form action="sweep_rule_save.mhtml">

							<input
								type  = "hidden"
								name  = "set_id"
								value = "<% $set->id %>"
							>

							<input
								type  = "hidden"
								name  = "tag"
								value = "points_per_composite_rank"
							>
						</td>

						<td class="nospace">

							<span class="half nospace">

								<span class="third rightalign marno">
									Rank:
								</span>

								<span class="fourfifths marno">
									<input
										type  = "number"
										class = "thinner"
										name  = "place"
										min   = "1"
										max   = "99"
										step  = "1"
										size  = "3"
									>
								</span>
							</span>

							<span class="half">
								<div class="full nospace">

									<span class="quarter">
										Basis
									</span>

									<span class="threequarters">
										<select
											name  = "tiebreak_set_id"
											class = "fixedtiny plain"
										>
%											foreach my $tb_set ($tourn->tiebreak_sets) {
												<option
													value="<% $tb_set->id %>"
												><% $tb_set->name %></option>
%											}
										</select>
									</span>
								</div>

								<div class="full nospace">
									<select name="count" class="fixedsmall">
										<option value="all">All</option>
										<option value="prelim">Prelims</option>
										<option value="elim">Elims</option>
										<option value="final">Finals</option>
									</select>
								</div>
							</span>
						</td>

						<td class="smallish">
							Points:
							<input
								type = "number"
								name = "points"
								max  = "999"
								min  = "0"
								size = "5"
								step = ".1"
							>
						</td>

						<td class="centeralign">
							<input
								type="submit"
								class="thin"
								value="Add">
							</form>
						</td>

					</tr>

					<tr>
						<td colspan="4" class="nospace">
							<h6 class="semibold bluetext">Debate Win/Loss</h6>
						</td>
					</tr>

					<tr class="row">

						<td class="smallish">
							Give points for each debate ballot won
							<form action="sweep_rule_save.mhtml">
							<input type="hidden" name="set_id" value="<% $set->id %>">
							<input type="hidden" name="tag" value="debate_win">
						</td>

						<td class="smallish">
							<span class="fifth">
								In:
							</span>
							<span class="fourfifths">
								<select name="count" class="fixedsmall">
									<option value="all">All</option>
									<option value="prelim">Prelims</option>
									<option value="elim">Elims</option>
									<option value="final">Finals</option>
								</select>
							</span>
						</td>

						<td class="smallish">
							Points:
							<input
								type = "number"
								name = "points"
								max  = "999"
								min  = "1"
								size = "5"
							>
						</td>

						<td class="centeralign">
							<input
								type  = "submit"
								class = "thin"
								value = "Add"
							>
							</form>
						</td>

					</tr>

					<tr class="row">

						<td class="smallish">
							Give points for each debate ballot lost
							<form action="sweep_rule_save.mhtml">

							<input
								type  = "hidden"
								name  = "set_id"
								value = "<% $set->id %>"
							>
							<input
								type  = "hidden"
								name  = "tag"
								value = "debate_loss"
							>
						</td>

						<td class="smallish">

							<span class="fifth">
								In:
							</span>

							<span class="fourfifths">
								<select name="count" class="fixedsmall">
									<option value="all">All</option>
									<option value="prelim">Prelims</option>
									<option value="elim">Elims</option>
									<option value="final">Finals</option>
								</select>
							</span>

						</td>

						<td class="smallish">
							Points:
							<input
								type = "number"
								name = "points"
								max  = "999"
								min  = "1"
								step = ".1"
								size = "5"
							>
						</td>

						<td class="centeralign">
							<input
								type  = "submit"
								class = "thin"
								value = "Add"
							>
							</form>
						</td>

					</tr>

					<tr class="row">

						<td class="smallish">
							Give points for each debate round won

							<form action="sweep_rule_save.mhtml">

							<input
								type  = "hidden"
								name  = "set_id"
								value = "<% $set->id %>">

							<input
								type  = "hidden"
								name  = "tag"
								value = "debate_round_win"
							>

						</td>

						<td class="smallish">

							<span class="fifth">
								In:
							</span>

							<span class="fourfifths">
								<select name="count" class="fixedsmall">
									<option value="all">All</option>
									<option value="prelim">Prelims</option>
									<option value="elim">Elims</option>
									<option value="final">Finals</option>
								</select>
							</span>
						</td>

						<td class="smallish">
							Points:
							<input
								type = "number"
								name = "points"
								max  = "999"
								min  = "1"
								step = ".1"
								size = "5"
							>
						</td>

						<td class="centeralign">
							<input type="submit" class="thin" value="Add">
							</form>
						</td>

					</tr>

					<tr class="row">

						<td class="smallish">
							Give points for each debate round loss

							<form action="sweep_rule_save.mhtml">

							<input
								type  = "hidden"
								name  = "set_id"
								value = "<% $set->id %>"
							>

							<input
								type  = "hidden"
								name  = "tag"
								value = "debate_round_loss"
							>

						</td>

						<td class="smallish">
							<span class="fifth">
								In:
							</span>
							<span class="fourfifths">
								<select name="count" class="fixedsmall">
									<option value="all">All</option>
									<option value="prelim">Prelims</option>
									<option value="elim">Elims</option>
									<option value="final">Finals</option>
								</select>
							</span>
						</td>

						<td class="smallish">
							Points:
							<input
								type = "number"
								name = "points"
								max  = "999"
								min  = "1"
								step = ".1"
								size = "5"
							>
						</td>

						<td class="centeralign">
							<input
								type  = "submit"
								class = "thin"
								value = "Add"
							>
							</form>
						</td>

					</tr>

					<tr class="row">

						<td class="smallish">
							Give points for each debate round bye

							<form action="sweep_rule_save.mhtml">

							<input
								type  = "hidden"
								name  = "set_id"
								value = "<% $set->id %>"
							>

							<input
								type  = "hidden"
								name  = "tag"
								value = "debate_round_bye"
							>

						</td>

						<td>
							<span class="fifth">
								In:
							</span>
							<span class="fourfifths">
								<select name="count" class="fixedsmall">
									<option value="all">All</option>
									<option value="prelim">Prelims</option>
									<option value="elim">Elims</option>
									<option value="final">Finals</option>
								</select>
							</span>
						</td>

						<td class="smallish">
							Points:
							<input
								type = "number"
								name = "points"
								max  = "999"
								min  = "1"
								step = ".1"
								size = "5"
							>
						</td>

						<td class="centeralign">
							<input
								type  = "submit"
								class = "thin"
								value = "Add"
							>
							</form>
						</td>

					</tr>

				<tr class="row">
					<td
						colspan = "3"
						class   = "smallish"
					>

						Manually entered points (under Tab &rarr; Sweeps)

						<form action="sweep_rule_save.mhtml">

						<input
							type  = "hidden"
							name  = "set_id"
							value = "<% $set->id %>"
						>

						<input
							type  = "hidden"
							name  = "tag"
							value = "manual"
						>

					</td>

					<td class="centeralign">
						<input
							type  = "submit"
							class = "thin"
							value = "Add">
						</form>
					</td>
				</tr>

			</table>

%		} else {

			<h4>Choose a set at right</h4>
%		}

	</div>
	<div class="menu">

%		my @sets = $tourn->sweep_sets;

		<div class="sidenote">

			<h4>Sweeps Sets </h4>

%			foreach my $set (@sets) {
				<a
					class="<% $set_id == $set->id ? "dk" : "" %>blue full"
					href="sweeps.mhtml?set_id=<% $set->id %>">
					<% $set->name %>
				</a>
%			}

			<h5>Add New Set</h5>

			<form
				action = "sweep_set_save.mhtml"
				method = "post"
			>

			<div class="even">

				<span class="threequarters">
					<input
						type        = "text"
						size        = "32"
						name        = "name"
						placeholder = "Enter name"
					>
				</span>

				<span class="quarter rightalign">
					<input
						type="submit"
						class="thin"
						value="Add">
				</span>

			</div>
			</form>
		</div>

%		if ($set && $tourn_settings->{"nsda_nats"}) {

%			my $cumulative = $set->rules(tag => "cumulative")->first;

			<div class='sidenote'>

				<h4>Cumulative Awards</h4>

				<form
					action = "sweep_rule_cumulative.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "set_id"
					value = "<% $set->id %>"
				>

				<div class="row centeralign">

					<select
						name="cumulative_tag"
						onchange="this.form.submit();"
					>
						<option value="">None</option>

						<option
							value="mundt"
							<% $cumulative && $cumulative->value eq "mundt" ? 'selected="selected"' : "" %>
							>Karl Mundt Award</option>

						<option
							value="bruno"
							<% $cumulative && $cumulative->value eq "bruno" ? 'selected="selected"' : "" %>
							>Bruno Jacobs Award</option>

					</select>
				</div>
				</form>
			</div>
%		}

	</div>

<%perl>

	sub convert {

		my $ref = shift;
		my %hash;

		foreach my $ref (@{$ref}) {
			my $id = $ref->{"id"};
			$hash{$id} = $ref;
		}

		return %hash;
	}

</%perl>
