<%args>
	$tourn
	$person
	$tiebreak_set_id => undef
</%args>
<%init>

	my @tiebreakers = (
		"",
		"ranks",
		"winloss",
		"reciprocals",
		"points",
		"ballots",
		"judgepref",
		"seed",
		"opp_seed",
		"opp_ranks",
		"opp_wins",
		"opp_points",
		"headtohead",
		"chair_ranks",
		"downs",
		"losses",
		"judgevar",
		"judgevar2",
		"coinflip",
	);

	my @counts = (
		"prelim",
		"elim",
		"previous",
		"final",
		"all"
	);

	my $set = Tab::TiebreakSet->retrieve($tiebreak_set_id) if $tiebreak_set_id;

	my %tb_setting = $set->all_settings if $set;

</%init> 

	<div class="main">
			
		<h2><% $tourn->name %></h2>

		<& tabbar.mas, 
			tourn => $tourn, 
			whoami => "tiebreaks" 
		&>

		<div class='full nospace'>

			<span class="twothirds">

				<h4><% $set ? $set->name : "Create Tiebreak Set:" %></h4>

			</span>

			<span class="third rightalign">

%				if ($set) { 

%					my $warn = "You are about to delete this tiebreaker set.  That
%					may cause terrible, terrible damage.  Are you sure?";

						<a 
							class = "redtext buttonwhite centeralign nowrap hover"
							href  = "tiebreak_set_rm.mhtml?set_id=<% $set->id %>"
							title = "Delete <% $set->name %> tiebreakers"

							<& "/funclib/confirm.mas", warn => $warn &>  
						>
							<span class="inline fa fa-trash"></span>
							Delete <% $set->name %>
						</a>
%					}
			</span>

		</div>

			<form 
				action = "tb_set_save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				name  = "tiebreak_set_id"
				value = "<% $tiebreak_set_id %>"
			>

			<div class="full marbottom padless marleft marright yellowrow">

				<span class="third padleft">
					Name of Tiebreaker Set
				</span>

				<span class="twothirds centeralign">
					<input 
						type        = "text"
						size        = "48"
						name        = "name"
						value       = "<% $set ? $set->name : "" %>"
						placeholder = "Tiebreak set name"
					>
				</span>

			</div>

		<span class="pagehalf">

			<label for="truncate_to_smallest">

				<div class="lightrow hover">

					<span class="seveneighth padleft">
						Truncate all IE ranks to size of smallest section
					</span>

					<span class="eighth">
						<input 
							type  = "checkbox"
							id    = "truncate_to_smallest"
							name  = "truncate_to_smallest"
							value = "1"
							<% $tb_setting{"truncate_to_smallest"} ? 'checked="checked"' : "" %>
						>
					</span>
				</div>
			</label>

			<div class="lightrow hover">

				<label for="truncate_ranks_to">
					<span class="fivesixth padleft">
						Truncate all IE ranks/recips to 
					</span>
					<span class="sixth">
						<input 
							type  = "number"
							id    = "truncate_ranks_to"
							name  = "truncate_ranks_to"
							size  = "3"
							min   = "0"
							max   = "99"
							class = "smaller"
							value = "<% $set ? $tb_setting{"truncate_ranks_to"} : "" %>"
						>
					</span>
				</label>
			</div>

			<div class="lightrow">
				<span class="twofifth padleft">
					Truncate all IE ranks/recips in:
				</span>

				<span class="threefifth nowrap">	

					<label for="truncate_prelims">
						<span class="third hover smallish nowrap nospace">
							<input 
								type  = "checkbox"
								id    = "truncate_prelims"
								name  = "truncate_prelims"
								value = "1"
								<% $tb_setting{"truncate_prelims"} ? 'checked="checked"' : "" %> 
							> Prelim
						</span>
					</label>

					<label for="truncate_elims">
						<span class="third hover smallish nowrap nospace">

							<input 
								type  = "checkbox"
								id    = "truncate_elims"
								name  = "truncate_elims"
								value = "1"
								<% $tb_setting{"truncate_elims"} ? 'checked="checked"' : "" %>
							> Elim
						</span>

					</label>

					<label for="truncate_finals">
						<span class="third hover smallish nowrap nospace">
							<input 
								type  = "checkbox"
								id    = "truncate_finals"
								name  = "truncate_finals"
								value = "1"
								<% $tb_setting{"truncate_finals"} ? 'checked="checked"' : "" %> 
							> Final
						</span>
					</label>
				</span>
			</div>

		</span>


		<span class="pagehalf">

			<div class="lightrow hover">

				<label for="equal_elims">

					<span class="seveneighth padleft">

						Advance equal entries from each section

						<p class="smallish explain marno padless">
							Use only in IE Elims &amp; Congress
						</p>
					</span>

					<span class="eighth smallish">
						<input 
							type  = "checkbox"
							id    = "equal_elims"
							name  = "equal_elims"
							value = "1"
							<% $tb_setting{"equal_elims"} ? 'checked="checked"' : "" %>
						>
					</span>

				</label>
			</div>

			<div class="lightrow hover">
				<label for="forfeits_never_break">

					<span class="seveneighth padleft">
						No shows/forfeits cannot break/advance
					</span>

					<span class="eighth">
						<input 
							type  = "checkbox"
							id    = "forfeits_never_break"
							name  = "forfeits_never_break"
							value = "1"
							<% $tb_setting{"forfeits_never_break"} ? 'checked="checked"' : "" %> 
						>
					</span>
				</label>
			</div>

			<div class="lightrow hover">

				<label for="mfl_time_violation">

					<span class="seveneighth padleft">
						IE Time Violation penalty (+1 rank)
					</span>
					<span class="eighth">
						<input 
							type  = "checkbox"
							id    = "mfl_time_violation"
							name  = "mfl_time_violation"
							value = "1"
							<% $tb_setting{"mfl_time_violation"} ? 'checked="checked"' : "" %>
						>
					</span>
				</label>
			</div>

			<div class="lightrow hover">

				<label for="tie_middle_rank">

					<span class="seveneighth padleft">
						3x Composite Ties get Middle Rank (CA)
					</span>

					<span class="eighth">
						<input 
							type  = "checkbox"
							id    = "tie_middle_rank"
							name  = "tie_middle_rank"
							value = "1"
							<% $tb_setting{"tie_middle_rank"} ? 'checked="checked"' : "" %>
						>
					</span>
				</label>
			</div>



		</span>

		<div class="liblrow rightalign">
			<input 
				type  = "submit"
				value = "<% $set ? "Save Settings" : "Create Tiebreak Set" %>"
			>
			</form>
		</div>


%		if ($set) { 
			
			<h4>Tiebreaks order</h4>


<%perl>
			
			my $prime;


	   		foreach my $tiebreak (
				sort {$a->priority <=> $b->priority} 
					Tab::Tiebreak->search(tiebreak_set => $set->id)
			) {

				$prime = $tiebreak->priority if $tiebreak->priority > $prime;

				my $highlow;

				my $highlow_count = $tiebreak->highlow_count;

				$highlow_count = 1 unless $highlow_count;

				$highlow = ", except the ".$highlow_count." best &amp; worst" 
					if $tiebreak->highlow == 1 
					|| $tiebreak->highlow == 2;

				$highlow = ", except the ".$highlow_count." best" 
					if $tiebreak->highlow == 3;

				$highlow = ", except the ".$highlow_count." worst" 
					if $tiebreak->highlow == 4;

</%perl>
				<div class="lightrow">

					<span class="seveneighth">
						 <% $tiebreak->priority %>. 
						 <% ucfirst($tiebreak->name) %> 
						 score from <% $tiebreak->count %> round(s)
						 <% $tiebreak->truncate ? " truncated to ".$tiebreak->truncate : "" %>
						 <% $highlow %>
						 <% ($tiebreak->multiplier > 1) ? ", multiplied by ".$tiebreak->multiplier : "" %>
						 <% $tiebreak->child > 0 ? ", composite on ".$tiebreak->child->name : "" %>
					</span>

					<span class="eighth rightalign">
            	    	<a 
							class="redtext button hover buttonwhite fa fa-lg fa-trash"
							href="tiebreak_rm.mhtml?tiebreak_id=<% $tiebreak->id %>"
						></a>
					</span>

				</div>

%			}

%			$prime++;

			<br />

			<h5>Add new tiebreaker:</h5>

			<form 
				action = "tiebreak_save.mhtml"
				method = "post"
			>

			<input 
				type    = "hidden"
				name    = "tiebreak_set_id"
				value   = "<% $set->id %>"
			>

			<script>

				function showCompositeBox() { 

					var tiebreaker = $('#newtiebreaker').find(":selected").val();

					if (   tiebreaker === "ranks" 
						|| tiebreaker === "reciprocals"
						|| tiebreaker === "downs"
					) { 
						$(".compositebox").removeClass("hidden");
					} else { 
						$(".compositebox").addClass("hidden");
					}

				};

				function showComposite(value) { 

					if (value == 1) { 
						$("#composite").removeClass("hidden");
					} else { 
						$("#composite").addClass("hidden");
					}
				};

				$(document).ready(function(){
					$("#composite").addClass('hidden');
				});

			</script>
					
			<table>

				<tr class="yellowrow"> 

					<th class="smallish centeralign">
						Tiebreak Type
					</th>

					<th class="smallish centeralign">
						Priority
					</th>

					<th class="smallish centeralign hidden compositebox">
						Truncate
					</th>

					<th class="smallish centeralign">
						Count Rounds
					</th>

					<th class="smallish centeralign">
						Multiply By
					</th>

					<th class="smallish centeralign">
						Ignore/Drop
					</th>


					<th class="smallish centeralign hidden compositebox" >
						Composite
					</th>

					<th></th>
				</tr>

				<tr class="lighteven"> 
				
					<td class="centeralign">

						<select 
							name     = "name"
							id       = "newtiebreaker"
							onChange = "showCompositeBox();";
						>

%               			foreach my $tb (@tiebreakers) {
                    			<option value="<% $tb %>"><% ucfirst($tb) %></option>
%               			}

           	 			</select>

        			</td> 
					
					<td class="centeralign">
						<input 
							type        = "number"
							class       = "smaller"
							min         = "1"
							max         = "99"
							size        = "2"
							name        = "priority"
							value       = "<% $prime %>"
							placeholder = "Priority"
						>
					</td> 

					<td class="centeralign hidden compositebox">

						<input 
							type="number"
							name="truncate"
							min = "0"
							max = "99"
							class="smaller"
						>
					</td> 
					
					
					<td class="centeralign">
						<select name="count">
%           				foreach my $ct (@counts) {
                				<option 
									value="<% $ct %>"
								><% ucfirst($ct) %></option>
%           				}
            			</select>
        			</td>

					<td class="centeralign">
						<input 
							type        = "number"
							class       = "smaller"
							min         = "1"
							max         = "99"
							size        = "5"
							name        = "multiplier"
							placeholder = "Multiplier"
						>
					</td> 

					<td class="smaller centeralign nospace">

						<span class="quarter marno">
							Drop
						</span>

						<span class="quarter marno">
							<input 
								type  = "number"
								class = "smaller"
								name  = "highlow_count"
								min   = "1"
								max   = "9"
								size  = "3"
								class = "thin"
							>
						</span>

						<span class="half marno">
							<select name="highlow nospace">
								<option value="0">None</option>
								<option value="1">H/L</option>
								<option value="3">Best</option>
								<option value="4">Worst</option>
							</select>
						</span>
					</td> 
					
					<td class = "centeralign nospace hidden compositebox" >

						<label for="composite_box">
							<span class="padmuchmore hover">

								<input
									type    = "checkbox"
									name    = "composite"
									id      = "composite_box"
									value   = "1"
									onclick = "showComposite(this.checked)";
								>
							</span>
						</label>
					</td> 
					
					<td 
						class   = "centeralign"
						rowspan = "2"
					>
						<input 
							class = "thin"
							type  = "submit"
							value = "Save"
						>
						</form>
					</td>

				</tr>

				<tr 
					id    = "composite"
					class = "lighteven"
				>

					<td 
						colspan = "7"
					>

						<span class="half rightalign marno">
							Composite based on tiebreakers:
						</span>

						<span class="half centeralign">

							<select 
								name    = "child"
								class   = "chosen fixedmed"
							>

							<option value=""></option>

%							foreach my $other_set ($tourn->tiebreak_sets) { 
%								next if $other_set == $set;
								<option 
									value="<% $other_set->id %>"
								><% $other_set->name %></option>
%							}

							</select>
						</span>


					</td>

				</tr>

			</table>
%		}

	</div>

	<div class="menu">

<%perl>

		my @sets = 
			sort {$a->name cmp $b->name} 
			Tab::TiebreakSet->search(tourn => $tourn->id);

</%perl>

		<div class="sidenote">

			<h4>Tiebreak sets</h4>

				<a 
					class = "yellow full marbottom"
					href  = "tiebreaks.mhtml"
				>
					Add a new set
				</a>

%				foreach my $tiebreak_set (@sets) { 
					<a 	
						class = "<% $tiebreak_set_id == $tiebreak_set->id ? "dk" : "" %>blue full" 
						href  = "tiebreaks.mhtml?tiebreak_set_id=<% $tiebreak_set->id %>"
					>
						<% $tiebreak_set->name %>
					</a>
%				}

			<br />

			<h4 class="martop">Explain, Please</h4>

				<p>

					Create a tiebreak set for each type of advancement you wish
					to have; for example, one set for Debate Prelims, one for
					Debate Elims, one for IE Prelims, one for IE Elims, and one
					for Debate Top Speakers.

				</p>

				<a 
					href  = "tiebreaks_explain.mhtml"
					class = "yellow full"
				>
					Guide to Tiebreakers
				</a>

		</div>

	</div>
