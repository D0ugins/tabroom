<%args>
	$tourn
	$person
	$certain     => undef
	$timeslot_id => undef
</%args>
<%init>

	my $timeslot = Tab::Timeslot->retrieve($timeslot_id);

	unless ($timeslot) {
		$m->print("That timeslot does not exist");
		$m->abort;
	}

	if ($certain eq "Delete Timeslot ".$timeslot->name) {

		my $msg = "Timeslot ".$timeslot->name." Deleted.";

		$m->comp("/funclib/log.mas",
			type        => 'tabbing',
			tourn       => $tourn->id,
			person      => $person->id,
			description => "Deleted timeslot ".$timeslot->name." and its ".scalar $timeslot->rounds()." rounds"
		);

		my $dbh = Tab::DBI->db_Main();

		my $score_sth = $dbh->prepare("
			delete score.*
			from score, ballot, panel, round
			where round.timeslot = ?
			and round.id = panel.round
			and panel.id = ballot.panel
			and ballot.id = score.ballot
		");

		my $ballot_sth = $dbh->prepare("
			delete ballot.*
			from ballot, panel, round
			where round.timeslot = ?
			and round.id = panel.round
			and panel.id = ballot.panel
		");

		my $panel_sth = $dbh->prepare("
			delete panel.*
			from panel, round
			where round.timeslot = ?
			and round.id = panel.round
		");

		my $parent_sth = $dbh->prepare("
			update round, round parent
			set parent.runoff = 0
			where parent.runoff = round.id
			and round.timeslot = ?
		");

		my $round_sth = $dbh->prepare("
			delete round.*
			from round
			where round.timeslot = ?
		");

		$score_sth->execute($timeslot->id);
		$ballot_sth->execute($timeslot->id);
		$panel_sth->execute($timeslot->id);
		$parent_sth->execute($timeslot->id);
		$round_sth->execute($timeslot->id);
		$timeslot->delete();
		$m->redirect("/setup/schedule/sked.mhtml?msg=$msg");
	}

</%init>

	<div class="main" style="text-align: center;">

		<&  "/funclib/warning.mas", person => $person &>

		<h5 class="warning bluetext">
			You are about to permanently delete Timeslot <% $timeslot->name %>
		</h5>

		<h5 class="warning bluetext">
			This action will also delete <% scalar $timeslot->rounds %> rounds:
		</h5>

%		foreach my $round ($timeslot->rounds) {
			<h6 class="centeralign redtext semibold quarter">
				<% $round->realname %> of <% $round->event->abbr %>
			</h6>
%		}

%		foreach my $round ($timeslot->rounds) {
%			if ($round->panels) {
				<h5 class="orangetext padvertmuchmore marvertmuchmore semibold ltborder">
					<% $round->event->abbr%> <% $round->realname %> HAS <% scalar $round->panels %> SECTIONS SCHEDULED
					<br />
					<br />THIS PAIRING &mdash; AND ALL ITS RESULTS &mdash; WILL BE DELETED
				</h5>
%			}
%		}

		<p>
			This action cannot be undone.  You can only get it back with a
			backup or by re-entering it again.  If the timeslot has rounds
			scheduled in it, they will be deleted, along with any results and
			feedback entered in them.  You can't get them back.  Don't come
			crying to me.
		</p>

		<p>
			Don't say I didn't warn you.
		</p>

		<p>
			To proceed, type "Delete Timeslot <% $timeslot->name %>" in the box below:
		</p>

		<form action="delete.mhtml" method="post">

		<input
			type  = "hidden"
			value = "<% $timeslot_id %>"
			name  = "timeslot_id"
		>

			<p align="center">
				<input
					type           = "text"
					name           = "certain"
					size           = "20"
					autocomplete   = "off"
					autocorrect    = "off"
					autocapitalize = "off"
					spellcheck     = "false"
					class          = "martop notfirst"
				></p>
			</p>

			<p align="center">
				<input
					type  = "submit"
					value = "Delete Timeslot"
				>
				</form>
			</p>
	</div>
