<%args>
	$tourn
	$perms
	$tourn_settings 
	$date            => undef
	$all             => undef
	$round_highlight => undef
</%args> 
<%init> 

	if ($perms->{"details"}) { 
		$m->redirect("event.mhtml");
	}

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $today;
	my $end = $tourn->end->set_time_zone($tz);
	my $start = $tourn->start->set_time_zone($tz);

	if ($date) { 
		$today = Tab::dateme($date);
	}

	my @days = $m->comp(
		"/funclib/tourn_days.mas", 
		tourn => $tourn
	);

	$today = $days[0] unless $today;
	$m->abort unless $today;

	$today->set_time_zone($tz);
	$today->truncate( to => 'day' );

	my $today_limit;

	if ($tourn_settings->{"nsda_district"}) { 

		my $last_date = $days[-1] if @days;

		unless ($last_date->mdy eq $today->mdy) { 

			$today_limit = $today->clone();

			$today_limit->set(
				hour   => 21,
				minute => 30
			);
		}
	}

	my @timeslots;

	if (scalar @days > 1 && not defined $all) { 

		$today = $days[0] unless $today;
	
		my @tmp = Tab::Timeslot->search( 
			tourn => $tourn->id, 
			{order_by => 'start'}
		);

		foreach my $ts (@tmp) { 
			push (@timeslots, $ts) 
				if $ts->start 
				&& $ts->start->set_time_zone($tz)->mdy eq $today->mdy;
		}

	} else  { 

		@timeslots = 
			sort {$a->start <=> $b->start} 
				Tab::Timeslot->search( 
					tourn => $tourn->id, 
					{order_by => 'start'}
				)
		;
		$today = shift @days;

	}

	my $time_warning;
	my $impossible_warning;

</%init>

	<& "menu.mas", 
		tourn => $tourn,
		perms => $perms,
		days  => \@days,
		today => $today 
	&>

	<div class="main">

		<span class="fourfifths">
			<h4>Timeslots: <% $today->day_name %> <% $today->month."/".$today->day %></h4>
		</span>
	
		<span 
			id    = "sortsked_buttonarea"
			class = "fifth rightalign"
		>
		</span>

		<& "/funclib/tablesorter.mas", 
			table => "sortsked"
		&>

%		if (@timeslots) { 

			<form 
				action = "save.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				name  = "date"
				value = "<% $today->mdy('/') %>"
			>

%		}

		<table id="sortsked">

			<thead>

				<tr class="yellowrow">

					<th>
						Label
					</th>

%					if (@days) { 
						<th>
							Day
						</th>
%					}

					<th>
						Start Time
					</th>

					<th>
						End Time
					</th>

					<th class="nosort">
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

			my %warning = ();

			foreach my $timeslot (@timeslots) {

				my $roundstart = $timeslot->start;
				my $roundend = $timeslot->end;
				my $duration = $roundend - $roundstart;

				if ($duration->in_units('hours') > 4) { 

					my $non_congress;

					foreach my $round ($timeslot->rounds) {
						$non_congress++ if $round->event->type ne "congress";
						last if $non_congress;
					}

					if ($non_congress) { 

						$warning{$timeslot->id}{"color"} = "red";

						$warning{$timeslot->id}{"text"} = "One or more rounds (in red) were scheduled for longer than 4 hours.  Dear God, what are you doing to those poor judges?  Chances are there's an am/pm problem here.";
					}

				}

				if ($roundstart > $roundend) { 

					$warning{$timeslot->id}{"color"} = "blue";

					$warning{$timeslot->id}{"text"} = "One or more rounds (in blue) ends before it is scheduled to begin.  While that sure would save a lot of time, we do not we control the fabric of space and time.  Chances are strong there's an am/pm problem here.";

				}

				if ($today_limit && $tourn_settings->{'nsda_district'}) { 

					if ($roundstart > $today_limit) { 

						$warning{$timeslot->id}{"color"} = "orange";

						$warning{$timeslot->id}{"text"} = "One or more rounds (in orange) start after 9:30 PM. By NSDA rule, no round may start after 9:30 PM except on the last day of the tournament.  Extemp rounds may start no later than 9:45 PM.";

					}

				}

</%perl>

				<tr class="<% $warning{$timeslot->id}{"color"} %>row">

					<td class="centeralign">

						<span class="hidden"><% $timeslot->name %></span>

						<input 
							type  = "text"
							name  = "<% $timeslot->id %>_name"
							value = "<% $timeslot->name %>"
							size  = "15"
						>

					</td>

%					if (@days) { 

						<td class="centeralign">

							<span class="hidden"><% $timeslot->start->day %></span>

							<select 
								name  = "<% $timeslot->id %>_day"
								class = "fixedtiny"
							>

%								foreach my $day (@days) { 
									<option 
										value = "<% $day->mdy('/') %>"
										<% $day->mdy eq $timeslot->start->mdy ? 'selected' : "" %> 
									> <% $day->day_abbr %> <% $day->month."/".$day->day %> </option>
%								}
							</select>

						</td>
%					}

					<td class="centeralign">
						<span class="hidden"><% $timeslot->start->epoch %></span>
						<& /funclib/timepicker.mas, 
							name => $timeslot->id."_start", 
							time => $timeslot->start->set_time_zone($tz) 
						&>
					</td>

					<td class="centeralign">
						<span class="hidden"><% $timeslot->end->epoch %></span>
						<& /funclib/timepicker.mas, 
							name => $timeslot->id."_end", 
							time => $timeslot->end->set_time_zone($tz) 
						&>
					</td>

					<td class="centeralign nospace">
						<a 
							class = "dkred button fa fa-lg fa-trash buttonwhite redtext"
							href  = "delete.mhtml?timeslot_id=<% $timeslot->id %>"
							alt   = "Delete"
							title = "Delete Timeslot &amp; Rounds"
							>
						</a>
					</td>

				</tr>

%			}

			</tbody>

<%perl>

			my %done;

 			foreach my $timeslot (@timeslots) {

				next unless $warning{$timeslot->id};
				next if $done{$warning{$timeslot->id}{"color"}}++;
				next unless $warning{$timeslot->id}{"color"};

</%perl>
				<div class="warn redtext centeralign padmuchmore marbottom">
					<h5>Warning:</h5>
					<% $warning{$timeslot->id}{"text"} %>
				</div>
%			}

%			if (@timeslots) { 

				<tr class="liblrow">

					<td colspan="5" class="rightalign">
						<input  
							style = "width: 150px;"
							type  = "submit"
							value = "Save Timeslots"
						>
						</form>
					</td>

				</tr>

%			}

		</table>

		<h4 class="martopmore">
			Add a new timeslot:
		</h4>

		<form action="create.mhtml" method="post">

		<input 
			type  = "hidden"
			name  = "date"
			value = "<% $today->mdy('/') %>"
		>

		<div class="ltyellow full">

			<span class="quarter">
				<input 	
					type        = "text"
					name        = "name"
					size        = "20"
					placeholder = "Add new..."
				>
			</span>
			
			<span class="quarter">
				<& 
					"/funclib/timepicker.mas", 
					name => "new_start" 
				&>
			</span>
			
			<span class="quarter">
				<& 
					"/funclib/timepicker.mas", 
					name => "new_end"
				&>
			</span>

			<span class="quarter rightalign">
				<input  
					type  = "submit"
					value = "Add"
				>
				</form>
			</span>

		</div>

	</div>

