<%args>
	$tourn
	$perms
	$tourn_settings
	$person
	$person_settings
	$event_id        => undef
	$round_highlight => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	my @tourn_events = $tourn->events();

	unless ($event) {
		@tourn_events = $m->comp(
			"/funclib/event_perms.mas",
			perms  => $perms,
			type   => "admin",
			events => \@tourn_events
		);

		$event = $tourn_events[0] if @tourn_events;
	}

	$m->abort unless $event;
	$m->abort unless $event->category;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $weekend_id = $event->setting('weekend');

	my $not_held++ if $weekend_id eq "nope";
	my $weekend = Tab::Weekend->retrieve($weekend_id)
		if $weekend_id
		&& $weekend_id == int($weekend_id);

	my $weekend_start;
	my $weekend_end;
	my @sites;

	if ($weekend) {
		$weekend_start = $weekend->start->epoch;
		$weekend_end = $weekend->end->epoch;
		push @sites, $weekend->site;
	} else {
		@sites = $m->comp(
			"/funclib/tourn_sites.mas",
			tourn => $tourn
		);
	}

	my %ok_sites = map {$_->id => 1} @sites;
	my $now = DateTime->now();

    my @days = $m->comp(
		"/funclib/tourn_days.mas",
		tourn   => $tourn,
	);

	my $default_site = $sites[0]->id
		if @sites
		&& scalar @sites < 2;

	my $type = $event->type;

	$type = "debate"
		if $type ne "speech"
		&& $type ne "congress";

	my $district++ if $tourn_settings->{"nsda_district"};
	undef $district if $tourn_settings->{"nsda_pilot_".$event->type};

	my @rounds = $event->rounds;
	my %round_by_timeslot;
	my $empty;

	my $warning;

	foreach my $round (@rounds) {
		next unless $round->timeslot;
		$empty = "hidden" if $round->type eq "final";
		push @{$round_by_timeslot{$round->timeslot->id}}, $round;

		unless ($ok_sites{$round->site}) {
			$warning .= "<br />" if $warning;
			$warning .= "Round ".$round->realname;

			if ($round->site) {
				$warning .=" Site (".$round->site->name.") not assigned to this tournament!";
			} else {
				$warning .=" No site assigned!";
			}
		}
	}

	my @tiebreak_sets =
		sort {$a->name cmp $b->name}
		$tourn->tiebreak_sets;

	my @tourn_timeslots =
		sort {$a->start->epoch <=> $b->start->epoch}
		$tourn->timeslots;

	Tab::Round->columns(TEMP => "r2_name");

	Tab::Round->set_sql( overlaps => "

		select r1.*, r2.name as r2_name
		from round r1, timeslot t1,
			round r2, timeslot t2

		where r1.event = ?
		and r1.event = r2.event
		and r1.timeslot = t1.id
		and r2.timeslot = t2.id
		and r2.id != r1.id

		and t1.start < t2.end
		and t2.start < t1.end

		and not exists (
			select breakout1.value
			from round_setting breakout1
			where breakout1.tag = 'use_for_breakout'
			and breakout1.round = r1.id
		)

		and not exists (
			select breakout2.value
			from round_setting breakout2
			where breakout2.tag = 'use_for_breakout'
			and breakout2.round = r2.id
		)
	");

	my @overlaps = Tab::Round->search_overlaps( $event->id );

</%init>

	<script type="text/javascript">

		$(document).ready(function(){
			$('html,body').scrollTop(0);
		});

		function showMe (timeslotID) {
			$("."+timeslotID).toggleClass("hidden");
		}

		function toggleEmpties () {

			if ($("#toggle").val()  == "Hide Empty Slots") {
				$("#toggle").val("Show Empty Slots");
				$(".empty").addClass("hidden");
                $(".main").find(".row").removeClass("even");
                $(".main").find(".row").removeClass("odd");
                $(".main").find(".row:visible:even").addClass("even");
				$(".main").find(".row:visible:odd").addClass("odd");
			} else {
				$(".empty").removeClass("hidden");
				$("#toggle").val("Hide Empty Slots");
                $(".main").find(".row").removeClass("even");
                $(".main").find(".row").removeClass("odd");
                $(".main").find(".row:even").addClass("even");
				$(".main").find(".row:odd").addClass("odd");
			}

			zebraRows();
		}


	</script>

%	my $current_day;

	<& menu.mas,
		tourn => $tourn,
		perms => $perms,
		event => $event,
		days  => \@days
	&>

	<div class="main">

		<span class="half">
			<h4><% $event->name %> schedule</h4>
		</span>

		<span class="third semibold rightalign">
			<% $weekend ? "Dates: ".$weekend->name : "" %>
		</span>

		<span class="sixth rightalign marno">
			<input
				type    = "button"
				id      = "toggle"
				class   = "thin"
				value   = "Show Empty Slots"
				onclick = "toggleEmpties(this)"
			>
		</span>

%		if ($warning) {

			<div class="semibold redtext bigger centeralign padbottommore">
				<h5>Warning!</h5>
				<% $warning %>

				<p class="martopmore fourfifths bluetext redborderbottom">
					To solve site errors, either change them below, add that
					site to this tournament again, or if you are using only 1
					site, remove the site from tournament and re-add it.
				</p>

			</div>
%		}

%		if (@overlaps) {
			<div class="semibold redtext bigger centeralign padbottommore">
				<h5>Rounds Overlap!</h5>

				<p class="martopmore fourfifths bluetext redborderbottom">
					The following rounds overlap each other's time blocks,
					which can lead to serious problems - no rooms or judges in
					one round will be placed in the other.
				</p>

				<p class="martopmore fourfifths bluetext redborderbottom">
					Adjust start/stop times for:
%					foreach my $overlap (@overlaps) {
%						$m->print($overlap->realname." ");
%					}
				</p>
			</div>
%		}

%		unless ($event->rounds) {

			<form
				action="clone_schedule.mhtml"
				method="post"
			>

			<input
				type  = "hidden"
				name  = "destination_event_id"
				value = "<% $event->id %>"
			>

			<div class="centeralign full even nospace">

				<span class="third rightalign">
					Clone schedule of:
				</span>

				<span class="third centeralign">

					<select name="source_event_id" class="fixedmed">

						<option value=""></option>

%						foreach my $other (@tourn_events) {
%							next if $event->id == $other->id;
%							next if $weekend && $weekend->id ne $other->setting('weekend');
							<option value="<% $other->id %>"><% $other->name %></option>
%						}

					</select>

				</span>

				<span class="leftalign third">
					<input
						type  = "submit"
						value = "Clone"
						class = "thin"
					>
				</span>

				</form>
			</div>
%		}

		<form
			action = "event_save.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "event_id"
			value = "<% $event->id %>"
		>

		<& "/funclib/tablesorter.mas", table => "schedule", nobuttons => 1 &>

		<table class="narrow" id="schedule">

			<thead>
			</thead>

			<tbody>
<%perl>

			TIMESLOT:
			foreach my $timeslot (@tourn_timeslots) {

				if ($weekend) {
					next TIMESLOT if $timeslot->start->epoch > $weekend_end;
					next TIMESLOT if $timeslot->end->epoch < $weekend_start;
				}

				if (
					(not defined $current_day)
					|| $current_day->day != $timeslot->start->set_time_zone($tz)->day
				) {

					$current_day = $timeslot->start->set_time_zone($tz);
</%perl>

					<tr class="yellowrow">

						<th class="smaller">
							<% $current_day->day_abbr %>
							<% Tab::niceshortdate($current_day) %>
						</th>

						<th class="smaller">
							Y/N
						</th>

						<th colspan="2" class="smaller">
							Label
						</th>

						<th class="smaller">
							Type
						</th>

						<th class="smaller">
							Tiebreaks
						</th>

%						if (scalar @sites > 1) {
							<th class="smaller">
								Site
							</th>
%						}

%						if ($type ne "congress") {
							<th class="smaller">
								Flights
							</th>
%						}

						</th>
					</tr>
<%perl>
				}

				my $second;
				@{$round_by_timeslot{$timeslot->id}} = (0)
					unless $round_by_timeslot{$timeslot->id};

				foreach my $round (@{$round_by_timeslot{$timeslot->id}}) {

					undef $round unless $round > 0;

					my $hidden = "hidden" unless $round && $round > 0;
					my $published;

					$published++ if $weekend && $weekend->end < $now;

					if ($round) {
						$published++ if $round->published > 0;
						$published++ if $round->panels;
						undef $published unless $round->panels;
					} else {
						undef $published;
					}

					my $warning = "This round is assigned, and unchecking this box ";
					$warning .= "would delete it.  To move it without deleting go to ";
					$warning .= "the Settings tab on the schematic.  If you really want ";
					$warning .= "to delete it, do so under Change and Destroy on the schematic.";
</%perl>

				<tr
					class="<% $round && $round_highlight == $round->id ? "lirdrow" : "row" %>
					<% $round ? "" : "empty ".$empty %>"
				>

					<td class="smaller nowrap">

						<div class="nospace <% $second ? "redtext semibold" : "" %>">
							<% $timeslot->name %>
						</div>

						<div class="padno martophalf">
							<% Tab::shorttime($timeslot->start->set_time_zone($tz)) %>
						</div>

					</td>


					<td class="centeralign">

						<label for="<% $timeslot->id %>">

						<div
							<% $published ? 'title="'.$warning.'"' : "" %>
							class="hover"
						>
							<input
								type    = "checkbox"
								id      = "<% $timeslot->id %>"
								name    = "<% $timeslot->id %>"
								value   = "1"
%								if ($published) {
									onclick = "return false;"
%								} else {
									onclick = "showMe(<% $timeslot->id %>);"
%								}
								<% $round && $round > 0 ? "checked" : "" %>
							><% $published ? '*' : "" %>
							</div>
						</label>
					</td>

					<td class="smallish centeralign">
						<% ($round) ? $round->name : "" %>
					</td>

%					if ($second) {

						<td colspan="4" class="centeralign redtext semibold smallish">

							<span class="twothirds">
								WARNING! Multiple rounds scheduled in the same timeslot! <br />
								Move round to another timeslot on the schematic round settings!
							</span>
							<span class="third centeralign">
								<a
									class="thin buttonwhite redtext invert smaller"
									href="/panel/schemat/show.mhtml?round_id=<% $round->id %>&default=settings"
								>Round <% $round->name %> Settings</a>
							</span>
						</td>

%					} else {

						<td class="smallish">

							<div class = "centeralign nospace <% $hidden %> <% $timeslot->id %>" >

								<input
									type        = "text"
									size        = "<% $district ? "16" : "4" %>"
									name        = "<% $timeslot->id %>_label"
									placeholder = "Label"
									value       = "<% ($round && $round->label) ? $round->label : "" %>"
								>
							</div>
						</td>

						<td class="centeralign">

							<div class = "nospace <% $hidden %> <% $timeslot->id %>" >

								<select
									name  = "<% $timeslot->id %>_type"
									class = "smallish plain"
								>

									<option
										value="prelim"
										<% ($round && $round->type eq "prelim")
											? "selected" : ""
										%>
									>
										Prelim/Preset
									</option>

%									if ($type eq "debate") {
										<option
											value="highlow"
											<% ($round && $round->type eq "highlow")
												? "selected" : ""
											%>
										>
											Hi/Lo
										</option>

										<option
											value="highhigh"
											<% ($round && $round->type eq "highhigh")
												? "selected" : ""
											%>
										>
											Hi/Hi
										</option>
%									}

%									if ($type eq "speech") {
										<option
											value="snaked_prelim"
											<% ($round && $round->type eq "snaked_prelim")
												? "selected" : ""
											%>
										>
											Snaked Prelim
										</option>
%									}

									<option
										value="elim"
										<% ($round && $round->type eq "elim")
											? "selected" : ""
										%>
									>
										Elim
									</option>

									<option
										value="final"
										<% ($round && $round->type eq "final")
											? "selected" : ""
										%>
									>
										Final
									</option>

									<option
										value="runoff"
										<% ($round && $round->type eq "runoff")
											? "selected" : ""
										%>
									>
										Runoff
									</option>

								</select>
							</div>
						</td>

						<td
							class="centeralign nospace smallish
							<% $round > 0 && $round->id == $round_highlight ? "dkred" : "" %> "
						>

							<div
								class = "nospace full <% $hidden %> <% $timeslot->id %>
								<% $round && $round->tiebreak_set && $round->tiebreak_set->id ? "" : "dkred" %>"
							>

								<select
									name="<% $timeslot->id %>_tiebreak_set"
									class="fixedsmaller plain"
								>

									<option value=""></option>
%									foreach my $tiebreak_set (@tiebreak_sets) {
										<option
											value="<% $tiebreak_set->id %>"
											<% 	$round
												&& $round->tiebreak_set
												&& $round->tiebreak_set->id == $tiebreak_set->id ? "selected" : ""
											%>
										>
											<% ucfirst($tiebreak_set->name) %>
										</option>
%									}
								</select>
							</div>
						</td>

%						if (scalar @sites > 1) {

							<td class="centeralign smallish">

								<div class = "nospace <% $hidden %> <% $timeslot->id %>" >

									<select
										name  = "<% $timeslot->id %>_site"
										class = "fixedsmaller plain"
									>

									<option value="">Select Site</option>

%										foreach my $site (@sites) {

											<option
												value="<% $site->id %>"
												<% ($round && $round->site && $site->id == $round->site->id) ? 'selected' : "" %>
											>
												<% $site->name %>
											</option>
%										}

										<option value="">No Site</option>

									</select>

								</div>

							</td>

%						} else {

							<input
								type  = "hidden"
								name  = "<% $timeslot->id %>_site"
								value = "<% $default_site %>"
							>
%						}

%						if ($type ne 'congress') {

							<td class="centeralign">

								<div class = "nospace <% $hidden %> <% $timeslot->id %>" >

									<select name="<% $timeslot->id %>_flight" class="plain">

										<option
											value="1"
											<% $round && $round->flighted == 1 ? "selected" : ""%>
										>1</option>

										<option
											value="2"
											<% $round && $round->flighted == 2 ? "selected" : ""%>
										>2</option>

										<option
											value="3"
											<% $round && $round->flighted == 3 ? "selected" : ""%>
										>3</option>

									</select>
								</div>
							</td>
%						}
%					}

				</tr>

%					if ($round > 0 && $round->tiebreak_set < 1) {

						<tr class="lird">

							<td
								colspan = "4"
								class   = "centeralign strong smallish redtext"
							>

								DANGER WILL ROBINSON!
							</td>

							<td
								colspan="3"
								class="centeralign strong smallish redtext"
							>

								<div class="strong">
									<h5 class="nospace">&#65514;&#65514;&#65514;&#65514;&#65514;&#65514;</h5>
								</div>

								Every round must have a tiebreaker set, or you
								cannot enter ballots.  (Tiebreakers are how Tabroom
								knows what scores to ask for).

								<br />
								<br />
									Please correct the red box above.
								<br />
								<br />
							</td>
						</tr>

%					}
%					$second++;
%				}
%			}

			</tbody>

		</table>

		<div class="liblrow rightalign">
			<input
				type  = "submit"
				value = "Save Rounds"
				class = "thin"
			>
		</div>

		</form>

		<p class='explain'>
			* You may not delete or move rounds that have been sectioned with
			this screen; it will delete and re-create rounds, not move them.
			If you want to move rounds on your schedule, go to the schematic
			and use the menu on the Settings tab.
		</p>

	</div>

