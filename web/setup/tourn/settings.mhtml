<%args>
	$tourn
	$person
	$tourn_settings
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $district = $tourn_settings->{"nsda_district"};

</%init>

	<div class="main">

		<h3><% $tourn->name %></h3>

		<& tabbar.mas,
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			whoami         => "settings"
		&>

		<h4>General Settings</h4>

		<form
			enctype = "multipart/form-data"
			name    = "regpack"
			action  = "settings_save.mhtml"
			method  = "post"
		>

		<input
			type  = "hidden"
			name  = "tourn_id"
			value = "<% $tourn->id %>"
		>

		<span class="pagehalf">
			<label for="require_adult_contact">
				<div class="hover row">
					<span class="fivesixth">
						Require adult contact info to register
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "require_adult_contact",
							value   => $tourn_settings->{"require_adult_contact"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

			<label for="category_adult_contact">
				<div class="hover row">
					<span class="fivesixth">
						Ask for adult contacts by category
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "category_adult_contact",
							value   => $tourn_settings->{"category_adult_contact"},
							target  => $tourn,
							smaller => 1
						&>
					</span>
				</div>
			</label>

			<label for="second_adult_contact">
				<div class="hover row">
					<span class="fivesixth">
						Ask for secondary adult contact
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "second_adult_contact",
							value   => $tourn_settings->{"second_adult_contact"},
							target  => $tourn,
							smaller => 1
						&>
					</span>
				</div>
			</label>

			<label for="eligibility_upload">
				<div class="hover row">
					<span class="fivesixth">
						Ask for eligibility documentation
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "eligibility_upload",
							value   => $tourn_settings->{"eligibility_upload"},
							target  => $tourn,
							smaller => 1
						&>
					</span>
				</div>
			</label>

%			if ($tourn_settings->{"nsda_nats"}) {

				<label for="show_jpools">
					<div class="hover row">
						<span class="fivesixth">
							Show All NonReg Pools on JCards
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "show_jpools",
								value   => $tourn_settings->{"show_jpools"},
								target  => $tourn,
								smaller => 1
							&>
						</span>
					</div>
				</label>
%			}


%			if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {

				<label for="require_hotel_form">
					<div class="hover row">
						<span class="fivesixth">
							Require hotel information to register
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "require_hotel_form",
								value   => $tourn_settings->{"require_hotel_form"},
								target  => $tourn,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

			<label for="track_reg_changes">
				<div class="hover row">
					<span class="fivesixth">
						Log registration changes
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "track_reg_changes",
							value   => $tourn_settings->{"track_reg_changes"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

			<label for="hide_codes">
				<div class="hover row">
					<span class="fivesixth">
						Hide Speaker Codes from Registrants
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "hide_codes",
							value   => $tourn_settings->{"hide_codes"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

%			unless ($district) {

				<label for="closed_entry">
					<div class="hover row">
						<span class="fivesixth">
							Closed tournament: admin staff registers
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "closed_entry",
								value   => $tourn_settings->{"closed_entry"},
								target  => $tourn,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

			<label for="hidden">
				<div class="hover row">
					<span class="fivesixth">
						Test tournament, not public.
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							value    => $tourn->hidden,
							target   => $tourn,
							property => "hidden",
							smaller  => 1,
						&>
					</span>
				</div>
			</label>

			<label for="no_waitlist_double_entry">
				<div class="hover row">
					<span class="fivesixths">
						Waitlisted entries still hit double entry limits
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "no_waitlist_double_entry",
							value   => $tourn_settings->{"no_waitlist_double_entry"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

%			if ($tourn_settings->{"ncfl"}) {

				<label for="ncfl_codes">
					<div class="hover row">
						<span class="fivesixth">
							Post Entry Codes by Diocese
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "ncfl_codes",
								value   => $tourn_settings->{"ncfl_codes"},
								target  => $tourn,
								smaller => 1,
							&>
						</span>
					</div>
				</label>
%			}

		</span>

		<span class='nospace row'>
		</span>

		<span class="pagehalf">

%			unless ($district) {

				<label for="refund_information">
					<div class="hover row">
						<span class="fivesixth">
							Ask for refund information
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "refund_information",
								value   => $tourn_settings->{"refund_information"},
								target  => $tourn,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

%				if ($tourn_settings->{"refund_information"}) {

					<label
						for   = "enable_credit"
						id    = "enable_credit_box"
					>
						<div class="hover row">
							<span class="fivesixth">
								Offer credit for next year?
							</span>

							<span class="sixth centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "enable_credit",
									value   => $tourn_settings->{"enable_credit"},
									target  => $tourn,
									smaller => 1,
								&>
							</span>
						</div>
					</label>
%				}

%				if ($tourn_settings->{"nsda_nats"} || $tourn_settings->{"nsda_ms_nats"}) {

					<div class="hover row">

						<label for="refund_judge_bond">
							<span class="fivesixth">
								Option to apply refund to judge bond
							</span>

							<span class="sixth centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "refund_judge_bond",
									value   => $tourn_settings->{"refund_judge_bond"},
									target  => $tourn,
									smaller => 1,
								&>
							</span>
						</label>
					</div>
%				}

				<div class="hover row">
					<label for="nsda_members_only">
						<span class="fivesixth">
							NSDA Paid Members only
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "nsda_members_only",
								value   => $tourn_settings->{"nsda_members_only"},
								target  => $tourn,
								smaller => 1,
							&>
						</span>
					</label>
				</div>
%			}

			<label for="publish_schools">
				<div class="hover row">
					<span class="fivesixth">
						Publish list of registered schools
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "publish_schools",
							value   => $tourn_settings->{"publish_schools"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

%			unless ($district) {

				<label for="regions">
					<div class="hover row">
						<span class="fivesixth">
							Use school regions
						</span>

						<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "regions",
								value   => $tourn_settings->{"regions"},
								target  => $tourn,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

				<label for="overall_cap">
					<div class="row">
						<span class="threequarter">
							Tournament-wide cap on entries
						</span>

						<span class="quarter centeralign">
							<input
								type  = "number"
								id    = "overall_cap"
								name  = "overall_cap"
								size  = "5"
								class = "smaller"
								value = "<% $tourn_settings->{"overall_cap"} %>"
							>
						</span>
					</div>
				</label>
%			}

			<div class="row">
				<span class="twofifth">
					School code style
				</span>

				<span class="threefifth rightalign">
					<select name="school_codes" class="fixedmed">
						<option
							value="incremental"
							<% $tourn_settings->{'school_codes'} eq "incremental" ? "selected" : "" %> >
								Incremental (AA, AB, AC...)
						</option>

						<option
							value="circuit"
							<% $tourn_settings->{'school_codes'} eq "circuit" ? "selected" : "" %> >
							Circuit codes
						</option>

						<option
							value="shortname"
							<% $tourn_settings->{'school_codes'} eq "shortname" ? "selected" : "" %> >
							Shorten school name
						</option>

						<option
							value="registrant"
							<% $tourn_settings->{'school_codes'} eq "registrant" ? "selected" : "" %> >
							Registrant choice
						</option>

						<option
							value="none"
							<% $tourn_settings->{'school_codes'} eq "none" ? "selected" : "" %> >
							None
						</option>

					</select>
				</span>
			</div>

			<div class="row">
				<span class="threequarter">
					First school code:
				</span>

				<span class="quarter centeralign">
					<input
						type  = "text"
						size  = "4"
						name  = "first_school_code"
						value = "<% $tourn_settings->{"first_school_code"} %>"
					>
				</span>
			</div>

			<label for="nonunique_entry_codes">
				<div class="row hover">
					<span class="fivesixth">
						Allow duplicate codes in different events
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "nonunique_entry_codes",
							value   => $tourn_settings->{"nonunique_entry_codes"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

			<label for="avoid_others_rooms">
				<div class="row hover">
					<span class="fivesixths">
						Do not avoid ADA rooms/Other Pools' Rooms
					</span>

					<span class="sixth centeralign">
						<& "/funclib/bool_switch.mas",
							tag     => "avoid_others_rooms",
							value   => $tourn_settings->{"avoid_others_rooms"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

		</span>

		<div class="liblrow pagefull marno rightalign">
			<input
				type  = "submit"
				value = "Save Settings"
			>
		</div>

		<h4>Online on-site registration</h4>

		<p>
			On-site registration allows schools to confirm they are on site
			online.  Schools will be marked as "in" as they register.
		</p>

<%perl>

		my $onsite_starts = $tourn_settings->{"onsite_starts"};
		$onsite_starts->set_time_zone($tz) if $onsite_starts;

		my $onsite_ends = $tourn_settings->{"onsite_ends"};
		$onsite_ends->set_time_zone($tz) if $onsite_ends;

</%perl>
		<span class='nospace row'>
		</span>


		<span class="pagehalf">

			<label for="onsite_registration">
				<div class="hover row">
					<span class="threequarter">
						Enable online registration system
					</span>

					<span class="quarter">
						<& "/funclib/bool_switch.mas",
							tag     => "onsite_registration",
							value   => $tourn_settings->{"onsite_registration"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

			<label for="onsite_only_paid">
				<div class="hover row">
					<span class="threequarter">
						Only paid schools may register
					</span>

					<span class="quarter">
						<& "/funclib/bool_switch.mas",
							tag     => "onsite_only_paid",
							value   => $tourn_settings->{"onsite_only_paid"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</div>
			</label>

			<div class="row">
				<span class="twofifths padsetting">
					Registration Packet:
				</span>

				<span class="threefifths rightalign">
%				if ($tourn_settings->{"registration_packet"}) {
					<a
						class="plain full semibold bluetext"
						href="<% $Tab::s3_url %>/<% $tourn->id %>/<% $tourn_settings->{"registration_packet"} %>">
						<% $tourn_settings->{"registration_packet"} %>
					</a>
%				} else {
					<span class="inline semibold bluetext">
						None
					</span>
%				}
				</span>
			</div>

		</span>

		<span class='nospace row'>
		</span>

		<span class="pagehalf">

			<div class="row">

				<& /funclib/datepicker.mas, id => "onsite_starts" &>

				<span class="half">
					Online registration starts
				</span>

				<span class="half centeralign">
					<input
						type  = "text"
						name  = "onsite_starts"
						id    = "onsite_starts"
						size  = "8"
						value = "<% $onsite_starts ? Tab::pickerdate($onsite_starts) : "" %>">
						@

					<&
						/funclib/timepicker.mas,
						name => "onsite_starts_time",
						time => $onsite_starts,
						size => "6"
					&>
				</span>

			</div>

			<& /funclib/datepicker.mas, id => "onsite_ends" &>

			<div class="row">

				<span class="half">
					Online registration ends
				</span>

				<span class="half centeralign">

					<input
						type  = "text"
						name  = "onsite_ends"
						id    = "onsite_ends"
						size  = "8"
						value = "<% $onsite_ends ? Tab::pickerdate($onsite_ends) : "" %>">
						@

					<& /funclib/timepicker.mas,
						name => "onsite_ends_time",
						time => $onsite_ends,
						size => "6"
					&>
				</span>

			</div>

			<div class="row">

				<span class="twofifths padsetting">
					Upload Packet
				</span>

				<span class="threefifths rightalign nospace">
					<div class="uploader thinner">

						<input
							type  = "file"
							name  = "regpack"
							style = "opacity: 0;" onchange = "uploaderName()"
							id    = "upload">

						<span
							id="filename"
							class="filename"
							style="-webkit-user-select: none;"
						>No file selected</span>

						<span
							class="action"
							style="-webkit-user-select: none;"
						>Choose File</span>

					</div>
				</span>
			</div>
		</span>

		<& "/funclib/editor.mas" &>

		<h5>Notes on onsite registration page:</h5>
		<div class="row">
			<textarea
				rows = "5"
				cols = "60"
				name = "onsite_notes"
			><% $tourn_settings->{"onsite_notes"} %></textarea>
		</div>


		<div class="liblrow truefull marno rightalign">
			<input
				type  = "submit"
				value = "Save Settings & Upload"
			>
			</form>
		</div>

<%perl>

		unless ($district) {

			my @tourns = $m->comp(
				"/funclib/person_tourns.mas",
				person => $person,
				all    => 1
			);

			if (@tourns) {

</%perl>

				<h4>Copy settings</h4>

				<p>
					Copies setup, events, judge categories, etc from a previous
					tournament.  Do this only to a new tournament; it will
					duplicate any existing events or judge categories you may
					already have set up
				</p>

				<form action="import.mhtml" method="post">

				<div class="even full nospace">

					<span class="third">

						<select name="clone" class="fixedmed chosen">

							<option value="">None: Create tournament from scratch</option>

%						   	foreach my $otourn (@tourns) {

%								next if $otourn->id == $tourn->id;
								<option
									value="<% $otourn->id %>"
									> <%
										$otourn->start->year
											%> <%
										substr($otourn->name,0,40)
									%> </option>
%							}

						</select>
					</span>

%					my $warn = "This option will erase all schools, options, events, judge categories, etc and replace them with the cloned tournament.  Are you sure?";

					<label for="erase">

						<span class="fifth centeralign hover smallish marno">
							Erase current
							<input
								type  = "checkbox"
								name  = "erase"
								id    = "erase"
								value = "1"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
						</span>
					</label>

%					$warn = "This option will import the previous tournament's	entries, judges and schools.  Are you sure?";

					<label for="entries">

						<span class="fifth centeralign hover smallish marno">

							Include Entries

							<input
								type  = "checkbox"
								name  = "entries"
								id    = "entries"
								value = "1"
								<& "/funclib/confirm.mas", warn => $warn &>
							>
						</span>
					</label>

					<span class="fifth rightalign">
						<input
							type  = "submit"
							value = " Clone "
							class = "thin"
						>
					</span>

				</div>
				</form>
%			}

%		}

%		if ($person->site_admin) {

			<h4>Rarely Used Options</h4>

			<p>
				The options below are reserved for site admins to activate
				particular custom tournaments. Please do not enable them or
				Really Weird Things will start happening to your tournament.
				You've been warned.
			</p>

			<div class="row">

				<label for = "nsda_nats" >
					<span class="twofifths">
						NSDA Nationals
					</span>
					<span class="tenth">
						<& "/funclib/bool_switch.mas",
							tag     => "nsda_nats",
							value   => $tourn_settings->{"nsda_nats"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</label>

				<label for="mailing_address">
					<span class="twofifths">
						Ask for Mailing Address
					</span>
					<span class="tenth">
						<& "/funclib/bool_switch.mas",
							tag     => "mailing_address",
							value   => $tourn_settings->{"mailing_address"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</label>
			</div>

			<div class="row">
				<label for="nsda_ms_nats">
					<span class="twofifths">
						NSDA Middle School Nationals
					</span>
					<span class="tenth">
						<& "/funclib/bool_switch.mas",
							tag     => "nsda_ms_nats",
							value   => $tourn_settings->{"nsda_ms_nats"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</label>

				<label for="nsda_billing">
					<span class="twofifths">
						Non-nationals using NSDA Billing System
					</span>
					<span class="tenth">
						<& "/funclib/bool_switch.mas",
							tag     => "nsda_billing",
							value   => $tourn_settings->{"nsda_billing"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</label>
			</div>

			<div class="row">
				<label for="wsdc">
					<span class="twofifths">
						Worlds Schools Debate Championships
					</span>
					<span class="tenth">
						<& "/funclib/bool_switch.mas",
							tag     => "wsdc",
							value   => $tourn_settings->{"wsdc"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</label>

				<label for="legion">
					<span class="twofifths">
						American Legion Oratorical Contest
					</span>
					<span class="tenth">
						<& "/funclib/bool_switch.mas",
							tag     => "legion",
							value   => $tourn_settings->{"legion"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</label>
			</div>

			<div class="row">

				<label for="ncfl">
					<span class="twofifths">
						NCFL Grand Nationals
					</span>
					<span class="tenth">
						<& "/funclib/bool_switch.mas",
							tag     => "ncfl",
							value   => $tourn_settings->{"ncfl"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</label>

				<label for="ceda_nationals">
					<span class="twofifths">
						CEDA Nationals
					</span>
					<span class="tenth">
						<& "/funclib/bool_switch.mas",
							tag     => "ceda_nationals",
							value   => $tourn_settings->{"ceda_nationals"},
							target  => $tourn,
							smaller => 1,
						&>
					</span>
				</label>
			</div>

			<div class="row">
				<span class="twofifths">
					NSDA District Qualifier for:
				</span>
				<span class="tenth">
					<input
						type  = "number"
						id    = "nsda_district"
						name  = "nsda_district"
						size  = "5"
						value = "<% $district %>"
					>
				</span>

				<span class="twofifths">
					NSDA District Level Override:
				</span>
				<span class="tenth">
					<input
						type  = "number"
						id    = "nsda_district_level_force"
						name  = "nsda_district_level_force"
						size  = "5"
						value = "<% $tourn_settings->{"nsda_district_level_force"} %>"
					>
				</span>
			</div>

			<div class="liblrow truefull marno rightalign">
				<input
					class = "thin"
					type  = "submit"
					value = "I have read the above warning.  Save these weird settings anyway."
				>
				</form>
			</div>
%		}

	</div>

