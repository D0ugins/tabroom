<%args>
	$person
	$tourn
	$tourn_settings
	$perms
	$event_id => undef
</%args>
<%init>

	my %admin_perms = ();
	my @admins;

	my $event; 
	my @events = $tourn->events;

	if ($perms->{"details"}) { 

		@events = $m->comp("/funclib/event_perms.mas", 
			events => \@events,
			perms  => $perms,
			type   => 'admin'
		);

		$event = $events[0] if scalar @events == 1;

	} else { 
		$event = Tab::Event->retrieve($event_id) if $event_id;
	}

	if (@events) { 
		$event = $events[0] unless $event; 
	}

	if ($event) { 

	foreach my $perm (
		Tab::Permission->search(
			tourn => $tourn->id,
			tag   => "detailed"
		)
	) { 

		my $admin = $perm->person();
	
		$admin_perms{$admin->id} = eval { 
			JSON::decode_json($perm->details);
		};

		if ($admin_perms{$admin->id}{$event->id}) { 
			push @admins, $admin;
		}

	}

	@admins = 
		sort {
			$admin_perms{$b->id}{$event->id}
			cmp $admin_perms{$a->id}{$event->id}
		} @admins;

	}

    my %links = (
		"overall" => "access.mhtml",
		"by_event" => "event_access.mhtml"
	);

</%init>

	<script type="text/javascript">

		function concealGreens (id, type) { 
			$(".leveler_"+id).removeClass('green', "fold");
			$("#"+id+"_"+type+"box").addClass('green');
		}

        function showLimits (it, radio, type) { 
			concealGreens(it, type);
        } 

        function hideLimits (it, radio, type) { 
			concealGreens(it, type);
		}
    </script>

	<div class="main">

		
		<h2><% $tourn->name %></h2>

%		unless ($perms->{"details"}) { 
			<& "tabbar.mas", 
				tourn          => $tourn,
				tourn_settings => $tourn_settings,
				whoami         => "access"
			&>
%		}

		<span class="half">
			<h4><% $event ? $event->abbr : "" %> permissions</h4>
		</span>

		<span class="third centeralign">
%		unless ($perms->{"details"}) { 
			<&
				"/funclib/tabs.mas",
					links   => \%links,
					default => "by_event",
					center  => "yes",
					buttons => "yes",
					reverse => "yes"
			&>
%		}
		</span>

		<span 
			id    = "event_access_buttonarea"
			class = "sixth rightalign"
		></span>

%		if ($event) { 
%			if (@admins) { 

				<& "/funclib/tablesorter.mas", 
					table => "event_access"
				&>

				<form 
					action = "event_access_save.mhtml"
					method = "post"
				>

				<input 
					type  = "hidden"
					name  = "event_id"
					value = "<% $event->id %>"
				>

				<table id="event_access">
		
					<thead>

						<tr class="yellowrow">
						
							<th class="smallish">	
								Person
							</th>

							<th class="smallish">
								Email
							</th>

							<th class="smallish">
								Access Level
							</th>

							<th class="smaller">
							</th>
						
						</tr>

					</thead>

					<tbody>

%	 					foreach my $admin (@admins) { 

%							my $perm = $admin_perms{$admin->id}{$event->id};

							<tr id = "<% $admin->id %>" >
			
								<td
									title = "<% $admin->email %>"
									class = "limit smallish hover"
								>
									<% $admin->first." ".$admin->last %>
								</td>

								<td>
									<% $admin->email %>
								</td>

								<td class="centeralign padno smallish">

									<span class="hidden">  <!-- for sorting -->
										<% $admin_perms{$admin->id}{$event->id} %>
									</span>

									<label for="<% $admin->id %>_admin">
										<span 
											id    = "<% $admin->id %>_adminbox"
											class = "fourtenths padless marno hover leveler_<% $admin->id %> 
											<% $admin_perms{$admin->id}{$event->id} eq "admin"
												? 'green' 
												: "" 
											%>"
										>
											Event Admin

											<input 
												type    = "radio"
												id      = "<% $admin->id %>_admin"
												name    = "<% $admin->id %>_level"
												value   = "admin"
												onclick = "concealGreens(<% $admin->id %>, 'admin')"
												<% $admin_perms{$admin->id}{$event->id} eq "admin"
													? 'checked="checked"' 
													: ""
												%>
											>
										</span>
									</label>

									<label for="<% $admin->id %>_entry">
										<span 
											id    = "<% $admin->id %>_entrybox"
											class = "fourtenths padless marno hover leveler_<% $admin->id %>
											<% $admin_perms{$admin->id}{$event->id} eq "entry"
												? 'green' 
												: "" 
											%>"
										>
										Entry Only <input 
											type    = "radio"
											id      = "<% $admin->id %>_entry"
											name    = "<% $admin->id %>_level"
											value   = "entry"
											onclick = "concealGreens(<% $admin->id %>, 'entry')"
											<% $admin_perms{$admin->id}{$event->id} eq "entry"
												? 'checked="checked"' 
												: ""
											%>
										>
										</span>
									</label>

								</td>

								<td class="centeralign nospace smallish">
									<a 
										class="redtext button buttonwhite fa fa-lg fa-trash" 
										href="access_rm.mhtml?admin_id=<% $admin->id %>"
									></a>
								</td>

							</tr>
%						}

					<tbody>

				</table>

				<div class="libl full rightalign marno">
					<input type="submit" value="Save Permissions">
				</div>

				</form>
%			}

%		}

	</div>

	<div class="menu">

%		if (@events) { 

			<div class="sidenote">
				
				<h4>Choose Event</h4>

				<form 
					action = "event_access.mhtml"
					method = "post"
				>

				<div class="full even centeralign">

					<select 
						name     = "event_id"
						class    = "fixedmed"
						onChange = "this.form.submit();"
					>

					<option value=""></option>
%					foreach my $oevent (@events) { 
						<option 
							value="<% $oevent->id %>"
							<% $oevent == $event ? "selected" : "" %>
						><% $oevent->abbr %> <% $oevent->name %></option>
%					}

					</select>

				</div>

				</form>

			</div>
%		}

%		if ($event) { 

		<div class="sidenote">

			<h4>Add New Staff:</h4>

			<form 
				action = "event_access_add.mhtml"
				method = "post"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn %>"
			>

			<input 
				type  = "hidden"
				name  = "event_id"
				value = "<% $event->id %>"
			>

			<div class="row centeralign padmuchmore">
				<input 
					type        = "text"
					name        = "email"
					size        = "28"
					placeholder = "Email address"
				>
			</div>

			<div class="libl marno padmore rightalign">
				<input  
					type  = "submit"
					value = "Grant Access"
				>
			</div>

			</form>

		</div>
%		}

	</div>

