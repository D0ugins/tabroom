<%args>
	$tourn
	$tourn_settings
	$person
</%args>
<%init>

	my $carts = $tourn_settings->{"store_carts"};
	my $invoice_key = 1;

	foreach my $key (keys %{$carts}) {
		$invoice_key = $key + 1;
	}

	my $now = DateTime->now();

	$carts->{$invoice_key}{"creator"}    = $person->id;
	$carts->{$invoice_key}{"created_at"} = $now->datetime;
	$carts->{$invoice_key}{"tabroom"}    = $ARGS{"tabroom_request"};
	$carts->{$invoice_key}{"nc"}         = $ARGS{"nc_request"};
	$carts->{$invoice_key}{"nco"}        = $ARGS{"nco_request"};

	my $json = JSON::encode_json($carts);

	$tourn->setting("store_carts", "json", $carts);

</%init>

	<!-- This feels like a real Bruschke move but it's what I got today -->

	<script>

		async function populateCart() {

			var cartId;
			var baseUrl = "<% $Tab::nsda_store_api %>";
			var cartUrl = "<% $Tab::nsda_store_redirect %>";
			var keys    = ["tabroom", "nc", "nco"];

			var requests = {
				tabroom : "<% $ARGS{'tabroom_request'} ? $ARGS{'tabroom_request'} : "0" %>",
				nc      : "<% $ARGS{'nc_request'} ? $ARGS{'nc_request'} : "0" %>",
				nco     : "<% $ARGS{'nco_request'} ? $ARGS{'nco_request'} : "0" %>"
			};

			var codes = {
				tabroom : "<% $Tab::nsda_product_codes->{"tabroom"} %>",
				nc      : "<% $Tab::nsda_product_codes->{"campus"} %>",
				nco     : "<% $Tab::nsda_product_codes->{"campus_observers"} %>"
			};

			await keys.reduce(async (i, key) => {

				await i;

				if (requests[key] > 0) {

					var postUrl = baseUrl;

					if (cartId) {
						postUrl = postUrl + "?cart_key=" + cartId;
					}

					var postData = {
						id        : codes[key],
						quantity  : requests[key],
						item_data : {
							addons: [
								{ name: "Tournament", value: "<% $tourn->id %>"},
								{ name: "Invoice", value: "<% $tourn->id."-".$invoice_key %>"}
							]
						}
					};

					await $.ajax({
						type          : 'POST',
						url           : postUrl,
						contentType   : 'application/json',
						dataType      : "json",
						data          : JSON.stringify(postData),
						success : function(data) {
							cartId = data.cart_key;
							console.log("success!  cart key is "+cartId);
							$("."+key).removeClass("hidden");
						},
						failure : function(msg) {
							console.log("Failure to post: "+msg);
						}
					});

				} else {
					await console.log("No request found for "+key);
				}

				return;

			}, undefined).then(async function() {

				if (cartId) {

					await $.ajax({
						type          : 'POST',
						url           : '/setup/tourn/payment_cart.mhtml',
						data          : {
							target_id : '<% $invoice_key %>',
							cart_id   : cartId
						},
						success : function(data) {
							console.log("success!");
						},
						failure : function(msg) {
							console.log("Failure to post: "+msg);
						}
					}).then(function() {
						window.location.href = cartUrl + cartId;
					});
				}

			});

		};

		$(document).ready( function() {
			populateCart();
		});

	</script>

	<div class="blankfull">

		<h3>Creating your cart & redirecting to the NSDA store</h3>

		<p class="rightalign orangetext semibold bigger italic">
			This process takes a minute.
		</p>
		<p class="rightalign redtext semibold bigger italic">
			Please do not leave or refresh this page.
		</p>

		<div class="full nospace odd martopmore">

			<span class="quarter dkblue padvert marno">
			</span>

			<span class="quarter hidden tabroom dkblue padvert marno">
			</span>

			<span class="quarter hidden nc dkblue padvert marno">
			</span>

			<span class="quarter hidden nco dkblue padvert marno">
			</span>
		</div>

	</div>
