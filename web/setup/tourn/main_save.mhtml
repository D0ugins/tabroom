<%args>
	$tourn
	$person
	$name
	$webname   => undef
	$country   => undef
	$city      => undef
	$state     => undef
	$timezone  => undef
	$currency  => undef
	$papersize => undef
</%args>
<%init>

	$name =~ tr/a-zA-Z0-9 //cd;

	my $now = DateTime->now;

	# Do not put this year into the friggin tournament name.

	my $year = $now->year;

	$name =~ s/$year++//g;
	$name =~ s/$year//g;
	$name =~ s/  / /;
	$name =~ s/^\s+//;
	$name =~ s/\s+$//;

	$tourn->name($name);
	$tourn->country($country);
	$tourn->city($city);
	$tourn->state($state);
	$tourn->tz($timezone);
	$tourn->update;

	$tourn->setting("currency", $currency);
	$tourn->setting("papersize", $papersize);

	if ($webname) { 

        #Remove all the whitespace
        $webname =~ s/ //g;
        #Remove all non-alphanumeric characters
        $webname =~ s/[^\w]//g;
        #Lowercase the whole thing
        $webname = lc($webname);

		my $year = $now->year;

		#People never read anything.
		$webname =~ s/$year++//g;
		$webname =~ s/$year//g;

		if ($webname eq int($webname)) { 
			my $err = "Web names cannot consist only of numbers. <br /> Your quest: choose another!";
			$m->redirect("main.mhtml?err=$err");
		}

		my @others = Tab::Tourn->search(
			webname => $webname
		);

		my $ok++ unless @others;

		OTHER:
		foreach my $other (@others) { 

			my $ownership = Tab::Permission->search( 
				tag    => "owner",
				person => $person->id,
				tourn  => $other->id
			)->first;

			$ok++ if $ownership;
			last if $ok;
		}

		unless ($ok || $person->site_admin) { 
			my $err = "The webname $webname is already taken by another user.  <br /> Thou must needst choose another";
			$m->redirect("main.mhtml?err=$err");

		}

		$tourn->webname($webname);
		$tourn->update;

	}

	$m->comp("/funclib/update_calendar.mas", tourn => $tourn);

	my $msg = "Tournament name saved";

	$m->redirect("main.mhtml?msg=$msg");

</%init>
