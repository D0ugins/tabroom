<%args>
	$tourn
	$tourn_settings
	$method
	$person
</%args>
<%init>

	my $msg;
	my $err;

	my @settings = (
		"nsda_pilot_speech",
		"nsda_pilot_debate"
	);

	foreach my $setting (@settings) {

		my $arg = $ARGS{$setting};
		$arg = 0 unless $arg;
		$tourn->setting($setting, $arg);

		$setting =~ "s/nsda_//";

		if ($arg) {
			$m->comp("/funclib/log.mas",
				tourn       => $tourn->id,
				type        => "districts",
				person      => $person->id,
				description => "Pilot setting ".$setting." marked enabled"
			);
		} else {
			$m->comp("/funclib/log.mas",
				tourn       => $tourn->id,
				type        => "districts",
				person      => $person->id,
				description => "Pilot setting ".$setting." marked disabled"
			);
		}

		$msg .= "<br />" if $msg;
		$msg .= "Pilot rules chosen for ".$setting;
	}

	if ($ARGS{"nsda_pilot_speech"}) {

		$tourn->setting("nsda_speech_method", 0);

	} else {

		if ($method &&
			($method eq "doubledown"
			|| $method eq "california_3"
			|| $method eq "california_2")
		) {

			unless ($method eq $tourn_settings->{"nsda_speech_method"}) {

				$m->comp("/funclib/log.mas",
					tourn       => $tourn->id,
					type        => "districts",
					person      => $person->id,
					description => "IE Rules changed to ".$method
				);

				$msg .= "<br />" if $msg;
				$msg .= "IE Rules changed to ".$method;
				$tourn->setting("nsda_speech_method", $method);
			}
		}

		unless ($method) {

			$m->comp("/funclib/log.mas",
				tourn       => $tourn->id,
				type        => "districts",
				person      => $person->id,
				description => "NO IE RULES SELECTED"
			);

			$err = "You have selected the traditional rulebook but not selected an IE ruleset!";
			$tourn->setting("nsda_speech_method", 0);
		}
	}

	unless ($ARGS{"nsda_strikes"} eq $tourn_settings->{"nsda_strikes"}) {

		$m->comp("/funclib/log.mas",
			tourn       => $tourn->id,
			type        => "districts",
			person      => $person->id,
			description => "District tournament strikes enabled"
		);

		$msg .= "<br />" if $msg;
		$msg .= "Strikes were enabled";
		$tourn->setting("nsda_speech_method", 0);
	}

	$m->comp("/funclib/district_tiebreakers.mas", tourn => $tourn, person => $person);

	unless ($ARGS{"software"} eq $tourn_settings->{"nsda_tabbing_software"}) {

		$tourn->setting("nsda_tabbing_software", lc($ARGS{"software"})) if $ARGS{"software"};
		$msg .= "<br />" if $msg;
		$msg .= "Software set to ".$ARGS{"software"};

		$m->comp("/funclib/log.mas",
			tourn       => $tourn->id,
			type        => "districts",
			person      => $person->id,
			description => "Software set to ".uc($ARGS{"software"})
		);
	}

	$m->redirect("main.mhtml?err=$err&msg=$msg");

</%init>
