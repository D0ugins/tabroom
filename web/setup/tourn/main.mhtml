<%args>
	$tourn
	$person
	$person_settings
	$tourn_settings
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "America/New_York" unless $tz;

</%init>

	<div class=" main">

		<h2><% $tourn->name %></h2>

		<& "tabbar.mas",
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			whoami         => "main"
		&>

		<h4>Name & Location</h4>

			<div class="row">

				<span class="third">
					Tournament Full Name 
				</span>

				<span class="twothird">

					<form
						action="main_save.mhtml" 
						method="post"
					>

					<input 
						type  = "text"
						name  = "name"
						size  = "64"
						value = "<% $tourn->name %>">
				</span>

			</div>

			<div class="row">

				<span class="third">
					Tournament public site
				</span>

				<span class="twothird">

%					if ($tourn_settings->{"nsda_district"}) { 

						<a 
							class  = "full hover"
							target = "_blank"
							href   = "http://<% $tourn->webname %>.tabroom.com"
						>
							http://<% $tourn->webname %>.tabroom.com
						</a>

%					} else { 

						<input 
							type  = "text"
							name  = "webname"
							size  = "16"
							value = "<%  $tourn->webname  %>"
						>

						<div class="smallish">
							<a  href   = "http://<% $tourn->webname %>.tabroom.com"
								class  = "inline bluetext strong"
								target = "_blank"
							>
								http://<% $tourn->webname %>.tabroom.com
							</a>
							
							will direct to your tournament Tabroom site.<br />

							Keep it short &amp; memorable, and re-use it from
							one year to the next; that way previous years
							results will appear on your page.

						</div>

%					} 

				</span>

			</div>

			<div class="row">

				<span class="third">
					City/Location:
				</span>

				<span class="twothird">

					<form 
						action="main_save.mhtml" 
						method="post"
					>

					<input 
						type  = "text"
						name  = "city"
						size  = "32"
						value = "<% $tourn->city %>"
					>
				</span>

			</div>


			<div class="row">

				<span class="third">
					Location State (if applicable)
				</span>

				<span class="twothird ">
					<select 
						name  = "state"
						class = "chosen fixed"
					>

						<& 
							"/funclib/state_select.mas", 
							state => $tourn->state 
						&>

					</select>

				</span>

			</div>

			<div class="row">

				<span class="third">
					Location Country
				</span>

				<span class="twothird ">
					<select 
						name  = "country"
						class = "chosen fixed"
					>

					<& 
						"/funclib/country_select.mas", 
						country => $tourn->country 
					&>
					</select>
				</span>

			</div>

			<div class="row">

				<span class="third">
					Time Zone
				</span>

				<span class="twothird ">
					<select name="timezone" 
					class="chosen fixed">
					<& "/funclib/timezones.mas", tz => $tz &>
					</select>
				</span>

			</div>

%			my $currency = $tourn_settings->{'currency'};

			<div class="row">

				<span class="third">
					Currency Symbol
				</span>

				<span class="twothird">
					<input 
						type  = "text"
						name  = "currency"
						size  = "5"
						value = "<% $currency ? $currency : '$' %>">
				</span>

			</div>

%			my $papersize = $tourn_settings->{'papersize'};

			<div class="row">

				<span class="third">
					Paper Size
				</span>

				<span class="twothird ">

					<select name="papersize" class="fixedsmall chosen">

						<option 
							value="letter" 
							<% $papersize eq "letter" ? 'selected' : "" %>
						> Letter (US) </option>

						<option 
							value="a4" 
							<% $papersize eq "a4" ? 'selected' : "" %>
						> A4 </option>

					</select>
				</span>

			</div>


			<div class=" liblrow rightalign marno"> 
				<input  
					type="submit" 
					value="Save Tournament Info"
				>
				</form>
			</div>

		</table>

		<span class="half top">

%			if ($tourn_settings->{"nsda_district"}) { 

				<h6 class="header">
					National Speech &amp; Debate Association
				</h6>

				<div class="full row centeralign marno">

				<h5>District qualifier for:</h5>

%				my $district = Tab::District->retrieve($tourn_settings->{"nsda_district"});

				<p class="padmuchmore">
					#<% $district->code %> <% $district->name %>
					<% $district->location ? "(".$district->location.")" : "" %>
				</p>

				</div>

%				if ($person->site_admin || $person_settings->{"nsda_admin"}) { 

					<form 
						action = "switch_nsda_method.mhtml"
						method = "post"
					>

%						my @softwares = ("Tabroom", "JOT");
%						my @methods = ("doubledown", "california_3", "california_2");

						<div class="full row centeralign padmuchmore marno">

							<h5 class="padbottom">
								Tabbing Software:
							</h5>

							<span class="fourfifths">

								<select 
									name  = "software"
									class = "fixedmed"
								>

%									foreach my $software (@softwares) { 
										<option 
											value="<% lc($software) %>"
											<% lc $software eq $tourn_settings->{"nsda_tabbing_software"} 
												? 'selected="selected"' 
												: ""
											%>
										> <% $software %></option>
%									}
								</select>

							</span>

							<span class="fifth">
								<input 
									type  = "submit"
									value = "Save"
									class = "thin"
								>
							</span>
						</div>

						<div class="full row centeralign padmuchmore marno">

							<h5 class="padbottom">
								IE Method:
							</h5>

							<span class="fourfifths">

								<select name="method" class="fixedmed">

%									foreach my $method (@methods) { 
										<option 
											value="<% $method %>"
											<% $method eq $tourn_settings->{"nsda_speech_method"} 
												? 'selected="selected"' 
												: ""
											%>
										> <% ucfirst $method %></option>
%									}

								</select>

							</span>

							<span class="fifth">
								<input 
									type  = "submit"
									value = "Save"
									class = "thin"
								>
							</span>

							</form>

						</div>

%				} else { 

					<div class="full row centeralign padmuchmore marno">

						<h5 class="padbottom">
							IE Method:
						</h5>

%					if ($tourn_settings->{"nsda_speech_method"} eq "california_3") { 

						California Plan (3 Judges)

%					} elsif ($tourn_settings->{"nsda_speech_method"} eq "california_2") { 
				
						California Plan (2 Judges)

%					} elsif ($tourn_settings->{"nsda_speech_method"} eq "doubledown") {

						Double-drop  
%					}

					</div>
%				}


%			} else { 
			
			
				<h5>Circuits</h5>

<%perl>

				my @approved = $m->comp(
					"/funclib/tourn_circuits.mas", 
					tourn => $tourn
				);

				my @pending = $m->comp(
					"/funclib/tourn_circuits.mas", 
					tourn	  => $tourn,
					unapproved => 1
				);

</%perl>

%				if (@approved) { 
					<p class="strong">Approved for the following circuit calendars:</p>
%				}

<%perl>
				my %circuit_used;

				foreach my $circuit (@approved) { 

					next if $circuit_used{$circuit->id}++;

</%perl>
					<form 
						action="circuit_add.mhtml" 
						method="post"
					>

					<input 
						type  = "hidden"
						name  = "tourn_id"
						value = "<% $tourn->id %>"
					>

					<div class="full row">

						<span class="twothird smallish">
							<% $circuit->name %>
						</span>

%						unless ($circuit->setting("tourns_no_add") &! ($person->site_admin)) { 
							<span class="third rightalign nospace">
								<a 
									class="redtext button buttonwhite fa fa-trash fa-lg" 
									href="circuit_rm.mhtml?circuit_id=<% $circuit->id %>">
								</a>
							</span>
%						}

					</div>
							
%				}

%				if (@pending) { 
					<p class="redtext strong">Approval still pending:</p>
%				}


%				foreach my $circuit (@pending) { 

%					next if $circuit->setting("tourns_no_add") &! $person->site_admin;
%					next if $circuit_used{$circuit->id}++;

					<div class="full row">

						<span class="twothird smallish">
							<% $circuit->name %>
						</span>

						<span class="third rightalign nospace">

							<a 
								class = "buttonwhite fa fa-lg hover redtext fa-trash"
								href  = "circuit_rm.mhtml?circuit_id=<% $circuit->id %>"
							>
							</a>
						</span>

					</div>

%				}

				<form action="circuit_add.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "chapter_id"
					value = "<% $tourn->id %>"
				>

				<div class="libl full">
				
					<span class="twothird centeralign">
						<select name="circuit_id" class="fixedmed">

<%perl>
							foreach my $circuit (
								sort {$a->name cmp $b->name} 
								Tab::Circuit->search( active => 1)
							) { 
								next if $circuit->setting("tourns_no_add") &! $person->site_admin;
								next if $circuit_used{$circuit->id};
</%perl>
								<option value="<% $circuit->id %>"> <% $circuit->name %> </option>
%							}

						</select>
					</span>

					<span class="third rightalign">
						<input type="submit" value="Add" class="thin">
						</form>
					</span>
				</div>

%			}

		</span>

		<span class="half">
		
			<h5>Invitation</h5>

			<div class="row full"> 

				<span class="twothird centeralign">

					<div class="uploader">

						<form 
							enctype  = "multipart/form-data"
							onsubmit = "return uploadThis();"
							name	 = "invite"
							action   = "invite_upload.mhtml"
							method   = "post"
						>

						<input 
							type     = "file"
							name     = "invite"
							style    = "opacity: 0;"
							onchange = "uploaderName('invite', 'invite_file');"
							id       = "invite"
						>

						<span 
							id    = "invite_file"
							class = "filename"
							style = "-webkit-user-select: none;"
						>No file selected</span>

						<span 
							class = "action"
							style = "-webkit-user-select: none;"
						>Choose File</span>

					</div>
				</span>

				<span class="third rightalign">
					<input 
						type  = "submit"
						class = "thin"
						value = "Upload"
					>
					</form>
				</span>
			</div>

			<h5>Congress Packet</h5>

			<div class="row full"> 

				<span class="twothird centeralign">
					<div class="uploader">
						<form 
							enctype  = "multipart/form-data"
							onsubmit = "return uploadThis();"
							name	 = "bills"
							action   = "bills_upload.mhtml"
							method   = "post"
						>

						<input 
							type	 = "file"
							name	 = "bills"
							style	= "opacity: 0;"
							onchange = "uploaderName('bills', 'bill_file')"
							id	   = "bills"
						>

						<span 
							id	= "bill_file"
							class = "filename"
							style = "-webkit-user-select: none;"
						>No file selected</span>

						<span 
							class = "action"
							style = "-webkit-user-select: none;"
						>Choose File</span>
					</div>
				</span>

				<span class="third rightalign">
					<input  
						type  = "submit"
						class = "thin"
						value = "Upload"
					>
					</form>
				</span>
			</div>

			<h5>Tournament Logo</h5>

			<div class="row full"> 

				<span class="twothird centeralign">
					<div class="uploader">

						<form 
							enctype  = "multipart/form-data"
							onsubmit = "return uploadThis()"
							name	 = "logo_image"
							action   = "logo_upload.mhtml"
							method   = "post"
						>

						<input 
							type	 = "file"
							name	 = "logo_image"
							style 	 = "opacity: 0;"
							id	   = "logo_image"
						>

						<span 
							id	= "logo_image_file"
							class = "filename"
							style = "-webkit-user-select: none;"
						>No file selected</span>

						<span 
							class = "action"
							style = "-webkit-user-select: none;"
						>Choose File</span>
					</div>
				</span>

				<span class="third rightalign">
					<input 
						id    = "logo-submit"
						type  = "submit"
						class = "thin"
						value = "  Upload  "
						disabled
					>
					</form>
				</span>
			</div>

			<script>
				(function() { 
					//This is ugly and bad -  a FileReader() and transmuatation may be more appropriate
					$('#logo_image').change(() => {
						getImageType($('#logo_image')[0]);
					});

					function getImageType(i) {
						if (i.files && i.files[0]) {
							var e = i.files[0].name.split('.').pop().toLowerCase();

							//ADD FILETYPES HERE
							var s = ['png', 'jpg', 'jpeg'].indexOf(e) > -1; 
							
							if (s) {
								uploaderName('logo_image', 'logo_image_file');
								unlockUpload();
							} else {
								alertify.warning("Tournament images must be in JPG or PNG format");
							}
						}
					}

					function unlockUpload() {
						$('#logo-submit').removeAttr('disabled');
					}
				})();
			</script>



%			if ($tourn_settings->{"nsda_ms_nats"} || $tourn_settings->{"nsda_nats"}) { 

				<h5>Per-Entry Release Forms</h5>

				<div class="row full"> 

					<span class="twothird centeralign">

						<div class="uploader">

							<form 
								enctype  = "multipart/form-data"
								onsubmit = "return uploadThis()"
								name	 = "entry_release_form"
								action   = "entry_release_upload.mhtml"
								method   = "post"
							>

							<input 
								type	 = "file"
								name	 = "entry_release_form"
								style	= "opacity: 0;"
								onchange = "uploaderName('entry_release_form', 'entry_release_form_file')"
								id	   = "entry_release_form"
							>

							<span 
								id	= "entry_release_form_file"
								class = "filename"
								style = "-webkit-user-select: none;"
							>No file selected</span>

							<span 
								class = "action"
								style = "-webkit-user-select: none;"
							>Choose File</span>
						</div>
					</span>

					<span class="third rightalign">
						<input  
							type  = "submit"
							class = "thin"
							value = "  Upload  "
						>
						</form>
					</span>
				</div>

%			}

		</div>

	</span>

	<div class=" menu">

<%perl>
 		if (
			$tourn_settings->{"invite"} 
			|| $tourn_settings->{"bills"} 
			|| $tourn_settings->{"logo"} 
			|| $tourn_settings->{"entry_release"} 
		) { 
</%perl>

			<div class=" sidenote"> 

%				if ($tourn_settings->{"logo"}) { 

%					my $logo_file = $tourn_settings->{"logo"};

					<h4>Logo</h4>

					<div class=" centeralign">
						<img 
							src   = "<% $Tab::s3_url %>/<% $tourn->id."/".$logo_file %>"
							alt   = "<% $logo_file %>"
							style = "max-width: 220px;"/
						>
					</div>

					<a 
						class = "yellow martopmore full"
						href  = "logo_delete.mhtml"
					>
						<span class="quarter centeralign fa fa-trash redtext"></span>
						Delete Logo
					</a>
%				}

<%perl>
 				if (
					$tourn_settings->{"invite"} 
					|| $tourn_settings->{"bills"} 
					|| $tourn_settings->{"entry_release"}
				) { 
</%perl>
					<h4>Files posted:</h4>

%		 			if ($tourn_settings->{"invite"}) {

						<a 
							class  = "blue half "
							href   = "<% $Tab::s3_url %>/<% $tourn->id %>/<% $tourn_settings->{"invite"} %>"
							target = "_blank"
						>
							<span class="quarter centeralign fa fa-file-o bluetext"></span>
							Posted Invite
						</a>
						
						<a 
							class = "yellow half"
							href  = "invite_delete.mhtml"
						>
							<span class="quarter centeralign fa fa-trash redtext"></span>
							Delete Invite
						</a>
%					}

%  					if ($tourn_settings->{"bills"}) {

					 	<a 
							class  = "blue half "
							href   = "<% $Tab::s3_url %>/<% $tourn->id."/bills/".$tourn_settings->{"bills"} %>"
							target = "_blank"
						>
							<span class="quarter centeralign fa fa-file-o bluetext"></span>

							Posted Bills
						</a>
						
						<a 
							class = "yellow half"
							href  = "bills_delete.mhtml"
						>
							<span class="quarter centeralign fa fa-trash redtext"></span>
							Delete Bills
						</a>
%   				} 

%  					if ($tourn_settings->{"entry_release"}) {

					 	<a 
							class  = "blue half"
							href   = "<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$tourn_settings->{"entry_release"} %>"
							target = "_blank"
						>
							<span class="quarter centeralign fa fa-file-o bluetext"></span>

							Entry Release
						</a>
						
						<a 
							class = "yellow half"
							href  = "entry_release_delete.mhtml"
						>
							<span class="quarter centeralign fa fa-trash redtext"></span>
							Delete Release
						</a>
%   				} 

%  				} 

			</div>
% 		} 

		<div class="sidenote">

			<h4> 
				NSDA Services
			</h4>

			<div class="full bigger">
				Interested in saving time &amp; hassle by purchasing 
				<a 
					class  = "padno marno strong"
					href   = "http://www.speechanddebate.org/ExtempQuestionsService"
					target = "_blank"
				>Extemp Questions</a> 
				
				or 
					<a 
						class  = "padno marno strong"
						href   = "http://www.speechanddebate.org/trophyshop"
						target = "_blank"
					>Trophies</a>?  

			</div>

			<div class="full bigger">
				The National Speech &amp; Debate Association has
				affordably priced trophies and extemp questions
				available to purchase for your tournament.
			</div>

		</div>

		<div class="sidenote bigger"> 

			<h4>Notes</h4>

			<p class="bigger">
				Your webname must be unique to your tournament, and in all
				lowercase letters or numbers, no punctuation.  Don't include
				the year; web names can be re-used by the same tournament
				each year.
			</p>

			<p>
				Don't make your tournament name too long; long names will be
				truncated on many online listings.  Also, don't include
				the year of the tournament; archives and results pages will
				include the year automatically.
			</p>

			<p>
				Your tournament invitations and the bill packets will
				immediately appear on your public website as download
				links.  Please make sure the files are in a common format, such
				as DOC or PDF, and it's best if the file names did not include
				characters besides numbers and letters
			</p>

	
		</div>

	</div>
