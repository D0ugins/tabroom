<%args>
	$person
	$tourn
	$tourn_settings
	$perms
	$event_id => undef
</%args>
<%init>

	my %admin_perms = ();
	my @admins;

	my $msg;

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	unless ($event) { 
		my $err = "No event found for $event_id";
		$m->redirect("event_access.mhtml?err=$err");
	}

	my %perms;

	foreach my $perm (
		Tab::Permission->search(
			tourn => $tourn->id,
			tag   => "detailed"
		)
	) { 

		my $admin = $perm->person();

		$admin_perms{$admin->id} = eval { 
			JSON::decode_json($perm->details);
		};

		$perms{$admin->id} = $perm;

		if ($admin_perms{$admin->id}{$event->id}) { 
			push @admins, $admin;
		}

	}

	foreach my $admin (@admins) { 

		my $level = $ARGS{$admin->id."_level"};

		unless ($admin_perms{$admin->id}{$event->id} eq $level) { 

			$admin_perms{$admin->id}{$event->id} = $level;
		
			$perms{$admin->id}->details(
				JSON::encode_json($admin_perms{$admin->id})
			);

			$perms{$admin->id}->update();

			my $change = $m->comp(
				"/funclib/log.mas", 
				tourn       => $tourn->id,
				event       => $event->id,
				type        => "access",
				person      => $person,
				description => $admin->email." permission for ".$event->name." adjusted to $level"
			);

		}
	}

	$msg = "Permissions adjusted";
	$m->redirect("event_access.mhtml?event_id=".$event->id."&msg=$msg");

</%init>

