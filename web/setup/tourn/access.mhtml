<%args>
	$person
	$tourn
	$tourn_settings
	$perms
</%args>
<%init>

	$m->abort if $perms->{"by_event"} || $perms->{"checker"};

	my @admins;
	my %admin_perms = ();

	foreach my $perm (
		Tab::Permission->search( tourn => $tourn->id )
	) {
		unless ($perm->person > 0) {
			$perm->delete();
			next;
		}
		$admin_perms{$perm->person}{$perm->tag} = $perm;
		push @admins, $perm->person;

		if ($perm->tag eq "by_event") {
			if ($perm->get_details) {
				$admin_perms{$perm->person}{"details"}  = $perm->get_details();
			}
		}
	}

	my %seen = ();
	@admins = grep { ! $seen{$_->id} ++ } @admins;

	@admins = sort {
		$admin_perms{$b->id}{"owner"} <=> $admin_perms{$a->id}{"owner"}
		|| $admin_perms{$b->id}{"contact"} <=> $admin_perms{$a->id}{"contact"}
		|| $admin_perms{$b->id}{"tabber"} <=> $admin_perms{$a->id}{"tabber"}
		|| $admin_perms{$b->id}{"checker"} <=> $admin_perms{$a->id}{"checker"}
	} @admins;

    my %links = (
		"backups"  => "backups.mhtml"
	);

	my $dbh = Tab::DBI->db_Main();

	my %events;
	my %categories;
	my %types;

	my $sth = $dbh->prepare("
		select
			event.id, event.abbr, event.name, event.type,
			category.id, category.abbr
		from event, category
			where event.tourn = ?
			and event.category = category.id
	");

	$sth->execute($tourn->id);

	while (
		my (
			$id, $abbr, $name, $type,
			$cat_id, $cat_abbr
		) = $sth->fetchrow_array()
	) {
		$events{$id}{"name"} = $name;
		$events{$id}{"abbr"} = $abbr;
		$events{$id}{"type"} = $type;
		$types{$type}++;
		$categories{$cat_id} = $cat_abbr;
	}

</%init>

	<script type="text/javascript">

		function checkAdmin() { 

			$('.admins').each(function(index, admin) { 
				var adminId = admin.id;
				if ($("#level_"+adminId).val() === "by_event") {
					$(".by_events_"+adminId).removeClass('hidden');
				} else { 
					$(".by_events_"+adminId).addClass('hidden');
				}
			});
		}

		$(document).ready(function() { 
			checkAdmin();
		});

    </script>

	<div class="main">

		<h3><% $tourn->name %></h3>

		<& "tabbar.mas",
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			whoami         => "access"
		&>

		<span class="half">
			<h4>Administrator Access</h4>
		</span>

		<span class="third centeralign">
            <&
                "/funclib/tabs.mas",
                    links   => \%links,
                    default => "overall",
                    center  => "yes",
                    buttons => "yes"
            &>
		</span>

		<span
			id    = "access_buttonarea"
			class = "sixth rightalign marno"
		></span>

		<&
			"/funclib/tablesorter.mas",
			table => "access"
		&>

		<form
			action = "access_save.mhtml"
			method = "post"
		>

		<table id="access">

%			if (@admins) {

				<thead>
					<tr class="yellowrow">
						<th class="smallish">
							Person
						</th>

						<th
							title = "Accounts marked as contact will have their email on the tourn website"
							class = "smallish"
						>Contact</th>

						<th class="smallish">
							Access Level
						</th>

						<th class="smaller">
							Events w/Tabber Access
						</th>

						<th class="smaller">
							Events w/Checker Access
						</th>

						<th class="smaller">
						</th>
					</tr>
				</thead>

				<tbody>

%					foreach my $admin (@admins) {

						<tr id="<% $admin->id %>" class="admins">

							<td
								title = "<% $admin->email %>"
								class = "limit smallish"
							>
								<% $admin->first." ".$admin->last %>

								<span class="full padtopless nospace">
									<% $admin->email %>
								</span>
							</td>

							<label for="<% $admin->id %>_contact">
								<td class="centeralign nospace">
									<span class="hidden">
										<% $admin_perms{$admin->id}{"contact"} ? '1' : "" %>
									</span>

<%perl>
									if ($person->site_admin
										|| $admin_perms{$person->id}{"owner"}
										|| ($admin->id == $person->id && $admin_perms{$person->id}{"contact"})
									) {
</%perl>
										<label for="<% $admin->id %>_contact">
											<span class="padvertless full marno hover">
												<input
													type          = "checkbox"
													target_id     = "<% $admin->id %>"
													property_name = "contact"
													post_method   = "put"
													value         = "1"
													onChange      = "postSwitch(this, '/v1/tourn/<% $tourn->id %>/tab/setup/access');"
													<% $admin_perms{$admin->id}{"contact"}
														? 'checked="checked"'
														: ""
													%>
												>
											</span>
										</label>
%									} else {
										<span class="padvertless full marno centeralign greentext
												<% $admin_perms{$admin->id}{"contact"}
													? 'fa fa-check'
													: ""
												%>">
										</span>
%									}
								</td>
							</label>

							<td class="centeralign padno smallish">

								<span class="hidden">  <!-- for sorting -->
									<% $admin_perms{$admin->id}{"owner"} ? '1' : "" %>
									<% $admin_perms{$admin->id}{"tabber"} ? '2' : "" %>
									<% $admin_perms{$admin->id}{"checker"} ? '4' : "" %>
									<% $admin_perms{$admin->id}{"by_event"} ? '5' : "" %>
								</span>

<%perl>
								if (
									$admin_perms{$admin->id}{owner}
									&& (not defined $perms->{owner})
									&& (not defined $person->site_admin)
								) {
</%perl>
									<span class="centeralign semibold bluetext">
										Owner
									</span>

%								} else {

									<select
										name          = "level"
										class         = "fixedsmall"
										id            = "level_<% $admin->id %>"
										target_id     = "<% $admin->id %>"
										property_name = "level"
										post_method   = "put"
										onChange      = "postSwitch(this, '/v1/tourn/<% $tourn->id %>/tab/setup/access'); checkAdmin();"
									>

%										if ($perms->{owner} || $person->site_admin) {
											<option
												value="owner"
												<% $admin_perms{$admin->id}{"owner"} ? "selected" : "" %>
											>Owner</option>
%										}

										<option
											value="tabber"
											<% $admin_perms{$admin->id}{"tabber"} ? "selected" : "" %>
										>Tabber (All events)</option>

										<option
											value="checker"
											<% $admin_perms{$admin->id}{"checker"} ? "selected" : "" %>
										>Checker (All events)</option>

										<option
											value="by_event"
											<% $admin_perms{$admin->id}{"by_event"} ? "selected" : "" %>
										>By Event</option>
									</select>
%								}
							</td>

							<td class="leftalign nospace smallish">
								<span
									class = "twothirds events nospace by_events_<% $admin->id %>"
									id    = "tabber_<% $admin->id %>"
								>
<%perl>
								foreach my $id (
									sort {
										$events{$a}{"type"} cmp $events{$b}{"type"}
										|| $events{$a}{"abbr"} cmp $events{$b}{"abbr"}
										|| $events{$a}{"name"} cmp $events{$b}{"name"}
									} keys %events
								) {

									next unless $admin_perms{$admin->id}{"details"};
									next unless $admin_perms{$admin->id}{"details"}{$id} eq "tabber";
</%perl>
									<div
										class        = "lilbutton threetenths bluetext <% $id %>_<% $admin->id %>"
										id           = "<% $id %>_<% $admin->id %>"
										target_id    = "<% $admin->id %>"
										title        = "Click event to remove access"
										post_method  = "delete"
										setting_name = "<% $id %>"
										onClick      = "postSwitch(this, '/v1/tourn/<% $tourn->id %>/tab/setup/eventaccess');"
									>
										<% $events{$id}{"abbr"} %>
									</div>
%								}
								</span>

								<span class="threetenths centeralign nospace by_events_<% $admin->id %>">
									<select
										target_id    = "<% $admin->id %>"
										setting_name = "tabber"
										class        = "fixedtinier plain"
										reply_append = "tabber_<% $admin->id %>"
										onClick      = "postSwitch(this, '/v1/tourn/<% $tourn->id %>/tab/setup/eventaccess');"
									>
										<option value="">Add:</option>
										<optgroup label="Event Types">
<%perl>
										foreach my $type (
											sort {
												$types{$a} cmp $types{$b}
											} keys %types
										) { 
</%perl>
											<option 
												value="type_<% $type %>"
											><% ucfirst($type) %> events</option>
%										}
										<optgroup label="Judge Categories">
<%perl>
										foreach my $category (
											sort {
												$categories{$a} cmp $categories{$b}
											} keys %categories
										) { 
</%perl>
											<option 
												value="category_<% $category %>"
											><% $categories{$category} %> events</option>
%										}
										<optgroup label="Events">
<%perl>
										foreach my $event (
											sort {
												$events{$a}{"type"} cmp $events{$b}{"type"}
												|| $events{$a}{"abbr"} cmp $events{$b}{"abbr"}
											} keys %events
										) { 
</%perl>
											<option 
												value="event_<% $event %>"
											><% $events{$event}{"abbr"} %></option>
%										}
									</select>
								</span>
							</td>

							<td class="leftalign nospace smallish">
								<span
									class = "twothirds events nospace by_events_<% $admin->id %>"
									id    = "checker_<% $admin->id %>"
								>
<%perl>
								foreach my $id (
									sort {
										$events{$a}{"type"} cmp $events{$b}{"type"}
										|| $events{$a}{"abbr"} cmp $events{$b}{"abbr"}
										|| $events{$a}{"name"} cmp $events{$b}{"name"}
									} keys %events
								) {

									next unless $admin_perms{$admin->id}{"details"};
									next unless $admin_perms{$admin->id}{"details"}{$id} eq "checker";
</%perl>
									<div
										class        = "lilbutton threetenths bluetext <% $id %>_<% $admin->id %>"
										id           = "<% $id %>_<% $admin->id %>"
										target_id    = "<% $admin->id %>"
										title        = "Click event to remove access"
										post_method  = "delete"
										setting_name = "<% $id %>"
										onClick      = "postSwitch(this, '/v1/tourn/<% $tourn->id %>/tab/setup/eventaccess');"
									>
										<% $events{$id}{"abbr"} %>
									</div>
%								}
								</span>

								<span class="threetenths centeralign nospace by_events_<% $admin->id %>">
									<select
										target_id    = "<% $admin->id %>"
										setting_name = "checker"
										class        = "fixedtinier plain"
										reply_append = "checker_<% $admin->id %>"
										onClick      = "postSwitch(this, '/v1/tourn/<% $tourn->id %>/tab/setup/eventaccess');"
									>
										<option value="">Add:</option>
										<optgroup label="Event Types">
<%perl>
										foreach my $type (
											sort {
												$types{$a} cmp $types{$b}
											} keys %types
										) { 
</%perl>
											<option 
												value="type_<% $type %>"
											><% ucfirst($type) %> events</option>
%										}
										<optgroup label="Judge Categories">
<%perl>
										foreach my $category (
											sort {
												$categories{$a} cmp $categories{$b}
											} keys %categories
										) { 
</%perl>
											<option 
												value="category_<% $category %>"
											><% $categories{$category} %> events</option>
%										}
										<optgroup label="Events">
<%perl>
										foreach my $event (
											sort {
												$events{$a}{"type"} cmp $events{$b}{"type"}
												|| $events{$a}{"abbr"} cmp $events{$b}{"abbr"}
											} keys %events
										) { 
</%perl>
											<option 
												value="event_<% $event %>"
											><% $events{$event}{"abbr"} %></option>
%										}
									</select>
								</span>
							</td>

							<td class="centeralign nospace smallish">
<%perl>
								unless (
									$admin_perms{$admin->id}{"owner"}
									&& (not defined $admin_perms{$person->id}{"owner"})
									&& (not defined $person->site_admin)
								) {
</%perl>
									<a
										target_id     = "<% $admin->id %>"
										post_method   = "delete"
										class         = "redtext button buttonwhite fa fa-trash"
										onClick       = "postSwitch(this, '/v1/tourn/<% $tourn->id %>/tab/setup/access');"
									></a>
%								}
							</td>
						</tr>
%					}
				</tbody>
%			}
		</table>

		<div class="libl rightalign">
			<span class="centeralign third">
				<input
					type  = "submit"
					value = "Save Permissions"
				>
			</span>
		</div>

		</form>
	</div>

<%perl>

	$sth = $dbh->prepare("
		select
			person.id, person.email, person.first, person.last,
			count(distinct permission.tourn)
		from person, permission, permission mine
		where person.id = permission.person
			and permission.tourn = mine.tourn
			and mine.person = ?
			and mine.tag in ('owner', 'tabber')
		group by person.id
	");

	$sth->execute($person->id);

	my %peeps;

	while (
		my (
			$person_id, $email, $first, $last, $count
		) = $sth->fetchrow_array()
	) {
		$peeps{$person_id}{"first"} = $first;
		$peeps{$person_id}{"last"}  = $last;
		$peeps{$person_id}{"email"} = $email;
		$peeps{$person_id}{"count"} = $count;
	}

</%perl>

	<div class="menu">
		<div class="sidenote">
			<h4>Add New Staff</h4>

			<form
				action = "access_add.mhtml"
				method = "post"
			>
				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn %>"
				>

				<div class="row centeralign padmuchmore">
					<select
						name  = "person_id"
						class = "fixedmost"
					>
						<option value="">Choose Person...</option>
<%perl>
					foreach my $id (
						sort {
							$peeps{$b}{"count"} <=> $peeps{$a}{"count"}
							|| $peeps{$b}{"last"} cmp $peeps{$a}{"last"}
						} keys %peeps
					) {

						next if $id == $person;
</%perl>
						<option
							value="<% $id %>"
						><% $peeps{$id}{"first"}." ".$peeps{$id}{"last"}." ".$peeps{$id}{"email"} %></option>
%					}
					</select>
				</div>

				<div class="row centeralign padmuchmore">
					<input
						type        = "text"
						name        = "email"
						size        = "32"
						placeholder = "Or, search by email address"
					>
				</div>

				<div class="row centeralign padmuchmore">

					<span class="quarter semibold bluetext">
						Role:
					</span>

					<span class="threequarters nospace">
						<select
							class = "fixedmost"
							name  = "tag"
						>
							<option value="checker">Checker (All events)</option>
							<option value="tabber">Tabber (All events)</option>
							<option value="by_event">By Event Access</option>
%							if ($perms->{owner} || $person->site_admin) {
								<option value="owner">Tournament Owner</option>
% 							}
						</select>
					</span>
				</div>

				<div class="libl marno padmore rightalign">
					<span class="half centeralign nospace">
						<input
							type  = "submit"
							value = "Give Access"
						>
					</span>
				</div>
			</form>
		</div>
	</div>

%	$dbh->disconnect();
