<%args>
	$person
	$tourn
	$tourn_settings
	$perms
</%args>
<%init>

	$m->abort if $perms->{"by_event"} || $perms->{"checker"};

	my @admins;

	my %admin_perms = ();

	foreach my $perm (
		Tab::Permission->search( tourn => $tourn->id )
	) {
		unless ($perm->person > 0) {
			$perm->delete();
			next;
		}
		$admin_perms{$perm->person}{$perm->tag} = $perm;
		push @admins, $perm->person;
	}

	my %seen = ();
	@admins = grep { ! $seen{$_->id} ++ } @admins;

	@admins =
		sort {
			$admin_perms{$b->id}{"checker"}
			<=> $admin_perms{$a->id}{"checker"}
		} @admins;

	@admins =
		sort {
			$admin_perms{$b->id}{"tabber"}
			<=> $admin_perms{$a->id}{"tabber"}
		} @admins;

	@admins =
		sort {
			$admin_perms{$b->id}{"contact"}
			<=> $admin_perms{$a->id}{"contact"}
		} @admins;

	@admins =
		sort {
			$admin_perms{$b->id}{"owner"}
			<=> $admin_perms{$a->id}{"owner"}
		} @admins;

    my %links = (
		"backups"  => "backups.mhtml"
	);

	my $dbh = Tab::DBI->db_Main();

	my %events;

	my $sth = $dbh->prepare("
		select
			event.id, event.abbr, event.name, event.type
		from event
			where event.tourn = ?
	");

	$sth->execute($tourn->id);

	while (
		my (
			$id, $abbr, $name, $type
		) = $sth->fetchrow_array()
	) {
		$events{$id}{"name"} = $name;
		$events{$id}{"abbr"} = $abbr;
		$events{$id}{"type"} = $type;
	}

</%init>

	<script type="text/javascript">

		function concealGreens (id, type) {
			$(".leveler_"+id).removeClass('green', "fold");
			$("#"+id+"_"+type+"box").addClass('green');
		}

        function showLimits (it, radio, type) {
			if (radio.checked) {
				$("#"+it).show("fold");
			} else {
				$("#"+it).hide("fold");
			}

			concealGreens(it, type);
        }

        function hideLimits (it, radio, type) {
			if (radio.checked) {
				$("#"+it).hide("fold");
			}

			concealGreens(it, type);
		}
    </script>

	<div class="main">

		<h3><% $tourn->name %></h3>

		<& "tabbar.mas",
			tourn          => $tourn,
			tourn_settings => $tourn_settings,
			whoami         => "access"
		&>

		<span class="half">
			<h4>Administrator Access</h4>
		</span>

		<span class="third centeralign">
            <&
                "/funclib/tabs.mas",
                    links   => \%links,
                    default => "overall",
                    center  => "yes",
                    buttons => "yes"
            &>
		</span>

		<span
			id    = "access_buttonarea"
			class = "sixth rightalign marno"
		></span>

		<&
			"/funclib/tablesorter.mas",
			table => "access"
		&>

		<form
			action = "access_save.mhtml"
			method = "post"
		>

		<table id="access">

%			if (@admins) {

				<thead>
					<tr class="yellowrow">
						<th class="smallish">
							Person
						</th>

						<th
							title = "Accounts marked as contact will have their email on the tourn website"
							class = "smallish"
						>Contact</th>

						<th class="smallish">
							Access Level
						</th>

						<th class="smaller">
							Events w/Full Access
						</th>

						<th class="smaller">
							Events w/Checker Access
						</th>

						<th class="smaller">
						</th>
					</tr>
				</thead>

				<tbody>

%					foreach my $admin (@admins) {

						<tr id="<% $admin->id %>">

							<td
								title = "<% $admin->email %>"
								class = "limit smallish"
							>
								<% $admin->first." ".$admin->last %>

								<span class="full padtopless nospace">
									<% $admin->email %>
								</span>
							</td>

							<label for="<% $admin->id %>_contact">
								<td class="centeralign nospace">
									<span class="hidden">
										<% $admin_perms{$admin->id}{"contact"} ? '1' : "" %>
									</span>

									<label for="<% $admin->id %>_contact">
										<span class="padvertless full marno hover">
											<input
												type          = "checkbox"
												target_id     = "<% $admin->id %>"
												property_name = "contact"
												value         = "1"
												<% $person->site_admin
													|| $admin_perms{$person->id}{"owner"}
													|| $admin_perms{$person->id}{"contact"}
													? "" : 'disabled'
												%>
												<% $admin_perms{$admin->id}{"contact"}
													? 'checked="checked"'
													: ""
												%>
												onclick   = " postSwitch(this, 'access_change.mhtml');"
											>
										</span>
									</label>
								</td>
							</label>

							<td class="centeralign padno smallish">

								<span class="hidden">  <!-- for sorting -->
									<% $admin_perms{$admin->id}{"owner"} ? '1' : "" %>
									<% $admin_perms{$admin->id}{"tabber"} ? '2' : "" %>
									<% $admin_perms{$admin->id}{"checker"} ? '4' : "" %>
								</span>

								<select
									name      = "level"
									class     = "fixedmed"
									target_id = "<% $admin->id %>"
									onclick   = "showEvents(this); postSwitch(this, 'access_change.mhtml');"
								>
									<option value="owner">
										Tournament Owner
									</option>

									<option value="tabber">
										Tabber: All Events
									</option>

									<option value="checker">
										Checker: All Events
									</option>

									<option value="by_event">
										Access by Event
									</option>
								</select>
							</td>

							<td class="centeralign nospace smallish events_<% $admin->id %>">
								<span
									class = "full events"
									id    = "tabber_<% $admin->id %>"
								>
<%perl>
								foreach my $id (
									sort {
										$events{$a}{"type"} cmp $events{$b}{"type"}
										|| $events{$a}{"abbr"} cmp $events{$b}{"abbr"}
										|| $events{$a}{"name"} cmp $events{$b}{"name"}
									} keys %events
								) {

									next unless $perms->{"details"}{$id} eq "tabber";
</%perl>
									<div
										class = "full nospace padvertless greentext yellowhover"
										id    = "<% $id %>_<% $admin->id %>"
										title = "Click event to remove access"
									>
										<% $events{$id}{"abbr"} %>
									</div>
%								}
								</span>
							</td>

							<td class="centeralign nospace smallish events_<% $admin->id %>">
								<span
									class = "full events"
									id    = "checker_<% $admin->id %>"
								>
<%perl>
								foreach my $id (
									sort {
										$events{$a}{"type"} cmp $events{$b}{"type"}
										|| $events{$a}{"abbr"} cmp $events{$b}{"abbr"}
										|| $events{$a}{"name"} cmp $events{$b}{"name"}
									} keys %events
								) {

									next unless $perms->{"details"}{$id} eq "checker";
</%perl>
									<div
										class = "full nospace padvertless bluetext yellowhover"
										id    = "<% $id %>_<% $admin->id %>"
										title = "Click event to remove access"
									>
										<% $events{$id}{"abbr"} %>
									</div>
%								}
								</span>
							</td>

							<td class="centeralign nospace smallish">
<%perl>
								unless ($admin_perms{$admin->id}{"owner"}
									&! ($admin_perms{$person->id}{"owner"}
									|| $person->site_admin)
								) {
</%perl>
									<a
										class="redtext button buttonwhite fa fa-lg fa-trash"
										href="access_rm.mhtml?admin_id=<% $admin->id %>"
									></a>
%								}
							</td>
						</tr>
%					}

				</tbody>
			</table>
%			}

			<div class="libl rightalign">
				<span class="centeralign third">
					<input
						type  = "submit"
						value = "Save Permissions"
					>
				</span>
			</div>

		</form>
	</div>

<%perl>

	$sth = $dbh->prepare("
		select
			person.id, person.email, person.first, person.last,
			count(distinct permission.tourn)
		from person, permission, permission mine
		where person.id = permission.person
			and permission.tourn = mine.tourn
			and mine.person = ?
			and mine.tag in ('owner', 'tabber')
		group by person.id
	");

	$sth->execute($person->id);

	my %peeps;

	while (
		my (
			$person_id, $email, $first, $last, $count
		) = $sth->fetchrow_array()
	) {
		$peeps{$person_id}{"first"} = $first;
		$peeps{$person_id}{"last"}  = $last;
		$peeps{$person_id}{"email"} = $email;
		$peeps{$person_id}{"count"} = $count;
	}

</%perl>

	<div class="menu">
		<div class="sidenote">
			<h4>Add New Staff</h4>

			<form
				action = "access_add.mhtml"
				method = "post"
			>
				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn %>"
				>

				<div class="row centeralign padmuchmore">
					<select
						name  = "person_id"
						class = "fixedmost"
					>
<%perl>
					foreach my $id (
						sort {
							$peeps{$b}{"count"} <=> $peeps{$a}{"count"}
							|| $peeps{$b}{"last"} cmp $peeps{$a}{"last"}
						} keys %peeps
					) {

						next if $id == $person;
</%perl>
						<option
							value="<% $id %>"
						><% $peeps{$id}{"first"}." ".$peeps{$id}{"last"}." ".$peeps{$id}{"email"} %></option>
%					}

					</select>
				</div>

				<div class="row centeralign padmuchmore">
					<input
						type        = "text"
						name        = "email"
						size        = "32"
						placeholder = "Or, search by email address"
					>
				</div>

				<div class="libl marno padmore rightalign">
					<span class="half centeralign nospace">
						<input
							type  = "submit"
							value = "Give Access"
						>
					</span>
				</div>
			</form>
		</div>
	</div>

%	$dbh->disconnect();
