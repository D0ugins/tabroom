<%args>
	$person
	$tourn
	$event_id => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

 	my @categories = sort{$a->name cmp $b->name} $tourn->categories;
	my $event = Tab::Event->retrieve($event_id) if $event_id;
	$m->redirect("edit.mhtml") unless $event;

	unless ($event->category) { 

		my $err = "Your event is not assigned to a judge category.  ";
		$err .= "You must do that before going further";
		$m->redirect("edit.mhtml?err=$err&event=$event_id");
	}

</%init>

    <script type="text/javascript"> 
		function showMe (it) { 
			$("."+it).toggleClass("hidden");
		} 
    </script>

    <div class="main">

        <h2><% $event->name %></h2>

        <& tabbar.mas, event => $event, whoami => "sectioning" &>
    
		<form action="sectioning_save.mhtml" method="post">
		<input type="hidden" name="event_id" value="<% $event->id %>">

		<span class="pagehalf">

%			if ($event->type eq "speech") { 
				<h4>Sectioning</h4> 
%			} elsif ($event->type eq "congress") { 
				<h4>Chamber Assignments</h4>
%			} elsif ($event->type eq "wudc") { 
				<h4>Sectioning</h4> 
%			} else { 
				<h4>Preset Rounds</h4> 
%			} 

%			if ($event->type eq "speech" || $event->type eq "congress") { 
	

				<div class=" row">
					<span class="half martop">
						Section labels
					</span>
					<span class="half rightalign">
						<select name="panel_labels" class="fixedsmall">

							<option value="numbers">Numbers</option>

							<option 
								<% $event->setting("panel_labels") eq "letters" ? "selected" : "" %> 
								value="letters"
							>Letters</option>

						</select>
					</span>
				</div>

%			}

%			if ($event->type eq "speech") { 

				<div class="row hover">

					<span class="half">
						IE schematic style
					</span>

					<span class="half rightalign">
						<select name="schem_orientation" class="fixedsmall">
							<option value="">
								Horizontal
							</option>
							<option value="1" 
								<% $event->setting("schem_veritcal") ? 'selected="selected"' : "" %>>
								Vertical</option>
						</select>
					</span>
				</div>

				<div class="row hover">

					<span class="half">
						List IEs by 
					</span>

					<span class="half rightalign">
						<select name="schem_orientation" class="fixedsmall">
							<option value="codes" 
								<% $event->setting("schem_veritcal") eq "codes" ? 'selected="selected"' : "" %>>
								Codes
							</option>
							<option value="names" 
								<% $event->setting("schem_veritcal") eq "names" ? 'selected="selected"' : "" %>>
								Names
							</option>
							<option value="both" 
								<% $event->setting("schem_veritcal") eq "both" ? 'selected="selected"' : "" %>>
								Both
							</option>
						</select>
						</select>
					</span>
				</div>

%			}

%			if ($event->type eq "wudc") { 

				<label for="avoid_school_hits">
					<div class="hover row">
						<span class="twothird wrap">
							Avoid pairing same-school entries 
						</span>
						<span class="sixth centeralign">
							<input 
								type="checkbox" 
								id="avoid_school_hits" 
								name="avoid_school_hits" 
								value="1" <% ($event) ? ($event->setting("avoid_school_hits")) ? 'checked' : '' : '' %>>
						</span>
					</div>
				</label>
% 			}

% 			if ($event->type ne "congress" && $event->type ne "speech" && $event->type ne "wudc") { 

				<label for="round_robin">
					<div class="hover row">
						<span class="fivesixth ">
							Round Robin format
						</span>
						<span class="sixth centeralign">
							<input 
								type="checkbox" 
								name="round_robin" 
								id="round_robin" 
								value="1" 
								<% $event->setting("round_robin") ? 'checked' : '' %> onclick="showMe('norr')">
						</span>
					</div>
				</label>

				<label for="no_side_constraints">
					<div class="hover row">
						<span class="fivesixth ">
							Flip for sides in all rounds (PF)
						</span>
						<span class="sixth centeralign">
							<input  
								type="checkbox" 
								name="no_side_constraints" 
								id="no_side_constraints" 
								value="1" 
								<% $event->setting("no_side_constraints") ? 'checked'  : '' %>>
						</span>
					</div>
				</label>

				<label for="school_debates_self">
					<div class="hover row">
						<span class="fivesixths ">
							Allow entries to debate own school
						</span>
						<span class="sixth centeralign">
							<input  
								type="checkbox" 
								name="school_debates_self" 
								id="school_debates_self" 
								value="1" <% $event->setting("school_debates_self") ? 'checked' : '' %>>
						</span>
					</div>
				</label>

%				if ($event->type ne "speech" && $event->type ne "congress" && $event->setting("hybrids")) { 

					<label for="hybrids_can_hit">

						<div class="hover row">
							<span class="fivesixths ">
								Hybrids may debate hybrid partner school
							</span>
							<span class="sixth centeralign">
								<input  
									type="checkbox" 
									name="hybrids_can_hit" 
									id="hybrids_can_hit" 
									value="1" 
									<% $event->setting("hybrids_can_hit") ? 'checked' : ''  %>>
							</span>
						</div>
					</label>
%				}

%				if ($tourn->setting("regions")) { 

					<label for="region_avoid">
						<div class="hover row">
							<span class="fivesixths">
								Avoid in-region matchups in presets
							</span>
							<span class="sixth centeralign">
								<input  
									type="checkbox" 
									name="region_avoid" 
									id="region_avoid" 
									value="1" 
									<% $event->setting("region_avoid") ? 'checked' : '' %>>
							</span>
						</div>
					</label>
%				}


				<div class="norr <% $event->setting("round_robin") ? "hidden" : "" %>">

%					my $seed_presets = $event->setting("seed_presets");

					<div class="row">
						<span class="third ">
							Preset seeding
						</span>
						<span class="twothird rightalign">
							<select name="seed_presets" class="fixedmed">

								<option value="0" <% $seed_presets ? "" : "selected" %> >
									Randomly (None)
								</option>

								<option value="all" <% $seed_presets eq "all" ? "selected" : "" %> >
									Hit All Seed Categories
								</option>

								<option value="inverse" <% $seed_presets eq "inverse" ? "selected" : "" %> >
									Hit Inverse Seeds (1 hits 2&amp;3; 3 hits 1&amp;4)
								</option>

								<option value="balance" <% $seed_presets eq "balance" ? "selected" : "" %> >
									Balance seeds of presets to same total
								</option>

								<option value="protect" <% $seed_presets eq "protect" ? "selected" : "" %> >
									Power Protect (1 hits 6, 2 hits 5)
								</option>

%								if ($event->type eq "wsdc") {
									<option value="wsdc" <% $seed_presets eq "wsdc" ? "selected" : "" %> >
										WSDC 8 Prelim Balancing
									</option>
%								}

							</select>
						</span>
					</div>

				</div>

%				if ($event->type eq "wsdc") { 

					<label for="wsdc_multiple_sites">
						<div class="row hover">
							<span class="fivesixths">
								Use multiple sites per round (WSDC)
								<!-- FML! -->
							</span>
							<span class="sixth centeralign">
								<input 
									type="checkbox" 
									id="wsdc_multiple_sites" 
									name="wsdc_multiple_sites" 
									<% $event->setting("wsdc_multiple_sites") ? 'checked="checked"' : "" %> value="1"> 
							</span>
						</div>
					</label>

					<label for="wsdc_cap_repel">
						<div class="row hover">
							<span class="fivesixths">
								Put CAP members into different sites
							</span>
							<span class="sixth centeralign">
								<input type="checkbox" id="wsdc_cap_repel" name="wsdc_cap_repel" 
									<% $event->setting("wsdc_cap_repel") ? 'checked="checked"' : "" %> value="1"> 
							</span>
						</div>
					</label>

% 				}


				<div class="norr <% $event->setting("round_robin") ? "hidden" : "" %>">

					<h4>Powermatching</h4>


%					my $powermatch = $event->setting("powermatch");

					<div class=" row">
						<span class="third">
							Method
						</span>
						<span class="twothird rightalign">
							<select name="powermatch" class="fixedmed">
								<option value="sop" <% $powermatch eq "sop" ? "selected" : "" %>>SOP (Seed + Opp Seed)</option>
								<option value="seed" <% $powermatch eq "seed" ? "selected" : "" %>>Seeds Only</option>
							</select>
						</span>
					</div>

					<label for="bracket_by_ballots">
						<div class="hover row">
							<span class="fivesixths ">
								Powermatch by first tiebreak, not win/loss
							</span>
							<span class="sixth centeralign">
								<input  type="checkbox" name="bracket_by_ballots" id="bracket_by_ballots" 
									value="1" <% ($event) ? ($event->setting("bracket_by_ballots")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>

					<label for="snake_sides_huge_schools">
						<div class="hover row">
							<span class="fivesixths ">
								Don't put large schools on same side
							</span>
							<span class="sixth centeralign">
								<input  type="checkbox" name="snake_sides_huge_schools" id="snake_sides_huge_schools" 
									value="1" <% ($event) ? ($event->setting("snake_sides_huge_schools")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>

					<label for="bracket_rooms">
						<div class="hover row">
							<span class="fivesixth ">
								Assign rooms by brackets
							</span>
							<span class="sixth centeralign">
								<input type="checkbox" id="bracket_rooms" name="bracket_rooms" 
									value="1" <% ($event) ? ($event->setting("bracket_rooms")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>

%					my $pullup_method = $event->setting("pullup_method");

					<div class=" row">
						<span class="third ">
							Pullup method
						</span>
						<span class="twothird rightalign">
							<select name="pullup_method" class="fixedmed">
								<option value="sop" <% $pullup_method eq "sop" ? "selected" : "" %>>	
									SOP: Worst opponent seed
								</option>
								<option value="oppwin" <% $pullup_method eq "oppwin" ? "selected" : "" %>>
									Worst opponent wins
								</option>
								<option value="middle" <% $pullup_method eq "middle" ? "selected" : "" %>>
									Pull from middle (Hand-tab holdover; not recommended)
								</option>
								<option value="lowseed" <% $pullup_method eq "lowseed" ? "selected" : "" %>>
									Worst seed from bracket below
								</option>
							</select>
						</span>
					</div>

					<label for="pullup_repeat">
						<div class="hover row">
							<span class="fivesixths ">
								Allow repeat pullups (best for SOP)
							</span>
							<span class="sixth centeralign">
								<input  type="checkbox" name="pullup_repeat" id="pullup_repeat" 
									value="1" <% ($event) ? ($event->setting("pullup_repeat")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>

					<label for="pullup_minimize">
						<div class="hover row" title="An APDA Abomination!&trade;">
							<span class="fivesixths ">
								Minimize pullups (Breaks side locks)
							</span>
							<span class="sixth centeralign">
								<input  type="checkbox" name="pullup_minimize" id="pullup_minimize" 
									value="1" <% ($event) ? ($event->setting("pullup_minimize")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>


					<label for="prevent_hitting_pullup_twice">
						<div class="hover row">
							<span class="fivesixths ">
								Entries shouldn't debate multiple pullups
							</span>
							<span class="sixth centeralign">
								<input  type="checkbox" name="prevent_hitting_pullup_twice" id="prevent_hitting_pullup_twice" 
									value="1" <% ($event) ? ($event->setting("prevent_hitting_pullup_twice")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>

				</div>

% 			}

% 			if ($event->type eq "congress" || $event->type eq "speech") { 

%				if ($tourn->setting("regions")) { 

					<label for="region_avoid">
						<div class="hover row">
							<span class="fivesixths">
								Avoid in-region matchups in prelims
							</span>
							<span class="sixth centeralign">
								<input  type="checkbox" name="region_avoid" id="region_avoid" 
									value="1" <% ($event) ? ($event->setting("region_avoid")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>

%				}

				<div class="hover row">
					<span class="twothird ">
						Minimum <% $event->type eq "speech" ? "section" : "chamber" %> size
					</span>
					<span class="third rightalign">
						<input type="text" class="thin" name="min_panel_size" 
							value="<% ($event) ? $event->setting("min_panel_size") : "0" %>" size="5">
					</span>
				</div>

				<div class="hover row">
					<span class="twothird ">
						Maximum <% $event->type eq "speech" ? "section" : "chamber" %> size
					</span>
					<span class="third rightalign">
						<input type="text" class="thin" name="max_panel_size" 
							value="<% ($event) ? $event->setting("max_panel_size") : "0" %>" size="5">
					</span>
				</div>

				<div class="hover row">
					<span class="twothird ">
						Default <% $event->type eq "speech" ? "section" : "chamber" %> size
					</span>
					<span class="third rightalign">
						<input type="text" class="thin" name="default_panel_size" 
							value="<% ($event) ? $event->setting("default_panel_size") : "0" %>" size="5">
					</span>
				</div>

				<div class="hover row">
					<span class="twothird ">
						Limit a school to this % of sections
					</span>
					<span class="third rightalign">
						<input type="text" class="thin" name="school_percent_limit" 
							value="<% ($event) ? $event->setting("school_percent_limit") : "0" %>" size="5">
					</span>
				</div>

%				my $elim_method = $event->setting("elim_method");

				<div class=" row">

					<span class="half ">
						Elim snake adjustment
					</span>

					<span class="half rightalign">

						<select name="elim_method" class="fixedsmall">

							<option value="snake" 
								<% ($event->setting("elim_method") eq "snake") ? "selected" : "" %>> 
								None: do not adjust for same-school hits
							</option>
		
							<option value="snake_school" 
								<% ($event->setting("elim_method") eq "snake_school") ? "selected" : "" %>> 
								Seeds: Adjust among entries with similar prelim seed (max 2 places)
							</option>

							<option value="snake_school_rank" 
								<% ($event->setting("elim_method") eq "snake_school_rank") ? "selected" : "" %>> 
								Tiebreak: Adjust among entries tied in the 1st tiebreaker
							</option>

							<option value="snake_school_prelim_cume" 
								<% ($event->setting("elim_method") eq "snake_school_prelim_cume") ? "selected" : "" %>> 
								Prelim Cume: Adjust among entries tied in prelim cume ranks
							</option>

							<option value="snake_school_overall_cume" 
								<% ($event->setting("elim_method") eq "snake_school_overall_cume") ? "selected" : "" %>> 
								Overall Cume: Adjust among entries tied in overall cume ranks
							</option>
		
							<option value="snake_school_force" 
								<% ($event->setting("elim_method") eq "snake_school_force") ? "selected" : "" %>> 
								Force: Force-adjust no matter tiebreakers; closer seeds first.
							</option>


						</select>
					</span>
				</div>
							
% 			}

% 			if ($event->type eq "congress") { 

				<label for="seed_presets">
					<div class=" row">
						<span class="fivesixth ">
							Pair prelims based on seeding
						</span>
						<span class="sixth centeralign">
							<input type="checkbox" name="seed_presets" id="seed_presets" 
								value="1" <% $event && $event->setting("seed_presets") eq "congress" ? 'checked' : '' %>>
						</span>
					</div>
				</label>

				<label for="separate_codes">
					<div class=" row">
						<span class="fivesixth ">
							Use separate school codes
						</span>
						<span class="sixth centeralign">
							<input type="checkbox" name="separate_codes" id="separate_codes" 
								value="1" <% ($event) ? ($event->setting("separate_codes")) ? 'checked' : '' : '' %>>
						</span>
					</div>
				</label>

% 			}

		</span>

		<span class="pagehalf">

			<h4>Judging</h4>

			<label for="allow_judge_own">
				<div class="hover row">
					<span class="fivesixth ">
						Judges may judge their own school
					</span>
					<span class="sixth centeralign">
						<input type="checkbox" id="allow_judge_own" name="allow_judge_own" 
							value="1" <% ($event) ? ($event->setting("allow_judge_own")) ? 'checked' : '' : '' %>>
					</span>
				</div>
			</label>

%			if ($tourn->setting("regions")) { 

				<label for="region_judge_forbid">
					<div class="hover row">
						<span class="fivesixths">
							Forbid judges from judging own region
						</span>
						<span class="sixth centeralign">
							<input  type="checkbox" name="region_judge_forbid" id="region_judge_forbid" 
								value="1" <% ($event) ? ($event->setting("region_judge_forbid")) ? 'checked' : '' : '' %>>
						</span>
					</div>
				</label>
%			}
						
			<label for="no_first_years">
				<div class="hover row">
					<span class="fivesixth ">
						Block first year out judges
					</span>
					<span class="sixth centeralign">
						<input type="checkbox" id="no_first_years" name="no_first_years" 
							value="1" <% ($event) ? ($event->setting("no_first_years")) ? 'checked' : '' : '' %>>
					</span>
				</div>
			</label>


%			unless ($event->type eq "speech") { 

				<label for="allow_repeat_judging">
					<div class="hover row">
						<span class="fivesixth ">
							Allow repeat judging always
						</span>
						<span class="sixth centeralign">
							<input type="checkbox" id="allow_repeat_judging" name="allow_repeat_judging" 
								value="1" <% ($event) ? ($event->setting("allow_repeat_judging")) ? 'checked' : '' : '' %>>
						</span>
					</div>
				</label>

				<label for="allow_repeat_prelim_side">
					<div class="hover row">
						<span class="fivesixth ">
							Allow repeat judging on other side
						</span>
						<span class="sixth centeralign">
							<input type="checkbox" id="allow_repeat_prelim_side" name="allow_repeat_prelim_side" 
								value="1" <% ($event) ? ($event->setting("allow_repeat_prelim_side")) ? 'checked' : '' : '' %>>
						</span>
					</div>
				</label>

				<label for="allow_repeat_elims">
					<div class="hover row">
						<span class="fivesixth ">
							Allow repeat judging in elims
						</span>
						<span class="sixth centeralign">
							<input type="checkbox" id="allow_repeat_elims" name="allow_repeat_elims" 
								value="1" <% ($event) ? ($event->setting("allow_repeat_elims")) ? 'checked' : '' : '' %>>
						</span>
					</div>
				</label>

%				unless ($event && $event->category->setting('prefs') 
%						&& $event->category->setting('prefs') ne "community") { 

					<label for="disallow_repeat_drop">
						<div class="hover row">
							<span class="fivesixth wrap smallish">
								Disallow repeats in elims by judges who voted against a debater
							</span>
							<span class="sixth centeralign">
								<input 
									type="checkbox" 
									id="disallow_repeat_drop" 
									name="disallow_repeat_drop" 
									value="1" <% ($event) ? ($event->setting("disallow_repeat_drop")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>
%				}

%				unless ($event->type eq "wudc" || $event->setting("no_side_constraints")) { 

%					if ($event->category && $event->category->setting("prefs") && $event->category->setting("prefs") ne "no") { 

						<div class=" row">
							<span class="fivesixth ">
								Maximum pref for in debates
							</span>
							<span class="sixth centeralign">
								<input type="text" class="thin" name="max_pref" 
									value="<% ($event) ? $event->setting("max_pref") : "" %>" size="5">
							</span>
						</div>

						<div class=" row">
							<span class="fivesixth ">
								Ignore prefs once an entry loses
							</span>
							<span class="sixth centeralign">
								<input type="text" class="thin" name="break_point" 
									value="<% ($event) ? $event->setting("break_point") : "" %>" size="5">
							</span>
						</div>

						<div class=" row">
							<span class="fivesixth ">
								Maximum pref for down-and-outs
							</span>
							<span class="sixth centeralign">
								<input type="text" class="thin" name="max_nobreak_pref" 
									value="<% ($event) ? $event->setting("max_nobreak_pref") : "" %>" size="5">
							</span>
						</div>
%	 				}
% 				}

%				if ($event && $event->category && $event->category->setting('tab_ratings')) { 

					<label for="best_judges_highest_seed">
						<div class="hover row" title="An APDA Abomination!&trade;">
							<span class="fivesixth ">
								Best judging goes to highest brackets
							</span>
							<span class="sixth centeralign">
								<input type="checkbox" id="best_judges_highest_seed" name="best_judges_highest_seed" 
									value="1" <% ($event) ? ($event->setting("best_judges_highest_seed")) ? 'checked' : '' : '' %>>
							</span>
						</div>
					</label>
% 				}
							
% 			}

			<h4>Publishing</h4>

			<label for="live_updates">
				<div class="hover row">
					<span class="fivesixth ">
						Live updates (Text/Email Blasts)
					</span>
					<span class="sixth centeralign">
						<input type="checkbox" id="live_updates" name="live_updates" 
							value="1" <% ($event) ? ($event->setting("live_updates")) ? 'checked' : '' : '' %>>
					</span>
				</div>
			</label>

				<div class="row">

					<span class="half">
						Auto-publish results<br />
						<div class="explain nospace">
						(when next round is paired)
						</div>
					</span>

					<span class="half rightalign">

%						my $autopublish_results = $event->setting("autopublish_results");

						<select name="autopublish_results" class="fixedsmall">

							<option value="" <% ( $autopublish_results eq "") ? "selected" : "" %>>
								No
							</option>

							<option value="1" <% ( $autopublish_results eq "1") ? "selected" : "" %>>
								Win/Loss Only
							</option>

							<option value="2" <% ( $autopublish_results eq "2") ? "selected" : "" %>>
								Full Results
							</option>

						</select>

					</span>
				</div>


		</span>

		<div class="liblrow rightalign">
			<input type="submit" value="Save  Settings">
			</form>
		</div>

	</div>
		
	<div class="menu">
		<& menu.mas, tourn => $tourn, whoami => "tabbing", event_id => ($event) ? $event->id : "" &>		
	</div>

