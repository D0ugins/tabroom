<%args>
	$tourn
	$tourn_settings
	$event_id => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	$m->abort() unless $event;

	my @settings = (
		"wsdc_no_rfd",
		"aff_label",
		"neg_label",
		"congress_placard_nologo",
		"congress_placard_noschools",
		"congress_placard_designator",
		"congress_placard_title",
		"congress_placard_logo"
	);

	foreach my $setting (@settings) { 
		my $value = $ARGS{$setting};
		$value = 0 unless $value;
		$event->setting($setting, $value);
	}

	my @text_settings = (
		"ballot_rules",
		"ballot_rules_chair",
		"point_scale",
		"speech_times",
		"strike_card_message",
		"student_vote_message",
	);

	foreach my $setting (@text_settings) { 

		my $value = $m->comp("/funclib/save_editor.mas", 	
			text => $ARGS{$setting}
		);

		if ($value) { 
			$event->setting($setting, "text", $value);
		} else { 
			$event->setting($setting, "0");
		}

	}

    if ($ARGS{"congress_placard_logo"}) {

        my $req = Apache2::Request->new($r);
        my $upload = $req->upload("congress_placard_logo");
        my $filename  = $upload->filename;

        $filename =~ s/[^\w.]//g;
        $filename =~ s/\.(?=.*\.)//g;
        $filename =~ s/\s//g;

        my $filetemp = $upload->tempname;
        system $Tab::s3_cmd." put $filetemp ".$Tab::s3_bucket."/tourns/".$tourn->id."/".$event->id."/$filename";
        $event->setting("congress_placard_logo", $filename);
    } 

	if ($ARGS{"delete_congress_logo"}) { 
        $event->setting("congress_placard_logo", 0);
	}

	if ($tourn_settings->{'legion'}) { 

		my @categories = (
			"content",
			"speaking",
			"penalties"
		);

		foreach my $category (@categories) { 

			my %existing;
			
			%existing = %{ JSON::decode_json($event->setting($category."_points"))}
				if $event->setting($category."_points");

			my %result; 
			my $counter; 

			foreach my $key (sort keys %existing, "New") { 

				Tab::debuglog("Cat $category key $key text ".$ARGS{$category."_".$key."_text"});

				if ($ARGS{$category."_".$key."_text"}) { 

					$counter++;

					$result{$counter}{"text"} = $ARGS{$category."_".$key."_text"};
					$result{$counter}{"prepared"} = $ARGS{$category."_".$key."_prepared"};
					$result{$counter}{"assigned"} = $ARGS{$category."_".$key."_assigned"};
					$result{$counter}{"total"} = $ARGS{$category."_".$key."_total"};
				
					Tab::debuglog("Assigning this to $counter for $category");

				}
			}

			if (keys %result) { 

				$event->setting($category."_points", "text", JSON::encode_json(\%result));

			} else { 

				$event->setting($category, 0);

			}
		}
	}

	my $msg = "Ballot and website rules text saved.";

	$m->redirect("ballots.mhtml?event_id=".$event->id."&msg=$msg");
		
</%init>
