<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$perms
	$event_id => undef
	$add      => undef
	$tz       => undef
</%args>
<%init>

	$tz = $tourn->tz unless $tz;

 	my @categories = sort{$a->name cmp $b->name} $tourn->categories;

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	if (scalar $tourn->events == 1 && not defined $add) {
		$event = $tourn->events->first;
	}

	$m->abort unless $event;

	my %event_settings = $event->all_settings;

	if ($event) {

		unless ($event->category) { 
			my $err = "You must select a judge category before continuing";
			$m->redirect("edit.mhtml?event_id=$event_id&err=$err");
		}

	}

	my $districts = $tourn_settings->{"nsda_district"};
	undef $districts if $event->setting("nsda_event_category") == "108";

	my %bill_categories = eval { 
		return %{ JSON::decode_json($event_settings{"bill_categories"})};
	};

</%init>

	<div class="main">

		<h2><% $event->name %></h2>

		<& 
			"tabbar.mas", 
			districts       => $districts,
			event           => $event,
			person          => $person,
			person_settings => $person_settings,
			whoami          => "legislation"
		&>
			
		<form 
			action   = "legislation_save.mhtml"
			method   = "post"
			enctype  = "multipart/form-data"
			onsubmit = "return uploadThis();"
		>

		<input 
			type  = "hidden"
			name  = "event_id"
			value = "<% $event->id %>"
		>

		<span class="pagehalf">

			<h5>Legislation Uploads</h5> 

			<label for="upload_legislation">

				<div class="hover row settings">

					<span class="threequarter">
						Upload legislation on Tabroom
					</span>

					<span class="quarter centeralign">
						<input 
							type  = "checkbox"
							class = "notfirst"
							id    = "upload_legislation"
							name  = "upload_legislation"
							value = "1"
							<% $event_settings{"upload_legislation"} ? 'checked=true' : '' %>
						>
					</span>

				</div>

			</label>

<%perl>
			my $deadline = eval {  
				return $event_settings{"bill_deadline"}->set_time_zone($tz);
			};

</%perl>
			<& 
				"/funclib/datepicker.mas", 
				id  => "deadline",
				max => $tourn->start
			&>

			<div class="row">

				<span class="quarter">
					Deadline:
				</span>

				<span class="threequarters">
					<input 
						type        = "text"
						class       = "notfirst"
						name        = "bill_deadline"
						id          = "deadline"
						placeholder = "Date.."
						size        = "16"
						value       = "<% ($deadline) ?  $deadline->mdy('/') : "" %>"
					>
						@
					<& 
						"/funclib/timepicker.mas",
						name        => "bill_deadlinetime",
						time        => $deadline,
						size        => 16,
						placeholder => "Time..."
					&>
				</span>

			</div>

			<div class="row settings">

				<span class="threequarter">
					Per school limit on submissions
				</span>

				<span class="quarter centeralign">
					<input 
						type  = "text"
						class = "thin"
						name  = "legislation_cap"
						size  = "5"
						value = "<% $event_settings{"legislation_cap"} %>"
					>
				</span>

			</div>



			<label for="bill_author_required">

				<div class="hover row">

					<span class="threequarter">
						Bills must be tied to an author/entry
					</span>

					<span class="quarter centeralign">
						<input 
							type  = "checkbox"
							class = "notfirst"
							id    = "bill_author_required"
							name  = "bill_author_required"
							value = "1"
							<% $event_settings{"bill_author_required"} ? 'checked=true' : '' %>
						>
					</span>

				</div>

			</label>

%			foreach my $type ("bill", "resolution", "amendment") { 

				<div class="row settings">

					<span class="third">
						<% ucfirst($type) %> Template
					</span>

%					if ($event_settings{$type."_template"}) { 

						<span class="half">
							<a 
								class  = "bluetext white smallish"
								href   = "<% 
									$Tab::s3_url 
									."/". $tourn->id
									."/". $event->id 
									."/".$type."_template/". $event_settings{$type."_template"} 
								%>" 
								target = "_blank"
							><% $event_settings{$type."_template"} %></a>

						</span>

						<span class="sixth">
							<a 
								class = "redtext buttonwhite fa fa-trash"
								href  = "delete_template.mhtml?event_id=<% $event->id %>&target=<% $type %>"
							>
							</a>
						</span>

%					} else { 

						<span class="twothirds rightalign">

							<div class="uploader leftalign wider">

								<input 
									type     = "file"
									name     = "<% $type %>"
									style    = "opacity: 0;"
									onchange = "uploaderName('<% $type %>', '<% $type %>_file')"
									id       = "<% $type %>"
								>

								<span 
									id  = "<% $type %>_file"
									class = "filename"
									style = "-webkit-user-select: none;"
								>No file selected</span>

								<span 
									class = "action"
									style = "-webkit-user-select: none;"
								>Choose File</span>

							</div>


						</span>

%					} 

				</div>
%			} 

		</span>

		<span class="pagehalf">

			<h5>Categories</h5>

			<label for="bill_category_required">

				<div class="hover row">

					<span class="threequarter">
						Require a category for each bill
					</span>

					<span class="quarter centeralign">
						<input 
							type  = "checkbox"
							class = "notfirst"
							id    = "bill_category_required"
							name  = "bill_category_required"
							value = "1"
							<% $event_settings{"bill_category_required"} ? 'checked=true' : '' %>
						>
					</span>
				</div>
			</label>

			<div class="row settings">

				<span class="threequarter">
					School limit per category
				</span>

				<span class="quarter centeralign">
					<input 
						type  = "text"
						class = "thin"
						name  = "bill_category_cap"
						size  = "5"
						value = "<% $event_settings{"bill_category_cap"} %>"
					>
				</span>

			</div>

%			foreach my $category (sort keys %bill_categories) { 

				<div id="<% $category %>" class="row settings">

					<span class="fourfifths padvert">
						<% $category %>
					</span>

					<span class="fifth centeralign padvert nospace">
						<a 
							class        = "buttonwhite fa fa-sm fa-trash redtext"
							target_id    = "<% $event->id %>"
							onClick      = "postSwitch( this, 'bill_categories.mhtml')";
							on_success   = "destroy"
							setting_name = "category"
							title        = "Delete category <% $category %>"
						></a>
					</span>
				</div>
%			}

			<h6 class="padsetting">Add categories (comma separated):</h6>

			<div class="row padvertmore centeralign">
				<textarea 
					name = "category_names"
					rows = "5"
					cols = "40"
					></textarea>
			</div>

		</span>

		<div class="libl full rightalign martopno">
			<input 
				type="submit" 
				value="Save Legislation Settings"
			>
			</form>
		</div>

	</div>
		
	<div class="menu">
		<& "menu.mas", 
			person          => $person,
			person_settings => $person_settings,
			tourn           => $tourn,
			perms           => $perms,
			tourn_settings  => $tourn_settings,
			whoami          => "register",
			event_id        => $event->id
		&>
	</div>
		
