<%args>
	$tourn
	$tourn_settings
	$event_id => undef
	$add      => undef
</%args>
<%init>

	use Tab::NSDA::EventCategory;

	my @speech_categories = 
		sort {$a->name cmp $b->name} 
		Tab::NSDA::EventCategory->search( type => 's');

	my @debate_categories = 
		sort {$a->id cmp $b->id} 
		Tab::NSDA::EventCategory->search( type => 'd');

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

 	my @categories = sort{$a->name cmp $b->name} $tourn->categories;

	my $event = Tab::Event->retrieve($event_id) if $event_id;


	if (scalar $tourn->events == 1 && not defined $add) {
		$event = $tourn->events->first;
	}

	my $high_school;

	foreach my $circuit ($tourn->circuits) { 
		$high_school++ 
			if $circuit->id != 43 
			&& $circuit->id != 2 
			&& $circuit->id != 15;
	}

	my %event_setting = ();

	if ($event) { 
		%event_setting = map {$_->tag => $_->value} $event->settings;
		$event_setting{'category'} = $event->category if $event->category;
		$event_setting{'type'} = $event->type;
		$event_setting{'type'} = "big_questions" if $event_setting{"big_questions"};
	}

	my $districts = $tourn_settings->{"nsda_district"};

</%init>
	
	<& "/funclib/editor.mas" &>

	<div class="main">

%		if ($event)	{

			<h2><% $event->name %></h2>

			<& 
				tabbar.mas, 
				event     => $event,
				districts => $districts,
				whoami    => "edit"
			&>

			<h4>Main Settings</h4>

%		} elsif ($add) { 

			<h2>Add a new event/division</h2>
%		}

%		unless (@categories) {
		
			<p>
				Events, or divisions, are organized into judge categories.
				Events in the same category will share judges, same judge
				obligations, and judge rating systems.
			</p>

			<p>
				You must create judge categories under 
				<a href="/setup/judges/edit.mhtml">Setup &rarr; Judge Categories</a>
				before creating events here.
			</p>

%		}

		<div class="half top">

%		if ($event || $add) { 

			<form action="edit_save.mhtml" method="post">

			<input 
				type="hidden" 
				name="event_id"
				value="<% ($event) ? $event->id : "" %>" 
			>

			<div class=" row">

				<span class="third">
					Full Name
				</span>
			
				<span class="twothird rightalign">
					<input 
						type     = "text"
						name     = "name"
						value    = "<% ($event) ? $event->name : "" %>"
						size     = "25"
						tabindex = "1"
						<% $districts ? 'disabled="true"' : "" %>
					>
				</span>
			</div>
				
			<div class=" row">

				<span class="threequarter">
					Short Abbreviation (limit 5 characters)
				</span> 
				
				<span class="quarter rightalign">
					<input 
						type      = "text"
						name      = "abbr"
						value     = "<% ($event) ? $event->abbr : "" %>"
						size      = "5"
						maxlength = "5"
						<% $districts ? 'disabled="true"' : "" %>
					>
				</span> 

			</div>

			<div class=" row">

				<span class="threequarter ">
					Per-Entry Fee
				</span>

				<span class="quarter rightalign">
					<input 
						type  = "text"
						name  = "fee"
						size  = "5"
						value = "<% ($event) ? $event->fee : "" %>"
					>
				</span>

			</div>

			<div class=" row">

				<span class="threequarter ">
					Minimum competitors per entry
				</span> 

				<span class="quarter rightalign">
					<input 
						type  = "text"
						name  = "min_entry"
						size  = "5"
						value = "<% $event_setting{"min_entry"} ? $event_setting{"min_entry"} : "1" %>"
						<% $districts ? 'disabled="true"' : "" %>
					>
				</span> 

			</div>

			<div class=" row">

				<span class="threequarter ">
					Maximum competitors per entry
				</span> 

				<span class="quarter rightalign">
					<input 
						type  = "text"
						name  = "max_entry"
						size  = "5"
						value = "<% $event_setting{"max_entry"} ? $event_setting{"max_entry"}  : "1" %>"
						<% $districts ? 'disabled="true"' : "" %>
					>
				</span> 

			</div> 

%			unless ($districts) { 

				<div class=" row">

					<span class="third smallish">
						Clone settings of:
					</span> 

					<span class="twothird rightalign">

						<select 
							name  = "clone_event"
							class = "fixedmed"
						>

							<option value=""></option>

%							foreach my $oevent ($tourn->events) { 
%								next if $event && $oevent->id == $event->id;
								<option value="<% $oevent->id %>"><% $oevent->name %></option>
%							}

						</select>
					</span>

				</div>
	
%			} else { 

				<div class=" row">
				</div>

%			} 

		</div>

		<div class="half top">

			<div class=" row">

				<span class="third">
					Judge Category
				</span>
				
				<span class="twothird rightalign">

%					if ($districts) { 

						<input
							type  = "text"
							value = "<% ucfirst($event_setting{"type"}) %>"
							size  = "16"
							<% $event_setting{"category"}->name %>
							<% $districts ? 'disabled="true"' : "" %>
						>
%					} else { 

						<select 
							name  = "category_id"
							class = "fixedmed"
							<% $districts ? 'disabled="true"' : "" %>
						>

%							foreach my $category (sort {$a->name cmp $b->name} $tourn->categories) { 

								<option 
									value="<% $category->id %>" 
									<% ($event_setting{"category"} == $category->id) ? "selected" : "" %>
								><% $category->name %></option>
%							}
						</select>

%					}

				</span>
			</div>
			
			<div class=" row">

%				my $code_style = $event_setting{"code_style"} if $event;

				<span class="third">
					Designate entries 
				</span>

				<span class="twothird rightalign">

					<select 
						name  = "code_style"
						class = "fixedmed"
					>

						<option 
							value="numbers" 
							<% ($event_setting{"code_style"} eq "numbers") ? "selected" : "" %>
						>
							Numeric codes
						</option>

						<option 
							value="school_number" 
							<% ($event_setting{"code_style"} eq "school_number") ? "selected" : "" %>
						>
							School code & numeric code
						</option>

						<option 
							value="schoolname_code" 
							<% ($event_setting{"code_style"} eq "schoolname_code") ? "selected" : "" %>
						>
							School name & numeric code
						</option>

						<option 
							value="initials" 
							<% ($event_setting{"code_style"} eq "initials") ? "selected" : "" %>
						>
							School code & entry initials	
						</option>

						<option 
							value="code_name" 
							<% ($event_setting{"code_style"} eq "code_name") ? "selected" : "" %>
						>
							School code & entry name
						</option>

						<option 
							value="full_initials" 
							<% ($event_setting{"code_style"} eq "full_initials") ? "selected" : "" %>
						>
							School name & entry initials	
						</option>

						<option 
							value="school_names" 
							<% ($event_setting{"code_style"} eq "school_names") ? "selected" : "" %>
						>
							School name & Full names (Do not use with TRPC)
						</option>

						<option 
							value="school_name_only" 
							<% ($event_setting{"code_style"} eq "school_name_only") ? "selected" : "" %>
						>
							School name Only
						</option>

						<option 
							value="names" 
							<% ($event_setting{"code_style"} eq "names") ? "selected" : "" %>
						>
							Full names Only
						</option>

						<option 
							value="names_lastfirst" 
							<% ($event_setting{"code_style"} eq "names_lastfirst") ? "selected" : "" %>
						>
							Full names (Last First)
						</option>

						<option 
							value="last_names" 
							<% ($event_setting{"code_style"} eq "last_names") ? "selected" : "" %>
						>
							Last names
						</option>

						<option 
							value="register" 
							<% ($event_setting{"code_style"} eq "register") ? "selected" : "" %>
						>
							Ask registrants to supply code
						</option>

					</select>

				</span>

			</div>

			<div class="row">

				<span class="twothird">
					Start entry codes with:
				</span> 

				<span class="third rightalign">
					<input 
						type  = "text"
						name  = "code_start"
						size  = "5"
						value = "<% $event_setting{"code_start"} ? $event_setting{"code_start"} : "100" %>"
					>
				</span> 

			</div> 

			<div class="row">

				<span class="third">
					Event Type
				</span> 

				<span class="twothird rightalign">

%					if ($districts) { 

						<input
							type  = "text"
							value = "<% ucfirst($event_setting{"type"}) %>"
							size  = "16"
							<% $districts ? 'disabled="true"' : "" %>
						>

%					} else {

						<select 
							name     = "type"
							class    = "fixedmed"
							onchange = "showNSDA(this)"
						>
							
							<option value=""></option>

							<option 
								value="speech" 
								<% ($event_setting{"type"} eq "speech") ? "selected" : "" %>
							>
								Speech
							</option>

							<option 
								value="congress" 
								<% ($event_setting{"type"} eq "congress") ? "selected" : "" %>
							>
								Congress
							</option>

							<option 
								value="debate" 
								<% ($event_setting{"type"} eq "debate") ? "selected" : "" %>
							>
								Debate
							</option>

							<option 
								value="policy" 
								<% ($event_setting{"type"} eq "policy") ? "selected" : "" %>
							>
								Policy
							</option>

							<option 
								value="ld" 
								<% ($event_setting{"type"} eq "ld") ? "selected" : "" %>>
								LD
							</option>

							<option 
								value="pf" 
								<% ($event_setting{"type"} eq "pf") ? "selected" : "" %>
							>
								PF
							</option>

							<option 
								value="parli" 
								<% ($event_setting{"type"} eq "parli") ? "selected" : "" %>
							>
								Parli (2 teams/round)
							</option>

							<option 
								value="big_questions" 
								<% ($event_setting{"type"} eq "big_questions") ? "selected" : "" %>
							>
								Big Questions Debates
							</option>

							<option 
								value="wsdc" 
								<% ($event_setting{"type"} eq "wsdc") ? "selected" : "" %>
							>
								Worlds Schools (WSDC)
							</option>

							<option 
								value="wudc" 
								<% ($event_setting{"type"} eq "wudc") ? "selected" : "" %>
							>
								Worlds Univ. (WUDC/BP)
							</option>

						</select>

%					}

				</span> 

			</div> 

%			unless ($districts) { 

				<div class=" row">

					<span class="third ">
						Event Level
					</span> 

					<span class="twothird rightalign">

						<select 
							name  = "level"
							class = "fixedmed"
						>

							<option value=""></option>

							<option 
								value="open" 
								<% ($event_setting{"level"} eq "open") ? "selected" : "" %>
							>
								Open/Varsity
							</option>

							<option 
								value="jv" 
								<% ($event_setting{"level"} eq "jv") ? "selected" : "" %>
							>
								JV
							</option>

							<option 
								value="novice" 
								<% ($event_setting{"level"} eq "novice") ? "selected" : "" %>
							>
								Novice
							</option>

							<option 
								value="champ" 
								<% ($event_setting{"level"} eq "champ") ? "selected" : "" %>
							>
								Championship
							</option>

							<option 
								value="spanish-varsity" 
								<% ($event_setting{"level"} eq "spanish-varsity") ? "selected" : "" %>
							>
								Spanish Varsity
							</option>

							<option 
								value="spanish-novice" 
								<% ($event_setting{"level"} eq "spanish-novice") ? "selected" : "" %>
							>
								Spanish Novice
							</option>

						</select>

					</span>

				</div>

%			}

%			if ($high_school) { 

				<script type="text/javascript">

					$(document).ready(function () { 
						$('.speech').hide();
						$('.debate').hide();
						$('.showmeplz').show();
					});
					
					function showNSDA(select) { 

						switch (select.selectedIndex) { 
							case 0:
								break;
							case 1: 
								$('.speech').show();
								$('.debate').hide();
								break;
							case 2:
								$('.speech').hide();
								$('.debate').hide();
								break;
							default:
								$('.speech').hide();
								$('.debate').show();
								break;
						}
					};

				</script>

%				my $event_category = $event->setting('nsda_event_category') if $event;
%				my $hidden = "hidden";
%				undef $hidden if $event && $event->type eq "speech";

				<div class="row">

					<span class="third">
						NSDA Points
					</span> 

					<span class="twothird rightalign <% $hidden ? "" : "showmeplz" %> speech">

						<select 
							name  = "nsda_speech_category"
							class = "fixedmed"
							<% $districts ? 'disabled="true"' : "" %>
						>

							<option value=""></option>

%							foreach my $category (@speech_categories) { 
								<option 
									value="<% $category->id %>"  
									<% $category->id == $event_category ? 'selected="selected"' : "" %>
								><% $category->name %></option>
%							}
						</select>
					</span>

%					$hidden = "hidden";
%					undef $hidden if $event && ($event->type ne "speech" && $event->type ne "congress");

					<span class="twothird rightalign <% $hidden ? "" : "showmeplz" %> debate">

						<select name="nsda_debate_category" class="fixedmed">

							<option value=""></option>

%							foreach my $category (@debate_categories) { 
								<option 
									value="<% $category->id %>"  
									<% $category->id == $event_category ? 'selected="selected"' : "" %>
								><% $category->name %></option>
%							}
						</select>
					</span>

				</div>
%			}

		</div>

		<div class="liblrow full rightalign marno">
			<input type="submit" value="Save">
		</div>

%		unless ($districts) { 

			<h4>Event Rules &amp; Description for website</h4>

				<div class="centeralign">
					<textarea 
						class = "full"
						name  = "description"
						s     = 10
						cols  = "59"
						wrap  = "virtual"
						><% $event_setting{"description"} %></textarea>
				</div>

			<div class="liblrow full rightalign">
				<input 
					type  = "submit"
					value = "Save"
				>
			</div>
%		} 

%		} else { 
			</div>
%		} 

		</form>

	</div>
			
	<div class="menu">
		<& 
			menu.mas, 
			add       => $add,
			tourn     => $tourn,
			whoami    => "edit",
			districts => $districts,
			event_id  => ($event) ? $event->id : ""
		&>
	</div>
