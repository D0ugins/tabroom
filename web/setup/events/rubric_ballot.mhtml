<%args>
	$tourn
	$tourn_settings
	$perms
	$person
	$person_settings
	$rows     => 1
	$event_id => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id);
	my %event_settings = $event->all_settings();

	unless ($event->tourn == $tourn) {
		$m->abort();
	}

	my $existing = $event_settings{"ballot_rubric"};

	my $counter;
	foreach my $key ( sort {$a <=> $b} keys %{$existing}) {
		$counter = $key;
	}

	if ($ARGS{'saveme'}) {

		my $total = $counter + $rows;

		undef $existing;
		my %taken;
		my $order;

		foreach my $row (1 .. $total) {
			next unless $ARGS{$row."_label"};
			next if $ARGS{$row."_label"} eq "Add New";

			my $order = $ARGS{$row."_order"};

			while ($taken{$order}) {
				$order++;
			}
			$taken{$order}++;

			$existing->{$order} = ({
				order   => $order,
				label   => $ARGS{$row."_label"},
				speaker => $ARGS{$row."_speaker"},
				min     => $ARGS{$row."_min"},
				max     => $ARGS{$row."_max"},
			});
		}

		#Fill in the gaps
		my $new;
		my $resort;

		foreach my $key ( sort {$a <=> $b} keys %{$existing} ) {
			$resort++;
			$new->{$resort} = $existing->{$key};
		}

		$event->setting("ballot_rubric", "json", $new);
		$counter = $order;

		# Do this so a refresh doesn't re-save the existing ballot after a JS
		# delete event

		my $msg = "Ballot rubric saved";
		$m->redirect("rubric_ballot.mhtml?event_id=".$event->id."&msg=$msg");
	}

	my $limit = $counter;

	foreach my $tick (1 .. $rows) {
		$counter++;
		$existing->{$counter}{"label"} = "Add New";
	}

	my $warn = "This will remove this point category entirely from the rubric.  Continue?";

</%init>

	<div class="main">

		<form
			action = "rubric_ballot.mhtml"
			method = "post"
		>
			<input
				type  = "hidden"
				name  = "event_id"
				value = "<% $event_id %>"
			>

			<input
				type  = "hidden"
				name  = "saveme"
				value = "yaskween"
			>

			<span class="threequarters nospace">
				<h4>Ballot Points Rubric for <% $event->abbr %></h4>
			</span>
			<span class="quarter nospace rightalign">

				<span class="half semibold rightalign">
					Add Rows:
				</span>

				<span class="half">
					<input
						type     = "number"
						name     = "rows"
						value    = "<% $rows %>"
						onChange = 'this.form.submit();'
					>
				</span>
			</span>

			<div class="ltyellow row semibold smallish">
				<span class="eighth">
					Order
				</span>

				<span class="threeeighths">
					Label
				</span>

				<span class="tenth hover" title="Ask for a speaker's name for these points">
					Speaker?
				</span>

				<span class="eighth" title="Minimum points accepted for this category">
					Min
				</span>

				<span class="eighth" title="Minimum points accepted for this category">
					Max
				</span>

				<span class="tenth rightalign">
				</span>
			</div>
<%perl>
			my $count;

			foreach my $key (
				sort {
					$a <=> $b
				} keys %{$existing}
			) {

				$count = $key;
</%perl>
				<div class="row" id="<% $key %>">
					<span class="eighth">
						<input
							type = "number"
							name = "<% $key %>_order"
							min  = 0
							step = 1
							value = <% $key %>
						>
					</span>
					<span class="threeeighths">
						<input
							type  = "text"
							name  = "<% $key %>_label"
							value = "<% $existing->{$key}{"label"} %>"
						>
					</span>

					<label for="<% $key %>_speaker">
						<span class="tenth leftalign hover ">
							<span class="spacer"></span>
							<input
								type  = "checkbox"
								name  = "<% $key %>_speaker"
								id    = "<% $key %>_speaker"
								value = "1"
								<% $existing->{$key}{"speaker"} ? "checked" : "" %>
							>
						</span>
					</label>

					<span class="eighth">
						<input
							type  = "number"
							name  = "<% $key %>_min"
							id    = "<% $key %>_min"
							value = "<% $existing->{$key}{"min"} %>"
						>
					</span>

					<span class="eighth">
						<input
							type  = "number"
							name  = "<% $key %>_max"
							id    = "<% $key %>_max"
							value = "<% $existing->{$key}{"max"} %>"
						>
					</span>

					<span class="tenth rightalign">
%						unless ($key > $limit) {
							<a
								class    = 'fa fa-trash fa-sm buttonwhite redtext'
								order    = "<% $key %>"
								event_id = "<% $event->id %>"
								onClick  = 'postConfirm("<% $warn %>", this, "rubric_remove.mhtml"); fixVisual();'
							></a>
%						}
					</span>
				</div>
%			}

			<div class="libl rightalign">
				<span class="third centeralign">
					<input
						type  = "submit"
						value = "Save Rubric Rows"
					>
				</span>
			</div>

		</form>

	</div>

	<div class="menu">
		<& "menu.mas",
			tourn           => $tourn,
			perms           => $perms,
			tourn_settings  => $tourn_settings,
			person          => $person,
			person_settings => $person_settings,
			whoami          => "rubric_ballot",
			event_id        => ($event) ? $event->id : ""
		&>
	</div>
