<%args>
	$tourn
	$perms
	$tourn_settings
	$person
	$person_settings
	$event_id => undef
	$add      => undef
	$err      => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

 	my @categories = sort{$a->name cmp $b->name} $tourn->categories;
	my $event = Tab::Event->retrieve($event_id) if $event_id;
	my %event_settings = $event->all_settings();

	if (scalar $tourn->events == 1 && not defined $add) {
		$event = $tourn->events->first;
	}

	$m->abort unless $event;
	my $districts = $tourn_settings->{"nsda_district"};

</%init>

	<& "/funclib/editor.mas",
		half => 1
	&>

	<div class="main">

		<h2><% $event->name %></h2>

		<&
			"tabbar.mas",
			person          => $person,
			person_settings => $person_settings,
			event           => $event,
			districts       => $districts,
			tourn_settings  => $tourn_settings,
			whoami          => "ballots"
		&>

		<form
			action   = "ballots_save.mhtml"
			method   = "post"
			enctype  = "multipart/form-data"
			name     = "congress_placard_logo"
		>

		<input
			type  = "hidden"
			name  = "event_id"
			value = "<% $event->id %>">

<%perl>
		unless (
			$event->type eq "speech"
			|| $event->type eq "congress"
			|| $event->type eq "wudc"
		) {
</%perl>

			<div class="row centeralign">
				<span class="half">
					<span class="twothirds semibold bluetext">
						Affirmative designation
					</span>

					<span class="third">
						<input
							type      = "text"
							name      = "aff_label"
							size      = "5"
							maxlength = "5"
							value     = "<% $event_settings{"aff_label"} %>"
						>
					</span>
				</span>

				<span class="half">
					<span class="twothirds semibold bluetext">
						Negative designation
					</span>

					<span class="third">
						<input
							type      = "text"
							name      = "neg_label"
							size      = "5"
							maxlength = "5"
							value     = "<% $event_settings{"neg_label"} %>"
						>
					</span>
				</span>
			</div>

%			if ($event_settings{"topic"}) {

%				my $topic = Tab::Topic->retrieve($event_settings{"topic"});

				<div class="row">

					<span class="third semibold bluetext centeralign">
						Topic
					</span>

					<span class="twothirds">
						<div class="nospace full redtext semibold padvertless">
							<% $topic->source." ".$topic->event_type." ".$topic->tag %>
						</div>
						<div class="nospace full bluetext padvertless">
							<% $topic->topic_text %>
						</div>
					</span>
				</div>

%			} else {

				<div class="row">
					<span class="third semibold bluetext centeralign">
						Topic/Resolution
					</span>

					<span class="twothirds centeralign">
						<textarea
							name      = "resolution"
							cols      = 81
							rows      = 2
						><% $event_settings{"resolution"} %></textarea>
					</span>
				</div>
%			}

			<div class="row nospace centeralign">
				<label for="combined_ballots">
					<span class="half hover marno leftalign">
						<span class="threequarters rightalign semibold bluetext">
							Combo ballots (All flights on 1 page)
						</span>

						<span class="quarter centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "combined_ballots",
								value   => $event_settings{"combined_ballots"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</span>
				</label>

				<label for="big_questions">
					<span class="half hover marno">
						<span class="half rightalign semibold bluetext">
							Big Questions ballots
						</span>

						<span class="quarter centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "big_questions",
								value   => $event_settings{"big_questions"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</span>
				</label>
			</div>
%		}

%		if ($tourn_settings->{"nsda_nats"}) {

			<h4>Message for Registration Sheets</h4>

			<div class="centeralign martop">
				<textarea
					class = "full"
					name  = "registration_notice"
					s     = 10
					cols  = "80"
					wrap  = "virtual"
				><% $event_settings{"registration_notice"} %></textarea>
			</div>
%		}

%		if ($event->type eq "wsdc") {

			<label for="wsdc_no_rfd">

				<div class="row hover">
					<span class="fivesixths">
						Double size World Schools ballots (No RFD)
					</span>

					<span class="sixth centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "wsdc_no_rfd",
								value   => $event_settings{"wsdc_no_rfd"},
								target  => $event,
								smaller => 1,
							&>
					</span>
				</div>
			</label>
%		}

%		if ($event->type eq "congress") {

			<h4>Congress Printout Settings</h4>

			<div class="row">

				<span class="sixth semibold padleft">
					Seating Charts:
				</span>

				<label for  = "congress_seating_noentrycodes">
					<span class="fifth hover">

						<span class="twothirds">
							Entry codes
						</span>

						<span class="third centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "congress_seating_entrycodes",
								value   => $event_settings{"congress_seating_entrycodes"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</span>
				</label>

				<label for  = "congress_seating_entrynames">
					<span class="fifth hover">

						<span class="twothirds">
							Entry names
						</span>

						<span class="third centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "congress_seating_entrynames",
								value   => $event_settings{"congress_seating_entrynames"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</span>
				</label>

				<label for  = "congress_seating_schoolcodes">
					<span class="fifth hover">

						<span class="twothirds">
							School codes
						</span>

						<span class="third centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "congress_seating_schoolcodes",
								value   => $event_settings{"congress_seating_schoolcodes"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</span>
				</label>

				<label for    = "congress_seating_schoolnames">
					<span class="fifth hover">

						<span class="twothirds">
							School names
						</span>

						<span class="third centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "congress_seating_schoolnames",
								value   => $event_settings{"congress_seating_schoolnames"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</span>
				</label>

			</div>

			<div class="row">

				<span class="half">

					<span class="third semibold">
						Placards print:
					</span>

					<label for="lastnames">
						<span class="third hover">
							Last names
							<input
								type  = "radio"
								name  = "congress_placard_designator"
								id    = "lastnames"
								value = "lastnames"
								<% $event_settings{"congress_placard_designator"} eq "lastnames"
									? 'checked="checked"'
									: ""
								%>
								<% $event_settings{"congress_placard_designator"}
									? ""
									: 'checked="checked"'
								%>
							>
						</span>
					</label>

					<label for="codes">
						<span class="third hover">
							Entry codes
							<input
								type  = "radio"
								name  = "congress_placard_designator"
								id    = "codes"
								value = "codes"
								<% $event_settings{"congress_placard_designator"} eq "codes"
									? 'checked="checked"'
									: ""
								%>
							>
						</span>
					</label>
				</span>

				<span class="half">
					<span class="half semibold">
						Title for entries:
					</span>

					<span class="half">
						<input
							type        = "text"
							name        = "congress_placard_title"
							size        = "18"
							maxlength   = "16"
							value       = "<% $event_settings{"congress_placard_title"} %>"
							placeholder = "Senator"
						>
					</span>
				</span>
			</div>

			<div class="row">
				<label for="noschools">
					<span class="half hover">
						<span class="twothirds semibold">
							Do not show schools on placards:
						</span>

						<span class="third centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "congress_placard_noschools",
								value   => $event_settings{"congress_placard_noschools"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</span>
				</label>

				<label for="nologo">
					<span class="half hover">
						<span class="twothirds semibold">
							Do not show logo on placards:
						</span>

						<span class="third centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "congress_placard_nologo",
								value   => $event_settings{"congress_placard_nologo"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</span>
				</label>
			</div>

			<div class="row">
				<span class="fifth semibold">
					Placard logo:
				</span>

				<span class="twofifths centeralign">
					<div class="uploader wider">
						<input
							type     = "file"
							name     = "congress_placard_logo"
							style    = "opacity: 0;"
							onchange = "uploaderName()"
							id       = "upload"
						>
						<span
							id    = "filename"
							class = "filename"
							style = "-webkit-user-select: none;"
						>No file selected</span>

						<span
							class = "action"
							style = "-webkit-user-select: none;"
						>Choose File</span>

					</div>
				</span>

				<span class="twofifths centeralign odd border">

%					if ($event_settings{'congress_placard_logo'}) {
%						my $logo_file = $event_settings{'congress_placard_logo'};

						<img
							src   = "<% $Tab::s3_url %>/<% $tourn->id."/".$event->id."/".$logo_file %>"
							alt   = "<% $logo_file %>"
							style = "max-width: 220px;"/
						>

						<div class="full">
							<span class="twothirds semibold">
								Delete Congress logo:
							</span>
							<span class="third centeralign">
								<input
									type="checkbox"
									name="delete_congress_logo"
									value="1"
								>
							</span>
						</div>

%					} elsif ($tourn_settings->{'logo'}) {
						<img
							src   = "<% $Tab::s3_url %>/<% $tourn->id."/".$tourn_settings->{"logo"} %>"
							alt   = "<% $tourn_settings->{"logo"} %>"
							style = "max-width: 220px;"/
						>
%					} else {
						None
%					}

				</span>
			</div>

			<div class="liblrow pagefull marno rightalign">
				<input
					type  = "submit"
					value = "Save Settings"
				>
			</div>
%		}

<%perl>

		if ($tourn_settings->{"legion"}) {

			my @categories = (
				"content",
				"speaking",
				"penalties"
			);

			foreach my $category (@categories) {

				my %existing;

				%existing = %{ JSON::decode_json($event_settings{$category."_points"}) }
					if $event_settings{$category."_points"};

</%perl>

				<h5><% ucfirst($category) %> ballot categories</h5>

				<div class="ltyellow semibold padvertless">

					<span class="twenty semibold centeralign">
						&nbsp;
					</span>

					<span class="threefifths">
						Category/Description
					</span>

					<span class="tenth">
						Prepared
					</span>

					<span class="tenth">
						Assigned
					</span>

					<span class="tenth">
						or Total:
					</span>
				</div>

%				foreach my $key (sort keys %existing, "New") {

					<div class="row">

						<span class="twenty semibold centeralign">
							<% $key %>
						</span>

						<span class="threefifths">
							<input
								type  = "text"
								name  = "<% $category."_".$key %>_text"
								value = "<% $existing{$key}{"text"} %>"
								size  = "64"
							>
						</span>

						<span class="tenth">
							<input
								type  = "number"
								name  = "<% $category."_".$key %>_prepared"
								value = "<% $existing{$key}{"prepared"} %>"
								size  = "8"
								min   = -99
								max   = 99
							>
						</span>

						<span class="tenth">
							<input
								type  = "number"
								name  = "<% $category."_".$key %>_assigned"
								value = "<% $existing{$key}{"assigned"} %>"
								size  = "8"
								min   = -99
								max   = 99
							>
						</span>

						<span class="tenth">
							<input
								type  = "number"
								name  = "<% $category."_".$key %>_total"
								value = "<% $existing{$key}{"total"} %>"
								size  = "8"
								min   = -99
								max   = 99
							>
						</span>

					</div>

%				}

%			}

%		}

		<h4>Text on top ballots</h4>

		<div class="centeralign martop">
			<textarea
				class = "full"
				name  = "ballot_rules"
				s     = 10
				cols  = "80"
				wrap  = "virtual"
			><% $event_settings{"ballot_rules"} %></textarea>

		</div>

		<h4>Text on Chair/Parli ballots only</h4>

		<div class="centeralign martop">
			<textarea
				class = "full"
				name  = "ballot_rules_chair"
				s     = 10
				cols  = "80"
				wrap  = "virtual"
			><% $event_settings{"ballot_rules_chair"} %></textarea>

		</div>

		<h4>Message beneath scores</h4>

		<div class="centeralign martop">
			<textarea
				class = "full"
				name  = "dumb_signature_line"
				s     = 5
				cols  = "80"
				wrap  = "virtual"
			><% $event_settings{"dumb_signature_line"} %></textarea>
		</div>

<%perl>
		unless (
			$event->type eq "speech"
			|| $event->type eq "congress"
			|| $event->type eq "wudc"
		) {
</%perl>

			<div class="full nospace row martopmore">

				<span class="quarter">
					<h4>Info Boxes</h4>
				</span>

				<span class="threequarters rightalign explain">
					Use ellipses (...) to right justify text.  "1AC...8
					min" will right-justify "8 min" with leading dots.
				</span>

			</div>

			<div class="row centeralign">

				<span class="half leftalign">
					<h6>Speech Times:</h6>

					<textarea
						class = "half"
						name  = "speech_times"
						s     = 6
						cols  = "36"
						wrap  = "virtual"
						><% $event_settings{"speech_times"} %></textarea>

				</span>

				<span class="half leftalign ">

					<h6>Point Scale:</h6>

					<textarea
						class = "half"
						name  = "point_scale"
						s     = 6
						cols  = "36"
						wrap  = "virtual"
						><% $event_settings{"point_scale"} %></textarea>
				</span>
			</div>
%		}

%	 	if ($event->type eq "congress") {

			<h4>Message/Rules for Student Ballots</h4>

			<div class="centeralign">
				<textarea
					class = "full"
					name  = "student_vote_message"
					s     = 10
					cols  = "59"
					wrap  = "virtual"
					><% $event_settings{"student_vote_message"} %></textarea>
			</div>

%		} elsif ($event->type eq "speech") {

%		} else {

			<h4>Instructions/Message for Strike Cards</h4>

			<div class="centeralign marbottom">
				<textarea
					class = "full"
					name  = "strike_card_message"
					s     = 10
					cols  = "59"
					wrap  = "virtual"
					><% $event_settings{"strike_card_message"} %></textarea>
			</div>
%		}

		<div class="liblrow pageful marno rightalign">
			<input
				type  = "submit"
				value = "Save Messages"
			>
			</form>
		</div>

	</div>

	<div class="menu">
		<& "menu.mas",
			tourn           => $tourn,
			perms           => $perms,
			tourn_settings  => $tourn_settings,
			person          => $person,
			person_settings => $person_settings,
			whoami          => "ballots",
			event_id        => ($event) ? $event->id : ""
		&>
	</div>
