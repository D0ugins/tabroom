<%args>
	$tourn
	$person
	$events => undef
</%args>
<%init>

	my @patterns = $tourn->patterns;
	my %pattern_by_id = map {$_->id => $_} @patterns;

</%init>

    <div class="menu"> 
		<& menu.mas, tourn => $tourn, whoami => "double" &>
	</div> 

	<script>

		function updateTab(input) { 

			$(".tabs").removeClass("selected");
			$(".screens").addClass("hidden");

			$("#"+input).addClass("selected");
			$("."+input).removeClass("hidden");

			return;
		}

	</script>
	
	<div class="main">
		
		<h2>Double Entry Patterns</h2>

		<ul id="tabnav" class="marbottom">
			
			<li id="settings" class="tabs <% $events ? "" : "selected" %>" onClick="updateTab('settings')">
				Settings
			</li>

			<li id="events" class="tabs <% $events ? "selected" : "" %>" onClick="updateTab('events')">
				Event Assignments
			</li>

		</ul>

		<div class="screens settings <% $events ? "hidden" : "" %>">

			<form action="double_settings_save.mhtml">

			<div class="full even">

				<span class="third">
					Tournament-wide setting:
				</span>

				<span class="third">

					<select name="double_entry" class="fixedmed plain"> 
					
						<option 
							value="none" 
							<% ($tourn->setting("double_entry") eq "none") ? "selected" : "" %>
						>No Double Entry Allowed</option> 
					
						<option 
							value="max_events" 
							<% ($tourn->setting("double_entry") eq "max_events") ? "selected" : ""  %>
						>Allow up to maximum</option> 
	
						<option 
							value="unlimited" 
							<% ($tourn->setting("double_entry") eq "unlimited") ? "selected" : "" %>
						>Unlimited Double Entry</option> 
					
					</select> 
				</span>

				<span class="sixth rightalign">
					Maximum: 
				</span>

				<span class="sixth">
					<input 
						type="number" 
						name="double_max" 
						value="<% $tourn->setting("double_max") %>" 
						size="3" 
						min=0 
						max=100 
						class=""
					>
				</span>
			</div>

		<h4>Exclusivity Patterns</h4>
			
		<table>

			<tr class="yellow">

				<th>
					Name
				</th>

				<th>
					Cross entry limits (pick one)
				</th>

				<th class="smallish">
					No cross w/
				</th>

				<th>
				</th>

			</tr>

%				foreach my $pattern (sort {$a->name cmp $b->name} @patterns) { 

<%perl>

					my %excludeds = ();

					my $exclude = $pattern->exclude;

					if ($exclude && ($pattern_by_id{$exclude})) { 

						$excludeds{$exclude}++;

						$pattern->exclude(JSON::encode_json(\%excludeds));
						$pattern->update;

					} elsif ($exclude) { 

						%excludeds = %{ JSON::decode_json($pattern->exclude) };

					}

</%perl>

					<tr class="row">		
							
						<td>
							<input 
								type="text" 
								name="name_<% $pattern->id %>" 
								value="<% $pattern->name %>" 
								size="16">
						</td>

						<td class="nospace">

							<label for="<% $pattern->id %>_2">
								<span class="half hover">
									<input 
										type="radio" 
										id="<% $pattern->id %>_2" 
										name="<% $pattern->id %>" 
										value="2" <% ($pattern->type == 2) ? "checked" : ""%>>
									None
								</span>
							</label>

							<label for="<% $pattern->id %>_1">
								<span class="half hover">
									<input 
										type="radio" 
										id="<% $pattern->id %>_1" 
										name="<% $pattern->id %>" 
										value="1" <% ($pattern->type == 1) ? "checked" : ""%>>
									None w/in group 
								</span>
							</label>

							<label for="<% $pattern->id %>_3">
								<span class="half hover nospace">

									<span class="half">
										<input 
											type="radio" 
											id="<% $pattern->id %>_3" 
											name="<% $pattern->id %>" 
											value="3" <% ($pattern->type == 3) ? "checked" : ""%>>
										Max of
									</span>

									<span class="half">
										<input 
											type="number" 
											name="max_<% $pattern->id %>" 
											value="<% $pattern->max %>" 
											min=0 
											max=9 
											size=2 
											class="thin"
										>
									</span>
								</span>
							</label>

							<label for="<% $pattern->id %>_0">
								<span class="half hover">
									<input 
										type="radio" 
										id="<% $pattern->id %>_0" 
										name="<% $pattern->id %>" 
										value="0" <% ($pattern->type == 0) ? "checked" : ""%>>
									Any
								</span>
							</label>

						</td>

						<td class="centeralign">

%							foreach my $exclude_id (keys %excludeds) { 

%								next unless $pattern_by_id{$exclude_id} && $pattern_by_id{$exclude_id}->id;

								<a 
									class="plain redtext block hover smallish padless leftalign" 
									href="pattern_exclude_rm.mhtml?exclude_id=<% $exclude_id %>&pattern_id=<% $pattern->id %>">
									<% $pattern_by_id{$exclude_id}->name %>
								</a>

%							}

							<select 
								name="<% $pattern->id %>_exclude" 
								class="fixedtiny plain martop">

								<option value=""></option>

%								foreach my $ed (sort {$a->name cmp $b->name} $tourn->patterns) {
%									next if $excludeds{$ed->id};
									<option value="<% $ed->id %>"> <% $ed->name %> </option>
%								}

							</select>
						</td>

						<td class="smallish centeralign">
							<a 
								class="redtext hover fa fa-trash fa-2x button" 
								href="pattern_rm.mhtml?pattern_id=<% $pattern->id %>">
							</a>
						</td>

					</tr>

%				}

				<tr class="liblrow">

					<td align="center">
						<a class="dkblue button" href="pattern_add.mhtml">
							Add
						</a>
					</td>

					<td colspan="3" align="right">
						<input type="submit" value="Save Double Entry Settings" >
						</form>
					</td>
				</tr>

			</table>

			</div>

			<div class="events <% $events ? "" : "hidden" %> screens">

			<h4>Place Events in Cross Entry Groups</h4>

			<form action="event_patterns_save.mhtml">

%			my $counter++;

			<div class="full row">

%			foreach my $event (sort {$a->name cmp $b->name} 
%				$m->comp("/funclib/tourn_events.mas", tourn => $tourn)) { 

%				if ($counter++ % 2) { 

					</div>
					<div class="full row">
%				}

				<span class="half">

					<span class="half">
						<% $event->name %> 
					</span>

					<span class="half">

						<select name="<% $event->id %>" class="fixedsmall plain">

							<option value="">----</option>

%							foreach my $pattern (sort {$a->name cmp $b->name} $tourn->patterns) { 
								<option 
									value="<% $pattern->id %>" 
									<% ($event->pattern && $event->pattern->id == $pattern->id) ? "selected" : "" %>
									><% $pattern->name %></option>
%							}
						</select>
					</span>
				</span>
%			}

			</div>


			<div class="full liblrow rightalign">
				<input type="submit"  value="Save Event Groupings">
				</form>
			</div>

			</div>

	</div>

	
