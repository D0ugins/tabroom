<%args>
	$tourn
	$person
	$events => undef
</%args>
<%init>

	my @patterns = $tourn->patterns;
	my %pattern_by_id = map {$_->id => $_} @patterns;

	my $double_entry = $tourn->setting("double_entry");
	my $double_max = $tourn->setting("double_max");

</%init>

	<script>

		function revealMax(input) { 

			if (input.value == "3") { 
				$(".max_"+input.id).removeClass("hidden");
			} else {
				$(".max_"+input.id).addClass("hidden");
			}

		}

		function revealTournMax() { 

			var answer = $("#double_entry").val();

			if (answer === "max_events") { 
				$(".totalmax").removeClass("hidden");
			} else {
				$(".totalmax").addClass("hidden");
			}

		}

	</script>

    <div class="menu"> 
		<& menu.mas, tourn => $tourn, whoami => "double" &>
	</div> 

	<script>

		function updateTab(input) { 

			$(".tabs").removeClass("selected");
			$(".screens").addClass("hidden");

			$("#"+input).addClass("selected");
			$("."+input).removeClass("hidden");

			return;
		}

	</script>
	
	<div class="main">
		
		<h2>Double Entry Patterns</h2>

		<ul 
			id    = "tabnav"
			class = "marbottom">
			
			<li 
				id    = "settings"
				class = "tabs <% $events ? "" : "selected" %>" onClick = "updateTab('settings')"
			>
				Settings
			</li>

			<li 
				id    = "events"
				class = "tabs <% $events ? "selected" : "" %>" onClick = "updateTab('events')"
			>
				Event Assignments
			</li>

		</ul>

		<div class="screens settings <% $events ? "hidden" : "" %>">

			<form 
				action = "double_settings_save.mhtml"
				method = "post"
			>

			<div class="full even">

				<span class="quarter">
					Tournament-wide limit
				</span>

				<span class="third">

					<select 
						id       = "double_entry"
						name     = "double_entry"
						class    = "doublers fixedmed"
						onChange = "revealTournMax();"
					>
					
						<option 
							value="none" 
							<% ($double_entry eq "none") ? "selected" : "" %>
						>No Double Entry Allowed</option> 
					
						<option 
							value="max_events" 
							<% ($double_entry eq "max_events") ? "selected" : ""  %>
						>Allow up to maximum</option> 
	
						<option 
							value="unlimited" 
							<% ($double_entry eq "unlimited") ? "selected" : "" %>
						>Unlimited Double Entry</option> 
					
					</select> 
				</span>

				<span class="fifth rightalign">
					<div class="nospace full totalmax <% $double_entry eq "max_events" ? "" : "hidden" %> ">
						Max total entries
					</div>
				</span>

				<span class="tenth">
					<div class="nospace full totalmax <% $double_entry eq "max_events" ? "" : "hidden" %> ">
						<input 
							type  = "number"
							name  = "double_max"
							value = "<% $tourn->setting("double_max") %>"
							size  = "3"
							min   = 0
							max   = 100
							class = "smaller"
						>
					</div>
				</span>

				<span class="tenth centeralign">
					<input 
						type  = "submit"
						value = "Save"
						class = "thin"
					>
				</span>

			</div>

			<div class="nospace">

				<span class="threequarters">
					<h4>Exclusivity Patterns</h4>
				</span>

				<span class="quarter rightalign">
					<a class="dkblue button" href="pattern_add.mhtml">
						Add New
					</a>
				</span>

			</div>

%			foreach my $pattern (sort {$a->name cmp $b->name} @patterns) { 

<%perl>
				my %excludeds = ();

				my $exclude = $pattern->exclude;

				if ($exclude && $pattern_by_id{$exclude}) { 

					$excludeds{$exclude} = 1;
					$pattern->exclude(JSON::encode_json(\%excludeds)) if %excludeds;
					$pattern->update;

				} elsif ($exclude) { 

					eval { %excludeds = %{ JSON::decode_json($exclude) }; };

				}

</%perl>

				<div class="yellowrow padless">

					<span class="half">

						<input 
							type="text" 
							name="name_<% $pattern->id %>" 
							value="<% $pattern->name %>" 
							size="32"
						>

					</span>

					<span class="twofifths">

%						my $notfirst;

%						foreach my $event ($pattern->events) {
%							$m->print(", ") if $notfirst++;
%							$m->print($event->abbr);
%						}
					</span>

					<span class="eighth rightalign">
						<a 
							class="redtext hover fa fa-trash fa-lg button" 
							href="pattern_rm.mhtml?pattern_id=<% $pattern->id %>">
						</a>
					</span>

				</div>

				<div class="row">

					<span class="half borderright nospace top">

						<div class="full marless padleftmore top">

							<select 
								class = "fixedmed plain"
								id    = "<% $pattern->id %>"
								name  = <% $pattern->id %> onChange = "revealMax(this);">

								<option 
									value="2" 
									<% $pattern->type == 2 ? 'selected="selected"' : "" %>
									>No cross entry (w/any pattern)</option>

								<option 
									value="0" 
									<% $pattern->type == 0 ? 'selected="selected"' : "" %>
									>Unlimited</option>

								<option 
									value="3" 
									<% $pattern->type == 3 ? 'selected="selected"' : "" %>
									>Limited pattern</option>

							</select>

						</div>

						<div 
							class="
								full
								marless
								padless
								padleftmore
								max_<% $pattern->id %> 
								<% $pattern->type == 3 ? "" : "hidden" %>">

								Max entries w/n pattern:

								<input 
									type  = "number"
									title = "Competitors can enter only this many events in this pattern"
									name  = "max_<% $pattern->id %>"
									value = "<% $pattern->max ? $pattern->max : "1" %>"
									min   = 1
									max   = 99
									size  = 2
									class = "smaller"
								>

						</div>

					</span>

					<span class="quarter">

						<p>No cross entry w/:</p>

%							foreach my $exclude_id (keys %excludeds) { 

%								next unless $pattern_by_id{$exclude_id} && $pattern_by_id{$exclude_id}->id;

%								# Yeah, I have no idea how to pithily explain or label
%								# this one. 

%								next if $excludeds{$exclude_id} eq "same_pattern_only";

								<a 
									class="plain redtext block hover smallish padless leftalign nowrap" 

									href="pattern_exclude_rm.mhtml?exclude_id=<% $exclude_id %>&pattern_id=<% $pattern->id %>">
										<% $pattern_by_id{$exclude_id}->name %>
								</a>

%							}

							<div class="full nospace">

								<span class="quarter smallish rightalign">
									Add:
								</span>

								<span class="twothirds">

									<select 
										name="<% $pattern->id %>_exclude" 
										onChange="this.form.submit();"
										class="fixedtiny plain martop">

										<option value=""></option>

%										foreach my $ed (sort {$a->name cmp $b->name} $tourn->patterns) {
%											next if $excludeds{$ed->id};
%											next if $pattern->id == $ed->id;
											<option value="<% $ed->id %>"> <% $ed->name %> </option>
%										}

									</select>
								</span>

							</div>

						</span>

						<span class="quarter">

							<p>Only cross w/one of</p>

%							foreach my $exclude_id (keys %excludeds) { 

%								next unless $pattern_by_id{$exclude_id} && $pattern_by_id{$exclude_id}->id;
%								next unless  $excludeds{$exclude_id} eq "same_pattern_only";

								<a 
									class="plain redtext block hover smallish padless leftalign nowrap" 
									href="pattern_exclude_rm.mhtml?exclude_id=<% $exclude_id %>&pattern_id=<% $pattern->id %>">
									<% $pattern_by_id{$exclude_id}->name %>
								</a>

%							}

							<div class="full nospace">

								<span class="quarter smallish rightalign">
									Add:
								</span>

								<span class="twothirds">

									<select 
										name="<% $pattern->id %>_exclude_same_pattern" 
										onChange="this.form.submit();"
										class="fixedtiny plain martop">

										<option value=""></option>

%										foreach my $ed (sort {$a->name cmp $b->name} $tourn->patterns) {
%											next if $pattern->id == $ed->id;
%											next if $excludeds{$ed->id};
											<option value="<% $ed->id %>"> <% $ed->name %> </option>
%										}

									</select>

								</span>
							</div>

						</span>

					</div>

%				}

				<div class="liblrow rightalign">
					<input type="submit" value="Save Double Entry Settings" >
					</form>
				</div>

			</div>

			<div class="events <% $events ? "" : "hidden" %> screens">

				<h4>Place Events in Cross Entry Groups</h4>

				<form action="event_patterns_save.mhtml">

%				my $counter++;

				<div class="full row">

%				foreach my $event (sort {$a->name cmp $b->name} 
%					$m->comp("/funclib/tourn_events.mas", tourn => $tourn)) { 

%					if ($counter++ % 2) { 

						</div>
						<div class="full row">
%					}

					<span class="half">

						<span class="half">
							<% $event->name %> 
						</span>

						<span class="half">

							<select name="<% $event->id %>" class="fixedsmall plain">

								<option value="">----</option>

%								foreach my $pattern (sort {$a->name cmp $b->name} $tourn->patterns) { 
									<option 
										value="<% $pattern->id %>" 
										<% ($event->pattern && $event->pattern->id == $pattern->id) ? "selected" : "" %>
										><% $pattern->name %></option>
%								}
							</select>
						</span>
					</span>
%				}

				</div>


				<div class="full liblrow rightalign">
					<input type="submit"  value="Save Event Groupings">
					</form>
				</div>

			</div>

	</div>

	
