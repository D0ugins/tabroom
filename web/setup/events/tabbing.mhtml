<%args>
	$person
	$tourn
	$tourn_settings
	$event_id => undef
</%args>
<%init>

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

 	my @categories = sort{$a->name cmp $b->name} $tourn->categories;

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	$m->redirect("edit.mhtml") unless $event;

	my %event_settings = $event->all_settings;

	unless ($event->category) { 
		my $err = "Your event is not assigned to a judge category.  You must do that before going further";
		$m->redirect("edit.mhtml?err=$err&event=$event_id");
	}

</%init>

    <script type="text/javascript"> 
		function showMe (it) { 
			$("."+it).toggleClass("hidden");
		} 
    </script>

    <div class="main">

        <h2><% $event->name %></h2>

        <& 
			tabbar.mas, 
			event     => $event,
			whoami    => "tabbing"
		&>
    
		<form 
			action="tabbing_save.mhtml" 
			method="post">

		<input 
			type  = "hidden"
			name  = "event_id"
			value = "<% $event->id %>"
		>

		<span class="pagehalf">

			<h4>Input</h4>

%			my $increments = $event_settings{"point_increments"} if $event;

			<div class=" row">

				<span class="half">
					Point increments
				</span>

				<span class="half rightalign">

					<select name="point_increments" class="fixedsmall">

						<option value="whole" <% ($increments eq "whole") ? "selected" : "" %>>
							Whole
						</option>

						<option value="half" <% ($increments eq "half") ? "selected" : "" %>>
							Half
						</option>

						<option value="fourths" <% ($increments eq "fourths") ? "selected" : "" %>>
							.25
						</option>

						<option value="tenths" <% ($increments eq "tenths") ? "selected" : "" %>>
							.10
						</option>

					</select>
				</span>
			</div>

%			unless ($event->type eq "speech" || $event->type eq "congress") { 

				<label for="team_points">
					<div class="hover row">
						<span class="fivesixth ">
							Give team points, not per-speaker
						</span>
						<span class="sixth centeralign">
							<input  
								type  = "checkbox"
								name  = "team_points"
								id    = "team_points"
								value = "1"
								<% $event_settings{"team_points"} ? 'checked' : ''  %>>
						</span>
					</div>
				</label>
%			}

%			unless ($event->type eq "wudc") { 

%				if ($event->type eq "speech") { 

					<label for="allow_lowpoints">
						<div class="hover row">
							<span class="fivesixth ">
								Allow lower points to go to better ranks
							</span>
							<span class="sixth centeralign">
								<input 
									type  = "checkbox"
									id    = "allow_lowpoints"
									name  = "allow_lowpoints"
									value = "1"
									<% $event_settings{"allow_lowpoints"} ? "checked" : "" %>>
							</span>
						</div>
					</label>

%				} elsif ($event->type ne "congress" && $event->type ne "wudc") { 

					<label for="no_lpw">
						<div class="hover row">
							<span class="fivesixth ">
								Forbid low-point wins
							</span>
							<span class="sixth centeralign">
								<input 
									type  = "checkbox"
									id    = "no_lpw"
									name  = "no_lpw"
									value = "1"
									<% $event_settings{"no_lpw"} ? "checked" : "" %>
								>
							</span>
						</div>
					</label>

%				} 

				<label for="point_ties">
					<div class="hover row">
						<span class="fivesixth ">
							Allow tied points
						</span>
						<span class="sixth centeralign">
							<input 
								type  = "checkbox"
								id    = "point_ties"
								name  = "point_ties"
								value = "1"
								<% $event_settings{"point_ties"} ? 'checked' : '' %>
							> 
						</span>
					</div>
				</label>

%			}

%			if ($event->type eq "speech" || $event->type eq "congress") { 

				<label for="allow_rank_ties">

					<div class="hover row">

						<span class="fivesixth ">
							Allow rank ties
						</span>

						<span class="sixth centeralign">
							<input 
								type  = "checkbox"
								id    = "allow_rank_ties"
								name  = "allow_rank_ties"
								value = "1"
								<% $event_settings{"allow_rank_ties"} ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<label for="truncate_fill">

					<div class="hover row">

						<span class="threequarters ">
							Auto-fill blank ranks on ballot with:
						</span>

						<span class="quarter centeralign">
							<input 
								type  = "number"
								id    = "truncate_fill"
								name  = "truncate_fill"
								value = "<% $event_settings{"truncate_fill"} %>"
							>
						</span>
					</div>
				</label>
%			}


%			if ($event->type eq "congress") { 

				<label for="points_later">

					<div class="hover row">

						<span class="fivesixth ">
							Enter Ranks &amp; Scores separately
						</span>

						<span class="sixth centeralign">
							<input 
								type  = "checkbox"
								id    = "points_later"
								name  = "points_later"
								value = "1"
								<% $event_settings{"points_later"} ? 'checked' : '' %>
							> 
						</span>
					</div>
				</label>	

				<label for="parli_ballot">

					<div class="hover row">

						<span class="fivesixth ">
							Enter Parli ballot once in prelims
						</span>

						<span class="sixth centeralign">
							<input 
								type  = "checkbox"
								id    = "parli_ballot"
								name  = "parli_ballot"
								value = "1"
								<% $event_settings{"parli_ballot"} ? 'checked' : '' %>
							> 
						</span>
					</div>
				</label>	

%			}

%			if ($event->type eq "wsdc") { 

				<label for="wsdc_subtotal_ballot">

					<div class="row hover">

						<span class="fivesixths">
							Show WSDC subpoints on tab entry:
						</span>

						<span class="sixth centeralign">

							<input 
								type    = "checkbox"
								id      = "wsdc_subtotal_ballot"
								name    = "wsdc_subtotal_ballot"
								value   = "1"
								onclick = "showMe('subpoints')"
								<% $event_settings{"wsdc_subtotal_ballot"} ? 'checked="checked"' : "" %> 
							> 
						</span>
					</div>
				</label>

				<div class="subpoints <% $event_settings{"wsdc_subtotal_ballot"} ? "" : "hidden" %>">

					<div class="row">

						<span class="quarter strong padleft">
							Style
						</span>

						<span class="third centeralign">
							Min:
							<input 
								type  = "text"
								class = "thin"
								name  = "min_style_points"
								value = "<% $event_settings{"min_style_points"} %>"
								size  = "5"
							>
						</span>

						<span class="third centeralign marno">
							Max:
							<input 
								type  = "text"
								class = "thin"
								name  = "max_style_points"
								value = "<% $event_settings{"max_style_points"} %>"
								size  = "5"
							>

						</span>
					</div>

					<div class="row">

						<span class="quarter strong padleft">
							Content
						</span>
						<span class="third centeralign">
							Min:
							<input 
								type  = "text"
								class = "thin"
								name  = "min_content_points"
								value = "<% $event_settings{"min_content_points"} %>"
								size  = "5"
							>
						</span>
						<span class="third centeralign marno">
							Max:
							<input
								type  = "text"
								class = "thin"
								name  = "max_content_points"
								value = "<% $event_settings{"max_content_points"} %>"
								size  = "5"
							>
						</span>
					</div>


					<div class="row">
						<span class="quarter strong padleft">
							Strategy
						</span>
						<span class="third centeralign">
							Min:
							<input 
								type  = "text"
								class = "thin"
								name  = "min_strategy_points"
								value = "<% $event_settings{"min_strategy_points"} %>"
								size  = "5"
							>
						</span>
						<span class="third centeralign marno">
							Max:
							<input 
								type  = "text"
								class = "thin"
								name  = "max_strategy_points"
								value = "<% $event_settings{"max_strategy_points"} %>"
								size  = "5"
							>
						</span>
					</div>

					<div class="row">

						<span class="quarter strong padleft">
							POIs
						</span>

						<span class="third centeralign ">
							Min:
							<input 
								type  = "text"
								class = "thin"
								name  = "min_poi_points"
								value = "<% $event_settings{"min_poi_points"} %>"
								size  = "5"
							>
						</span>
						<span class="third centeralign marno">
							Max: 
							<input 
								type  = "text"
								class = "thin"
								name  = "max_poi_points"
								value = "<% $event_settings{"max_poi_points"} %>"
								size  = "5"
							>
						</span>
					</div>

				</div>

%			}

			<div 
				class="subpoints <% $event_settings{"wsdc_subtotal_ballot"} ? "hidden" : "" %>">

				<div class=" row">

					<span class="twothird ">
						Minimum speaker points
					</span>

					<span class="third rightalign">
						<input 
							type  = "text"
							class = "thin"
							name  = "min_points"
							size  = "5"
							value = "<% $event_settings{"min_points"} %>"
						>
					</span>
				</div>

				<div class=" row">
					<span class="twothird ">
						Maximum speaker points
					</span>
					<span class="third rightalign">
						<input 
							type  = "text"
							class = "thin"
							name  = "max_points"
							size  = "5"
							value = "<% $event_settings{"max_points"} %>"
						>
					</span>
				</div>

			</div>

			<label for="online_ballots">

				<div class="hover row">

					<span class="fivesixth ">
						Online Ballots
					</span>

					<span class="sixth centeralign">
						<input 
							type    = "checkbox"
							id      = "online_ballots"
							name    = "online_ballots"
							value   = "1"
							onclick = "showMe('onlineballots')"
							<% $event_settings{"online_ballots"} ? 'checked' : '' %>
						>
					</span>
				</div>
			</label>

			<div class="subpoints <% $event_settings{"wsdc_subtotal_ballot"} ? "hidden" : "" %>">

			<div class="onlineballots <% $event_settings{"online_ballots"} ? "" : "hidden" %>">

				<div class="row">

					<span class="twothird ">
						Min online ballot points
					</span>

					<span class="third rightalign">

						<input 
							type  = "text"
							class = "thin"
							name  = "min_ob_points"
							value = "<% $event_settings{"min_ob_points"} ? $event_settings{"min_ob_points"} : "0" %>"
							size  = "5">
					</span>
				</div>

				<div class="oddrow">

					<span class="twothird ">
						Max online ballot points
					</span>

					<span class="third rightalign">
						<input 
							type="text" 
							class="thin" 
							size="5"
							name="max_ob_points" 
							value="<% $event_settings{"max_ob_points"} ? $event_settings{"max_ob_points"} : "30" %>" 
							>
					</span>

				</div>

%				if ($event->type ne 'speech') { 

					<div class="row">

						<span class="twothird ">
							Min word count in RFDs:
						</span>

						<span class="third rightalign">
							<input 
								type  = "text"
								class = "thin"
								name  = "comments_plz"
								size  = "5"
								value = "<% $event_settings{"comments_plz"} ? $event_settings{"comments_plz"} : "" %>"
							>
						</span>

					</div>

%				} elsif ($event->type ne 'congress') { 

					<div class=" row">

						<span class="twothird ">
							Min word count in comments:
						</span>

						<span class="third rightalign">
							<input 
								type  = "text"
								class = "thin"
								name  = "rfd_plz"
								size  = "5"
								value = "<% $event_settings{"rfd_plz"} ? $event_settings{"rfd_plz"} : "" %>"
							>
						</span>

					</div>
%				}

			</div>

			</div>

		</span>

		<span class="pagehalf">
			
			<h4>Output</h4>

%			unless ($event->type eq "speech" || $event->type eq 'congress') { 

				<div class=" row">

					<span class="half ">
						Speaker awards:
					</span>

					<span class="half centeralign">

%						my $set = $event_settings{"speaker_tbset"} if $event;

						<select name="speaker_tbset" class="fixedsmall">

							<option value="">None</option>

%							foreach my $tiebreak_set (Tab::TiebreakSet->search( tourn => $tourn->id)) { 

								<option value="<% $tiebreak_set->id %>" <% $tiebreak_set->id == $set ? "selected" : "" %>>
									<% $tiebreak_set->name %>
								</option>

%							}

						</select>
					</span>

				</div>

				<label for="show_averages">

					<div class="hover row">

						<span class="fivesixth">
							Speaker awards by averages, not totals
						</span>

						<span class="sixth centeralign">
							<input 
								type  = "checkbox"
								id    = "show_averages"
								name  = "show_averages"
								value = "1"
								<% $event_settings{"show_averages"} ? 'checked' : '' %>
							> 
						</span>

					</div>
				</label>

%			}


%			if ($event->type eq "wsdc") { 

				<div class=" row">
					<span class="threequarters">
						Limit speaker scores to top
					</span>
					<span class="quarter rightalign">
						<input 
							type  = "text"
							class = "thin"
							name  = "speaker_max_scores"
							size  = "5"
							value="<% $event_settings{"speaker_max_scores"} %>" 
						>
					</span>
				</div>

				<div class=" row">
					<span class="threequarters">
						Quota of speeches for speaker awards
					</span>
					<span class="quarter rightalign">
						<input 
							type  = "text"
							class = "thin"
							name  = "speaker_min_speeches"
							size  = "5"
							value="<% $event_settings{"speaker_min_speeches"} %>" 
						>
					</span>
				</div>

				<label for="wsdc_bye_win_average">
					<div class=" row">
						<span class="fivesixths">
							Bye rounds get average wins &amp; ballots
						</span>
						<span class="sixth centeralign">
							<input 
								type  = "checkbox"
								id    = "wsdc_bye_win_average"
								name  = "wsdc_bye_win_average"
								value = "1"
								<% $event_settings{"wsdc_bye_win_average"} ? 'checked="checked"' : "" %> 
							>
						</span>
					</div>
				</label>

				<label for="include_wsdc_reply">
					<div class=" row">
						<span class="fivesixths">
							Include replies (x2) in speaker average
						</span>
						<span class="sixth centeralign">
							<input 
								type  = "checkbox"
								id    = "include_wsdc_reply"
								name  = "include_wsdc_reply"
								value = "1"
								<% $event_settings{"include_wsdc_reply"} ? 'checked="checked"' : "" %> 
							>
						</span>
					</div>
				</label>


%			} else { 

%				unless ($event->type eq "speech" || $event->type eq "congress") { 

%					my $mavericks = $event_settings{"mavericks"};

					<div class=" row">

						<span class="third">
							Mavericks get:
						</span>

						<span class="twothird rightalign">
							<select name="mavericks" class="fixedmed">
								<option value="average" <% $mavericks eq "average" ? "selected" : "" %>>
									Points averaged, max ranks
								</option>

								<option value="double" <% $mavericks eq "double" ? "selected" : "" %>>
									Points doubled, ranks +1
								</option>

								<option value="nothing" <% $mavericks eq "nothing" ? "selected" : "" %>>
									No points, max ranks
								</option>
							</select>
						</span>

					</div>

%				}
%			}

			<div class="row">

				<span class="half">
					Recognize top novices
				</span>

				<span class="half rightalign">

%					my $top_novice = $event_settings{"top_novice"};

					<select name="top_novice" class="fixedsmall">

						<option value="none" <% ( $top_novice eq "none") ? "selected" : "" %>>
							None
						</option>

						<option value="top" <% ( $top_novice eq "top") ? "selected" : "" %>>
							Overall
						</option>

						<option value="noelim" <% ( $top_novice eq "noelim") ? "selected" : "" %>>
							Non-advancing
						</option>

					</select>

				</span>
			</div>

%			if ($event->type eq "speech" || $event->type eq "congress") { 

				<label for="honorable_mentions">	

					<div class="hover row">

						<span class="fivesixth">
							Recognize honorable mentions 
							<p class="explain nospace">non-advancers tied on ranks</p>
						</span>

						<span class="sixth centeralign">
							<input 
								type  = "checkbox"
								id    = "honorable_mentions"
								name  = "honorable_mentions"
								value = "1"
								<% $event_settings{"honorable_mentions"} ? 'checked' :'' %>
							> 
						</span>
					</div>
				</label>
%			}

			<label for="omit_sweeps">	

				<div class="hover row">

					<span class="fivesixth">
						Omit event from sweeptsakes
					</span>

					<span class="sixth centeralign">
						<input 
							type  = "checkbox"
							id    = "omit_sweeps"
							name  = "omit_sweeps"
							value = "1"
							<% $event_settings{"omit_sweeps"} ? 'checked' :'' %>> 
					</span>

				</div>
			</label>


		</span>

		<div class="liblrow rightalign">
			<input type="submit" value="Save Tabbing Settings">
			</form>
		</div>

	</div>
		
	<div class="menu">
		<& "menu.mas", 
			person   => $person,
			tourn    => $tourn,
			whoami   => "tabbing",
			event_id => $event->id
		&>
	</div>

