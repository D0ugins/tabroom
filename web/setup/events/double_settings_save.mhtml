<%args>
	$tourn
	$double_entry => undef
	$double_max   => undef
</%args>
<%init>

	use Data::Dumper;

	$tourn->setting("double_entry", $double_entry);
	$tourn->setting("double_max", $double_max);

	foreach my $pattern ($tourn->patterns) { 

		$pattern->name($ARGS{"name_".$pattern->id});
		$pattern->type($ARGS{$pattern->id});
		$pattern->max($ARGS{"max_".$pattern->id});

		if ($ARGS{$pattern->id."_exclude"}) { 

			my %excludeds = %{ JSON::decode_json($pattern->exclude) } if $pattern->exclude;
			$excludeds{$ARGS{$pattern->id."_exclude"}} = 1;
			$pattern->exclude(JSON::encode_json(\%excludeds));

		} elsif ($ARGS{$pattern->id."_exclude_same_pattern"}) { 

			my %excludeds = %{ JSON::decode_json($pattern->exclude) } if $pattern->exclude;
			$excludeds{$ARGS{$pattern->id."_exclude_same_pattern"}} = "same_pattern_only";
			$pattern->exclude(JSON::encode_json(\%excludeds));

		}

		$pattern->update;

	}

	my $msg = "Event double-entry group settings saved";

	$m->redirect("/setup/events/double_entry.mhtml?msg=$msg");

</%init>
