<%args>
	$tourn
	$tourn_settings
	$person
	$person_settings
	$perms
	$event_id => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	unless ($event) {
		$m->comp("/funclib/abort.mas", message => "No event found for ID $event_id");
	}

	my %event_settings = $event->all_settings;

</%init>

	<div class="main">

		<h2><% $event->name %></h2>

		<&
			"tabbar.mas",
			districts       => $tourn_settings->{"nsda_district"},
			event           => $event,
			tourn           => $tourn,
			person          => $person,
			person_settings => $person_settings,
			tourn_settings  => $tourn_settings,
			whoami          => "online"
		&>

		<form
			action   = "online_save.mhtml"
			method   = "post"
			enctype  = "multipart/form-data"
		>

			<input
				type  = "hidden"
				name  = "event_id"
				value = "<% $event->id %>"
			>

			<h5 class="button">
				Online Options
			</h5>

			<span class="pagehalf">

				<label for="online">
					<div class="hover row">
						<span class="threequarters">
							Online Event
						</span>
						<span class="quarter centeralign">
							<& "/funclib/bool_switch.mas",
								tag      => "online",
								value    => $event_settings{"online"},
								target   => $event,
								smaller  => 1,
								function => "checkOnline();"
							&>
						</span>
					</div>
				</label>

				<script>
					function checkOnline() {
						if ($("#online").prop("checked") == true) {
							$(".online_options").removeClass("hidden");
						} else {
							$(".online_options").addClass("hidden");
						}
						zebraRows();
					}

					function checkJitsi() {

						$(".async_links").addClass("hidden");
						$(".online_prep").addClass("hidden");
						$(".dumb_half_async_thing").addClass("hidden");
						$(".async_link_entries").addClass("hidden");

						if ($("#online_jitsi").prop("checked") == true) {
							$(".jitsi").removeClass("hidden");
							$(".async_links").removeClass("hidden");
							$(".online_prep").removeClass("hidden");
						} else if ($("#online_nsda").prop("checked") == true) {
							$(".jitsi").removeClass("hidden");
							$(".async_links").removeClass("hidden");
							$(".online_prep").removeClass("hidden");
						} else if ($("#online_sync").prop("checked") == true) {
							$(".async_links").removeClass("hidden");
							$(".jitsi").addClass("hidden");
						} else {
							$(".jitsi").addClass("hidden");
							$(".dumb_half_async_thing").removeClass("hidden");
							$(".async_link_entries").removeClass("hidden");
						}

						zebraRows();
					}

					$(document).ready(function() {
						checkOnline();
						checkJitsi();
					});

				</script>

				<div
					class = "hidden nospace online_options"
				>
					<label for="online_public">
						<div class="hover row">
							<span class="threequarters">
								Show room URLs on public schematic
							</span>
							<span class="quarter centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "online_public",
									value   => $event_settings{"online_public"},
									target  => $event,
									smaller => 1,
								&>
							</span>
						</div>
					</label>

					<label for="dumb_half_async_thing">
						<div
							class="hover row dumb_half_async_thing"
							title="Use this option if you want the judges to judge their async video rounds in set time blocks rather than their own schedule"
						>
							<span class="threequarters">
								Schedule judges synchronously
							</span>
							<span class="quarter centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "dumb_half_async_thing",
									value   => $event_settings{"dumb_half_async_thing"},
									target  => $event,
									smaller => 1
								&>
							</span>
						</div>
					</label>

					<label for="show_async_links">
						<div class="hover row async_links">
							<span class="threequarters">
								Show async video links on ballots
							</span>
							<span class="quarter centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "show_async_links",
									value   => $event_settings{"show_async_links"},
									target  => $event,
									smaller => 1,
								&>
							</span>
						</div>
					</label>

					<label for="show_async_to_entries">
						<div class="hover row async_link_entries">
							<span class="threequarters">
								Show async video links to other entries
							</span>
							<span class="quarter centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "show_async_to_entries",
									value   => $event_settings{"show_async_to_entries"},
									target  => $event,
									smaller => 1,
								&>
							</span>
						</div>
					</label>

					<label for="online_prep">
						<div class="hover row online_prep">
							<span class="threequarters">
								Show online prep room for each entry
							</span>
							<span class="quarter centeralign">
								<& "/funclib/bool_switch.mas",
									tag     => "online_prep",
									value   => $event_settings{"online_prep"},
									target  => $event,
									smaller => 1,
								&>
							</span>
						</div>
					</label>

					<div class="hidden nospace jitsi">
						<h5 class="button">
							Identify Users in Online Rooms
						</h5>

						<label for="online_prepend_role">
							<div class="hover row">
								<span class="threequarters">
									Prepend Role (Judge/Entry/Tab)
								</span>
								<span class="quarter centeralign">
									<& "/funclib/bool_switch.mas",
										tag     => "online_prepend_role",
										value   => $event_settings{"online_prepend_role"},
										target  => $event,
										smaller => 1,
									&>
								</span>
							</div>
						</label>

						<div class="hover row">
							<span class="half">
								Entry Display
							</span>
							<span class="half centeralign">
								<select
									class        = "fixedsmall"
									setting_name = "online_entry_display"
									target_id    = "<% $event->id %>"
									name         = "online_entry_display"
									onChange     = "postSwitch(this, 'setting_switch.mhtml');"
								>
%									foreach my $option ("code", "code_first", "code_name", "name") {
										<option value="<% $option %>"
											<% $event_settings{"online_entry_display"} eq $option
												? "selected"
												: ""
											%>
										>
<%perl>
											my $key = $option;
											if ($key eq "code_first") {
												$key .= " Name";
											}
											$key =~ s/_/ \& /g;
											$key =~ s/first/First/g;
											$key =~ s/name/Name/g;
</%perl>
											Entry <% ucfirst($key) %>
										</option>
%									}
								</select>
							</span>
						</div>

						<div class="hover row">
							<span class="half">
								Judge Display
							</span>
							<span class="half centeralign">
								<select
									class        = "fixedsmall"
									setting_name = "online_judge_display"
									target_id    = "<% $event->id %>"
									name         = "online_judge_display"
									onChange     = "postSwitch(this, 'setting_switch.mhtml');"
								>
%									foreach my $option ("name", "code_first", "code_name", "code") {
										<option value="<% $option %>"
											<% $event_settings{"online_judge_display"} eq $option
												? "selected"
												: ""
											%>
										>
<%perl>
											my $key = $option;
											if ($key eq "code_first") {
												$key .= " name";
											}
											$key =~ s/_/ \& /g;
											$key =~ s/first/First/g;
											$key =~ s/name/Name/g;
</%perl>
											Judge <% ucfirst($key) %>
										</option>
%									}
								</select>
							</span>
						</div>
					</div>
				</div>

				<label for="dont_poke_entries">
					<div class="hover row">
						<span class="threequarters">
							Status screen: Poke only judges
						</span>
						<span class="quarter centeralign">
							<& "/funclib/bool_switch.mas",
								tag     => "dont_poke_entries",
								value   => $event_settings{"dont_poke_entries"},
								target  => $event,
								smaller => 1,
							&>
						</span>
					</div>
				</label>

			</span>

			<span class="pagehalf">
				<div
					class = "hidden nospace online_options"
				>
					<label for="online_async">
						<div class="hover row">
							<span class="threequarters">
								Asynchronous links to online videos
							</span>
							<span class="quarter centeralign">
								<input
									type         = "radio"
									id           = "online_async"
									name         = "online_mode"
									value        = "async"
									target_id    = "<% $event->id %>"
									setting_name = "online_mode"
									onChange     = "postSwitch(this, 'setting_switch.mhtml'); checkJitsi(); "
									<% $event_settings{"online_mode"} eq "async" ? 'checked' : "" %>
								>
							</span>
						</div>
					</label>

					<label for="online_sync">
						<div class="hover row">
							<span class="threequarters">
								Synchronous via pre-created room URLs
							</span>
							<span class="quarter centeralign">
								<input
									type         = "radio"
									id           = "online_sync"
									name         = "online_mode"
									value        = "sync"
									target_id    = "<% $event->id %>"
									setting_name = "online_mode"
									onChange     = "postSwitch(this, 'setting_switch.mhtml'); checkJitsi(); "
									<% $event_settings{"online_mode"} eq "sync" ? 'checked' : "" %>
								>
							</span>
						</div>
					</label>
<%perl>
					if (
						$tourn_settings->{"nsda_campus_purchased"} > 0
						|| $tourn_settings->{"nsda_campus_requested"} > 0
						|| $person->site_admin
						|| $person_settings->{"nsda_admin"}
					) {
</%perl>
						<label for="online_nsda">
							<div class="hover row">
								<span class="threequarters">
									NSDA Campus
								</span>
								<span class="quarter centeralign">
									<input
										type         = "radio"
										id           = "online_nsda"
										name         = "online_mode"
										value        = "nsda_private"
										target_id    = "<% $event->id %>"
										setting_name = "online_mode"
										onChange     = "postSwitch(this, 'setting_switch.mhtml'); checkJitsi(); "
										<% $event_settings{"online_mode"} eq "nsda_private" ? 'checked' : "" %>
									>
								</span>
							</div>
						</label>
<%perl>
						if (
							$person->site_admin
							|| $person_settings->{"nsda_admin"}
						) {
</%perl>
							<label for="online_jitsi">
								<div class="hover row">
									<span class="threequarters">
										Public Jitsi Server
									</span>
									<span class="quarter centeralign">
										<input
											type         = "radio"
											id           = "online_jitsi"
											name         = "online_mode"
											value        = "nsda_jitsi"
											target_id    = "<% $event->id %>"
											setting_name = "online_mode"
											onChange     = "postSwitch(this, 'setting_switch.mhtml'); checkJitsi(); "
											<% $event_settings{"online_mode"} eq "nsda_jitsi" ? 'checked' : "" %>
										>
									</span>
								</div>
							</label>
%						}

						<div class="hover row">
							<span class="threequarters">
								Event Campus Room Limit
							</span>
							<span class="quarter centeralign">
								<input
									type         = "number"
									id           = "campus_room_limit"
									name         = "campus_room_limit"
									value        = "<% $event_settings{"campus_room_limit"} %>"
									target_id    = "<% $event->id %>"
									setting_name = "campus_room_limit"
									onChange     = "postSwitch(this, 'setting_switch.mhtml');"
								>
							</span>
						</div>

						<label for="nsda_campus_public_elims">
							<div class="hover row">
								<span class="threequarters">
									Live-streamable elims &amp; finals*
								</span>
								<span class="quarter centeralign">
									<& "/funclib/bool_switch.mas",
										tag      => "nsda_campus_public_elims",
										value    => $event_settings{"nsda_campus_public_elims"},
										target   => $event,
										smaller  => 1
									&>
								</span>
							</div>
						</label>
%					}

				</div>
			</span>

			<div class="full nospace martopmore">
				<span class="nospace twofifths">
					<h5 class="button">
						Online Support Options
					</h5>
				</span>

				<span class="threefifths rightalign semibold italic redtext">
					Email &amp; instructions appear on online room landing pages
				</span>
			</div>

			<div class="row">
				<span class="third semibold bluetext">
					Support Email
				</span>

				<span class="twothirds">
					<input
						type = "email"
						name = "online_support"
						size = "64"
						value = "<% $event_settings{"online_support"} %>"
					>
				</span>
			</div>

			<div class="row">
				<span class="third semibold bluetext">
					Online Instructions
				</span>

				<span class="twothirds">
					<textarea
						name  = "online_instructions"
						size  = "64"
						rows  = "5"
						cols  = "64"
					><% $event_settings{"online_instructions"} %></textarea>
				</span>
			</div>

			<div class="row">
				<span class="third semibold bluetext">
					Apply contact/instructions to:
				</span>

				<span class="twothirds">
					<select name="scope" value="fixedmed">
						<option value="">Just <% $event->abbr %></option>
						<option value="cat">All events in <% $event->category ? $event->category->abbr : "" %></option>
						<option value="type">All <% $event->type %> events</option>
						<option value="tourn">All events in tournament</option>
					</select>
				</span>
			</div>

			<div class="liblrow rightalign marvertno">
				<span class="third centeralign">
					<input
						type  = "submit"
						value = "Save Online Settings"
					>
				</span>
			</div>
		</form>

<%perl>
		if (
			$tourn_settings->{"nsda_campus_purchased"} > 0
			|| $tourn_settings->{"nsda_campus_requested"} > 0
			|| $person->site_admin
			|| $person_settings->{"nsda_admin"}
		) {
</%perl>
			<div class="padleftmore padrightmore padvert italic martopmuchmore">
				* On the NSDA's private server, live streaming is not
				automatically available even with a Youtube key.
				<br />
				<br />

				This setting sends rounds marked "final" &amp; "elim" to a
				public service, permitting easy YouTube streaming, but is
				also potentially less secure.

				<br />
				<br />
				Do not change this setting in the
				middle of an ongoing elim/final round; all your rooms will
				suddenly be sent to a new place.
			</div>

%		}

	</div>

	<div class="menu">
		<& "menu.mas",
			person          => $person,
			person_settings => $person_settings,
			tourn           => $tourn,
			perms           => $perms,
			tourn_settings  => $tourn_settings,
			whoami          => "online",
			event_id        => $event->id
		&>
	</div>

