<%args>
	$tourn
	$tourn_settings
	$person
	$event_id  => undef
	$whoami    => undef
	$add       => undef
	$districts => undef
	$perms     => undef
</%args>
<%init>

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	my $base_url = $whoami;
	$base_url = "edit" if $whoami eq "double";

	undef $districts if $person->site_admin;

	my @tourn_events = $tourn->events;

	@tourn_events = sort {$a->type cmp $b->type} @tourn_events;

	if ($tourn_settings->{'nsda_nats'}) { 

		@tourn_events = 
			sort {$a->setting("supp") cmp $b->setting("supp")} 
			@tourn_events;

		@tourn_events = 
			sort {$a->setting("conn") cmp $b->setting("conn")} 
			@tourn_events;

	}

	@tourn_events = $m->comp(
		"/funclib/event_perms.mas", 
		type   => "admin",
		perms  => $perms,
		events => \@tourn_events
	);


</%init>

	<div class="sidenote">
%		unless ($perms->{"details"}) { 
		
			<h4>
				Batch Changes
			</h4>

%			if ($person->site_admin || (not defined $districts)) { 
				<a 
					class="<% $add ? "dk" : "" %>yellow full" 
					href="edit.mhtml?add=yes"
				>
					Add New Event
				</a>
%			}

			<a 
				class="<% ($whoami eq "recode") ? "dkblue full" : "blue full" %>" 
				href="mass_recode.mhtml"
			>
				Speaker Codes
			</a>

			<a 
				class="<% ($whoami eq "double") ? "dkblue full" : "blue full" %>" 
				href="double_entry.mhtml"
			>
				Patterns &amp; Double Entry Limits
			</a>

%		}

<%perl>

		if (@tourn_events) { 

			$base_url = "edit" 
				if $base_url eq "recode" 
				|| $base_url eq "double";

</%perl>
			<h4>
				Events
			</h4>

%			my $lasttype;

%			foreach my $event (@tourn_events) { 
				<a 
					class="<% ($event->id == $event_id) ? "dk" : "" %>blue nowrap full
						<% $lasttype eq $event->type ? "" : "martop" %>" 
					href="<% $base_url %>.mhtml?event_id=<% $event->id %>"
				>
					<% $event->name %>
				</a>

%				$lasttype = $event->type;
%			}
	
			<br />

%	 		if ($event && !$perms->{"details"}) { 

%	 			if ($event->category) { 
					<a 
						class="blue full" 
						href="/setup/judges/edit.mhtml?category_id=<% $event->category->id %>"
					>
						Go to Judge Category: <% $event->category->abbr %>
					</a>
%				}

%				unless ($districts || (scalar (@tourn_events) < 2) ) { 

%					if ($person->site_admin) { 

						<a 
							class="dkred full martopmore" 
							href="move_tourn.mhtml?event_id=<% $event->id %>"
						>
							Move To Different Tournament
						</a>

%					}


				<h4>
					Delete <% $event->abbr %>
				</h4>

				<form action="merge_event.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "event_id"
					value = "<% ($event) ? $event->id : "" %>"
					class = "notfirst"
				>

				<div class="libl full">

					<span class="third smaller">
						Merge with
					</span>

					<span class="half nospace">
						<select name="merge_into" class="notfirst fixedtiny">
%							foreach my $event (@tourn_events) { 
%								next if $event->id == $event_id;
								<option value="<% $event->id %>">
									<% $event->abbr %>
								</option>
%							}
						</select>
					</span>

					<span class="sixth">
						<input 
							class = "notfirst thin"
							type  = "submit"
							value = "Go"
						>
					</span>

				</div>

<%perl>
				my $warn = "You are about to delete the event ".$event->name.". No going back. Click OK to continue:";
</%perl>

				<a 
					class="dkred full" 
					href="event_rm.mhtml?event_id=<% ($event) ? $event->id : "" %>"
					<& "/funclib/confirm.mas", warn => $warn &>  
				>
					Delete Event w/o Merging
				</a>

%				}
%			}

%		} 

%		if ($person->site_admin) { 

			<a 
				class="dkred full"
				href="dedupe_events.mhtml"
			>Deduplicate Events</a>
%		}

	</div>


