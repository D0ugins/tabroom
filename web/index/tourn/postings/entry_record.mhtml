<%args>
	$entry_id => undef
	$person => undef
</%args>
<%init>

	my $key = $entry_id;
	return if $m->cache_self( key => $key, expires_in => '5m' );

	$m->abort if ref($entry_id);

	my $entry = Tab::Entry->retrieve($entry_id);

	$m->abort() unless $entry;

	my $event = $entry->event;
	my $tourn = $event->tourn;

	my @circuits = $tourn->circuits;

	my $ndt;

	foreach my $circuit (@circuits) {
		$ndt++ if $circuit->id == 43;
	}

	my $aff_string = $event->setting("aff_label");
	my $neg_string = $event->setting("neg_label");

	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	my $ncfl++ if $tourn->setting("ncfl");

	$ncfl++ if $event->setting("code_style") eq "numbers";
	$ncfl++ if $event->setting("code_style") eq "school_number";
				
	my @students = $entry->students;

</%init>

	<& menu.mas, tourn_id => $tourn->id, event_id => $event->id &>

	<div class="main">

        <h2>
			<% $ncfl 
				? $entry->code 
				: $entry->name  
			%> Record
			<% $ncfl %>
        </h2>

        <& ../tabbar.mas, tourn => $tourn, person => $person &>

		<div class="full martopmore">

			<span class="half nospace">

%				unless ($ncfl) { 

					<div class="full nospace">

						<h4 class="nospace">
%							my $notfirst;
%							foreach my $student (@students) { 
%								$m->print("&amp;") if $notfirst++;
								<% $student->first %> <% $student->last %>
%							}
						</h4>

					</div>

					<h6 class="full nospace normal martop">
						<% $entry->school->name %>
					</h6>

%				}

			</span>

			<span class="half rightalign">

%				unless ($ncfl) { 

					<a 
						class="buttonwhite bluetext invert"
						href="/index/tourn/updates/entry_follow.mhtml?entry_id=<% $entry->id %>&tourn_id=<% $tourn->id %>"
					>
						Live Updates
					</a>
%				}

%				if ($ndt) {

%					if (scalar @students == 2 ) { 
						<a 
							class="buttonwhite greentext thin"
							href="/jbruschke/TeamBidSheet.php?id1=<% $students[0]->id %>&id2=<% $students[1]->id %>"
						>
							NDT Bid Sheet
						</a>
%					}

%					if ($entry->school && $entry->school->chapter) { 
						<a 
							class="buttonwhite redtext thin"
							href="http://opencaselist.paperlessdebate.com/Caselist/Redirect?<% $entry->school->chapter->id %>"
						>
							Casewiki
						</a>
%					}

%				}
			</span>

		</div>

%		my @panels = $m->comp('/funclib/entry_panels.mas', entry => $entry, published => 1);

%		if (@panels) { 

			<h5>Pairings</h5>

			<table>

%		}

<%perl>

		my %seen = (); 

		@panels = grep { ! $seen{$_->id} ++ } @panels;

		@panels = sort {$b->round->name <=> $a->round->name} @panels;

		foreach my $panel (@panels) {

			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel); 

			my $opp = Tab::Entry->retrieve($panel->opp) if $panel->opp;
			my $side = $aff_string if $panel->side == 1;

			$side = $neg_string if $panel->side == 2;
			$side = "Bye" if $panel->bye;
			$side = "Bye" unless @judges;

</%perl>

			<tr class="row">

				<td class="smallish">
					<% $panel->round->realname %>
				</td>

%				if ($panel->round->flighted > 1) { 
					<td class="smallish">
						Flight <% $panel->flight %> 
					</td>
%				}
				
				<td class="smallish">
					<% ($panel->room) ? $panel->room->name : "" %>
				</td>

				<td class="smallish">
					<% $side %>
				</td>

				<td class="smallish">
					<a 
						class="white padtop padbottom"
						href="entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $opp->id %>"
					>
						vs <% $opp->code %>
					</a>
				</td>

				<td class="smallish padleft">

%					foreach my $judge (@judges) { 
						<a 
							class="white padtop padbottom"
							href="judge.mhtml?tourn_id=<% $tourn->id %>&judge_id=<% $judge->id %>"
						>
							<% ucfirst $judge->first." ". ucfirst $judge->last %>
						</a>
%					}
				</td>

			</tr>

%		}

%		if (@panels) { 
			</table>
%		}

<%perl>

		my @results = $m->comp(
			'/funclib/entry_panels.mas', 
			entry        => $entry,
			post_results => 1
		);

		my %rseen = (); 

		@results = grep { ! $rseen{$_->id} ++ } @results;

</%perl>

%		if (@results) { 

			<h5>Results</h5>

%		}

<%perl>

		@results = sort {$b->round->name <=> $a->round->name} @results;

		foreach my $panel (@results) { 

			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);

			@judges = sort {$b->chair <=> $a->chair} @judges;

			my $opp = Tab::Entry->retrieve($panel->opp) if $panel->opp;

			my $side = $aff_string if $panel->side == 1;

			$side = $neg_string if $panel->side == 2;

			$side = "Bye" if $panel->bye;

</%perl>
			<div class="lightrow">

				<span class="eighth">
					<% $panel->round->realname %>
				</span>

				<span class="eighth">
					<% $side %>
				</span>

				<span class="quarter padno">

%					if ($opp) { 

						<a 
							class = "white padtop padbottom" 
							href  = "entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $opp->id %>"
						>
							vs <% $opp->code %>
						</a>
%					} 

				</span>

				<span class="half nospace">

<%perl>

				my $notfirst;

				foreach my $judge (@judges) { 

					my @scores = $m->comp(
						'/funclib/panel_scores.mas', 
						panel => $panel,
						judge => $judge,
						entry => $entry
					);

   	        		my %scores_by_recipient = ();

	           		foreach my $score (@scores) {   

						push @{$scores_by_recipient{$score->student->id}}, $score 
							if $score->student 
							&& $score->student->id; 
    	       		}

</%perl>

					<div class="padless full">

						<span class="third nospace">

							<a 
								class = "white padtop padbottom" 
								href  = "judge.mhtml?tourn_id=<% $tourn->id %>&judge_id=<% $judge->id %>"
							>
								<% ucfirst $judge->last %>, <% ucfirst $judge->first %>
							</a>

						</span>

						<span class="sixth centeralign">

%							foreach my $score (@scores) { 
								<% $score->tag eq "ballot" 
									? $score->value > 0 
									? "W" 
										: "L" 
										: "" 
								%>
%							}
	
						</span>

%						my @students = $entry->students;

						<span class="half">

%							if ($panel->round->post_results > 2) { 

%							foreach my $student (@students) { 

								<div class="full nospace">

%									if (scalar @students > 1) { 
										<span class="half nowrap marno">
											<% $student->last." ".$student->first %>
										</span>
%									}

%								
%									foreach my $score (@{$scores_by_recipient{$student->id}}) { 
	
										<span class="quarter marno">
											<% $score->value %>
										</span>

%									}

								</div>
%							}
%							}
		
						</span>

					</div>

%				}   

			</div>

%		}

	</div>

