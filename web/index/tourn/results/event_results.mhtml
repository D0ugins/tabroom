<%args>
	$tourn_id
	$person    => undef
	$result_id => undef
</%args>
<%init>

	$result_id = int($result_id);
	$tourn_id = int($tourn_id);

	my $key = $result_id."-".$tourn_id;

	return if $m->cache_self( 
		key        => $key,
		expires_in => '10m'
	);

	my $result_set = Tab::ResultSet->retrieve($result_id) if $result_id;

	$m->abort unless $result_set;

	$m->redirect("bracket.mhtml?tourn_id=$tourn_id&result_id=$result_id") 
		if $result_set->bracket;

	my @results = sort {$a->rank <=> $b->rank} $result_set->results;
	my $event = $result_set->event if $result_set->event;
	my $event_id = $event->id if $event;

	my $tourn = eval { 
		return Tab::Tourn->retrieve($tourn_id);
	};

	unless ($tourn) { 
		$m->comp("/funclib/abort.mas", 
			message => "No tournament found for id $tourn_id"
		);
	}

	my $sample;
	$sample = $results[0] if @results;

	my $anonymous_public = $event->setting("anonymous_public");

	my $tick++;

</%init>

	<& 
		"menu.mas",
		tourn_id  => $tourn_id,
		event_id  => $event_id,
		result_id => $result_id
	&>

	<div class="main">
		
		<& "/index/tourn/title.mas",
			tourn => $tourn
		&>

        <& "/index/tourn/tabbar.mas",
			tourn  => $tourn,
			person => $person
		&>


<%perl>

		if (@results && $result_set->published == 1) { 

			my $current_tiebreaks;
			my $counter;
			my $printed_header;

			foreach my $result (@results) { 

				my $entry = $result->entry if $result->entry;
				my $student = $result->student if $result->student;	
	
				next unless $entry;
				my @values = $result->values;
				next unless @values;
				my $place = shift @values;

				unless ($place->tag eq "Place" || $place->tag eq "Order") { 
					unshift @values, $place;
					undef $place;
				}

				my $tiebreaks;
				foreach my $value (@values) { 
					$tiebreaks .= "-" if $tiebreaks;
					$tiebreaks .= $value->tag;
				}
				$counter++;

				if (
					$current_tiebreaks ne $tiebreaks 
					|| (not defined $printed_header)
				) { 

					$printed_header++;

</%perl>

					<% $current_tiebreaks ? "</table> <br />" : "" %>
%					$current_tiebreaks = $tiebreaks;
		
					<span class="fourfifths martopmore nospace">
						<h4 class="nospace"><% $result_set->label." in ".$event->name %></h4>
					</span>

					<span 
						class = "fifth rightalign"
						id    = "<% $result_set->id."_".$tick %>_buttonarea"
					></span>

					<& "/funclib/tablesorter.mas", table => $result_set->id."_".$tick &>

					<table id="<% $result_set->id %>_<% $tick %>">

						<thead>

							<tr class="yellowrow">

%								if ($place) { 
									<th class="smallish centeralign">
										<% ucfirst($place->tag) %>
									</th>
%								}

								<th class="smallish">
									Code
								</th>

								<th class="smallish">
									Name
								</th>

								<th class="smallish">
									Institution
								</th>

%								foreach my $value (@values) { 
									<th class="smaller <% $value->no_sort ? "nosort" : "" %>">
										<span title="<% $value->description %>">
										<% ucfirst($value->tag) %>
										</span>
									</th>
%								}

							</tr>

						</thead>

						<tbody>

%						$tick++;
%					}

					<tr>
						
%						if ($place) { 
							<td class="smallish centeralign">
								<span class="hidden"><% $counter %></span>
								<% $place ? $place->value : "" %>
							</td>
%						} 

						<td class="smallish">
%							unless ($anonymous_public) { 
								<a class="white" 
									href="/index/tourn/postings/entry_record.mhtml?tourn_id=<% $tourn->id %>&entry_id=<% $entry->id %>">
%							}
%								if ($student) { 
										<% $entry->code %> 
									</td>
									<td class="smallish">
										<% $student->first." ".$student->last %>
%								} else { 
										<% $entry->code eq $entry->name ? "" : $entry->code %>
									</td>
									<td class="smallish">
										<% $entry->name %> 
%								}
%							unless ($anonymous_public) { 
								</a>
%							}
						</td>

						<td class="smallish">
							<% $entry->school ? $entry->school->short_name : "No school"%>
						</td>

<%perl>
						foreach my $value (@values) { 

							my $score = $value->value;
							$score =~ s/^\ +//g;

							if ($value->tag eq "Ballots") { 
								$score =~ s/&nbsp; &nbsp; &nbsp; &nbsp;/\<br \/\>/g ;
								$score =~ s/&nbsp; &nbsp;/\<br \/\>/g ;
								$score =~ s/&nbsp;&nbsp;/\<br \/\>/g ;
								$score =~ s/&nbsp;/\<br \/\>/g ;
								$score =~ s/\<br \/\> \<br \/\>/\<br \/\>/g ;
								$score =~ s/^\s+//;
								$score =~ s/W/ W/g;
								$score =~ s/L/ L/g;
							} elsif (
								$value->tag =~ m/Win$/
								|| $value->tag =~ m/PWin/
								|| $value->tag =~ m/Rnd/
								|| $value->tag =~ m/Bal/
								|| $value->tag =~ m/H2H/
								|| $value->tag =~ m/Rk/
							) {
								$score = sprintf('%d', $score);
							}

</%perl>
							<td 
%							   if ($value->tag eq "Ballots") { 
									class="centeralign smallish"
									title="<% $score %>" 
									>
									<span 
										class="fa fa-sm fa-eye buttonwhite bluetext smallish padless"
									>
									</span>
%						   		} else { 
									class="rightalign smallish">
									<% $score %>
%   							}
							</td>

%						}

					</tr>
%				}

			</table>

%		}

	</div>

