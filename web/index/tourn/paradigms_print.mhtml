<%args>
	$tourn_id
	$category_id => undef
	$person  => undef
</%args>
<%init>

	my $tourn =  Tab::Tourn->retrieve($tourn_id);
	$m->abort unless $tourn;

	my $tz = $person->tz if $person;
	$tz = $tourn->tz unless $tz;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now;	
	$now->set_time_zone($tz);

	my $category =  Tab::Category->retrieve($category_id);

	Tab::Category->set_sql( field_reports => "
		select category.* from category, category_setting
		where category.tourn = ?
		and category.id = category_setting.category
		and category_setting.tag = 'field_report'
		and category_setting.value = 1
		order by category.name
	");

	my @categories = Tab::Category->search_field_reports($tourn->id);

	$category = $categories[0] unless $category;

	$m->abort unless $category;

    my $webpage = Tab::Webpage->search( 
		tourn   => $tourn_id,
		special => "fields"
	)->first;

	my $switch;

    my $name = $tourn->name;
    $name =~ s/[\W_]//g;

    my $filename = $name."-".$category->abbr."-Paradigms-".$now->epoch;
    my $filepath = $Tab::file_root."tmp/".$filename;
    `rm -f $filepath.*`; 

    $m->comp("/funclib/printout.mas", 
		tourn    => $tourn,
		filename => $filename,
		head     => 1
	);

	open (TEXOUT, ">>$filepath.tex");

	print TEXOUT "\\hfill {\\LARGE ".Tab::texify($tourn->name)."}\n";
	print TEXOUT "\\smallskip\n";
	print TEXOUT "\\newline\n";
	print TEXOUT "\\bigskip\n";
	print TEXOUT "\\hfill {\\Large ".Tab::texify($category->name)." judge paradigms }\n";
	print TEXOUT "\\newline\n";

	foreach my $judge (sort {$a->last cmp $b->last} $category->judges) { 

		next unless $judge->person;
		my $paradigm = $judge->person->setting("paradigm");
		next unless $paradigm;

		my $strip = HTML::Strip->new();
		$paradigm = $strip->parse($paradigm);
		$paradigm =~ s/[^[:ascii:]]//g;
		$paradigm =~ s/^\s+//; 
		$paradigm =~ s/\s+$//;
		my $newline = "\\newline\n";
		$paradigm = Tab::texify($paradigm);
		$paradigm =~ s/\R/$newline/g;

		print TEXOUT "\\begin{tabular}{p{2in}p{2.5in}p{2in}}\n";

		print TEXOUT "\\large ".$judge->last.", ".$judge->first." & ";

		if ($judge->school->id) { 
			print TEXOUT "\\large ".Tab::texify($judge->school->short_name);
		} else { 
			print TEXOUT "\\large Hired";
		}

		print TEXOUT " & ";

		if ($judge->obligation || $judge->hired) { 
			print TEXOUT "\\large ".($judge->obligation + $judge->hired)." rounds ";
		}

		print TEXOUT " \\\\ \\hline \n \\end{tabular}\n\\smallskip\\newline\n";
		print TEXOUT "\\small\n\\onehalfspacing\n";
		print TEXOUT $paradigm."\\bigskip\\newline\n" if $paradigm;
		print TEXOUT "Not Submitted \\bigskip\\newline\n" unless $paradigm;

	}

	print TEXOUT "\\end{document}\n";

	close TEXOUT;

    $m->comp("/funclib/printout.mas", 
		tourn    => $tourn,
		filename => $filename,
		tail     => 1
	);


</%init>
