<%args>
	$tourn_id
	$category_id => undef
	$person      => undef
</%args>
<%init>

	my $key = $tourn_id."-".$category_id;

#	return if $m->cache_self( 
#		key        => $key,
#		expires_in => '15m'
#	);

	my $tourn =  Tab::Tourn->retrieve($tourn_id);
	$m->abort unless $tourn;

	Tab::Category->columns(TEMP => "nats");

	Tab::Category->set_sql( field_reports => "

		select category.*, category_setting.tag as nats

		from category, category_setting
		where category.tourn = ?

			and category_setting.category = category.id
			and category_setting.value = 1
			and ( 
				category_setting.tag = 'field_report' 
			)

		group by category.id
		order by category.name
	");

	my @categories = Tab::Category->search_field_reports($tourn->id);

	my $category =  Tab::Category->retrieve($category_id);

	my $rounds_per = $category->setting("rounds_per") if $category;

    my $webpage = Tab::Webpage->search( 
		tourn => $tourn_id, 
		special => "fields"
	)->first;

	my $switch;

</%init>

	<div class="main">

		<& "title.mas", tourn => $tourn &>

        <& "tabbar.mas", 
			tourn => $tourn, 
			person => $person 
		&>

%		if ($category) { 

%			my @judges = $m->comp("/funclib/category_judges.mas", category => $category);

			<span class="threequarters nospace">
				<h4> <% scalar @judges %> Judges in <% $category->name %> </h4>
			</span>

			<span 
				class="rightalign quarter nospace" 
				id="judgelist_buttonarea"
			>
			</span>

			<& "/funclib/tablesorter.mas", 
				table => "judgelist"
			&>

			<table id="judgelist">

				<thead>

				<tr class="yellowrow">

					<th title="Paradigm">
						Para
					</th>

					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						School
					</th>

					<th>
						State
					</th>

%					if ($rounds_per) { 
						<th>
							Rounds
						</th>
%					}

				</tr>

				</thead>

				<tbody>

%				foreach my $judge (@judges) { 

					<tr>

						<td class="nospace centeralign">
%							if ($judge->paradigm) { 
								<a 
									href="/index/paradigm.mhtml?judge_person_id=<% $judge->person->id %>"
									class="buttonwhite bluetext fa fa-sm fa-file-text-o"
									target="_blank"
								></a>
%							}
						</td>

						<td class="nospace">
%						if ($judge->paradigm) { 
							<a class="white full padvert" 
								href="/index/paradigm.mhtml?judge_person_id=<% $judge->person->id %>"
							>
%						}
							<% $judge->first %>
							</a>
						</td>

						<td class="nospace">
%							if ($judge->paradigm) { 
								<a class="white full padvert" 
								href="/index/paradigm.mhtml?judge_person_id=<% $judge->person->id %>"
								>
%							} 
								<% $judge->last %>
							</a>
						</td>

			
						<td>
							<% $judge->schname ? $judge->schname : "Hired" %>
						</td>

						<td class='centeralign'>
							<% $judge->state %>
						</td>

%						if ($rounds_per) { 
							<td>
								<% $judge->obligation + $judge->hired %>
							</td>
%						}

					</tr>

%				}
				</tbody>

			</table>

%		} elsif ($webpage) { 

	        <p>
				<% $webpage->content %>
			</p>

%		} else { 

			<h6 class="martopmore centeralign">
				Choose an judge category at right to see the judge list.
			</h6>
				
			<h6 class="martopmore centeralign">
				You may not see all categories or divisions.
				Tabroom only reports fields which the tournament
				officials have released.
			</h6>

%		}

		</table>

	</div>

	<& "menu.mas", 
		category => $category,
		tourn    => $tourn
	&> 


