<%args>
	$person      => undef
	$tourn_id    => undef
	$category_id => undef
</%args>
<%init>

    my $tourn;
	eval{ $tourn = Tab::Tourn->retrieve($tourn_id); };

	unless ($tourn) {
		$m->print('<div class="main">');
		$m->print("<h3>Invalid tourn ID or URL</h3>");
		$m->print('</div>');
		$m->abort;
	}

	my $tz = $tourn->tz if $tourn;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now( time_zone => $tz );

	my $category = Tab::Category->retrieve($category_id)
		if $category_id
		&& $category_id == int($category_id);

	undef $category
		unless (not defined $category)
		|| $category->tourn->id == $tourn->id;


</%init>

	<div class="main">

		<& title.mas, tourn => $tourn &>

		<& tabbar.mas,
			tourn      => $tourn,
			person     => $person
		&>

%		if ($category) {

%			my %category_settings = $category->all_settings();

			<h5>Judge signup in <% $category->name %></h5>

%			if ($now > $category_settings{"public_signups_deadline"}) {

				<p class="bigger semibold redtext centeralign">
					The signup deadline has passed.
				</p>

				<p class="biggish martopmore semibold bluetext centeralign">
					The deadline for signups was
					<% Tab::nicedt($category_settings{"public_signups_deadline"}) %>
					<% Tab::tzname($tz) %>.
				</p>

%			} else {

%				unless ($person) {

					<p class="bigger semibold redtext centeralign">
						You must be logged in to register as a judge.
					</p>

					<p class="biggish martopmore semibold bluetext centeralign">
						If you have a Tabroom.com account, you must first
						<a
							href   = "/user/login/login.mhtml?return=judgesign&category_id=<% $category_id %>&tourn_id=<% $tourn_id %>"
							target = "_blank"
							class  = "inline"
						>log in.</a>
					</p>

					<p class="biggish martopmore semibold bluetext centeralign">
						If you do not, first
						<a
							href   = "/user/login/new_user.mhtml"
							target = "_blank"
							class  = "inline"
						>sign up.</a>
					</p>

<%perl>

				} else {

					my @already = $m->comp(
						"/funclib/tourn_person_judges.mas",
						tourn  => $tourn,
						person => $person
					);


					my $judge = shift @already if @already;

					my $cant;

					if ($judge) {

						if ($judge->category->id != $category->id) {
</%perl>
							<h5>You are already registered in <% $category->abbr %></h5>

%							unless ($judge->category->setting("double_entry") && $category->setting("double_entry")) {
								<p>You cannot register in both <% $judge->category->abbr %> and <% $category->abbr %></p>

%								$cant++;
%							}

%						}
%					}

%					unless ($cant) {

						<form
							action = "judge_signups_save.mhtml"
							method = "post"
						>

							<input
								type  = "hidden"
								name  = "category_id"
								value = "<% $category->id %>"
							>

							<input
								type  = "hidden"
								name  = "judge_id"
								value = "<% $judge ? $judge->id : "" %>"
							>

							<input
								type  = "hidden"
								name  = "tourn_id"
								value = "<% $tourn->id %>"
							>

%							my @shifts = $category->shifts( type => "public");
%							push @shifts, $category->shifts( type => "both");

							<div class="full centeralign">

%							if (@shifts) {

								<% $category_settings{"public_signups_notice"} %>

								<h5 class="centeralign martopmore">
									Which judging shifts are you available for?
								</h5>

<%perl>
								foreach my $shift (@shifts) {

									my $nope_cant++ if $judge && $judge->strikes(shift => $shift->id);

									my $start = $shift->start;
									$start->set_time_zone("UTC");
									$start->set_time_zone($tz);

									my $end = $shift->end;
									$end->set_time_zone("UTC");
									$end->set_time_zone($tz);
</%perl>

									<label for="<% $shift->id %>">
										<div class="row fourfifths marno leftalign hover">

											<span class="quarter">
												<% $shift->name %>
											</span>

											<span class="quarter">
												Start: <% Tab::niceshortdayt($start) %>
												<& Tab::tzname($tz) &>
											</span>

											<span class="quarter">
												End: <% Tab::niceshortdayt($end) %>
											</span>

											<span class="quarter centeralign">

												<span class="hidden"><% $nope_cant %></span>

												<input
													type  = "checkbox"
													value = "1"
													id    = "<% $shift->id %>"
													name  = "<% $shift->id %>"
													<% $nope_cant ? "" : 'checked="checked"' %>
												>

											</span>
										</div>
									</label>
%								}
%							}

							<div class="row fourfifths leftalign marno martopmore">

								<span class="third">
									Special requests/notes:
								</span>

								<span class="twothirds">

									<input
										type  = "text"
										name  = "notes"
										size  = 48
										value = "<% $judge ? $judge->setting("notes") : "" %>"
									>

								</span>

							</div>

%							if ($category_settings{"rounds_per"}) {

								<div class="row fourfifths leftalign marno">

									<span class="third">
										# of Prelim rounds available:
									</span>

									<span class="twothirds">
										<input
											type  = "number"
											name  = "hired"
											size  = 48
											min   = "1"
											max   = <% $category_settings{"max_rounds"} %>
											value = "<% $judge ? $judge->hired : $category_settings{"max_rounds"} %>"
										>
									</span>

								</div>

%							}

							<div class="libl rightalign fourfifths padvert marno">

								<input
									type  = "submit"
									value = "<% $judge ? "Save Details" : "Register to Judge" %>"
								>

								</form>

							</div>


%						if ($judge) {

							<div class="row fourfifths leftalign martopmore">

								<span class="third">
									Status:
								</span>

								<span class="twothirds marvert padvert rightalign semibold
									<% $judge->active ? "greentext" : "redtext" %>">
									<% $judge->active
										? "REGISTERED &amp; APPROVED"
										: "REGISTERED. APPROVAL PENDING"
									%>
								</span>

							</div>

							<h5 class="centeralign martopmore">
								Conflicted Schools
							</h5>

%							foreach my $conflict ($judge->strikes(conflictee => 1)) {

								<div
									id="<% $conflict->id %>"
									class="row fourfifths marno"
								>
									<span class="twothirds leftalign">
										<% $conflict->school ? $conflict->school->short_name : "" %>
										<% $conflict->entry ? $conflict->entry->name : "" %>
									</span>
									<span class="third">
										<a
											class         = "buttonwhite redtext fa fa-trash"
											target_id     = "<% $conflict->id %>"
											on_success    = "destroy"
											onClick       = "postSwitch(this, 'conflict_rm.mhtml');"
											title         = "Remove Conflict"
										></a>
									</span>
								</div>
%							}

							<div class="row fourfifths marno">

								<form
									action = "judge_strike.mhtml"
									method = "post"
								>

								<input
									type  = "hidden"
									name  = "category_id"
									value = "<% $category->id %>"
								>

								<input
									type  = "hidden"
									name  = "judge_id"
									value = "<% $judge ? $judge->id : "" %>"
								>

								<input
									type  = "hidden"
									name  = "tourn_id"
									value = "<% $tourn->id %>"
								>

								<span class="twothirds">
									<select name="school_id">
										<option value=""></option>
%										foreach my $school ($tourn->schools) {
											<option
												value="<% $school->id %>"
											><% $school->name %></option>
%										}
									</select>
								</span>

								<span class="sixth">
									<input
										type  = "submit"
										value = "Add"
									>
								</span>
							</div>

%						}

						</div>

%					}

%				}

%			}

%		}

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Judge categories</h4>

%			foreach my $other_category (
%				$m->comp("/funclib/tourn_public_signups.mas", tourn => $tourn)
%			) {

				<a
					class = "<% $other_category == $category ? "dk" : "" %>blue full"
					href  = "judge_signups.mhtml?category_id=<% $other_category->id %>&tourn_id=<% $tourn->id %>"
				><% $other_category->name %></a>

%			}

		</div>

	</div>

