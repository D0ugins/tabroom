<%args>
	$tourn_id
	$event_id => undef
	$person => undef
</%args>
<%init>

	my $key = $tourn_id."-".$event_id;

	return if $m->cache_self(
		key        => $key,
		expires_in => '15m'
	);

	$event_id =~ s/[\D_]//g;

	my $tourn = Tab::Tourn->retrieve($tourn_id);
	$m->abort unless $tourn;

	my $event = Tab::Event->retrieve($event_id) if $event_id;

	Tab::Event->set_sql( field_reports => "
		select event.* from event, event_setting
		where event.tourn = ?
		and event.id = event_setting.event
		and event_setting.tag = 'field_report'
		and event_setting.value = 1
		order by event.name
	");

	my @events = Tab::Event->search_field_reports($tourn->id);

	my %events_by_id = map { $_->id => 1} @events;

	if ($event) {

		unless ($events_by_id{$event_id}) {

			$m->print("<div class='blankfull centeralign'>");
			$m->print("<h6 class='martopmore marbottommore'>This entry field is not published</h6>");
			$m->print("</div>");

			$m->abort;
		}
	}

    my $webpage = Tab::Webpage->search(
		tourn => $tourn_id,
		special => "fields"
	)->first;

	my $ndt;

	foreach my $circuit ($tourn->circuits) {
		$ndt++ if $circuit->id == 43;
	}

	my $anonymous_public = $event->setting("anonymous_public") if $event;

</%init>

	<div class="main">

		<& title.mas, tourn => $tourn &>

        <& tabbar.mas,
			tourn => $tourn,
			person => $person
		&>

<%perl>

		if ($event) {


			my @entries =
				sort {$a->school->name cmp $b->school->name}
				$event->entries(active => 1);

			@entries =
				sort {$a->school->name cmp $b->school->name}
				$event->entries(dropped => 0 )
			if $event->setting("field_waitlist");

</%perl>

			<span class="threefifths nospace">
				<h5 class="nospace">
					Field in <% $event->name %>
				</h5>
			</span>

			<span class="fifth nospace bluetext semibold">
				<h5 class="nospace">
				<% scalar @entries %> entries
				</h5>
			</span>

			<span
				id    = "fieldsort_buttonarea"
				class = "fifth rightalign"
			></span>

			<& "/funclib/tablesorter.mas", table => "fieldsort" &>

			<table id="fieldsort">

				<thead>

					<tr class="yellowrow">

						<th class="smallish">
							School
						</th>

						<th class="smallish">
							Locale
						</th>

%						unless ($anonymous_public) {
							<th class="smallish">
								Entry
							</th>
%						}

						<th class="smallish">
							Code
						</th>

%						if ($event->setting("field_waitlist")) {
							<th class="smallish">
								Status
							</th>
%						}

%						if ($ndt) {
							<th class="smallish nosort">
								Results
							</th>
							<th class="smallish nosort">
								Bids
							</th>
%						}

					</tr>

				</thead>

				<tbody>

%				foreach my $entry (@entries) {

					<tr>

						<td>
							<% substr($entry->school->name,0,35) %>
						</td>

						<td>
							<% $entry->school->chapter ? $entry->school->chapter->location : "" %>
						</td>

%						unless ($anonymous_public) {
							<td>
								<% $entry->name %>
							</td>
%						}

						<td>
							<% $entry->code %>
						</td>

%						if ($event->setting("field_waitlist")) {
							<td class="centeralign">
								<% $entry->waitlist ? "WL" : "In" %>
							</td>
%						}

%						unless ($anonymous_public) {
%							if ($ndt) {

%								my ($student1, $student2, $crap) = $entry->students;

%								if ($student1 && $student2) {

									<td class="centeralign">
										<a
											href="/index/results/team_lifetime_record.mhtml?id1=<% $student1->id %>&id2=<% $student2->id %>"
											class="buttonwhite bluetext hover smallish invert"
										>
											All Results
										</a>
									</td>

									<td class="centeralign">
										<a
											href="/index/results/team_results.mhtml?id1=<% $student1->id %>&id2=<% $student2->id %>"
											class="buttonwhite greentext hover smallish invert"
										>
											Bid Sheet
										</a>
									</td>
%								}

%							}
%						}

					</tr>

%				}

				</tbody>

			</table>

%		} elsif ($webpage) {

	        <p>
				<% $webpage->content %>
			</p>

%		} else {

			<p>
				Choose an event at right to see the reported field.  You may
				not see all events or divisions in the field report; the system
				only reports fields which the tournament officials have
				released.
			</p>

%		}

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Events</h4>

%			foreach my $oevent (sort {$a->name cmp $b->name} @events) {

%				$event_id = $oevent->id unless $event_id;

				<a class="<% ($oevent->id == $event_id ) ? "dk" : "" %>blue full"
					href="/index/tourn/fields.mhtml?tourn_id=<% $tourn_id %>&event_id=<% $oevent->id %>">
					<% $oevent->name %>
				</a>

%			}

%			if ($tourn == 12448) {
%				# Have to disable because this is so resource intensive it was bringing down the site.  JB: Re-enabled just for 2019 NDT
%				unless ($anonymous_public) {
%					if ($ndt) {
						<a
							class="yellow full"
							href="/index/results/debate_stats2.mhtml?event_id=<% $event_id %>">
							Results comparison of teams
						</a>
						<a
							class="yellow full"
							href="/index/results/tourn_head_to_head.mhtml?tourn_id=<% $tourn->id %>&mode=WW&event_id=<% $event_id %>">
							Head to Head Comparisons
						</a>
%					}
%				}
%			}

		</div>

	</div>

