<%args> 
	$tourn_id   => undef
	$site_id    => undef
	$webpage_id => undef
	$person     => undef
	$webname    => undef
</%args>
<%init> 

	my $key = $tourn_id."-".$site_id."-".$webpage_id;

	return if $m->cache_self( 
		key => $key, 
		expires_in => '10m' 
	);

	if ($webname && not defined $tourn_id ) { 
		$m->redirect("/index/tourn/past.mhtml?webname=$webname");
	}

    my $tourn;
	eval{ $tourn = Tab::Tourn->retrieve($tourn_id); };

	unless ($tourn) {
		$m->print('<div class="main">');
		$m->print("<h3>Invalid tourn ID or URL</h3>");
		$m->print('</div>');
		$m->abort;
	}

	my %tourn_settings = $tourn->all_settings();

	my $tz = $person->tz if $person;
	$tz = $tourn->tz if $tourn && not defined $tz; 
	$tz = "UTC" unless $tz;

	my $now = DateTime->now( time_zone => $tz );

	my $tz_ob = DateTime::TimeZone->new( name => $tz );
	my $webpage = Tab::Webpage->retrieve($webpage_id);

	unless ($webpage) { 
		my @webpages = Tab::Webpage->search(
			tourn   => $tourn->id,
			special => "main"
		);
		$webpage = shift @webpages if @webpages;
	}

	my $end = $tourn->end->set_time_zone($tz);

	my $site = Tab::Site->retrieve($site_id) if $site_id;

	my $start = $tourn->start->set_time_zone($tz);

	my @others = Tab::Tourn->search( 
		webname => $tourn->webname
	);

	my $district_id = $tourn_settings{"nsda_district"};
	my $district;

</%init> 

	<div class="main index">

		<& "title.mas", 
			tourn => $tourn
		&>

		<& "tabbar.mas",
			tourn      => $tourn,
			webpage_id => $webpage_id,
			person     => $person
		&>

%		if ($site) { 

			<h3><% $site->name %></h3>

			<p>Host: <% ($site->host) ? $site->host->first." ".$site->host->last : "None Listed"%></p>

			<p><% $site->directions %></p>

<%perl>

		} else { 

			if ($district_id) { 

				$district = Tab::District->retrieve($district_id);
				my $software = $tourn_settings{"nsda_tabbing_software"};

				my $school_year = $tourn->start->year;
				$school_year++ if $tourn->start->month > 6;

				my %event_weekends = ();

				foreach my $event ($tourn->events) { 
					push @{$event_weekends{$event->setting("weekend")}}, $event;
				}

</%perl>
				
				<h4 class="centeralign"><% $district->name %> District Qualifier</h4>
				<h6 class="bluetext semibold martopless marbottommore centeralign"
					>for the <% $school_year %> National Tournament</h6>

%				if ($software eq "jot") { 

%					my $jot_url = $tourn_settings{"jot_url"};

					<p class="semibold">
						This district tournament will be registered &amp;
						tabbed with <a 
							class  = "bluetext"
							target = "_blank"
							href   = "http://www.joyoftournaments.com"
						>Joy of Tournaments</a>.
						
						For the most up to date information, and to register,
						you should be sure to check the JOT website.
					</p>

%				} elsif ($software eq "speechwire") { 

					<p class="semibold">
						This district tournament will be registered &amp;
						tabbed with <a 
							class  = "bluetext"
							target = "_blank"
							href   = "http://www.speechwire.com"
						>Speechwire</a>.
						
						For the most up to date information, and to register,
						you should be sure to check the Speechwire website.
					</p>

%				} 

%				foreach my $weekend ($tourn->weekends() ) { 

					<div class="row full marno">

						<span class="quarter semibold">
							<% $weekend->name %>
						</span>
						<span class="quarter padno">
							<div class="padless marno">
								<% $weekend->site ? $weekend->site->name :  "" %>
							</div>
							<div class="padless marno">
								<% $weekend->city ? $weekend->city.", ".$weekend->state : ""%>
							</div>
						</span>
						<span class="eighth">
							<% 
								Tab::niceshortdayte($weekend->start->set_time_zone($tz))
							%>
						</span>
						<span class="eighth">
							<% 
								Tab::niceshortdayte($weekend->end->set_time_zone($tz))
							%>
						</span>
						<span class="quarter">
%							foreach my $event (@{$event_weekends{$weekend->id}}) { 
								<span class="padleft padright"> <% $event->abbr %></span>
%							}
						</span>
					</div>

%				}

%				if ($software eq "tabroom") { 

%					if ($webpage) { 

						<% ($webpage && $webpage->title ne "main") ? "<h3>".$webpage->title."</h3>" : "" %>

						<% ($webpage) ? $webpage->content : "" %>

%					} else { 

						<p class="martopmuchmore bigger semibold centeralign">
							This district tournament series will be hosted here on Tabroom.com.
						</p>

						<p>The tournament chair has not yet posted details or a tournament invite, but
						check back here at</p>
						
						<p class="centeralign"><a 
							class="semibold bluetext"
							href="http://<% $tourn->webname %>.tabroom.com"
						>http://<% $tourn->webname %>.tabroom.com</a></p>

						<p>
							You will need to be a paid member of this district
							to compete at their District Tournament qualifier series.  Consult your 
							<a href="https://www.speechanddebate.org/account/"
								class="redtext semibold"
							>NSDA membership account</a> to confirm your school and students'
							membership status.

						</p>

%					}

%				}

%			} elsif ($webpage) { 

				<% ($webpage && $webpage->title ne "main") ? "<h3>".$webpage->title."</h3>" : "" %>

				<% ($webpage) ? $webpage->content : "" %>

%			} else { 

				<p>
					The <% $tourn->name %> is hosted on Tabroom.com, an online
					registration and tabulation website provided to the speech
					&amp; debate community by the National Speech &amp; Debate Association.
				</p>

				<p>
					The tournament officials have not yet posted
					information in this space; but click the tabs above, and
					see the details &amp; contact information at right, to see
					more information about the tournament as it comes
					available.  
				</p>

				<p>
					If registration is open, you can register by clicking 
					the Register tab at top. 
					<a 
						class="inline semibold redtext"
						href="/user/login/new_user.mhtml"
					>created a tabroom.com account</a> 
					before you can register for this tournament.

				</p>

%			}

%		}

	</div>

	<div class="menu">

		<div class="sidenote">

%			if ($tourn_settings{"logo"}) { 
				<div class="centeralign">
					<img 
						src   = "<% $Tab::s3_url %>/<% $tourn->id."/".$tourn_settings{"logo"} %>"
						alt   = "Logo"
						style = "max-width: 220px;"/
					>
				</div>
%			}

			<h4>Invite & Packets</h4>

%   		if ($tourn_settings{"invite"}) { 
				<a class="green full" href="<% $Tab::s3_url %>/<% $tourn->id."/".$tourn_settings{"invite"} %>">
					Tournament Invitation
				</a>
%   		}

%   		if ($tourn_settings{"bills"}) { 
    	    	<a class="green full" href="<% $Tab::s3_url %>/<% $tourn->id."/bills/".$tourn_settings{"bills"} %>">
					Congress Legislation
				</a>
%   		}

			<h6>Circuit(s)</h6> 

%			foreach my $circuit ($m->comp('/funclib/tourn_circuits.mas', tourn => $tourn)) { 
				<a class="blue nowrap  full" href="/index/circuit/index.mhtml?circuit_id=<% $circuit->id %>">
					<% $circuit->name %>
				</a>
%			}

			<h6>Location</h6>

%			foreach my $site ($m->comp("/funclib/tourn_sites.mas", tourn => $tourn)) {
				<a 
					class="<% ($site_id == $site->id) ? "dk" : "" %>blue full" 
					href="index.mhtml?site_id=<% $site->id %>&tourn_id=<% $tourn_id %>"
				> <% $site->name %> </a>
%			}

			<h6>Contacts</h6> 

%			foreach my $contact ($m->comp("/funclib/tourn_admins.mas", tourn => $tourn, contact => 1)) { 
				<a class="blue full" 
					href="mailto:<% $contact->email %>"
				> <% $contact->first." ".$contact->last %> </a>
%			}

			<h6>Info</h6>
<%perl>

			my @postings = 
				sort {$b->uploaded <=> $a->uploaded}
				$tourn->files( type => "front", published => 1);

			if (@postings) {

				foreach my $posting (@postings) { 
</%perl>
					<a 
						class="yellow full" 
						href="<% $Tab::s3_url %>/<% $tourn->id %>/postings/<% $posting->id %>/<% $posting->filename %>"
					>
						<span class="threequarters nospace">
							<% ($posting->label) ? $posting->label : $posting->filename %>
						</span>
						<span class="quarter centeralign fa fa-download">
						</span>
					</a>
<%perl>
				}
			}

			foreach my $webpage (sort {$a->page_order <=> $b->page_order} $tourn->webpages) { 

				next unless $webpage->published;
				next if $webpage->special;

</%perl>
				<a 
					class="<% $webpage_id == $webpage->id ? "dk" : ""%>yellow full" 
					href="/index/tourn/index.mhtml?webpage_id=<% $webpage->id %>&tourn_id=<% $tourn->id %>"
				><% $webpage->title %></a>

%			}

%			if (Tab::Email->search( tourn => $tourn->id )) { 
				 <a 
				 	class = "yellow full"
					href  = "/index/tourn/emails.mhtml?tourn_id=<% $tourn->id %>"
				>Email Archive</a>
%			}

			<a 
				class = "yellow full"
				href  = "/index/tourn/events.mhtml?tourn_id=<% $tourn->id %>"
			>Events/Divisions</a>

%			if ($tourn_settings{"publish_schools"}) { 
				<a 
					class="yellow full" 
					href="/index/tourn/schools.mhtml?tourn_id=<% $tourn->id %>"
					>Schools Registered</a>
%			}

%			if ($tourn->webname && scalar @others > 1) { 
				<a 
					class="martop blue full" 
					href="/index/tourn/past.mhtml?webname=<% $tourn->webname %>"
				>Other Years' Results</a>
%			}

%			my $switch;


		</div>

		<div class="sidenote">

			<h4>Dates & Deadlines</h4>

%			if ($district) { 

				<div class="explain centeralign">
					Times are in <% $tz_ob->short_name_for_datetime($now) %>
				</div>

<%perl>
				foreach my $weekend ($tourn->weekends) { 

					my $start = $weekend->start->set_time_zone($tz);
					my $end = $weekend->end->set_time_zone($tz);
</%perl>

					<p class="semibold bluetext bigger centeralign"><% $weekend->name %></p>

					<div class="row">
						<span class="semibold smaller half">
							Competition
						</span>

						<span class="smaller half">
							<% ($start) ? Tab::niceshortdate($start) : "" %>
							<% ($start->mdy ne $end->mdy) 
								? " to ".Tab::niceshortdate($end) 
								: ""
							%>
						</span>

					</div>
			
					<div class="row">

						<span class="semibold smaller half">
							Reg Opens
						</span>

						<span class="smaller half">
							<% Tab::niceshortdt($weekend->reg_start->set_time_zone($tz)) %>
						</span>

					</div>

					<div class="row">

						<span class="semibold smaller half">
							Reg Close
						</span>

						<span class="smaller half">
							<% Tab::niceshortdt($weekend->reg_end->set_time_zone($tz)) %>
						</span>

					</div>

					<div class="row">

						<span class="semibold smaller half">
							Fees Frozen
						</span>

						<span class="smaller half">
							<% Tab::niceshortdt($weekend->freeze_deadline->set_time_zone($tz)) %>
						</span>

					</div>

					<div class="row">

						<span class="semibold smaller half">
							Judging Due
						</span>

						<span class="smaller half">
							<% Tab::niceshortdt($weekend->judge_deadline->set_time_zone($tz)) %>
						</span>

					</div>

					<div class="row">

						<span class="semibold smaller half">
							Drop online
						</span>

						<span class="smaller half">
							<% Tab::niceshortdt($weekend->drop_deadline->set_time_zone($tz)) %>
						</span>
		
					</div> 

					<div class="row">

						<span class="semibold smaller half">
							Penalty fines
						</span>

						<span class="smaller half">
							<% Tab::niceshortdt($weekend->fine_deadline->set_time_zone($tz)) %>
						</span>

					</div>

%				}

%			} else { 

				<div class="explain centeralign">
					Times are in <% $tz_ob->short_name_for_datetime($now) %>
				</div>

				<div class="row">
					<span class="semibold smaller half">
						Tournament
					</span>

					<span class="smaller half">
						<% ($start) ? Tab::niceshortdate($start) : "" %>
						<% ($start->mdy ne $end->mdy) ? " to ".Tab::niceshortdate($end) : "" %>
					</span>

				</div>
		
				<div class="row">

					<span class="semibold smaller half">
						Reg Opens
					</span>

					<span class="smaller half">
						<% ($tourn->reg_start) ? Tab::niceshortdt($tourn->reg_start->set_time_zone($tz)) : "Not Set" %>
					</span>

				</div>

				<div class="row">

					<span class="semibold smaller half">
						Reg Close
					</span>

					<span class="smaller half">
						<% ($tourn->reg_end) ? Tab::niceshortdt($tourn->reg_end->set_time_zone($tz)) : "Not Set" %>
					</span>

				</div>

				<div class="row">

					<span class="semibold smaller half">
						Fees Frozen
					</span>

					<span class="smaller half">
%						my $freeze = $tourn_settings{"freeze_deadline"};
						<% ($freeze) ? Tab::niceshortdt($freeze->set_time_zone($tz)) : "Not Set" %>
					</span>

				</div>

				<div class="row">

					<span class="semibold smaller half">
						Judging Due
					</span>

					<span class="smaller half">
%						my $judge = $tourn_settings{"judge_deadline"};
						<% ($judge) ? Tab::niceshortdt($judge->set_time_zone($tz)) : "Not Set" %>
					</span>

				</div>

				<div class="row">

					<span class="semibold smaller half">
						Drop online
					</span>

					<span class="smaller half">
%						my $drop = $tourn_settings{"drop_deadline"};
						<% ($drop) ? Tab::niceshortdt($drop->set_time_zone($tz)) : "Not Set" %>
					</span>
	
				</div> 

				<div class="row">

					<span class="semibold smaller half">
						Penalty fines
					</span>

					<span class="smaller half">
%						my $fine = $tourn_settings{"fine_deadline"};
						<% ($fine) ? Tab::niceshortdt($fine->set_time_zone($tz)) : "Not Set" %>
					</span>

				</div>

			</div>

%		}

	</div>

