<%args>
	$person
	$country    => undef
	$state      => undef
	$year       => undef
	$circuit_id => undef
</%args>
<%init>

	use POSIX;

	my $key = $country."-".$state."-".$year."-".$circuit_id;
	return if $m->cache_self( key => $key, expires_in => '5m' );

	my $tz = $person->tz if $person;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now;
	my $limit;
	my $weekend_limit;
	my $amount;

	$year = int($year);

	if ($year > 0 && $year < 3000) { 
		$limit .= " and tourn.start < \" $year-07-01 00:00:00\"";
		$weekend_limit .= " and weekend.start < \" $year-07-01 00:00:00\"";
		$year--;
		$limit .= " and tourn.start > \" $year-07-01 00:00:00\"";
		$weekend_limit .= " and weekend.start > \" $year-07-01 00:00:00\"";
		$year++;

	} else { 
		$now->subtract(days => 2);
		$limit .= " and tourn.end > \"".DateTime::Format::MySQL->format_datetime($now)."\"";
		$weekend_limit .= " and weekend.end > \"".DateTime::Format::MySQL->format_datetime($now)."\"";
		$amount = " limit 256";
	}

	my $state_hash = $m->comp("/funclib/state_hash.mas");

	if ($state && defined $state_hash->{$state}) { 
		$limit .= " and tourn.state = \"".$state."\"";
		$weekend_limit .= " and tourn.state = \"".$state."\"";
	}

	my $country_hash = $m->comp("/funclib/country_hash.mas");

	if ($country && defined $country_hash->{$country}) { 
		$limit .= " and tourn.country = \"".$country."\"";
		$weekend_limit .= " and tourn.country = \"".$country."\"";
	}

	my $circuit = Tab::Circuit->retrieve($circuit_id) 
		if $circuit_id
		&& $circuit_id eq int($circuit_id);

	if ($circuit) { 
		$limit .= "\nand exists ( select tourn_circuit.id from tourn_circuit ";
		$limit .= "where tourn_circuit.tourn = tourn.id ";
		$limit .= "and tourn_circuit.approved = 1 ";
		$limit .= "and tourn_circuit.circuit = \"".$circuit->id."\" )\n";

		$weekend_limit .= "\nand exists ( select tourn_circuit.id from tourn_circuit ";
		$weekend_limit .= "where tourn_circuit.tourn = tourn.id ";
		$weekend_limit .= "and tourn_circuit.approved = 1 ";
		$weekend_limit .= "and tourn_circuit.circuit = \"".$circuit->id."\" )\n";
	}

	Tab::Tourn->columns(TEMP => qw/nats msnats tournname tournid/);

	Tab::Tourn->set_sql(front_page => "
		select tourn.*, msnats.id as msnats, nats.id as nats
		from tourn

		left join tourn_setting msnats 
			on msnats.tourn = tourn.id 
			and msnats.tag = 'nsda_ms_nats'

		left join tourn_setting nats 
			on nats.tourn = tourn.id 
			and nats.tag = 'nsda_nats'

		where tourn.hidden != 1
		$limit
		and not exists (
			select weekend.id
			from weekend
			where weekend.tourn = tourn.id
		)
		order by tourn.end
		$amount
	");

	my @tourns = Tab::Tourn->search_front_page();

	Tab::Weekend->columns(TEMP => qw/tz webname location city state country tournname tournid/);

	Tab::Weekend->set_sql(front_page => "
		select weekend.*, 
			tourn.id as tournid, tourn.tz as tz, tourn.webname as webname, tourn.city as location,
			tourn.city as city, tourn.state as state, tourn.country as country,
			tourn.name as tournname
		from (tourn, weekend)

		left join tourn_setting msnats 
			on msnats.tourn = tourn.id 
			and msnats.tag = 'nsda_ms_nats'

		left join tourn_setting nats 
			on nats.tourn = tourn.id 
			and nats.tag = 'nsda_nats'

		where tourn.hidden != 1
		and tourn.id = weekend.tourn
		$weekend_limit
		order by weekend.end
		$amount
	");

	my @weekends = Tab::Weekend->search_front_page();

	push @tourns, @weekends;

	@tourns = sort {$a->end->epoch <=> $b->end->epoch} @tourns;

</%init>


	<div class="menu">

		<div class="sidenote">

			<div class="centeralign full">
				<a 
					class="bluetext buttonwhite invert bigger seveneighths centeralign"
					href="index.mhtml?circuit_id=83"
				>NSDA Districts Calendar</a>

			</div>

			<h4>Circuit</h4>

			<form action="index.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "state"
				value = "<% $state %>"
			>

			<input 
				type  = "hidden"
				name  = "country"
				value = "<% $country %>"
			>

			<input 
				type  = "hidden"
				name  = "year"
				value = "<% $year %>"
			>

			<div class="row centeralign full">

				<select 
					name     = "circuit_id"
					onchange = 'this.form.submit()'
					class    = "fixedmed"
				>

					<option value=""></option>

%					foreach my $circuit (sort {$a->name cmp $b->name} Tab::Circuit->search(active => 1)) { 
						<option value="<% $circuit->id %>" 
							<% $circuit_id == $circuit->id ? 'selected' : "" %>
						> <% $circuit->abbr %> <% $circuit->name %>
						</option>
%					}

				</select>

			</div>

			</form>

			<h4>School Year Ending</h4>

			<form action="index.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "state"
				value = "<% $state %>"
			>

			<input 
				type  = "hidden"
				name  = "country"
				value = "<% $country %>"
			>

			<input 
				type  = "hidden"
				name  = "circuit"
				value = "<% $circuit_id %>"
			>

			<div class="row centeralign full">

				<select 
					name     = "year"
					onchange = 'this.form.submit()'
					class    = "fixedmed"
				>

					<option value=""></option>

%					my $ayear = $now->year + 1;

%					while ($ayear > 2002) { 
						<option value="<% $ayear %>" <% $year == $ayear ? 'selected' : "" %>>
							<% $ayear-- %>
						</option>
%					}

				</select>

			</div>

			</form>

<%perl>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare('
		select distinct state 
		from tourn 
		where state is not null 
		and state != "" 
		order by state');

	$sth->execute();

	my $cth = $dbh->prepare('
		select distinct country 
		from tourn 
		where country is not null 
		and country != "" 
		order by country'
	);
	$cth->execute();

</%perl>

			<h4>States/Provinces</h4>

			<div class="row centeralign full">

				<form action="index.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "year"
					value = "<% $year %>"
				>

				<input 
					type  = "hidden"
					name  = "country"
					value = "<% $country %>"
				>

				<input 
					type  = "hidden"
					name  = "circuit"
					value = "<% $circuit_id %>"
				>

				<select 
					name     = "state"
					class    = "fixedmed"
					onchange = "this.form.submit();"
				>

					<option value=""></option>

%					while( my $astate = $sth->fetchrow_array() ) { 
%						next unless $astate;
						<option
							value="<% $astate %>"
							<% $astate eq $state ? 'selected="selected"' : "" %>
						> <% $astate %> <% $state_hash->{$astate} %>
						</option>
%					}

				</select>

				</form>

			</div>

			<h4>Countries</h4>

			<div class="row centeralign full">

				<form action="index.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "year"
					value = "<% $year %>"
				>

				<input 
					type  = "hidden"
					name  = "state"
					value = "<% $state %>"
				>

				<input 
					type  = "hidden"
					name  = "circuit"
					value = "<% $circuit_id %>"
				>

				<select 
					name     = "country"
					class    = "fixedmed"
					onchange = "this.form.submit();"
				>

					<option value=""></option>

%					while( my $acountry = $cth->fetchrow_array() ) { 
%						next unless $acountry;
						<option
							value="<% $acountry %>"
							<% $acountry eq $country ? 'selected="selected"' : "" %>
						> <% $acountry %> <% $country_hash->{$acountry} %>
						</option>
%					}

				</select>

				</form>

			</div>

%			$sth->finish;
%			$cth->finish;

		</div>

	</div>

	<& "/funclib/ad.mas" &>

	<script>

	function beGone(name) {
		jQuery.cookie(name, ' ',{expires: 'Thu, 01 Jan 1970 00:00:01 GMT', path: '/', domain: 'www.tabroom.com'});
	}

	$(document).ready(function() {
		beGone("vg");
		beGone("vl");
		beGone("vq");
		beGone("vd");
	});

	</script>

	<div class="main">

		<div class="full nospace">

			<span class="twothirds nospace">

				<h2> 
%					if ($year || $country || $state) { 
						<% scalar @tourns %> Tournaments
%					} else {
						Upcoming Tournaments
%					}	
				</h2>

			</span>

			<span class="third nospace rightalign">

				<h6>
%					if ($state) { 
						in <% $state_hash->{$state} %>
%					} 

%					if ($country) { 
						in <% $country_hash->{$country} %>
%					} 
%					if ($year) { 
						in the <% ($year - 1)%>-<% $year %> school year
%					} 

%					if ($circuit > 0) { 
						in <% $circuit->name %>
%					}
				</h6>

			</span>

		</div>

		<& "/funclib/tablesorter.mas", 
			table     => "tournlist",
			nobuttons => 1
		&> 

		<table 
			id    = "tournlist"
			class = "narrow"
		>

			<thead>

			<tr class="yellowrow">
			
				<th class="smaller">
					Dates
				</th>

				<th class="smaller">
					Tournament
				</th>

				<th class="smaller">
					City
				</th>

				<th class="smaller">
					Locale
				</th>

				<th class="smaller">
					Registration
				</th>

			</tr>

			</thead>

			<tbody class="smaller">

<%perl>

				my $counter = 256;

				foreach my $tourn (@tourns) { 

					next unless $counter-- > 1;

					my $tz;
					$tz = $person->tz if $person;
					$tz = $tourn->tz if $tourn->tz && not defined $tz;
					$tz = "UTC" unless $tz;

					my $end = $tourn->end->set_time_zone($tz);

					my $start = $tourn->start->set_time_zone($tz) 
						if $tourn->reg_start;

					my $reg_end = $tourn->reg_end->set_time_zone($tz) 
						if $tourn->reg_end;

					my $reg_start = $tourn->reg_start;

					$reg_start->set_time_zone($tz) if $reg_start;
					$reg_end->set_time_zone($tz) if $reg_end;

					my $open++ if (
						$tourn->reg_start 
						&& $tourn->reg_end 
						&& $tourn->reg_start->epoch < $now->epoch 
						&& $tourn->reg_end->epoch > $now->epoch
					);
</%perl>
	
				<tr class="<% ($tourn->webname eq "msnats" 
					|| $tourn->webname eq "nationals") 
					? "semibold bluetext" 
					: ""
				%>">

					<td class="centeralign smallish nowrap">

						<span class="hidden"><% $start ? $start->epoch : "" %></span>

						<% Tab::niceshortdate($start) %> 
						<% ($start && $end && $start->day != $end->day) ? "- ".Tab::niceshortdate($end) : "" %>

					</td>

					<td class="nospace">
						<a 
							class="white smallish nearfull"
							href="tourn/index.mhtml?tourn_id=<% $tourn->tournid ? $tourn->tournid : $tourn->id %>"
						>

%						my $tournname = $tourn->tournname;
%						$tournname =~ s/District Tournament//g;
							<% $tournname ? '<span class="semibold half">'.$tournname.'</span><span class="half">' : "" %>
							<% $tourn->name %>
							<% $tournname ? '</span>' : "" %>
						</a>
					</td>

					<td title="<% $tourn->city %>" class="smallish white">
						<% substr($tourn->city, 0, 24) %> 
					</td>

					<td title="<% $tourn->city %>" class="centeralign smallish">
%						if ($tourn->state) { 
							<a class="white" 
								href="index.mhtml?state=<% $tourn->state %>&country=<% $country %>&circuit_id=<% $circuit_id %>&year=<% $year %>">
%						} elsif ($tourn->country) { 
							<a class="white" 
								href="index.mhtml?country=<% $tourn->country %>&circuit_id=<% $circuit_id %>&year=<% $year %>">
%						}
						<% $tourn->location %> 
						</a>
					</td>

					<td class="centeralign nowrap">

						<a 
							class="white smaller nospace" 
							href="tourn/index.mhtml?tourn_id=<% $tourn->id %>"
						>

						<span class="hidden">
							<% ($open && $reg_end) ? $reg_end->epoch : "" %>
							<% $reg_start && $reg_start > $now ? $reg_start->epoch : ""%>
							<% $reg_end && $reg_end < $now ? $reg_end->epoch : "" %>
						</span>

%						if ($open) { 

							<span class="leftalign fifth greentext semibold">Due</span>

							<span class="fifth nospace"><% Tab::niceshortdate($reg_end) %></span>
							
							<span class="threefifths"><% Tab::nicetime($reg_end)." ".Tab::tzname($tz) %></span>

%						} elsif ($reg_start > $now ) { 

							<span class="leftalign fifth bluetext semibold">Open</span>

							<span class="fifth nospace"><% Tab::niceshortdate($reg_start) %></span>
							
							<span class="threefifths"><% Tab::nicetime($reg_start)." ".Tab::tzname($tz) %></span>

%						} elsif ($reg_end < $now) { 

							<span 
								class="centeralign redtext semibold"
								title="Registration was due by <% Tab::niceshortdate($reg_end) %> <% Tab::nicetime($reg_end)." ".Tab::tzname($tz) %>"
							>
								Closed
							</span>

%						}

						</a>

					</td>
			
				</tr>

%			}

		</tbody>

		</table>

	</div>



