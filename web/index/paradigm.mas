<%args>
	$judge_person => undef
	$tz => undef
</%args>
<%init>

	return unless $judge_person;

	$tz = $judge_person->tz if (not defined $tz);
	$tz = "UTC" unless $tz;

	my $changed = $judge_person->setting("paradigm_timestamp");

	if ($changed) { 
		$changed->set_time_zone($tz);
	}

</%init>

	<span class="twothirds">
		<h4><% $judge_person->first." ".$judge_person->last %> Paradigm</h4>
	</span>

	<span class="third rightalign semibold bluetext">
%		if ($changed) { 
			Last changed <% Tab::niceshortdt($changed) %> <% Tab::tzname($tz) %>
%		}	
	</span>

	<div class="paradigm">
		<% $judge_person->setting("paradigm") %>
	</div>

	<& "/funclib/tablesorter.mas", table => "record" &>

	<a name="judging"></a>

	<span class="twothirds">
		<h4>Full Judging Record</h4>
	</span>

	<span 
		id    = "record_buttonarea"
		class = "third rightalign"
	>
	</span>

	<table id="record"> 

	<thead>

	<tr class="yellowrow">

		<th class="smallish">Tournament</th>
		<th class="smallish">Date</th>
		<th class="smallish">Event</th>
		<th class="smallish">Rd</th>
		<th class="smallish">Aff</th>
		<th class="smallish">Neg</th>
		<th class="smallish">Decision</th>																
	</tr>
	
	</thead>
	
	<tbody class="smallish">

<%perl>

	Tab::Ballot->columns(TEMP => qw/win eventabbr eventtype panel_id entry_code tournid tournname tournstart roundid roundlabel roundname roundtype entryid/);

	Tab::Ballot->set_sql( ballots_by_judge => "
		select ballot.*, score.value as win, 
			event.abbr as eventabbr, event.type as eventtype, 
			panel.id as panel_id, 
			entry.id as entryid, entry.code as entry_code, 
			tourn.name as tournname, tourn.id as tournid, tourn.start as tournstart, 
			round.label as roundlabel, round.name as roundname, round.type as roundtype, round.id as roundid
		from ballot, judge, score, panel, round, event, entry, tourn
		where ballot.judge=judge.id
			and judge.person = ? 
			and score.ballot=ballot.id
			and score.tag= 'ballot'
			and panel.id=ballot.panel
			and round.id=panel.round
			and round.published > 0
			and round.post_results > 0
			and round.event = event.id
			and ballot.entry = entry.id
			and tourn.id = event.tourn
			order by tourn.start desc, round.name, ballot.panel asc
		");

		my @ballots = Tab::Ballot->search_ballots_by_judge($judge_person);

		my @panels;
		my %panel_results;
		my %used;

		foreach my $ballot (@ballots) {

			my $panel = $ballot->panel;
			my $panel_id = $panel->id;
			push @panels, $panel unless $used{$panel}++;

			my $aff_string = "AFF";
			my $neg_string = "NEG";

			$aff_string = "PRO" if $ballot->eventtype eq "pf";
			$neg_string = "NEG" if $ballot->eventtype eq "pf";

			$aff_string = "GOV" if $ballot->eventtype eq "parli";
			$neg_string = "OPP" if $ballot->eventtype eq "parli";

			$panel_results{$panel_id}{"aff"} = $ballot->entry_code if $ballot->side == 1;
			$panel_results{$panel_id}{"neg"} = $ballot->entry_code if $ballot->side == 2;

			$panel_results{$panel_id}{"affid"} = $ballot->entryid if $ballot->side == 1;
			$panel_results{$panel_id}{"negid"} = $ballot->entryid if $ballot->side == 2;

			if ($ballot->side == 1 and $ballot->win ==1) { 
				$panel_results{$panel_id}{"decision"} = $aff_string;
				$panel_results{$panel_id}{"voted_for"} = $ballot->entry_code;
			}

			if ($ballot->side == 2 and $ballot->win ==1) { 
				$panel_results{$panel_id}{"decision"} = $neg_string;
				$panel_results{$panel_id}{"voted_for"} = $ballot->entry_code;
			}

			my ($winner, $winside, $result) = $m->comp('/funclib/panel_winner.mas', panel => $ballot->panel);

			$panel_results{$panel_id}{"winner"} = substr($winner->code, 0, 10) if $winner;
			$panel_results{$panel_id}{"result"} = $result;

			$panel_results{$panel_id}{"tourn"} = $ballot->tournname;
			$panel_results{$panel_id}{"tournid"} = $ballot->tournid;

			eval { 
				$panel_results{$panel_id}{"tourndate"} 
					= DateTime::Format::MySQL->parse_datetime($ballot->tournstart);
			};

			$panel_results{$panel_id}{"eventabbr"} = $ballot->eventabbr;
			$panel_results{$panel_id}{"round"} = $ballot->roundlabel;
			$panel_results{$panel_id}{"roundid"} = $ballot->roundid;
			$panel_results{$panel_id}{"round"} = $ballot->roundname unless $panel_results{$panel_id}{"round"};
			$panel_results{$panel_id}{"roundtype"} = $ballot->roundtype;
		}


		foreach my $panel (@panels) {
			my $panel_id = $panel->id;

</%perl>
			<tr>

				<td class="nospace">
					<a 
						class  = "button leftalign white"
						target = "blank"
						href="/index/tourn/postings/index.mhtml?tourn_id=<% $panel_results{$panel_id}{"tournid"} %>"
					><% $panel_results{$panel_id}{"tourn"} %></a>
				</td>

				<td>
					<% Tab::pickerdate($panel_results{$panel_id}{"tourndate"}) %>
				</td>

				<td>
					<% $panel_results{$panel_id}{"eventabbr"} %>
				</td>

				<td class="nospace">
					<a
						class="button leftalign white" 
						target="blank" 
						href="/index/tourn/postings/round.mhtml?tourn_id=<% $panel_results{$panel_id}{"tournid"} %>&round_id=<% $panel_results{$panel_id}{"roundid"} %>">
					<% $panel_results{$panel_id}{"round"} %>
					</a>
				</td>

				<td class="nospace">
					<a 
						class="button leftalign white" 
						target="blank" 
						href="/index/tourn/postings/entry_record.mhtml?tourn_id=<% $panel_results{$panel_id}{"tournid"} %>&entry_id=<% $panel_results{$panel_id}{"affid"}%>">
					<% $panel_results{$panel_id}{"aff"} %>
					</a>
				</td>

				<td class="nospace">
					<a class="button leftalign white" 
						target="blank" 
						href="/index/tourn/postings/entry_record.mhtml?tourn_id=<% $panel_results{$panel_id}{"tournid"} %>&entry_id=<% $panel_results{$panel_id}{"negid"}%>">
					<% $panel_results{$panel_id}{"neg"} %>
					</a>
				</td>

				<td class="nowrap">
					<span class="fifth">
						<% $panel_results{$panel_id}{"decision"} %>
					</span>

%						if ($panel_results{$panel_id}{"roundtype"} eq "elim" 
%							|| $panel_results{$panel_id}{"roundtype"} eq "final"
%						) { 
							<div class="padless full italic rightalign smallish">
							 	<% $panel_results{$panel_id}{"winner"} %> on a 
								<%  $panel_results{$panel_id}{"result"} %>
							</div>
%						}
					</td>
				</tr>
%			}		
			</tbody>
				
		</table>
