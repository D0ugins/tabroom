<%args>
	$person          => undef
	$judge_person_id => undef
	$search_first    => undef
	$search_last     => undef
</%args>
<%init>

	use POSIX qw/strftime/;
	my $tz = $person->tz if $person;
	$tz = "UTC" unless $tz;

    my $key = $judge_person_id."-".$search_first."-".$search_last;

	return if $m->cache_self(
		key        => $key,
		expires_in => '5m'
	);

	my $judge_person = Tab::Person->retrieve($judge_person_id) if $judge_person_id;

	$search_first =~ s/[\W_]//g;
	$search_last =~ s/[\W_]//g;

	my @searches;

	my $num_results;

	if ($search_first || $search_last) {

		if ($search_first && $search_last) {

			Tab::Person->set_sql( both => "
				select distinct *
				from person
				where first like ?
				and last like ?
				and exists (
					select person_setting.*
					from person_setting
					where person_setting.person = person.id
					and person_setting.tag = 'paradigm'
				)
			");

			@searches = Tab::Person->search_both($search_first."%", $search_last."%");

		} elsif ($search_first) {

			Tab::Person->set_sql( first => "
				select distinct *
				from person
				where first like ?
				and exists (
					select person_setting.*
					from person_setting
					where person_setting.person = person.id
					and person_setting.tag = 'paradigm'
				)
			");

			@searches = Tab::Person->search_first($search_first."%");

		} elsif ($search_last) {

			Tab::Person->set_sql( last => "
				select distinct *
				from person
				where last like ?
				and exists (
					select person_setting.*
					from person_setting
					where person_setting.person = person.id
					and person_setting.tag = 'paradigm'
				)
			");

			@searches = Tab::Person->search_last($search_last."%");

		}

		$judge_person = $searches[0] if scalar @searches == 1;
		$num_results = scalar @searches;
	}

	Tab::PersonSetting->set_sql( by_training => "
		select distinct person_setting.*
		from person_setting
		where person_setting.person = ?
		and person_setting.tag like 'judge_training_%'
		order by person_setting.tag
	");

	my @training_notes = Tab::PersonSetting->search_by_training($judge_person->id) if $judge_person;

</%init>

	<div class="main">

%		if ($judge_person) {
			<& "paradigm.mas", judge_person => $judge_person &>
%		} elsif (@searches) {

			<h2>Pick one</h2>

			<p>
				Your search for <% $search_first %> <% $search_last %>
				returned <% $num_results %> results:
			</p>

%			my $switch = 1 ;

<%perl>

			foreach my $search (@searches) {

				my @logins = $search->logins;

				my $last_access;
				foreach my $login (@logins) {
					$last_access = $login->last_access
						unless $last_access;

					$last_access = $login->last_access
						if $last_access < $login->last_access;
				}
				my @judges = $search->judges;
				my %schools;
				my $school_names;

				foreach my $judge (@judges) {
					next unless $judge->school;
					next unless $judge->school->name;
					next if $schools{$judge->school->name}++;

					$school_names .= ", " if $school_names;
					$school_names .= $judge->school->name;
				}
</%perl>

				<a
					class="lightrow plain full hover padmore martopmore"
					href="paradigm.mhtml?judge_person_id=<% $search->id %>"
				>

					<span class="third nospace padleft">
						<h5> <% $search->first." ".$search->last %> </h5>

						<div class="padless marno full">
							(<% $search->state ? $search->state."/" : "" %><% $search->country %>)
						</div>
						<div class="padless marno full">
							<% $last_access ? "Last Login: ".Tab::niceshortdt($last_access) : "" %>
						</div>
					</span>

					<span class="fifth smallish">
%						if ($school_names) {
							<h5>Judges for:</h5>
%						}
					</span>

					<span class="third marno">

						<% $school_names %>
					</span>

					<span class="tenth rightalign">
						<span class="bluetext buttonwhite">Paradigm</a>
					</span>
				</a>

%			}

%		} else {

			<h2>Judge Paradigms</h2>

			<p>Search for a judge at right to read paradigms</p>

%			unless (@searches) {

%				if ($search_first || $search_last) {
					<p class="explain centeralign">
						Your search for <% $search_first %> <% $search_last %> returned no judges with paradigms.  Please
						try again.
					</p>
%				}
%			}
%		}

		<br />
		<br />

<%perl>

		foreach my $note (@training_notes) {

			my $tag = $note->tag;
			$tag =~ s/judge_training_//g;
			my $circuit = Tab::Circuit->retrieve($tag);
			my $entered_tag = "judge_tr_meta_".$tag;

</%perl>

			<a name="training"></a>

			<h4>Training record from <% $circuit->name %></h4>

			<div class="row rightalign explain">
				<% $judge_person ? $judge_person->setting($entered_tag) : "" %>
			</div>

			<div class="row">
				<% $note->value_text %>
			</div>

%		}

	</div>

	<div class="menu">

%		if ($judge_person) {

			<div class="sidenote">

				<h4>Intel on <% $judge_person->last %></h4>

				<a
					href="/user/tourn/show_past_prefs.mhtml?judge_person_id=<% $judge_person->id %>"
					class="blue full"
				>
					View Past Ratings
				</a>

				<a href="#judging" class="blue full">
					View Judging Record
				</a>
			</div>

%		}

		<div class="sidenote">

			<h4>Search Judges:</h4>

			<form action="paradigm.mhtml">

			<div class="row centeralign">
				<input
					type        = "text"
					name        = "search_first"
					placeholder = "First name"
					size        = "24"
				>
			</div>

			<div class="row centeralign">
				<input
					type        = "text"
					name        = "search_last"
					placeholder = "Last name"
					size        = "24"
				>
			</div>

			<div class="liblrow rightalign">
				<input
					type  = "submit"
					value = " Go "
				>
				</form>
			</div>

		</div>
	</div>

