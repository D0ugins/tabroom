<%args>

</%args>
<%init>

	my ($jsonref, $raw) = $m->comp("api_client.mas", path => "/reports/nats-appearances");

	my $dbh = Tab::DBI->db_Main();

	my $exists_sth = $dbh->prepare("
		select chapter.id, cs.id
		from chapter
			left join chapter_setting cs
			on cs.chapter = chapter.id
			and cs.tag = 'nats_appearances'
		where chapter.nsda = ?
	");

	my $update_sth = $dbh->prepare("
		update chapter_setting set value = ? where id = ?
	");

	my $insert_sth = $dbh->prepare("
		insert into chapter_setting (value, chapter, tag) values (?, ?, 'nats_appearances');
	");

	my $counter;

	foreach my $school_ref (@{$jsonref->{data}}) {

		next unless $school_ref->{"Appearances"} > 0;

		$exists_sth->execute($school_ref->{"school_id"});

		while (
			my ($chapter_id, $setting_id) = $exists_sth->fetchrow_array()
		) {
			if ($setting_id) {
				$update_sth->execute($school_ref->{"Appearances"}, $setting_id);
			} elsif ($chapter_id) {
				$insert_sth->execute($school_ref->{"Appearances"}, $chapter_id);
			}
		}

		$exists_sth->finish();

		unless ($counter++ % 300) {
			Tab::debuglog("Counter is at $counter");
		}
	}

	$dbh->disconnect();

	return;

</%init>
