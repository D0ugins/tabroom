<%args>
	$student    => undef
	$student_id => undef
	$nsda       => undef
	$person_id  => undef
	$person     => undef
</%args>
<%init>

	unless ($student) {
		$student = Tab::Student->retrieve($student_id);
	}

	return unless $student;

	if ($person_id) {
		$person = Tab::Person->retrieve($person_id);
	}

	unless ($person) {
		$person = Tab::Person->search(nsda => $nsda)->first;
	}

	if ($nsda && $nsda != $student->nsda) {
		$student->nsda($nsda);
		$student->update();
	}

	unless ($person) {
		if ($student->nsda) {
			my $membership = $m->comp("/funclib/nsda/membership.mas", student => $student);

			if ($membership->{'email'}) {
				$person = Tab::Person->search(email => $membership->{"email"})->first;
			}
		}
	}

	if ($person) {

		$student->person($person);

		if ($nsda && $nsda != $person->nsda) {
			$person->nsda($nsda);
			$person->update();
		}
		$m->comp("/funclib/nsda/membership.mas", person => $person);
	}

	my $membership = $m->comp("/funclib/nsda/membership.mas", student => $student);

	$student->grad_year($membership->{"grad_year"});
	$student->update();

	return $student;

</%init>
