<%args>
	$person
	$all   => undef
	$limit => undef
</%args>
<%perl>

	return unless $person && $person->id;

	my $limit_sql = " limit $limit " if $limit;

	if ($all) { 

	    Tab::Tourn->set_sql( by_director => "
        	select distinct tourn.* 
        	from tourn, permission
        	where tourn.id = permission.tourn
        	and permission.person = ? 
        	order by tourn.end DESC
			$limit_sql
			");

    	my @tourns = Tab::Tourn->search_by_director($person->id);

    	Tab::Tourn->set_sql( by_league_admin => "
        	select distinct tourn.* 
        	from tourn, tourn_circuit, permission
			where tourn.id = tourn_circuit.tourn
			and tourn_circuit.circuit = permission.circuit
			and permission.person = ?
			and permission.tag = 'circuit'
        	order by tourn.end DESC
			$limit_sql
			");

		push (@tourns, Tab::Tourn->search_by_league_admin($person->id));

		my %seen = ();
		@tourns = grep { ! $seen{$_->id} ++ } @tourns;
		return (@tourns);

	}

	my $now = DateTime->now;
	$now->subtract(days => 4);

    Tab::Tourn->set_sql( by_director => "
       	select distinct tourn.* 
       	from tourn, permission
       	where tourn.id = permission.tourn
       	and permission.person = ? 
		and tourn.end > ?
       	order by tourn.end
		$limit_sql
		");

   	my @tourns = Tab::Tourn->search_by_director($person->id, DateTime::Format::MySQL->format_datetime($now));

	return (@tourns);

</%perl>
