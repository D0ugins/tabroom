<%args>
	$round => undef
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select count(distinct panel.id), nsda_campus_purchased.value

		from panel, round other, event,
			event_setting online_mode, event_setting online,
			timeslot other_time, timeslot,
			tourn_setting nsda_campus_purchased

		where timeslot.id = ?
			and timeslot.tourn = other_time.tourn
			and timeslot.start < other_time.end
			and timeslot.end   > other_time.start

			and other_time.id = other.timeslot
			and other.event = event.id

			and other.event       = online_mode.event
			and online_mode.tag   = 'online_mode'
			and online_mode.value = 'nsda_private'

			and other.event = online.event
			and online.tag = 'online'

			and nsda_campus_purchased.tourn = timeslot.tourn
			and nsda_campus_purchased.tag = 'nsda_campus_purchased.tag'

			and other.id = panel.round
			and panel.flight in (0, 1)
	");

	$sth->execute($round->timeslot->id);

	my ($panel_count, $total) = $sth->fetchrow_array();

	return ($total - $panel_count);

</%init>
