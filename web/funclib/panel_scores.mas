<%args>
	$panel
	$entry    => undef
	$entry_id => undef
	$judge    => undef
	$comments => undef
	$congress => undef
</%args>
<%init>

	my $limiter = 'score.tag = "rank" 
		or score.tag = "points" 
		or score.tag = "ballot" 
		or score.tag = "rebuttal_points" 
		or score.tag = "congress_speech"';

	$limiter = 'score.tag = "rfd" 
		or score.tag = "categories" 
		or score.tag = "comments"
		or score.tag = "points"' if $comments;

	if ($congress) { 
		$limiter .= " or " if $limiter;
		$limiter .= 'score.tag = "congress_speech"' 
	}

	if ($judge && ($entry || $entry_id))  { 

		$entry_id = $entry->id unless $entry_id;

		Tab::Score->set_sql( by_panel_judge_and_entry => "
			select distinct score.*, ballot.judge as judgeid, 
				score.student as studentid, ballot.entry as entryid
			from score, ballot
			where ballot.panel = ?
			and ballot.entry = ? 
			and ballot.judge = ? 
			and ballot.id = score.ballot
			and ( $limiter )
			order by ballot.entry,
			CASE score.tag WHEN 'ballot' 
				then 1 when 'rank' 
				then 2 when 'points' 
				then 3 when 'congress_speech' 
				then 4 when 'rfd'
				then 5 when 'comments'
				then 6 end");

		return Tab::Score->search_by_panel_judge_and_entry( $panel->id, $entry_id, $judge->id );

	} elsif ($entry || $entry_id) { 

		$entry_id = $entry->id unless $entry_id;

		Tab::Score->set_sql( by_panel_and_entry => "
			select distinct score.*, ballot.judge as judgeid, 
				score.student as studentid, ballot.entry as entryid
			from score, ballot
			where ballot.panel = ?
			and ballot.entry = ? 
			and ballot.id = score.ballot
			and ( $limiter )
			order by ballot.entry, 
			CASE score.tag WHEN 'ballot' 
				then 1 when 'rank' 
				then 2 when 'points' 
				then 3 when 'congress_speech' 
				then 4 when 'rfd'
				then 5 when 'comments'
				then 6 end");


		return Tab::Score->search_by_panel_and_entry( $panel->id, $entry_id );

	} elsif ($judge) { 

		Tab::Score->columns(TEMP => "ballotid");
	
		Tab::Score->set_sql( by_panel_and_judge => "
			select distinct score.*, 
				ballot.judge as judgeid, 
				score.student as studentid, 
				ballot.entry as entryid, 
				ballot.id as ballotid
			from score, ballot
			where ballot.panel = ?
			and ballot.judge = ? 
			and ballot.id = score.ballot
			and ( $limiter )
			order by ballot.entry,
			CASE score.tag WHEN 'ballot' 
				then 1 when 'rank' 
				then 2 when 'points' 
				then 3 when 'congress_speech' 
				then 4 when 'rfd'
				then 5 when 'comments'
				then 6 end");

		return Tab::Score->search_by_panel_and_judge( $panel->id, $judge->id );
	
	} elsif ($panel) {

		Tab::Score->set_sql( by_panel => "
			select distinct score.*, ballot.judge as judgeid, 
				score.student as studentid, ballot.entry as entryid
			from score, ballot
			where ballot.panel = ?
			and ballot.id = score.ballot
			and ( $limiter )
			order by ballot.entry,
			CASE score.tag WHEN 'ballot' 
				then 1 when 'rank' 
				then 2 when 'points' 
				then 3 when 'congress_speech' 
				then 4 when 'rfd'
				then 5 when 'comments'
				then 6 end");

		return Tab::Score->search_by_panel( $panel->id );

	}

	return;

</%init>

