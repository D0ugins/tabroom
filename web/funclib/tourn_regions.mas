<%args>
	$tourn
	$sort_by => undef
</%args>
<%perl>

	my $sort = "order by region.code, region.name";
	$sort = "order by region.name, region.code" if $sort_by eq "name";

	Tab::Region->set_sql( by_tourn => "
		select distinct region.*, registered.value as registered

		from (region, school, tourn)
		left join region_setting registered 
			on registered.region = region.id
			and registered.tag = ? 
			and registered.value = 1
		where region.id = school.region
		and school.tourn = tourn.id
		and tourn.id = ? 
		$sort 
	");
	
	my @regions = Tab::Region->search_by_tourn("registered_".$tourn->id, $tourn->id);
	push @regions, $tourn->regions;

	my %seen = (); 
	@regions = grep { ! $seen{$_->id} ++ } @regions;
	@regions = sort {length($a->code) <=> length($b->code)} @regions;

	return @regions;

</%perl>

