<%args>
	$round 
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $hits_sth = $dbh->prepare("

        select entry.id, entry.code, ballot.side, round.name, opponent.id, opponent.code

        from entry, round, panel, ballot, 
			entry opponent, ballot oppballot,
			round other

		where entry.id = ballot.entry
		and ballot.panel = panel.id
		and oppballot.panel = panel.id
		and opponent.id = oppballot.entry
		and opponent.id != entry.id
		and panel.round = round.id
		and round.event = other.event
		and round.name < other.name
		and other.id = ? 

	");

	my %entry_hits; 

	$hits_sth->execute($round->id);

    while ( 
		my ($entry_id, $entry_code, $ballot_side, $round_name, $opponent_id, $opponent_code) 
		= $hits_sth->fetchrow_array() 
	) { 

		$entry_hits{$entry_id}{$opponent_id}{"count"}++;
		$entry_hits{$entry_id}{$opponent_id}{"code"} = $opponent_code;
		$entry_hits{$entry_id}{$opponent_id}{"rounds"}{$round_name}++;
		$entry_hits{$entry_id}{"sides"}{$round_name} = $ballot_side;
	}

	return %entry_hits;

</%init>
