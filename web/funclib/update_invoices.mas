<%args>
	$school    => undef
	$school_id => undef
	$target_id => undef
	$invoice   => undef
</%args>
<%init>

    use JSON;
    use MIME::Base64;
    use REST::Client;
	use Data::Dumper;

	$school_id = $target_id unless $school_id;

	my @invoices;

	if ($invoice) { 

		$school = $invoice->school;
		push @invoices, $invoice; 

	} elsif ($school) { 

		@invoices = Tab::Invoice->search(
			paid   => 0,
			school => $school_id
		);

	} elsif ($school_id) { 
	
		$school = Tab::School->retrieve($school_id) if $school_id;

		@invoices = Tab::Invoice->search(
			paid   => 0,
			school => $school_id
		);

	} else { 

		@invoices = Tab::Invoice->search(
			paid => 0
		);

	}

	my $counter;

    my $auth_header = encode_base64($Tab::nsda_invoice_user.":".$Tab::nsda_invoice_key);

	my $true = bless( do{\(my $o = 1)}, 'JSON::PP::Boolean' ); 

	my $client = REST::Client->new(
		host => $Tab::nsda_invoice_endpoint 
	);

	foreach my $invoice (@invoices) { 

		if ($invoice
			&& $invoice->school
			&& $invoice->school->chapter
			&& $invoice->school->chapter->nsda
		) { 

			$client->GET(
				"/v1/invoices/".$invoice->blusynergy,
				{
					'Authorization' => "Basic $auth_header",
					'Content-Type'  => 'application/json',
					'Accept'        => 'application/json'
				}
			);

			my $response_json = $client->responseContent();

	        my %answered_invoices = eval {
				return %{JSON::decode_json($response_json)};
			};

			next unless $answered_invoices{"invoiceId"} == $invoice->blusynergy;

			if ($answered_invoices{"status"} eq "paid") { 

				$invoice->paid(1);
				$invoice->update;

				my $amount = $answered_invoices{"total"} * -1;

				my $payment = Tab::Fine->create({
					school  => $invoice->school->id,
					reason  => "NSDA Invoice #".$invoice->blusynergy." paid",
					payment => 1,
					amount  => $amount,
					deleted => 0,
					invoice => $invoice->id,
					tourn   => $invoice->school->tourn->id
				});
			}

			if ($answered_invoices{"status"} eq "cancelled"
				|| $answered_invoices{"status"} eq "canceled"
			) { 
				$invoice->delete();
			}
		}
	}

	if ($ARGS{"property_name"} eq "admin") { 

		$m->clear_buffer();
		$r->content_type('application/json');

		my $msg = $school->name." invoice paid status has been updated";

		$m->print('{ "error": false, "message": "'.$msg.'"}');

		$m->abort();
	
	} else { 

		return "Invoice status updated";

	}

</%init>
