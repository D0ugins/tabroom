<%args>
	$school
</%args>
<%init>

	return unless $school;

	Tab::Category->set_sql(by_school => "
		select distinct category.* 
			from event,entry,category
			where event.id = entry.event 
			and entry.school = ? 
			and entry.unconfirmed = 0
			and event.category = category.id
			order by event.name
	");

	Tab::Category->set_sql(by_judge_school => "
		select distinct category.* 
			from judge, category
			where judge.school = ? 
			and judge.category = category.id
	");

	Tab::Category->set_sql(by_judge_worlds_school => "
		select distinct category.* 
			from judge, category, judge_setting
			where judge.id = judge_setting.judge
			and judge_setting.tag = 'original_school'
			and judge_setting.value = ? 
			and judge.category = category.id
	");

	my @categories = (
		Tab::Category->search_by_school($school->id), 
		Tab::Category->search_by_judge_school($school->id),
		Tab::Category->search_by_judge_worlds_school($school->id)
	);

	my %seen;
	@categories = grep { ! $seen{$_->id} ++ } @categories;

	return sort {$a->name cmp $b->name} @categories; 

</%init>
