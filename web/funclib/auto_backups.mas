<%args>
	$round
</%args>
<%init>

	return unless $round;

	my $event = $round->event;
	return unless $event->setting("auto_backups");

	my $follower_ids = $event->setting("followers");
	return unless $follower_ids;

	my $filepath = $m->comp("download_round.mas", round  => $round);

	my $now = DateTime->now(time_zone => $event->tourn->tz);

	my $body = "\n\nBackup of ".$round->realname." taken at ".Tab::nicedt($now)."\n\n";
	$body .= "To restore, upload this file on the Schemat screen for the round under the blue Settings tab\n";

	my $round_name = $round->realname;
	my $event_name = $event->abbr;
	my $subject = $ARGS{"subject"};

	$round_name =~ s/[\W_]//g;
	$event_name =~ s/[\W_]//g;
	$subject =~ s/[\W_]//g;

	my $name = "$event_name-$round_name-$subject-BackupFile.xml";
	my $subject_line = "$event_name $round_name Backup $subject";

	foreach my $id (split(/,/, $follower_ids)) {

		next unless $id;
		my $person = Tab::Person->retrieve($id);
		next unless $person;
		my $to = $person;

		$m->comp( "/funclib/send_email.mas",
			from_string     => 'Tabroom Backups <live@tabroom.com>',
			to              => $to,
			subject         => $subject_line,
			body            => $body,
			attachment_name => $name,
			attachment_path => $filepath
		);
	}

	return;

</%init>
