<%args>
	$school => undef
	$region => undef
	$category
	$category_settings
</%args>
<%init>

	my @useme; 
	my @alt_judges;

	if ($school) { 

		my @judges = Tab::Judge->search( 
			category => $category->id,
			school   => $school->id
		);

		foreach my $judge (@judges) {
			push (@useme, $judge) unless $judge->covers > 0;
		}

		push( @useme, 
			Tab::Judge->search( 
				covers => $category->id,
				school => $school->id
			)
		);
	
		@alt_judges = $m->comp(
			"/funclib/alt_category_judges.mas", 
				category => $category,
				school   => $school
		);

	} elsif ($region) { 

		my @judges = $m->comp(
			"/funclib/region_judges.mas",
			category => $category,
			region   => $region
		);

		foreach my $judge (@judges) {
			push (@useme, $judge) unless $judge->covers > 0;
		}

		push @useme, $m->comp(
			"/funclib/region_judges.mas",
			category => $category,
			region   => $region,
			covers   => 1
		);

		@alt_judges = $m->comp(
			"/funclib/region_judges.mas",
			category => $category,
			region   => $region,
			alt      => 1
		);

	} else { 

		$m->comp("/funclib/abort.mas", warning => "No school sent, so no fees generated.");

	}

	my @dontcount;
	my $count;

	my $no_free = $category_settings->{"free_strikes_dont_count"};
	my $alt_max = $category_settings->{"alt_max"};

	foreach my $judge (@alt_judges) { 

		$count++ unless $no_free && $judge->setting("free_strike");

		if ($alt_max && ($count > $alt_max)) { 
			push (@dontcount, $judge)
		} else { 
			push (@useme, $judge)
		}
	
	}

	@useme = 	
		sort {$a->setting("first_year") <=> $b->setting("first_year")} 
		@useme 
		if $category_settings->{"fyo_free_strikes"};

	return @useme, @dontcount;

</%init>
