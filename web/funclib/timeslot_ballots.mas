<%args>
	$timeslot
	$style => undef
	$limit => undef
</%args>
<%init>

	if ($style eq "not_collected") {  
	
		Tab::Ballot->set_sql( by_timeslot_event => "
			select distinct ballot.*
			from panel, round, ballot, entry, event
			where ballot.panel = panel.id
			and ballot.collected_by = 0
			and panel.round = round.id
			and round.timeslot = ? 
			and ballot.entry = entry.id
			and entry.dropped = 0
			and entry.dq = 0
			and entry.waitlist = 0
			
			and round.event = event.id
			".$limit."
			order by panel.letter
		");

		return Tab::Ballot->search_by_timeslot($timeslot->id);

	} elsif ($style eq "collected") {  

		Tab::Ballot->set_sql( by_timeslot_event => "
			select distinct ballot.* 
			from panel, round, ballot, entry, event
			where ballot.panel = panel.id
			and ballot.collected_by != 0
			and panel.round = round.id
			and round.timeslot = ? 
			and ballot.entry = entry.id
			and entry.dropped = 0
			and entry.dq = 0
			and entry.waitlist = 0
			
			and round.event = event.id
			".$limit."
			order by panel.letter
		");

		return Tab::Ballot->search_by_timeslot($timeslot->id);

	} else { 

		Tab::Ballot->columns(TEMP => "entrycode");
		Tab::Ballot->columns(TEMP => "lastname");
		Tab::Ballot->columns(TEMP => "firstname");

		Tab::Ballot->set_sql( by_timeslot => "

			select distinct ballot.*, 
				entry.code as entrycode, 
				student.last as lastname,
				student.first as firstname

			from (panel, round, ballot, entry, event)

			left join entry_student on entry_student.entry = entry.id
			left join student on entry_student.student = student.id
			where ballot.panel = panel.id
			and panel.round = round.id
			and round.timeslot = ? 
			and ballot.entry = entry.id
			and entry.dropped = 0
			and entry.dq = 0
			and entry.waitlist = 0
			
			and round.event = event.id
			group by ballot.id
			".$limit."
			order by panel.letter
		");

		return Tab::Ballot->search_by_timeslot($timeslot->id);

	}

</%init>

