<%args>
	$username   => undef
	$password   => undef
    $key    => undef
</%args>
<%init>
    unless ($key eq $Tab::hacky_api_key) {
        $r->status(401);
        $m->print("Unauthorized");
        $m->abort;
    }
    my $login = Tab::Login->search(
        username => lc($username)
    )->first;

    unless ($ARGS{"skip_abort"} || $login) {
        $m->print("0");
        $m->abort;
    } elsif (not defined $login) {
        return;
    }

    $password =~ s/\s+$//g;

    my $db_sha_crypt = $login->sha512;
    my $sha_crypt = crypt($password, $db_sha_crypt) if $db_sha_crypt;
    my $login_ok;

    if ($sha_crypt && ($sha_crypt eq $db_sha_crypt)) {
        $login_ok++;
    } else {
        $m->print("0");
        $m->abort;
    }
    my $person = $login->person;
    $m->print($person);
</%init>

