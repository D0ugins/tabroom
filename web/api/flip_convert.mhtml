<%args>

</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			panel.id,
			panel.flip,
			panel.flip_at,
			panel.flip_status,
			score.value

		from panel, ballot, score

		where score.tag = 'flip_winner'
			and score.ballot = ballot.id
			and ballot.panel = panel.id

		group by panel.id
		order by panel.id
	");

	$sth->execute();

	my $counter;

	while (
		my (
			$pid, $flip, $flip_at, $flip_status, $winner
		) = $sth->fetchrow_array()
	) {

		unless ($counter++ % 100) {
			$m->print("<p> Here I am with count $counter</p>");
			$m->flush_buffer();
		}

		if ($flip_at) {
			Tab::PanelSetting->create({
				panel      => $pid,
				tag        => "flip_at",
				value      => "date",
				value_date => $flip_at
			});
		}

		if ($flip) {
			Tab::PanelSetting->create({
				panel      => $pid,
				tag        => "flip",
				value      => "json",
				value_text => $flip
			});
		}

		if ($flip_status) {
			Tab::PanelSetting->create({
				panel      => $pid,
				tag        => "flip_status",
				value      => $flip_status
			});
		}

		if ($winner) {
			Tab::PanelSetting->create({
				panel      => $pid,
				tag        => "flip_winner",
				value      => $winner
			});
		}

	}

</%init>
