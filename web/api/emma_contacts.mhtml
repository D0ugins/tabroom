<%args>

</%args>
<%init>

	$m->print('<div class="blankfull">');

	my $now = DateTime->today();

	my $week_start = $now->clone();

	while ($week_start->day_of_week != 2) {
		$week_start->subtract(days => 1);
	}

	my $week_end = $week_start->clone();
	$week_end->add(days => 1);

	my $week_ref = ({
		start           => DateTime::Format::MySQL->format_datetime($week_start),
		end             => DateTime::Format::MySQL->format_datetime($week_end),
		member_group_id => 1,
		groupName       => "Tabroom: Monthly Contacts",
		groupId         => 56010202,
		phones          => 1
	});

	my $month_start = $now->clone();

	while ($month_start->day_of_month != 1) {
		$month_start->subtract(days => 1);
	}

	my $month_end = $month_start->clone();
	$month_end->add(months => 1);

	my $month_ref = ({
		start     => DateTime::Format::MySQL->format_datetime($week_start),
		end       => DateTime::Format::MySQL->format_datetime($week_end),
		groupName => "Tabroom: Monthly Contacts",
		groupId   => 56011226
	});

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			person.email, person.phone, person.provider
		from person, permission, tourn
			where tourn.start  >= ?
			and tourn.start <= ?
			and tourn.id = permission.tourn
			and permission.tag IN ('owner', 'contact')
			and permission.person = person.id
			and person.no_email != 1
	");

	foreach my $ref ($week_ref, $month_ref) {
		$sth->execute($ref->{"start"}, $ref->{"end"});

		my $results = $sth->fetchall_hash();

		delete $ref->{'start'};
		delete $ref->{'end'};

		my %done;

		foreach my $person (@{$results}) {

			unless ($done{$person->{'email'}}++) {
				my $mail = ({email => $person->{"email"}});
				push @{$ref->{"members"}}, $mail;
			}

			if ($ref->{"phone"} && $person->{'phone'} && $person->{"provider"}) {
				unless ($done{$person->{"phone"}}++) {
					my $mail = ({email => $person->{"phone"}.'@'.$person->{"provider"}});
					push @{$ref->{"members"}}, $mail;
				}
			}
		}

		delete $ref->{"phone"};

		my ($results_hash, $raw) = $m->comp(
			"api_client.mas",
			path     => "/emma/groups",
			post_ref => JSON::encode_json($ref)
		);

		$m->print("<code>");
		$m->print($raw);
		$m->print("<code>");
		$m->flush_buffer();
	}

	$m->print('</div>');

</%init>
