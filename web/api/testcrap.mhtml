<%init>

##Still gotta play with this a little bit, but it reads a table from the database and coverts it to a json object
#the code below works, it should be modified to receive the table name as input and iterate through all the fields in the hash
#without knowing their names in advance.

use strict;
use warnings;
use Data::Dumper; 
binmode STDOUT, ":utf8";
use utf8;
use DateTime;
use Time::HiRes qw( time );
my $start = time(); 

my $dbh = Tab::DBI->db_Main();
use JSON;

#my $sth = $dbh->prepare("
#	select * from school
#	where tourn = 4278
#");

		Tab::School->set_sql( allschools => "
			select *
			from school
			where tourn=4278
		");

		my @schools= Tab::School->search_allschools();
		
#my @schools = $sth->execute();
print scalar(@schools)." schools<br>";

my %data;
foreach my $school (@schools) {
	#print $school->name."<br>";
	$data{$school->id}{'id'} = $school->id;
	$data{$school->id}{'name'} = $school->name;
}

my $json_str = encode_json(\%data);  # This will work now
print "$json_str";

#my $json = encode_json \@schools;
#print "$json\n";

#my $data = decode_json($json);
</%init>		