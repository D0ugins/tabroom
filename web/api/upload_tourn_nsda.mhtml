<%args>
	$username   => undef
	$password   => undef
	$debug      => undef
	$no_prefs   => undef
	$account_id => undef
	$session_id => undef
</%args>
<%init>

	undef $debug if $Tab::hostname eq "www.tabroom.com";
	
	use XML::Simple;
	use Crypt::PasswdMD5;
	use Data::Dumper;

	my $now = DateTime->now;
	my $account;

	if ($account_id && $session_id) { 

		$account = Tab::Account->retrieve($account_id);
		my $session = Tab::Session->retrieve($session_id);

		unless ($session->account->id == $account_id) { 
			$m->print("ACCOUNT_NOT_AUTHENTICATED");
			$m->abort;
		}
	}

	my $login;

	unless ($debug || $account) { 

		#ACCOUNT
		($login) = Tab::Login->search( username => lc($username) );
		unless ($login) { 
			$m->print("NO_SUCH_ACCOUNT");
			$m->abort;
		}

		$password =~ s/\s+$//g;
		my $db_password = $login->password;
		my $verify_password = unix_md5_crypt($password,$db_password);
	   
		unless ($verify_password eq $db_password) { 
			$m->print("PASSWORD_WRONG");
			$m->abort;
		}

		$account = $login->person;
	}

	#PROCESS THE XML

	my $xml = new XML::Simple ( SuppressEmpty => 1,  ForceArray => [ qw(EVENT EVENT_SETTING TOURN_SETTING SCHOOL REGION) ]); 
	my $data;

	if ($debug) { 

		$data = $xml->XMLin("/tmp/DataTest.xml");

	} else { 

		eval{ 
			my $req = Apache2::Request->new($r);
			my @xml_handles = $r->upload;
			my $xml_file = $req->upload($xml_handles[0]);
			my $xml_filename = $xml_file->tempname;

			my $epoch = $now->epoch;
			
			system "/bin/mkdir -p ".$Tab::file_root."tmp/$epoch";

			if ($session_id) { 
				system "mv $xml_filename ".$Tab::file_root."tmp/$epoch/TourneyData.xml";
			} else { 
				system "mv $xml_filename ".$Tab::file_root."tmp/$epoch/me.zip";
				system "cd ".$Tab::file_root."tmp/$epoch/; /usr/bin/unzip ".$Tab::file_root."tmp/$epoch/me.zip";
			}

			$data = $xml->XMLin($Tab::file_root."tmp/$epoch/TourneyData.xml"); 
		};

		$m->abort unless $data;

	}

	unless ($account) { 
		$m->print("Error: you are not logged in");
		$m->abort;
	}

	$m->print("Upload successful");
	
</%init>
