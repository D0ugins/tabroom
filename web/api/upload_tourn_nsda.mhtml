<%args>
	$username   => undef
	$password   => undef
	$debug      => undef
	$no_prefs   => undef
	$session_id => undef
</%args>
<%init>

	undef $debug if $Tab::hostname eq "www.tabroom.com";
	
	use XML::Simple;
	use Crypt::PasswdMD5;
	use Data::Dumper;

	my $now = DateTime->now;

	my ($person, $tourn, $session) = $m->comp("login_api.mas", 
		tourn_id   => $tourn_id,
		username   => $username,
		password   => $password,
		session_id => $session_id
	); 

	#PROCESS THE XML

	my $xml = new XML::Simple ( 
		SuppressEmpty => 1,  
		ForceArray => [ qw(EVENT EVENT_SETTING TOURN_SETTING SCHOOL REGION) ]
	); 
	my $data;

	if ($debug) { 

		$data = $xml->XMLin("/tmp/DataTest.xml");

	} else { 

		eval{ 
			my $req = Apache2::Request->new($r);
			my @xml_handles = $r->upload;
			my $xml_file = $req->upload($xml_handles[0]);
			my $xml_filename = $xml_file->tempname;

			my $epoch = $now->epoch;
			
			system "/bin/mkdir -p ".$Tab::file_root."tmp/$epoch";

			if ($session_id) { 
				system "mv $xml_filename ".$Tab::file_root."tmp/$epoch/TourneyData.xml";
			} else { 
				system "mv $xml_filename ".$Tab::file_root."tmp/$epoch/me.zip";
				system "cd ".$Tab::file_root."tmp/$epoch/; /usr/bin/unzip ".$Tab::file_root."tmp/$epoch/me.zip";
			}

			$data = $xml->XMLin($Tab::file_root."tmp/$epoch/TourneyData.xml"); 
		};

		$m->abort unless $data;

	}

	unless ($person) { 
		$m->print("Error: you are not logged in");
		$m->abort;
	}

	$m->print("Upload successful");
	
</%init>
