<%args>

</%args>
<%init>


	Tab::Person->set_sql( diamonds => "
		select person.*
		from entry_setting coach_points, entry, event, tourn_setting, person
		where event.tourn = tourn_setting.tourn
			and tourn_setting.tag = 'nsda_nats'
			and event.id = entry.event
			and entry.active = 1
			and entry.id = coach_points.entry
			and coach_points.tag = 'coach_points'
			and coach_points.value = person.nsda

			and  exists (
				select person.id from person
				where person.nsda = coach_points.value
			)
	");


	$m->clear_buffer();

	$m->print("<h4>Giving these people diamonds.</h4>");

	my $counter;

	foreach my $person (Tab::Person->search_diamonds()) {

		my ($degree, $diamonds, $honors) = $m->comp(
			"/funclib/nsda/member_honors.mas",
			nsda_id => $person->nsda
		);

		if ($diamonds) {
			$person->setting("diamonds", $diamonds);
		} else {
			$person->setting("diamonds", 0);
		}

		unless ($counter++ % 100) {

			$m->print("<p>");
			$m->print($person->email." has $diamonds diamonds");
			$m->print("</p>");
			$m->flush_buffer();
		}
	}

</%init>
