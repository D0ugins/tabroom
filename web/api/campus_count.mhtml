<%args>
	$date => undef
</%args>
<%init>

	my $now = DateTime->now();

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("

        select
            tourn.id, nsda_campus_purchased.value, nsda_campus_days.value_text,
            CONVERT_TZ(tourn.start, '+00:00', tourn.tz)

        from (tourn, tourn_setting nsda_campus_purchased)
			left join tourn_setting nsda_campus_days
				on tourn.id = nsda_campus_days.tourn
				and nsda_campus_days.tag = 'nsda_campus_days'

            where tourn.start < (CURDATE() + INTERVAL 1 DAY)
            and tourn.end > (CURDATE())

            and tourn.id = nsda_campus_purchased.tourn
            and nsda_campus_purchased.tag = 'nsda_campus_purchased'


	");

	$sth->execute();

	my $today;
	my $total;
	my $count;

	while (
		my (
			$tourn_id, $purchased, $day_json, $start
		)  = $sth->fetchrow_array()
	) {

		my $dt = DateTime::Format::MySQL->parse_datetime($start);

		my $daycount = 1;

		while ($dt->day != $now->day) {
			$dt->add(days => 1);
			$daycount++;
		}

		my $days = eval{
			return JSON::decode_json($day_json);
		};

		$count++;
		$today += $days->{$daycount}{"count"};
		$total += $purchased;

	}

	my $output = ({
		tournaments => $count,
		today       => $today,
		purchased   => $total,
	});

	$m->clear_buffer();
	$r->content_type('application/json');
	$m->print(JSON::encode_json($output));
	$m->abort();

</%init>


