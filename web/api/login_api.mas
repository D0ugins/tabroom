<%args>
	$username   => undef
	$password   => undef
	$tourn_id   => undef
	$session_id => undef
	$person_id  => undef
</%args>
<%init>


	my ($person, $session) = $m->comp("/user/login/authenticate.mas");

	if ($person_id) {
		$person = Tab::Person->retrieve($person_id);
	}

	unless ($person) {

		my $login = Tab::Login->search(
			username => lc($username)
		)->first;

		unless ($ARGS{"skip_abort"} || $login) {
			$m->print("<error>No login with the username ".$username." was found.</error>");
			$m->abort;
		} elsif (not defined $login) {
			return;
		}

		$password =~ s/\s+$//g;

        my $db_sha_crypt = $login->sha512;
        my $sha_crypt = crypt($password, $db_sha_crypt) if $db_sha_crypt;
        my $login_ok;

        if ($sha_crypt && ($sha_crypt eq $db_sha_crypt)) {
            $login_ok++;
        } else {

			unless ($ARGS{"skip_abort"}) {
				$m->print("<error>Password incorrect for ".$username.".</error>");
				$m->abort;
			} else {
				return;
			}
		}
		$person =  $login->person;
	}

	if ($session) {
		my $defaults = $session->default();
		$tourn_id = $defaults->{tourn};
	}

	my $tourn;
	$tourn = Tab::Tourn->retrieve($tourn_id) if $tourn_id;

	unless ($tourn || $ARGS{"skip_abort"}) {
		$m->print("NO_SUCH_TOURNAMENT");
		$m->abort;
	} elsif ($tourn) {
	} else {
		return;
	}

	my %perms = $person->all_permissions($tourn);

	unless ($perms{"owner"}
		|| $perms{"full_admin"}
		|| $perms{"tabbing"}
		|| $perms{"details"}
	) {
		return if $ARGS{"skip_abort"};
		$m->print("You do not have access to that tournament.");
		$m->abort;
	}

	return $person, $tourn, $session, \%perms;

</%init>

