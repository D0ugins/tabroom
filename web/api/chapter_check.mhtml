<%args>


</%args>
<%init>

	use utf8;

	$m->clear_buffer;

	use Encode qw(decode encode);
	use Data::Dumper;

	$m->print("<h4>Checking chapters</h4>");
	$m->flush_buffer();

	my $counter;

	foreach my $chapter (Tab::Chapter->retrieve_all) { 
		my $name = $chapter->name;
		object_test($chapter, $name);
	}

	$m->print("<h4>Checking students</h4>");
	$m->flush_buffer();

	foreach my $student (Tab::Student->retrieve_all()) { 

		my $first = $student->first;
		chomp $first;
		my $name = $first." ".$student->last;
		object_test($student, $name);
	}

	$m->print("<h4>Checking schools</h4>");
	$m->flush_buffer();
	foreach my $school (Tab::School->retrieve_all) { 
		my $name = $school->name;
		object_test($school, $name);
	}

	$m->print("<h4>Checking judges</h4>");
	$m->flush_buffer();
	foreach my $cjudge (Tab::ChapterJudge->retrieve_all) { 
		my $first = $cjudge->first;
		chomp $first;
		my $name = $first." ".$cjudge->last;
		object_test($cjudge, $name);
	}

	sub object_test { 

		my ($object, $condition) = @_;

		chomp $condition;

		my $first_pass = $condition;
		$first_pass =~ tr/\000-\037/ /;

		my $decoded_condition = encode('iso-8859-1', $first_pass);

		my $reencoded_condition = encode('utf8', $decoded_condition, Encode::FB_HTMLCREF);

		my $second_coded_condition = encode('utf8', $condition, Encode::FB_HTMLCREF);

		return if $condition eq $decoded_condition;

		$m->print("deleting $object ".ref($object));
		$m->print(" <br/> Raw: ");
		$m->print(substr($first_pass,0,32));
		$m->print(" <br/> Decoded: ");
		$m->print(substr($decoded_condition,0,32));
		$m->print("<br /><br />");
		$m->flush_buffer();

		$object->delete();

		return;

	}

</%init>
