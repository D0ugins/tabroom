<%init>

	Tab::Category->columns( TEMP => 'tournname');

	Tab::Category->set_sql( future_district => "
		select category.*, tourn.name as tournname
		from category, tourn

		where tourn.start > NOW()
		and tourn.id = category.tourn
		and exists (
			select ts.id from tourn_setting ts
			where ts.tag = 'nsda_district'
			and ts.tourn = tourn.id
		)
		and exists (
			select event.id
			from event
			where event.type = 'congress'
			and event.category = category.id
		)
	");

	foreach my $cat (Tab::Category->search_future_district() ) {

		$m->print("<p>Setting for ".$cat->abbr." at ".$cat->tournname."</p>");
		$m->flush_buffer();

		$cat->setting("online_registration_notice",
			"text",
			"Warning: judges affiliated with competing schools may not judge the district Congress"
		);
	}

	Tab::EventSetting->set_sql( rm_school_cap => "
	    delete es.*
			from event_setting es, event, tourn
		where tourn.end > NOW()
			and tourn.id = event.tourn
			and event.abbr = 'BQ'
			and es.tag = 'school_cap'
			and es.event = event.id
			and exists (
				select ts.id from tourn_setting ts
				where ts.tag = 'nsda_district'
				and ts.tourn = tourn.id
			)
	");

	Tab::EventSetting->sql_rm_school_cap->execute();

	Tab::EventSetting->set_sql( chamber_sizes => "
		update event_setting es, event, tourn
			set es.value = 16
		where tourn.end > NOW()
			and tourn.id = event.tourn
			and event.type = 'congress'
			and es.tag = 'max_panel_size'
			and es.event = event.id
			and exists (
				select ts.id from tourn_setting ts
				where ts.tag = 'nsda_district'
				and ts.tourn = tourn.id
			)
			and exists (
				select es.id from event_setting es
				where es.tag = 'online_mode'
				and es.event = event.id
				and es.value != 'none'
			)
	");

	Tab::EventSetting->sql_chamber_sizes->execute();
</%init>
