<%args>
	$school_id
	$person
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);

	my $tourn = $school->tourn;

	my %aff_labels;
	my %neg_labels;

	foreach my $event ($m->comp("/funclib/school_events.mas", school => $school)) { 

		$aff_labels{$event->id} = $event->setting('aff_label');
		$neg_labels{$event->id} = $event->setting('neg_label');

		$aff_labels{$event->id} = "Aff" unless $aff_labels{$event->id};
		$neg_labels{$event->id} = "Neg" unless $neg_labels{$event->id};

	}

    my $scrubber = HTML::Scrubber->new( allow => [ qw[ p strong b i u hr br ol ul li] ] );

	my $deadline = DateTime->now;
	$deadline->add(hours => 24);

	my $past++ if $deadline > $school->tourn->end;


</%init>

	<& "menu.mas", 
		school => $school,
		whoami => "ballots" 
	&>

	<script>
		
		function toggleBallots(entryID) { 

			$("#"+entryID).slideToggle('fast', function() { 
				$("#"+entryID).toggleClass("hidden");
			});

			$("#button_"+entryID).toggleClass("fa-eye");
			$("#button_"+entryID).toggleClass("fa-eye-slash");
			$("#button_"+entryID).toggleClass("redtext");
			$("#button_"+entryID).toggleClass("bluetext");

		}

	</script>

	<div class="main">

		<h2><% $school->chapter->name %>: Results</h2>

		<& 
			"/user/chapter/tabbar.mas", 
				chapter => $school->chapter,
				person  => $person,
				whoami  => "results" 
		&>

		<h3 class="normalweight centeralign padtopmore">
			<% $tourn->name %>
		</h3>

		<h4>Individual Ballots</h4>

<%perl>

		foreach my $entry (sort {$a->event->abbr cmp $b->event->abbr} $school->entries) {

			my $event = $entry->event;

			my @ballots = $m->comp(
				"/funclib/entry_ballots.mas", 
				entry     => $entry,
				published => 1,
				coach     => 1
			);

</%perl>

			<div class="full marno padless martop odd">

				<span class="twofifth nospace">
					<h5 class="semibold"><% $entry->code %></h5>
				</span>
				
				<span class="twofifth nospace">
					<h6 class="normalweight"><% $entry->name %></h6>
				</span>

				<span class="tenth">
					<h6 class="normalweight"><% $entry->event->abbr %></h6>
				</span>

				<span class="tenth">
					<a 
						class   = "fa fa-large buttonwhite bluetext fa-eye"
						id      = "button_<% $entry->id %>"
						onClick = "toggleBallots('<% $entry->id %>');"
					></a>
				</span>

			</div>

			<div 
				id    = "<% $entry->id %>"
				class = "marleftmore full hidden borderleft"
			>

			<div>

<%perl>

			my $current_round;
			my $opponent;

			BALLOT:
			foreach my $ballot (@ballots) { 

				my $panel = $ballot->panel;
				my $judge = $ballot->judge;
				my $round = $ballot->panel->round;
				my @scores = $ballot->scores; 

				my %round_settings = $round->all_settings();

				my %score_types = map {$_->tag => 1} @scores;

				unless ($round->post_results > 0
					|| $round_settings{"coach_wins"}
					|| $round_settings{"coach_points"}
					|| $round_settings{"coach_feedback"}
				) { 
					next BALLOT;
				}

				my $subscores;

				foreach my $type (keys %score_types) {
					$subscores++ if substr($type, 0, 9) eq "subpoints";
				}

</%perl>

%				unless ($current_round == $round->id) { 

					</div>

					<div class="row">

					<div class="full nospace martop">

						<span class="quarter">
							<h6 class="semibold">
								<% $round->realname %>
							</h6>
						</span>

%						$current_round = $round->id;

%						if ($event->type ne "speech" && $event->type ne "congress") { 

							<span class="threequarters rightalign">

								<h6 class="semibold">
									<% $ballot->side == 1 ? $aff_labels{$event->id} : $neg_labels{$event->id} %>

%									foreach my $other ($m->comp("/funclib/panel_entries.mas", panel => $panel)) { 
%										next if $entry->id == $other->id;
										vs. <% $other->code %> 
%									}
								</h6>
							</span>
%						}

					</div>
%				}

					<div class="full marno">

						<div class="full marless padno borderbottom">

%							if ($panel->bye) { 

								<h6 class="normal">Bye Round</h6>

%							} elsif ($ballot->bye) { 

								<h6 class="normal">
								<% $entry->code %> bye</h6>

%							} elsif ($ballot->forfeit) { 

								<h6 class="normal">
								<% $entry->code %> forfeits</h6>

%							} else { 

								<span class="third">

									<h6 class="normal">
										Judge <% $judge->first %> <% $judge->last %>
									</h6>
								</span>

								<span class="eighth strong">
%									if ($round_settings{"coach_wins"} || $round->post_results) {
%										foreach my $score (@scores) { 
%											if ($score->tag eq "ballot") { 
												<% $score->value ? "WIN" : "LOSS" %> 
%											}
%										}
%									}
								</span>

%								if ($score_types{"points"} || $score_types{"rank"}) {

%									my %done;

									<span class="fifth nospace">

<%perl>
										foreach my $score (@scores) { 

											next unless $score->tag eq "rank" 
												|| $score->tag eq "points";

											next if 
												$score->tag eq "points"
												&& $round->post_results < 2
												&& (not defined $round_settings{"coach_points"})
											;

											next unless
												$score->tag ne "ranks"
												|| $round->post_results > 1
												|| $round_settings{'coach_points'}
												|| ($event->type eq "speech" && $round_settings{'coach_wins'})
												|| ($event->type eq "congress" && $round_settings{'coach_wins'})
											;


											if ($score->student) { 
</%perl>

%												next if $done{$score->student->id}++;

												<div class="full nowrap marno padless">
													<% $score->student->first." ".$score->student->last %>:
												</div>

%											}

%										}

									</span>
%								}

%								foreach my $type ("rank", "points", "rebuttal_points") { 

%									if ($score_types{$type}) { 

										<span class="eighth nospace">

%										foreach my $score (@scores) { 

<%perl>
											next unless $score->tag eq "rank" 
												|| $score->tag eq "points";

											next if 
												$score->tag eq "points"
												&& $round->post_results < 2
												&& (not defined $round_settings{"coach_points"})
											;

											next unless
												$score->tag ne "ranks"
												|| $round->post_results > 1
												|| $round_settings{'coach_points'}
												|| ($event->type eq "speech" && $round_settings{'coach_wins'})
												|| ($event->type eq "congress" && $round_settings{'coach_wins'})
											;

</%perl>

%											if ($score->tag eq $type) { 

												<div class="full nowrap marno padless">
													<% $type eq "rebuttal_points" ? "Reply" : "" %>
													<% $score->value %> 
												</div>
%											}

%										}

										</span>
%									}

%								}

%							}
		
						</div>

<%perl>
						if ($subscores 
							&& ( $round->post_results > 1 
								|| $round_settings{"coach_points"}
							) 
						) { 

							foreach my $student ($entry->students) { 
</%perl>

								<div class="full rightalign nospace">

									<span class="quarter nowrap">
										<% $student->first %> <% $student->last %>:
									</span>
<%perl>

									foreach my $score (@scores) { 

										next unless $score->student 
											&& $score->student->id == $student->id;

										next unless substr($score->tag, 0, 9) 
											eq "subpoints";

</%perl>

										<span class="sixth">
											<% ucfirst($score->content) %>:
										</span>

										<span class="twentieth">
											<% $score->value %>
										</span>
%									}

								</div>

%							}

%						}

<%perl>

					foreach my $score (@scores) { 

						next unless $score->content;

						next if $score->tag eq "points";
						next if $score->tag eq "ballot";
						next if $score->tag eq "rebuttal_points";
						next if $score->tag eq "rank";

						next if substr($score->tag,0,9) eq "subpoints";

						next unless (
							$round->post_results > 0 
							|| $round_settings{"coach_feedback"}
						);

						$score->content($scrubber->scrub($score->content));
						$score->update;
</%perl>

						<div class="padless marno bordertop">

							<span class="fifth">
								<% ucfirst($score->tag) %>
								<% $score->student ? "<br /> ".$score->student->last : "" %>
							</span>
							<span class="fourfifths">
								<% $score->content %>
							</span>
						</div>

%					}

				</div>


%			}

			</div>
			</div>

%		}

	</div>


