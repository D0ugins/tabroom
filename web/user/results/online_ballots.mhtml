<%args>
	$school_id
	$person
</%args>
<%init>

	use Compress::Zlib;

	my $school = Tab::School->retrieve($school_id);

	my $tourn = $school->tourn;

	my %aff_labels;
	my %neg_labels;

	foreach my $event ($m->comp("/funclib/school_events.mas", school => $school)) {

		$aff_labels{$event->id} = $event->setting('aff_label');
		$neg_labels{$event->id} = $event->setting('neg_label');

		$aff_labels{$event->id} = "Aff" unless $aff_labels{$event->id};
		$neg_labels{$event->id} = "Neg" unless $neg_labels{$event->id};

	}

	my $deadline = DateTime->now;
	$deadline->add(hours => 24);

	my $past++ if $deadline > $school->tourn->end;

</%init>

	<& "menu.mas",
		school => $school,
		whoami => "ballots"
	&>

	<script>

		function toggleBallots(entryID) {

			$("#"+entryID).slideToggle('fast', function() {
				$("#"+entryID).toggleClass("hidden");
			});

			$("#button_"+entryID).toggleClass("fa-eye");
			$("#button_"+entryID).toggleClass("fa-eye-slash");
			$("#button_"+entryID).toggleClass("redtext");
			$("#button_"+entryID).toggleClass("bluetext");
		}

	</script>

	<div class="main">

		<h2><% $school->chapter->name %>: Results</h2>

		<&
			"/user/chapter/tabbar.mas",
				chapter => $school->chapter,
				person  => $person,
				whoami  => "results"
		&>

		<h3 class="normalweight centeralign padtopmore">
			<% $tourn->name %>
		</h3>

		<h4>Individual Ballots</h4>

<%perl>

		my @entries = $school->entries( unconfirmed => 0 );

		if ($tourn->setting("nsda_nats")) {
			Tab::Entry->set_sql( friggin_wsdc => "
				select entry.*
				from entry, entry_student es, student, event, event_setting usa_wsdc
				where event.tourn = ?
					and event.id = entry.event
					and event.id = usa_wsdc.event
					and usa_wsdc.tag = 'usa_wsdc'
					and entry.unconfirmed = 0
					and entry.id = es.entry
					and es.student = student.id
					and student.chapter = ?
				group by entry.id
			");

			push @entries, Tab::Entry->search_friggin_wsdc($tourn->id, $school->chapter->id);
		}

		foreach my $entry (
			sort {$a->event->abbr cmp $b->event->abbr} @entries
		) {

			my $event = $entry->event;

			my @ballots = $m->comp( "/funclib/entry_ballots.mas",
				entry      => $entry,
				post_level => 1
			);

			next unless @ballots;

</%perl>

			<div class="full marno padless martop odd">

				<span class="twofifth nospace">
					<h5 class="semibold"><% $entry->code %></h5>
				</span>

				<span class="twofifth nospace">
					<h6 class="normalweight"><% $entry->name %></h6>
				</span>

				<span class="tenth">
					<h6 class="normalweight"><% $entry->event->abbr %></h6>
				</span>

				<span class="tenth">
					<a
						class   = "fa fa-large buttonwhite bluetext fa-eye"
						id      = "button_<% $entry->id %>"
						onClick = "toggleBallots('<% $entry->id %>');"
					></a>
				</span>

			</div>

			<div
				id    = "<% $entry->id %>"
				class = "marleftmore full hidden borderleft"
			>

			<div>

<%perl>

			my $current_round;
			my $opponent;

			BALLOT:
			foreach my $ballot (@ballots) {

				my $panel = $ballot->panel;
				my $judge = $ballot->judge;
				my $round = $ballot->panel->round;
				my @scores = $ballot->scores;

				next unless @scores;

				my %round_settings = $round->all_settings();

				my %score_types = map {$_->tag => $_} @scores;

				unless ($round->post_results > 0
					|| $round_settings{"coach_wins"} > 0
					|| $round_settings{"public_feedback"} > 0
					|| $round_settings{"coach_points"} > 0
					|| $round_settings{"coach_feedback"} > 0
				) {
					next BALLOT;
				}

				my $subscores;

				foreach my $type (keys %score_types) {
					$subscores++ if substr($type, 0, 9) eq "subpoints";
				}

				unless ($current_round == $round->id) {
</%perl>

					</div>

					<div class="row">

					<div class="full nospace martop">

						<span class="quarter">
							<h6 class="semibold">
								<% $round->realname %>
							</h6>
						</span>

%						$current_round = $round->id;

%						if ($event->type ne "speech" && $event->type ne "congress") {

							<span class="threequarters rightalign">

								<h6 class="semibold">
									<% $ballot->side == 1 ? $aff_labels{$event->id} : $neg_labels{$event->id} %>

%									foreach my $other ($m->comp("/funclib/panel_entries.mas", panel => $panel)) {
%										next if $entry->id == $other->id;
										vs. <% $other->code %>
%									}
								</h6>
							</span>
%						}

					</div>
%				}

					<div class="full marno">

						<div class="full marless padno borderbottom">
%							if ($panel->bye) {

								<h6 class="normal">Bye Round</h6>

%							} elsif ($ballot->bye) {

								<h6 class="normal">
								<% $entry->code %> is awarded the bye</h6>

%							} elsif ($ballot->forfeit) {

								<h6 class="normal">
								<% $entry->code %> forfeits</h6>

%							} else {

								<span class="third">
									<p class="redtext semibold bigger">
										<% $event->type eq "congress" && $ballot->chair ? "Parliamentarian" : "Judge" %>
										<% $judge->first %> <% $judge->last %>
									</p>
								</span>

								<span class="eighth bluetext semibold">
%									if ($round_settings{"coach_wins"} || $round->post_results) {
%										if ($score_types{"winloss"}) {
											<% $score_types{"winloss"}->value ? "WIN" : "LOSS" %>
%										}
%									}
								</span>

%								if ($score_types{"point"} || $score_types{"rank"}) {
%									my %done;

									<span class="fifth nospace">
<%perl>
										foreach my $score (@scores) {

											next unless $score->tag eq "rank"
												|| $score->tag eq "point"
												|| $score->tag eq "refute";

											next if
												$score->tag eq "point"
												&& $round->post_results < 2
												&& (not defined $round_settings{"coach_points"})
											;

											next unless
												$score->tag ne "rank"
												|| $round->post_results > 1
												|| $round_settings{'coach_points'}
												|| ($event->type eq "speech" && $round_settings{'coach_wins'})
												|| ($event->type eq "congress" && $round_settings{'coach_wins'})
											;

											if ($score->student) {

												next if $done{$score->student->id}++;
</%perl>
												<div class="full nowrap marno padless">
													<% $score->student->first." ".$score->student->last %>:
												</div>
%											}
%										}

									</span>
%								}

%								foreach my $type ("rank", "point", "refute") {
%									if ($score_types{$type}) {

										<span class="eighth nospace">
<%perl>
										foreach my $score (@scores) {
											next unless $score->tag eq "rank"
												|| $score->tag eq "point"
												|| $score->tag eq "refute";

											next if
												$score->tag eq "point"
												&& $round->post_results < 2
												&& (not defined $round_settings{"coach_points"})
											;

											next unless
												$score->tag ne "rank"
												|| $round->post_results > 1
												|| $round_settings{'coach_points'}
												|| ($event->type eq "speech" && $round_settings{'coach_wins'})
												|| ($event->type eq "congress" && $round_settings{'coach_wins'})
											;

											if ($score->tag eq $type) {
</%perl>
												<div class="full nowrap marno padless">
													<% $type eq "refute" ? "Reply" : "" %>
													<% $type eq "rank" ? "Rank" : "" %>
													<% $score->value %>
													<% $type eq "point" ? "Pts" : "" %>
												</div>
%											}
%										}
										</span>
%									}
%								}
%							}
						</div>

<%perl>
						if ($subscores
							&& ( $round->post_results > 1
								|| $round_settings{"coach_points"}
							)
						) {

							foreach my $student ($entry->students) {

								my $categories;

								foreach my $score (@scores) {
									next unless $score->tag eq "subpoints";
									next if $score->student != $student->id;
									$categories = JSON::decode_json($score->content);
									last;
								}

								next unless $categories;
</%perl>
								<div class="full leftalign nospace ltborderbottom">
									<span class="fifth">
										<span class="spacer"></span>
										<% $student->first %> <% $student->last %>:
									</span>
									<span class="twothirds padvertless">
%										foreach my $key (sort {$b cmp $a} keys %{$categories}) {
											<div class="full nospace">
												<span class="quarter semibold bluetext padvertless">
													<% ucfirst($key) %>
													<% $categories->{$key}{"position"} %>:
												</span>
												<span class="threequarters nospace">
%													foreach my $type (sort {$a cmp $b} keys %{$categories->{$key}}) {
%														next if $type eq "position";
														<span class="third nospace">
															<span class="twothirds semibold padvertless">
																<% ucfirst($type) %>
															</span>
															<span class="third padvertless">
																<% $categories->{$key}{$type} %>
															</span>
														</span>
%													}
												</span>
											</div>
%										}
									</span>
								</div>
<%perl>
							}
						}

					foreach my $score (sort {$a->tag cmp $b->tag} @scores) {

						next unless $score->content;
						next if $score->tag eq "subpoints";
						next if $score->tag eq "categories";
						next if $score->tag eq "title";

						next unless (
							$round->post_results > 1
							|| $round_settings{"coach_feedback"}
							|| $round_settings{"public_feedback"}
						);
</%perl>
						<div class="padless marno bordertop">
							<span class="fifth semibold bluetext">
								<% uc($score->tag) %>
								<% $score->speech ? "&num;".$score->speech : "" %>
								<% $score->student ? "<br /> ".$score->student->last : "" %>
								<% $score->value ? "<br />".$score->value. " pts" : "" %>
							</span>
							<span class="fourfifths ltborderleft">
%								if ($score->topic) {
									<div class="padvertless odd">
										<span class="eighth semibold bluetext">
											Topic:
										</span>
										<span class="half">
											<% $score->topic %>
										</span>
										<span class="quarter semibold orangetext">
											<% $score->position == 1 ? "FOR" : ""%>
											<% $score->position == 2 ? "AGAINST" : ""%>
										</span>
									</div>
%								}
								<% Tab::Score::uncompress($score->content) %>
							</span>
						</div>

%					}

				</div>
%			}

			</div>
			</div>

%		}
	</div>

