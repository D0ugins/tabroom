<%args>
	$school_id
	$person
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);

	my %aff_strings;
	my %neg_strings;

	foreach my $event ($m->comp("/funclib/school_events.mas", school => $school)) { 

		$aff_strings{$event->id} = $event->setting('aff_string');
		$neg_strings{$event->id} = $event->setting('neg_string');

		$aff_strings{$event->id} = "Aff" unless $aff_strings{$event->id};
		$neg_strings{$event->id} = "Neg" unless $neg_strings{$event->id};

	}

    my $scrubber = HTML::Scrubber->new( allow => [ qw[ p strong b i u hr br ol ul li] ] );


</%init>

	<& "menu.mas", 
		school => $school,
		whoami => "ballots" 
	&>

	<div class="main">

		<h2><% $school->chapter->name %>: Results</h2>

		<& 
			"/user/chapter/tabbar.mas", 
				chapter => $school->chapter,
				person  => $person,
				whoami  => "results" 
		&>

		<h4>Individual Ballots</h4>

			

<%perl>

		foreach my $entry ($school->entries) {

			my $event = $entry->event;

			my @ballots = $m->comp(
				"/funclib/entry_ballots.mas", 
				entry     => $entry,
				published => 1
			);

</%perl>

			<div class="full marno padless blue martopmore ">

				<span class="twofifth">
					<h5><% $entry->code %></h5>
				</span>
				
				<span class="twofifth">
					<h5><% $entry->name %></h5>
				</span>

				<span class="fifth">
				</span>

			</div>

<%perl>

			my $current_round;
			my $opponent;

			foreach my $ballot (@ballots) { 

				my $panel = $ballot->panel;
				my $judge = $ballot->judge;
				my $round = $ballot->panel->round;
				my @scores = $ballot->scores; 

				my %score_types = map {$_->tag => 1} @scores;

				next if $round->post_results < 1;

				my $subscores;

				foreach my $type (keys %score_types) {
					$subscores++ if substr($type, 0, 9) eq "subpoints";
				}


</%perl>

%				unless ($current_round == $round->id) { 

					<div class="full nospace yellowrow martop">

						<span class="quarter">
							<h6 class="normal">
								<% $round->realname %>
							</h6>
						</span>

%						$current_round = $round->id;

%						if ($event->type ne "speech" && $event->type ne "congress") { 

							<span class="threequarters rightalign">

								<h6 class="normal">
									<% $ballot->side == 1 ? $aff_strings{$event->id} : $neg_strings{$event->id} %>

%									foreach my $other ($m->comp("/funclib/panel_entries.mas", panel => $panel)) { 
%										next if $entry->id == $other->id;
										vs. <% $other->code %> 
%									}
								</h6>
							</span>
%						}

					</div>
%				}

					<div class="full row marno">

						<div class="full marless padno borderbottom">

%							if ($panel->bye) { 

								<h6 class="normal">Bye Round</h6>

%							} elsif ($ballot->bye) { 

								<h6 class="normal">
								<% $entry->code %> bye</h6>

%							} elsif ($ballot->forfeit) { 

								<h6 class="normal">
								<% $entry->code %> forfeits</h6>

%							} else { 

								<span class="third">

									<h6 class="normal">
										Judge <% $judge->first %> <% $judge->last %>
									</h6>
								</span>

								<span class="eighth strong">

%									foreach my $score (@scores) { 
%										if ($score->tag eq "ballot") { 
											<% $score->value ? "WIN" : "LOSS" %> 
%										}
%									}
								</span>

%								if ($score_types{"points"} || $score_types{"rank"}) {

%									my %done;

									<span class="fifth nospace">

%										foreach my $score (@scores) { 

%											next unless $score->tag eq "rank" || $score->tag eq "points";

%											if ($score->student) { 

%												next if $done{$score->student->id}++;

												<div class="full nowrap marno padless">
													<% $score->student->first." ".$score->student->last %>:
												</div>

%											}

%										}

									</span>
%								}

%								foreach my $type ("rank", "points", "rebuttal_points") { 

%									if ($score_types{$type}) { 

										<span class="eighth nospace">

%										foreach my $score (@scores) { 

%											if ($score->tag eq $type) { 

												<div class="full nowrap marno padless">
													<% $type eq "rebuttal_points" ? "Reply" : "" %>
													<% $score->value %> 
												</div>
%											}

%										}

										</span>
%									}

%								}

%							}
		
						</div>

%						if ($subscores) { 

%							foreach my $student ($entry->students) { 

								<div class="full rightalign nospace">

									<span class="quarter nowrap">
										<% $student->first %> <% $student->last %>:
									</span>
<%perl>

									foreach my $score (@scores) { 

										next unless $score->student 
											&& $score->student->id == $student->id;

										next unless substr($score->tag, 0, 9) 
											eq "subpoints";

</%perl>

										<span class="sixth">
											<% ucfirst($score->content) %>:
										</span>

										<span class="twentieth">
											<% $score->value %>
										</span>
%									}

								</div>

%							}

%						}



<%perl>

					foreach my $score (@scores) { 

						next unless $score->content;

						next if $score->tag eq "points";
						next if $score->tag eq "ballot";
						next if $score->tag eq "rebuttal_points";
						next if $score->tag eq "rank";

						next if substr($score->tag,0,9) eq "subpoints";

						$score->content($scrubber->scrub($score->content));
						$score->update;
</%perl>

						<div class="padless marno bordertop">

							<span class="fifth">
								<% ucfirst($score->tag) %>
								<% $score->id %>
								<% $score->student ? "<br /> ".$score->student->last : "" %>
							</span>
							<span class="fourfifths">
								<% $score->content %>
							</span>
						</div>

%					}

				</div>


%			}

%		}

	</div>


