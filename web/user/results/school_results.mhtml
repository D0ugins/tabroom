<%args>
	$school_id
	$person
	$person_settings
	$perms
</%args>
<%init>

	my $tourn = $school->tourn;
	my $school = Tab::School->retrieve($school_id);

</%init>

	<& "menu.mas",
		school => $school,
		whoami => "ballots"
	&>

	<script>
		function toggleBallots(entryID) {

			$("#"+entryID).slideToggle('fast', function() {
				$("#"+entryID).toggleClass("hidden");
			});

			$("#button_"+entryID).toggleClass("fa-eye");
			$("#button_"+entryID).toggleClass("fa-eye-slash");
			$("#button_"+entryID).toggleClass("redtext");
			$("#button_"+entryID).toggleClass("bluetext");
		}

	</script>

	<div class="main">

		<h4>Results from <% $tourn->name %></h4>

		<&
			"/user/chapter/tabbar.mas",
				chapter => $school->chapter,
				person  => $person,
				whoami  => "results"
		&>

		<h4>Individual Ballots</h4>

<%perl>

		my %results = $m->comp("/funclib/entry_results.mas", school => $school);

		foreach my $e_id ( 
			sort {
				$results{$a}{event_abbr} cmp $results{$a}{event_abbr}
				|| $results{$a}{code} cmp $results{$a}{code}
			} keys %results
		) {

</%perl>
			<div class="full marno padless martop odd">

				<span class="twofifth nospace">
					<h5 class="semibold"><% $results{$e_id}{"entry_code"} %></h5>
				</span>

				<span class="twofifth nospace">
					<h6 class="normalweight"><% $results{$e_id}{"entry_name"} %></h6>
				</span>

				<span class="tenth">
					<h6 class="normalweight"><% $results{$e_id}{"event_abbr"} %></h6>
				</span>

				<span class="tenth">
					<a
						class   = "fa fa-large buttonwhite bluetext fa-eye"
						id      = "button_<% $e_id %>"
						onClick = "toggleBallots('<% $e_id %>');"
					></a>
				</span>
			</div>

			<div
				id    = "<% $entry_id %>"
				class = "marleftmore full hidden borderleft"
			>
<%perl>
				foreach my $r_id (
					sort {
						 $results{$e_id}{round}{$a}{number} <=> $results{$e_id}{round}{$b}{number}
					} keys %{$results{$e_id}{round}}
				) {

					my $round = $results{$e_id}{"round"}{$_id};
</%perl>

					<div class="row full nospace martop">

						<span class="quarter padno">
							<h6 class="semibold padno">
								<% $round->{name} %>
							</h6>
						</span>

						<span class="threequarters rightalign padno">
							<h6 class="semibold padno">
%								if ($round->{side_name}) { 
									<span class="quarter">
										<% $round->{side_name} %>
									</span>
%								}

%								if ($round->{order}) { 
									<span class="quarter">
										<% $round->{order} %>
									</span>
%								}

%								if ($round->{position}) { 
									<span class="half">
										<% $round->{position} %>
									</span>
%								} elsif ($round->{opponent}) { 
									<span class="half">
										vs <% $round->{opponent} %>
									</span>
%								}
							</h6>
						</span>
					</div>
<%perl>
				}

				foreach my $b_id (
					sort {
						$round->{ballot}{$a}{"judge_last"} cmp $round->{ballot}{$b}{"judge_last"}
					} keys %{$round->{ballot}} 
				) {

					my $ballot = $round->{ballot}{$b_id};
</%perl>

					<div class="full marless padno borderbottom">

%						if ($round->{bye}) { 

							<h6 class="normal">
								Bye Round
							</h6>

%						} elsif ($round->{ballot}{$b_id}{"bye"}) { 

							<h6 class="normal">
								<% $results{$e_id}{"entry_code"} %> given a bye
							</h6>

%						} elsif ($round->{ballot}{$b_id}{"forfeit"}) { 

							<h6 class="normal">
								<% $results{$e_id}{"entry_code"} %> forfeits
							</h6>

%						} else {

							<span class="twofifths">
								<p class="redtext semibold bigger">
									<% $results{$e_id}{"event_abbr"} eq "congress" && $ballot->{"chair"}
										? "Parliamentarian" 
										: "Judge"
									%>
									<% $ballot->{judge_name} %>
								</p>
							</span>

							<span class="fifth centeralign">
%								if ($ballot->{by_type}{"winloss"}) { 
%									foreach my $s_id (keys %{$ballot->{by_type}{winloss}}) {
										<% $ballot->{score}{$s_id}{value} == 1 
											? '<span class="greentext semibold">WIN</span>'
											: ""
										%>
										<% $ballot->{score}{$s_id}{value} == 2 
											? '<span class="redtext semibold">LOSS</span>'
											: ""
										%>
%									}
%								} elsif ($ballot->{by_type}{"rank"}) { 
%									foreach my $s_id (keys %{$ballot->{by_type}{rank}}) {
										Rank <% $ballot->{score}{$s_id}{value} %>
%									}
%								}
							</span>

							<span class="fifth">
%								if ($ballot->{by_type}{"winloss"}) { 

%								} else { 

%								}
							</span>
%						}

					</div>



								<span class="eighth bluetext semibold">
%									if ($round_settings{"coach_wins"} || $round->post_results) {
%										if ($score_types{"winloss"}) { 
											<% $score_types{"winloss"}->value ? "WIN" : "LOSS" %>
%										}
%									}
								</span>

%								if ($score_types{"point"} || $score_types{"rank"}) {
%									my %done;

									<span class="fifth nospace">
<%perl>
										foreach my $score (@scores) {

											next unless $score->tag eq "rank"
												|| $score->tag eq "point"
												|| $score->tag eq "refute";

											next if
												$score->tag eq "point"
												&& $round->post_results < 2
												&& (not defined $round_settings{"coach_points"})
											;

											next unless
												$score->tag ne "rank"
												|| $round->post_results > 1
												|| $round_settings{'coach_points'}
												|| ($event->type eq "speech" && $round_settings{'coach_wins'})
												|| ($event->type eq "congress" && $round_settings{'coach_wins'})
											;

											if ($score->student) {

												next if $done{$score->student->id}++;
</%perl>
												<div class="full nowrap marno padless">
													<% $score->student->first." ".$score->student->last %>:
												</div>
%											}
%										}

									</span>
%								}

%								foreach my $type ("rank", "point", "refute") {
%									if ($score_types{$type}) {

										<span class="eighth nospace">
<%perl>
										foreach my $score (@scores) {
											next unless $score->tag eq "rank"
												|| $score->tag eq "point"
												|| $score->tag eq "refute";

											next if
												$score->tag eq "point"
												&& $round->post_results < 2
												&& (not defined $round_settings{"coach_points"})
											;

											next unless
												$score->tag ne "rank"
												|| $round->post_results > 1
												|| $round_settings{'coach_points'}
												|| ($event->type eq "speech" && $round_settings{'coach_wins'})
												|| ($event->type eq "congress" && $round_settings{'coach_wins'})
											;

											if ($score->tag eq $type) {
</%perl>
												<div class="full nowrap marno padless">
													<% $type eq "refute" ? "Reply" : "" %>
													<% $type eq "rank" ? "Rank" : "" %>
													<% $score->value %>
													<% $type eq "point" ? "Pts" : "" %>
												</div>
%											}
%										}
										</span>
%									}
%								}
%							}
						</div>

<%perl>
						if ($subscores
							&& ( $round->post_results > 1
								|| $round_settings{"coach_points"}
							)
						) {

							foreach my $student ($entry->students) {

								my $categories;

								foreach my $score (@scores) {
									next unless $score->tag eq "subpoints";
									next if $score->student != $student->id;
									$categories = JSON::decode_json($score->content);
									last;
								}

								next unless $categories;
</%perl>
								<div class="full leftalign nospace ltborderbottom">
									<span class="fifth">
										<span class="spacer"></span>
										<% $student->first %> <% $student->last %>:
									</span>
									<span class="twothirds padvertless">
%										foreach my $key (sort {$b cmp $a} keys %{$categories}) { 
											<div class="full nospace">
												<span class="quarter semibold bluetext padvertless">
													<% ucfirst($key) %>
													<% $categories->{$key}{"position"} %>:
												</span>
												<span class="threequarters nospace">
%													foreach my $type (sort {$a cmp $b} keys %{$categories->{$key}}) {
%														next if $type eq "position";
														<span class="third nospace">
															<span class="twothirds semibold padvertless">
																<% ucfirst($type) %>
															</span>
															<span class="third padvertless">
																<% $categories->{$key}{$type} %>
															</span>
														</span>
%													}
												</span>
											</div>
%										}
									</span>
								</div>
<%perl>
							}
						}

					foreach my $score (sort {$a->tag cmp $b->tag} @scores) {

						next unless $score->content;
						next if $score->tag eq "subpoints";
						next if $score->tag eq "categories";
						next if $score->tag eq "title";

						next unless (
							$round->post_results > 1
							|| $round_settings{"coach_feedback"}
							|| $round_settings{"public_feedback"}
						);
</%perl>
						<div class="padless marno bordertop">
							<span class="fifth semibold bluetext">
								<% uc($score->tag) %>
								<% $score->speech ? "&num;".$score->speech : "" %>
								<% $score->student ? "<br /> ".$score->student->last : "" %>
								<% $score->value ? "<br />".$score->value. " pts" : "" %>
							</span>
							<span class="fourfifths ltborderleft">
%								if ($score->topic) { 
									<div class="padvertless odd">
										<span class="eighth semibold bluetext">
											Topic:
										</span>
										<span class="half">
											<% $score->topic %>
										</span>
										<span class="quarter semibold orangetext">
											<% $score->position == 1 ? "FOR" : ""%>
											<% $score->position == 2 ? "AGAINST" : ""%>
										</span>
									</div>
%								}
								<% Tab::Score::uncompress($score->content) %>
							</span>
						</div>

%					}

				</div>
%			}

			</div>
			</div>

%		}
	</div>

