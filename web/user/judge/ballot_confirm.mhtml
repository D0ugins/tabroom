<%args>
	$person
	$person_settings
	$panel_id => undef
	$from     => undef
</%args>
<%init>

    unless ($panel_id) { 
        my $err = "I didn't get a ballot record?";
        $m->redirect("/user/home.mhtml?err=$err");
    }   

    my $panel = Tab::Panel->retrieve($panel_id);

	unless ($panel && $person) { 
		$m->comp("/funclib/abort.mas", message => "No section found for ID $panel_id");
	}

	Tab::Judge->set_sql( panel_person => "
		select judge.*
		from judge, ballot
		where ballot.panel = ? 
		and ballot.judge = judge.id
		and judge.person = ?
	");

	my $judge = Tab::Judge->search_panel_person($panel->id, $person->id)->first;

    unless ($panel && $judge) { 
        my $err = "No ballots found for that judge and that panel.";
        $m->redirect("/user/home.mhtml?err=$err");
    }   

    unless ($judge->person->id == $person->id) { 
        my $err = "You are not authorized to enter ballots for that judge.";
        $m->redirect("/user/home.mhtml?err=$err")
    }   

    my @ballots = Tab::Ballot->search( 	
		panel => $panel->id, 
		judge => $judge->id
	);

    unless (@ballots) { 
        my $err = "That judge does not judge in that room.";
        $m->redirect("/user/home.mhtml?err=$err");
	}

	my $rfd;

	foreach my $ballot (@ballots) { 

		$ballot->audit(1);
		$ballot->entered_by($person->id);
		$ballot->update;

		$rfd = Tab::Score->search( 
			tag    => "rfd",
			ballot => $ballot->id
		)->first unless $rfd;

	}

	my @judges = $m->comp(
		"/funclib/panel_judges.mas", 
		panel => $panel
	);

	my $event = $panel->round->event;
	my $type = $event->type;

	my $aff_string = $event->setting("aff_label");
	my $neg_string = $event->setting("neg_label");

	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	my $undone;

	if ($type eq "wudc") { 

		foreach my $ballot ($panel->ballots) { 
			$ballot->audit(1);
			$ballot->update;
		}

	} elsif ($type eq "congress" || $type eq "speech") { 

		my $msg = "Thank you for confirming your ballot!";
		$m->redirect("/user/judge/panels.mhtml?msg=$msg");

	} else {

		foreach my $other (@judges) { 
			next if $judge->id == $other->id;

			my ($win, $winside) = $m->comp(
				'/funclib/panel_winner.mas',
					panel => $panel, 
					judge => $other
				);

			$undone++ unless $win;
			undef $win;
		}
	}

	$m->comp("/funclib/round_done.mas", 
		round => $panel->round
	);

</%init>

%	if ($undone) { 

		<div class="main">

			<h2>
				Panel Decision Incomplete
			</h2>

			<p>
				Other judges have yet to vote.  When all ballots are confirmed
				you can refresh this page to see the decision.  The last judge
				to vote will also automatically see the decision.
			</p>

		</div>

%	} elsif ($event->setting("hide_panel_decision")) { 

		<div class="main">

			<h2>
				Panel Decision Complete
			</h2>

			<p>
				All judges have voted; the round is over.  Thank you!
			</p>

		</div>

%	} elsif ($type ne "wudc") { 

		<div class="main">

			<span class="threequarters">
				<h2 class="nospace">
					Decision Complete
				</h2>
			</span>

			<span class="quarter rightalign">
				<a 
					class="buttonwhite bluetext invert" 
					href="/user/home.mhtml"
				> Return Home </a>
			</span>

<%perl>

			my $proceed++;
			my $aff_count = 0;
			my $neg_count = 0;
			my $switch;
			my $winner;
			my $side;

			foreach my $ojudge (@judges) { 

				my ($thiswin, $winside, $winorder) = $m->comp(
					'/funclib/panel_winner.mas', 
					panel => $panel,
					judge => $ojudge,
					noob  => 1
				);

				$aff_count++ if $winside == 1;
				$neg_count++ if $winside == 2;

				$side = $aff_string if $winside == 1;
				$side = $neg_string if $winside == 2;

</%perl>
				<div class="row">

					<span class="padvertmore quarter bigger semibold bluetext">
						<% $ojudge->first." ".$ojudge->last %> 
					</span>

					<span class="eighth bigger graytext semibold rightalign">
						<% $side %> 
					</span>
							
					<span class="quarter bigger orangetext semibold">
						<% $winorder 
						 	? Lingua::EN::Numbers::Ordinate::ordinate($winorder)." speakers" 
							: "" 
						%>
					</span>
							
					<span class="threeeighths bigger semibold bluetext">
						<% $thiswin ? $thiswin->code : "" %>
					</span>

				</div>
%			}

		<div class="martopmore marbottommore full">

			<span class="half">
				<h4 class="semibold nospace">
					Result:
				</h4>
			</span>

			<span class="half centeralign bluetext semibold">

%				if (scalar @judges > 1) { 

					<h4 class="semibold greytext centeralign nospace">
%					if ($aff_count == $neg_count) { 
						<% $aff_count."-".$neg_count %> SPLIT DECISION
%					} elsif ($aff_count > $neg_count) { 
						<% $aff_count."-".$neg_count %> for the <% $aff_string %>
%					} else { 
						<% $neg_count."-".$aff_count %> for the <% $neg_string %>
%					} 
					</h4>

%				} else { 
					<h4 class="semibold bluetext centeralign nospace">
						<% $winner? $winner->code : "" %> won on the <% $side %>
					</h4>
%				}
			</span>
		</div>


%		if ($event->setting("judge_publish_results")) { 

%			if ($panel->publish) { 

				<div class="bordertop borderbottom">
					<h4 class="greentext centeralign">
						Decision is Published
					</h4>
				</div>

%			} else { 

				<div class="bordertop borderbottom">

					<span class="threequarters nospace">

						<h4 class="marno padless padleft padtop">
							Publish Decision
						</h4>

						<span class="bigger redtext semibold full marno padless marbottom">
							Once the result has been announced, please
							publish the decision:
						</span>
					</span>

					<span class="quarter rightalign">
						<a 
							class="buttonred invert bigger"
							<& "/funclib/confirm.mas", 
								warn => "This will post the result online. Please be sure it has announced before doing so." &>
							href="publish_panel.mhtml?panel_id=<% $panel->id %>"
						>Publish Online</a>
					</span>

				</div>
%			}

%		}

%		if ($rfd) { 

			<h5 class="martopmuchmore">Your RFD</h5>

			<div style="padding-left: 25px;">
				<% $rfd->content %>
			</div>

%		}


%		my $now = DateTime->now;

%		if ($now->month > 9) { 

%			if ($person->id == 7482) { 

				<div class="full hidden centeralign">

					<iframe 
						width       = "560"
						height      = "315"
						frameborder = "0"
						src="https://www.youtube.com/embed/Px0F9LQZQY8?rel=0&amp;controls=0&amp;showinfo=0&autoplay=1&start=60s" 
					></iframe>
				</div>
%			}
%		}

%		if ($person->id == 7355) { 

				<div class="hidden">
					<iframe 
						width       = "420"
						height      = "315"
						frameborder = "0"
						src="https://www.youtube.com/watch?v=yJxCdh1Ps48?rel=0&amp;controls=0&amp;showinfo=0&autoplay=1" 
					></iframe>	
				</div>

%		}

%#		Word.
%		if ($person_settings->{'tomasi'})  { 
			<& "/funclib/tomasi.mas" &>
%		}


%		if ($now->month > 12) { 

%			if ($person->id == 6366 || $person->id == 6429 || $person->id == 6415) { 

				<div class="hidden">
					<iframe 
						width       = "420"
						height      = "315"
						frameborder = "0"
						src="https://www.youtube.com/embed/etWoKUxz5NU?rel=0&amp;controls=0&amp;showinfo=0&autoplay=1" 
					></iframe>	
				</div>
%			}
%		}

	</div>

	<& "/user/menu.mas", person => $person &>

<%perl>

	} else {

		my $msg = "Thank you for entering your ballot.  If you come to believe
		you screwed up, please contact the tournament staff";

		$m->redirect("/user/home.mhtml?msg=$msg");

	} 

</%perl>

