<%args>
	$person
	$person_settings
	$panel_id => undef
	$from     => undef
</%args>
<%init>

    unless ($panel_id) {
        my $err = "I didn't get a ballot record?";
        $m->redirect("/user/home.mhtml?err=$err");
    }

    my $panel = Tab::Panel->retrieve($panel_id);
	my $round = $panel->round;

	unless ($panel && $person) {
		$m->comp(
			"/funclib/abort.mas",
			message => "No section found for ID $panel_id"
		);
	}

	Tab::Judge->set_sql( panel_person => "
		select judge.*
		from judge, ballot
		where ballot.panel = ?
		and ballot.judge = judge.id
		and judge.person = ?
	");

	my $judge = Tab::Judge->search_panel_person($panel->id, $person->id)->first;

    unless ($panel && $judge) {
        my $err = "No ballots found for that judge and that panel.";
        $m->redirect("/user/home.mhtml?err=$err");
    }

    unless ($judge->person->id == $person->id) {
        my $err = "You are not authorized to enter ballots for that judge.";
        $m->redirect("/user/home.mhtml?err=$err")
    }

    my @ballots = Tab::Ballot->search(
		panel => $panel->id,
		judge => $judge->id
	);

	my @clean;
	foreach my $ballot (@ballots) {
		next unless $ballot->entry > 0;
		push @clean, $ballot;
	}

	@ballots = @clean;
    unless (@ballots) {
        my $err = "That judge does not judge in that room.";
        $m->redirect("/user/home.mhtml?err=$err");
	}

	my $rfd;

	foreach my $ballot (@ballots) {
		$ballot->audit(1);
		$ballot->entered_by($person->id);
		$ballot->update;

		$rfd = Tab::Score->search(
			tag    => "rfd",
			ballot => $ballot->id
		)->first unless $rfd;
	}

	my @judges = $m->comp(
		"/funclib/panel_judges.mas",
		panel => $panel
	);

	my $event = $round->event;
	my $type = $event->type;

	my $aff_string = $event->setting("aff_label");
	my $neg_string = $event->setting("neg_label");
	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	my $undone;

	if ($type eq "wudc") {

		foreach my $ballot ($panel->ballots) {
			$ballot->audit(1);
			$ballot->update;
		}

	} elsif ($type eq "congress" || $type eq "speech") {

		$m->comp("/funclib/round_done.mas",
			round => $round
		);

		my $msg = "Thank you for confirming your ballot!";
		$m->redirect("/user/judge/panels.mhtml?msg=$msg");

	} else {

		foreach my $other (@judges) {
			next if $judge->id == $other->id;

			my ($win, $winside) = $m->comp(
				'/funclib/panel_winner.mas',
					panel => $panel,
					judge => $other
				);

			$undone++ unless $win;
			undef $win;
		}
	}

	Tab::Judge->set_sql( all => "
		select count(distinct judge.id)
		from judge, ballot, panel
		where panel.round = ?
			and panel.flight = ?
			and panel.id = ballot.panel
			and ballot.judge = judge.id
	");

	Tab::Judge->set_sql( undone => "
		select count(distinct judge.id)
		from judge, ballot, panel
		where panel.round = ?
		and panel.flight = ?
		and panel.id = ballot.panel
		and ballot.audit = 1
		and ballot.judge = judge.id
	");

	my $judge_rank = Tab::Judge->sql_undone->select_val($round->id, $panel->flight);
	my $judge_count = Tab::Judge->sql_all->select_val($round->id, $panel->flight);
	my $last_judge;

	if ($judge_rank == $judge_count) {
		$last_judge++;
	}

	$m->comp("/funclib/round_done.mas",
		round => $round
	);

</%init>

%	if ($undone) {

		<div class="main">

			<h2>
				Panel Decision Incomplete
			</h2>

			<p>
				Other judges have yet to vote.  When all ballots are confirmed
				you can refresh this page to see the decision.  The last judge
				to vote will also automatically see the decision.
			</p>

			<p class="bigger semibold bluetext">
				You were the
					<span class="redtext inline"><% Lingua::EN::Numbers::Ordinate::ordinate($judge_rank) %></span>
				judge out of
					<span class="redtext inline"><% $judge_count %></span> to submit your ballot.
			</p>

		</div>

%	} elsif ($event->setting("hide_panel_decision")) {

		<div class="main">

			<h2>
				Panel Decision Complete
			</h2>

			<p class="bigger bluetext semibold">
				All judges have voted; the round is over.  Thank you!
			</p>

			<p class="bigger semibold bluetext">
				You were the
					<span class="redtext inline"><% Lingua::EN::Numbers::Ordinate::ordinate($judge_rank) %></span>
				judge out of
					<span class="redtext inline"><% $judge_count %></span> to submit your ballot.
			</p>

		</div>

%	} elsif ($type ne "wudc") {

		<div class="main">

			<span class="threequarters marbottom nospace">
				<h2 class="nospace">
					Decision Complete
				</h2>
			</span>

			<span class="quarter rightalign nospace">
				<a
					class="buttonwhite bluetext invert"
					href="/user/home.mhtml"
				> Return Home </a>
			</span>

<%perl>

			my $proceed++;
			my $aff_count = 0;
			my $neg_count = 0;
			my $switch;

			my ($winner, $side, $order) = $m->comp(
				'/funclib/panel_winner.mas',
				panel => $panel
			);

			foreach my $ojudge (@judges) {

				my ($thiswin, $winside, $winorder) = $m->comp(
					'/funclib/panel_winner.mas',
					panel => $panel,
					judge => $ojudge,
					noob  => 1
				);

				$aff_count++ if $winside == 1;
				$neg_count++ if $winside == 2;
				$side = $aff_string if $winside == 1;
				$side = $neg_string if $winside == 2;

</%perl>
				<div class="row martopmore">

					<span class="padvertmore quarter bigger semibold bluetext">
						<% $ojudge->first." ".$ojudge->last %>  votes for
					</span>

					<span class="threeeighths bigger redtext semibold marno centeralign">
						<% $winorder
							? "the ".Lingua::EN::Numbers::Ordinate::ordinate($winorder)." speakers/"
							: ""
						%><% $side %>
					</span>

					<span class="threeeighths bigger semibold bluetext">
						<% $thiswin ? $thiswin->code : "" %>
					</span>
				</div>
%			}

			<div class="martopmore marbottommore full">
				<span class="full centeralign">

%					if (scalar @judges > 1) {

						<h5 class="semibold greytext centeralign nospace">
%						if ($aff_count == $neg_count) {
							<% $aff_count."-".$neg_count %> SPLIT DECISION
%						} elsif ($aff_count > $neg_count) {
							<% $aff_count."-".$neg_count %> for the <% $aff_string %>
%						} else {
							<% $neg_count."-".$aff_count %> for the <% $neg_string %>
%						}
						</h5>
%					} else {
						<h5 class="semibold bluetext centeralign nospace">
							<% $winner? $winner->code : "" %> won on the <% $side %>
						</h5>
%					}
				</span>
			</div>

			<p class="bigger semibold bluetext centeralign marbottommore padbottommore">
				You were the
					<span class="redtext inline"><% Lingua::EN::Numbers::Ordinate::ordinate($judge_rank) %></span>
				judge out of
					<span class="redtext inline"><% $judge_count %></span> to submit your ballot.
			</p>

%			if ($event->setting("judge_publish_results")) {

%				if ($panel->publish) {

					<div class="bordertop borderbottom">
						<h4 class="greentext centeralign">
							Decision is Published
						</h4>
					</div>

%				} else {

					<h4 class="marno padless padleft padtop">
						Publish Decision
					</h4>

					<div class="bordertop borderbottom padvertmuchmore">
						<span class="threequarters nospace bigger redtext semibold centeralign">
							Once the result has been announced, please publish
							the decision:
						</span>

						<span class="quarter nospace">
							<a
								class="buttonwhite bluetext invert bigger"
								<& "/funclib/confirm.mas",
									warn => "This will post the result online. Please be sure it has announced before doing so." &>
								href="publish_panel.mhtml?panel_id=<% $panel->id %>"
							>Publish Online</a>
						</span>
					</div>
%				}
%			}

%			if ($rfd) {
				<h5 class="martopmuchmore">Your RFD</h5>
				<div style="padding-left: 25px;">
					<% $rfd->content %>
				</div>
%			}

%			my $now = DateTime->now;

%#			Word.
%			if ($person_settings->{'tomasi'})  {
				<& "/funclib/tomasi.mas" &>
%			}

		</div>

		<& "/user/menu.mas", person => $person &>

<%perl>

	} else {
		my $msg = "Thank you for entering your ballot.  If you come to believe you made a mistake, please contact the tournament staff.";
		$m->redirect("/user/home.mhtml?msg=$msg");
	}

</%perl>
