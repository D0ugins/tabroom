<%args>
	$person
	$other_id       => undef
	$chapter_id     => undef
	$search_email   => undef
	$search_chapter => undef
	$search_last    => undef
	$judge_id       => undef
</%args>
<%init>

	if ($other_id) { 

		my $other = Tab::Person->retrieve($other_id);

		if ($other) { 

			my @already = Tab::Conflict->search( 
				person     => $person->id,
				conflicted => $other_id
			);

			unless (@already) { 

				Tab::Conflict->create({
					person     => $person->id,
					conflicted => $other_id,
					added_by   => $person->id,
				});

			}
		} 
	} 

	if ($chapter_id) { 

		my $chapter = Tab::Chapter->retrieve($chapter_id);

		if ($chapter) { 

			my @already = Tab::Conflict->search( 
				person  => $person->id,
				chapter => $chapter_id
			);

			unless (@already) { 

				Tab::Conflict->create({
					person   => $person->id,
					chapter  => $chapter_id,
					added_by => $person->id,
				});

			}
		} 
	}
	
	my @chapters;
	my @persons;

	if ($search_email && $search_last) { 

		@persons = Tab::Person->search_where( 
			last  => { "like", $search_last."%" },
			email => { "like", $search_email."%" }
		);

	} elsif ($search_email) { 

		@persons = Tab::Person->search_where( 
			email => { "like", $search_email."%" }
		);

	} elsif ($search_last) { 

		@persons = Tab::Person->search_where( 
			last => { "like", $search_last."%" }
		);

	}

	if ($search_chapter) { 

		@chapters = Tab::Chapter->search_where( 
			name => { "like", $search_chapter."%" }
		);

	}

	my @existings = Tab::Conflict->search( person => $person->id );

</%init>

	<& menu.mas, person => $person, whoami => "conflicts" &>

	<div class="main">

		<h2>Standing Conflicts</h2>

		<p>
			These conflicts are meant to reflect a personal or professional
			relationship which means it is unfair for you to judge the other
			person; such as a relative, or a former student.  Do NOT use
			conflicts against debaters you simply do not like, or the
			tournament directors of tournaments you attend will likely get very
			angry.
		</p>

		<p>
			The conflict must have a Tabroom.com person linked to their
			entries for a standing conflict to work automatically.
		</p>

		<p> 

			<strong class="redtext">
				Conflicts entered on Tabroom.com are not confidential. 
			</strong>
			
			Any information you enter onto Tabroom is viewable by third
			parties, including the people you are conflicting.  If you have a
			conflict (or for that matter, any other information) you wish to
			keep confidential, you should contact the tournament officials
			directly instead of entering it here.  

		</p>

		<div class="half top">

			<h5 class="button">Add Personal Conflict</h5>

			<form action="conflicts.mhtml" method="post">

			<div class="row padleftmore">
				<span class="third">
					Last Name: 
				</span>
				<span class="twothird">
					<input 
						type        = "text"
						name        = "search_last"
						size        = "25"
						placeholder = "Search by last name"
					>
				</span>
			</div>

			<div class="row padleftmore">
				<span class="third">
					or Email:
				</span>
				<span class="twothird">
					<input 
						type        = "text"
						name        = "search_email"
						size        = "25"
						placeholder = "Search by email"
					>
				</span>
			</div>

			<div class="rightalign liblrow marno">
				<input type="submit" value="Search">
				</form>
			</div>

			<h5 class="button">Add School Conflict</h5>

			<form action="conflicts.mhtml" method="post">

			<div class="row padleftmore">
				<span class="third">
					Whole School:
				</span>
				<span class="twothird">
					<input 
						type        = "text"
						name        = "search_chapter"
						size        = "25"
						placeholder = "Search by school name"
					>
				</span>
			</div>

			<div class="rightalign liblrow marno">
				<input type="submit" value="Search">
				</form>
			</div>

<%perl>

			my @nowjudges = $m->comp(
				"/funclib/person_judges.mas", 
					person       => $person,
					future       => 1,
					conflictable => 1
				);

			if (@nowjudges) { 

</%perl>

				<h5 class="martopmore button">
					Tournament Specific Conflicts
				</h5>

				<form action="conflicts.mhtml" method="post">

				<div class="row">

					<span class="quarter">
						Tournament:
					</span>
					<span class="threequarters ">

						<select name="judge_id" class="fixedmed">

							<option value=""></option>

%							foreach my $judge (@nowjudges) { 
								<option value="<% $judge->id %>" 
									<% $judge->id == $judge_id ? 'selected="selected"' : "" %>
								> <% $judge->category->abbr %> at <% $judge->category->tourn->name %> </option>
%							}
						</select>
					</span>

				</div>

				<div class="rightalign liblrow marno">
					<input type="submit" value="Search">
					</form>
				</div>
%			}
		</div>

		<div class="half top right">

%			if (@persons || @chapters) { 

				<h5 class="button">Search Results:</h5>

<%perl>

				foreach my $other (@persons) { 

					my @chapters;

					my @students = Tab::Student->search( person => $other->id );

					my @chapter_judges = Tab::ChapterJudge->search( person => $other->id );

					foreach my $person (@chapter_judges, @students) { 
						push @chapters, $person->chapter if $person->chapter;
					}

</%perl>
					<div class="row ">

						<span class="quarter ">
							<% $other->first %>
						</span>

						<span class="quarter ">
							<% $other->last %>
						</span>

						<span class="quarter ">
%							foreach my $chapter (@chapters) { 
								<div class="full nospace">
									<% $chapter->name %> 
								</div>
%							}
						</span>

						<span class="quarter">
							<a class="buttonwhite bluetext" 
								href="conflicts.mhtml?other_id=<% $other->id %>"
							> Conflict </a>
						</span>

					</div>

%				}

%				foreach my $chapter (@chapters) { 

					<div class="row ">

						<span class="half">
							<% $chapter->name %>
						</span>

						<span class="quarter">
							<% $chapter->state %>
						</span>

						<span class="quarter">
							<a class="bluetext buttonwhite"
								href="conflicts.mhtml?chapter_id=<% $chapter->id %>"
							> Conflict </a>
						</span>

					</div>

%				}

%			}

%			if (@existings) { 

				<h5 class="button">Permanent Conflicts</h5>

<%perl>
				foreach my $existing (@existings) { 

					my $conflicted = $existing->conflicted 
						if $existing->conflicted > 0;

					my $chapter = $existing->chapter 
						if $existing->chapter > 0;

</%perl>

					<div class="row">
						
						<span class="fifth">
							<% $conflicted > 0 ? "Person" : "" %>
							<% $existing->chapter > 0 ? "Team" : "" %>
						</span>

%						if ($conflicted) { 
							<span 
								title="<% $conflicted->email %>"
								class="threefifths semibold bluetext hover"
							>
								<% $conflicted->first." ".$conflicted->last %>
							</span>
%						} elsif ($chapter) { 
							<span class="threefifths semibold bluetext" >
								<% $chapter->name %>
							</span>
%						}

						<span class="fifth rightalign marno padvertless">
							<a class="redtext buttonwhite fa fa-trash fa-sm" 
								href="conflict_rm.mhtml?conflict_id=<% $existing->id %>">
							</a>
						</span>

%						if ($conflicted) { 

%							my @cjs = $conflicted->chapter_judges if $conflicted;

							<span class="half top nospace">

								<div class="full semibold redtext">
									Judging for:
								</div>

%								foreach my $judge (@cjs) { 
%									next unless $judge->chapter;
									<div class="full padless smallish marno marleftmore">
										<% $judge->chapter->name %>
									</div>
%								}

%								unless (@cjs) { 
									<div class="padmore semibold redtext marbottom">
										No judge records linked. No conflict will apply.
									</div>
%								}

							</span>

							<span class="half top nospace">

								<div class="full semibold redtext">
									Competing for:
								</div>

%								my @students = $conflicted->students if $conflicted;

%								foreach my $student (@students) { 
%									next unless $student && $student->chapter;
									<div class="full padless smallish marno marleftmore">
										<% $student->chapter->name %>
										(<% $student->grad_year %>)
									</div>
%								}

%								unless (@students) { 
									<div class="padmore semibold redtext marbottom">
										No competitor records linked.  No conflict will apply
									</div>
%								}

							</span>

%						}
					</div>
<%perl>

				}
			} 

			if ($judge_id) { 

				my $judge = Tab::Judge->retrieve($judge_id);

				unless ($judge->category->setting("conflicts")) { 
						
</%perl>
					<p>
						This tournament is not set to permit online entry of
						conflicts
					</p>

					<p>
						Please contact the tournament staff if you believe this
						is an error
					</p>

%				} elsif ($judge && $judge->person->id == $person->id) { 
					
					<h4 class="button nowrap"> <% $judge->category->tourn->name %></h4>

<%perl>
					foreach my $conflict (
						Tab::Strike->search( 
							judge      => $judge_id,
							registrant => 1,
							conflictee => 1 
						)
					) {
</%perl>

						<div class="row">

							<span class="threequarter">
								<% $conflict->type eq "conflict" && $conflict->entry 
									? "Entry: ".$conflict->entry->name : ""
								%>
								<% $conflict->type eq "entry" && $conflict->entry 
									? "Entry: ".$conflict->entry->name : ""
								%>
								<% $conflict->type eq "school" && $conflict->school 
									? "School: ".$conflict->school->short_name : ""
								%>
							</span>

							<span class="quarter">
								<a class="redtext buttonwhite" 
									href="conflict_tourn_rm.mhtml?conflict_id=<% $conflict->id %>">
									Remove
								</a>
							</span>

						</div>
%					}

					<h5 class="button">Add new:</h5>

%					foreach my $event ($judge->category->events) { 

						<div class="row">

							<form action="conflict_entry.mhtml">

							<input 
								type  = "hidden"
								name  = "judge_id"
								value = "<% $judge->id %>"
							>

							<span class="sixth">
								<% $event->abbr %>:
							</span>

							<span class="half">

								<select name="entry_id" class="fixedmed">

%									foreach my $entry (sort {$a->code cmp $b->code} $event->entries) {
		
%										my $schname = substr($entry->school->short_name,0,8);

%										foreach ( length($schname) .. 8) {
%											$schname .= "&nbsp;";
%										}
		
										<option 
											value="<% $entry->id %>"
										><% $schname."- ".$entry->name %></option>
%									}
								</select>

							</span>

							<span class="third rightalign">
								<input class="thin" type="submit" value="Conflict">
								</form>
							</span>

						</div>

						<div class="row">

							<form action="conflict_school.mhtml">

							<input 
								type  = "hidden"
								name  = "judge_id"
								value = "<% $judge->id %>"
							>

							<span class="sixth">
								School:
							</span>

							<span class="half">

								<select name="school_id" class="fixedmed">

<%perl>
								foreach my $school (
									sort {$a->name cmp $b->name} $judge->category->tourn->schools
								) { 
</%perl>
									<option value="<% $school->id %>">	<% $school->name %> </option>
%								}

								</select>
							</span>

							<span class="rightalign third">
								<input 
									class = "thin"
									type  = "submit"
									value = "Conflict"
								>
								</form>
							</span>

						</div>

%					}

%				}

%			}

			</div>

	</div>



