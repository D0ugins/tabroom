<%args>
	$person
	$other_id       => undef
	$chapter_id     => undef
	$search_email   => undef
	$search_chapter => undef
	$search_last    => undef
	$judge_id       => undef
</%args>
<%init>

	if ($other_id) {

		my $other = Tab::Person->retrieve($other_id);

		if ($other) {

			my @already = Tab::Conflict->search(
				person     => $person->id,
				conflicted => $other_id
			);

			unless (@already) {

				Tab::Conflict->create({
					person     => $person->id,
					conflicted => $other_id,
					added_by   => $person->id,
				});

			}
		}
	}

	if ($chapter_id) {

		my $chapter = Tab::Chapter->retrieve($chapter_id);

		if ($chapter) {

			my @already = Tab::Conflict->search(
				person  => $person->id,
				chapter => $chapter_id
			);

			unless (@already) {

				Tab::Conflict->create({
					person   => $person->id,
					chapter  => $chapter_id,
					added_by => $person->id,
				});

			}
		}
	}

	my @chapters;
	my @persons;

	if ($search_email && $search_last) {
		@persons = Tab::Person->search_where(
			last  => { "like", $search_last."%" },
			email => { "like", $search_email."%" }
		);
	} elsif ($search_email) {
		@persons = Tab::Person->search_where(
			email => { "like", $search_email."%" }
		);
	} elsif ($search_last) {
		@persons = Tab::Person->search_where(
			last => { "like", $search_last."%" }
		);
	}

	if ($search_chapter) {
		@chapters = Tab::Chapter->search_where(
			name => { "like", $search_chapter."%" }
		);
	}

	my @existings = Tab::Conflict->search(
		person => $person->id
	);

	my %no_chapter;
	my %no_person;

	foreach my $existing (@existings) {
		if ($existing->conflicted > 0) {
			$no_person{$existing->conflicted}++;
		}

		if ($existing->chapter > 0) {
			$no_chapter{$existing->chapter}++;
		}
	}

	my @nowjudges = $m->comp(
		"/funclib/person_judges.mas",
		person       => $person,
		future       => 1,
		conflictable => 1
	);

	if ($chapter_id || $other_id) {
		foreach my $judge (@nowjudges) {
			$m->comp("/funclib/person_conflict.mas", person => $person, tourn => $judge->category->tourn);
		}
	}

</%init>

	<& menu.mas,
		person => $person,
		whoami => "conflicts"
	&>

	<div class="main">

		<h2>Standing Conflicts</h2>

		<p>
			These conflicts are meant to reflect a personal or professional
			relationship which means it is unfair for you to judge the other
			person; such as a relative, or a former student.  Do not use
			conflicts against debaters you simply do not like as judges.
		</p>

		<p>
			These conflicts work to prevent one party from being judged by the
			other. They will not prevent two entries from competing against one
			another, which requires manual intervention.  Contact your
			tournament's officials if the latter situation arises.
		</p>

		<p class="redtext semibold padvertmore bigger centeralign">
			Conflicts entered on Tabroom.com are not confidential.
		</p>

		<p>
			Any information you enter onto Tabroom is viewable by third
			parties, including the people you are conflicting.  If you have a
			conflict (or for that matter, any other information) you wish to
			keep confidential, you should contact the tournament officials
			directly instead of entering it here.
		</p>

		<p class="centeralign bigger semibold redtext">

			The judge &amp; entry both must have a Tabroom.com person linked to
			their entries for a standing conflict to work automatically.
		</p>

		<div class="half top">

			<h5 class="button">Add Personal Conflict</h5>

			<form action="conflicts.mhtml" method="post">

			<div class="row padleftmore">
				<span class="third">
					Last Name:
				</span>
				<span class="twothird">
					<input
						type        = "text"
						name        = "search_last"
						size        = "25"
						placeholder = "Search by last name"
					>
				</span>
			</div>

			<div class="row padleftmore">
				<span class="third">
					or Email:
				</span>
				<span class="twothird">
					<input
						type        = "text"
						name        = "search_email"
						size        = "25"
						placeholder = "Search by email"
					>
				</span>
			</div>

			<div class="rightalign liblrow marno">
				<input type="submit" value="Search">
				</form>
			</div>

			<h5 class="button">Add School Conflict</h5>

			<form action="conflicts.mhtml" method="post">

			<div class="row padleftmore">
				<span class="third">
					Whole School:
				</span>
				<span class="twothird">
					<input
						type        = "text"
						name        = "search_chapter"
						size        = "25"
						placeholder = "Search by school name"
					>
				</span>
			</div>

			<div class="rightalign liblrow marno">
				<input type="submit" value="Search">
				</form>
			</div>

		</div>

		<div class="half top right">

%			if (@persons || @chapters) {

				<h5 class="button">Search Results:</h5>

<%perl>

				foreach my $other (@persons) {

					next if $no_person{$other};

					my @chapters;

					my @students = Tab::Student->search( person => $other->id );

					my @chapter_judges = Tab::ChapterJudge->search( person => $other->id );

					foreach my $person (@chapter_judges, @students) {
						push @chapters, $person->chapter if $person->chapter;
					}

</%perl>
					<div class="row ">

						<span class="quarter ">
							<% $other->first %>
						</span>

						<span class="quarter ">
							<% $other->last %>
						</span>

						<span class="quarter ">
%							foreach my $chapter (@chapters) {
								<div class="full nospace">
									<% $chapter->name %>
								</div>
%							}
						</span>

						<span class="quarter">
							<a class="buttonwhite bluetext invert thin"
								href="conflicts.mhtml?other_id=<% $other->id %>"
							> Conflict </a>
						</span>

					</div>

%				}

%				foreach my $chapter (@chapters) {

%					next if $no_chapter{$chapter};

					<div class="row ">

						<span class="half">
							<% $chapter->name %>
						</span>

						<span class="quarter">
							<% $chapter->state %>
						</span>

						<span class="quarter">
							<a class="buttonwhite bluetext invert thin"
								href="conflicts.mhtml?chapter_id=<% $chapter->id %>"
							> Conflict </a>
						</span>

					</div>

%				}
%			}

			<h5 class="button">Standing Conflicts</h5>

<%perl>

			if (@existings) {

				foreach my $existing (@existings) {

					my $conflicted = $existing->conflicted
						if $existing->conflicted > 0;

					my $chapter = $existing->chapter
						if $existing->chapter > 0;

</%perl>

					<div class="row">

						<span class="fifth">
							<% $conflicted > 0 ? "Person" : "" %>
							<% $existing->chapter > 0 ? "Team" : "" %>
						</span>

%						if ($conflicted) {
							<span
								title="<% $conflicted->email %>"
								class="threefifths semibold bluetext hover"
							>
								<% $conflicted->first." ".$conflicted->last %>
							</span>
%						} elsif ($chapter) {
							<span class="threefifths semibold bluetext" >
								<% $chapter->name %>
							</span>
%						}

						<span class="fifth rightalign marno padvertless">
							<a class="redtext buttonwhite fa fa-trash fa-sm"
								href="conflict_rm.mhtml?conflict_id=<% $existing->id %>">
							</a>
						</span>

%						if ($conflicted) {

%							my @cjs = $conflicted->chapter_judges if $conflicted;

							<span class="half top nospace">

								<div class="full semibold redtext">
									Judging for:
								</div>

%								foreach my $judge (@cjs) {
%									next unless $judge->chapter;
									<div class="full padless smallish marno marleftmore">
										<% $judge->chapter->name %>
									</div>
%								}

%								unless (@cjs) {
									<div class="padmore semibold redtext marbottom">
										No judge records linked. No conflict will apply.
									</div>
%								}

							</span>

							<span class="half top nospace">

								<div class="full semibold redtext">
									Competing for:
								</div>

%								my @students = $conflicted->students if $conflicted;

%								foreach my $student (@students) {
%									next unless $student && $student->chapter;
									<div class="full padless smallish marno marleftmore">
										<% $student->chapter->name %>
										(<% $student->grad_year %>)
									</div>
%								}

%								unless (@students) {
									<div class="padmore semibold redtext marbottom">
										No competitor records linked.  No conflict will apply
									</div>
%								}
							</span>
%						}
					</div>
%				}
%			}
		</div>


%		if (@nowjudges) {
			<h5 class="martopmore button">
				Or, Enter Tournament Specific Conflicts
			</h5>

%			foreach my $judge (@nowjudges) {

				<div class="row">
					<span class="twofifths semibold">
						<% $judge->category->tourn->name %>
					</span>

					<span class="tenth">
						<% $judge->category->abbr %>
					</span>

					<span class="third">
						<% $judge->school ? $judge->school->name : "Hired" %>
					</span>

					<span class="fifth centeralign">
						<a
							href="judge_conflicts.mhtml?judge_id=<% $judge->id %>"
							class="buttonwhite bluetext thinnish invert"
						>Conflict Sheet</a>
					</span>
				</div>

%			}
%		}

	</div>
