<%args>
	$target_id      => undef
	$property_name  => undef
	$property_value => undef
</%args>
<%init>

	$m->clear_buffer();
	$r->content_type('application/json');

	unless ($target_id) { 
		$m->print('{ "error": true, "message": "No ballot ID sent"}');
		$m->abort();
	}

	unless ($property_name) { 
		$m->print('{ "error": true, "message": "No property to change sent"}');
		$m->abort();
	}

	my $ballot = Tab::Ballot->retrieve($target_id);

	unless ($ballot) { 
		$m->print('{ "error": true, "message": "No ballot found for ID '.$target_id.'"}');
		$m->abort();
	}

	my $title;


	if ($property_name eq "title") { 

	   my $text = $m->comp(
		   "/funclib/save_editor.mas", 
			text => $property_value
		);

		my $title = Tab::Score->search( 
			tag    => "title",
			ballot => $ballot->id 
		)->first;

		if ($title) { 
			$title->content($text);
			$title->update();
		} else { 
			$title = Tab::Score->create({
				tag      => "title",
				tiebreak => 4,
				ballot   => $ballot->id,
				content  => $text,
				student  => 0 
			});
		}

	}

	$m->print('{ "error": false, "message": "'.$ballot->entry->code.' title saved to score '.$title.'"}');

	$m->abort();

</%init>

