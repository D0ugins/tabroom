<%args>
	$person
	$judge_id => undef
	$past     => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);

	if ($judge > 0 && $judge->person && $judge->person->id != $person->id) { 
		my $name = $person->last;
		$m->print("That judge is not you.  Stop messing around, $name");
		$m->abort;
	}

	my @judges = $person->judges unless $judge;

	push (@judges, $judge) if $judge;

	my $now = DateTime->now();

</%init>

	<& "/user/menu.mas", person => $person &>

	<div class="main">

		<h2>Judging</h2>

<%perl>
		foreach my $judge (@judges) { 

			my $category = $judge->category;
			next unless $category;

			my $tourn = $category->tourn;
			next unless $tourn;

			my $tz = $tourn->tz;  
			$tz = "UTC" unless $tz;

			my $start = $tourn->start->set_time_zone($tz);
			my $end = $tourn->end->set_time_zone($tz);

			next unless $past || $end > $now;

</%perl>
			<h5><% $tourn->name %> </h5>

			<span class="pagehalf">
				<div class="row marno">
					<span class="third semibold padvert">
						Dates
					</span>
					<span class="twothirds">
						<% Tab::niceshortdate($start) %>
						<% $start->day != $end->day ? " - ".Tab::niceshortdate($end) : "" %>/<% $start->year %>
					</span>
				</div>


				<div class="row marno">
					<span class="third semibold padvert">
						School
					</span>
					<span class="twothirds">
						<% $judge->school > 0 ? $judge->school->short_name : "Hired" %>
					</span>
				</div>

				<div class="row marno">
					<span class="third semibold padvert">
						Category
					</span>

					<span class="twothirds">
						<% $category->name %>
					</span>

				</div>

%				if ($end > $now && $category->setting("diversity_selfie")) { 

					<form action="diverse_switch.mhtml" method="post">

					<input 
						type  = "hidden"
						name  = "judge_id"
						value = "<% $judge->id %>"
					>

					<label for="<% $judge->id %>_diverse">

						<div class="row hover">

							<span class="half">
								Diversity Enhancing?
							</span>

							<span class="half">
								<input 
									type     = "checkbox"
									id       = "<% $judge->id %>_diverse"
									name     = "diverse"
									value    = "1"
									onchange = 'this.form.submit()'
									<% $judge->setting("diverse") ? 'checked="checked"' : "" %>
								>
								<% $judge->setting("diverse") ? "YES" : "NO" %>
							</span>
						</div>
					</label>

					</form>

%					if ($category->setting("diversity_notice")) { 
						<p class="explain">
							<% $category->setting("diversity_notice") %>
						</p>
%					}

%				}
	
%				unless ($category->setting("no_codes")) { 
					<div class="row  full marno">
						<span class="half  ">
							Judge Code
						</span>
						<span class="half ">
							<% $judge->code %>
						</span>
					</div>
%				}

			</span>

			<span class="pagehalf">

%				if ($end < $now) { 

					<div class="row  full marno">
						<span class="half ">
							Rounds judged
						</span>
						<span class="half ">
							<% scalar $m->comp("/funclib/judge_panels.mas", judge => $judge) %>
						</span>
					</div>

%				} elsif ($category->setting("rounds_per")) { 

					<div class="row  full marno">
						<span class="half ">
							Obligation for School
						</span>
						<span class="half ">
							<% $judge->obligation %>
						</span>
					</div>

					<div class="row  full marno">
						<span class="half ">
							Hired Rounds
						</span>
						<span class="half ">
							<% $judge->hired %>
						</span>
					</div>
%				}


%				if ($m->comp("/funclib/person_panels.mas", person => $person, judge => $judge)) {

					<div class="row  full marno">

						<span class="half ">
							Enter Ballots Online:
						</span>

						<span class="half nospace">
							<a class="buttonwhite bluetext smallish" href="panels.mhtml">
								ENTER
							</a>
						</span>
					</div>

%				} elsif ($m->comp("/funclib/person_published.mas", person => $person, judge => $judge)) {

					<div class="row centeralign padvert">
						<a
							class="buttonwhite bluetext marvert invert"
							href="panels.mhtml"
						>View Assignments</a>
					</div>
%				}

			</span>

%		}

	</div>

