<%args>
	$person
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("

		select
			judge.id, judge.first, judge.middle, judge.last,
				judge.code, judge.obligation, judge.hired,
			school.name,
			tourn.name, tourn.start, tourn.end, tourn.tz,
			CONVERT_TZ(tourn.reg_end, '+00:00', tourn.tz),
			CONVERT_TZ(judge_deadline.value_date, '+00:00', tourn.tz),
			weekend.id, weekend.name, weekend.start, weekend.end,
			category.id, category.name, category.abbr,
			diverse.value,
			nomination.value_text,
				diversity_notice.value_text,
				rounds_per.value,
				no_codes.value,
				diversity_selfie.value,
				required_quizzes.value_text,
				paradigm_quiz.value_text,
				conflicts.value,
				show_training.value,
				nsda_nats.value,
			show_judges.id,
			count(distinct panel.id)

		from (judge, category, tourn)

			left join school on school.id = judge.school

			left join judge_setting diverse
				on diverse.judge = judge.id
				and diverse.tag = 'diverse'

			left join judge_setting nomination
				on nomination.judge = judge.id
				and nomination.tag = 'nomination'

			left join tourn_setting judge_deadline
				on judge_deadline.tag = 'weekend'
				and judge_deadline.tourn = tourn.id

			left join event on event.category = category.id

			left join event_setting cws
				on cws.tag = 'weekend'
				and cws.event = event.id

			left join weekend
				on cws.value = weekend.id
				and weekend.tourn = tourn.id

			left join category_setting diversity_notice
				on diversity_notice.category = category.id
				and diversity_notice.tag = 'diversity_notice'

			left join category_setting rounds_per
				on rounds_per.category = category.id
				and rounds_per.tag = 'rounds_per'

			left join category_setting no_codes
				on no_codes.category = category.id
				and no_codes.tag = 'no_codes'

			left join category_setting diversity_selfie
				on diversity_selfie.category = category.id
				and diversity_selfie.tag = 'diversity_selfie'

			left join category_setting required_quizzes
				on required_quizzes.category = category.id
				and required_quizzes.tag = 'required_quizzes'

			left join category_setting conflicts
				on conflicts.category = category.id
				and conflicts.tag = 'conflicts'

			left join category_setting show_training
				on show_training.category = category.id
				and show_training.tag = 'show_training'

			left join tourn_setting nsda_nats
				on nsda_nats.tourn = tourn.id
				and nsda_nats.tag = 'nsda_nats'

			left join jpool_judge jpj
				on jpj.judge = judge.id

			left join jpool on jpj.jpool = jpool.id

			left join jpool_setting show_judges
				on show_judges.tag = 'show_judges'
				and show_judges.jpool = jpool.id

			left join jpool_setting paradigm_quiz
				on paradigm_quiz.tag = 'paradigm_quiz'
				and paradigm_quiz.jpool = jpool.id

			left join ballot on ballot.judge = judge.id and ballot.audit = 1
			left join panel on ballot.panel = panel.id

			where judge.person = ?
				and judge.category = category.id
				and category.tourn = tourn.id
				and tourn.end > NOW()

            and (
                exists (
                    select weekend.id
                        from weekend, event, event_setting cws
                    where weekend.tourn = tourn.id
                        and cws.tag = 'weekend'
                        and cws.value = weekend.id
                        and cws.event = event.id
						and event.category = category.id
                        and weekend.end > now()
                ) or not exists (
                    select weekend.id
                    from weekend
                    where weekend.tourn = tourn.id
                )
            )

			group by judge.id
			order by tourn.start
	");

	my $now = DateTime->now();
	my $nowstring = DateTime::Format::MySQL->format_datetime($now);
	$nowstring =~ s/[\D_]//g;

	$sth->execute($person->id);

	my $strike_sth = $dbh->prepare("
		select
			strike.id, strike.type,
				CONVERT_TZ(strike.start, '+00:00', tourn.tz) start,
				CONVERT_TZ(strike.end, '+00:00', tourn.tz) end,
			school.name school, entry.name entry,
			strike.registrant

		from (strike, judge, category, tourn)
			left join school on strike.school = school.id
			left join entry on strike.entry = entry.id

		where strike.judge = ?
			and strike.judge = judge.id
			and judge.category = category.id
			and category.tourn = tourn.id
	");

</%init>

	<& "/user/menu.mas",
		person => $person,
		whoami => "judgeindex"
	&>

	<div class="main">

		<h3 class="padvertless marvertno">
			Your Upcoming &amp; Present Judging
		</h3>

<%perl>

		my @quizzes;

		while (
			my (
				$judge_id, $judge_first, $judge_middle, $judge_last, $judge_code, $judge_obligation, $judge_hired,
				$school_name,
				$tourn_name, $tourn_start, $tourn_end, $tz,
				$reg_end,
				$judge_deadline,
				$weekend_id, $weekend_name, $weekend_start, $weekend_end,
				$category_id, $category_name, $category_abbr,
				$diverse,
				$nomination,
				$diversity_notice,
				$rounds_per,
				$no_codes,
				$diversity_selfie,
				$required_quizzes,
				$paradigm_quiz,
				$conflicts,
				$show_training,
				$nsda_nats,
				$jpool,
				$rounds_judged
			) = $sth->fetchrow_array()
		) {

			$strike_sth->execute($judge_id);

			my @strikes = eval {
				return @{$strike_sth->fetchall_hash()};
			};

			if ($required_quizzes) {
				my $reqs = eval {
					return JSON::decode_json($required_quizzes);
				};

				if ($reqs) {
					push @quizzes, @{$reqs};
					@quizzes = sort {$a cmp $b} @quizzes;
				}
			}

			if ($paradigm_quiz) {
				push @quizzes, $paradigm_quiz;
			}
</%perl>

			<div class="full nospace bottomalign">
				<span class="threefifths nospace bottomalign true">
					<h5 class="martopmore">
						<% $category_name %> <% $category_abbr && $category_abbr ne $category_name ? '('.$category_abbr.')' : "" %>
						at
						<% $tourn_name %>
						<% $weekend_name %>
					</h5>
				</span>

				<span class="twofifths nospace padbottom bottomalign rightalign true">

%					my $start_string = $tourn_start;
%					$start_string =~ s/[\D_]//g;
%					if ($start_string < $nowstring) {
						<a class="ltbuttonwhite bluetext"
							href="panels.mhtml"
						><span class="halfspacer"></span>Online Ballots<span class="halfspacer"></span></a>
%					} else {

						<div class="nospace centeralign padno smallish semibold italic graytext">
							Online Ballots will be available starting
								<& "/funclib/showdt.mas",
									string => $tourn_start,
									tz     => $tz,
									tzname => 1,
									length => "murica_noyear",
									at     => 'yas'
								&>
						</div>
%					}
				</span>
			</div>

			<div class="full nospace odd bluebordertop flexrow">
				<span class="half borderright marno marright flex">
					<div class="nospace padtop">
						<span class="twofifths semibold">
							Name
						</span>
						<span class="threefifths">
							<% $judge_first %>
							<% $judge_middle %>
							<% $judge_last %>
						</span>
					</div>
					<div class="nospace">
						<span class="twofifths semibold">
							Dates
						</span>
						<span class="threefifths">
%							if ($weekend_id) {
%								my $same = &same_day($weekend_start, $weekend_end);
								<& "/funclib/showdate.mas", string => $weekend_start &>
%								unless ($same) {
									&ndash; <& "/funclib/showdate.mas", string => $weekend_end &>
%								}
%							} else {
%								my $same = &same_day($tourn_start, $tourn_end);
								<& "/funclib/showdate.mas", string => $tourn_start &>
%								unless ($same) {
									&ndash; <& "/funclib/showdate.mas", string => $tourn_end &>
%								}
%							}
						</span>
					</div>

					<div class="nospace">
						<span class="twofifths semibold ">
							School
						</span>
						<span class="threefifths">
							<% $school_name ? $school_name : "Tournament Hire" %>
						</span>
					</div>

%					unless ($no_codes) {
						<div class="nospace">
							<span class="twofifths semibold ">
								Judge Code
							</span>
							<span class="threefifths">
								<% $judge_code %>
							</span>
						</div>
%					}

%					if ($rounds_judged > 0) {
						<div class="nospace">
							<span class="twofifths semibold">
								Rounds judged
							</span>
							<span class="threefifths leftalign">
								<% $rounds_judged %>
							</span>
						</div>
%					}

%					if ($rounds_per) {

%						my $short_name = $m->comp('/funclib/short_name.mas', name => $school_name);

						<div class="nospace">
							<span class="twofifths semibold smallish">
								Prelim Obligation
							</span>

							<span class="threefifths leftalign">
								<div class="full nospace">
									<% $judge_obligation %>
									<% $short_name ? "rounds for ".$short_name : "" %>
								</div>
%								if ($judge_hired) {
									<div class="full nospace padtopless">
										<% $judge_hired ? $judge_hired." hired" : "" %>
									</div>
%								}
							</span>
						</div>
%					}
				</span>

				<span class="half marno top flex">
					<div class="full nospace padtopless ltborderbottom">
						<span class="semibold biggish marno half">
							Your Conflicts
						</span>

						<span class="padno marno half rightalign">
%						if ($conflicts) {
							<a class  = "bluetext marno hover link-underline semibold"
								href  = "judge_conflicts.mhtml?judge_id=<% $judge_id %>"
								title = "Conflicts indicate schools or competitors you have a past coaching or personal relationship with and should not judge"
							>Add Conflicts</a>
%						}
						</span>
					</div>

<%perl>
					my $notfirst;

					foreach my $strike (@strikes) {

						next if $strike->{"type"} eq "entry" && ($strike->{"registrant"} < 1);
						next if $strike->{"type"} eq "school" && ($strike->{"registrant"} < 1);
</%perl>

%						if ($strike->{"type"} eq "entry") {

							<div class="full nospace smallish">
								<span class="quarter italic bluetext">
									<span class="quarterspacer"></span>
									Entry
								</span>

								<span class="threequarter">
									<% $strike->{"entry"} %>
								</span>
							</div>

%						} elsif ($strike->{"type"} eq "school") {

							<div class="full nospace smallish">
								<span class="quarter bluetext italic">
									<span class="quarterspacer"></span>
									School
								</span>

								<span class="threequarters">
									<% $strike->{"school"} %>
								</span>
							</div>

%						} elsif ($strike->{"type"} eq "departure") {

							<div class="full nospace smallish">
								<span class="quarter bluetext italic">
									<span class="quarterspacer"></span>
									Departs
								</span>

								<span class="threequarters">
									<& "/funclib/showdt.mas", string => $strike->{"start"} &>
								</span>
							</div>

%						} elsif ($strike->{"type"} eq "time") {

							<div class="full nospace smallish">
								<span class="quarter bluetext italic">
									<span class="quarterspacer"></span>
									Unavailable
								</span>

								<span class="threequarters">
									<& "/funclib/showdt.mas", string => $strike->{"start"} &>
									to <& "/funclib/showdt.mas", string => $strike->{"end"} &>
								</span>
							</div>
%						}
%					}
				</span>
			</div>

%			if ($diversity_selfie || @quizzes ) {

				<div class="padleftmore nospace">
					<h6 class="padtop">
						Additional Information for <% $tourn_name %>
					</h6>

					<span class="pagehalf">
%						if ($diversity_selfie) {
%							if ($diversity_notice) {
								<p class="explain">
									<% $diversity_notice %>
								</p>
%							}

							<div class="nospace">
								<label for="<% $judge_id %>_diverse">
									<span class="third semibold leftalign smallish">
										<span class='quarterspacer'></span>
										Do you identify as diversity enhancing?
									</span>

									<span class="sixth centeralign">
										<label class = "switch smaller marvertless">
											<input
												class         = "padsettingbox"
												type          = "checkbox"
												value         = "1"
												id            = "<% $judge_id %>_diverse"
												setting_name  = "diverse"
												target_id     = "<% $judge_id %>"
												onChange      = "postSwitch( this, 'judge_switch.mhtml');"
												<%  $diverse ? 'checked' : "" %>
											>
											<div class="<% $ARGS{"onred"} ? "onred" : "" %> slider"></div>
										</label>
									</span>
								</label>
							</div>
%						}

%						my $counter = 1;
%						if (@quizzes) {
							<p class="biggish">
								Tournament required forms &amp; questionnaires:
							</p>
%						}

%						foreach my $quiz_id (@quizzes) {

%							my $quiz = Tab::Quiz->retrieve($quiz_id);
%							my $pq = $quiz->answers(person => $person->id)->first;


							<div class="nospace padvertless ltbordertop">
								<a
									title = "Take Questionnaire"
									href  = "quiz_take.mhtml?quiz_id=<% $quiz->id %>&from=upcoming"
									class = "white nospace"
								>
									<span class="fifth centeralign nospace">
%										if ($pq && $pq->completed > 0) {
											<span class="fa fa-sm greentext fa-check" title="Completed">
											</span>
%										} else {
											<span class="fa fa-sm redtext fa-times" title="Not Completed">
											</span>
%										}
									</span>

									<span class="twothirds semibold leftalign smallish nospace">
										<span class="ninetenths marno bluetext link-underline nospace link-underline padvert">
											<% $quiz->label %>
										</span>
									</span>

									<span class="tenth rightalign nospace">
										<span class="fa fa-sm fa-file-text-o buttonwhite bluetext">
										</span>
									</span>
								</a>
							</div>
%						}
					</span>

					<span class="pagehalf">
<%perl>
						if ($nsda_nats) {

							my $deadline;

							if ($judge_deadline) {
								$deadline = eval {
									return DateTime::Format::MySQL->parse_datetime($judge_deadline);
								};
							} else {
								$deadline = eval {
									return DateTime::Format::MySQL->parse_datetime($reg_end);
								};
							}

							if ($deadline && $deadline > DateTime->now()) {
</%perl>
%								if (@quizzes) {
									<p class="biggish">
										Optional but encouraged:
									</p>
%								}

								<div class="nospace padvertless ltbordertop">
									<a
										title = "Self-Nominate"
										href  = "nats.mhtml"
										class = "white nospace"
									>
										<span class="fifth centeralign nospace">
%											if ($nomination) {
												<span class="fa fa-sm greentext fa-check" title="Completed">
												</span>
%											} else {
												<span class="fa fa-sm redtext fa-times" title="Not Completed">
												</span>
%											}
										</span>

										<span class="twothirds semibold leftalign smallish nospace">
											<span class="ninetenths marno bluetext link-underline nospace link-underline padvert">
												Late Elim Nomination
											</span>
										</span>

										<span class="tenth rightalign nospace">
											<span class="fa fa-sm fa-file-text-o buttonwhite bluetext">
											</span>
										</span>
									</a>
								</div>
%							}
%						}
					</span>
				</div>
%			}
%		}
		</div>
	</div>

<%perl>

	sub same_day  {

		my ($first, $last) = @_;

		my $first_day = substr($first, 8, 2);
		my $last_day = substr($last, 8, 2);

		if ($first_day eq $last_day) {
			return 1;
		} else {
			return;
		}
	}

</%perl>
