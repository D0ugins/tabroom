<%args>
	$person
	$judge_id => undef
	$past     => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);

	if ($judge > 0 && $judge->person && $judge->person->id != $person->id) {
		my $name = $person->last;
		$m->print("That judge is not you.  Stop messing around, $name");
		$m->abort;
	}

	my @judges = $person->judges unless $judge;
	push (@judges, $judge) if $judge;
	my $now = DateTime->now();

</%init>

	<& "/user/menu.mas",
		person => $person,
		whoami => "judgeindex"
	&>

	<div class="main">

		<h2>Your Judging</h2>

<%perl>

		foreach my $judge (@judges) {

			my $category = $judge->category;
			next unless $category;

			my %category_settings = $category->all_settings();

			my $tourn = $category->tourn;
			next unless $tourn;

			my $tz = $tourn->tz;
			$tz = "UTC" unless $tz;

			my $start = $tourn->start->set_time_zone($tz);
			my $end = $tourn->end->set_time_zone($tz);
			next unless $past || $end > $now;

			my $nats;
			my @pools;

			if ($category->tourn->setting('nsda_nats')) {
				$nats++;

				Tab::JPool->set_sql( public_by_judge => "
					select jpool.*
					from jpool, jpool_judge jpj, jpool_setting show_judges

					where jpool.category = ?
					and jpool.id = jpj.jpool
					and jpj.judge = ?
					and show_judges.jpool = jpool.id
					and show_judges.tag = 'show_judges'
				");

				@pools = Tab::JPool->search_public_by_judge($category->id, $judge->id);

			}

</%perl>

			<div class="full nospace bottomalign">

				<span class="twothirds nospace bottomalign">
					<h5 class="martopmore"><% $tourn->name %> </h5>
				</span>

				<span class="third nospace padbottom bottomalign">
					<p class="semibold bluetext rightalign bottomalign biggish nospace">
						<% $category->name %>
						(<% $category->abbr %>)
					</p>
				</span>

			</div>

			<div class="full nospace odd bluebordertop">

				<span class="pagehalf borderright marno">

					<div class="nospace">
						<span class="third semibold ">
							Name
						</span>

						<span class="twothirds ">
							<% $judge->first %>
							<% $judge->middle %>
							<% $judge->last %>
						</span>
					</div>
					<div class="nospace">
						<span class="third semibold ">
							Dates
						</span>
						<span class="twothirds ">
							<% Tab::niceshortdate($start) %>
							<% $start->day != $end->day
								? " - ".Tab::niceshortdate($end)
								: ""
							%>/<% $start->year %>
						</span>
					</div>

					<div class="nospace">
						<span class="third semibold ">
							School
						</span>
						<span class="twothirds ">
							<% $judge->school > 0 ? $judge->school->short_name : "Hired" %>
						</span>
					</div>


%					unless ($category_settings{"no_codes"}) {
						<div class="nospace">
							<span class="third semibold ">
								Judge Code
							</span>
							<span class="twothirds">
								<% $judge->code %>
							</span>
						</div>
%					}

%					if ($start < $now) {
						<div class="nospace">
							<span class="third semibold">
								Debates judged
							</span>
							<span class="half leftalign">
								<% scalar $m->comp("/funclib/judge_panels.mas", judge => $judge) %>
							</span>
						</div>
%					}

%					if ($category_settings{"rounds_per"}) {

						<div class="nospace">
							<span class="third semibold">
								Round Obligation
							</span>

							<span class="half leftalign">
								<% $judge->obligation %>
								<% $judge->school > 0 ? "for ".$judge->school->short_name : "" %>
							</span>

							<span class="sixth">
								<% $judge->hired ? "+ ".$judge->hired." hired" : "" %>
							</span>
						</div>
%					}

				</span><span class="pagehalf borderleft marno" style="margin-left: -1px !important;">

%					if ($end > $now && $category_settings{"diversity_selfie"}) {
%						if ($category_settings{"diversity_notice"}) {
							<p class="explain">
								<% $category_settings{"diversity_notice"} %>
							</p>
%						}

						<div class="nospace ltborderbottom">
							<label for="<% $judge->id %>_diverse">
								<span class="fourfifths semibold centeralign">
									Identify as diversity enhancing?
								</span>

								<span class="sixth centeralign">
									<label class = "switch smaller">
										<input
											class         = "padsettingbox"
											type          = "checkbox"
											value         = "1"
											id            = "<% $judge->id %>_diverse"
											setting_name  = "diverse"
											target_id     = "<% $judge->id %>"
											onChange      = "postSwitch( this, 'judge_switch.mhtml');"
											<%  $judge->setting("diverse") ? 'checked' : "" %>
										>
										<div class="<% $ARGS{"onred"} ? "onred" : "" %> slider"></div>
									</label>
								</span>
							</label>
						</div>
%					}

%					if ($category_settings{"paradigm_form"}) {
						<div class="nospace centeralign padvert">
							<a
								class = "half ltbuttonwhite bluetext"
								href  = "paradigm_form.mhtml?judge_id=<% $judge->id %>"
							>Paradigm Form</a>
						</div>
%					}

%					if ($category_settings{"conflicts"}) {
%						if ($now > $category_settings{"strike_start"}) {
							<div class="nospace centeralign padvert">
								<a class="half ltbuttonwhite bluetext"
									href="judge_conflicts.mhtml?judge_id=<% $judge->id %>"
								>Enter Conflicts</a>
							</div>
<%perl>
						}
					}

					if ($nats) {

						my $nationals = $m->comp("/funclib/current_nationals.mas");
						if ($nationals->reg_end > $now) {
</%perl>
							<div class="nospace centeralign padvert">
								<a class="half ltbuttonwhite bluetext"
									href="nats.mhtml"
								>Self-nominate to late elims or finals</a>
							</div>
%						}

						<div class="nospace centeralign padvert">
							<a class="half ltbuttonwhite bluetext"
								href="nats.mhtml"
							>NSDA Diversity &amp Paradigm Forms</a>
						</div>
<%perl>
					}

					if (
						$category_settings{"show_training"}
						|| $m->comp("/funclib/person_panels.mas",
							person => $person,
							judge => $judge
						)
						|| $m->comp("/funclib/person_published.mas",
							person => $person,
							judge => $judge
						)
					) {
</%perl>
						<div class="nospace centeralign padvert">
							<a class="half ltbuttonwhite bluetext"
								href="panels.mhtml"
							>Online Ballots</a>
						</div>
%					} elsif (@pools) {
						<div class="nospace centeralign padvert">
							<a class="half ltbuttonwhite bluetext"
								href="panels.mhtml"
							>Assignments</a>
						</div>
%					}
				</span>
			</div>
%		}
	</div>

