<%args>
	$person
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("

		select
			judge.id, judge.first, judge.middle, judge.last, judge.code, judge.obligation, judge.hired,
			school.name,
			tourn.name, tourn.start, tourn.end,
			weekend.id, weekend.name, weekend.start, weekend.end,
			category.id, category.name, category.abbr,
			diverse.value,
			diversity_notice.value_text,
			rounds_per.value,
			no_codes.value,
			diversity_selfie.value,
			paradigm_form.value,
			conflicts.value,
			show_training.value,
			nsda_nats.value,
			show_judges.id,
			count(distinct panel.id)

		from (judge, category, tourn)

			left join school on school.id = judge.school

			left join judge_setting diverse
				on diverse.judge = judge.id
				and diverse.tag = 'diverse'

			left join event on event.category = category.id

			left join event_setting cws
				on cws.tag = 'weekend'
				and cws.event = event.id

			left join weekend
				on cws.value = weekend.id
				and weekend.tourn = tourn.id

			left join category_setting diversity_notice
				on diversity_notice.category = category.id
				and diversity_notice.tag = 'diversity_notice'

			left join category_setting rounds_per
				on rounds_per.category = category.id
				and rounds_per.tag = 'rounds_per'

			left join category_setting no_codes
				on no_codes.category = category.id
				and no_codes.tag = 'no_codes'

			left join category_setting diversity_selfie
				on diversity_selfie.category = category.id
				and diversity_selfie.tag = 'diversity_selfie'

			left join category_setting paradigm_form
				on paradigm_form.category = category.id
				and paradigm_form.tag = 'paradigm_form'

			left join category_setting conflicts
				on conflicts.category = category.id
				and conflicts.tag = 'conflicts'

			left join category_setting show_training
				on show_training.category = category.id
				and show_training.tag = 'show_training'

			left join tourn_setting nsda_nats
				on nsda_nats.tourn = tourn.id
				and nsda_nats.tag = 'nsda_nats'

			left join jpool_judge jpj
				on jpj.judge = judge.id

			left join jpool on jpj.jpool = jpool.id

			left join jpool_setting show_judges
				on show_judges.tag = 'show_judges'
				and show_judges.jpool = jpool.id

			left join ballot on ballot.judge = judge.id and ballot.audit = 1
			left join panel on ballot.panel = panel.id

			where judge.person = ?
				and judge.category = category.id
				and category.tourn = tourn.id
				and tourn.end > NOW()

            and (
                exists (
                    select weekend.id
                        from weekend, event, event_setting cws
                    where weekend.tourn = tourn.id
                        and cws.tag = 'weekend'
                        and cws.value = weekend.id
                        and cws.event = event.id
						and event.category = category.id
                        and weekend.end > now()
                ) or not exists (
                    select weekend.id
                    from weekend
                    where weekend.tourn = tourn.id
                )
            )

			group by judge.id
			order by tourn.start
	");

	$sth->execute($person->id);

</%init>

	<& "/user/menu.mas",
		person => $person,
		whoami => "judgeindex"
	&>

	<div class="main">

		<h2>Upcoming &amp; Present Judging</h2>

<%perl>

		while (
			my (
				$judge_id, $judge_first, $judge_middle, $judge_last, $judge_code, $judge_obligation, $judge_hired,
				$school_name,
				$tourn_name, $tourn_start, $tourn_end,
				$weekend_id, $weekend_name, $weekend_start, $weekend_end,
				$category_id, $category_name, $category_abbr,
				$diverse,
				$diversity_notice,
				$rounds_per,
				$no_codes,
				$diversity_selfie,
				$paradigm_form,
				$conflicts,
				$show_training,
				$nsda_nats,
				$jpool,
				$rounds_judged
			) = $sth->fetchrow_array()
		) {

</%perl>

			<div class="full nospace bottomalign">
				<span class="twothirds nospace bottomalign">
					<h5 class="martopmore"><% $tourn_name %> </h5>
				</span>

				<span class="third nospace padbottom bottomalign">
					<p class="semibold bluetext rightalign bottomalign biggish nospace">
						<% $weekend_name %>
						<% $category_name %>
						<% $category_abbr ? '('.$category_abbr.')' : "" %>
					</p>
				</span>
			</div>

			<div class="full nospace odd bluebordertop">

				<span class="pagehalf borderright marno">

					<div class="nospace">
						<span class="third semibold ">
							Name
						</span>

						<span class="twothirds ">
							<% $judge_first %>
							<% $judge_middle %>
							<% $judge_last %>
						</span>
					</div>
					<div class="nospace">
						<span class="third semibold ">
							Dates
						</span>
						<span class="twothirds ">
%							if ($weekend_id) {
%								my $same = &same_day($weekend_start, $weekend_end);
								<& "/funclib/showdate.mas", string => $weekend_start &>
%								unless ($same) {
									&ndash; <& "/funclib/showdate.mas", string => $weekend_end &>
%								}
%							} else {
%								my $same = &same_day($tourn_start, $tourn_end);
								<& "/funclib/showdate.mas", string => $tourn_start &>
%								unless ($same) {
									&ndash; <& "/funclib/showdate.mas", string => $tourn_end &>
%								}
%							}
						</span>
					</div>

					<div class="nospace">
						<span class="third semibold ">
							School
						</span>
						<span class="twothirds ">
							<% $school_name ? $school_name : "Tournament Hire" %>
						</span>
					</div>

%					unless ($no_codes) {
						<div class="nospace">
							<span class="third semibold ">
								Judge Code
							</span>
							<span class="twothirds">
								<% $judge_code %>
							</span>
						</div>
%					}

%					if ($rounds_judged > 0) {
						<div class="nospace">
							<span class="third semibold">
								Rounds judged
							</span>
							<span class="half leftalign">
								<% $rounds_judged %>
							</span>
						</div>
%					}

%					if ($rounds_per) {

%						my $short_name = $m->comp('/funclib/short_name.mas', name => $school_name);

						<div class="nospace">
							<span class="third semibold">
								Round Obligation
							</span>

							<span class="half leftalign">
								<% $judge_obligation %>
								<% $short_name ? "for ".$short_name : "" %>
							</span>

							<span class="sixth">
								<% $judge_hired ? $judge_hired." hired" : "" %>
							</span>
						</div>
%					}

				</span><span class="pagehalf borderleft marno" style="margin-left: -1px !important;">

%					if ($diversity_selfie) {

%						if ($diversity_notice) {
							<p class="explain">
								<% $diversity_notice %>
							</p>
%						}

						<div class="nospace ltborderbottom">
							<label for="<% $judge_id %>_diverse">
								<span class="fourfifths semibold centeralign">
									Identify as diversity enhancing?
								</span>

								<span class="sixth centeralign">
									<label class = "switch smaller">
										<input
											class         = "padsettingbox"
											type          = "checkbox"
											value         = "1"
											id            = "<% $judge_id %>_diverse"
											setting_name  = "diverse"
											target_id     = "<% $judge_id %>"
											onChange      = "postSwitch( this, 'judge_switch.mhtml');"
											<%  $diverse ? 'checked' : "" %>
										>
										<div class="<% $ARGS{"onred"} ? "onred" : "" %> slider"></div>
									</label>
								</span>
							</label>
						</div>
%					}

%					if ($paradigm_form) {
						<div class="nospace centeralign padvert">
							<a
								class = "half ltbuttonwhite bluetext"
								href  = "paradigm_form.mhtml?judge_id=<% $judge_id %>"
							>Paradigm Form</a>
						</div>
%					}

%					if ($conflicts) {
						<div class="nospace centeralign padvert">
							<a class="half ltbuttonwhite bluetext"
								href="judge_conflicts.mhtml?judge_id=<% $judge_id %>"
							>Check/Enter Conflicts</a>
						</div>
<%perl>
					}

					if ($nsda_nats) {

						my $nationals = $m->comp("/funclib/current_nationals.mas");
						if ($nationals->reg_end > DateTime->now()) {
</%perl>
							<div class="nospace centeralign padvert">
								<a class="half ltbuttonwhite bluetext"
									href="nats.mhtml"
								>Self-nominate to late elims or finals</a>
							</div>
%						}

						<div class="nospace centeralign padvert">
							<a class="half ltbuttonwhite bluetext"
								href="nats.mhtml"
							>NSDA Diversity &amp Paradigm Forms</a>
						</div>
<%perl>
					}

</%perl>
					<div class="nospace centeralign padvert">
						<a class="half ltbuttonwhite bluetext"
							href="panels.mhtml"
						>Online Ballots</a>
					</div>

				</span>
			</div>
%		}
	</div>

<%perl>

	sub same_day  {

		my ($first, $last) = @_;

		my $first_day = substr($first, 8, 2);
		my $last_day = substr($last, 8, 2);

		if ($first_day eq $last_day) {
			return 1;
		} else {
			return;
		}
	}

</%perl>
