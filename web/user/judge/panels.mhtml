<%args>
	$person
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();
	my $sth;

	my @ballot_panels = $m->comp(
		"/funclib/person_panels.mas",
		person => $person
	);

	my @list_panels = $m->comp(
		"/funclib/person_panels.mas",
		person   => $person,
		listonly => 1
	);

	my %panels_done = ();
	my $now = DateTime->now();

	$sth = $dbh->prepare("
		select judge.id, judge.code, judge.first, judge.last,
			category.id, category.abbr, category.name,
			tourn.id, tourn.name,
			training_label.value,
			training_room.value,
			training_time.value

		from (judge, category, tourn, category_setting cs)

		left join category_setting training_label
			on training_label.category = category.id
			and training_label.tag = 'training_label'

		left join category_setting training_room
			on training_room.category = category.id
			and training_room.tag = 'training_room'

		left join category_setting training_time
			on training_time.category = category.id
			and training_time.tag = 'training_time'

		left join event on event.category = category.id

		where judge.person = ?
			and (judge.category = category.id
				or judge.alt_category = category.id)
			and category.id = cs.category
			and cs.tag = 'show_training'

			and category.tourn = tourn.id
			and tourn.start < now()
			and tourn.end > now()
			and tourn.id > 10000

		and not exists (
			select js.id
			from judge_setting js
			where js.judge = judge.id
			and js.tag = 'ballot_trained'
		)

		group by judge.id
	");

	my %trainings = ();
	$sth->execute($person->id);

	while (
		my (
			$judge_id, $judge_code, $judge_first, $judge_last,
				$category_id, $category_abbr, $category_name,
				$tourn_id, $tourn_name,
				$training_label, $training_room, $training_time,
				$event_id, $event_abbr, $event_type
		) = $sth->fetchrow_array()
	) {
		$trainings{$judge_id}{"code"} = $judge_code;
		$trainings{$judge_id}{"first"} = $judge_first;
		$trainings{$judge_id}{"last"} = $judge_last;
		$trainings{$judge_id}{"category_id"} = $category_id;
		$trainings{$judge_id}{"category_abbr"} = $category_abbr;
		$trainings{$judge_id}{"category_name"} = $category_name;
		$trainings{$judge_id}{"training_label"} = $training_label;
		$trainings{$judge_id}{"training_room"} = $training_room;
		$trainings{$judge_id}{"training_time"} = $training_time;

		$trainings{$judge_id}{"event_id"} = $event_id;
		$trainings{$judge_id}{"event_abbr"} = $event_abbr;
		$trainings{$judge_id}{"event_type"} = $event_type;
	}

</%init>

	<&
		"/user/menu.mas",
		person => $person
	&>

	<div class="main">

%		if (@ballot_panels || @list_panels || (keys %trainings)) {

			<h3>
				Online Ballots
			</h3>

			<&
				"/funclib/tablesorter.mas",
				table => "pendingrounds"
			&>

			<span class="half">
				<h5 class="nospace">Upcoming Rounds</h5>
			</span>

			<span
				id    = "pendingrounds_buttonarea"
				class = "half rightalign">
			</span>

			<table id="pendingrounds">

				<thead>

					<tr class="yellowrow">

						<th class="smaller">
							Round
						</th>

						<th class="smaller">
							Room
						</th>

						<th class="smaller">
							Starts
						</th>

						<th class="smaller">
							Entries
						</th>

						<th class="smaller">
						</th>

					</tr>
				</thead>
				<tbody>
<%perl>

		}

		if (keys %trainings) {
			$m->print('<h5 class="centeralign">Training &amp; Orientation</h5>');
		}

		foreach my $id (
			sort {
				$trainings{$a}{"training_label"} cmp $trainings{$b}{"training_label"}
			} keys %trainings
		) {

			$trainings{$id}{"training_label"} = "Judge Training" unless $trainings{$id}{"training_label"};
			$trainings{$id}{"training_room"}  = "Room TBA" unless $trainings{$id}{"training_room"};
</%perl>
			<tr>

				<td class="">
					<% $trainings{$id}{"training_label"} %>
				</td>

				<td class="semibold bluetext">
					<% $trainings{$id}{"training_room"} %>
				</td>

				<td class="centeralign semibold redtext">
					<% $trainings{$id}{"training_time"} %>
				</td>

				<td class="leftalign">
%					if ($trainings{$id}{"event_type"} eq "debate") {
						<div class="leftalign full">
							AFF: TEAM 9999
						</div>
						<div class="leftalign full">
							NEG: TEAM 8888
						</div>

%					} else {
%						foreach my $order (1 .. 6) {
							<span class="fifth leftalign">
								<% $trainings{$id}{"event_type"} eq "speech" ? $order."." : "" %>
								<% $order.$order.$order.$order %>
							</span>
%						}
%					}

				</td>

				<td class="centeralign padless">
					<a
						class="greentext buttonwhite invert"
						href="training.mhtml?sample=1&event_id=<% $trainings{$id}{"event_id"} %>&judge_id=<% $id %>"
					>
						START ROUND
					</a>
				</td>
			</tr>
<%perl>
		}

		foreach my $panel (@ballot_panels) {

			my $round = $panel->round;
			my $event = $round->event;
			my $tourn = $event->tourn;

			my $legion = $tourn->setting('legion');

	   		my $no_side_constraints++
				if $event->setting('no_side_constraints');

			my $sidelocks++
				if ($round->type eq "elim"
					|| $round->type eq "final"
					|| $round->type eq "runoff"
				) && not defined $no_side_constraints;

			my $locked =  $m->comp(
				"/funclib/round_elim_dueaff.mas",
				panel => $panel
			) if $sidelocks;

			my $tz = $event->tourn->tz;
			$tz = "UTC" unless $tz;

			$panels_done{$panel->id}++;

			next unless $panel
				&& $round
				&& ($round->published || $round->setting("judges_ballots_visible") );

			my $judge = Tab::Judge->retrieve($panel->judge);

			my $aff_string = $event->setting("aff_label");
			my $neg_string = $event->setting("neg_label");

			my $online_mode = $event->setting("online_mode");

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my @entries = sort {$a->side <=> $b->side} $m->comp(
				'/funclib/panel_entries.mas',
					panel    => $panel,
					no_drops => 1
			);

			my @scores = $m->comp(
				'/funclib/panel_scores.mas',
					panel => $panel,
					judge => $judge
			);

			my $chair;
			my $started;

			foreach my $ballot ($panel->ballots( judge => $judge)) {
				$chair++ if $ballot->chair;
				$started = $ballot->judge_started();
			}

			my $scored;

			foreach my $score (@scores) {
				$scored++ if $score->value;
			}

</%perl>
			<tr>

				<td class="">

					<span class="hidden">
						<% $round->name %>-<% $panel->flight %>
					</span>

					<a
						class="white padless full"
						href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
					>
						<% $event->abbr %> <% $round->realname %>
					</a>

%					my $flight_offset;
%					if ($round->flighted > 1) {
%						$flight_offset = $event->setting("flight_offset");
%						$flight_offset = $flight_offset * ($panel->flight - 1);
						<a
							class="white padless full"
							href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
						>
							Flight <% $panel->flight %>
						</a>
%					}

				</td>

				<td class="semibold bluetext centeralign">
%					if ($online_mode && $online_mode ne "async") {
						<& "/funclib/online_room.mas",
							panel  => $panel,
							person => $person,
							show   => 1
						&>
%					} elsif ($online_mode) {

%					} else {
						<% $panel->room ? $panel->room->name : "No Room Listed" %>
%					}
				</td>

				<td class="centeralign semibold redtext">
<%perl>
					my $start = $round->start_time;
					$start = $round->timeslot->start unless $start;
					$start = $start->set_time_zone($tz);
					$start->add( minutes => $flight_offset ) if $flight_offset;
</%perl>
					<% $start->day_abbr %>
					<% Tab::nicetime($start)." ".Tab::tzname($tz) %>
				</td>
<%perl>
				my $length;

				foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {
					$length = length($entry->code) if $length < length($entry->code);
				}

				my $spansize = "eighth";
				$spansize = "sixth" if $length > 4;
				$spansize = "fifth" if $length > 8;
				$spansize = "quarter" if $length > 10;
				$spansize = "third" if $length > 16;

</%perl>

				<td class="leftalign">

%				unless ($legion) {
%					if ($event->type eq "speech") {
%						foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {
							<span class="<% $spansize %> leftalign">
								<% $event->type eq "speech" ? $entry->speaks."." : "" %>
								<% $entry->code %>
							</span>
%						}
%					} elsif ($event->type eq "congress") {

						<span class="semibold">Chamber <% $panel->letter %></span>

%					} else {
%						foreach my $entry (@entries) {

							<div class="leftalign">

%								unless ($event->type eq "congress") {
									<span class="quarter">
%										if ($event->type eq "wudc") {
											<% $entry->speaks == 1 ? "1G" : "" %>
											<% $entry->speaks == 2 ? "1O" : "" %>
											<% $entry->speaks == 3 ? "2G" : "" %>
											<% $entry->speaks == 4 ? "2O" : "" %>
%										} elsif ($sidelocks && not defined $locked) {
											<% $entry->side
												? $entry->side == 1
													? "Flip for" : "Sides"
												: ""
											%>
%										} else {
											<% $entry->side
												? $entry->side == 1
													? $aff_string : $neg_string
												: ""
											%>
%										}
									</span>

									<span class="threequarter nowrap">
%								}  else {
									<span class="full nowrap padless marno">
<%perl>
								}

								if ($event->type eq "wudc" || $event->type eq "wsdc") {
   									$m->print($entry->code);
								} else {
   									$m->print($entry->name);
								}
</%perl>
								</span>

							</div>
%						}
%					}
%				}
				</td>

				<td class="centeralign padless">

%					if ($legion) {

%						if ($started) {
							<a
								class="bluetext invert buttonwhite"
								href="legion_ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							>BALLOT</a>

%						} elsif ($scored) {
							<a
								class="redtext buttonwhite invert"
								href="legion_confirm.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							>CONFIRM</a>
%						} else {
							<a
								class="greentext buttonwhite invert"
								href="legion_ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							>Scores</a>
%						}

						<a
							class  = "bluetext buttonwhite invert marleftmore"
							target = "_blank"
							href="legion_comments.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
						>Feedback</a>

%					} elsif ($event->type eq "wudc" &! $chair) {

						Panelist Judge <br /> (only Chairs enter ballots)

%					} else {

%						if ($chair) {
%							if ($event->type eq "congress") {
								<p class="explain marno padless">
									Parliamentarian
								</p>
%							} else {
								<p class="explain marno padless">
									Please Chair this round
								</p>
%							}
%						}

%						if ($started) {

							<a
								class="bluetext invert buttonwhite"
								href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">

								BALLOT
							</a>

%						} elsif ($scored) {

							<a
								class="redtext buttonwhite invert"
								href="re_confirm.mhtml?panel_id=<% $scored %>&judge_id=<% $judge %>">
								CONFIRM
							</a>
%						} elsif ($panel > 0 && $judge > 0)  {
							<a
								class="greentext buttonwhite invert"
								href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">

								START ROUND
							</a>
%						}
%					}

				</td>
			</tr>

<%perl>
			if ( ($event->type eq "wudc"
				|| $event->type eq "wsdc")
				&& $round->published == 3
			) {
</%perl>
				<tr>

					<td>
						<span class="hidden">
						<% $round->name %><% $panel->flight %>
						</span>
					</td>

					<th class="">
						Motion:
					</td>

					<td colspan="3">
						<% $round->setting("motion") %>
					</td>
				</tr>
%			}
%		}

<%perl>

		my $last_round;

		foreach my $panel (@list_panels) {

			my $round = $panel->round;
			$panels_done{$panel->id}++;

			next unless $panel && $round && $round->published;

			my $event = $round->event;
			my $judge = Tab::Judge->retrieve($panel->judge);
			my $tourn = $event->tourn;
			my $legion = $tourn->setting('legion');

			my $aff_string = $event->setting("aff_label");
			my $neg_string = $event->setting("neg_label");

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my @entries = sort {$a->side <=> $b->side} $m->comp(
				'/funclib/panel_entries.mas',
				panel => $panel
			);

			my $key = $round->id."-".$panel->flight;

</%perl>
			<tr class="<% $last_round && $last_round ne $key ? "bordertop" : "" %>">

				<td class="padless">

					<span class="hidden">
						<% $round->name %><% $panel->flight %>
					</span>

					<a
						class="white padless full"
						href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
					>
						<% $event->abbr %> <% $round->realname %>
					</a>

%					if ($round->flighted > 1) {
						<a
							class="white padless full marno border"
							href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
						>
							Flight <% $panel->flight %>
						</a>
%					}

				</td>

				<td class="">
					<% $panel->room ? $panel->room->name : "No Room Listed" %>
				</td>

				<td class="">
					<% Tab::nicetime($round->timeslot->start->set_time_zone($tourn->tz)) %>
				</td>

				<td class="">
<%perl>

					if ($event->type eq "speech" || $event->type eq "congress") {

						foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {

							my $spansize = "third";

							$spansize = "eighth"
								if ($event->setting('code_style') eq "numbers"
								|| $event->setting('code_style') eq "school_number");

</%perl>

							<span class="<% $spansize %>">
%								if ($legion) {
									<% $entry->speaks %>
%								} else {
									<% $event->type eq "speech" ? $entry->speaks."." : "" %>
									<% $entry->code %>
%								}
							</span>
%						}

%					} else {

%						foreach my $entry (@entries) {

							<div>
								<span class="quarter">
%									if ($event->type eq "wudc") {
										<% $entry->speaks == 1 ? "1G" : "" %>
										<% $entry->speaks == 2 ? "1O" : "" %>
										<% $entry->speaks == 3 ? "2G" : "" %>
										<% $entry->speaks == 4 ? "2O" : "" %>
%									} elsif ($event->type eq "congress") {

%									} else {
										<% $entry->side ? $entry->side == 1 ? $aff_string : $neg_string : "" %>
%									}
								</span>

								<span class="threequarter">
<%perl>
									if (
										$event->type eq "wudc"
										|| $event->type eq "wsdc"
									) {

</%perl>
										<% $entry->code %>
%									} else {
										<% $entry->name %>
%									}
								</span>

							</div>
%						}
%					}
				</td>

				<td>
				</td>

			</tr>

%			$last_round = $round->id."-".$panel->flight;
%		}

%		if (@ballot_panels || @list_panels || (keys %trainings)) {
			</tbody>
			</table>
%		}
<%perl>

		$sth = $dbh->prepare("
			select
				tourn.id, tourn.name,
				judge.id, judge.code,
				category.id, category.abbr,
				school.name, school.id,
				online_rooms.value_text

			from (tourn, judge, category)

				left join tourn_setting online_rooms
					on online_rooms.tourn = tourn.id
					and online_rooms.tag = 'online_rooms'

				left join school on school.id = judge.school

			where judge.person = ?
				and judge.category = category.id
				and category.tourn = tourn.id

				and exists (
					select event.id
					from event, event_setting online_mode
					where event.category = category.id
					and event.id = online_mode.event
					and online_mode.tag = 'online_mode'
					and online_mode.value in ('nsda_jitsi', 'nsda_public')
				)
			and tourn.end > now()
		");

		$sth->execute($person->id);

		my %rooms;

		while (
			my (
				$tourn_id, $tourn_name,
				$judge_id, $judge_code,
				$category_id, $category_abbr, $school_name, $school_id,
				$online_rooms
			) = $sth->fetchrow_array()
		) {

			if ($school_id) {
				$rooms{$tourn_id}{"school"}{"id"} = $school_id;
				$rooms{$tourn_id}{"school"}{"name"} = $school_name." Squad Room";
			}

			my @local_rooms = eval{
				return @{JSON::decode_json($online_rooms)};
			};

			if (@local_rooms) {
				foreach my $room (@local_rooms) {
					if (
						$room->{access} eq "judge"
						&& (
							(not defined $room->{category_id})
							|| $room->{category_id} == $category_id
						)
					) {
						$rooms{$tourn_id}{"judge"}{$room->{id}}{name} = $room->{"name"};
						$rooms{$tourn_id}{"judge"}{$room->{id}}{thing} = $room;
					}
				}
			}
		}

		if (keys %rooms) {
</%perl>
			<h5 class="martopmore">Online Spaces</h5>

			<div class="ltbordervert odd full">

%			foreach my $tourn_id (sort keys %rooms) {
%				if ($rooms{$tourn_id}{"school"}) {
					<span class="third nospace">
						<span class="threequarters semibold bluetext rightalign">
							<% $rooms{$tourn_id}{"school"}{"name"} %>:
						</span>
						<span class="quarter nospace centeralign">
							<& "/funclib/online_room.mas",
								school => $rooms{$tourn_id}{"school"}{"id"},
								person => $person,
								show   => 1
							&>
						</span>
					</span>
%				}
%				foreach my $room_id (keys %{$rooms{$tourn_id}{"judge"}}) {
					<span class="third nospace">
						<span class="threequarters semibold bluetext rightalign">
							<% $rooms{$tourn_id}{"judge"}{$room_id}{"name"} %>:
						</span>
						<span class="quarter nospace centeralign">
							<& "/funclib/online_room.mas",
								util   => $rooms{$tourn_id}{"judge"}{$room_id}{"thing"},
								person => $person,
								show   => 1
							&>
						</span>
					</span>
%				}
%			}

			</div>

<%perl>

		}

		$sth = $dbh->prepare("

			select
				jpool.id, jpool.name,
				message.value_text,
				judge_sheet_notice.value_text,
				event.id, event.abbr, event.name,
				round.id, round.label, round.name

			from (judge, jpool, jpool_judge, jpool_setting show_judges, category, tourn)

				left join jpool_setting message
					on message.tag = 'message'
					and message.jpool = jpool.id

				left join category_setting judge_sheet_notice
					on judge_sheet_notice.category = category.id
					and judge_sheet_notice.tag = 'judge_sheet_notice'

				left join jpool_round jpr
					on jpr.jpool = jpool.id

				left join round on round.id = jpr.round
				left join event on event.id = round.event

			where judge.person = ?
				and jpool_judge.judge = judge.id
				and jpool_judge.jpool = jpool.id
				and jpool.id = show_judges.jpool
				and show_judges.tag = 'show_judges'
				and jpool.category = category.id
				and category.tourn = tourn.id

				and tourn.end > now()

			order by jpool.name
		");

		$sth->execute($person->id);

		my %jpools;

		while (
			my (
				$jpool_id, $jpool_name,
				$message,
				$judge_sheet_notice,
				$event_id, $event_abbr, $event_name,
				$round_id, $round_label, $round_name
			) = $sth->fetchrow_array()
		) {

			unless ($jpools{$jpool_id}{"name"}) {
				$jpools{$jpool_id}{"name"}    = $jpool_name;
				$jpools{$jpool_id}{"message"} = $message;
				$jpools{$jpool_id}{"notice"}  = $judge_sheet_notice;
			}

			$jpools{$jpool_id}{"rounds"}{$round_id}{"event"} = $event_id;
			$jpools{$jpool_id}{"rounds"}{$round_id}{"event_abbr"} = $event_abbr;
			$jpools{$jpool_id}{"rounds"}{$round_id}{"event_name"} = $event_name;

			$jpools{$jpool_id}{"rounds"}{$round_id}{"number"} = $round_name;

			if ($round_label) {
				$jpools{$jpool_id}{"rounds"}{$round_id}{"name"} = $round_label;
			} else {
				$jpools{$jpool_id}{"rounds"}{$round_id}{"name"} = "Round ".$round_name;
			}
		}

		if (keys %jpools) {

			$m->print("<h5 class='martop'>Pools</h5>");
			my $notfirst;

			foreach my $id (
				sort {$jpools{$a}{"name"} cmp $jpools{$b}{"name"}} keys %jpools
			) {

				unless ($notfirst++) {
					if ($jpools{$id}{"notice"}) {
						$m->print("<p>".$jpools{$id}{"notice"}."</p>");
					}
				}
</%perl>
				<div class="row">
					<div class='full nospace ltborderbottom'>
						<span class="third padsetting semibold bigger">
							<% $jpools{$id}{"name"} %>
						</span>
						<span class="twothirds">
							<% $jpools{$id}{"message"} %>
						</span>
					</div>

					<span class="full">
<%perl>
						foreach my $round_id (
							sort {
								$jpools{$id}{"rounds"}{$a}{"event_abbr"} cmp $jpools{$id}{"rounds"}{$b}{"event_abbr"}
								|| $jpools{$id}{"rounds"}{$a}{"number"} <=> $jpools{$id}{"rounds"}{$b}{"number"}
							} keys %{$jpools{$id}{"rounds"}}
						) {
</%perl>
							<span class='quarter padless marno'>
								<% $jpools{$id}{"rounds"}{$round_id}{"event_abbr"} %>
								<% $jpools{$id}{"rounds"}{$round_id}{"name"} %>
							</span>
%						}
					</span>

				</div>
%			}
%		}

<%perl>

		$sth = $dbh->prepare("

			select
				judge.id, judge.code, judge.first, judge.last,
				event.id, event.abbr, event.name, event.type,
				round.id, round.name, round.label, round.flighted,

				panel.id, panel.letter, panel.flight,

				ballot.id, ballot.audit, ballot.side, ballot.speakerorder,
				entry.id, entry.name, entry.code,

				score.id, score.tag, score.value,
				student.id, student.first, student.last,
				tourn.id, tourn.name,
				aff_label.value, neg_label.value,
				legion.value

			from (judge, ballot, panel, round, event, entry, score, tourn)

				left join student on score.student = student.id

				left join event_setting aff_label
					on aff_label.event = event.id
					and aff_label.tag = 'aff_label'

				left join event_setting neg_label
					on neg_label.event = event.id
					and neg_label.tag = 'neg_label'

				left join tourn_setting legion
					on legion.tourn = tourn.id
					and legion.tag = 'legion'

			where judge.person = ?
				and judge.id = ballot.judge
				and ballot.audit = 1
				and ballot.panel = panel.id
				and panel.round = round.id
				and round.event = event.id
				and event.tourn = tourn.id

				and ballot.entry = entry.id
				and ballot.id = score.ballot

				and score.tag in ('winloss', 'rank', 'point', 'title', 'speech')
				and tourn.end > now()

			group by score.id
			order by event.abbr, round.name, ballot.side, ballot.speakerorder, score.speech
		");

		$sth->execute($person->id);

		my %results;

		while (
			my (
				$judge_id, $judge_code, $judge_first, $judge_last,
				$event_id, $event_abbr, $event_name, $event_type,
				$round_id, $round_name, $round_label, $round_flighted,

				$panel_id, $panel_letter, $panel_flight,

				$ballot_id, $ballot_audit, $ballot_side, $ballot_speakerorder,
				$entry_id, $entry_name, $entry_code,

				$score_id, $score_tag, $score_value,
				$student_id, $student_first, $student_last,
				$tourn_id, $tourn_name,
				$aff_label, $neg_label, $legion
			) = $sth->fetchrow_array()
		) {

			unless ($results{$judge_id}{$panel_id}{"round_name"}) {

				$results{$judge_id}{$panel_id}{"legion"} = $legion;

				$results{$judge_id}{$panel_id}{"round_name"} = $round_name;
				$results{$judge_id}{$panel_id}{"flight"} = $panel_flight;
				$results{$judge_id}{$panel_id}{"flighted"} = $round_flighted;
				$results{$judge_id}{$panel_id}{"letter"} = $panel_letter;

				if ($round_label) {
					$results{$judge_id}{$panel_id}{"round_label"} = $round_label;
				} else {
					$results{$judge_id}{$panel_id}{"round_label"} = "Round ".$round_name;
				}

				$results{$judge_id}{$panel_id}{"event_id"} = $event_id;
				$results{$judge_id}{$panel_id}{"event_name"} = $event_name;
				$results{$judge_id}{$panel_id}{"event_abbr"} = $event_abbr;
				$results{$judge_id}{$panel_id}{"event_type"} = $event_type;
			}

			unless ($results{$judge_id}{$panel_id}{"entries"}{$entry_id}) {
				$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{"code"} = $entry_code;
				$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{"name"} = $entry_name;

				if ($ballot_speakerorder) {
					$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{"order"} = $ballot_speakerorder;
				}

				if ($ballot_side) {
					$aff_label = "Aff" unless $aff_label;
					$neg_label = "Neg" unless $neg_label;

					$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{"raw_side"} = $ballot_side;

					if ($ballot_side == 1) {
						$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{"side"} = $aff_label;
					} elsif ($ballot_side == 2) {
						$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{"side"} = $neg_label;
					}
				}
			}

			if ($score_tag eq "winloss") {
				if ($score_value == 1) {
					$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{$score_tag} = "W";
				} else {
					$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{$score_tag} = "L";
				}
			} elsif ($score_tag eq "speech") {

				if ($results{$judge_id}{$panel_id}{"entries"}{$entry_id}{$score_tag}) {
					$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{$score_tag} .= ",";
				}
				$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{$score_tag} .= $score_value;

			} else {

				if ($student_id) {
					$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{$score_tag}{students}{$student_id}{name} = $student_first." ".$student_last;
					$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{$score_tag}{students}{$student_id}{value} = $score_value;
				} else {
					$results{$judge_id}{$panel_id}{"entries"}{$entry_id}{$score_tag} = $score_value;
				}
			}
		}

		if (keys %results) {
</%perl>
			<div class="full martopmuchmore nospace">
				<span class="quarter nospace">
					<h5 class="nospace">
						Past Ballots
					</h5>
				</span>
				<span class="threequarters true rightalign semibold italic graytext nospace">
					You may edit comments until the tournament ends. <br />
					You cannot change scores once confirmed; contact tournament officials to fix errors
				</span>
			</div>
<%perl>
		}

		foreach my $judge_id (sort keys %results) {

			foreach my $panel_id (
				sort {
					$results{$judge_id}{$b}{"round_name"} <=> $results{$judge_id}{$a}{"round_name"}
					|| $results{$judge_id}{$a}{"flight"} <=> $results{$judge_id}{$b}{"flight"}
					|| $results{$judge_id}{$a}{"event_abbr"} cmp $results{$judge_id}{$b}{"event_abbr"}
				} keys %{$results{$judge_id}}
			) {
</%perl>
				<div class="full nospace martopmore">

					<span class="fourfifths nospace bigger semibold bluetext italic">
						<% $results{$judge_id}{$panel_id}{"event_abbr"} %>
						<% $results{$judge_id}{$panel_id}{"round_label"} %>
						<% $results{$judge_id}{$panel_id}{"flighted"}
							? "Flt ".$results{$judge_id}{$panel_id}{"flight"}
							: ""
						%>
					</span>

					<span class="fifth rightalign">
%						if ($results{$judge_id}{$panel_id}{"legion"}) {
							<a
								class = "bluetext ltbuttonwhite hover smaller"
								href  = "legion_comments.mhtml?panel_id=<% $panel_id %>&judge_id=<% $judge_id %>"
							>
								Edit Feedback
							</a>
%						} else {
							<a
								class = "bluetext ltbuttonwhite hover padvertless"
								href  = "rfd_only.mhtml?panel_id=<% $panel_id %>&judge_id=<% $judge_id %>"
							>
								Edit Feedback
							</a>
%						}
					</span>
				</div>

				<div class="bluebordertop odd">
<%perl>
					foreach my $entry_id (
						sort {
							$results{$judge_id}{$panel_id}{"entries"}{$a}{"raw_side"} <=> $results{$judge_id}{$panel_id}{"entries"}{$b}{"raw_side"}
							|| $results{$judge_id}{$panel_id}{"entries"}{$a}{"order"} <=> $results{$judge_id}{$panel_id}{"entries"}{$b}{"order"}
						} keys %{$results{$judge_id}{$panel_id}{"entries"}}
					) {

						my $entry = $results{$judge_id}{$panel_id}{"entries"}{$entry_id};
</%perl>
						<div class="nospace ltborderbottom">

%							if ($results{$judge_id}{$panel_id}{"event_type"} eq "congress") {

								<span class="tenth padvert smaller">
									<%
										Lingua::EN::Numbers::Ordinate::ordinate($entry->{order})
									%> spkr
								</span>

								<span class="fifth">
									<% $entry->{code} %>
								</span>

								<span class="half">
									<% $entry->{speech}
										? $entry->{speech}
										: ""
									%>
								</span>

								<span class="tenth semibold">
									<% $entry->{rank}
										? $entry->{rank}
										: ""
									%>
								</span>

								<span class="tenth">
								</span>

%							} elsif ($results{$judge_id}{$panel_id}{"event_type"} eq "wudc") {

								<span class="tenth padvert">
									<% $entry->{order} == 1 ? "1G" : "" %>
									<% $entry->{order} == 2 ? "1O" : "" %>
									<% $entry->{order} == 3 ? "2G" : "" %>
									<% $entry->{order} == 4 ? "2O" : "" %>
								</span>

								<span class="fifth">
									<% $entry->{code} %>
								</span>

								<span class="tenth semibold">
									<% $entry->{rank}
										? $entry->{rank}
										: ""
									%>
								</span>

								<span class="half nospace">
%									foreach my $student_id (sort keys %{$entry->{"point"}{"students"}}) {
										<span class="threequarters padless marno">
											<% $entry->{point}{students}{$student_id}{"name"} %>
										</span>
										<span class="quarter padless marno">
											<% $entry->{point}{students}{$student_id}{"value"} %>
										</span>
%									}
								</span>

%							} elsif ($results{$judge_id}{$panel_id}{"event_type"} eq "speech") {

								<span class="tenth padvert smaller">
									<%
										Lingua::EN::Numbers::Ordinate::ordinate($entry->{order})
									%> spkr
								</span>

								<span class="fifth">
									<% $entry->{code} %>
								</span>

								<span class="half">
									<% $entry->{title}
										? $entry->{title}
										: ""
									%>
								</span>

								<span class="tenth semibold">
									<% $entry->{rank}
										? $entry->{rank}
										: ""
									%>
								</span>

								<span class="tenth">
									<% $entry->{point}
										? $entry->{point}
										: ""
									%>
								</span>

%							} else {

								<span class="twenty padvert smaller centeralign">
									<% $entry->{"side"} %>
								</span>

								<span class="twenty padvert smaller">
									<% $entry->{"order"}
										? ($entry->{"order"})
										: ""
									%>
								</span>

								<span class="fifth">
									<% $entry->{code} %>
								</span>

								<span class="tenth centeralign semibold">
									<% $entry->{winloss} %>
								</span>

%								if ($entry->{"point"} && (not defined $entry->{"point"}{"students"})) {
									<span class="eighth rightalign">
										Pts <% $entry->{point} %>
									</span>
%								}

%								if ($entry->{"rank"} && (not defined $entry->{"rank"}{"students"})) {
									<span class="eighth rightalign">
										Rank <% $entry->{rank} %>
									</span>
%								}

%								if ($entry->{"point"}{"students"} || $entry->{"rank"}{"students"}) {
									<span class="quarter nospace smallish">
%										foreach my $student_id (sort keys %{$entry->{"point"}{"students"}}) {
											<span class="full padless marno">
												<% $entry->{point}{students}{$student_id}{"name"} %>:
											</span>
%										}
									</span>
%								}

%								if ($entry->{"point"}{"students"}) {
									<span class="eighth nospace smallish rightalign">
%										foreach my $student_id (sort keys %{$entry->{"point"}{"students"}}) {
											<span class="full padless marno">
												<% $entry->{point}{students}{$student_id}{"value"} %>
											</span>
%										}
									</span>
%								}

%								if ($entry->{"rank"}{"students"}) {
									<span class="eighth nospace smallish rightalign">
%										foreach my $student_id (sort keys %{$entry->{"rank"}{"students"}}) {
											<span class="full padless marno">
												<% $entry->{rank}{students}{$student_id}{"value"} %>
											</span>
%										}
									</span>
%								}
%							}
						</div>
%					}
				</div>
%			}
%		}
	</div>

%	$dbh->disconnect();

