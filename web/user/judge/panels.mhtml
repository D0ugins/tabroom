<%args>
	$person
</%args>
<%init>

    my $key = $person->id;

    return if $m->cache_self(
        key => $key,
        expires_in => '1m'
    );


	my @ballot_panels = $m->comp(
		"/funclib/person_panels.mas",
		person => $person
	);

	my @list_panels = $m->comp(
		"/funclib/person_panels.mas",
		person   => $person,
		listonly => 1
	);

	my @done_panels = $m->comp(
		"/funclib/person_panels.mas",
		person  => $person,
		done    => 1,
		reverse => 1
	);

	my @jpools = $m->comp(
		"/funclib/person_pools.mas",
		person => $person,
		public => "trooth"
	);

	my %panels_done = ();
	my $now = DateTime->now();

	Tab::Judge->set_sql( training_wheels => "
		select judge.*
		from judge, category, tourn, category_setting cs

		where judge.person = ?
			and (judge.category = category.id
				or judge.alt_category = category.id)
			and category.id = cs.category
			and cs.tag = 'show_training'

			and category.tourn = tourn.id
			and tourn.start < now()
			and tourn.end > now()
			and tourn.id > 10000

		and not exists (
			select js.id
			from judge_setting js
			where js.judge = judge.id
			and js.tag = 'ballot_trained'
		)

		group by judge.id
	");

	my @trainings = Tab::Judge->search_training_wheels($person->id);

</%init>

	<&
		"/user/menu.mas",
		person => $person
	&>

	<div class="main">

%		if (@ballot_panels || @list_panels || @trainings) {

			<h3>
				Online Ballots
			</h3>

			<&
				"/funclib/tablesorter.mas",
				table => "pendingrounds"
			&>

			<span class="half">
				<h5 class="nospace">Upcoming Rounds</h5>
			</span>

			<span
				id    = "pendingrounds_buttonarea"
				class = "half rightalign">
			</span>

			<table id="pendingrounds">

				<thead>

					<tr class="yellowrow">

						<th class="smaller">
							Round
						</th>

						<th class="smaller">
							Room
						</th>

						<th class="smaller">
							Starts
						</th>

						<th class="smaller">
							Entries
						</th>

						<th class="smaller">
						</th>

					</tr>

				</thead>

				<tbody>

<%perl>

		}

		if (@trainings) {
			$m->print('<h5 class="centeralign">Training &amp; Orientation</h5>');
		}

		foreach my $training (@trainings) {

			my $category = $training->category;

			my $label = $category->setting("training_label");
			my $room = $category->setting("training_room");
			my $time = $category->setting("training_time");

			$label = "Judge Training" unless $label;
			$room  = "Room TBA" unless $room;
			$time = $category->tourn->start unless $time;

			my $sample_event = $category->events->first();

</%perl>

			<tr>

				<td class="">
					<% $label %>
				</td>

				<td class="semibold bluetext">
					<% $room %>
				</td>

				<td class="centeralign semibold redtext">
					<% $time %>
				</td>

				<td class="leftalign">

%				if ($sample_event->type eq "debate") {

					<div class="leftalign full">
						AFF: TEAM 9999
					</div>
					<div class="leftalign full">
						NEG: TEAM 8888
					</div>

%				} else {

%					foreach my $order (1 .. 6) {
						<span class="fifth leftalign">
							<% $sample_event->type eq "speech" ? $order."." : "" %>
							<% $order.$order.$order.$order %>
						</span>
%					}
%				}

				</td>

				<td class="centeralign padless">

					<a
						class="greentext buttonwhite invert"
						href="training.mhtml?sample=1&event_id=<% $sample_event->id %>&judge_id=<% $training->id %>"
					>
						START ROUND
					</a>

				</td>
			</tr>
<%perl>

		}

		foreach my $panel (@ballot_panels) {

			my $round = $panel->round;
			my $event = $round->event;
			my $tourn = $event->tourn;

			my $legion = $tourn->setting('legion');

	   		my $no_side_constraints++
				if $event->setting('no_side_constraints');

			my $sidelocks++
				if ($round->type eq "elim"
					|| $round->type eq "final"
					|| $round->type eq "runoff"
				) && not defined $no_side_constraints;

			my $locked =  $m->comp(
				"/funclib/round_elim_dueaff.mas",
				panel => $panel
			) if $sidelocks;

			my $tz = $event->tourn->tz;
			$tz = "UTC" unless $tz;

			$panels_done{$panel->id}++;

			next unless $panel
				&& $round
				&& ($round->published || $round->setting("judges_ballots_visible") );

			my $judge = Tab::Judge->retrieve($panel->judge);

			my $aff_string = $event->setting("aff_label");
			my $neg_string = $event->setting("neg_label");

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my @entries = sort {$a->side <=> $b->side} $m->comp(
				'/funclib/panel_entries.mas',
					panel    => $panel,
					no_drops => 1
			);

			my @scores = $m->comp(
				'/funclib/panel_scores.mas',
					panel => $panel,
					judge => $judge
			);

			my $chair;
			my $started;

			foreach my $ballot ($panel->ballots( judge => $judge)) {
				$chair++ if $ballot->chair;
				$started = $ballot->judge_started();
			}

			my $scored;

			foreach my $score (@scores) {
				$scored++ if $score->value;
			}

</%perl>

			<tr>

				<td class="">

					<span class="hidden">
						<% $round->name %>-<% $panel->flight %>
					</span>

					<a
						class="white padless full"
						href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
					>
						<% $event->abbr %> <% $round->realname %>
					</a>

%					my $flight_offset;
%					if ($round->flighted > 1) {
%						$flight_offset = $event->setting("flight_offset");
%						$flight_offset = $flight_offset * ($panel->flight - 1);
						<a
							class="white padless full"
							href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
						>
							Flight <% $panel->flight %>
						</a>
%					}

				</td>

				<td class="semibold bluetext">
					<% $panel->room ? $panel->room->name : "No Room Listed" %>
				</td>

				<td class="centeralign semibold redtext">

<%perl>
					my $start = $round->start_time;
					$start = $round->timeslot->start unless $start;
					$start = $start->set_time_zone($tz);
					$start->add( minutes => $flight_offset ) if $flight_offset;
</%perl>
					<% $start->day_abbr %>
					<% Tab::nicetime($start)." ".Tab::tzname($tz) %>
				</td>
<%perl>

				my $length;

				foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {
					$length = length($entry->code) if $length < length($entry->code);
				}

				my $spansize = "eighth";
				$spansize = "sixth" if $length > 4;
				$spansize = "fifth" if $length > 8;
				$spansize = "quarter" if $length > 10;
				$spansize = "third" if $length > 16;

</%perl>

				<td class="leftalign">

%				unless ($legion) {
%					if ($event->type eq "speech") {
%						foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {
							<span class="<% $spansize %> leftalign">
								<% $event->type eq "speech" ? $entry->speaks."." : "" %>
								<% $entry->code %>
							</span>
%						}
%					} elsif ($event->type eq "congress") {

						<span class="semibold">Chamber <% $panel->letter %></span>

%					} else {
%						foreach my $entry (@entries) {

							<div class="leftalign">

%								unless ($event->type eq "congress") {
									<span class="quarter">
%										if ($event->type eq "wudc") {
											<% $entry->speaks == 1 ? "1G" : "" %>
											<% $entry->speaks == 2 ? "1O" : "" %>
											<% $entry->speaks == 3 ? "2G" : "" %>
											<% $entry->speaks == 4 ? "2O" : "" %>
%										} elsif ($sidelocks && not defined $locked) {
											<% $entry->side
												? $entry->side == 1
													? "Flip for" : "Sides"
												: ""
											%>
%										} else {
											<% $entry->side
												? $entry->side == 1
													? $aff_string : $neg_string
												: ""
											%>
%										}
									</span>

									<span class="threequarter nowrap">
%								}  else {
									<span class="full nowrap padless marno">
<%perl>
								}

								if ($event->type eq "wudc" || $event->type eq "wsdc") {
   									$m->print($entry->code);
								} else {
   									$m->print($entry->name);
								}
</%perl>
								</span>

							</div>
%						}
%					}
%				}
				</td>

				<td class="centeralign padless">

%					if ($legion) {

%						if ($started) {
							<a
								class="bluetext invert buttonwhite"
								href="legion_ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							>BALLOT</a>

%						} elsif ($scored) {
							<a
								class="redtext buttonwhite invert"
								href="legion_confirm.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							>CONFIRM</a>
%						} else {
							<a
								class="greentext buttonwhite invert"
								href="legion_ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
							>Scores</a>
%						}

						<a
							class  = "bluetext buttonwhite invert marleftmore"
							target = "_blank"
							href="legion_comments.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
						>Feedback</a>

%					} elsif ($event->type eq "wudc" &! $chair) {

						Panelist Judge <br /> (only Chairs enter ballots)

%					} else {

%						if ($chair) {
%							if ($event->type eq "congress") {
								<p class="explain marno padless">
									Parliamentarian
								</p>
%							} else {
								<p class="explain marno padless">
									Please Chair this round
								</p>
%							}
%						}

%						if ($started) {

							<a
								class="bluetext invert buttonwhite"
								href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">

								BALLOT
							</a>

%						} elsif ($scored) {

							<a
								class="redtext buttonwhite invert"
								href="re_confirm.mhtml?panel_id=<% $scored %>&judge_id=<% $judge %>">
								CONFIRM
							</a>
%						} elsif ($panel > 0 && $judge > 0)  {
							<a
								class="greentext buttonwhite invert"
								href="ballot.mhtml?panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">

								START ROUND
							</a>
%						}
%					}

				</td>
			</tr>

<%perl>
			if ( ($event->type eq "wudc"
				|| $event->type eq "wsdc")
				&& $round->published == 3
			) {
</%perl>
				<tr>

					<td>
						<span class="hidden">
						<% $round->name %><% $panel->flight %>
						</span>
					</td>

					<th class="">
						Motion:
					</td>

					<td colspan="3">
						<% $round->setting("motion") %>
					</td>
				</tr>
%			}
%		}

<%perl>

		my $last_round;

		foreach my $panel (@list_panels) {

			my $round = $panel->round;
			$panels_done{$panel->id}++;

			next unless $panel && $round && $round->published;

			my $event = $round->event;
			my $judge = Tab::Judge->retrieve($panel->judge);
			my $tourn = $event->tourn;
			my $legion = $tourn->setting('legion');

			my $aff_string = $event->setting("aff_label");
			my $neg_string = $event->setting("neg_label");

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my @entries = sort {$a->side <=> $b->side} $m->comp(
				'/funclib/panel_entries.mas',
				panel => $panel
			);

			my $key = $round->id."-".$panel->flight;

</%perl>
			<tr class="<% $last_round && $last_round ne $key ? "bordertop" : "" %>">

				<td class="padless">

					<span class="hidden">
						<% $round->name %><% $panel->flight %>
					</span>

					<a
						class="white padless full"
						href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
					>
						<% $event->abbr %> <% $round->realname %>
					</a>

%					if ($round->flighted > 1) {
						<a
							class="white padless full marno border"
							href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
						>
							Flight <% $panel->flight %>
						</a>
%					}

				</td>

				<td class="">
					<% $panel->room ? $panel->room->name : "No Room Listed" %>
				</td>

				<td class="">
					<% Tab::nicetime($round->timeslot->start->set_time_zone($tourn->tz)) %>
				</td>

				<td class="">
<%perl>

					if ($event->type eq "speech" || $event->type eq "congress") {

						foreach my $entry (sort {$a->speaks <=> $b->speaks} @entries) {

							my $spansize = "third";

							$spansize = "eighth"
								if ($event->setting('code_style') eq "numbers"
								|| $event->setting('code_style') eq "school_number");

</%perl>

							<span class="<% $spansize %>">
%								if ($legion) {
									<% $entry->speaks %>
%								} else {
									<% $event->type eq "speech" ? $entry->speaks."." : "" %>
									<% $entry->code %>
%								}
							</span>
%						}

%					} else {

%						foreach my $entry (@entries) {

							<div>
								<span class="quarter">
%									if ($event->type eq "wudc") {
										<% $entry->speaks == 1 ? "1G" : "" %>
										<% $entry->speaks == 2 ? "1O" : "" %>
										<% $entry->speaks == 3 ? "2G" : "" %>
										<% $entry->speaks == 4 ? "2O" : "" %>
%									} elsif ($event->type eq "congress") {

%									} else {
										<% $entry->side ? $entry->side == 1 ? $aff_string : $neg_string : "" %>
%									}
								</span>

								<span class="threequarter">
<%perl>
									if (
										$event->type eq "wudc"
										|| $event->type eq "wsdc"
									) {

</%perl>
										<% $entry->code %>
%									} else {
										<% $entry->name %>
%									}
								</span>

							</div>
%						}
%					}
				</td>

				<td>
				</td>

			</tr>

%			$last_round = $round->id."-".$panel->flight;
%		}

%		if (@ballot_panels || @list_panels || @trainings) {

			</tbody>
			</table>
%		}

%		if (@jpools) {

			<h5 class="martop">Pools</h5>

			<p>
      			<% $jpools[0]->category->setting("judge_sheet_notice") %>
			</p>

%			foreach my $jpool (@jpools) {

				<div class="row">

					<span class="quarter padsetting semibold">
						<% $jpool->name %>
					</span>

					<span class="quarter">
%						foreach my $round ($jpool->rounds) {
%							next unless $round->event > 0;
							<span class='full padless marno'>
								<% $round->event->abbr %> <% $round->realname %>
							</span>
%						}
					</span>

					<span class="half">
						<% $jpool->message %>
					</span>
				</div>
%			}
%		}

%		if (@done_panels) {

			<h5 class="martopmuchmore">
				Previously Entered Results
			</h5>

			<p class="martop marbottom graytext semibold">
				You may edit comments until the tournament ends.
				You cannot change wins/points/ranks once confirmed.
				Contact tab officials if you see an error.
			</p>
<%perl>

		}

		undef $last_round;

		foreach my $done (@done_panels) {

			my $round    = $done->round;
			my $event    = $round->event;
			my $noedit;

			my $tourn = $event->tourn;
			$noedit++ if $tourn->end < $now;

			my $category = $event->category;
			my $legion   = $event->tourn->setting('legion');

			my $judge = Tab::Judge->retrieve($done->judge)
				if $done->judge;

			my @entries = $m->comp(
				'/funclib/panel_entries.mas',
				panel => $done
			);

			my @scores = $m->comp(
				'/funclib/panel_scores.mas',
				panel => $done,
				judge => $judge
			);

			@scores = $m->comp(
				'/funclib/panel_scores.mas',
				panel => $done)
			if $event->type eq "wudc";

			my %scores_by_recipient =();

			foreach my $score (@scores) {
				push @{$scores_by_recipient{$score->student->id}}, $score
					if $score->student && $score->student->id;
			}

			my $aff_string = $event->setting("aff_label");
			my $neg_string = $event->setting("neg_label");

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my %category_settings  = $category->all_settings;
			my $ballot_entry_name  = $category_settings{"ballot_entry_names"};
			my $ballot_entry_title = $category_settings{"ballot_entry_titles"};
			my $ballot_school_code = $category_settings{"ballot_school_codes"};
			my $ballot_school_name = $category_settings{"ballot_school_names"};
			my $ballot_entry_first_name = $category_settings{"ballot_entry_first_names"};

</%perl>

			<& /funclib/tablesorter.mas, table => $done->id &>

			<div class="full nospace martopmore">

				<span class="fourfifths nospace bigger semibold bluetext italic">
%					my $rstart = $round->start_time;
%					$rstart->set_time_zone($tourn->tz);
					<% $rstart->day_abbr %>
					<& "/funclib/showtime.mas",  dt => $rstart &>
					&ndash;
					<% $round->realname %>
					<% $round->flighted > 1 ? "Flt ".$done->flight : "" %>
					<% $event->name %>
				</span>

				<span class="fifth rightalign">
%					if ($noedit) {

%					} elsif ($legion) {
						<a
							class = "bluetext ltbuttonwhite hover"
							href  = "legion_comments.mhtml?panel_id=<% $done->id %>&judge_id=<% $judge->id %>"
						>
							Edit Feedback
						</a>
%					} elsif ($done && $judge)  {
						<a
							class = "bluetext ltbuttonwhite hover"
							href  = "rfd_only.mhtml?panel_id=<% $done %>&judge_id=<% $judge %>"
						>
							Edit Feedback
						</a>
%					}
				</span>

			</div>

<%perl>

			my %entry_result = ();
			my %entry_score = ();
			my %entry_sort = ();

			foreach my $entry (@entries) {

				foreach my $score (@scores) {

					next if $score->student > 0;
					next unless $score->ballot;
					next unless $score->ballot->entry;
					next unless $score->ballot->entry->id == $entry->id;

					if ($score->tag eq "speech") {
						$entry_score{$entry->id} .= " &ndash; "
							if $entry_score{$entry->id};
					} else {
						$entry_result{$entry->id} .= " &ndash; "
							if $entry_result{$entry->id};
					}

					if ($entry->event->type eq "wudc"
						&& $round->type ne "elim"
						&& $round->type ne "final"
						&& $round->type ne "runoff"
					) {

						$entry_result{$entry->id} .= (4 - $score->value)." pts"
							if $score->tag eq "rank";

					} elsif ($entry->event->type eq "wudc") {

						$entry_result{$entry->id} .= " Advances "
							if $score->value == 1;

					} else {

						$entry_result{$entry->id} .= " Bye " if $score->ballot->bye;
						$entry_result{$entry->id} .= " Fft " if $score->ballot->forfeit;

						if ($score->tag eq "winloss") {
							if ($score->value == 1) {
								$entry_result{$entry->id} .= " W ";
							} else {
								$entry_result{$entry->id} .= " L ";
							}
						}

						if (
							$entry->event->type eq "speech"
							|| $entry->event->type eq "congress"
						) {

							$entry_sort{$entry->id} = $score->value
								if $score->tag eq "rank";

						} else {

							$entry_sort{$entry->id} = (10 - $score->value)
								if $score->tag eq "winloss";
						}

						$entry_result{$entry->id} .= "Rank: ".$score->value
							if $score->tag eq "rank";

						$entry_result{$entry->id} .= $score->value
							if $score->tag eq "point";

						$entry_score{$entry->id} .= $score->value
							if $score->tag eq "speech";
					}
				}
			}

			@entries =
				sort {$entry_sort{$a} <=> $entry_sort{$b}}
				@entries;

</%perl>

			<div class="bluebordertop odd">

%				foreach my $entry (@entries) {

					<div class="nospace ltborderbottom">

%					if ($event->type eq "congress") {

						<span class="quarter padvert">
							<% $entry->code %>
						</span>

						<span class="quarter">

%					} elsif ($event->type eq "wudc") {
						<span class="sixth padvert">
							<% $entry->speaks == 1 ? "1G" : "" %>
							<% $entry->speaks == 2 ? "1O" : "" %>
							<% $entry->speaks == 3 ? "2G" : "" %>
							<% $entry->speaks == 4 ? "2O" : "" %>
						</span>
						<span class="third">
%					} else {

						<span class="eighth padvert smaller">
							<% $entry->side
								? $entry->side == 1
									? $aff_string
									: $neg_string
								: Lingua::EN::Numbers::Ordinate::ordinate($entry->speaks)." speaker"
							%>
						</span>

%						if ($event->type eq "speech") {
							<span class="twothirds semibold redtext">
%						} else {
							<span class="third semibold redtext">
%						}
%					}
<%perl>
						if ($event->type eq "wudc"
							|| $event->type eq "speech"
							|| $event->type eq "wsdc"
							|| $event->setting("anonymous_public")
						) {
</%perl>
%							if ($ballot_entry_name || $ballot_entry_first_name) {
%							} else {
								<div class="twofifths">
									<% $entry->code %>
								</div>
%							}

%							if ($ballot_school_code) {
								<div class="fifth">
									<% $ballot_school_code ? $entry->school->code  : "" %>
								</div>
%							}
%							if ($ballot_school_name) {
								<div class="twofifths">
									<% $ballot_school_name ? $entry->school->short_name  : "" %>
								</div>
%							}

<%perl>
						}

						if ($event->type eq "wudc"
							|| $event->type eq "speech"
							|| $event->type eq "wsdc"
							|| $event->type eq "congress"
						) {

							if ($ballot_entry_name) {
								$m->print('<div class="twofifths">');
								$m->print($entry->name);
								$m->print('</div>');
							}

							if ($ballot_entry_first_name) {
								$m->print('<div class="twofifths">');
								foreach my $student ($entry->students) {
									$m->print($student->first);
								}
								$m->print('</div>');
							}

						} else {
							$m->print($entry->name);
						}

						if ($ballot_entry_title) {

							my $title = Tab::Score->search(
								ballot => $entry->ballot,
								tag    => "title"
							)->first;
</%perl>
							<div class="full nospace italic normalweight">
								<% $title ? $title->text : "" %>
							</div>
%						}

					</span>

<%perl>

					my $span = "tenth";

					$span = "quarter" if $event->type eq "speech";
					$span = "half" if $event->type eq "congress";

</%perl>

					<span class="<% $span %> centeralign marno padno">

%						if ($entry_score{$entry->id}) {

							<span class="quarter">
								<% $entry_result{$entry->id} %>
							</span>

							<span class="threequarters rightalign">
								Speech Scores: <% $entry_score{$entry->id} %>
							</span>

%						} else {
							<% $entry_result{$entry->id} %>
%						}
					</span>

%					unless ($event->type eq "speech" || $event->type eq "congress") {

						<span class="fourtenths">

<%perl>
							foreach my $student ($entry->students) {

								my @scores = @{$scores_by_recipient{$student->id}}
									if $student->id && $scores_by_recipient{$student->id};

								next unless @scores;

</%perl>
								<span class="fourtenths nospace">

									<span class="threequarters nowrap marno">
										<% $student->last %>:
									</span>

									<span class="quarter">
%										my $notfirst;
%										foreach my $score (@scores) {
%											next if $score->position > 3;
											<% $notfirst++ ? " - " : "" %>
											<% $score->tag eq "winloss" ? $score->value ? "W" : "L" : "" %>
											<% $score->tag eq "rank" ? $score->value : "" %>
											<% $score->tag eq "point" ? $score->value : "" %>
%										}
									</span>
								</span>
%							}

%							if ($event->type eq "wsdc") {

								<span class="half nospace">

<%perl>
									STUDENT:
									foreach my $student ($entry->students) {

										my @scores = @{$scores_by_recipient{$student->id}}
											if $student->id
											&& $scores_by_recipient{$student->id};

										next unless @scores;

										foreach my $score (@scores) {

											next STUDENT unless $score->position > 3;

</%perl>
												<span class="twothird nowrap">
													REPLY: <% $student->last %>:
												</span>
												<span class="third">
													<% $score->value %>
												</span>
%										}
										</span>
%									}
								</span>
%							}

						</span>
%					}
%					$last_round = $round->id."-".$done->flight;
					</div>
%				}

			</div>

%		}

	</div>

