<%args>
	$person
	$person_settings
	$panel_id => undef
	$judge_id => undef
	$errs     => undef
</%args>
<%init>

	unless ($panel_id && $judge_id) { 
		my $err = "I didn't get both a judge and a ballot record";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $panel = Tab::Panel->retrieve($panel_id);
	my $judge = Tab::Judge->retrieve($judge_id);

	$m->comp("/funclib/panel_dedupe.mas", panel => $panel);

	$m->abort unless $panel;

	my $round = $panel->round;
	my $event = $round->event;
	my %event_settings = $event->all_settings;

	my $category = $event->category;
	my %category_settings = $category->all_settings;

	my $tourn = $category->tourn;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now(time_zone => $tz);

	if ($event->type eq "wsdc") { 
		$m->redirect("wsdc_ballot.mhtml?panel_id=".$panel->id."&judge_id=".$judge->id);
	}

    my $subscores = $event_settings{"wsdc_categories"};

    my %max_subpoints = (); 
    my %min_subpoints = (); 

    my @scores = ("Style", "Content", "Strategy", "POI"); 
    
    foreach my $key (@scores) { 

        $min_subpoints{$key} = $event_settings{"min_".lc($key)."_points"};
        $max_subpoints{$key} = $event_settings{"max_".lc($key)."_points"}; 

        $min_subpoints{$key} = 0 unless $min_subpoints{$key};

        $min_subpoints{"total"} += $min_subpoints{$key} unless $key eq "POI";
        $max_subpoints{"total"} += $max_subpoints{$key} unless $key eq "POI";

    }   

    my $trash = pop @scores unless $max_subpoints{"POI"};

	my $no_lpw++ if $event_settings{"no_lpw"};

	my $aff_string = $event_settings{"aff_label"};
	my $neg_string = $event_settings{"neg_label"};

	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	my $ballot_rules = $event_settings{"ballot_rules"};
	my $ballot_entry_name = $category_settings{"ballot_entry_names"};
	my $ballot_entry_first_name = $category_settings{"ballot_entry_first_names"};
	my $ballot_entry_title = $category_settings{"ballot_entry_titles"};
	my $ballot_school_code = $category_settings{"ballot_school_codes"};
	my $ballot_school_name = $category_settings{"ballot_school_names"};

	$ballot_rules =~ s/^\s+//;
	$ballot_rules =~ s/^\t+//;
	$ballot_rules =~ s/^\n+//;
	$ballot_rules =~ s/^\r+//;
	$ballot_rules =~ s/\s+$//;

	$ballot_rules =~ s/\t//g;
	$ballot_rules =~ s/\n/\n\n/g;
	$ballot_rules =~ s/\n\n<p>/<p>/g;
	$ballot_rules =~ s/<br \/>/\n\n/g;

	my $type = $event->type;
	my $wudc++ if $type eq "wudc";

	unless ($panel && $judge) { 
		my $err = "No ballots found for that judge and that panel.";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	unless ($judge->person->id == $person->id || $person->site_admin) { 
		my $err = "You are not authorized to enter ballots for that judge.";
		$m->redirect("/user/home.mhtml?err=$err")
	}

	unless ($round->tiebreak_set) { 

		my $err = "That tournament does not have tiebreakers set.";
		$err .= " Please contact the tournament tab staff to let them know.";

		$m->redirect("/user/judge/panels.mhtml?err=$err");
	}

	my @ballots = sort {$a->side <=> $b->side} 
		Tab::Ballot->search( 
			judge => $judge->id, 
			panel => $panel->id 
		);

	unless (@ballots) { 
		my $err = "That judge does not judge in that room.";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	unless ($panel->started) { 
		$panel->started($now);
		$panel->update;
	}

	foreach my $ballot (@ballots) { 
		next if $ballot->judge_started;
		$ballot->judge_started($now);
		$ballot->update;
	}

	my $wins;
	my $points;
	my $ranks;

	foreach my $tb ($round->tiebreak_set->tiebreaks) { 

		my $round_type = $round->type;
		$round_type = "prelim" if $round_type eq "highhigh";
		$round_type = "prelim" if $round_type eq "highlow";

		next if  
			$tb->count eq "prelim" 
			&& (
				$round_type eq "elim"
				|| $round_type eq "final"
			);

		$ranks++ if ($tb->name eq "ranks" 
					|| $tb->name eq "reciprocals");

		$wins++ if ($tb->name eq "opp_wins" 
					|| $tb->name eq "winloss" 
					|| $tb->name eq "losses" 
					|| $tb->name eq "ballots");

		$points++ if ($tb->name eq "points" 
					|| $tb->name eq "competition" 
					|| $tb->name eq "opp_points");

		if ($tb->child) { 

            foreach my $otb ($tb->child->tiebreaks) { 

                next if  
                    $otb->count eq "prelim" 
                    && (
                        $round_type eq "elim"
                        || $round_type eq "final"
                    );

                $ranks++ if (
                    $otb->name eq "ranks" 
                    || $otb->name eq "reciprocals" 
                    || $otb->name eq "opp_ranks"
                );

                $wins++ if (
                    $otb->name eq "opp_wins" 
                    || $otb->name eq "winloss"
                    || $otb->name eq "losses"
                );

                $points++ if (
                    $otb->name eq "points"
                    || $otb->name eq "opp_points"
                );
            }
		}
	}

	my $team_points++ if $event_settings{"team_points"};
	$team_points++ if $type eq "speech";
	$team_points++ if $type eq "congress";

	undef $ranks if $wudc;

	my @panel_students = $m->comp(
		'/funclib/panel_students.mas', 
		panel => $panel
	);

	my $tv++ if $type eq "speech" 
		&& $round->tiebreak_set->setting("mfl_time_violation");

	my $forfeit++ if $type eq "speech" 
		&& $round->tiebreak_set->setting("forfeits_never_break");

	my $max_points = $event_settings{"max_points"};
	my $min_points = $event_settings{"min_points"};

	my $max_ob_points = $event_settings{"max_ob_points"};
	my $min_ob_points = $event_settings{"min_ob_points"};

	$min_ob_points = $min_points unless $min_ob_points;
	$max_ob_points = $max_points unless $max_ob_points;

	my %entry_scores = ();

	if ($event->type eq 'congress') { 

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 6 unless $max_ob_points;

        my @scores = $m->comp(
            '/funclib/judge_scores.mas',
            judge    => $judge,
            timeslot => $round->timeslot,
            tag      => "congress_speech"
        );

        foreach my $score (@scores) {
            $entry_scores{$score->entryid}{$score->speech} = $score;
			$entry_scores{$score->entryid}{"total"} += $score->value;
			$entry_scores{$score->entryid}{"count"}++;
        }

	} elsif ($event->type eq 'speech') { 

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 100 unless $max_ob_points;

	} else { 

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 30 unless $max_ob_points;

	}

	my $increments = $event_settings{"point_increments"};

	my $step = "1" if $increments eq "whole";
	$step = "0.5" if $increments eq "half";
	$step = "0.25" if $increments eq "fourths";
	$step = "0.1" if $increments eq "tenths";

	my $no_side_constraints++ 
		if $event_settings{'no_side_constraints'};

    my $sidelocks++ 
		if ($round->type eq "elim" || $round->type eq "final") 
		&& not defined $no_side_constraints;

	my $locked =  $m->comp(
		"/funclib/round_elim_dueaff.mas", 
		panel => $panel
	) if $sidelocks;

</%init>

	<& "/funclib/editor.mas" &>

	<script>

		function swapOrder(orderSelector) { 

			var ballotID = $(orderSelector).attr("ballot_id");
			var selectedValue = $("#"+orderSelector.id+" option:selected").val();

			if (ballotID && selectedValue) { 

				var otherValue = 2;

				if (selectedValue == otherValue) { 
					otherValue--;
				}

				$(".speakerorder").each( function() { 

					if (this.id != ballotID+"_speakerorder") { 
						$("#"+this.id+" option").prop('selected', false);
						$("#"+this.id+" option[value="+otherValue+"]").prop('selected', true);
					}

					$(".orderpick").prop("disabled", true);

				});

				sortTable();
			}

			return;
		}



		function sortTable() { 

			console.log("What the hell");

			var rows = $(".ballotrows").get();

			rows.sort(function(a, b) { 
				var A = $("#"+a.id+"_speakerorder option:selected").val();
				var B = $("#"+b.id+"_speakerorder option:selected").val();

				if (A < B) { 
					return -1;
				} 

				if (A > B) { 
					return 1;
				}
				return 0;
			});

			$.each(rows, function(index, row) { 
				$("#ballottable").append(row);
				$(row).toggleClass("even");
				$(row).toggleClass("odd");
			});

			return;

		}

		function doneSwitch(which) { 
			$('.commentary').addClass("hidden");
			$('#box_'+which).removeClass("hidden");
			$("li.commentzing").removeClass("selected");
			$('#header_'+which).addClass("selected");
		}

		function switchBox(selectTarget) { 
			$('.commentary').addClass("hidden");
			$('#box_'+$(selectTarget).val()).removeClass("hidden");
		}

		function speakerTotal(studentID, entryID) {

			var pointTotal = 0;

			$("."+studentID).each(function() { 

                var Float = parseFloat(this.value);

                if (Float) { 

                    if (Float > this.max) { 

						alertify.error(
							Float+" is over the maximum points allowed.  The maximum is "+this.max
						);

						$(this).val("");
						this.focus();

                    } else if (Float < this.min) { 

                        alertify.error(
							Float+" is below the minimum points allowed.  The minimum is "+this.min
						);

						$(this).val("");
						this.focus();


                    } else { 

                        pointTotal += Float;

                    }
				}

			});

			$("#"+studentID+"_points")
				.val(pointTotal)
				.change(function() { 
					checkTotal(studentID, entryID);
					teamTotal(entryID);
				})
				.trigger("change");
		}

		function checkTotal(studentID, entryID) { 

			$("."+studentID+"_row").removeClass("lird");
			$("#"+studentID+"_warning").addClass("hidden");
			
			var boxTotal = $("#"+studentID+"_points").val();

			var pointTotal = 0;

			$("."+studentID).each(function() { 

				var Float = parseFloat(this.value);

				if (Float) { 
					pointTotal += Float;
				}

			});

			if (pointTotal != boxTotal) { 

				$("."+studentID+"_row").addClass("lird");
				$("#"+studentID+"_warning").removeClass("hidden");

				$("#"+studentID+"_warning").html("Total: "+pointTotal+" vs "+boxTotal);

			}

		}

		function teamTotal(entryID) { 

			var teamTotal = 0;

			$("."+entryID).each(function() { 

				var Float = parseFloat(this.value);

				if (Float) { 
					teamTotal += Float;
				}

			});

			$("#"+entryID+"_total").val(teamTotal);

		}

		function checkLPW(selectMenu) { 

			var Winner = parseFloat($('#winner').val());

			if (Winner) { 

				var mostPoints = 0;
				var mostBallot = 0;

				$(".totals").each(function() { 

					var localPoints = $(this).val();

					if (localPoints > mostPoints) { 
						mostBallot  = $(this).attr("ballotID");
						mostPoints = localPoints;
					}

				});

				if (mostBallot != Winner) { 

%					if ($event_settings{"no_lpw"}) { 

						alertify.error(
							"You gave the winning team fewer points.  Please correct."
						);

						$("#winbox").addClass("lird");

%					} else { 

						$("#lpwbox").addClass("redtext");
						$("#lpwbox").addClass("strong");

%					}

				} else { 
					
					$("#winbox").removeClass("lird");
					$("#lpwbox").removeClass("redtext");
					$("#lpwbox").removeClass("strong");

				}

			} else { 

				$("#winbox").removeClass("lird");
				$("#lpwbox").removeClass("redtext");
				$("#lpwbox").removeClass("strong");

			}


		}

		$(document).ready(function () {
			sortTable();
		});

	</script>

	<div class="main">

		<div>
			
			<span class="twothirds">
				<h4>
					<% $event->abbr %> 
					<% $round->realname %> 
					<% $round->flighted > 1 ? "Flt ".$panel->flight : "" %> 
					Ballot for 
					<% $judge->last %>
				</h4>
			</span>

			<span class="third rightalign right">

				<h5 class="normalweight bluetext">
					<% $panel->room > 0 
						? "Room: ". $panel->room->name
						: "NO ROOM ASSIGNED"
					%>
				</h5>
			</span>	
		</div>
		
%		if ($round->setting("notes")) { 
			<p class="warning padleft">
				Note: <% $round->setting("notes") %>
			</p>
%		}

%		if ($ballot_rules) { 
			<div class="padleft">
				<% $ballot_rules %>
			</div>
%		}

<%perl>

		if ($event->type eq "congress") { 

			my $default = $ARGS{"default"};
			$default = "speeches" unless $default;
			my @tabs = ("speeches", "rankings");
	
</%perl>
				<& 
					"/funclib/tabs.mas", 
					tabs    => \@tabs,
					default => $default
				&>

			<div class="speeches screens">

				<& 
					"congress_speeches.mas", 
						person          => $person,
						person_settings => $person_settings,
						judge           => $judge,
						panel           => $panel,
						event           => $event,
						missing         => $ARGS{"missing"},
						event_settings  => \%event_settings,
						entry_id        => $ARGS{"entry_id"}
				&>

			</div>

			<div class="rankings screens">

%		}

%		if ($errs) { 

			<div class="borderred centeralign martopmore marbottommore">

				<h6 class="bluetext semibold">
					Oh, drat. Your ballot had errors.
				</h6>

				<span class="semibold redtext bigger">
					<% $errs %>
				</span>

				<p class="bigger semibold bluetext">
					Please correct these before continuing.
				</p>

			</div>
%		}

		<form 
			action="<% $wudc ? "wudc_save.mhtml" : "ballot_save.mhtml" %>" 
			method="post">

		<input 
			type  = "hidden"
			name  = "panel_id"
			value = "<% $panel->id %>"
		>

		<input 
			type  = "hidden"
			name  = "judge_id"
			value = "<% $judge->id %>"
		>

%		if ($event->type eq 'speech' || $event->type eq "congress") { 

			<& "/funclib/tablesorter.mas", 
				table => "sortable", 
				nobuttons => 1
			&>

%		}

%		if ($event_settings{"truncate_fill"} && $ranks) { 

			<h6 class="bluetext centeralign padmore marbottom">
				Any blank ranks will be auto-filled with a 
					<% $event_settings{"truncate_fill"} %>
			</h6>

%		}

%		if ($points) { 

			<div class="row padvert centeralign marbottommore">

				<span class="semibold redtext inline marright">
					Points Rules:
				</span>

				Range: 
					<% $min_ob_points."-".$max_ob_points %>
					<% ($min_ob_points != $min_points)
					|| ($max_ob_points != $max_points) ? "*" : "" %>.

				<% $step eq "1" ? " Whole points only. " : "" %>

				<% $event_settings{"point_ties"} ? 
					"Ties are OK. " : "No ties. " %>

%				if ($type eq "speech" || $type eq "congress") { 
					<% $event_settings{"allow_lowpoints"} 
						? "" 
						: "Ranks and points must agree. " 
					%>
%				}

				<% ($type ne "speech" && $type ne "congress" ) 
					&& $no_lpw ? "Winner must have higher points. " : "" %>

				<% $step eq "0.5" ? "Steps of 0.5. " : "" %>
				<% $step eq "0.25" ? "Steps of 0.25. " : "" %>
				<% $step eq "0.1" ? "Steps of 0.1. " : "" %>

			</div>

%		}

		<table id="sortable"> 

			<thead>

			<tr class="yellowrow smallish centeralign">

%				if ($type eq "wudc") { 

					<th>
						Position
					</th>

%				} elsif ($type ne "speech" && $type ne "congress") { 

					<th>
						Side <% $sidelocks ? $locked ? "(Locked)" : "(Flip)" : "" %>
					</th>
%				}

%				if ($no_side_constraints) { 
					<th>
						Speaks
					</th>
%				}

				<th>
					Code
				</th>

%				if ($ballot_school_code) {
					<th>
						Sch Code
					</th>
%				}
%				if ($ballot_school_name) {
					<th>
						School
					</th>
%				}

%				if ($ballot_entry_name) {
					<th>
						Name
					</th>
%				}

%				if ($ballot_entry_first_name) {
					<th>
						First Name
					</th>
%				}
%				if ($ballot_entry_title) {
					<th>
						Title/Question
					</th>
%				}

%				if ($wudc && $wins && $round->type eq "elim") { 
					<th>
						Advance (2)
					</th>

%				} elsif ($wudc && $wins && $round->type eq "final") { 

					<th>
						Champion
					</th>
%				} 

%				if ($event->type eq "congress") { 

					<th>
						Points
					</th>

					<th>
						Average
					</th>

					<th>
						Ranks
					</th>

%				} else { 
				
					<th colspan="5">
<%perl>

					my $tick; 

					if (
						($ranks || $points 
						&& (scalar @panel_students > scalar @ballots)
					) 
						&& not defined $team_points
					) { 

						$tick++;
</%perl>
						<span class="third marno padless centeralign">
							Speaker
						</span>
%					}


%					if ($ranks) { 
						<span class="<% $tick ? "third padless" : "half" %> marno centeralign">
							Ranks
						</span>
%					}

%					if ($points) { 

						<span class="<% $tick ? "third padless" : "half" %> marno centeralign">

%						if ($subscores) { 

%							foreach my $score (@scores) { 
								<span class="marno quarter centeralign">
									<% ucfirst ($score) %><br />
									(<% $min_subpoints{$score} %> - <% $max_subpoints{$score} %>)
								</span>
%							}

							<span class="marno quarter centeralign semibold">
								Total <br />
								(<% $min_subpoints{"total"} %> - <% $max_subpoints{"total"} %>)
							</span>

%						} else { 
							Points
%						}
						</span>
%					}

					</th>

%				}

%				if ($tv) { 
					<th>
						Overtime
					</th>
%				}

%				if ($forfeit) { 
					<th>
						No show?
					</th>
%				}

			</tr>

			</thead>

			<tbody id="ballottable">

<%perl>

			my $index = 1;
			my $switch;
			my $i_can_haz_doubled;

			foreach my $ballot (@ballots) { 

				my $entry = $ballot->entry;
				next unless $entry;

				next if $entry->dropped 
					&& $type eq "speech";

				next if $entry->dropped 
					&& $type eq "congress";

				my @students = $entry->students;

				my @doubled = $m->comp(
					"/funclib/entry_double.mas", 
						entry => $entry, 
						round => $round
				);

				$i_can_haz_doubled++ if @doubled;

</%perl>
				<tr
					id    = "<% $ballot->id %>"
					class = "<% ($switch % 2) ? "odd" : "even" %> ballotrows"
				>

<%perl>

					my $columns = scalar @students;

					$columns = 1 if $team_points;

					$columns = 1 unless ($points || $ranks);

					unless ($type eq "speech" || $type eq "congress") { 
</%perl>

						<td 
							class   = "centeralign"
						>

%							if ($no_side_constraints || $sidelocks && not defined $locked) { 

								<select 
									name  = "<% $ballot->id %>_side"
									class = "fixedtiny chosen"
								>

									<option 
										value    = ""
									>Pick</option>

									<option 
										value = "1"
										id    = "aff"
										<% $ballot->side == 1 ? "selected" : ""%>
									><% $aff_string %></option>

									<option 
										value = "2"
										id    = "neg"
										<% $ballot->side == 2 ? "selected" : ""%>
									><% $neg_string %></option>

								</select>

<%perl>
							} elsif ($wudc && ($round->type eq "elim" 
								|| $round->type eq "final") 
							) { 
</%perl>

								<select name="<% $ballot->id %>_speakerorder">
									<option value="">Pick</option>
									<option value="1">1st Gov</option>
									<option value="2">1st Opp</option>
									<option value="3">2nd Gov</option>
									<option value="4">2nd Opp</option>
								</select>

%							} elsif ($wudc) { 
								
								<% ($ballot->speakerorder == 1) ? "1st Gov" : "" %>
								<% ($ballot->speakerorder == 2) ? "1st Opp" : "" %>
								<% ($ballot->speakerorder == 3) ? "2nd Gov" : "" %>
								<% ($ballot->speakerorder == 4) ? "2nd Opp" : "" %>

%							} else { 
								<% ($ballot->side == 1) ? $aff_string : $neg_string %>
%							}

						</td>

%						if ($no_side_constraints) { 

							<td>

								<select 
									id        = "<% $ballot->id %>_speakerorder"
									name      = "<% $ballot->id %>_speakerorder"
									ballot_id = "<% $ballot->id %>"
									class     = "fixedtiny speakerorder plain"
									onChange  = "swapOrder(this);"
								>

									<option 
										value = ""
										class = "orderpick"
									>Pick</option>

									<option 
										value = "1"
										id    = "1"
										class = "orders"
										<% $ballot->speakerorder == 1 ? "selected" : ""%>
									>1</option>

									<option 
										value = "2"
										id    = "2"
										class = "orders"
										<% $ballot->speakerorder == 2 ? "selected" : ""%>
									>2</option>

								</select>
							</td>

%						}

%					}

					<td
						class   = "leftalign semibold"
					>
						<% $entry->code %><% @doubled ? "&dagger;" : "" %>
					</td>

%					if ($ballot_school_code) {

						<td
							class   = "centeralign"
						>
							<% $entry->school->code %>
						</td>

%					}

%					if ($ballot_school_name) {

						<td
							class   = "padleftmore"
						>
							<% $entry->school->name %>
						</td>
%					}

%					if ($ballot_entry_name) {
						<td
							class   = "padleftmore"
						>
							<% $entry->name %>
						</td>
%					}

%					if ($ballot_entry_first_name) {

						<td
							class   = "centeralign"
						>

%							foreach my $student ($entry->students) { 
								<% $student->first %>
%							}

						</td>
%					}

%					if ($ballot_entry_title) {

%						my $title = $entry->setting("title"); 

						<td class="centeralign" >

							<input 
								type        = "text"
								tabindex    = <% $index++  %>
								name        = "title_<% $ballot->id %>"
								value       = "<% $title %>"
								placeholder = "Enter title or extemp question"
								size        = "30"
							>
						</td>
%					}

%					if ($event->type eq "congress") { 

						<td class="centeralign">
<%perl>
							my $notfirst;
							foreach my $speech (keys %{$entry_scores{$entry->id}}) { 

								next if $speech eq "total";
								next if $speech eq "count";
								$m->print(", ") if $notfirst++;
								$m->print($entry_scores{$entry->id}{$speech}->value);
							}
</%perl>
						</td>

						<td class="centeralign">
%							if ($entry_scores{$entry->id}{"count"}) { 
								<% $entry_scores{$entry->id}{"total"} / $entry_scores{$entry->id}{"count"} %>
%							}
						</td>

<%perl>
					}

					if ($points || $ranks) { 

						my $notfirst;

						if ($team_points) { 

							if ($ranks) { 

</%perl>
								<td class="centeralign">
									<input 
										tabindex = <% $index++ %>
										type     = "number"
										step     = "1"
										size     = "5"
										name     = "<% $ballot->id %>_ranks"
										max      = "<% scalar @panel_students %>"
										value    = "<% $ARGS{$ballot->id."_ranks"} %>"
									>
								</td>

%							}

%							if ($points) { 

								<td <% $ranks ? "" : 'colspan="2"' %>
									class="centeralign">

									<input 
										class    = "<% $entry->id %>"
										type     = "number"
										step     = "<% $step %>"
										name     = "<% $ballot->id %>_points"
										id       = "<% $ballot->id %>_points"
										size     = "5"
										min      = "<% $min_points %>"
										max      = "<% $max_points %>"
										value    = "<% $ARGS{$ballot->id."_points"} %>"
										tabindex = <% $index++ %>
									>
								</td>

%							} 

%							if ($tv) { 

								<td class="centeralign">

									<input 
										type  = "checkbox"
										name  = "<% $ballot->id %>_tv"
										value = "1"
									> 
								</td>
%							}

%							if ($forfeit) { 
								<td class="centeralign">
									<input 
										type  = "checkbox"
										name  = "<% $ballot->id %>_forfeit"
										value = "1"
									>
								</td>
%							}


%						} else { 

							<td colspan="4">

%							my $length = "twothirds";
%							$length = "third" if $ranks && $points;

%							foreach my $student (@students) { 
							
								<div class="padless marno borderbottom centeralign">

									<span class='smallish <% $length %> marno padless leftalign <% $student->id."_row" %>' >

										<% substr($student->first." ".$student->last.":", 0, 30) %>

										<div 
											id    = "<% $student->id %>_warning"
											class = "hidden redtext strong nospace padtop"
										>
											Total incorrect!
										</div>

									</span>

%								if  ($ranks) { 

									<span class="third marno padless centeralign">

										<input 
											tabindex = <% $index++  %>
											type     = "number"
											step     = "1"
											size     = "5"
											name     = "<% $student->id %>_ranks"
											min      = "1"
											max      = "<% scalar @panel_students %>"
											value    = "<% $ARGS{$student->id."_ranks"} %>"
										>

									</span>
%								}

%								if ($points) { 

									<span class="third marno padless centeralign">

%									if ($subscores) { 

%										foreach my $score (@scores) { 

											<span class="quarter centeralign">

												<input 
													class    = "<% $student->id %>"
													type     = "number"
													step     = "<% $step %>"
													name     = "<% $student->id %>_<% $score %>"
													size     = "5"
													min      = "<% $min_subpoints{$score} %>"
													max      = "<% $max_subpoints{$score} %>"
													value    = "<% $ARGS{$student->id."_".$score} %>"
													tabindex = <% $index++ %>
													onBlur = "speakerTotal(
														'<% $student->id %>',
														'<% $entry->id %>'
													);"
												>
											</span>

%										}

										<span class="quarter centeralign">
											<input 
												class    = "<% $entry->id %>"
												type     = "number"
												step     = "<% $step %>"
												name     = "<% $student->id %>_points"
												id       = "<% $student->id %>_points"
												size     = "5"
												min      = "<% $min_subpoints{"total"} %>"
												max      = "<% $max_subpoints{"total"} %>"
												value    = "<% $ARGS{$student->id."_points"} %>"
												tabindex = <% $index++ %>
												onChange = "checkTotal(
													'<% $student->id %>',
													'<% $entry->id %>'
												);"
											>
										</span>

%									} else { 

%										my $class = "totals" unless $event_settings{"team_total_line"};

										<span class="third marno padless centeralign">

											<input 
												type     = "number"
												class    = "<% $class %>"
												ballotID = "<% $ballot->id %>"
												step     = "<% $step %>"
												name     = "<% $student->id %>_points"
												size     = "5"
												min      = "<% $min_points %>"
												max      = "<% $max_points %>"
												value    = "<% $ARGS{$student->id."_points"} %>"
												tabindex = <% $index++ %>
											>
										</span>

%									}
%								}

								</div>

%							}

							</td>

%							if ($tv) { 
								<td>
									<input 
										type  = "checkbox"
										name  = "<% $ballot->id %>_tv"
										value = "1"
									> 
								</td>
%							}

%							if ($forfeit) { 
								<td>
									<input 
										type  = "checkbox"
										name  = "<% $ballot->id %>_forfeit"
										value = "1"
									>
								</td>
%							}

%						}
						
%					} elsif  ($wudc && $wins) { 

						<td>
							<input 
								type     = "checkbox"
								name     = "<% $ballot->id %>_win"
								tabindex = <% $index++ %>
							>
						</td>

%					} else { 
	
						<td>
							<div style="height: 50px;">
							</div>
						</td>
						<td>
							<div style="height: 50px;">
							</div>
						</td>

%					}

					</tr>

<%perl>
					if ($event_settings{"team_total_line"}) { 


						my $columns = 3;

						if ($subscores) { 
							$columns += scalar @scores;
						} else { 
							$columns++ if $points;
						}

						$columns++ if $ranks;

</%perl>
						<tr class="<% ($switch % 2) ? "odd" : "even" %>">

							<td
								class="rightalign bluetext strong" 
								colspan="<% $columns %>"
							><% $entry->code %> TOTAL:</td>

							<td class="centeralign">
								<input 
									ballotID = "<% $ballot->id %>"
									type    = "number"
									id      = "<% $entry->id %>_total"
									class   = "totals"
									readonly
								>
							</td>

						</tr>

%					}
%					$switch++;
%				}

			</tbody>

%			if ($wins && not defined $wudc) { 

				<tr class="odd">

					<td 
						<% $no_side_constraints ? 'colspan="2"' : ""%>
						class="centeralign semibold redtext"
					>
						Win goes to:
					</td>

					<td <% $subscores ? 'colspan="2"' : "" %> 
						class="centeralign nospace"
						id = "winbox"
					>

						<select 
							id       = "winner"
							name     = "winner"
							class    = "fixedmed"
							onChange = "checkLPW();"
						>

							<option value="">Choose Winning Entry</option>

%							foreach my $ballot (@ballots) { 
%								next unless $ballot->entry;
								<option 
									value="<% $ballot->id %>" 
									<% $ARGS{"winner"} == $ballot->id ? "selected" : "" %>
								><% $ballot->entry->code %></option>
%							}
						</select>
					</td>


					<td <% $subscores ? 'colspan="3"' : "" %> >

						<div class="nowrap nospace">

						<span class="quarter rightalign semibold redtext bluetext">
							Side:
						</span>

						<label for="winner_1">
							<span class="hover third centeralign">

								<input 
									type  = "radio"
									name  = "winner_side"
									value = "1"
									id    = "winner_1"
									<% $ARGS{"winner_side"} == 1 ? "checked" : "" %>
								>
									<% $aff_string %>
							</span>
						</label>

						<label for="winner_2">

							<span class="hover third centeralign">

								<input 
									type  = "radio"
									name  = "winner_side"
									value = "2"
									id    = "winner_2"
									<% $ARGS{"winner_side"} == 2 ? "checked" : "" %>
								>
								<% $neg_string %>
							</span>
						</label>

						</div>

					</td>

%					if ($wins && $points && $no_lpw < 1) { 

						<td 
							colspan = "2"
							class   = "leftalign nospace"
						>

							<label for="lpw">

								<div 
									id    = "lpwbox"
									class = "hover padleft marno"
								>

									<span class="threequarters centeralign">
										Low-Point Win?
									</span>

									<span class="quarter centeralign">
										<input 
											type  = "checkbox"
											id    = "lpw"
											value = "1"
											name  = "lpw"
											<% $ARGS{"lpw"} ? "checked" : "" %>
										>
									</span>

								</div>

							</label>

						</td>

%					} else { 
	
						<td></td>

%					}
				
				</tr>

			<tr class="liblrow">

				<td colspan="10" class="rightalign">

%			} elsif ($event_settings{"low_lowpoints"}) { 

				<tr class="liblrow">

					<td colspan="2" class="centeralign">

						<label for="lpw">

							<div class="hover padleft marno">

								<span class="threequarters">
									Low-Point Ranks?
								</span>

								<span class="quarter centeralign">

									<input 
										type  = "checkbox"
										id    = "lpw"
										value = "1"
										name  = "lpw"
										<% $ARGS{"lpw"} ? "checked" : "" %>
									>
								</span>
							</div>
						</label>
					</td>

					<td colspan="9" class="rightalign">

%			} else { 

				<tr class="liblrow">
					<td colspan="10" class="rightalign">
%			}

					<input type="submit" value=" Submit Ballot ">
				</td>
			</tr>
		</table>

%		if ($points && $min_points != $min_ob_points || $max_points != $max_ob_points) { 

			<div class="row smallish redtext semibold centeralign padvertmore">
				* The full point range is 
				<% $min_points ? $min_points : "0" %><% " - ".$max_points %> 
				but you must ask the tab room to give points outside of 
				<% $min_ob_points." - ".$max_ob_points %>.

			</div>
%		}

%		if ($i_can_haz_doubled) { 
			<div class="row smallish redtext semibold centeralign padvertmore">
				&dagger; These entries are doubled entered in another category
				this round.  Please accomodate their need to leave early, or
				wait for them to appear late.
			</div>
%		}


		<div class="full">

			<span class="third">
				<h4>General Feedback</h4>
			</span>

%			if (scalar @ballots > 3) { 

				<span class="twothirds rightalign">

					<span class="half rightalign bigger semibold bluetext">
						Comments:
					</span>

					<span class="half centeralign">

						<select
							class="fixedmed"
							onChange = "switchBox(this);"
						>

							<option value="rfd">Reason for Rankings</option>

<%perl>
							foreach my $ballot (@ballots) { 

								my $entry = $ballot->entry if $ballot->entry;
								next unless $entry;
								next if $entry->dropped;

</%perl>
								<option 
									value="<% $ballot->id %>"
								><% $entry->code 
									%>&nbsp;&nbsp;<% 
									$entry->code ne $entry->name ? $entry->name : "" 
								%></option>
%							}

						</select>
					</span>
				</span>
%			}
		</div>

		<ul id="tabnav"> 

%			if (scalar @ballots < 4) { 
				
				<li id="header_rfd" class="selected commentzing"> 
					<a onclick="return doneSwitch('rfd')">
						Reason for 
						<% $type eq "speech" 
							|| $type eq "congress" 
							? "Rankings" : "Decision" %>
					</a>
				</li>

%				@ballots = sort {$a->entry->code cmp $b->entry->code} @ballots;

%				foreach my $ballot (@ballots) { 

%					next unless $ballot->entry;

					<li id="header_<% $ballot->id %>" class="commentzing">
						<a 
							onclick="return doneSwitch(<% $ballot->id %>)"
						><% $ballot->entry->code %></a>
					</li>
%				}
%			}

			</ul>

		<div id="box_rfd" class="commentary">

			<p class="semibold greentext centeralign full">
				These comments go to all participants in the round.  

				<% $event_settings{'rfd_plz'} 
					? "Must be at least ".$event_settings{'rfd_plz'}." words long." 
					: ""
				%>
			</p>

<%perl>
			my $rfd = Tab::Score->search( 
				tag    => "rfd",
				ballot => $ballots[0]->id
			)->first if @ballots;
</%perl>

			<div class="full centeralign">
				<textarea 
					name = "rfd"
					rows = "15"
					cols = "60"
				><% $rfd ? $rfd->content : "" %></textarea>
			</div>

		</div>

%		unless ($event->type eq "congress") { 
%		BALLOT:
%		foreach my $ballot (@ballots) { 

			<div 
				id    = "box_<% $ballot->id %>"
				class = "commentary hidden"
			>

<%perl>

				my $entry = $ballot->entry;

				unless ($entry) { 
					$ballot->delete;
					next BALLOT;
				} 

				my $code = $entry->code;
				$code .= " &ndash; ".$entry->school->code if $ballot_school_code;
				$code .= " &ndash; ".$entry->school->name if $ballot_school_name;
				$code .= " &ndash; ".$entry->name if $ballot_entry_name;
				$code .= " &ndash; ".$entry->setting("title") if $ballot_entry_title;
				if ($ballot_entry_first_name) { 
					foreach my $student ($entry->students) { 
						$code .= " &ndash; ".$student->first;
					}
				}
				
</%perl>

				<p class="semibold bluetext centeralign full">
					These comments go only to <% $code %> &amp; coaches
				</p>

<%perl>
				my $comments = Tab::Score->search( 	
					tag    => "comments",
					ballot => $ballot->id
				)->first;
</%perl>

				<div class="row centeralign">
					<textarea 
						name = "comments_<% $ballot->id %>"
						rows = "15"
						cols = "60"
					><% $comments ? $comments->content : "" %></textarea>
				</div>

			</div>

%		}
%		}

		<div class="libl full rightalign">

			<div class="half centeralign">
				<input 
					type  = "submit"
					value = "Save Comments Only"
					name  = "skipme"
					class = "med"
				>
			</div>

			<div class="half">
				<input 
					type  = "submit"
					value = "Save Comments & Ballot"
					class = "med"
				>
			</div>

			</form>
		</div>

%		if ($event->type eq "congress") { 
			</div>
%		}


	</div>


	<div class="menu">

		<div class="sidenote">

			<h6 class="bluetext semibold marbottom">
				This round
			</h6>

			<div class="row">

				<span class="quarter semibold">
					Round:
				</span>

				<span class="threequarter">
					<% $round->realname %>
				</span>

			</div>

			<div class="row">

				<span class="quarter semibold">
					Room:
				</span>
				<span class="threequarter">
					<% $panel->room ? $panel->room->name : "" %>
				</span>

			</div>

%			if ($round->flighted > 1) { 
				<div class="row">
	
					<span class="quarter nowrap semibold">
						Flight
					</span>

					<span class="threequarter">
						<% $panel->flight %>
					</span>

				</div>
%			}

%			if ($round->setting("num_judges") > 1) { 
				
				<div class="row nospace">

				<span class="quarter semibold">
					Panel:
				</span>

				<span class="threequarters nospace">

%					foreach my $other_judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

%						next if $other_judge->id == $judge->id;

						<div class="nowrap padless marno">
							<% $other_judge->code." ".$other_judge->first." ".$other_judge->last %>
						</div>
%					}

				</span>

				</div>

%			}

			<a 
				href="/index/tourn/postings/round.mhtml?tourn_id=<% $event->tourn->id %>&round_id=<% $round->id %>" 
				class="blue full martopmore">
				Full Pairing/Schematic
			</a>

		</div>

<%perl>

		my $point_scale = $event_settings{"point_scale"};
		my $speech_times = $event_settings{"speech_times"};

		if ($point_scale) { 

			$point_scale = $m->comp(
				"/funclib/save_editor.mas", 
					text        => $point_scale,
					restrictive => 1
				);

			my @point_lines = split(/\R/, $point_scale);

</%perl>

			<div class="sidenote lowspace">

				<h6 class="bluetext semibold marbottom">
					Point Scale
				</h6>

%				foreach my $line (@point_lines) { 

%					$line =~ s/\.\.\./<\/span><span class="rightalign right">/g;

					<div class="odd full lightborder padless marno">
						<span class="bluetext semibold">
							<% $line %>
						</span>
					</div>
%				}
			</div>
%		}


<%perl>

		if ($speech_times) { 

			$speech_times = $m->comp(
				"/funclib/save_editor.mas", 
					text        => $speech_times,
					restrictive => 1
				);

			my @time_lines = split(/\R/, $speech_times);

</%perl>

			<div class="sidenote lowspace">

				<h6 class="bluetext semibold marbottom">
					Speech Times
				</h6>

%				foreach my $line (@time_lines) { 

%					$line =~ s/\.\.\./<\/span><span class="rightalign right">/g;

					<div class="odd full lightborder padless marno">
						<span class="bluetext semibold">
							<% $line %>
						</span>
					</div>
%				}
			</div>
%		}

		<div class="sidenote">

			<h4>Other ballots</h4>

%			foreach my $opanel ($m->comp("/funclib/person_panels.mas", person => $person)) { 

%				next unless $opanel->round->published;
%				next if $opanel->id == $panel->id;

				<a 
					class="yellow full" 
					href="ballot.mhtml?panel_id=<% $opanel->id %>&judge_id=<% $opanel->judge %>">
					<% $opanel->round->event->abbr %> 
					<% $opanel->round->realname %> 
					<% $opanel->round->flighted > 1 ? "Flt ".$opanel->flight : "" %> 
					Pending
				</a>
%			}


%			foreach my $opanel ($m->comp("/funclib/person_panels.mas", person => $person, done => 1)) { 

%				next if $opanel->id == $panel->id;

				<a 
					class="blue full" 
					href="ballot_view.mhtml?panel_id=<% $opanel->id %>&judge_id=<% $opanel->judge %>">

					<% $opanel->round->event->abbr %>
					<% $opanel->round->realname %>
					<% $opanel->round->flighted > 1 ? "Flt ".$opanel->flight : "" %>
					Done
				</a>
%			}

		</div>

	</div>
