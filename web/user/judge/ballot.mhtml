<%args>
	$person
	$person_settings
	$panel_id => undef
	$judge_id => undef
	$errs     => undef
</%args>
<%init>

	unless ($panel_id && $judge_id) {
		my $err = "I didn't get both a judge and a ballot record";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $dbh = Tab::DBI->db_Main();

	my $panel = Tab::Panel->retrieve($panel_id);
	$m->abort unless $panel;
	$m->comp("/funclib/panel_dedupe.mas", panel => $panel);

	my $judge = Tab::Judge->retrieve($judge_id);

	my $round    = $panel->round;
	my $event    = $round->event;
	my $category = $event->category;
	my $tourn    = $category->tourn;

	my %event_settings = $event->all_settings;

	if ($round->setting("use_normal_rooms")) {
		$event_settings{"online_mode"} = "sync";
	}

	my $event_type = $event->type;

	my %tb_types = $m->comp(
		"/funclib/tiebreak_types.mas",
		round => $round
	);


	if (
		$event_type eq "wsdc" && $tb_types{"point"}
	) {
		$m->redirect("wsdc_ballot.mhtml?panel_id=".$panel->id."&judge_id=".$judge->id);
	}

	my %tourn_settings = $tourn->all_settings();

	if ($tourn_settings{"legion"}) {
		$m->redirect("legion_ballot.mhtml?panel_id=".$panel->id."&judge_id=".$judge->id);
	}

	my $ballot_header;

	if ($tourn_settings{"nsda_district"}
		|| $tourn_settings{"nsda_nats"}
		|| $tourn_settings{"nsda_ms_nats"}
		|| $tourn_settings{"nsda_billing"}
	) {

		my $nsda_district_ballot_header
			= Tab::TournSetting->search(
				tourn => 0,
				tag   => "nsda_district_ballot_header"
			)->first;

		$ballot_header = $nsda_district_ballot_header->value_text();
	}

	my $tourn_logo = $tourn_settings{"logo"};
	my %category_settings = $category->all_settings;

	if ($event_settings{"no_judge_violations"}) {
		undef $tb_types{"tv"};
	}

	my $now = DateTime->now();

    my %max_subpoints = ();
    my %min_subpoints = ();

    my @scores = ("Style", "Content", "Strategy", "POI");

    foreach my $key (@scores) {
        $min_subpoints{$key} = $event_settings{"min_".lc($key)."_points"};
        $max_subpoints{$key} = $event_settings{"max_".lc($key)."_points"};
        $min_subpoints{$key} = 0 unless $min_subpoints{$key};
        $min_subpoints{"total"} += $min_subpoints{$key} unless $key eq "POI";
        $max_subpoints{"total"} += $max_subpoints{$key} unless $key eq "POI";
    }

    my $trash = pop @scores unless $max_subpoints{"POI"};
	my $no_lpw++ if $event_settings{"no_lpw"};

	$event_settings{"aff_label"} = "Aff" unless $event_settings{"aff_label"};
	$event_settings{"neg_label"} = "Neg" unless $event_settings{"neg_label"};

	my $start_bias = DateTime->new(
		year      => 2021,
		month     => 8,
		day       => 1,
		hour      => 0,
		minute    => 0,
		second    => 0,
		time_zone => "UTC"
	);

	if (
		($tourn->start > $start_bias || $tourn_settings{"bias_saved"})
		&& (not defined $tourn_settings{"bias_statement"})
	) {

		$tourn_settings{"bias_statement"} = eval {

			my $bias_statement = Tab::TabroomSetting->search(
				tag   => "bias_statement"
			)->first;

			return $bias_statement->value_text;
		}
	}

	my $motion         = $round->setting("motion");
	my $motion_publish = $round->setting("motion_publish");

	my $ballot_entry_name       = $category_settings{"ballot_entry_names"};
	my $ballot_entry_first_name = $category_settings{"ballot_entry_first_names"};
	my $ballot_school_code      = $category_settings{"ballot_school_codes"};
	my $ballot_school_name      = $category_settings{"ballot_school_names"};

	my $flip_status = $panel->setting('flip_status');

	undef $category_settings{"ballot_entry_titles"} unless $event_type eq "speech";

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	$now->set_time_zone($tz);

	my $start = $round->start_time;
	$start = $round->timeslot->start unless $start;
	$start->set_time_zone($tz);

	my $decision_deadline;
	my $decision_time;

	if ($round->type eq "elim" || $round->type eq "final") {
		$decision_deadline = $event_settings{"elim_decision_deadline"};
	} else {
		$decision_deadline = $event_settings{"prelim_decision_deadline"};
	}

	if ($decision_deadline) {
		$decision_time = $start->clone;
		$decision_time->add("minutes", $decision_deadline);
	}

	if ($event_settings{"flight_offset"}) {
		foreach my $flight (2 .. $panel->flight) {
			$decision_time->add('minutes', $event_settings{"flight_offset"}) if $decision_time;
			$start->add('minutes', $event_settings{"flight_offset"});
		}
	}

	my $time_left;

	if ($decision_time) {
		$time_left = ($decision_time - $now);
	}

	my %bq_stuff;

	if ($event_settings{"big_questions"}) {

        $bq_stuff{bqd_logo}  = "lib/images/big-questions-logo.jpg";
        $bq_stuff{nsda_logo} = "lib/images/nsda-logo-printable.png";
        $bq_stuff{jtf_logo}  = "lib/images/templeton-logo.png";

        $bq_stuff{resolution} = Tab::TournSetting->search(
            tourn => 0,
            tag   => "bqd_resolution"
        )->first;

        $bq_stuff{resolution} = $m->comp("/funclib/print_format.mas",
            message =>  $bq_stuff{resolution}->value_text
        );

        $bq_stuff{rules} = Tab::TournSetting->search(
            tourn => 0,
            tag   => "bqd_rules"
        )->first;

        $bq_stuff{rules} = $bq_stuff{rules}->value_text;

		$bq_stuff{rules} =~ s/\n/<br \/>/g;
	}

	my $wudc++ if $event_type eq "wudc";

	unless ($panel && $judge) {
		my $err = "No ballots found for that judge and that panel.";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $notme;

	if ($judge->person->id == $person->id) {

	} elsif ($person->site_admin) {
		$notme++;
	} else {
		my $err = "You are not authorized to enter ballots for that judge.";
		$m->redirect("/user/home.mhtml?err=$err")
	}

	unless ($round->tiebreak_set) {
		my $err = "That tournament does not have tiebreakers set.";
		$err .= " Please contact the tournament tab staff to let them know.";
		$m->redirect("/user/judge/panels.mhtml?err=$err");
	}

	my @ballots = sort {$a->side <=> $b->side}
		Tab::Ballot->search(
			judge => $judge->id,
			panel => $panel->id
		);

	if (
		$event_type eq "speech"
		|| $event_settings{"no_side_constraints"}
		|| $event_settings{"sort_precedence"}
	) {
		@ballots =
			sort {$a->speakerorder <=> $b->speakerorder}
			@ballots;
	}

	my @clean;
	my $chair;
	my $audit = 1;
	my $i_can_haz_doubled;

	foreach my $ballot (@ballots) {
		next unless $ballot->entry > 0;

		unless ($chair) {
			$chair++ if $ballot->chair;
		}

		undef $audit unless $ballot->audit;
		push @clean, $ballot;
	}

	@ballots = @clean;
	unless (@ballots) {
		my $err = "That judge does not judge in that room.";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	unless ($notme) {

		# Ballot start time

		my $ballot_check_sth = $dbh->prepare("
			select id from ballot
				where judge = ?
				and panel = ?
				and (
					ballot.judge_started IS NULL
					or ballot.judge_started < ?
				)
		");

		$ballot_check_sth->execute(
			$judge->id,
			$panel->id,
			DateTime::Format::MySQL->format_datetime($tourn->start)
		);

		my ($id) = $ballot_check_sth->fetchrow_array();
		$ballot_check_sth->finish();

		if ($id) {

			my $ballot_sth = $dbh->prepare("
				update ballot set judge_started = NOW() where panel = ? and judge = ?
			");

			$ballot_sth->execute($panel->id, $judge->id);

			$ballot_sth->finish();
		}
	}

	my $team_points++ if $event_settings{"team_points"};
	$team_points++ if $event_type eq "speech";
	$team_points++ if $event_type eq "congress";

	undef $tb_types{"rank"} if $wudc;

	my @panel_students = $m->comp(
		'/funclib/panel_students.mas',
		panel => $panel
	);

	my $forfeit++ if $event_type eq "speech"
		&& $round->tiebreak_set->setting("forfeits_never_break");

	my $max_points = $event_settings{"max_points"};
	my $min_points = $event_settings{"min_points"};

	my $max_ob_points = $event_settings{"max_ob_points"};
	my $min_ob_points = $event_settings{"min_ob_points"};

	$min_ob_points = $min_points unless $min_ob_points;
	$max_ob_points = $max_points unless $max_ob_points;

	my %entry_scores = ();
	my $po_points;

	if ($event_type eq 'congress') {

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 6 unless $max_ob_points;

        my @scores = $m->comp(
            '/funclib/judge_scores.mas',
            judge    => $judge,
            timeslot => $round->timeslot,
            tag      => "speech"
        );

        foreach my $score (@scores) {
            $entry_scores{$score->entryid}{$score->speech} = $score;
			$entry_scores{$score->entryid}{"total"} += $score->value;
			$entry_scores{$score->entryid}{"count"}++;

        }

		if ($event_settings{"po_points_required"}) {
			my @po = $m->comp(
				'/funclib/judge_scores.mas',
				judge    => $judge,
				timeslot => $round->timeslot,
				tag      => "po"
			);

			foreach my $po (@po) {
				$entry_scores{$po->entryid}{"po"}++;
				if ($entry_scores{$po->entryid}{"total"} > 0) {
					$po_points++;
				}
			}
		}

	} elsif ($event_type eq 'speech') {

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 100 unless $max_ob_points;

	} else {

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 30 unless $max_ob_points;

	}

	my $increments = $event_settings{"point_increments"};

	my $step = "1" if $increments eq "whole";
	$step = "0.5"  if $increments eq "half";
	$step = "0.25" if $increments eq "fourths";
	$step = "0.1"  if $increments eq "tenths";


    my $sidelocks++
		if ($round->type eq "elim"
			|| $round->type eq "final"
			|| $round->type eq "runoff"
		) && not defined $event_settings{"no_side_constraints"};

	undef $sidelocks if $event_settings{'sidelock_elims'}
		&& ($round->type eq "elim" || $round->type eq "final");

	my $locked =  $m->comp(
		"/funclib/round_elim_dueaff.mas",
		panel => $panel
	) if $sidelocks;

	my $show_async = $panel->setting("show_async");

	$dbh->disconnect();

</%init>

	<& "/funclib/editor.mas", half => "1" &>

	<script>

		function saveComments(auto) {

			$(".comment_box").each(function() {

				$(this).tinymce().save();

				var textValue = $(this).val();
				var ballotID = $(this).attr("ballot_id");
				var commentType = $(this).attr('type');

				var message = "Save result: ";
				var errors = "Errors: ";

				$.ajax({
					type : 'POST',
					url  : 'comment_save.mhtml',
					data : {
						ballot_id : ballotID,
						text	  : textValue,
						type	  : commentType,
						auto	  : auto
					},

					success : function(data) {

						if (data) {
							if (data.message) {
								if (data.error) {
									errors = errors + data.message;
								} else {
									message = message + data.message;
								}
							} else {
								console.log(data);
								alertify.warning("An error condition was tripped.");
							}
						}
						return;
					}
				});

				if (errors !== "Errors: ") {
					alertify.error("Errors were encountered saving; save whole ballot instead");
				} else if (auto) {
				} else {
					alertify.dismissAll();
					alertify.notify("All comments and feedback were saved", "custom");
				}
			});
			return;
			window.onbeforeunload = null;
		}

		function swapOrder(orderSelector) {

			var ballotID = $(orderSelector).attr("ballot_id");
			var selectedValue = $("#"+orderSelector.id+" option:selected").val();

			if (ballotID && selectedValue) {

				var otherValue = 2;

				if (selectedValue == otherValue) {
					otherValue--;
				}

				$(".speakerorder").each( function() {

					if (this.id != ballotID+"_speakerorder") {
						$("#"+this.id+" option").prop('selected', false);
						$("#"+this.id+" option[value="+otherValue+"]").prop('selected', true);
					}

					$(".orderpick").prop("disabled", true);

				});

				sortTable();
			}
			return;
		}

		function sortTable() {

			var rows = $(".ballotrows").get();

			rows.sort(function(a, b) {
				var A = $("#"+a.id+"_speakerorder option:selected").val();
				var B = $("#"+b.id+"_speakerorder option:selected").val();

				if (A < B) {
					return -1;
				}

				if (A > B) {
					return 1;
				}
				return 0;
			});

			$.each(rows, function(index, row) {
				$("#ballottable").append(row);
				$(row).toggleClass("even");
				$(row).toggleClass("odd");
			});

			return;
		}

		function doneSwitch(which) {
			$('.commentary').addClass("hidden");
			$('#box_'+which).removeClass("hidden");
			$("li.commentzing").removeClass("selected");
			$('#header_'+which).addClass("selected");
			saveComments(true);
		}

		function switchBox(selectTarget) {
			$('.commentary').addClass("hidden");
			$('#box_'+$(selectTarget).val()).removeClass("hidden");
			saveComments(true);
		}

		function speakerTotal(studentID, entryID) {

			var pointTotal = 0;

			$("."+studentID).each(function() {

                var Float = parseFloat(this.value);

                if (Float) {

                    if (Float > this.max) {

						alertify.error(
							Float+" is over the maximum points allowed.  The maximum is "+this.max
						);

						$(this).val("");
						this.focus();

                    } else if (Float < this.min) {

                        alertify.error(
							Float+" is below the minimum points allowed.  The minimum is "+this.min
						);

						$(this).val("");
						this.focus();

                    } else {

                        pointTotal += Float;

                    }
				}

			});

			$("#"+entryID+studentID+"_points")
				.val(pointTotal)
				.change(function() {
					checkTotal(studentID, entryID);
					teamTotal(entryID);
				})
				.trigger("change");
		}

		function checkTotal(studentID, entryID) {

			$("."+studentID+"_row").removeClass("lird");
			$("#"+studentID+"_warning").addClass("hidden");

			var boxTotal = $("#"+studentID+"_points").val();
			var pointTotal = 0;

			$("."+studentID).each(function() {

				var Float = parseFloat(this.value);

				if (Float) {
					pointTotal += Float;
				}

			});

			if (pointTotal != boxTotal) {
				$("."+studentID+"_row").addClass("lird");
				$("#"+studentID+"_warning").removeClass("hidden");
				$("#"+studentID+"_warning").html("Total: "+pointTotal+" vs "+boxTotal);
			}
		}

		function teamTotal(entryID) {

			var teamTotal = 0;

			$("."+entryID).each(function() {

				var Float = parseFloat(this.value);

				if (Float) {
					teamTotal += Float;
				}

			});

			$("#"+entryID+"_total").val(teamTotal);
		}

		function checkLPW(selectMenu) {

			var Winner = parseFloat($('#winner').val());

			if (Winner) {

				var mostPoints = 0;
				var mostBallot = 0;

				$(".totals").each(function() {

					var localPoints = $(this).val();

					if (localPoints > mostPoints) {
						mostBallot  = $(this).attr("ballotID");
						mostPoints = localPoints;
					}

				});

				if (mostBallot != Winner) {

%					if ($event_settings{"no_lpw"} && $tb_types{"point"}) {

						alertify.error(
							"You gave the winning team fewer points.  Please correct."
						);

						$("#winbox").addClass("lird");

%					} else {

						$("#lpwbox").addClass("redtext");
						$("#lpwbox").addClass("semibold");

%					}

				} else {

					$("#winbox").removeClass("lird");
					$("#lpwbox").removeClass("redtext");
					$("#lpwbox").removeClass("semibold");

				}

			} else {

				$("#winbox").removeClass("lird");
				$("#lpwbox").removeClass("redtext");
				$("#lpwbox").removeClass("semibold");

			}
		}

		$(document).ready(function () {

			$("table").trigger("applyWidgets");

			sortTable();

			// I hate shit like this so much
			setTimeout(function(){
				doneSwitch('rfd');
			}, 500);
		});

	</script>

%	my $segment = "truethird";
%	$segment = "quarter" if $event_settings{'big_questions'};

	<div class="main">

		<div>
%			if ($event_settings{'big_questions'}) {
				<span class="<% $segment %> nospace">
					<img
						src   = "<% $bq_stuff{bqd_logo} %>"
						alt   = "<% $bq_stuff{bqd_logo} %>"
						style = "max-width: 164px;"/
					>
				</span>
%			}

			<span class="<% $segment %> nospace">
%				if ($event_settings{"online_mode"} && $event_settings{"online_mode"} ne "async") {
					<h5 class="bluetext inline nospace">
%						if ($event_settings{"online_mode"} eq "sync") {
							<% $panel->room > 0 ? $panel->room->name : "" %>
%						}
						Room Link:
					</h5>
					<& "/funclib/online_room.mas",
						panel  => $panel,
						person => $person,
						class  => "marno top invert"
					&>
%				} else {
					<h5 class="bluetext">
						<% $panel->room > 0
							? "Room: ". $panel->room->name
							: "NO ROOM ASSIGNED"
						%>
					</h5>
%				}
			</span>

			<span title="And you are simply the best!" class="<% $segment %> nospace centeralign">
				<h4 class="graytext">
					<% $judge->first %>
					<% $judge->middle %>
					<% $judge->last %>
				</h4>
			</span>

			<span class="<% $segment %> nospace rightalign">
				<h5 class="bluetext">
					<% $event->abbr %>
					<% $round->realname %>
					<% $round->flighted > 1 ? "Flt ".$panel->flight : "" %>
				</h5>
			</span>

		</div>

%		if ($round->setting("notes")) {
			<p class="warning padleft bluebordertop padtop">
				Note: <% $round->setting("notes") %>
			</p>
%		}

%		if ($ballot_header) {

			<div class="centeralign ltborder">
				<span class="ninetenths biggish leftalign">
					<% $ballot_header %>
				</span>
			</div>
%		}

<%perl>

		if ($event_type eq "congress") {

			my $default = $ARGS{"default"};
			$default = "speeches" unless $default;
			my @tabs;

			if ($chair && $audit) {
				@tabs = ("feedback", "precedence");
				$default = "precedence";
			} elsif ($chair) {
				@tabs = ("feedback", "precedence", "rankings");
				$default = "precedence";
			} elsif ($audit) {
				@tabs = ("speeches");
			} elsif (not defined $audit) {
				@tabs = ("speeches", "rankings");
			}

</%perl>
			<& "/funclib/tabs.mas",
				tabs      => \@tabs,
				default   => $default
			&>

%			if ($event_type eq "congress" && $event_settings{"sort_precedence"}) {

				<div class="precedence screens">
<%perl>
					my $precedence_sth = $dbh->prepare("
						select
							entry.id, entry.code, entry.name,
							ballot.id, ballot.speakerorder, ballot.judge,
							score.id, score.speech

						from (entry, ballot)

							left join score
								on score.ballot = ballot.id
								and score.tag = 'speech'

						where ballot.panel = ?
							and ballot.entry = entry.id
							and entry.active = 1
					");

					$precedence_sth->execute($panel->id);

					my %precedence;
					my $sample_judge;

					while (
						my (
							$entry_id, $code, $name,
							$ballot_id, $precedence, $judge,
							$score_id, $speech
						) = $precedence_sth->fetchrow_array()
					) {

						$precedence{$entry_id}{"order"}    = $precedence;
						$precedence{$entry_id}{"code"}     = $code;
						$precedence{$entry_id}{"name"}     = $name;

						if ($speech) {

							unless ($sample_judge) {
								$sample_judge = $judge;
							}

							if ($sample_judge = $judge) {
								$precedence{$entry_id}{"speeches"}{$speech}++;
							}
						}

					}

					$precedence_sth->finish();
</%perl>
					<& "/funclib/tablesorter.mas",
						table     => "speeches",
						nobuttons => 1
					&>

					<div class="martop">
						<span class="half">
							<h5 class="martop">
								Precedence for Speaking
							</h5>
						</span>

						<span class="half rightalign bigger redtext semibold padtopmore martopless">
							Chamber <% $panel->letter %>
						</span>
					</div>

					<table id="speeches">
						<thead>
							<tr class="yellowrow smallish">
								<th>
									Precedence
								</th>

								<th>
									Entry
								</th>

								<th>
									Speeches
								</th>
							</tr>
						</thead>

						<tbody>
<%perl>
							foreach my $id (
								sort {
									$precedence{$a}{"order"} <=> $precedence{$b}{"order"}
								} keys %precedence
							) {
</%perl>
								<tr>
									<td class="centeralign semibold bluetext">
										<% $precedence{$id}{"order"} %>
									</td>

									<td>
										<span class="spacer"></span>
										<% $precedence{$id}{"code"} %>
										<%
											$precedence{$id}{"code"} ne $precedence{$id}{"name"}
											? $precedence{$id}{"name"}
											: ""
										%>
									</td>

									<td>
<%perl>
										if ($precedence{$id}{"speeches"}) {
											foreach my $speech (
												sort {$a <=> $b} keys %{$precedence{$id}{'speeches'}}
											) {
</%perl>
												<span class="tenth">
													<% $speech %>
												</span>
%											}
%										}
									</td>
								</tr>
%							}
						</tbody>
					</table>
				</div>
%			}

			<div class="feedback screens">
				<&
					"congress_feedback.mas",
						person          => $person,
						person_settings => $person_settings,
						tourn           => $tourn,
						judge           => $judge,
						panel           => $panel,
						event           => $event,
						missing         => $ARGS{"missing"},
						event_settings  => \%event_settings,
						entry_id        => $ARGS{"entry_id"}
				&>

			</div>

			<div class="speeches screens">
				<&
					"congress_speeches.mas",
						person          => $person,
						person_settings => $person_settings,
						tourn           => $tourn,
						judge           => $judge,
						panel           => $panel,
						event           => $event,
						missing         => $ARGS{"missing"},
						event_settings  => \%event_settings,
						entry_id        => $ARGS{"entry_id"}
				&>

			</div>

			<div class="rankings screens">
%		}

%		if ($errs) {

			<div class="borderred centeralign martopmore marbottommore">

				<h6 class="bluetext semibold">
					Oh, drat. Your ballot had errors.
				</h6>

				<span class="semibold redtext bigger">
					<% $errs %>
				</span>

				<p class="bigger semibold bluetext">
					Please correct these before continuing.
				</p>

			</div>
%		}

%		if ($event_settings{big_questions}) {
			<div class="centeralign semibold bluetext padvertmore bigger padbottommore">
				Resolution: <% $bq_stuff{resolution} %>
			</div>

<%perl>

		} elsif ($event_settings{"topic"}) {

			my $topic = Tab::Topic->retrieve($event_settings{"topic"});
			my $text = $topic->topic_text;
			$text =~ s/\r\n/<br\ \/>/g;
			$text =~ s/\n/<br\ \/>/g;
			$text =~ s/\r/<br\ \/>/g;
</%perl>
			<div class="nospace centeralign">
				<div class="semibold bluetext padvertmore bigger padbottommore seveneighths leftalign">
					Topic: <% $text %>
				</div>
			</div>

%		} elsif ($motion_publish) {
			<div class="centeralign semibold bluetext padvertmore bigger padbottommore">
				Motion: <% $motion %>
			</div>
%		} elsif ($event_settings{"resolution"}) {
			<div class="centeralign semibold bluetext padvertmore bigger padbottommore">
				Resolution: <% $event_settings{"resolution"} %>
			</div>
%		}

%		if ($tourn_settings{"bias_statement"}) {
			<div class="padleft padvert padbottomless biggish">
				<% $tourn_settings{"bias_statement"} %>
			</div>
%		}

%		if ($event_settings{big_questions}) {
			<div class="padleft padvert padbottommore">
				<% $bq_stuff{rules} %>
			</div>
%		}

%		if ($event_settings{"ballot_rules"}) {
			<div class="padleft padvert padbottom">
				<% $event_settings{"ballot_rules"} %>
			</div>
%		}

%		if ($chair && $event_settings{"chair_ballot_rules"}) {
			<div class="padleft padvert padbottom">
				<% $event_settings{"chair_ballot_rules"} %>
			</div>
%		}

<%perl>
		if (
			$event_settings{"po_points_required"}
			&& (not defined $po_points)
			&& (not defined $chair)
		) {
</%perl>
			<h6 class="redtext centeralign padmore marbottom semibold">
				You must give points to a presiding officer
			</h6>

			<p class="bigger bluetext">
				This tournament requires you to mark the presiding officer of
				the session and award them points for presiding (under the
				Speeches tab) before you may submit rankings.
			</p>

%		} else {

%		unless ($audit) {

			<form
				action="<% $wudc ? "wudc_save.mhtml" : "ballot_save.mhtml" %>"
				method="post">

			<input
				type  = "hidden"
				name  = "panel_id"
				value = "<% $panel->id %>"
			>

			<input
				type  = "hidden"
				name  = "judge_id"
				value = "<% $judge->id %>"
			>
%		}

%		if ($event_type eq 'speech' || $event_type eq "congress") {
			<& "/funclib/tablesorter.mas",
				table => "sortable",
				nobuttons => 1
			&>
%		}


<%perl>

		if ($event_settings{"truncate_fill"}
			&& $tb_types{"rank"}
			&& ($event_type eq "congress" && (not defined $chair))
		) {
</%perl>

%			if ($event_settings{"scorer_max"}) {
				<h6 class="orangetext centeralign padmore marbottom semibold half">
					Give no rank higher than <% $event_settings{"truncate_fill"} %>
				</h6>
%			}

			<h6 class="bluetext centeralign padmore marbottom semibold half">
				Blanks will be auto-filled with a <% $event_settings{"truncate_fill"} %>
			</h6>


<%perl>
		} elsif ($event_type eq "congress"
			&& $chair
			&& $event_settings{"parli_noautofill"}
			&& (not defined $audit)
		) {
</%perl>

			<h6 class="orangetext centeralign padmore marbottom semibold">
				Parliamentarian Ballot: Please rank ALL entries in order
			</h6>

%		}

%		if ($decision_deadline || $tb_types{"point"} || $event_settings{"flip_online"}) {

			<div class="padvert marbottom centeralign ltbordertop">

%				if ($tb_types{"point"}) {

					<span class="twofifths centeralign nospace">

						<span class="semibold redtext inline marright">
							Points:
						</span>

						Range:
							<% $min_ob_points."-".$max_ob_points %>
							<% ($min_ob_points != $min_points)
							|| ($max_ob_points != $max_points) ? "*" : "" %>.

						<% $step eq "1" ? " Whole points only. " : "" %>

						<% $event_settings{"point_ties"} ?
							"Ties are OK. " : "No ties. " %>

%						if ($event_type eq "speech" || $event_type eq "congress") {
							<% $event_settings{"allow_lowpoints"}
								? ""
								: "<br />Ranks and points must agree. "
							%>
%						}

						<% ($event_type ne "speech" && $event_type ne "congress" )
							&& $no_lpw ? "Winner must have higher points. " : "" %>

						<% $step eq "0.5" ? "Steps of 0.5. " : "" %>
						<% $step eq "0.25" ? "Steps of 0.25. " : "" %>
						<% $step eq "0.1" ? "Steps of 0.1. " : "" %>

					</span>
%				}

%				if ($event_settings{"flip_online"}) {
					<span class="fifth semibold greentext centeralign bigger">
						Flips <% $flip_status eq "done" ? "Complete" : "Incomplete" %>
					</span>
%				}

%				if ($decision_deadline) {

					<span
						class = "twofifths centeralign semibold biggish smidge nospace"
						title = "This deadline is informative; your online ballot will not self-destruct when it expires.  But please vote by the deadline; the tournament cannot progress without your ballot."
					>

						<span class="half bigger">
							Vote by <% Tab::nicetime($decision_time) %>
						</span>

						<span class="orangetext half nospace">
							<span class="fourtenths marno leftalign">
								Time left
							</span>

							<span class="half buttonwhite orangetext orangeborder padbottomless padtopless padleftless padrightless ">
								<& "/funclib/stopwatch.mas",
									label     => "deadline",
									inline    => "true",
									autostart => "true",
									class     => "padtophalf",
									duration  => $time_left,
									default   => 135
								&>
							</span>
						</span>
					</span>
%				}


			</div>
%		}

%		if ($audit) {

			<div class="ltbordertop ltborderbottom full centeralign redtext semibold padvertmuchmore">
				This ballot has been entered and confirmed already.
				Further changes require contacting the tournament staff.
			</div>

%		} else {

		<table id="sortable">

			<thead>

			<tr class="yellowrow smallish centeralign">
<%perl>
				if ($event_settings{"online_mode"} eq "async"
					|| $event_settings{"show_async_links"}
					|| $show_async
				) {
</%perl>
					<th>
						Performance Video
					</th>
%				}

%				if ($event_type eq "wudc") {

					<th>
						Position
					</th>

%				} elsif ($event_type ne "speech" && $event_type ne "congress") {

					<th>
						Side <% $sidelocks ? $locked ? "(Locked)" : "(Flip)" : "" %>
					</th>
%				}

%				if ($event_type ne "wsdc" && $event_settings{"no_side_constraints"}) {
					<th>
						Speaking Position
					</th>
%				} elsif ($event_type eq "speech") {
					<th>
						Speaker Order
					</th>
%				} elsif ($event_type eq "congress" && $event_settings{"sort_precedence"}) {
					<th>
						Precedence
					</th>
%				}

				<th>
					Entry Code
				</th>

%				if ($ballot_school_code) {
					<th>
						Sch Code
					</th>
%				}

%				if ($category_settings{"ballot_region_codes"}) {

%					if ($tourn_settings{"nsda_nats"}) {
						<th>
							State
						</th>
%					} elsif ($tourn_settings{"ncfl"}) {
						<th>
							Diocese
						</th>
%					} else {
						<th>
							Region
						</th>
%					}

%				}

%				if ($ballot_school_name) {
					<th>
						School
					</th>
%				}

%				if ($ballot_entry_name) {
					<th>
						Name
					</th>
%				}

%				if ($ballot_entry_first_name) {
					<th>
						First Name
					</th>
%				}
%				if ($category_settings{'ballot_entry_titles'}) {
					<th>
						Title/Question
					</th>
<%perl>
				}

				if ($wudc && $tb_types{"winloss"} && $round->type eq "elim") {
</%perl>
					<th>
						Advance (2)
					</th>

%				} elsif ($wudc && $tb_types{"winloss"} && $round->type eq "final") {

					<th>
						Champion
					</th>
%				}


%				if ($event_type eq "congress" && (not defined $audit)) {

%					if ($event_settings{"po_points_required"}) {
						<th title="Presiding Officers">
							PO
						</th>
%					}

					<th>
						Speech Points
					</th>

					<th>
						Average
					</th>

					<th>
						Rank
					</th>

%					if ($tb_types{"point"}) {
						<th>
							Speaker Points
						</th>
%					}

%					if ($chair && $tb_types{"best_po"}) {
						<th>
							Best PO
						</th>
%					}

<%perl>
				} elsif (
					($audit ne "1")
					|| ($person->site_admin)
				) {

					my $num;
					$num++ if $tb_types{"rank"};
					$num++ if $tb_types{"point"};

					if ($num > 0) {
</%perl>
						<th colspan="<% $num %>">
<%perl>
						my $tick;

						if (
							($tb_types{"rank"} || $tb_types{"point"}
							&& (scalar @panel_students > scalar @ballots)
						)
							&& not defined $team_points
						) {

							$tick++;
</%perl>
							<span class="half marno padless leftalign">
								Speaker
							</span>
%						}

%						if ($tb_types{"rank"}) {
							<span class="<%
								$tb_types{"point"} && (not defined $team_points)
									? "quarter padless"
									: "half"
								%> marno centeralign borer">
								Rank
							</span>
%						}

%						if ($tb_types{"point"}) {
							<span class="<%
								$tb_types{"rank"} && (not defined $team_points)
									? "quarter padless"
									: "half"
							%> marno centeralign">
%							if ($event_settings{"wsdc_categories"}) {
%								foreach my $score (@scores) {
									<span class="marno quarter centeralign">
										<% ucfirst ($score) %><br />
										(<% $min_subpoints{$score} %> - <% $max_subpoints{$score} %>)
									</span>
%								}
								<span class="marno quarter centeralign semibold">
									Total <br />
									(<% $min_subpoints{"total"} %> - <% $max_subpoints{"total"} %>)
								</span>
%							} else {
								<% $team_points && $event_type eq "debate"
									? " Team "
									: ""
								%> Points
%							}
							</span>
%						}
						</th>

%						if ($category_settings{"ballot_times"} && $event->type eq "speech") {
							<th>
								Piece Time
							</th>
%						}

%						if ($tb_types{"tv"}) {
							<th>
								Violation
							</th>
%						}

%						if ($forfeit) {
							<th>
								No show?
							</th>
%						}
%					}
%				}

			</tr>

			</thead>

			<tbody id="ballottable">

<%perl>

			my $index = 1;
			my $switch;
			my %doubled;

			unless ($event_settings{"online_mode"} eq "async") {
				%doubled = $m->comp("/funclib/round_doubled.mas", round => $round);
			}

			foreach my $ballot (@ballots) {

				my $entry = $ballot->entry;
				next unless $entry;

				next if $entry->dropped && ($event_type eq "speech" || $event_type eq "congress");

				my $positions = $entry->setting("positions");
				my %sort;

				my @students = $entry->students;

				if ($event_type eq "debate" && (scalar @students > 2)) {
					foreach my $student (@students) {
						if ($positions->{$student->id} eq "1S") {
							$sort{$student->id} = 1;
						} elsif ($positions->{$student->id} eq "2S") {
							$sort{$student->id} = 2;
						} elsif ($positions->{$student->id} eq "2A") {
							if ($ballot->side == 1) {
								$sort{$student->id} = 2;
							} else {
								$sort{$student->id} = 1;
							}
						} elsif ($positions->{$student->id} eq "2N") {
							if ($ballot->side == 1) {
								$sort{$student->id} = 1;
							} else {
								$sort{$student->id} = 2;
							}
						}
					}
				}

				my $doubled = scalar (keys %{$doubled{$ballot->entry}});
				my $daggers;

				foreach (1 .. $doubled) {
					$daggers .= "&dagger;";
				}

				$i_can_haz_doubled++ if $doubled;

</%perl>
				<tr
					id    = "<% $ballot->id %>"
					class = "<% ($switch % 2) ? "odd" : "even" %> ballotrows"
				>

<%perl>
					if ($event_settings{"online_mode"} eq "async"
						|| $event_settings{"show_async_links"}
						|| $show_async
					) {
</%perl>
						<td class="centeralign">
%							if ($entry && $entry->setting('video_link')) {
								<a
									target = "_blank"
									class  = "buttonwhite bluetext invert fa fa-video-camera"
									href   = "<% $entry->setting('video_link') %>"
								></a>
%							} else {
								<span class="full nospace semibold orangetext">
									NO VIDEO
								</span>
%							}
						</td>
%					}
<%perl>

					my $columns = scalar @students;
					$columns = 1 if $team_points;
					$columns = 1 unless ($tb_types{"point"} || $tb_types{"rank"});

					unless ($event_type eq "speech" || $event_type eq "congress") {

						$m->print('<td class = "centeralign" >');

							if (
								($event_settings{"no_side_constraints"}
									|| $sidelocks && not defined $locked
								) && (not defined $event_settings{"flip_online"})
							) {
</%perl>

								<select
									name  = "<% $ballot->id %>_side"
									class = "fixedtiny chosen"
								>

									<option
										value    = ""
									>Pick</option>

									<option
										value = "1"
										id    = "aff"
										<% $ballot->side == 1 ? "selected" : ""%>
									><% $event_settings{"aff_label"} %></option>

									<option
										value = "2"
										id    = "neg"
										<% $ballot->side == 2 ? "selected" : ""%>
									><% $event_settings{"neg_label"} %></option>

								</select>

<%perl>
							} elsif ($wudc && (
								$round->type eq "elim"
								|| $round->type eq "final"
								|| $round->type eq "runoff")
							) {
</%perl>
								<select name="<% $ballot->id %>_speakerorder">
									<option value="">Pick</option>
									<option value="1">1st Gov</option>
									<option value="2">1st Opp</option>
									<option value="3">2nd Gov</option>
									<option value="4">2nd Opp</option>
								</select>

%							} elsif ($wudc) {

								<% ($ballot->speakerorder == 1) ? "1st Gov" : "" %>
								<% ($ballot->speakerorder == 2) ? "1st Opp" : "" %>
								<% ($ballot->speakerorder == 3) ? "2nd Gov" : "" %>
								<% ($ballot->speakerorder == 4) ? "2nd Opp" : "" %>

%							} else {
								<% ($ballot->side == 1) ? $event_settings{"aff_label"} : $event_settings{"neg_label"} %>
%							}

						</td>

<%perl>
						if ($event_settings{"no_side_constraints"}
							&& (not defined $event_settings{"flip_online"})
						) {
</%perl>

							<td class='centeralign'>

								<select
									id        = "<% $ballot->id %>_speakerorder"
									name      = "<% $ballot->id %>_speakerorder"
									ballot_id = "<% $ballot->id %>"
									class     = "fixedtiny speakerorder plain"
									onChange  = "swapOrder(this);"
								>

									<option
										value = ""
										class = "orderpick"
									>Pick</option>

									<option
										value = "1"
										id    = "1"
										class = "orders"
										<% $ballot->speakerorder == 1 ? "selected" : ""%>
									>1st</option>

									<option
										value = "2"
										id    = "2"
										class = "orders"
										<% $ballot->speakerorder == 2 ? "selected" : ""%>
									>2nd</option>

								</select>
							</td>

%						} elsif ($event_settings{"no_side_constraints"} && $event_settings{"flip_online"}) {

							<td class='centeralign'>
								<% $ballot->speakerorder == 1 ? "1st Speakers" : ""%>
								<% $ballot->speakerorder == 2 ? "2nd Speakers" : ""%>
							</td>
%						}
%					}

%					if ($event_type eq "speech") {
						<td class='centeralign'>
							<% Lingua::EN::Numbers::Ordinate::ordinate($ballot->speakerorder) %>
						</td>
%					}

%					if ($event_type eq "congress" && $event_settings{"sort_precedence"}) {
						<td class='centeralign'>
							<% $ballot->speakerorder %>
						</td>
%					}

					<td class = "leftalign semibold padvertmore">
						<span class="inline redtext semibold">
							<% $doubled ? $daggers : "" %>
						</span>
						<% $entry->code %>
					</td>


%					if ($ballot_school_code) {
						<td class = "centeralign">
							<% $entry->school->code %>
						</td>
%					}

%					if ($category_settings{"ballot_region_codes"}) {
						<td class = "centeralign">
							<% $entry->school->region->code %>
						</td>
%					}

%					if ($ballot_school_name) {
						<td class = "padleftmore">
							<% $entry->school->name %>
						</td>
%					}

%					if ($ballot_entry_name) {
						<td class = "padleftmore" >
							<% $entry->name %>

						</td>
%					}

%					if ($ballot_entry_first_name) {
						<td class = "centeralign" >
%							foreach my $student ($entry->students) {
								<div class="fixedflex">
									<% $student->first %>
								</div>
%							}
						</td>
%					}

<%perl>
					if ($category_settings{'ballot_entry_titles'}) {

						my $exists = $ballot->scores(
							tag => "title"
						)->first;

						my $title;

						if ($exists) {
							$title = $exists->text;
						} else {
							$title = $entry->setting("title");
						}

</%perl>
						<td class="centeralign">

							<input
								type          = "text"
								name          = "<% $ballot->id %>"
								target_id     = "<% $ballot->id %>"
								property_name = "title"
								tabindex      = -1
								value         = "<% $title %>"
								size          = "30"
								placeholder   = "Enter title or extemp question"
								onBlur        = "postSwitch(this, 'title_save.mhtml');"
							>
						</td>
%					}

%					if ($event_type eq "congress" && (not defined $audit)) {

%						if ($event_settings{"po_points_required"}) {
							<td class="centeralign semibold greentext">
								<%
									$entry_scores{$entry->id}{"po"} ? "PO" : ""
								%><%
									$event_settings{"po_rank_message"} ? "*" : ""
								%>
							</td>
%						}

						<td class="centeralign">
<%perl>
							my $notfirst;
							foreach my $speech (keys %{$entry_scores{$entry->id}}) {
								next if $speech eq "total";
								next if $speech eq "po";
								next if $speech eq "count";
								$m->print(", ") if $notfirst++;
								$m->print($entry_scores{$entry->id}{$speech}->value);
							}
</%perl>
						</td>

						<td class="centeralign">
%							if ($entry_scores{$entry->id}{"count"}) {
								<% Math::Round::nearest(
									.01,
									($entry_scores{$entry->id}{"total"} / $entry_scores{$entry->id}{"count"})
								) %>
%							}
						</td>
<%perl>
					}

					unless ($event_type eq "congress" && $chair && $audit) {

						if ($tb_types{"point"} || $tb_types{"rank"}) {
							my $notfirst;

							if ($team_points) {

								if ($tb_types{"rank"}) {
</%perl>
									<td class="centeralign">
										<input
											tabindex = <% $index++ %>
											type     = "number"
											step     = "1"
											size     = "5"
											name     = "<% $ballot %>_ranks"
											max      = "<% scalar @panel_students %>"
											value    = "<% $ARGS{$ballot."_ranks"} %>"
										>
									</td>
%								}

%								if ($tb_types{"point"}) {

									<td <% $tb_types{"rank"} ? "" : 'colspan="2"' %>
										class="centeralign">

										<input
											class    = "<% $entry->id %>"
											type     = "number"
											step     = "<% $step %>"
											name     = "<% $ballot->id %>_points"
											id       = "<% $ballot->id %>_points"
											size     = "5"
											min      = "<% $min_points %>"
											max      = "<% $max_points %>"
											value    = "<% $ARGS{$ballot->id."_points"} %>"
											tabindex = <% $index++ %>
										>
									</td>
%								}

%								if ($category_settings{"ballot_times"} && $event->type eq "speech") {
									<td class="centeralign nospace">
										<label for="<% $ballot->id %>_time">
											<span class="full padvertless hover">
												<input
													type        = "text"
													size        = "6"
													name        = "<% $ballot->id %>_time"
													placeholder = "0:00"
												>
											</span>
										</label>
									</td>
%								}

%								if ($tb_types{"tv"}) {
									<td class="centeralign nospace">
										<label for="<% $ballot->id %>_tv">
											<span class="full padvertless hover">
												<input
													type  = "checkbox"
													name  = "<% $ballot->id %>_tv"
													value = "1"
												>
											</span>
										</label>
									</td>
%								}

%								if ($forfeit) {
									<td class="centeralign nospace">
										<label for="<% $ballot->id %>_forfeit">
											<span class="full padvertless hover">
												<input
													type  = "checkbox"
													name  = "<% $ballot->id %>_forfeit"
													value = "1"
													<& "/funclib/warn.mas",
														warn => "You are marking the student as having forfeited the round.  Be sure you accomodated their double entry and are following the tournament policy on forfeits before doing so.  This entry will receive no ranks or points." &>
												>
											</span>
										</label>
									</td>
%								}

%							} else {

								<td colspan="4" class="nospace">
<%perl>
								my $length = "half";
								$length = "third" if $tb_types{"rank"} && $tb_types{"point"};

								my $notfirst;

								foreach my $student (
									sort {
										$sort{$a} <=> $sort{$b}
										|| $a->last cmp $b->last
									} @students
								) {
</%perl>

									<div class="padless marno <% $notfirst++ ? "ltbordertop" : "" %> centeralign">

										<span class='smallish <% $length %> marno padless leftalign <% $student->id."_row" %>' >

											<% substr($student->first." ".$student->last.":", 0, 30) %>

											<div
												id    = "<% $student->id %>_warning"
												class = "hidden redtext semibold nospace padtop"
											>
												Total incorrect!
											</div>

										</span>

%									if  ($tb_types{"rank"}) {

										<span class="<% $length eq "half" ? "half" : "third" %> marno padless centeralign">
											<input
												tabindex = <% $index++  %>
												type     = "number"
												step     = "1"
												size     = "5"
												name     = "<% $student %>_ranks"
												min      = "1"
												max      = "<% scalar @panel_students %>"
											>
										</span>
%									}

%									if ($tb_types{"point"}) {

										<span class="<% $length eq "half" ? "half" : "third" %> marno padless centeralign">

%										if ($event_settings{"wsdc_categories"}) {

%											foreach my $score (@scores) {

												<span class="quarter centeralign">
													<input
														class    = "<% $student->id %>"
														type     = "number"
														step     = "<% $step %>"
														name     = "<% $student->id %>_<% $score %>"
														size     = "5"
														min      = "<% $min_subpoints{$score} %>"
														max      = "<% $max_subpoints{$score} %>"
														value    = "<% $ARGS{$student->id."_".$score} %>"
														tabindex = <% $index++ %>
														onBlur = "speakerTotal(
															'<% $student->id %>',
															'<% $entry->id %>'
														);"
													>
												</span>
%											}

											<span class="quarter centeralign">
												<input
													class    = "<% $entry->id %>"
													type     = "number"
													step     = "<% $step %>"
													name     = "<% $student %>_points"
													id       = "<% $student %>_points"
													size     = "5"
													min      = "<% $min_subpoints{"total"} %>"
													max      = "<% $max_subpoints{"total"} %>"
													value    = "<% $ARGS{$student."_points"} %>"
													tabindex = <% $index++ %>
													onChange = "checkTotal(
														'<% $student->id %>',
														'<% $entry->id %>'
													);"
												>
											</span>

%										} else {

%											my $class = "totals" unless $event_settings{"team_total_line"};

											<span class="third marno padless centeralign">

												<input
													type     = "number"
													class    = "<% $class %>"
													ballotID = "<% $ballot->id %>"
													step     = "<% $step %>"
													name     = "<% $student %>_points"
													size     = "5"
													min      = "<% $min_points %>"
													max      = "<% $max_points %>"
													value    = "<% $ARGS{$student."_points"} %>"
													tabindex = <% $index++ %>
												>
											</span>
%										}
%									}
								</div>
%								}

								</td>

%								if ($tb_types{"tv"}) {
									<td>
										<input
											type  = "checkbox"
											name  = "<% $ballot->id %>_tv"
											value = "1"
										>
									</td>
%								}

%								if ($forfeit) {
									<td>
										<input
											type  = "checkbox"
											name  = "<% $ballot->id %>_forfeit"
											value = "1"
										>
									</td>
%								}
%							}
%						} elsif  ($wudc && $tb_types{"winloss"}) {
							<td>
								<input
									type     = "checkbox"
									name     = "<% $ballot->id %>_win"
									tabindex = <% $index++ %>
								>
							</td>
%						}

%						if ($chair && $tb_types{"best_po"}) {
							<td class="centeralign">
								<input
									type     = "radio"
									name     = "best_po"
									value    = "<% $ballot->id %>"
									tabindex = -1
								>
							</td>
%						}
%					}
				</tr>

<%perl>
					if ($event_settings{"team_total_line"}) {

						my $columns = 3;

						if ($event_settings{"wsdc_categories"}) {
							$columns += scalar @scores;
						} else {
							$columns++ if $tb_types{"point"};
						}

						$columns++ if $tb_types{"rank"};

</%perl>
						<tr class="<% ($switch % 2) ? "odd" : "even" %>">

							<td
								class="rightalign bluetext semibold"
								colspan="<% $columns %>"
							><% $entry->code %> TOTAL:</td>

							<td class="centeralign">
								<input
									ballotID = "<% $ballot->id %>"
									type    = "number"
									id      = "<% $entry->id %>_total"
									class   = "totals"
									readonly
								>
							</td>

						</tr>

%					}
%					$switch++;
%				}
			</tbody>
		</table>

%		if ($event_settings{"po_rank_message"}) {
			<div class="ltbordervert semibold centeralign bluetext">
				<% $event_settings{"po_rank_message"} %>
			</div>
%		}

%		if ($tb_types{"winloss"} && not defined $wudc) {

			<div class="odd">

				<span class="quarter semibold bluetext rightalign">
					Winner
				</span>

				<span class="quarter leftalign" id = "winbox">

					<select
						id       = "winner"
						name     = "winner"
						class    = "fixedmed"
						onChange = "checkLPW();"
					>

						<option value="">Choose Winning Entry</option>

%						foreach my $ballot (@ballots) {
%							next unless $ballot->entry;
							<option
								value="<% $ballot->id %>"
								<% $ARGS{"winner"} == $ballot->id ? "selected" : "" %>
							><% $ballot->entry->code %></option>
%						}
					</select>
				</span>

				<span class="quarter centeralign">
					<div class="nowrap nospace">
						<span class="quarter rightalign semibold bluetext bluetext">
							Side
						</span>

						<label for="winner_1">
							<span class="hover third centeralign">
								<input
									type  = "radio"
									name  = "winner_side"
									value = "1"
									id    = "winner_1"
									<% $ARGS{"winner_side"} == 1 ? "checked" : "" %>
								>
								<% $event_settings{"aff_label"} %>
							</span>
						</label>

						<label for="winner_2">
							<span class="hover third centeralign">

								<input
									type  = "radio"
									name  = "winner_side"
									value = "2"
									id    = "winner_2"
									<% $ARGS{"winner_side"} == 2 ? "checked" : "" %>
								>
								<% $event_settings{"neg_label"} %>
							</span>
						</label>
					</div>
				</span>

%				if ($tb_types{"winloss"} && $tb_types{"point"} && $no_lpw < 1) {

					<label for="lpw">
						<span id="lpwbox" class = "centeralign quarter hover">
							<span class="threequarters centeralign">
								Low-Point Win?
							</span>

							<span class="quarter centeralign">
								<input
									type  = "checkbox"
									id    = "lpw"
									value = "1"
									name  = "lpw"
									<% $ARGS{"lpw"} ? "checked" : "" %>
								>
							</span>
						</span>
					</label>
%				}
			</div>
%		}

%		if ($event_settings{"lower_rules"}) {
			<div class="padleft biggish bluetext centeralign padvert odd">
				<% $event_settings{"lower_rules"} %>
			</div>
%		}

<%perl>

		if ($event_settings{"po_contest"}) {

			Tab::Panel->set_sql(po_target => "
				select panel.*
					from panel, round, event

				where event.id = ?
					and event.type = 'congress'
					and event.id = round.event
					and round.name = ?
					and round.id = panel.round
					and round.published = 1
					and panel.letter = ?
			");

			my $po_panel = Tab::Panel->search_po_target(
				$event_settings{"po_contest"},
				$round->name,
				$panel->letter
			)->first;

			if ($po_panel) {

				my $po_round = $po_panel->round;
				my @po_entries = $m->comp("/funclib/panel_entries.mas", panel => $po_panel);

				my %po_tb_types = $m->comp(
					"/funclib/tiebreak_types.mas",
					round => $po_round
				);
</%perl>

				<h5>Please rate the presiding officers</h5>

%				foreach my $po_entry (@po_entries) {

					<div class="row">

						<span class="twofifths nospace">
							<span class="third semibold">
								<span class="spacer"></span>
								<% $po_entry->code %>
							</span>

							<span class="twothirds">
								<span class="spacer"></span>
								<% $po_entry->name %>
							</span>
						</span>

						<label for="po_<% $po_entry->id %>">
							<span class="fifth centeralign yellowhover">
%								if ($po_tb_types{"winloss"}) {
									Winner:
									<input
										type     = "radio"
										name     = "po_winloss"
										value    = "<% $po_entry->id %>"
										id       = "po_<% $po_entry->id %>"
										tabindex = -1
									>
%								}
							</span>
						</label>

						<span class="fifth centeralign">
%							if ($po_tb_types{"rank"}) {
								PO Rank (1 - <% scalar @po_entries %>)
								<input
									type     = "number"
									name     = "po_rank_<% $po_entry->id %>"
									min      = "1"
									max      = "<% scalar @po_entries %>"
									tabindex = -1
								>
%							}
						</span>

						<span class="fifth centeralign">
%							if ($po_tb_types{"point"}) {
								PO Points
								<input
									type     = "number"
									name     = "po_point_<% $po_entry->id %>"
									min      = "1"
									max      = "100"
									tabindex = -1
								>
%							}
						</span>
					</div>
%				}
%			}
%		}

			<div class="liblrow rightalign">
%				if ($event_settings{"allow_lowpoints"}) {
					<label for="lpw">
						<span class="half centeralign hover nospace">

							<span class="threequarters">
								Low-Point Ranks?
							</span>

							<span class="quarter centeralign">

								<input
									type  = "checkbox"
									id    = "lpw"
									value = "1"
									name  = "lpw"
									<% $ARGS{"lpw"} ? "checked" : "" %>
								>
							</span>
						</span>
					</label>
%				}

				<span class="half centeralign nospace">
					<input
						type  = "submit"
						value = "Submit Ballot"
					>
				</span>

			</div>
%		}

<%perl>

		if ($tb_types{"point"}
			&& ($min_points != $min_ob_points || $max_points != $max_ob_points)
		) {

</%perl>
			<div class="row smallish redtext semibold centeralign padvertmore">

				* The full point range is
				<% $min_points ? $min_points : "0" %><% " - ".$max_points %>
				but you must ask the tab room to give points outside of
				<% $min_ob_points." - ".$max_ob_points %>.

			</div>
%		}

%		if ($event_settings{dumb_signature_line}) {
			<div class="padleft padvert padbottommore">
				<% $event_settings{dumb_signature_line} %>
			</div>
%		}

%		if ($i_can_haz_doubled) {
			<div class="row smallish redtext semibold centeralign padvertmore">
				<span class="inline"> &dagger; </span>
				These entries are doubled entered in another category
				this round.  Please accomodate their need to leave early, or
				wait for them to appear late.
			</div>
%		}


%		unless ($event_type eq "congress") {

		<div class="full padtopmore">

			<span class="third nospace">
				<h5 class="nospace martop">
					Feedback
				</h5>
			</span>

%			if (scalar @ballots > 3) {

				<span class="twothirds rightalign">

					<span class="half rightalign bigger semibold bluetext">
						Comments go to:
					</span>

					<span class="half centeralign">

						<select
							class="fixedmed"
							onChange = "switchBox(this);"
						>

							<option value="rfd">Everyone (Reason for Rankings)</option>

<%perl>
							foreach my $ballot (@ballots) {

								next if $event_type eq "congress";

								my $entry = $ballot->entry if $ballot->entry;
								next unless $entry;
								next if $entry->dropped;

</%perl>
								<option
									value="<% $ballot->id %>"
								><% $entry->code
									%>&nbsp;&nbsp;<%
									$entry->code ne $entry->name ? $entry->name : ""
								%></option>
%							}

						</select>
					</span>
				</span>
%			}
		</div>

		<ul id="tabnav">

%			if (scalar @ballots < 4) {

				<li id="header_rfd" class="selected commentzing">
					<a onclick="doneSwitch('rfd');">
						Reason for
						<% $event_type eq "speech"
							|| $event_type eq "congress"
							? "Rankings" : "Decision" %>
					</a>
				</li>
<%perl>

				@ballots = sort {$a->entry->code cmp $b->entry->code} @ballots;

				foreach my $ballot (@ballots) {
					next unless $ballot->entry;
</%perl>
					<li id="header_<% $ballot->id %>" class="commentzing">
						<a
							onclick="doneSwitch(<% $ballot->id %>);"
						><% $ballot->entry->code %></a>
					</li>
%				}
%			}

			</ul>

			<div id="box_rfd" class="commentary">

				<span class="threequarters">
					<p class="semibold greentext full">
						These comments go to all participants in the round.
						<% $event_settings{'rfd_plz'}
							? "Must be at least ".$event_settings{'rfd_plz'}." words long."
							: ""
						%>
					</p>
				</span>

				<span class="quarter rightalign semibold bluetext">
					Save Feedback
					<button
						type    = "button"
						onClick = "saveComments(false);"
						class   = "bluetext buttonwhite fa fa-lg fa-save"
					></button>
				</span>

<%perl>
				my $rfd = Tab::Score->search(
					tag    => "rfd",
					ballot => $ballots[0]->id
				)->first if @ballots;
</%perl>

				<div class="full centeralign marno padvertno">
					<textarea
						id        = "rfd_<% $ballots[0]->id %>"
						class     = "comment_box full"
						type      = "rfd"
						ballot_id = "<% $ballots[0]->id %>"
						name      = "rfd"
						rows      = "15"
						cols      = "60"
					><% $rfd ? $rfd->text : "" %></textarea>
				</div>

			</div>

%			unless ($event_type eq "congress") {
%				BALLOT:
%				foreach my $ballot (@ballots) {

					<div
						id    = "box_<% $ballot->id %>"
						class = "commentary"
					>
<%perl>
						my $entry = $ballot->entry;

						unless ($entry) {
							$ballot->delete;
							next BALLOT;
						}

						my $code = $entry->code;

						$code .= " &ndash; ".$entry->school->code if $ballot_school_code;
						$code .= " &ndash; ".$entry->school->name if $ballot_school_name;
						$code .= " &ndash; ".$entry->name if $ballot_entry_name;

						if ($category_settings{'ballot_entry_titles'}) {
							$code .= " &ndash; ".$entry->setting("title");
						}

						if ($ballot_entry_first_name) {
							foreach my $student ($entry->students) {
								$code .= " &ndash; ".$student->first;
							}
						}

						my $comments = Tab::Score->search(
							tag    => "comments",
							ballot => $ballot->id
						)->first;
</%perl>
						<span class="threequarters">
							<p class="semibold bluetext full">
								These comments go only to <% $code %> &amp; coaches
							</p>
						</span>

						<span class="quarter rightalign semibold bluetext">
							Save Feedback
							<button
								type    = "button"
								onClick = "saveComments(false);"
								class   = "bluetext buttonwhite fa fa-lg fa-save"
							></button>
						</span>

						<div class="full centeralign marno padvertno">
							<textarea
								id        = "comments_<% $ballot->id %>"
								ballot_id = "<% $ballot->id %>"
								class     = "comment_box full"
								type      = "comments"
								name      = "comments_<% $ballot->id %>"
								rows      = "15"
								cols      = "60"
							><% $comments ? $comments->text : "" %></textarea>
						</div>

					</div>
%				}
%			}
			</form>

%		} else {

			</div>
%		}

%		if ($event_settings{"big_questions"}) {

			<div class="full centeralign">
				<span class="truethird nospace">
					<a
						target = "_blank"
						href   = "https://www.speechanddebate.org"
					>
					<img
						src   = "<% $bq_stuff{nsda_logo} %>"
						alt   = "<% $bq_stuff{nsda_logo} %>"
						style = "max-width: 220px;"/
					>
					</a>
				</span>

				<span class="truethird nospace">
					<a
						target = "_blank"
						href   = "https://www.templeton.org"
					>
					<img
						src   = "<% $bq_stuff{jtf_logo} %>"
						alt   = "<% $bq_stuff{jtf_logo} %>"
						style = "max-width: 220px;"/
					>
					</a>
				</span>
			</div>
%		}

%		if ($event_type eq "congress" && $chair && $audit) {
			<p class="centeralign redtext semibold martopmuchmore">
				You are the parliamentarian for this round.
				You will not rank the speakers until the end of all sessions.
			</p>
%		}

	</div>

	<div class="menu sticky">

%		if ($tourn_logo) {
			<div class="sidenote">
				<div class=" centeralign">
					<img
						src   = "<% $Tab::s3_url %>/<% $tourn->id."/".$tourn_logo %>"
						alt   = "<% $tourn_logo %>"
						style = "max-width: 220px;"/
					>
				</div>
			</div>
%       }

		<div class="sidenote">

			<span class="twofifths nospace">
				<h6 class="bluetext semibold marbottom">
					This round
				</h6>
			</span>

			<span class="threefifths rightalign">
				<h6 class="bluetext semibold marbottom">
					Start: <% Tab::nicetime($start) %>
				</h6>
			</span>

			<div class="row">
				<span class="quarter semibold padleft">
					Round
				</span>

				<span class="quarter">
					<% $round->realname %>
				</span>
%				if ($round->flighted > 1) {
					<span class="quarter nowrap semibold">
						Flight
					</span>

					<span class="quarter">
						<% $panel->flight %>
					</span>
%				}
			</div>

%			unless ($event_settings{"online"}) {
				<div class="row">
					<span class="quarter semibold">
						Room:
					</span>
					<span class="threequarter">
						<% $panel->room ? $panel->room->name : "" %>
					</span>
				</div>
%			}

%			if ($round->setting("num_judges") > 1) {

				<div class="row nospace">
					<span class="quarter semibold padleft">
						Panel
					</span>

					<span class="threequarters nospace">

%						foreach my $other_judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) {

%							next if $other_judge->id == $judge->id;

							<div class="nowrap padless marno">
								<% $other_judge->code." ".$other_judge->first." ".$other_judge->last %>
							</div>
%					}

					</span>
				</div>
%			}

%			if ($event_settings{"online_prep"}) {

				<h6 class="orangetext semibold marbottom">
					Prep Breakout Rooms
				</h6>

%				foreach my $ballot (@ballots) {
%					my $entry = $ballot->entry;
					<div class="row nospace">

						<span class="threequarters nospace bluetext semibold">
							<span class="halfspacer"></span>
							<% $entry->code %>
						</span>

						<span class="quarter leftalign">
							<& "/funclib/online_room.mas",
                                entry  => $entry->id,
                                person => $person,
								role   => "Judge",
                                show   => 1,
                                class  => "fa-sm padless"
                            &>
						</span>
					</div>
%				}

%			}

			<a
				href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
				class="blue full martopmore">
				Full Pairing/Schematic
			</a>

		</div>

		<div class="sidenote sticky">
<%perl>
			unless ($event_settings{"default_time"}) {

				$event_settings{"default_time"} = 5;
				$event_settings{"default_time"} = 10 if $event_type eq "speech";
				$event_settings{"default_time"} = 3 if $event_type eq "congress";
			}
</%perl>

			<span class="quarter nospace">
				<h4>Timers</h4>
			</span>

			<span class="threequarters explain rightalign biggish nospace ">
				If you refresh or leave, timers reset
			</span>

			<& "/funclib/stopwatch.mas",
				label   => $panel->id."_timer",
				default => $event_settings{"default_time"}
			&>

<%perl>
			unless ($event_type eq "speech"
				|| $event_type eq "congress"
			) {

				unless ($event_settings{"prep_time"}) {
					$event_settings{"prep_time"} = 4;
				}

				foreach my $ballot (@ballots) {
</%perl>

					<& "/funclib/stopwatch.mas",
						label   => $ballot->id."_timer",
						title   => $ballot->entry->code." Prep",
						default => $event_settings{"prep_time"}
					&>

%				}
%			}
		</div>

<%perl>

		my $point_scale = $event_settings{"point_scale"};
		my $speech_times = $event_settings{"speech_times"};

		if ($point_scale) {

			$point_scale = $m->comp(
				"/funclib/save_editor.mas",
					text        => $point_scale,
					restrictive => 1
				);

			my @point_lines = split(/\R/, $point_scale);

</%perl>

			<div class="sidenote lowspace">

				<h6 class="bluetext semibold marbottom">
					Point Scale
				</h6>

%				foreach my $line (@point_lines) {
%					$line =~ s/\.\.\./<\/span><span class="rightalign right">/g;

%					my $testline = $line;
%					$testline =~ s/\s+//g;
%					next unless $testline;

					<div class="odd full lightborder padless marno">
						<span class="bluetext semibold">
							<% $line %>
						</span>
					</div>
%				}
			</div>
%		}

<%perl>
		if ($speech_times) {

			$speech_times = $m->comp(
				"/funclib/save_editor.mas",
					text        => $speech_times,
					restrictive => 1
				);

			my @time_lines = split(/\R/, $speech_times);

</%perl>

			<div class="sidenote lowspace">

				<h6 class="bluetext semibold marbottom">
					Speech Times
				</h6>

%				foreach my $line (@time_lines) {

%					$line =~ s/\.\.\./<\/span><span class="rightalign right">/g;

					<div class="odd full lightborder padless marno">
						<span class="bluetext semibold">
							<% $line %>
						</span>
					</div>
%				}
			</div>
%		}

		<div class="sidenote">

			<h4>Other ballots</h4>
<%perl>

			foreach my $opanel (
				$m->comp(
					"/funclib/person_panels.mas",
					person => $person
				)
			) {

				next unless $opanel->round->published;
				next if $opanel->id == $panel->id;

</%perl>
				<a
					class="yellow full"
					href="ballot.mhtml?panel_id=<% $opanel->id %>&judge_id=<% $opanel->judge %>">
					<% $opanel->round->event->abbr %>
					<% $opanel->round->realname %>
					<% $opanel->round->flighted > 1 ? "Flt ".$opanel->flight : "" %>
					Pending
				</a>
<%perl>
			}

			foreach my $opanel (
				$m->comp(
					"/funclib/person_panels.mas",
					person => $person,
					done   => 1
				)
			) {

				next if $opanel->id == $panel->id;
</%perl>
				<a
					class="blue full"
					href="rfd_only.mhtml?panel_id=<% $opanel->id %>&judge_id=<% $opanel->judge %>"
				>
					<span class="threequarters">
						<% $opanel->round->event->abbr %>
						<% $opanel->round->realname %>
						<% $opanel->round->flighted > 1 ? "Flt ".$opanel->flight : "" %>
					</span>
					<span class="quarter centeralign greentext semibold">
						Done
					</span>
				</a>
%			}
%		}

		</div>

	</div>
