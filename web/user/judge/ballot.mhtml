<%args>
	$person
	$person_settings
	$panel_id => undef
	$judge_id => undef
	$errs     => undef
</%args>
<%init>

	unless ($panel_id && $judge_id) {
		my $err = "I didn't get both a judge and a ballot record";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $panel = Tab::Panel->retrieve($panel_id);
	$m->abort unless $panel;
	$m->comp("/funclib/panel_dedupe.mas", panel => $panel);

	my $judge = Tab::Judge->retrieve($judge_id);

	my $round    = $panel->round;
	my $event    = $round->event;
	my $category = $event->category;
	my $tourn    = $category->tourn;

	my %tb_types = $m->comp(
		"/funclib/tiebreak_types.mas",
		round => $round
	);

	if (
		$event->type eq "wsdc" && $tb_types{"point"}
	) {
		$m->redirect("wsdc_ballot.mhtml?panel_id=".$panel->id."&judge_id=".$judge->id);
	}

	my %tourn_settings = $tourn->all_settings();

	if ($tourn_settings{"legion"}) {
		$m->redirect("legion_ballot.mhtml?panel_id=".$panel->id."&judge_id=".$judge->id);
	}

	my $tourn_logo = $tourn_settings{"logo"};
	my %event_settings = $event->all_settings;
	my %category_settings = $category->all_settings;

	my $now = DateTime->now();
    my $subscores = $event_settings{"wsdc_categories"};

    my %max_subpoints = ();
    my %min_subpoints = ();

    my @scores = ("Style", "Content", "Strategy", "POI");

    foreach my $key (@scores) {
        $min_subpoints{$key} = $event_settings{"min_".lc($key)."_points"};
        $max_subpoints{$key} = $event_settings{"max_".lc($key)."_points"};
        $min_subpoints{$key} = 0 unless $min_subpoints{$key};
        $min_subpoints{"total"} += $min_subpoints{$key} unless $key eq "POI";
        $max_subpoints{"total"} += $max_subpoints{$key} unless $key eq "POI";
    }

	my $type = $event->type;

    my $trash = pop @scores unless $max_subpoints{"POI"};
	my $no_lpw++ if $event_settings{"no_lpw"};
	my $aff_string = $event_settings{"aff_label"};
	my $neg_string = $event_settings{"neg_label"};

	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	my $ballot_rules       = $event_settings{"ballot_rules"};
	my $chair_ballot_rules = $event_settings{"ballot_rules_chair"};
	my $lower_rules        = $event_settings{"dumb_signature_line"};
	my $resolution         = $event_settings{"resolution"};

	my $motion         = $round->setting("motion");
	my $motion_publish = $round->setting("motion_publish");

	my $ballot_entry_name       = $category_settings{"ballot_entry_names"};
	my $ballot_entry_first_name = $category_settings{"ballot_entry_first_names"};
	my $ballot_school_code      = $category_settings{"ballot_school_codes"};
	my $ballot_school_name      = $category_settings{"ballot_school_names"};

	undef $category_settings{"ballot_entry_titles"} unless $type eq "speech";

	my $decision_deadline;
	my $decision_time;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	$now->set_time_zone($tz);

	my $start = $round->start_time;
	$start = $round->timeslot->start unless $start;
	$start->set_time_zone($tz);

	if ($round->type eq "elim" || $round->type eq "final") {
		$decision_deadline = $event_settings{"elim_decision_deadline"};
	} else {
		$decision_deadline = $event_settings{"prelim_decision_deadline"};
	}

	if ($decision_deadline) {
		$decision_time = $start->clone;
		$decision_time->add("minutes", $decision_deadline);
	}

	if ($event_settings{"flight_offset"}) {
		foreach my $flight (2 .. $panel->flight) {
			$decision_time->add('minutes', $event_settings{"flight_offset"}) if $decision_time;
			$start->add('minutes', $event_settings{"flight_offset"});
		}
	}

	my $time_left;
	if ($decision_time) {
		$time_left = ($decision_time - $now);
	}


	my %bq_stuff;

	if ($event_settings{"big_questions"}) {

        $bq_stuff{bqd_logo}  = "lib/images/big-questions-logo.jpg";
        $bq_stuff{nsda_logo} = "lib/images/nsda-logo-printable.png";
        $bq_stuff{jtf_logo}  = "lib/images/templeton-logo.png";

        $bq_stuff{resolution} = Tab::TournSetting->search(
            tourn => 0,
            tag   => "bqd_resolution"
        )->first;

        $bq_stuff{resolution} = $m->comp("/funclib/print_format.mas",
            message =>  $bq_stuff{resolution}->value_text
        );

        $bq_stuff{rules} = Tab::TournSetting->search(
            tourn => 0,
            tag   => "bqd_rules"
        )->first;

        $bq_stuff{rules} = $bq_stuff{rules}->value_text;

		$bq_stuff{rules} =~ s/\n/<br \/>/g;
	}

	my $wudc++ if $type eq "wudc";

	unless ($panel && $judge) {
		my $err = "No ballots found for that judge and that panel.";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	unless ($judge->person->id == $person->id || $person->site_admin) {
		my $err = "You are not authorized to enter ballots for that judge.";
		$m->redirect("/user/home.mhtml?err=$err")
	}

	unless ($round->tiebreak_set) {
		my $err = "That tournament does not have tiebreakers set.";
		$err .= " Please contact the tournament tab staff to let them know.";
		$m->redirect("/user/judge/panels.mhtml?err=$err");
	}

	my @ballots = sort {$a->side <=> $b->side}
		Tab::Ballot->search(
			judge => $judge->id,
			panel => $panel->id
		);

	@ballots =
		sort {$a->speakerorder <=> $b->speakerorder}
		@ballots if $type eq "speech";

	my @clean;
	foreach my $ballot (@ballots) {
		next unless $ballot->entry > 0;
		push @clean, $ballot;
	}

	@ballots = @clean;
	unless (@ballots) {
		my $err = "That judge does not judge in that room.";
		$m->redirect("/user/home.mhtml?err=$err");
	}


	Tab::Panel->set_sql(update_start => "
		update panel
			set started = ?
			where id = ?
			and (panel.started is NULL
				or panel.started < '2000-01-01 00:00:01'
			)
	");

	Tab::Panel->sql_update_start->execute(
		DateTime::Format::MySQL->format_datetime($now), $panel->id
	);

	Tab::Ballot->set_sql(update_start => "
		update ballot
			set judge_started = ?, started_by = ?
			where panel = ?
			and judge = ?
			and (ballot.judge_started is NULL
				or ballot.judge_started < '1000-01-01 00:00:01'
			)
	");

	$now->set_time_zone("UTC");

	Tab::Ballot->sql_update_start->execute(
		DateTime::Format::MySQL->format_datetime($now),
		$person->id,
		$panel->id,
		$judge->id,
	);


	my $team_points++ if $event_settings{"team_points"};
	$team_points++ if $type eq "speech";
	$team_points++ if $type eq "congress";

	undef $tb_types{"rank"} if $wudc;

	my @panel_students = $m->comp(
		'/funclib/panel_students.mas',
		panel => $panel
	);

	my $tv++ if $type eq "speech"
		&& $round->tiebreak_set->setting("mfl_time_violation");

	my $forfeit++ if $type eq "speech"
		&& $round->tiebreak_set->setting("forfeits_never_break");

	my $max_points = $event_settings{"max_points"};
	my $min_points = $event_settings{"min_points"};

	my $max_ob_points = $event_settings{"max_ob_points"};
	my $min_ob_points = $event_settings{"min_ob_points"};

	$min_ob_points = $min_points unless $min_ob_points;
	$max_ob_points = $max_points unless $max_ob_points;

	my %entry_scores = ();

	if ($event->type eq 'congress') {

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 6 unless $max_ob_points;

        my @scores = $m->comp(
            '/funclib/judge_scores.mas',
            judge    => $judge,
            timeslot => $round->timeslot,
            tag      => "speech"
        );

        foreach my $score (@scores) {
            $entry_scores{$score->entryid}{$score->speech} = $score;
			$entry_scores{$score->entryid}{"total"} += $score->value;
			$entry_scores{$score->entryid}{"count"}++;
        }

	} elsif ($event->type eq 'speech') {

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 100 unless $max_ob_points;

	} else {

		$min_ob_points = 0 unless $min_ob_points;
		$max_ob_points = 30 unless $max_ob_points;

	}

	my $increments = $event_settings{"point_increments"};

	my $step = "1" if $increments eq "whole";
	$step = "0.5"  if $increments eq "half";
	$step = "0.25" if $increments eq "fourths";
	$step = "0.1"  if $increments eq "tenths";

	my $no_side_constraints++ if $event_settings{'no_side_constraints'};

    my $sidelocks++
		if ($round->type eq "elim"
			|| $round->type eq "final"
			|| $round->type eq "runoff"
		) && not defined $no_side_constraints;

	undef $sidelocks if $event_settings{'sidelock_elims'}
		&& ($round->type eq "elim" || $round->type eq "final");

	my $locked =  $m->comp(
		"/funclib/round_elim_dueaff.mas",
		panel => $panel
	) if $sidelocks;

</%init>

	<& "/funclib/editor.mas" &>

	<script>

		function saveComments(auto) {


			$(".feedback").each(function() {

				$(this).tinymce().save();

				var textValue = $(this).val();
				var ballotID = $(this).attr("ballot_id");
				var commentType = $(this).attr('type');

				var message = "Save result: ";
				var errors = "Errors: ";

				$.ajax({
					type : 'POST',
					url  : 'comment_save.mhtml',
					data : {
						ballot_id : ballotID,
						text	  : textValue,
						type	  : commentType,
						auto	  : auto
					},

					success : function(data) {

						if (data) {
							if (data.message) {
								if (data.error) {
									errors = errors + data.message;
								} else {
									message = message + data.message;
								}
							} else {
								console.log(data);
								alertify.warning("An error condition was tripped.");
							}
						}
						return;
					}
				});

				if (errors !== "Errors: ") {
					alertify.error("Errors were encountered saving; save whole ballot instead");
				} else if (auto) {
				} else {
					alertify.dismissAll();
					alertify.notify("All comments and feedback were saved", "custom");
				}
			});

			return;

			window.onbeforeunload = null;
		}

		function swapOrder(orderSelector) {

			var ballotID = $(orderSelector).attr("ballot_id");
			var selectedValue = $("#"+orderSelector.id+" option:selected").val();

			if (ballotID && selectedValue) {

				var otherValue = 2;

				if (selectedValue == otherValue) {
					otherValue--;
				}

				$(".speakerorder").each( function() {

					if (this.id != ballotID+"_speakerorder") {
						$("#"+this.id+" option").prop('selected', false);
						$("#"+this.id+" option[value="+otherValue+"]").prop('selected', true);
					}

					$(".orderpick").prop("disabled", true);

				});

				sortTable();
			}
			return;
		}

		function sortTable() {

			var rows = $(".ballotrows").get();

			rows.sort(function(a, b) {
				var A = $("#"+a.id+"_speakerorder option:selected").val();
				var B = $("#"+b.id+"_speakerorder option:selected").val();

				if (A < B) {
					return -1;
				}

				if (A > B) {
					return 1;
				}
				return 0;
			});

			$.each(rows, function(index, row) {
				$("#ballottable").append(row);
				$(row).toggleClass("even");
				$(row).toggleClass("odd");
			});

			return;

		}

		function doneSwitch(which) {
			$('.commentary').addClass("hidden");
			$('#box_'+which).removeClass("hidden");
			$("li.commentzing").removeClass("selected");
			$('#header_'+which).addClass("selected");
			saveComments(true);
		}

		function switchBox(selectTarget) {
			$('.commentary').addClass("hidden");
			$('#box_'+$(selectTarget).val()).removeClass("hidden");
			saveComments(true);
		}

		function speakerTotal(studentID, entryID) {

			var pointTotal = 0;

			$("."+studentID).each(function() {

                var Float = parseFloat(this.value);

                if (Float) {

                    if (Float > this.max) {

						alertify.error(
							Float+" is over the maximum points allowed.  The maximum is "+this.max
						);

						$(this).val("");
						this.focus();

                    } else if (Float < this.min) {

                        alertify.error(
							Float+" is below the minimum points allowed.  The minimum is "+this.min
						);

						$(this).val("");
						this.focus();

                    } else {

                        pointTotal += Float;

                    }
				}

			});

			$("#"+entryID+studentID+"_points")
				.val(pointTotal)
				.change(function() {
					checkTotal(studentID, entryID);
					teamTotal(entryID);
				})
				.trigger("change");
		}

		function checkTotal(studentID, entryID) {

			$("."+studentID+"_row").removeClass("lird");
			$("#"+studentID+"_warning").addClass("hidden");

			var boxTotal = $("#"+studentID+"_points").val();

			var pointTotal = 0;

			$("."+studentID).each(function() {

				var Float = parseFloat(this.value);

				if (Float) {
					pointTotal += Float;
				}

			});

			if (pointTotal != boxTotal) {

				$("."+studentID+"_row").addClass("lird");
				$("#"+studentID+"_warning").removeClass("hidden");

				$("#"+studentID+"_warning").html("Total: "+pointTotal+" vs "+boxTotal);

			}
		}

		function teamTotal(entryID) {

			var teamTotal = 0;

			$("."+entryID).each(function() {

				var Float = parseFloat(this.value);

				if (Float) {
					teamTotal += Float;
				}

			});

			$("#"+entryID+"_total").val(teamTotal);
		}

		function checkLPW(selectMenu) {

			var Winner = parseFloat($('#winner').val());

			if (Winner) {

				var mostPoints = 0;
				var mostBallot = 0;

				$(".totals").each(function() {

					var localPoints = $(this).val();

					if (localPoints > mostPoints) {
						mostBallot  = $(this).attr("ballotID");
						mostPoints = localPoints;
					}

				});

				if (mostBallot != Winner) {

%					if ($event_settings{"no_lpw"} && $tb_types{"point"}) {

						alertify.error(
							"You gave the winning team fewer points.  Please correct."
						);

						$("#winbox").addClass("lird");

%					} else {

						$("#lpwbox").addClass("redtext");
						$("#lpwbox").addClass("semibold");

%					}

				} else {

					$("#winbox").removeClass("lird");
					$("#lpwbox").removeClass("redtext");
					$("#lpwbox").removeClass("semibold");

				}

			} else {

				$("#winbox").removeClass("lird");
				$("#lpwbox").removeClass("redtext");
				$("#lpwbox").removeClass("semibold");

			}
		}

		$(document).ready(function () {

			sortTable();

			// I hate shit like this so much
			setTimeout(function(){
				doneSwitch('rfd');
			}, 500);
		});

	</script>

%	my $segment = "truethird";
%	$segment = "quarter" if $event_settings{'big_questions'};

	<div class="main">

		<div>
%			if ($event_settings{'big_questions'}) {
				<span class="<% $segment %> nospace">
					<img
						src   = "<% $bq_stuff{bqd_logo} %>"
						alt   = "<% $bq_stuff{bqd_logo} %>"
						style = "max-width: 164px;"/
					>
				</span>
%			}

			<span class="<% $segment %> nospace">
				<h5 class="bluetext">
					<% $panel->room > 0
						? "Room: ". $panel->room->name
						: "NO ROOM ASSIGNED"
					%>
				</h5>
			</span>

			<span title="And you are simply the best!" class="<% $segment %> nospace centeralign">
				<h4 class="redtext">
					<% $judge->first %>
					<% $judge->middle %>
					<% $judge->last %>
				</h4>
			</span>

			<span class="<% $segment %> nospace rightalign">
				<h5 class="bluetext">
					<% $event->abbr %>
					<% $round->realname %>
					<% $round->flighted > 1 ? "Flt ".$panel->flight : "" %>
				</h5>
			</span>

		</div>

%		if ($round->setting("notes")) {
			<p class="warning padleft bluebordertop padtop">
				Note: <% $round->setting("notes") %>
			</p>
%		}

<%perl>

		if ($event->type eq "congress") {

			my $default = $ARGS{"default"};
			$default = "speeches" unless $default;
			my @tabs = ("speeches", "rankings");

</%perl>
			<& "/funclib/tabs.mas",
				tabs      => \@tabs,
				default   => $default
			&>

			<div class="speeches screens">
				<&
					"congress_speeches.mas",
						person          => $person,
						person_settings => $person_settings,
						tourn           => $tourn,
						judge           => $judge,
						panel           => $panel,
						event           => $event,
						missing         => $ARGS{"missing"},
						event_settings  => \%event_settings,
						entry_id        => $ARGS{"entry_id"}
				&>

			</div>

			<div class="rankings screens">
%		}

%		if ($errs) {

			<div class="borderred centeralign martopmore marbottommore">

				<h6 class="bluetext semibold">
					Oh, drat. Your ballot had errors.
				</h6>

				<span class="semibold redtext bigger">
					<% $errs %>
				</span>

				<p class="bigger semibold bluetext">
					Please correct these before continuing.
				</p>

			</div>
%		}

%		if ($event_settings{big_questions}) {
			<div class="centeralign semibold bluetext padvertmore bigger padbottommore">
				Resolution: <% $bq_stuff{resolution} %>
			</div>

<%perl>

		} elsif ($event_settings{"topic"}) {

			my $topic = Tab::Topic->retrieve($event_settings{"topic"});
			my $text = $topic->topic_text;
			$text =~ s/\r\n/<br\ \/>/g;
			$text =~ s/\n/<br\ \/>/g;
			$text =~ s/\r/<br\ \/>/g;
</%perl>
			<div class="nospace centeralign">
				<div class="semibold bluetext padvertmore bigger padbottommore seveneighths leftalign">
					Topic: <% $text %>
				</div>
			</div>

%		} elsif ($motion_publish) {
			<div class="centeralign semibold bluetext padvertmore bigger padbottommore">
				Motion: <% $motion %>
			</div>
%		} elsif ($resolution) {
			<div class="centeralign semibold bluetext padvertmore bigger padbottommore">
				Resolution: <% $resolution %>
			</div>
%		}

%		if ($event_settings{big_questions}) {
			<div class="padleft padvert padbottommore">
				<% $bq_stuff{rules} %>
			</div>
%		}

%		if ($ballot_rules) {
			<div class="padleft padvert padbottommore">
				<% $ballot_rules %>
			</div>
%		}
%		if ($chair_ballot_rules) {
			<div class="padleft padvert padbottommore">
				<% $chair_ballot_rules %>
			</div>
%		}

		<form
			action="<% $wudc ? "wudc_save.mhtml" : "ballot_save.mhtml" %>"
			method="post">

		<input
			type  = "hidden"
			name  = "panel_id"
			value = "<% $panel->id %>"
		>

		<input
			type  = "hidden"
			name  = "judge_id"
			value = "<% $judge->id %>"
		>

%		if ($event->type eq 'speech' || $event->type eq "congress") {
			<& "/funclib/tablesorter.mas",
				table => "sortable",
				nobuttons => 1
			&>
%		}

%		if ($event_settings{"truncate_fill"} && $tb_types{"rank"}) {

			<h6 class="bluetext centeralign padmore marbottom semibold">
				Any blank ranks will be auto-filled with a
					<% $event_settings{"truncate_fill"} %>
			</h6>
%		}

%		if ($decision_deadline || $tb_types{"point"}) {

			<div class="padvert marbottommore marleftmore">

%				if ($tb_types{"point"}) {

					<span class="half leftalign nospace">

						<span class="semibold redtext inline marright">
							Points:
						</span>

						Range:
							<% $min_ob_points."-".$max_ob_points %>
							<% ($min_ob_points != $min_points)
							|| ($max_ob_points != $max_points) ? "*" : "" %>.

						<% $step eq "1" ? " Whole points only. " : "" %>

						<% $event_settings{"point_ties"} ?
							"Ties are OK. " : "No ties. " %>

%						if ($type eq "speech" || $type eq "congress") {
							<% $event_settings{"allow_lowpoints"}
								? ""
								: "Ranks and points must agree. "
							%>
%						}

						<% ($type ne "speech" && $type ne "congress" )
							&& $no_lpw ? "Winner must have higher points. " : "" %>

						<% $step eq "0.5" ? "Steps of 0.5. " : "" %>
						<% $step eq "0.25" ? "Steps of 0.25. " : "" %>
						<% $step eq "0.1" ? "Steps of 0.1. " : "" %>

					</span>
%				}

%				if ($decision_deadline) {

					<span class="half rightalign semibold bigger smidge">

						Decision due: <% Tab::nicetime($decision_time) %>

						<span class="orangetext inline borderleft marleft padleft">

							<span class="inline nospace">
								Time left:
							</span>

							<& "/funclib/stopwatch.mas",
								label     => "deadline",
								inline    => "true",
								autostart => "true",
								default   => ($time_left->in_units('minutes'))
							&>
						</span>
					</span>
%				}
			</div>
%		}

		<table id="sortable">

			<thead>

			<tr class="yellowrow smallish centeralign">

%				if ($type eq "wudc") {

					<th>
						Position
					</th>

%				} elsif ($type ne "speech" && $type ne "congress") {

					<th>
						Side <% $sidelocks ? $locked ? "(Locked)" : "(Flip)" : "" %>
					</th>
%				}

%				if ($type ne "wsdc" && ($no_side_constraints || $type eq "speech")) {
					<th>
						Speaks
					</th>
%				}

				<th>
					Code
				</th>

%				if ($ballot_school_code) {
					<th>
						Sch Code
					</th>
%				}

%				if ($category_settings{"ballot_region_codes"}) {

%					if ($tourn_settings{"nsda_nats"}) {
						<th>
							State
						</th>
%					} elsif ($tourn_settings{"ncfl"}) {
						<th>
							Diocese
						</th>
%					} else {
						<th>
							Region
						</th>
%					}

%				}

%				if ($ballot_school_name) {
					<th>
						School
					</th>
%				}

%				if ($ballot_entry_name) {
					<th>
						Name
					</th>
%				}

%				if ($ballot_entry_first_name) {
					<th>
						First Name
					</th>
%				}
%				if ($category_settings{'ballot_entry_titles'}) {
					<th>
						Title/Question
					</th>
<%perl>

				}

				if ($wudc && $tb_types{"winloss"} && $round->type eq "elim") {
</%perl>
					<th>
						Advance (2)
					</th>

%				} elsif ($wudc && $tb_types{"winloss"} && $round->type eq "final") {

					<th>
						Champion
					</th>
%				}

%				if ($event->type eq "congress") {

					<th>
						Speech Points
					</th>

					<th>
						Average
					</th>

					<th>
						Rank
					</th>

%					if ($tb_types{"point"}) {
						<th>
							Speaker Points
						</th>
%					}

%				} else {

<%perl>
					my $num;
					$num++ if $tb_types{"rank"};
					$num++ if $tb_types{"point"};

					if ($num > 0) {
</%perl>
					<th colspan="<% $num %>">
<%perl>

					my $tick;

					if (
						($tb_types{"rank"} || $tb_types{"point"}
						&& (scalar @panel_students > scalar @ballots)
					)
						&& not defined $team_points
					) {

						$tick++;
</%perl>
						<span class="third marno padless centeralign">
							Speaker
						</span>
%					}


%					if ($tb_types{"rank"}) {
						<span class="<% $tick ? "third padless" : "half" %> marno centeralign">
							Rank
						</span>
%					}

%					if ($tb_types{"point"}) {
						<span class="<% $tick ? "third padless" : "half" %> marno centeralign">
%						if ($subscores) {
%							foreach my $score (@scores) {
								<span class="marno quarter centeralign">
									<% ucfirst ($score) %><br />
									(<% $min_subpoints{$score} %> - <% $max_subpoints{$score} %>)
								</span>
%							}
							<span class="marno quarter centeralign semibold">
								Total <br />
								(<% $min_subpoints{"total"} %> - <% $max_subpoints{"total"} %>)
							</span>
%						} else {
							Points
%						}
						</span>
%					}
					</th>

%					if ($tv) {
						<th>
							Overtime
						</th>
%					}

%					if ($forfeit) {
						<th>
							No show?
						</th>
%					}
%				}
%			}

			</tr>

			</thead>

			<tbody id="ballottable">

<%perl>

			my $index = 1;
			my $switch;
			my $i_can_haz_doubled;

			my %doubled = $m->comp("/funclib/round_doubled.mas", round => $round);

			foreach my $ballot (@ballots) {

				my $entry = $ballot->entry;
				next unless $entry;

				next if $entry->dropped && $type eq "speech";
				next if $entry->dropped && $type eq "congress";

				my @students = $entry->students;

				my $doubled = scalar (keys %{$doubled{$ballot->entry}});
				my $daggers;
				foreach (1 .. $doubled) {
					$daggers .= "&dagger;";
				}
				$i_can_haz_doubled++ if $doubled;

</%perl>
				<tr
					id    = "<% $ballot->id %>"
					class = "<% ($switch % 2) ? "odd" : "even" %> ballotrows"
				>

<%perl>

					my $columns = scalar @students;
					$columns = 1 if $team_points;
					$columns = 1 unless ($tb_types{"point"} || $tb_types{"rank"});

					unless ($type eq "speech" || $type eq "congress") {
</%perl>

						<td class = "centeralign" >

%							if ($no_side_constraints || $sidelocks && not defined $locked) {

								<select
									name  = "<% $ballot->id %>_side"
									class = "fixedtiny chosen"
								>

									<option
										value    = ""
									>Pick</option>

									<option
										value = "1"
										id    = "aff"
										<% $ballot->side == 1 ? "selected" : ""%>
									><% $aff_string %></option>

									<option
										value = "2"
										id    = "neg"
										<% $ballot->side == 2 ? "selected" : ""%>
									><% $neg_string %></option>

								</select>

<%perl>
							} elsif ($wudc && (
								$round->type eq "elim"
								|| $round->type eq "final"
								|| $round->type eq "runoff")
							) {
</%perl>
								<select name="<% $ballot->id %>_speakerorder">
									<option value="">Pick</option>
									<option value="1">1st Gov</option>
									<option value="2">1st Opp</option>
									<option value="3">2nd Gov</option>
									<option value="4">2nd Opp</option>
								</select>

%							} elsif ($wudc) {

								<% ($ballot->speakerorder == 1) ? "1st Gov" : "" %>
								<% ($ballot->speakerorder == 2) ? "1st Opp" : "" %>
								<% ($ballot->speakerorder == 3) ? "2nd Gov" : "" %>
								<% ($ballot->speakerorder == 4) ? "2nd Opp" : "" %>

%							} else {
								<% ($ballot->side == 1) ? $aff_string : $neg_string %>
%							}

						</td>

%						if ($no_side_constraints && $type ne "wsdc") {

							<td class='centeralign'>

								<select
									id        = "<% $ballot->id %>_speakerorder"
									name      = "<% $ballot->id %>_speakerorder"
									ballot_id = "<% $ballot->id %>"
									class     = "fixedtiny speakerorder plain"
									onChange  = "swapOrder(this);"
								>

									<option
										value = ""
										class = "orderpick"
									>Pick</option>

									<option
										value = "1"
										id    = "1"
										class = "orders"
										<% $ballot->speakerorder == 1 ? "selected" : ""%>
									>1st</option>

									<option
										value = "2"
										id    = "2"
										class = "orders"
										<% $ballot->speakerorder == 2 ? "selected" : ""%>
									>2nd</option>

								</select>
							</td>

%						}
%					}

%					if ($type eq "speech") {
						<td class='centeralign'>
							<% Lingua::EN::Numbers::Ordinate::ordinate($ballot->speakerorder) %>
						</td>
%					}

					<td class = "leftalign semibold padvertmore">
						<span class="inline redtext semibold">
							<% $doubled ? $daggers : "" %>
						</span>
						<% $entry->code %>
					</td>

%					if ($ballot_school_code) {
						<td class = "centeralign">
							<% $entry->school->code %>
						</td>
%					}

%					if ($category_settings{"ballot_region_codes"}) {
						<td class = "centeralign">
							<% $entry->school->region->code %>
						</td>
%					}

%					if ($ballot_school_name) {
						<td class = "padleftmore">
							<% $entry->school->name %>
						</td>
%					}

%					if ($ballot_entry_name) {
						<td class = "padleftmore" >
							<% $entry->name %>
						</td>
%					}

%					if ($ballot_entry_first_name) {
						<td class = "centeralign" >
%							foreach my $student ($entry->students) {
								<% $student->first %>
%							}
						</td>
%					}

<%perl>
					if ($category_settings{'ballot_entry_titles'}) {

						my $exists = $ballot->scores(
							tag => "title"
						)->first;

						my $title;

						if ($exists) {
							$title = $exists->text;
						} else {
							$title = $entry->setting("title");
						}

</%perl>
						<td class="centeralign">

							<input
								type          = "text"
								name          = "<% $ballot->id %>"
								target_id     = "<% $ballot->id %>"
								property_name = "title"
								tabindex      = -1
								value         = "<% $title %>"
								size          = "30"
								placeholder   = "Enter title or extemp question"
								onBlur        = "postSwitch(this, 'title_save.mhtml');"
							>
						</td>
%					}

%					if ($event->type eq "congress") {

						<td class="centeralign">
<%perl>
							my $notfirst;
							foreach my $speech (keys %{$entry_scores{$entry->id}}) {
								next if $speech eq "total";
								next if $speech eq "count";
								$m->print(", ") if $notfirst++;
								$m->print($entry_scores{$entry->id}{$speech}->value);
							}
</%perl>
						</td>

						<td class="centeralign">
%							if ($entry_scores{$entry->id}{"count"}) {
								<% $entry_scores{$entry->id}{"total"} / $entry_scores{$entry->id}{"count"} %>
%							}
						</td>
<%perl>
					}

					if ($tb_types{"point"} || $tb_types{"rank"}) {

						my $notfirst;

						if ($team_points) {

							if ($tb_types{"rank"}) {

</%perl>
								<td class="centeralign">
									<input
										tabindex = <% $index++ %>
										type     = "number"
										step     = "1"
										size     = "5"
										name     = "<% $ballot %>_ranks"
										max      = "<% scalar @panel_students %>"
										value    = "<% $ARGS{$ballot."_ranks"} %>"
									>
								</td>

%							}

%							if ($tb_types{"point"}) {

								<td <% $tb_types{"rank"} ? "" : 'colspan="2"' %>
									class="centeralign">

									<input
										class    = "<% $entry->id %>"
										type     = "number"
										step     = "<% $step %>"
										name     = "<% $ballot->id %>_points"
										id       = "<% $ballot->id %>_points"
										size     = "5"
										min      = "<% $min_points %>"
										max      = "<% $max_points %>"
										value    = "<% $ARGS{$ballot->id."_points"} %>"
										tabindex = <% $index++ %>
									>
								</td>
%							}

%							if ($tv) {

								<td class="centeralign nospace">
									<label for="<% $ballot->id %>_tv">
										<span class="full padvertless hover">
											<input
												type  = "checkbox"
												name  = "<% $ballot->id %>_tv"
												value = "1"
											>
										</span>
									</label>
								</td>
%							}

%							if ($forfeit) {
								<td class="centeralign nospace">
									<label for="<% $ballot->id %>_forfeit">
										<span class="full padvertless hover">
											<input
												type  = "checkbox"
												name  = "<% $ballot->id %>_forfeit"
												value = "1"
												<& "/funclib/warn.mas",
													warn => "You are marking the student as having forfeited the round.  Be sure you accomodated their double entry and are following the tournament policy on forfeits before doing so.  This entry will receive no ranks or points." &>
											>
										</span>
									</label>
								</td>
%							}

%						} else {

							<td colspan="4" class="nospace">

%							my $length = "half";
%							$length = "third" if $tb_types{"rank"} && $tb_types{"point"};

%							foreach my $student (@students) {

								<div class="padless marno borderbottom centeralign">

									<span class='smallish <% $length %> marno padless leftalign <% $student->id."_row" %>' >

										<% substr($student->first." ".$student->last.":", 0, 30) %>

										<div
											id    = "<% $student->id %>_warning"
											class = "hidden redtext semibold nospace padtop"
										>
											Total incorrect!
										</div>

									</span>

%								if  ($tb_types{"rank"}) {

									<span class="<% $length eq "half" ? "half" : "third" %> marno padless centeralign">
										<input
											tabindex = <% $index++  %>
											type     = "number"
											step     = "1"
											size     = "5"
											name     = "<% $student %>_ranks"
											min      = "1"
											max      = "<% scalar @panel_students %>"
										>
									</span>
%								}

%								if ($tb_types{"point"}) {

									<span class="<% $length eq "half" ? "half" : "third" %> marno padless centeralign">

%									if ($subscores) {

%										foreach my $score (@scores) {

											<span class="quarter centeralign">

												<input
													class    = "<% $student->id %>"
													type     = "number"
													step     = "<% $step %>"
													name     = "<% $student->id %>_<% $score %>"
													size     = "5"
													min      = "<% $min_subpoints{$score} %>"
													max      = "<% $max_subpoints{$score} %>"
													value    = "<% $ARGS{$student->id."_".$score} %>"
													tabindex = <% $index++ %>
													onBlur = "speakerTotal(
														'<% $student->id %>',
														'<% $entry->id %>'
													);"
												>
											</span>

%										}

										<span class="quarter centeralign">
											<input
												class    = "<% $entry->id %>"
												type     = "number"
												step     = "<% $step %>"
												name     = "<% $student %>_points"
												id       = "<% $student %>_points"
												size     = "5"
												min      = "<% $min_subpoints{"total"} %>"
												max      = "<% $max_subpoints{"total"} %>"
												value    = "<% $ARGS{$student."_points"} %>"
												tabindex = <% $index++ %>
												onChange = "checkTotal(
													'<% $student->id %>',
													'<% $entry->id %>'
												);"
											>
										</span>

%									} else {

%										my $class = "totals" unless $event_settings{"team_total_line"};

										<span class="third marno padless centeralign">

											<input
												type     = "number"
												class    = "<% $class %>"
												ballotID = "<% $ballot->id %>"
												step     = "<% $step %>"
												name     = "<% $student %>_points"
												size     = "5"
												min      = "<% $min_points %>"
												max      = "<% $max_points %>"
												value    = "<% $ARGS{$student."_points"} %>"
												tabindex = <% $index++ %>
											>
										</span>

%									}
%								}

								</div>

%							}

							</td>

%							if ($tv) {
								<td>
									<input
										type  = "checkbox"
										name  = "<% $ballot->id %>_tv"
										value = "1"
									>
								</td>
%							}

%							if ($forfeit) {
								<td>
									<input
										type  = "checkbox"
										name  = "<% $ballot->id %>_forfeit"
										value = "1"
									>
								</td>
%							}

%						}

%					} elsif  ($wudc && $tb_types{"winloss"}) {

						<td>
							<input
								type     = "checkbox"
								name     = "<% $ballot->id %>_win"
								tabindex = <% $index++ %>
							>
						</td>


%					}

					</tr>

<%perl>
					if ($event_settings{"team_total_line"}) {


						my $columns = 3;

						if ($subscores) {
							$columns += scalar @scores;
						} else {
							$columns++ if $tb_types{"point"};
						}

						$columns++ if $tb_types{"rank"};

</%perl>
						<tr class="<% ($switch % 2) ? "odd" : "even" %>">

							<td
								class="rightalign bluetext semibold"
								colspan="<% $columns %>"
							><% $entry->code %> TOTAL:</td>

							<td class="centeralign">
								<input
									ballotID = "<% $ballot->id %>"
									type    = "number"
									id      = "<% $entry->id %>_total"
									class   = "totals"
									readonly
								>
							</td>

						</tr>

%					}
%					$switch++;
%				}

			</tbody>

		</table>

%		if ($tb_types{"winloss"} && not defined $wudc) {

			<div class="odd">

				<span class="quarter semibold redtext centeralign">
					Winner
				</span>

				<span class="quarter centeralign" id = "winbox">

					<select
						id       = "winner"
						name     = "winner"
						class    = "fixedmed"
						onChange = "checkLPW();"
					>

						<option value="">Choose Winning Entry</option>

%						foreach my $ballot (@ballots) {
%							next unless $ballot->entry;
							<option
								value="<% $ballot->id %>"
								<% $ARGS{"winner"} == $ballot->id ? "selected" : "" %>
							><% $ballot->entry->code %></option>
%						}
					</select>
				</span>

				<span class="quarter centeralign">

					<div class="nowrap nospace">

						<span class="quarter rightalign semibold redtext bluetext">
							Side:
						</span>

						<label for="winner_1">
							<span class="hover third centeralign">
								<input
									type  = "radio"
									name  = "winner_side"
									value = "1"
									id    = "winner_1"
									<% $ARGS{"winner_side"} == 1 ? "checked" : "" %>
								>
								<% $aff_string %>
							</span>
						</label>

						<label for="winner_2">
							<span class="hover third centeralign">

								<input
									type  = "radio"
									name  = "winner_side"
									value = "2"
									id    = "winner_2"
									<% $ARGS{"winner_side"} == 2 ? "checked" : "" %>
								>
								<% $neg_string %>
							</span>
						</label>

					</div>

				</span>

%				if ($tb_types{"winloss"} && $tb_types{"point"} && $no_lpw < 1) {

					<label for="lpw">
						<span id="lpwbox" class = "centeralign quarter hover">

							<span class="threequarters centeralign">
								Low-Point Win?
							</span>

							<span class="quarter centeralign">
								<input
									type  = "checkbox"
									id    = "lpw"
									value = "1"
									name  = "lpw"
									<% $ARGS{"lpw"} ? "checked" : "" %>
								>
							</span>
						</span>
					</label>
%				}

			</div>

			<div class="liblrow rightalign">

%		} elsif ($event_settings{"allow_lowpoints"}) {

			<div class="liblrow rightalign">

				<label for="lpw">

					<div class="half centeralign hover nospace">

						<span class="threequarters">
							Low-Point Ranks?
						</span>

						<span class="quarter centeralign">

							<input
								type  = "checkbox"
								id    = "lpw"
								value = "1"
								name  = "lpw"
								<% $ARGS{"lpw"} ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

%			} else {

				<div class="liblrow rightalign">
%			}

				<input type="submit" value=" Submit Ballot ">

			</div>

<%perl>

		if ($tb_types{"point"}
			&& ($min_points != $min_ob_points || $max_points != $max_ob_points)
		) {

</%perl>
			<div class="row smallish redtext semibold centeralign padvertmore">

				* The full point range is
				<% $min_points ? $min_points : "0" %><% " - ".$max_points %>
				but you must ask the tab room to give points outside of
				<% $min_ob_points." - ".$max_ob_points %>.

			</div>
%		}

%		if ($lower_rules) {
			<div class="padleft">
				<% $lower_rules %>
			</div>
%		}

%		if ($i_can_haz_doubled) {
			<div class="row smallish redtext semibold centeralign padvertmore">
				<span class="inline"> &dagger; </span>
				These entries are doubled entered in another category
				this round.  Please accomodate their need to leave early, or
				wait for them to appear late.
			</div>
%		}

%		unless ($type eq "congress") {

		<div class="full padtopmore">

			<span class="third nospace">
				<h5 class="nospace martop">
					Feedback
				</h5>
			</span>

%			if (scalar @ballots > 3) {

				<span class="twothirds rightalign">

					<span class="half rightalign bigger semibold bluetext">
						Comments go to:
					</span>

					<span class="half centeralign">

						<select
							class="fixedmed"
							onChange = "switchBox(this);"
						>

							<option value="rfd">Everyone (Reason for Rankings)</option>

<%perl>
							foreach my $ballot (@ballots) {

								next if $type eq "congress";

								my $entry = $ballot->entry if $ballot->entry;
								next unless $entry;
								next if $entry->dropped;

</%perl>
								<option
									value="<% $ballot->id %>"
								><% $entry->code
									%>&nbsp;&nbsp;<%
									$entry->code ne $entry->name ? $entry->name : ""
								%></option>
%							}

						</select>
					</span>
				</span>
%			}
		</div>

		<ul id="tabnav">

%			if (scalar @ballots < 4) {

				<li id="header_rfd" class="selected commentzing">
					<a onclick="doneSwitch('rfd');">
						Reason for
						<% $type eq "speech"
							|| $type eq "congress"
							? "Rankings" : "Decision" %>
					</a>
				</li>

<%perl>

				@ballots = sort {$a->entry->code cmp $b->entry->code} @ballots;

				foreach my $ballot (@ballots) {

					next unless $ballot->entry;
</%perl>

					<li id="header_<% $ballot->id %>" class="commentzing">
						<a
							onclick="doneSwitch(<% $ballot->id %>);"
						><% $ballot->entry->code %></a>
					</li>
%				}
%			}

			</ul>

			<div id="box_rfd" class="commentary">

				<span class="threequarters">
					<p class="semibold greentext full">
						These comments go to all participants in the round.
						<% $event_settings{'rfd_plz'}
							? "Must be at least ".$event_settings{'rfd_plz'}." words long."
							: ""
						%>
					</p>
				</span>

				<span class="quarter rightalign semibold redtext">
					Save Feedback:
					<button
						type    = "button"
						onClick = "saveComments(false);"
						class   = "bluetext buttonwhite fa fa-lg fa-save"
					></button>
				</span>

<%perl>
				my $rfd = Tab::Score->search(
					tag    => "rfd",
					ballot => $ballots[0]->id
				)->first if @ballots;
</%perl>

				<div class="full centeralign marno padvertno">
					<textarea
						id        = "rfd_<% $ballots[0]->id %>"
						class     = "feedback"
						type      = "rfd"
						ballot_id = "<% $ballots[0]->id %>"
						name      = "rfd"
						rows      = "15"
						cols      = "60"
					><% $rfd ? $rfd->text : "" %></textarea>
				</div>

			</div>

%			unless ($event->type eq "congress") {
%				BALLOT:
%				foreach my $ballot (@ballots) {

					<div
						id    = "box_<% $ballot->id %>"
						class = "commentary"
					>
<%perl>
						my $entry = $ballot->entry;

						unless ($entry) {
							$ballot->delete;
							next BALLOT;
						}

						my $code = $entry->code;

						$code .= " &ndash; ".$entry->school->code if $ballot_school_code;
						$code .= " &ndash; ".$entry->school->name if $ballot_school_name;
						$code .= " &ndash; ".$entry->name if $ballot_entry_name;

						if ($category_settings{'ballot_entry_titles'}) {
							$code .= " &ndash; ".$entry->setting("title");
						}

						if ($ballot_entry_first_name) {
							foreach my $student ($entry->students) {
								$code .= " &ndash; ".$student->first;
							}
						}

						my $comments = Tab::Score->search(
							tag    => "comments",
							ballot => $ballot->id
						)->first;

</%perl>

						<span class="threequarters">
							<p class="semibold bluetext centeralign full">
								These comments go only to <% $code %> &amp; coaches
							</p>
						</span>

						<span class="quarter rightalign semibold redtext">
							Save Feedback:
							<button
								type    = "button"
								onClick = "saveComments(false);"
								class   = "bluetext buttonwhite fa fa-lg fa-save"
							></button>
						</span>

						<div class="full centeralign marno padvertno">
							<textarea
								id        = "comments_<% $ballot->id %>"
								ballot_id = "<% $ballot->id %>"
								class     = "feedback"
								type      = "comments"
								name      = "comments_<% $ballot->id %>"
								rows      = "15"
								cols      = "60"
							><% $comments ? $comments->text : "" %></textarea>
						</div>

					</div>
%				}
%			}
			</form>

%		} else {

			</div>
%		}

%		if ($event_settings{"big_questions"}) {

			<div class="full centeralign">

				<span class="truethird nospace">
					<a
						target = "_blank"
						href   = "https://www.speechanddebate.org"
					>
					<img
						src   = "<% $bq_stuff{nsda_logo} %>"
						alt   = "<% $bq_stuff{nsda_logo} %>"
						style = "max-width: 220px;"/
					>
					</a>
				</span>


				<span class="truethird nospace">
					<a
						target = "_blank"
						href   = "https://www.templeton.org"
					>
					<img
						src   = "<% $bq_stuff{jtf_logo} %>"
						alt   = "<% $bq_stuff{jtf_logo} %>"
						style = "max-width: 220px;"/
					>
					</a>
				</span>

			</div>

%		}

	</div>


	<div class="menu sticky">

%		if ($tourn_logo) {
			<div class="sidenote">
				<div class=" centeralign">
					<img
						src   = "<% $Tab::s3_url %>/<% $tourn->id."/".$tourn_logo %>"
						alt   = "<% $tourn_logo %>"
						style = "max-width: 220px;"/
					>
				</div>
			</div>
%       }

		<div class="sidenote">

			<span class="twofifths nospace">
				<h6 class="bluetext semibold marbottom">
					This round
				</h6>
			</span>

			<span class="threefifths rightalign">
				<h6 class="bluetext semibold marbottom">
					Start: <% Tab::nicetime($start) %>
				</h6>
			</span>

			<div class="row">
				<span class="quarter semibold">
					Round:
				</span>

				<span class="quarter">
					<% $round->realname %>
				</span>
%				if ($round->flighted > 1) {
					<span class="quarter nowrap semibold">
						Flight
					</span>

					<span class="quarter">
						<% $panel->flight %>
					</span>
%				}
			</div>

			<div class="row">
				<span class="quarter semibold">
					Room:
				</span>
				<span class="threequarter">
					<% $panel->room ? $panel->room->name : "" %>
				</span>
			</div>


%			if ($round->setting("num_judges") > 1) {

				<div class="row nospace">

				<span class="quarter semibold">
					Panel:
				</span>

				<span class="threequarters nospace">

%					foreach my $other_judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) {

%						next if $other_judge->id == $judge->id;

						<div class="nowrap padless marno">
							<% $other_judge->code." ".$other_judge->first." ".$other_judge->last %>
						</div>
%					}

				</span>

				</div>

%			}

			<a
				href="/index/tourn/postings/round.mhtml?tourn_id=<% $tourn->id %>&round_id=<% $round->id %>"
				class="blue full martopmore">
				Full Pairing/Schematic
			</a>

		</div>

<%perl>

		my $point_scale = $event_settings{"point_scale"};
		my $speech_times = $event_settings{"speech_times"};

		if ($point_scale) {

			$point_scale = $m->comp(
				"/funclib/save_editor.mas",
					text        => $point_scale,
					restrictive => 1
				);

			my @point_lines = split(/\R/, $point_scale);

</%perl>

			<div class="sidenote lowspace">

				<h6 class="bluetext semibold marbottom">
					Point Scale
				</h6>

%				foreach my $line (@point_lines) {

%					$line =~ s/\.\.\./<\/span><span class="rightalign right">/g;

					<div class="odd full lightborder padless marno">
						<span class="bluetext semibold">
							<% $line %>
						</span>
					</div>
%				}
			</div>
%		}


<%perl>

		if ($speech_times) {

			$speech_times = $m->comp(
				"/funclib/save_editor.mas",
					text        => $speech_times,
					restrictive => 1
				);

			my @time_lines = split(/\R/, $speech_times);

</%perl>

			<div class="sidenote lowspace">

				<h6 class="bluetext semibold marbottom">
					Speech Times
				</h6>

%				foreach my $line (@time_lines) {

%					$line =~ s/\.\.\./<\/span><span class="rightalign right">/g;

					<div class="odd full lightborder padless marno">
						<span class="bluetext semibold">
							<% $line %>
						</span>
					</div>
%				}
			</div>
%		}

		<div class="sidenote sticky">

<%perl>
			unless ($event_settings{"default_time"}) {

				$event_settings{"default_time"} = 5;
				$event_settings{"default_time"} = 10 if $event->type eq "speech";
				$event_settings{"default_time"} = 3 if $event->type eq "congress";
			}

</%perl>

			<span class="third">
				<h4>Timers</h4>
			</span>

			<span class="twothirds explain rightalign">
				If you refresh or navigate away, these timers will reset
			</span>

			<& "/funclib/stopwatch.mas",
				label   => $panel->id."_timer",
				default => $event_settings{"default_time"}
			&>

<%perl>
			unless ($event->type eq "speech"
				|| $event->type eq "congress"
			) {

				unless ($event_settings{"prep_time"}) {
					$event_settings{"prep_time"} = 4;
				}

				foreach my $ballot (@ballots) {
</%perl>

					<& "/funclib/stopwatch.mas",
						label   => $ballot->id."_timer",
						title   => $ballot->entry->code." Prep",
						default => $event_settings{"prep_time"}
					&>

%				}
%			}

			<h4>Other ballots</h4>
<%perl>

			foreach my $opanel (
				$m->comp(
					"/funclib/person_panels.mas",
					person => $person
				)
			) {

				next unless $opanel->round->published;
				next if $opanel->id == $panel->id;

</%perl>
				<a
					class="yellow full"
					href="ballot.mhtml?panel_id=<% $opanel->id %>&judge_id=<% $opanel->judge %>">
					<% $opanel->round->event->abbr %>
					<% $opanel->round->realname %>
					<% $opanel->round->flighted > 1 ? "Flt ".$opanel->flight : "" %>
					Pending
				</a>
<%perl>
			}

			foreach my $opanel (
				$m->comp(
					"/funclib/person_panels.mas",
					person => $person,
					done   => 1
				)
			) {

				next if $opanel->id == $panel->id;
</%perl>

				<a
					class="blue full"
					href="rfd_only.mhtml?panel_id=<% $opanel->id %>&judge_id=<% $opanel->judge %>"
				>
					<% $opanel->round->event->abbr %>
					<% $opanel->round->realname %>
					<% $opanel->round->flighted > 1 ? "Flt ".$opanel->flight : "" %>
					Done
				</a>
%			}

		</div>
	</div>
