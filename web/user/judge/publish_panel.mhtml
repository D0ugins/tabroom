<%args>
	$person
	$panel_id
</%args>
<%init>

	my $panel = Tab::Panel->retrieve($panel_id);
	
	Tab::Judge->set_sql( panel_person => "
		select judge.*
		from judge, ballot
		where ballot.panel = ? 
		and ballot.judge = judge.id
		and judge.person = ?
	");

	my $judge = Tab::Judge->search_panel_person($panel->id, $person->id)->first;

	unless ($judge) { 
		$m->comp("abort.mas", 
			message => "You are not a judge on that section.  If you think this is in error contact the tournament officials");
	}

	my $event = $panel->round->event;

	unless ($event->setting("judge_publish_results")) { 
		my $err = "This tournament is not using the judge publishing system";
		$m->redirect("ballot_confirm.mhtml?panel_id=".$panel->id."&judge_id=".$judge->id."&err=$err");
	}

	if ($panel->ballots( audit => 0 )) { 
		my $err = "There are still oustanding ballots in this section.  If you think this is in error please contact the tournament officials";
		$m->redirect("ballot_confirm.mhtml?panel_id=".$panel->id."&judge_id=".$judge->id."&err=$err");
	}

	$panel->publish(1);
	$panel->update();

	$m->comp("/funclib/blast_results.mas", 
		panel  => $panel
	);

	my $msg = "Panel results have been published";
	Tab::debuglog("Judge is $judge");
	Tab::debuglog("panle is $panel");

	$m->redirect("ballot_confirm.mhtml?panel_id=".$panel->id."&judge_id=".$judge->id."&msg=$msg");

</%init>
