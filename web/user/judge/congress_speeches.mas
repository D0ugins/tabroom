<%args>
	$tourn
	$judge
	$panel
	$person
	$person_settings
	$event
	$event_settings
	$missing
	$entry_id => undef
</%args>
<%init>

	my @ballots = $panel->ballots;

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;

	my @entries = $m->comp(
		"/funclib/panel_entries.mas",
		panel => $panel
	);

    my $max_points = $event_settings->{"max_points"};
    my $min_points = $event_settings->{"min_points"};
    my $max_ob_points = $event_settings->{"max_ob_points"};
    my $min_ob_points = $event_settings->{"min_ob_points"};

    $min_ob_points = $min_points unless $min_ob_points;
    $max_ob_points = $max_points unless $max_ob_points;
	$min_ob_points = 0 unless $min_ob_points;
	$max_ob_points = 6 unless $max_ob_points;

	my %missings = map {$_ => 1} split(",", $ARGS{"missing"});


	Tab::Score->set_sql( entry_po => "
		select score.*
		from score, ballot
		where ballot.entry = ?
		and ballot.panel   = ?
		and ballot.id = score.ballot
		and score.tag = 'presiding_officer'
	");

</%init>

	<script>
		function poSwitch() {
			if ($("#presiding_officer").prop("checked")) {
				$(".po").removeClass("hidden");
				$(".speech").addClass("hidden");
			} else {
				$(".po").addClass("hidden");
				$(".speech").removeClass("hidden");
			}
		};

		$(document).ready(function() {
			poSwitch();
		});

	</script>

	<div class="full">

%		if (keys %missings) {

			<div class="full borderredthin centeralign">

				<h6 class="bluetext strong">
					Errors found with your last ballot!
				</h6>

				<p class="semibold bigger redtext">
					<% $missings{"points"} ? "No points <br />" : "" %>
					<% $missings{"topic"} ? "No topic <br />" : "" %>
					<% $missings{"side"} ? "No side <br />" : "" %>
					<% $missings{"points_range"} ? "Points out of range <br />" : "" %>
				</p>

				<p class="semibold">
					Please correct these before you continue
				</p>

			</div>

%		} else {

			<span class="twofifths bluetext">
				<h5>
					Per-Speech Points
				</h5>
			</span>


			<span class="fifth rightalign redtext semibold">
				Select a speaker:
			</span>

			<span class="twofifths">

				<form
					action="ballot.mhtml"
					method="post"
				>

					<input
						type = "hidden"
						name = "panel_id"
						value= "<% $panel->id %>"
					>

					<input
						type = "hidden"
						name = "judge_id"
						value= "<% $judge->id %>"
					>

				<select
					name     = "entry_id"
					class    = "fixedbig"
					onChange = "this.form.submit();"
				>
					<option value=""></option>

%					foreach my $entry (@entries) {
%						next if $entry->active != 1;

						<option
							value="<% $entry->id %>"
							<% $entry->id == $entry_id ? "selected='true'" : "" %>
						><%
							$entry->code
						%><%
							$entry->name ne $entry->code
								? "&ndash; ".$entry->name
								: ""
						%></option>
%					}

				</select>

				</form>

			</span>

%		}

	</div>

<%perl>

	if ($entry) {

		my $ballot = Tab::Ballot->search(
			judge => $judge->id,
			entry => $entry->id,
			panel => $panel->id
		)->first;

		unless ($ballot) {
			$m->comp("/funclib/abort.mas",
				err => "You are not slated to judge that competitor this round"
			);
		}

		unless ($panel) {
			$m->comp("/funclib/abort.mas",
				err => "No active chamber found?"
			);
		}

		my $po = Tab::Score->search_entry_po($entry->id, $panel->id)->first;

		my @scores =
			sort {$b->speech <=> $a->speech}
			$ballot->scores( tag => "congress_speech");

		my $score_count = scalar @scores;

		unless (keys %missings) {
			unshift (@scores, "new");
		}

</%perl>

		<h5 class="centeralign martopmore">
			<% $entry->code %><% $entry->name ne $entry->code ? ": ".$entry->name : "" %>
		</h5>


%		foreach my $score (@scores) {


			<div
				id = "<% $entry->id %>"
			>

				<form
					action = "congress_speech_save.mhtml"
					method = "post"
				>

%				unless ($score eq "new") {
					<input
						type = "hidden"
						name = "score_id"
						value= "<% $score->id %>"
					>
%				}

				<input
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel->id %>"
				>

				<input
					type  = "hidden"
					name  = "judge_id"
					value = "<% $judge->id %>"
				>

				<input
					type  = "hidden"
					name  = "entry_id"
					value = "<% $entry->id %>"
				>

%				if ($score eq "new") {

					<div class="full nospace martopmore">

						<span class="nospace twothirds">
							<h6 class="nospace marbottom speech">
								New speech:
							</h6>

							<h6 class="nospace marbottom po">
								New PO rating:
							</h6>
						</span>

%				} else {

					<div class="full nospace martopmore">
						<span class="third speech">
							<h6>Speaker's Speech #<% $score_count %></h6>
						</span>

						<span class="third po">
							<h6>Entry's Score #<% $score_count %></h6>
						</span>

						<span class="third centeralign speech">
							<h6>Session Speec h#<% $score->speech %></h6>
						</span>

						<span class="third centeralign po">
							<h6>Session Speech #<% $score->speech %></h6>
						</span>

%						$score_count--;

%				}

					<span class="third rightalign">

						<span class="twothirds semibold redtext">
							Presiding Officer:
						</span>
						<span class="third">
							<label class = "switch <% $ARGS{"smaller"} ? "smaller" : "" %>" >
								<input
									class         = "padsettingbox"
									type          = "checkbox"
									value         = "1"
									id            = "presiding_officer"
									name          = "presiding_officer"
									target_id     = "<% $entry %>"
									setting_name  = "<% $panel %>"
									onChange      = "postSwitch(this, 'po_switch.mhtml'); poSwitch();"
									<% $po ? 'checked' : "" %>
								>
								<div class="slider"></div>
							</label>
						</span>
					</span>

				</div>

				<div class="lightborder">

					<div class="odd speech <% $po ? "hidden" : "" %>">

						<span class="eighth semibold bigger bluetext centeralign">
							Topic/Bill:
						</span>

						<span class="centeralign threeeighths <% $missings{"topic"} ? "borderredthin" : "" %>">
							<input
								type = "text"
								name = "topic"
								size = "32"
								value = "<%
									$score ne "new" ? $score->topic : ""
								%><%
									$score eq "new" ? $person_settings->{"congress_topic"} : ""
								%>"
							>
						</span>

						<span class="eighth semibold bigger bluetext centeralign">
							Side:
						</span>

						<span class="threetenths <% $missings{"side"} ? "borderredthin" : "" %>">

							<label for="<% $score %>_aff">
								<span class="half hover">
									<input
										id    = "<% $score %>_aff"
										type  = "radio"
										name  = "side"
										value = "1"
										<% $score ne "new" && $score->position == 1 ? 'checked="checked"': "" %>
									>For the bill
								</span>
							</label>

							<label for="<% $score %>_neg">
								<span class="half hover">
									<input
										id    = "<% $score %>_neg"
										type  = "radio"
										name  = "side"
										value = "2"
										<% $score ne "new" && $score->position == 2 ? 'checked="checked"': "" %>
									>Against
								</span>
							</label>
						</span>
					</div>

					<div class="odd padvertmore bigger centeralign semibold orangetext po <% $po ? "" : "hidden" %>">
						Presiding Officership
					</div>

					<div class="padmuchmore">
						<span class="bigger bluetext semibold padvert">Comments &amp; feedback</span>

						<textarea
							placeholder = "General feedback and comments"
							name        = "comments"
							class       = "plain"
							rows        = 5
							cols        = 64
						><% $score ne "new" ? $score->content : ""%></textarea>

					</div>

					<div class="full marno borderbottom even">

						<span class="fiveeighths rightalign semibold redtext bigger">
							Points for this
								<span class="inline speech <% $po ? "hidden" : "" %>">speech</span>
								<span class="inline po <% $po ? "" : "hidden" %>">time period</span>
							(<% $min_ob_points %> - <% $max_ob_points %>):
						</span>

						<span class="eighth rightalign
							<% $missings{"points"} || $missings{"point_range"} ? "borderredthin" : "" %>">
							<input
								type = "number"
								name = "points"
								min  = "<% $min_ob_points %>"
								max  = "<% $max_ob_points %>"
								value = "<% $score ne "new" ? $score->value : "" %>"
							>
						</span>

						<span class="quarter rightalign">
							<input
								type  = "submit"
								value = "Save Speech"
							>
							</form>
						</span>
					</div>
				</div>
			</div>

%		}
%	}

