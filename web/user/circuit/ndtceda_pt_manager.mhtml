<%args> 
	$circuit_id => undef
	$person
	$year => undef
</%args>
<%init>

	my $err;
	my $tz = $person->tz;
	$tz = "UTC" unless $tz;
	
	my $now = DateTime->now( time_zone => $tz );
	my $foo++ unless $year;

	$year = $now->year unless $year;

	if ($now->month > 6 && $foo)  {
		$year++;
	}

	my $begin = DateTime->new( 
		year  => ($year - 1),
		month => 7,
		day   => 1
	);

	my $stop = DateTime->new(
		year  => $year,
		month => 6,
		day   => 30
	);

	my $circuit=Tab::Circuit->retrieve($circuit_id) if $circuit_id;
	$m->abort unless $circuit;

	my @all_tourns = $circuit->tourns if $circuit;

	my @tourns;

	foreach my $at (@all_tourns) { 
		next if $at->hidden;
		push (@tourns, $at) if ($at->start > $begin && $at->end < $stop);
	}

	@tourns = sort {$a->start <=> $b->start } @tourns;

	$m->redirect("/index/index.mhtml?err=No circuit found") unless $circuit;

</%init>

	<& menu.mas, 
		whoami  => "places",
		circuit => $circuit,
		year    => $year 
	&>

	<div class="main">

		<& /funclib/tablesorter.mas, 
			table => "collegedebate"
		&>

		<h2>The <% $circuit->abbr." ".$year." season "%></h2>

		<span class="ninetenths">
			<p> 
				This page allows you to create or delete CEDA/NDT points for
				individual tournaments by event.  Both sets of points require
				an event to have 6 teams from 3 schools to count; clicking on
				the hyperlink in the event column will show you the entries for
				an event.
			</p> 
			
			<p> 
				This also supports ADA points.  Clicking the appropriate column
				will calculate ADA points as well.  Nobody but the ADA circuit
				manager should click that column.  
			</p> 
		</span>

		<span 
			class = 'tenth rightalign'
			id    = "collegedebate_buttonarea"
		> </span>

		<table id="collegedebate">

			<thead>

				<tr class="yellowrow smallish">

					<th class="">
						Name
					</th>
		
					<th class="">
						Dates
					</th>
		
					<th class="">
						Event
					</th>

					<th class="">
						Active Entries
					</th>

					<th class="">
						NDT/CEDA Entries
					</th>

					<th class="">
						ADA Entries 
					</th>

					<th class="nosort">
						Run NDT/CEDA
					</th>

					<th class="nosort">
						Run ADA
					</th>

					<th class="inosort">
						Delete 
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
	 		my $switch;

			foreach my $tourn (@tourns) { 

				my @events = Tab::Event->search( tourn => $tourn->id );

				foreach my $event (@events) {

 					my $start = $tourn->start;
 					my $end = $tourn->end;
					$start->set_time_zone($tz);
					$end->set_time_zone($tz);

</%perl>
					<tr>
						<td class="smallish">
							<% $tourn->name %>
						</td>
		
						<td class="smallish">
							<% Tab::niceshortdate($start) %>
							<% ($start->day != $end->day) ? " - ".Tab::niceshortdate($end) : "" %>
						</td>

						<td class="smallish">
							<a 
								href  = "/index/tourn/fields.mhtml?tourn_id=<% $tourn->id %>&event_id=<% $event->id %>"
								class = "white full padvert"
							>
								<% $event->name %>
							</a>
						</td>
			
						<td class="smallish centeralign">
%							my @entries = Tab::Entry->search( event => $event->id, active => 1 ); 
							<% scalar(@entries) %>
						</td>
					
						<td class="smallish centeralign">
<%perl> 
							Tab::Result->set_sql( ceda_pts => "
								select count(entry.id)
								from entry, result, result_set
								where result_set.event = ? 
								and result_set.label = 'ceda_pts'
								and result_set.id = result.result_set
								and result.entry = entry.id
								and entry.active = 1
							");

							my $result_count = Tab::Result->sql_ceda_pts->select_val($event->id);

							$m->print($result_count);

</%perl> 
						</td>

						<td class="smallish centeralign">
<%perl> 

							Tab::Result->set_sql( ada_pts => "
								select count(entry.id)
								from entry, result, result_set
								where result_set.event = ? 
								and result_set.label = 'ada_pts'
								and result_set.id = result.result_set
								and result.entry = entry.id
								and entry.active = 1
							");

							$result_count = Tab::Result->sql_ada_pts->select_val($event->id);

							$m->print($result_count);

							my $args_string = "event_id=".$event->id."&came_from=manager&circuit_id=".$circuit->id;

</%perl> 
						</td>

						<td class="smallish centeralign">
							<a
								class = "buttonwhite bluetext invert smallish"
								href  = "ndt_ceda_generator.mhtml?<% $args_string %>&ada=false"
							>NDT/CEDA only</a>
						</td>
						
						<td class="smallish centeralign">
							<a 
								class = "buttonwhite bluetext invert smallish"
								href  = "ndt_ceda_generator.mhtml?<% $args_string %>&ada=true"
							>NDT/CEDA/ADA</a>
						</td>
						
						<td class="smallish centeralign">
							<a 
								class = "buttonwhite redtext invert smallish"
								href  = "ndt_ceda_generator.mhtml?<% $args_string %>&delete_only=1"
								<& "/funclib/confirm.mas", 
									warn => "This will delete the result points from ".$tourn->name.".  Are you sure?"
								&>
							>Delete</a>
						</td>
					</tr>
%				}	
%			}

		</table>

		<hr />

		<form 
			action = "tourns.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "circuit_id"
			size  = "5"
			value = "<% $circuit->id %>"
		>

		<div class="even">

			<span class="fourtenths semibold bluetext rightalign">
				View School Year ending:
			</span>
			
			<span class="fifth centeralign">
				<input 
					type  = "text"
					name  = "year"
					size  = "8"
					value = "<% $year %>"
				> 
			</span>

			<span class="twofifths leftalign nospace padvert">
				<input 
					type  = "submit"
					value = "Show Schedule"
				>
			</span>
		</div>
	
		</form>
