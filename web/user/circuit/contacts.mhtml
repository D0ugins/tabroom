<%args>
	$person
	$session
	$circuit_id => undef
</%args>
<%init>

	my $circuit = Tab::Circuit->retrieve($circuit_id);
	my $name = $circuit->name;
	$name =~ s/[\W_]//g;

    my $filename = "$name.csv";
    $m->clear_buffer;
    $r->content_type('application/csv');
    $r->headers_out->{'Content-Disposition'} = "attachment; filename=$filename";

	$m->print("School,");
	$m->print("Code,");
	$m->print("State,");
	$m->print("First,");
	$m->print("Last,");
	$m->print("Email,");
	$m->print("Phone,");
	$m->print("Membership,");
	$m->print("Street,");
	$m->print("State/Prov,");
	$m->print("Zip,");
	$m->print("Country\r\n");

	my @chapters = $m->comp("/funclib/circuit_chapters.mas", circuit => $circuit);

	foreach my $chapter (@chapters) {

		my $member = "N";
		$member = "Y" if $chapter->member;

		foreach my $admin ($chapter->admins) {
			$m->print("\"".$chapter->name."\",");
			$m->print("\"".$chapter->code."\",");
			$m->print("\"".$chapter->state."\",");
			$m->print("\"".$admin->first."\",");
			$m->print("\"".$admin->last."\",");
			$m->print("\"".$admin->email."\",");
			$m->print("\"".$admin->phone."\",");
			$m->print("\"".$member."\",");
			$m->print("\"".$admin->street."\",");
			$m->print("\"".uc($admin->state)."\",");
			$m->print("\"".$admin->zip."\",");
			$m->print("\"".$admin->country."\"\r\n");
		}
	}

	$m->abort();

</%init>
