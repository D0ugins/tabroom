<%args>
	$person
	$school_id
	$category_id => undef
</%args>
<%init>

	use POSIX;

	my $school = Tab::School->retrieve($school_id);
	my $category = Tab::Category->retrieve($category_id);
	my $tourn = $school->tourn;

	my @categories = $tourn->categories;
	$category = $categories[0] if scalar @categories == 1;
	$category_id = $category->id if scalar @categories == 1;

	my @events = $category->events if $category;

	my %category_settings = $category->all_settings if $category;
	my %tourn_settings = $tourn->all_settings;

	my $err;

	my $tz = $person->tz;
	$tz = $tourn->tz unless $tz;
	$tz = "UTC" unless $tz;

	#Make sure that the tournament is open for registration
	my $now = DateTime->now( time_zone => $tz);

	my $judge_deadline = $tourn_settings{"judge_deadline"};
	$judge_deadline->set_time_zone($tz) if $judge_deadline;

	my $judge_per = $category_settings{"judge_per"};
	my $rounds_per = $category_settings{"rounds_per"};
	my $frees_no = $category_settings{"free_strikes_dont_count"};

	my $total_rounds;

	my $fyo_label = $category_settings{"fyo_label"};
	$fyo_label = "First Year Judge" unless $fyo_label;

	my @requests = Tab::JudgeHire->search(
		school => $school->id,
		category => $category->id
	) if $category_id;

	my $deadline;
	my %used_judge = ();

	my %category_weekend;
	my %weekends;

	if ($tourn_settings{"nsda_district"}) {

		OCATEGORY:
		foreach my $ocategory (@categories) {

			my $weekend_id = $ocategory->setting("weekend");

			next unless $weekend_id;
			next if $weekend_id eq "nope";
			my $weekend;

			unless ($weekends{$weekend_id}) {

				$weekend = Tab::Weekend->retrieve($weekend_id);
				next OCATEGORY unless $weekend;

				$weekends{$weekend_id}{'object'} = $weekend;
				$weekends{$weekend_id}{"judge_deadline"} = $weekend->judge_deadline->set_time_zone($tz);
				$weekends{$weekend_id}{"reg_start"} = $weekend->reg_start->set_time_zone($tz);

			} else {
				$weekend = $weekends{$weekend_id}{'object'};
			}

			if ($category == $ocategory) {
				$judge_deadline = $weekends{$weekend_id}{"judge_deadline"};
			}
		}
	}

	my $hired_deadline_passed;

	if ($category_settings{"hired_deadline"}) {
		$hired_deadline_passed++ if $now->epoch > $category_settings{"hired_deadline"}->epoch;
	}
</%init>

	<div class="main">

		<& "tabbar.mas",
			school => $school,
			whoami => "judges"
		&>

<%perl>

		if ($category) {

			my $online_ballots;

			foreach my $e (@events) {
				if ($e->setting("online_ballots")) {
					$online_ballots++
				}
			}

			my $category_deadline = $category_settings{"deadline"};
			$category_deadline->set_time_zone($tz) if $category_deadline;
			$category_deadline = $judge_deadline->clone if $judge_deadline &! $category_deadline;

			if (
				$judge_deadline < $now
				|| $category_deadline
				&& $category_deadline < $now
			) {
				$deadline++;
			}

			my $details_deadline;

			if (
				$tourn->start < $now
				|| 	(	$category_settings{"details_deadline"}
						&& $category_settings{"details_deadline"} < $now
					)
			) {
				$details_deadline++;
			}

			my @shifts = $category->shifts;

			my %category_settings = $category->all_settings();

			my ($unc, $over) = $m->comp(
				"/funclib/judgemath/uncovered_burden_by_category.mas",
					school            => $school,
					category          => $category,
					category_settings => \%category_settings,
					tourn_settings => \%tourn_settings,
			);

            my %stimes_under = $m->comp(
                "/funclib/judgemath/judge_partials_short.mas",
					category          => $category,
					school            => $school,
					category_settings => \%category_settings,
					tourn_settings    => \%tourn_settings
            );

</%perl>

			<span class="threefifths nospace padtopmore">
				<h4 class="nospace"><% $category->name %></h4>
			</span>

			<span class="twofifths nospace rightalign">
%			if ($unc) {

				<p class="redtext semibold bigger">
%					if ($judge_per) {
					 	You still owe <% ceil ($unc / $judge_per) %>
						judge<% ($unc/$judge_per) > 1 ? "s" : ""%>.
%					} elsif ($rounds_per) {
						You still owe <% $unc %> round<% ($unc == 1) ? "" : "s" %>.
%					} else {
						This tournament hasn&apos;t set up its judge burdens yet.
%					}
				</p>
%			}
			</span>

%			if ($details_deadline) {
				<p class="centeralign semibold redtext bigger">
					The deadline to change any judge information has passed. <br />
					You must contact the tournament directly to make further changes.
				</p>

%			} elsif ($deadline) {
				<p class="centeralign semibold redtext bigger">
					The deadline to register or drop judges has passed. <br />
					You must contact the tournament directly to make further changes.
				</p>
%			}

<%perl>

			foreach my $key (keys %stimes_under) {

				my $stime = Tab::JudgeShift->retrieve($key);
				next unless $stimes_under{$stime->id} > 0;

				undef $over;

				if ($stime->no_hires) {

</%perl>
					<h5 class="redtext centeralign">
						You are under obligation a time block.
					</h5>

					<p class="redtext full strong centeralign">

						<br />
							<% $stimes_under{$stime->id} %> too many judges marked as "<% $stime->name %>".
						<br />

						This tournament does not offer partial hires; you must fulfill obligation in all time periods.
					</p>

%				} elsif ($stime->fine) {

					<p class="redtext full strong centeralign">
						<% $stimes_under{$stime->id} %>
							too many judges marked as "<% $stime->name %>".
					</p>

%				}

%				if ($stime->fine) {
					<p class="redtext full strong centeralign">
						You will be charged
						<%
							$tourn_settings{"currency"}
							? $tourn_settings{"currency"}
							: "&#36;"
						%><% $stime->fine * $stimes_under{$stime->id} %>

						unless you meet your judge obligation in all time blocks.

					</p>
%				}
%			}


%			if ($over) {

				<p class="greentext full centeralign semibold bigger marno">

%					if ($category_settings{"hired_fee"} > 0 && $judge_per) {
					 	You are over obligation on judging by
							<% ceil ($over / $judge_per) %> judges.
%					} elsif ($judge_per) {
						You have enough judging coverage for
							<% $over %> more entr<% ($over == 1) ? "y" : "ies" %>
%					} elsif ($rounds_per) {
						You are over obligation on judging by
						<% $over %> round<% ($over == 1) ? "" : "s" %>
%					}

%					if (@requests) {
						<br />
						Reduce your hired judging below,
						or you will still be charged for them!
%					}
				</p>
%			}

%			if ($rounds_per && (not defined $details_deadline)) {

				<form
					action = "rounds_save.mhtml"
					method = "post"
				>

				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>
				<input
					type  = "hidden"
					name  = "category_id"
					value = "<% $category->id %>"
				>
%			}

<%perl>
			my @judges = $m->comp(
				"/funclib/judgemath/judges_by_category.mas",
					school            => $school,
					category          => $category,
					category_settings => \%category_settings
			);
</%perl>

			<div class="full nospace marleftmore"><% $category_settings{"judge_policy"} %></div>

%			if (@judges) {

			<table>

				<tr class="yellowrow smallish">

%					unless ($tourn_settings{"hide_codes"} || $category_settings{"no_codes"}) {
						<th>Code</th>
%					}

					<th>
						Edit
					</th>

					<th>
						Name
					</th>

%					if ($rounds_per) {
						<th>
							Rounds
						</th>
%					}

%					if ($online_ballots) {
						<th title="Linked account for online ballots">
							Linked?
						</th>
%					}

%					if ($category_settings{"paradigm_before_strikes"} || $category_settings{"paradigm_form"}) {
						<th>
							Paradigm<% $category_settings{"paradigm_before_strikes"} ? '*' : '' %>
						</th>
%					}

%					if (@shifts) {
						<th>
							Availability
						</th>
%					}

%					if ($category_settings{"coach_ratings"}) {
						<th>
							Ratings
						</th>
%					}

					<th>
						Details
					</th>

					<th>
						Limits
					</th>

%					unless ($deadline) {
						<th>
						</th>
%					}

				</tr>

<%perl>
				my $first_free = 1 if $category_settings{"dont_count_free_strikes"};

				foreach my $judge (@judges) {

					my @strikes = $judge->strikes();

					$used_judge{$judge->chapter_judge->id}++ if $judge->chapter_judge;

					$total_rounds += $judge->obligation unless $judge->setting("free_strike");

					my $args = "school_id=".$school->id."&judge_id=".$judge->id;

</%perl>


%					if ($frees_no && $first_free && $judge->setting("free_strike")) {

%						undef $first_free;

						<tr class="oddrow">
							<td colspan="28">
								<h4>Non-credited judging:</h4>
							</td>
						</tr>
%					}

					<tr class="row">

%						unless ($tourn_settings{"hide_codes"} || $category_settings{"no_codes"}) {
							<td>
								<% $judge->code %>
							</td>
%						}

						<td class="centeralign">
%							unless ($details_deadline) {
								<a
									class="buttonwhite bluetext fa fa-edit fa-sm"
									href="judge_details.mhtml?<% $args %>">
								</a>
%							}
						</td>

						<td>
							<% $judge->first." ".$judge->last%>
						</td>


%						if ($deadline) {

							<td class="centeralign">
								<% $judge->obligation %>
							</td>

%						} elsif ($rounds_per) {

							<td class='centeralign'>
								<input
									type  = "number"
									name  = "<% $judge->id %>"
									size  = "5"
									min   = "1"
									max   = "99"
									value = "<% $judge->obligation %>"
								>
							</td>
%						}

%						if ($online_ballots) {
							<td class="centeralign">
								<span class="fa fa-lg <% $judge->person > 0 ? "greentext fa-check" : "redtext fa-times" %>"></span>
							</td>
%						}

%						if ($category_settings{"paradigm_form"}) {
							<td class="centeralign">
								<a
									href  = "questionnaire.mhtml?<% $args %>&tag=<% $category_settings{"paradigm_form"} %>"
									class = "bluetext buttonwhite smallish marvertmore fa fa-file-text-o"
								></a>
							</td>
%						} elsif ($category_settings{"paradigm_before_strikes"}) {
							<td class="centeralign nospace">
%								if ($judge->person > 0 && $judge->person->setting('paradigm')) {
									<span class="fa fa-lg greentext fa fa-check"></span>
%								} else {
									<span class="fa fa-lg redtext fa fa-times"></span>
%								}
							</td>
%						}

%						if (@shifts) {

%							my $haz_shifts;

							<td class="smaller">
%								unless ($deadline) {
									<a
										class="white"
										href="judge_shift.mhtml?<% $args %>"
									>
%								}

%									foreach my $shift ($category->shifts) {
%										if ($shift->strike($judge)) {
%											$haz_shifts++;
											<span class="full smallish padvertless marno">
												Not available <% $shift->name %>
											</span>
%										}
%									}

%									unless ($haz_shifts) {
										All rounds
%									}
%								unless ($deadline) {
									</a>
%								}

							</td>
%						}

%						if ($category_settings{"coach_ratings"}) {

							<td class="centeralign smallish">
								<% $m->comp("/funclib/judge_rating.mas",
									print => 1,
									judge => $judge )
								%>
							</td>
%						}

						<td>

%							if ($judge->ada) {
								<span class="semibold bluetext full padless marno">
									ADA rooms requested
								</span>
%							}

%							if ( $category_settings{"first_year_outs"} || $category_settings{"dont_count_free_strikes"}) {
								<span class="redtext semibold full padless marno">
									<% $judge->setting("first_year") ?  $fyo_label : "" %>
									<% $judge->setting("free_strike") ? "(Free Strike)" : "" %>
								</span>
%							}

						</td>

						<td>
%							foreach my $strike (sort {$a->type cmp $b->type} @strikes) {
%								if ($strike->type eq "departure") {
									<span class="full nospace padless smallish bluetext semibold">
										Departing <&
											"/funclib/showdt.mas",
												dt     => $strike->start,
												length => "casual",
												tz     => $tourn->tz
											&> <% &Tab::tzname($tourn->tz) %>
									</span>
%								} elsif ($strike->registrant) {
									<span class="full nospace padless smallish redtext semibold">
%										if ($strike->type eq "event") {
											No <% $strike->event->abbr %>
%										} elsif ($strike->type eq "school") {
											No <% $strike->school->short_name %>
%										} elsif ($strike->type eq "entry") {
											No <% $strike->entry->name %>
%										}
									</span>
%								}
%							}
						</td>

%						unless ($deadline) {
							<td class="centeralign padless">
								<a
									class="redtext buttonwhite fa-trash fa fa-lg"
									href="judge_drop.mhtml?<% $args %>">
								</a>
							</td>
%						}

					</tr>

% 				}

				</table>

%				if ($rounds_per) {

					<div class="row centeralign ltborder">

						<span class="half rightalign semibold bluetext padvertmore">
							Total Rounds Provided:
						</span>

						<span class="half leftalign semibold bluetext padvertmore">
							<% $total_rounds %>
						</span>
					</div>
%				}


%				if ($rounds_per && (not defined $deadline)) {

					<div class="liblrow rightalign">
						<span class="quarter centeralign">
							<input
								type  = "submit"
								value = "Save Rounds"
							>
						</span>
					</div>

					</form>
%				}

%			if ($category_settings{"paradigm_before_strikes"}) {
				<p class="semibold redtext padbottommore centeralign biggish martopmore">
					*This tournament requires all judges to have a paradigm
					before you may enter strikes or preferences.
				</p>
%			}

%			} elsif ($rounds_per) {

				</form>

%			}

%			if ($category_settings{"exchange"} ) {

<%perl>

				my @judges = $m->comp(
					"/funclib/exchange_judges.mas",
					category => $category
				);

				if (@judges) {

</%perl>
				<h5 class="martopmore">Hired Judge Exchange</h5>

					<div class="pagefull">
						<div class="even full nospace">
							<span class="threequarters semibold bluetext centeralign bigger">
								<% scalar @judges %> judge<% scalar @judges > 1 ? "s" : "" %>
								can be hired
							</span>

							<span class="quarter leftalign">
								<a
									class="buttonwhite bluetext invert"
									href="hire_exchange.mhtml?school_id=<% $school->id %>&category_id=<% $category->id %>">
									Add Hires
								</a>
							</span>
						</div>
					</div>
%				}

%				if (@requests) {
					<h5 class="martopmore">Exchange Hired Judges</h5>
%				}

%				foreach my $request (@requests) {

%					next unless $request->judge;

					<div class="pagefull row">
						<span class="threequarter semibold bluetext centeralign">
							Hired <% $request->judge->first." ".$request->judge->last %>
							for <% $request->rounds_requested %>
							rounds
						</span>

%						unless ($hired_deadline_passed) {
							<span class="quarter leftalign padvert">
								<a
									class = "buttonwhite redtext invert"
									href  = "hire_cancel.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>&back=roster"
								>
									Cancel
								</a>
							</span>
%						}
					</div>
%				}
%			}

%			if ($category_settings{"track_judge_hires"} ) {

%				if ($category_settings{"uncovered_entry_fee"} > 0) {

					<h4>Tournament Hired Judging</h4>

					<table>

%						foreach my $request (@requests) {

%							next if $request->judge;

							<tr class="row">

								<td class="smallish">
									Request made <%
										Tab::niceshortdt($request->requested_at->set_time_zone($tz))
									%>
								</td>

								<td class="centeralign smallish">
									<% $request->entries_accepted
										? $request->entries_accepted
										: 0
									%> accepted
								</td>

								<td class="centeralign smallish">
									<% $request->entries_requested %> requested
								</td>

%								my $warn = "This will reduce your judging request by 1.  Are you sure?";

%								unless ($hired_deadline_passed) {

									<td class="centeralign smallish">
										<a
											class = "buttonwhite orangetext fa fa-arrow-down fa-lg"
											title = "Reduce request by 1"
											href  = "hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
											<& "/funclib/confirm.mas", warn => $warn &>
										></a>
									</td>

%									$warn = "This will delete your judging request entirely. Are you sure?";

									<td class="centeralign smallish">
										<a
											class = "buttonwhite redtext fa fa-trash fa-lg"
											href  = "hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
											<& "/funclib/confirm.mas", warn => $warn &>
										></a>
									</td>

%								} else {

									<td class="centeralign smallish padvertmore semibold redtext">
										Deadline Passed
									</td>
%								}

							</tr>
<%perl>
						}

						unless ($judge_deadline < $now
							|| $category_deadline < $now
							|| $hired_deadline_passed
						) {
</%perl>
							<tr class="row martop">

								<td>
									<form
										action = "hire_save.mhtml"
										method = "post"
									>
									<input
										type  = "hidden"
										name  = "school_id"
										value = "<% $school->id %>"
									>
									<input
										type  = "hidden"
										name  = "category_id"
										value = "<% $category->id %>"
									>
									New Request:
								</td>

								<td class="centeralign" colspan="2">
									Cover
									<input
										type  = "number"
										min   = "0"
										max   = "99"
										name  = "hired_number"
										size  = "4"
										value = "">
									entries
								</td>

								<td
									class="centeralign"
									colspan="2">

									<input
										class = "thin"
										type  = "submit"
										value = "Request Hires"
									>

									</form>
								</td>
							</tr>
%						}

					</table>

					<p class="explain" style="padding-left: 10px;">
						This tournament hires judging by the entry, not the
						whole judge.  Enter hire requests for the number of
						entries who you do not have judging for.  Please note
						that a hire request does not mean the tournament has
						judges available for hire; Tabroom will email you
						when/if your request is accepted.
					</p>
<%perl>

				}

				if ($category_settings{"hired_fee"} > 0) {

					my $hires_requested;
					my $hires_accepted;

					foreach my $request (@requests) {
						$hires_requested += $request->entries_requested;
						$hires_accepted += $request->entries_accepted;
					}

					$hires_requested = ceil($hires_requested / $judge_per) if $judge_per;
					$hires_accepted = ceil($hires_accepted / $judge_per) if $judge_per;

</%perl>

					<h4 class="martop">Tournament Hired Judging</h4>

%					if ($category_settings{"hired_deadline"}) {
						<span class="full bigger centeralign redtext semibold marvert">
							Requests for hired judging cannot be added or deleted after
							<& "/funclib/showdate.mas",
								dt => $category_settings{"hired_deadline"},
								tz => $tz
							&> at
							<& "/funclib/showtime.mas",
								dt => $category_settings{"hired_deadline"},
								tz => $tz
							&>
						</span>
%					}

					<table>

%					foreach my $request (@requests) {

%						next if $request->judge;

						<tr class="row">

							<td class="smallish">
								Request made
								<% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
							</td>

							<td class="centeralign smallish">
								<% $request->entries_accepted && $judge_per
									? ceil($request->entries_accepted / $judge_per)
									: 0
								%> accepted
							</td>

							<td class="centeralign smallish">
								<% ($judge_per
									? ceil($request->entries_requested / $judge_per)
									: $request->entries_requested )
								%> requested
							</td>

<%perl>
							my $warn = "This will reduce your judging request by 1.  Are you sure?";

							unless ($category_settings{"hired_deadline"}
								&& $category_settings{"hired_deadline"} < $now
							) {
</%perl>

							<td class="centeralign smallish">

								<a  class = "buttonwhite orangetext fa fa-arrow-down fa-lg"
									title = "Reduce request by 1"
									href  = "hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
									<& "/funclib/confirm.mas", warn => $warn &>
								></a>
							</td>

%							$warn = "This will delete your judging request entirely. Are you sure?";

							<td class="centeralign smallish">
								<a
									class="redtext buttonwhite fa-trash fa fa-lg"
									href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
									<& "/funclib/confirm.mas", warn => $warn &>
								></a>
							</td>

%							} else {

								<td class="centeralign smallish padvertmore semibold redtext">
									Deadline Passed
								</td>
%							}

						</tr>

<%perl>
					}

					unless (
						$judge_deadline < $now
						|| $category_deadline < $now
						|| ($category_settings{"hired_deadline"}
							&& $category_settings{"hired_deadline"} < $now)
						) {
</%perl>

						<form action="hire_save.mhtml" method="post">

						<input
							type  = "hidden"
							name  = "school_id"
							value = "<% $school->id %>"
						>

						<input
							type  = "hidden"
							name  = "category_id"
							value = "<% $category->id %>"
						>

		            	<tr class="row martop">

 							<td>
    		            	    New Request:
            			    </td>

                			<td class="centeralign" colspan="2">
                			    <input
									type  = "number"
									name  = "hired_number"
									min   = "0"
									max   = "99"
									value = "<% $hires_requested %>'"
								>
								hired judges
							</td>

                			<td class="rightalign" colspan="2">
                    			<input
									type  = "submit"
									value = "Save"
								>
                			    </form>
            			    </td>

    		        	</tr>

%					}

					</table>

<%perl>
				}

				if ($category_settings{"round_hire_fee"} > 0) {

					my @requests = Tab::JudgeHire->search(
						school   => $school->id,
						category => $category->id
					);

					my $hires_requested;
					my $hires_accepted;

					foreach my $request (@requests) {
						$hires_requested += $request->rounds_requested;
						$hires_accepted += $request->rounds_accepted;
						$total_rounds += $request->rounds_accepted;
					}

</%perl>
					<h4 class="martop">Tournament Hired Judging</h4>

%					if ($category_settings{"hired_deadline"}) {
						<span class="full bigger centeralign redtext semibold marvert">
							Requests for hired judging cannot be added or deleted after
							<& "/funclib/showdate.mas",
								dt => $category_settings{"hired_deadline"},
								tz => $tz
							&> at
							<& "/funclib/showtime.mas",
								dt => $category_settings{"hired_deadline"},
								tz => $tz
							&>
						</span>
%					}

					<table>

%					foreach my $request (@requests) {

%						next if $request->judge;

						<tr class="row">

							<td class=" smallish">
								Request made
								<% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
							</td>

							<td
								class="centeralign smallish
									<% $request->rounds_accepted < $request->rounds_requested
										? "redtext"
										: ""
								%>">
								<% $request->rounds_accepted %> rounds accepted
							</td>

							<td class="centeralign smallish">
								<% $request->rounds_requested %> rounds requested
							</td>

%							my $warn = "This will reduce your judging request by 1 round.  Are you sure?";

							<td class="centeralign smallish">
%								unless ($category_settings{"hired_deadline"}
%									&& $category_settings{"hired_deadline"} < $now
%								) {
									<a
										class = "buttonwhite orangetext fa fa-arrow-down fa-lg"
										title = "Reduce request by 1"
										href  = "hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &>
									></a>
%								}
							</td>

%							$warn = "This will delete your judging request entirely. Are you sure?";

							<td class="centeralign smallish">
<%perl>
								unless ($category_settings{"hired_deadline"}
									&& $category_settings{"hired_deadline"} < $now
								) {
</%perl>
									<a
										class = "redtext buttonwhite fa-trash fa fa-lg"
										href  = "hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>"
										<& "/funclib/confirm.mas", warn => $warn &>
									></a>
%								}
							</td>

						</tr>

<%perl>
					}

					unless (
						$judge_deadline < $now
						|| $category_deadline < $now
						|| ($category_settings{"hired_deadline"}
							&& $category_settings{"hired_deadline"} < $now)
					) {
</%perl>
		            	<tr class="row martop">

 							<td>
                			    <form action="hire_save.mhtml" method="post">
            		    	    <input
									type  = "hidden"
									name  = "school_id"
									value = "<% $school->id %>"
								>
        		        	    <input
									type  = "hidden"
									name  = "category_id"
									value = "<% $category->id %>"
								>
    		            	    New Request
								<% $category_settings{"hired_deadline"} %>
            			    </td>

                			<td class="centeralign" colspan="2">
                			    <input
									type  = "number"
									name  = "rounds"
									min   = "0"
									max   = "<% $unc %>"
									value = ""
								> rounds
							</td>

                			<td class="rightalign" colspan="2">
                    			<input
									type  = "submit"
									value = "Save"
								>
                			    </form>
            			    </td>

    		        	</tr>

%					}

					</table>

<%perl>
				}
			}


		} else {
</%perl>

			<h4>Judges</h4>

			<p>
				Choose a judge category at right to enter judges or hire out
				judging committments (where tournaments permit).
			<p>

			<p>
				Divisions marked in red are divisions where you still owe
				judging.
			</p>

%		}

%		if ($category && $category_settings{'judge_policy'} > 0) {
			<h4 style="margin-left: 5px;"><% $category->abbr %> Judging notes:</h4>
			<p style="padding: 5px;"><% $category_settings{"judge_policy"} %></p>
%		}

	</div>

	<div class="menu">

		<div class="sidenote">
<%perl>

			if ($category && ($judge_deadline > $now)) {

				my $category_deadline = $category_settings{"deadline"};

				$category_deadline->set_time_zone($tz) if $category_deadline;

				$category_deadline = $judge_deadline->clone unless $category_deadline;

				unless ($category_deadline && $category_deadline < $now) {

					$m->print('<h4>Add Judge</h4>');

					my @chapter_judges = $m->comp(
						"/funclib/chapter_judges_free.mas",
						school   => $school,
						category => $category
					);

				    my $now = DateTime->now;

					if (@chapter_judges) {

</%perl>

						<form
							action = "judge_save.mhtml"
							method = "post"
						>

						<input
							type  = "hidden"
							name  = "category_id"
							value = "<% $category->id %>"
						>
						<input
							type  = "hidden"
							name  = "school_id"
							value = "<% $school->id %>"
						>

						<div class="row centeralign padbottom">

							<select
								name             = "chapter_judge_id"
								size             = "7"
								class            = "fixedmedsmall chosen"
								data-placeholder = "Select judge..."
							>

<%perl>

							foreach my $chapter_judge (
								sort {$a->last cmp $b->last}
								@chapter_judges
							) {

								next if $used_judge{$chapter_judge->id}++;

</%perl>
								<option
									value="<% $chapter_judge->id %>"
								><% $chapter_judge->last.", ".$chapter_judge->first %></option>

%							}

							</select>
						</div>

						<div class="libl full rightalign padless marbottommore">
							<input
								type  = "submit"
								class = "thin"
								value = "Add Judge"
							>
						</div>

						<div class="centeralign bluetext semibold">
							Judge deadline is <% Tab::xmldt($judge_deadline) %>
						</div>


						</form>

%					} else {

						<p>
							You have no judges on your roster to add.  Please add
							them before registering them into the tournament.  You
							only need to type in each judge's name to your roster
							once; they'll be available for all future tournaments.
						</p>
%					}

					<a
						class="yellow full martop"
						href="/user/chapter/judge_edit.mhtml?from=<% $category->id %>&chapter_id=<% $school->chapter->id %>">
						Add Judge to Roster
					</a>

					<hr />
%				}

%			} elsif ($category) {

				<div class="centeralign redtext semibold">
					Judge deadline was <% Tab::xmldt($judge_deadline) %>
				</div>

%			}

			<h4>Judge categories</h4>

<%perl>

			foreach my $ocategory (sort {$a->name cmp $b->name} @categories) {

				my $weekend_id = $ocategory->setting('weekend');

				next if $weekend_id eq "nope";

				next if $weekend_id
					&& $weekends{$weekend_id}{"reg_start"} > $now;

				my %ocategory_settings = $ocategory->all_settings();
				my $ocategory_deadline = $ocategory_settings{"deadline"};
				my $no_free = $ocategory_settings{"free_strikes_dont_count"};

				$ocategory_deadline->set_time_zone($tz) if $ocategory_deadline;

				my ($unc, $over) = $m->comp(
					"/funclib/judgemath/uncovered_burden_by_category.mas",
						school            => $school,
						category_settings => \%ocategory_settings,
						tourn_settings    => \%tourn_settings,
						category          => $ocategory
				);

				my @category_judges = $school->judges(category => $ocategory->id);

				my $obligation = $m->comp(
					"/funclib/judgemath/judges_needed_by_category.mas",
						school            => $school,
						category_settings => \%ocategory_settings,
						tourn_settings    => \%tourn_settings,
						category          => $ocategory
				);

				my %stimes_under = $m->comp(
					"/funclib/judgemath/judge_partials_short.mas",
					category          => $ocategory,
					category_settings => \%ocategory_settings,
					tourn_settings    => \%tourn_settings,
					school            => $school
				);

				my $partial_under;

	            foreach my $key (keys %stimes_under) {
					$partial_under += $stimes_under{$key};
				}

				my $rounds;

				if ($rounds_per) {
					foreach my $judge (@category_judges) {
						$rounds += $judge->obligation
							unless $no_free && $judge->setting("free_strike");

					}
				}

				my $status_mark;
				my $line_color = "odd";
				my $title;
				my $text;

				if ($unc > 0) {

					$status_mark = "fa fa-times redtext";
					$text = "redtext";
					$title = "You have not met obligation in this judge category";

				} elsif ($partial_under > 0) {

					$status_mark = "fa redtext fa-exclamation-triangle";
					$text = "redtext";
					$title = "You are short of obligation in some time blocks in this category";

				} else {

					$status_mark = "fa fa-check greentext";
					$text = "greentext";
					$title = "Obligation met";
				}

				if ($ocategory == $category) {
					$line_color = "even";
				}

</%perl>

				<a
					class="<% $line_color %> full grayhover white marno"
					href="judges.mhtml?school_id=<% $school->id %>&category_id=<% $ocategory->id %>"
				>

					<span class="nowrap threefifths semibold">
						<% $ocategory->name %>
					</span>

					<span class="quarter nospace bigger semibold <% $text %>">
%						if ($obligation) {
							<% $rounds ? $rounds : scalar @category_judges %>/<% $obligation %>
							<% $rounds ?
									( $unc < 1
										&& ($rounds && $rounds < $obligation) )
										? "+ Hires"
										: ""
								: ($unc < 1 && $obligation > 0 && scalar @category_judges < $obligation)
									? "+ Hires "
									: ""
							%>
%						} else {
							<% $unc %>
%						}
					</span>

					<span class="tenth rightalign <% $status_mark %>">
					</span>
				</a>

%				if ($ocategory_deadline) {

					<a
						href="/user/tourn/entry/judges.mhtml?school_id=<% $school->id %>&category_id=<% $ocategory->id %>"
						class="white"
					>
						**<% $ocategory->abbr %>
						Judges due:
						<% &Tab::niceshortdt($ocategory_deadline->set_time_zone($tz)) %>
					</a>

%				}
%			}

		</div>
	</div>
