<%args> 
	$person
	$school_id
	$category_id => undef
</%args>
<%init>

	use POSIX;

	my $school = Tab::School->retrieve($school_id);
	my $category = Tab::Category->retrieve($category_id);
	my $tourn = $school->tourn;

	my @categories = $tourn->categories;
	$category = $categories[0] if scalar @categories == 1;
	$category_id = $category->id if scalar @categories == 1;
	
	my @events = $category->events if $category;

	my $err;

	my $tz = $person->tz;
	$tz = $tourn->tz unless $tz;
	$tz = "UTC" unless $tz;

	#Make sure that the tournament is open for registration
	my $now = DateTime->now( time_zone => $tz);

	my $judge_deadline = $tourn->setting("judge_deadline");
	$judge_deadline->set_time_zone($tz) if $judge_deadline;

	my $judge_per = $category->setting("judge_per") if $category;
	my $rounds_per = $category->setting("rounds_per") if $category;
	my $frees_no = $category->setting("free_strikes_dont_count") if $category;
	my $total_rounds;

	my $fyo_label = $category->setting("fyo_label") if $category;
	$fyo_label = "First Year Judge" unless $fyo_label;

	my @requests = Tab::JudgeHire->search( 
		school => $school->id, 
		category => $category->id 
	) if $category_id;

	my $deadline;
	my %used_judge = ();


</%init>

	<div class="main">
    
		<h2>Judges: <% $tourn->name %></h2>
    	
		<& menu.mas, school => $school, whoami => "judges" &>

%		if ($category) { 

%			my $category_deadline = $category->setting("deadline");
%			$category_deadline->set_time_zone($tz) if $category_deadline;
%			$category_deadline = $judge_deadline->clone if $judge_deadline &! $category_deadline;

%			if ($judge_deadline < $now || $category_deadline &&  $category_deadline < $now) { 							

				<p class="warning">
					The deadline to enter judge information online has passed.
					You must contact the tournament directly to make
					changes.
				</p>

%				$deadline++;

%			}

%           my ($unc, $over) = $m->comp("/funclib/judgemath/uncovered_burden_by_category.mas", school => $school, category => $category);

%			if ($unc) { 

				<h5 class="redtext centeralign martopmore padmuchmore">

%					if ($category->setting("hired_fee") > 0 && $judge_per) { 
					 	You still owe <% ceil ($unc / $judge_per) %> judge<% ($unc/$judge_per) > 1 ? "s" : ""%>.
%					} elsif ($judge_per) { 
						You still have <% $unc %> entr<% ($unc == 1) ? "y" : "ies" %> uncovered.  
						Each judge covers <% $judge_per %> entries.
%					} elsif ($rounds_per) { 
						You still owe <% $unc %> round<% ($unc == 1) ? "" : "s" %>.
%					}

				</h5>
%			}

%			if ($over) { 

				<p class="greentext full centeralign strong">

%					if ($category->setting("hired_fee") > 0 && $judge_per) { 
					 	You are over obligation on judging by <% ceil ($over / $judge_per) %> judges.
%					} elsif ($judge_per) { 
						You are over obligation on judging coverage by <% $over %> entr<% ($over == 1) ? "y" : "ies" %>.
%					} elsif ($rounds_per) { 
						You are over obligation on judging by <% $over %> round<% ($over == 1) ? "" : "s" %> 
%					}

%					if (@requests) { 
						Reduce your hired judging below, or you will still be charged for them!
%					}
				</p>
%			} 

			<h4><% $category->name %> Judges</h4>

%			if ($rounds_per) { 
				<form action="rounds_save.mhtml" method="post">
				<input type="hidden" name="school_id" value="<% $school->id %>">
				<input type="hidden" name="category_id" value="<% $category->id %>">
%			}

			<div class="full nospace marleftmore"><% $category->setting("judge_policy") %></div>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="yellowrow">

					<% ($tourn->setting("hide_codes")|| $category->setting("no_codes")) ? "" : "<th>Code</th>" %>

					<th class="smallish leftalign">
						Name
					</th>

%					if ($rounds_per) { 
						<th class="smallish leftalign">
							Rounds
						</th>
%					}

%					if ($category->strike_timeslots) { 
						<th class="smallish leftalign">
							Availability 
						</th>
%					}

%					if ($category->setting("coach_ratings")) { 
						<th class="smallish leftalign">
							Ratings
						</th>
%					}

%					if ($category->setting("first_year_outs")) { 
						<th class="smallish leftalign">
							Limits
						</th>
%					}

					<th>
					</th>

					<th>
					</th>

				</tr>

%				my $first_free = 1 if $category->setting("dont_count_free_strikes");

%				my @judges = $m->comp("/funclib/judgemath/judges_by_category.mas", 
%										school   => $school,
%										category => $category
%									);

%				foreach my $judge (@judges) { 

%					$used_judge{$judge->chapter_judge->id}++ if $judge->chapter_judge;

%					if ($frees_no && $first_free && $judge->setting("free_strike")) { 
						
%						undef $first_free;

						<tr class="libl">

%							 unless ($tourn->setting("hide_codes")|| $category->setting("no_codes")) { 
								<td>
								</td>
%							 }

							<th class="smallish">
								Rounds Provided
							</td>

							<td>
								<% $total_rounds %>
							</td>

							<td colspan="7">
							</td>

						</tr>

						<tr class="oddrow">
							<td colspan="8">
								<h4>Non-credited judging:</h4>
							</td>
						</tr>

%					}

%					my @strikes = Tab::Strike->search( type => "event", judge => $judge->id, registrant => 1 );

					<tr class="row">

						<% ($tourn->setting("hide_codes")|| $category->setting("no_codes")) ? "" : "<td>".$judge->code."</td>" %>

						<td>
%							unless ($judge_deadline < $now || $category_deadline < $now) { 							
								<a class="white" href="judge_details.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
%							}
								<% $judge->first." ".$judge->last%>
							</a>

%							if ($judge->ada || @strikes) { 
								<span class="nolink white smaller">
									<% ($judge->ada) ? "(Accessible Rooms Requested)" : "" %>
%									foreach my $strike (@strikes) { 
										No <% $strike->event->abbr %> 
%									}
								</span>
%							}

						</td>

%						if ($deadline) { 

							<td>
								<% $judge->obligation %>
							</td>

%						} elsif ($rounds_per) { 

							<td class='centeralign'>
								<input type="number" name="<% $judge->id %>" size="5" min="1" max="99" value="<% $judge->obligation %>">
								</form>

%								$total_rounds += $judge->obligation unless $judge->setting("free_strike");

							</td>

%						}

%						if ($category->strike_timeslots) { 

%							my $strike_timeslotend;

							<td class="smaller">
%								unless ($judge_deadline < $now || $category_deadline < $now) { 							
									<a class="white" href="judge_striketime.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
%								}

%									foreach my $strike_timeslot ($category->strike_timeslots) { 
%										if ($strike_timeslot->strike($judge)) { 
%											$strike_timeslotend++;
											Not available <% $strike_timeslot->name %> 
											<br />
%										}
%									}

%									unless ($strike_timeslotend) { 
										All rounds
%									}
								
								</a>

							</td>
%						}

%						if ($category->setting("coach_ratings")) { 

							<td class="centeralign smallish">
								<% $m->comp("/funclib/judge_rating.mas", print => 1, judge => $judge )%>
							</td>

%						}

%						if ( $category->setting("first_year_outs") || $category->setting("dont_count_free_strikes") ) { 
							<td class="centeralign smallish">
								<% $judge->setting("first_year") ?  $fyo_label." <br />" : "" %>
								<% $judge->setting("free_strike") ? "Free Strike" : "" %>
							</td>
%						}

						<td class="centeralign padno">
%							unless ($judge_deadline < $now || $category_deadline < $now) {
								<a 
									class="greentext button buttonwhite fa fa-edit fa-lg"  
									href="judge_details.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
								</a>
%							}
						</td>
						
						<td class="centeralign padless">
%							unless ($judge_deadline < $now || $category_deadline < $now) {
								<a 
									class="redtext button buttonwhite fa-trash fa fa-lg" 
									href="judge_drop.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>">
								</a>
%							}
						</td>

					</tr>

% 				}

%				if ($first_free && $rounds_per) { 
						
%					undef $first_free;

					<tr class="row">

%						 unless ($tourn->setting("hide_codes")|| $category->setting("no_codes")) { 
							<td>
							</td>
%						 }

						<td class="rightalign padrightmore strong">
							Total Rounds Provided:
						</td>

						<td class="centeralign padrightmore strong">
							<% $total_rounds %>
						</td>

						<td colspan="7">
						</td>

					</tr>

					<tr class="liblrow">
						<td colspan="5" class="rightalign">
							<input type="submit" value="Save Rounds" class="thin">
							</form>
						</td>
					</tr>

%				} 

			</table>

%			if ($category->setting("exchange") ) { 

				<h4>Hired Judge Exchange</h4>

				<div class="half">

%				foreach my $request (@requests) { 

%					next unless $request->judge;

					<div class="row">
						<span class="threequarter">
							Hired <% $request->judge->first." ".$request->judge->last %> for <% $request->rounds_requested %> rounds
						</span>
						<span class="quarter">
							<a class="padmuchmore dkred" href="hire_cancel.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>&back=roster">
								CANCEL
							</a>
						</span>
					</div>

%				}

				</div>

%				my @judges = $m->comp("/funclib/exchange_judges.mas", category => $category);

%				if (@judges) { 
				<div class="half">
					<div class="even full nospace">
						<span class="threequarter">
							<% scalar @judges %> judge<% scalar @judges > 1 ? "s are" : " is" %> offering hired rounds     
						</span>
						<span class="quarter">
							<a class="dkblue padmuchmore" href="hire_exchange.mhtml?school_id=<% $school->id %>&category_id=<% $category->id %>">
								Add Hires
							</a>
						</span>
					</div>
				</div>
%				}


%			}

%			if ($category->setting("track_judge_hires") ) { 

				<br />

%				if ($category->setting("uncovered_entry_fee") > 0) { 

					<h4>Tournament Hired Judging</h4>

					<table>

%						foreach my $request (@requests) { 

%							next if $request->judge;
		            	
							<tr class="row">

								<td class="smallish">
									Request made <% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
								</td>
							
								<td class="centeralign smallish">
									<% $request->entries_accepted ? $request->entries_accepted : 0 %> accepted
								</td>
								
								<td class="centeralign smallish">
									<% $request->entries_requested %> requested
								</td>

%								my $warn = "This will reduce your judging request by 1.  Are you sure?";

								<td class="centeralign smallish">
									<a class="dkred button" <& "/funclib/confirm.mas", warn => $warn &> href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
										REDUCE
									</a>
								</td>

%								$warn = "This will delete your judging request entirely. Are you sure?";

								<td class="centeralign smallish">
									<a class="dkred button" <& "/funclib/confirm.mas", warn => $warn &> href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
										DELETE
									</a>
								</td>
							
							</tr>

%						}

%						unless ($judge_deadline < $now || $category_deadline < $now) {

							<tr class="row martop">
							
								<td>
									<form action="hire_save.mhtml" method="post">
									<input type="hidden" name="school_id" value="<% $school->id %>">
									<input type="hidden" name="category_id" value="<% $category->id %>">
									New Request:
								</td> 

								<td class="centeralign" colspan="2">
									Cover
									<input 
										type  = "number"
										min   = "0"
										max   = "99"
										name  = "hired_number"
										size  = "4"
										value = "">
									entries
								</td>
				
								<td 
									class="centeralign" 
									colspan="2">

									<input 
										class = "thin"
										type  = "submit"
										value = "Request Hires"
									>

									</form>
								</td>
							
							</tr> 
%						}
						

					</table>

					<p class="explain" style="padding-left: 10px;">
						This tournament hires judging by the entry, not the whole
						judge.  Enter hire requests for the number of entries who
						you do not have judging for.  Please note that a hire
						request does not mean the tournament has judges available
						for hire; Tabroom will email you when/if your request
						is accepted.
					</p>

%				}

%				if ($category->setting("hired_fee") > 0) { 

%       			my $hires_requested;
%       			my $hires_accepted;

%					foreach my $request (@requests) { 
%	    	   			$hires_requested += $request->entries_requested;
%   	    			$hires_accepted += $request->entries_accepted;
%					}

%       			$hires_requested = ceil($hires_requested / $judge_per) if $judge_per;
%       			$hires_accepted = ceil($hires_accepted / $judge_per) if $judge_per;
	
					<h4>Tournament Hired Judging</h4>

					<table>

%					foreach my $request (@requests) { 

%						next if $request->judge;
		            	
						<tr class="row">

							<td class="smallish">
								Request made <% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
							</td>
							
							<td class="centeralign smallish">
								<% $request->entries_accepted && $judge_per ? ceil($request->entries_accepted / $judge_per) : 0 %> accepted
							</td>
								
							<td class="centeralign smallish">
								<% ($judge_per ? ceil($request->entries_requested / $judge_per) : $request->entries_requested ) %> requested
							</td>

%							my $warn = "This will reduce your judging request by 1.  Are you sure?";

							<td class="centeralign smallish">
								<a class="dkred button" <& "/funclib/confirm.mas", warn => $warn &>  
										href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
									REDUCE
								</a>
							</td>

%							$warn = "This will delete your judging request entirely. Are you sure?";

							<td class="centeralign smallish">
								<a class="dkred button" <& "/funclib/confirm.mas", warn => $warn &>  
									href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
									DELETE
								</a>
							</td>
						
						</tr>

%					}

%					unless ($judge_deadline < $now || $category_deadline < $now) {

		            	<tr class="row martop">

 							<td>
                			    <form action="hire_save.mhtml" method="post">
            		    	    <input type="hidden" name="school_id" value="<% $school->id %>">
        		        	    <input type="hidden" name="category_id" value="<% $category->id %>">
    		            	    New Request:
            			    </td>

                			<td class="centeralign" colspan="2">
                			    <input type="number" name="hired_number" min="0" max="99" value=<% $hires_requested %>>
								hired judges
							</td>

                			<td class="rightalign" colspan="2">
                    			<input  type="submit" value="   Save   ">
                			    </form>
            			    </td>

    		        	</tr>

%					}

					</table>

%				}

%				if ($category->setting("round_hire_fee") > 0) { 

%					my @requests = Tab::JudgeHire->search( school => $school->id, category => $category->id );

%       			my $hires_requested;
%       			my $hires_accepted;

%					foreach my $request (@requests) { 
%	    	   			$hires_requested += $request->rounds_requested;
%   	    			$hires_accepted += $request->rounds_accepted;
%						$total_rounds += $request->rounds_accepted;
%					}
	
					<h4>Tournament Hired Judging</h4>

					<table>

%					foreach my $request (@requests) { 

%						next if $request->judge;
		            	
						<tr class="row">

							<td class=" smallish">
								Request made <% Tab::niceshortdt($request->requested_at->set_time_zone($tz)) %>
							</td>
							
							<td class="centeralign smallish <% $request->rounds_accepted < $request->rounds_requested ? "redtext" : "" %>">
								<% $request->rounds_accepted %> rounds accepted
							</td>
								
							<td class="centeralign smallish">
								<% $request->rounds_requested %> rounds requested
							</td>

%							my $warn = "This will reduce your judging request by 1 round.  Are you sure?";

							<td class="centeralign smallish">
								<a class="dkred button" <& "/funclib/confirm.mas", warn => $warn &>  href="hire_reduce.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
									REDUCE
								</a>
							</td>

%							$warn = "This will delete your judging request entirely. Are you sure?";

							<td class="centeralign smallish">
								<a class="dkred button" <& "/funclib/confirm.mas", warn => $warn &>  href="hire_delete.mhtml?school_id=<% $school->id %>&hire_id=<% $request->id %>">
									DELETE
								</a>
							</td>
						
						</tr>

%					}

%					unless ($judge_deadline < $now || $category_deadline < $now) {

		            	<tr class="row martop">

 							<td>
                			    <form action="hire_save.mhtml" method="post">
            		    	    <input type="hidden" name="school_id" value="<% $school->id %>">
        		        	    <input type="hidden" name="category_id" value="<% $category->id %>">
    		            	    New Request:
            			    </td>

                			<td class="centeralign" colspan="2">
                			    <input type="number" name="rounds" min="0" max="<% $unc %>" value=""> rounds
							</td>

                			<td class="rightalign" colspan="2">
                    			<input  type="submit" value="   Save   ">
                			    </form>
            			    </td>

    		        	</tr>

%					}

					</table>

%				}

%			}

			<br />
			<br />

%		} else { 

			<p>
				Choose a judge category at right to enter judges or hire out
				judging committments (where tournaments permit).
			<p>

			<p>
				Divisions marked in red are divisions where you still owe
				judging.
			</p>

%		}

%		if ($category && $category->setting('judge_policy') > 0) { 
			<h4 style="margin-left: 5px;"><% $category->abbr %> Judging notes:</h4>
			<p style="padding: 5px;"><% $category->setting("judge_policy") %></p>
%		}

	</div>

	<div class="menu">

		<div class="sidenote">

%			if ($category && ($judge_deadline > $now)) { 

%				my $category_deadline = $category->setting("deadline");
%				$category_deadline->set_time_zone($tz) if $category_deadline;
%				$category_deadline = $judge_deadline->clone unless $category_deadline;

%				unless ($category_deadline && $category_deadline < $now) {
        
					<h4>Add Judge</h4>

%					my @chapter_judges = $m->comp("/funclib/chapter_judges_free.mas", school => $school);
%				    my $now = DateTime->now;

%					if (@chapter_judges) { 

						<form action="judge_save.mhtml" method="post">
						<input type="hidden" name="category_id" value="<% $category->id %>">
						<input type="hidden" name="school_id" value="<% $school->id %>">

						<div class="row centeralign">
							<select name="chapter_judge_id" size="7" class="fixedmedsmall chosen" data-placeholder="Select judge...">
%								foreach my $chapter_judge (sort {$a->last cmp $b->last} @chapter_judges) { 
%									next if $used_judge{$chapter_judge->id}++;
									<option value="<% $chapter_judge->id %>"><% $chapter_judge->last.", ".$chapter_judge->first %></option>
%								}
							</select>
						</div>

						<div class="libl full rightalign padless marbottommore">
							<input type="submit" class="thin" value="Add Judge">
						</div>

						</form>

%					} else { 

						<p>
							You have no judges on your roster to add.  Please add
							them before registering them into the tournament.  You
							only need to type in each judge's name to your roster
							once; they'll be available for all future tournaments.
						</p>

%					}

					<a class="yellow full martop" href="/user/chapter/judge_edit.mhtml?from=<% $category->id %>&chapter_id=<% $school->chapter->id %>">
						Add Judge to Roster
					</a>

					<hr />
	
%				}
%			}

			<h4>Judge categories</h4>

%			foreach my $category (sort {$a->name cmp $b->name} @categories) {

<%perl>

				my $category_deadline = $category->setting("deadline");
				my $no_free = $category->setting("free_strikes_dont_count");

				$category_deadline->set_time_zone($tz) if $category_deadline;

				my ($unc, $over) = $m->comp("/funclib/judgemath/uncovered_burden_by_category.mas", 
						school   => $school,
						category => $category
				); 

				my @category_judges = $m->comp("/funclib/judgemath/judges_by_category.mas", 
						school   => $school,
						category => $category
				);

				my $obligation = $m->comp("/funclib/judgemath/judges_needed_by_category.mas", 
						school   => $school,
						category => $category
				);

				my $rounds;

				if ($rounds_per) { 
					foreach my $judge (@category_judges) { 
						$rounds += $judge->obligation 
							unless $no_free && $judge->setting("free_strike");
					}
				}

				my $status_mark;
				
				if ($unc > 0) { 

					$status_mark = "fa fa-times redtext fa-lg"; 
				
				} else { 
				
					$status_mark = "fa fa-check greentext fa-lg"; 
				}

</%perl>

				<a 
					class="blue full"
					href="judges.mhtml?school_id=<% $school->id %>&category_id=<% $category->id %>" 
				>

					<span class="nowrap threequarters">
						<% $category->name %>
					</span>

					<span class="eighth nospace">
						<% $rounds ? $rounds : scalar @category_judges %>/<% $obligation %>
						<% ($rounds) ? ($unc < 1 && ($rounds && $rounds < $obligation) ) ? "+ Hires" : "" : ($unc < 1 && scalar @category_judges < $obligation) ? "+ Hires " : "" %> 
					</span>

					<span class="eighth <% $status_mark %>">
					</span>
				</a>
	

%				if ($category_deadline) {
					<a href="/user/tourn/entry/judges.mhtml?school_id=<% $school->id %>&category_id=<% $category->id %>" class="white">
						**<% $category->abbr %> Judges due: <% &Tab::niceshortdt($category_deadline->set_time_zone($tz)) %>
					</a>

%				}

%			}

		</div>

	</div>

