<%args>
	$school_id
	$person
	$person_settings
	$perms
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);
	my $chapter = $school->chapter;
	my $tourn  = $school->tourn;

	my %event_by_id = map {$_->id => $_} ($tourn->events);

	my %district_entry = $m->comp(
		"/funclib/district_entry.mas", 
		chapter => $chapter 
	);

</%init>

	<& 
		"nsda_menu.mas", 
		school => $school,
		whoami => "doubleentry"
	&>

	<div class="main">

        <h2>
            <% $tourn->name %>
        </h2>

        <& tabbar.mas, 
			school => $school,
			whoami => "nsda" 
		&>

        <h4 class="martopmore padmuchmore">
			Single Entry Preferences
        </h4>

		<form 
			action="nsda_single_entry_save.mhtml" 
			method="post"
		>

		<input 
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

<%perl>

		my %already_entries = ();
		my %already_students = ();

		foreach my $student_id (sort keys %{$district_entry{"entries"}}) { 

			next unless ($district_entry{'student_count'}{$student_id} > 1);

			my $student;

			$student = $already_students{$student_id};

			unless ($student) { 
				$student = Tab::Student->retrieve($student_id);
				$already_students{$student_id} = $student;
			}

			my @entries;

			foreach my $entry_id ( @{$district_entry{"entries"}{$student_id}} ) { 

				my $entry;

				$entry = $already_entries{$entry_id};

				unless ($entry) { 
					$entry = Tab::Entry->retrieve($entry_id);
					$already_entries{$entry_id} = $entry;
				}

				push @entries, $entry;
				my $partner_string;

				foreach my $partner_id (@{$district_entry{"entry_students"}{$entry_id}} ) { 

					next if $partner_id == $student_id;

					my $partner;

					$partner = $already_students{$partner_id};

					unless ($partner) {
						$partner = Tab::Student->retrieve($partner_id);
						$already_students{$partner_id} = $partner;
					}

					unless ($partner_string) { 
						$partner_string = "Partner w/";
					} else { 
						$partner_string .= " &amp; "
					}

					$partner_string .= $partner->first." ".$partner->last;
				}

				$district_entry{"partner_string"}{$entry_id}{$student_id} = $partner_string;

			}

</%perl>

			<div class="lightrow">

				<span class="quarter">
					<% $student->first." ".$student->last %>
				</span>

				<span class="sixth">
					<% $district_entry{'student_total'}{$student_id} %> entries
				</span>

				<span class="sixth nospace">
%					foreach my $entry (@entries) { 
						<span 
							class="third hover padmore"
							title="<% $district_entry{"partner_string"}{$entry->id}{$student_id} %>"
						>
							<% $entry->event->abbr %>
						</span>
%					}
				</span>

				<span class="fourtenths nospace">

%					foreach my $slot (1 .. scalar @entries) { 

						<span class="third marno">

							<% $slot %>.
							<select 
								class='fixedtiny'
								name="<% $student->id %>-<% $slot %>"
							>

								<option value=""></option>

%							foreach my $entry (@entries) { 
								<option 
									value="<% $entry->id %>"
									<% $entry->setting("nsda_priority") == $slot ? 'selected="selected"' :  "" %>
								><% $entry->event->abbr %></option>
%							}

							</select>
				
						</span>
%					}

				</span>

			</div>


%		}

		<div class="full libl rightalign marno padtopmore">

			<input 
				type="submit" 
				value="Save Preferences"
			>

			</form>

		</div>

	</div>
