<%args>
	$school_id
	$person
	$person_settings
	$perms
</%args>
<%init>

	my $school = Tab::School->retrieve($school_id);
	my $chapter = $school->chapter;
	my $tourn  = $school->tourn;

	my %event_by_id = map {$_->id => $_} ($tourn->events() );

	my %district_entry = $m->comp(
		"/funclib/district_entry.mas", 
		chapter => $chapter 
	);

	my $blob = $school->setting("single_entry_letters");

	my %priorities = %{JSON::decode_json($blob)} if $blob;

</%init>

	<script>	

		$(document).ready(function() {
			$("#intentSave").submit(function() {
				$('select').removeAttr('disabled');
				console.log("What the hell is going on?");
			});

		});

		function disableSelected() { 

			$(".slotOptions").removeAttr("disabled");

			$(".slotselects").each(function() { 

				var selectID = $(this).val();

				if (selectID) { 
				
					var entryID = selectID.split('-')[0];
			
					var slotID = $(this).attr("slot");
					var studentID = $(this).attr("student");

					// Disable that option 
					$("."+studentID+"-"+entryID).attr("disabled", true);
					$("#"+studentID+"-"+entryID+"-"+slotID).removeAttr("disabled");

				};

			});

		};

		$(document).ready(function() {
			disableSelected();
		});

	</script>

	<& 
		"nsda_menu.mas", 
		school => $school,
		whoami => "doubleentry"
	&>

	<div class="main">

        <& "tabbar.mas",
			school => $school,
			whoami => "nsda" 
		&>

        <h4 class="martopmore padmuchmore">
			Single Entry Preferences
        </h4>

		<span class="threequarters">
			<p>
				Schools should still  bring a signed Single Entry Letter of Intent
				for each double entered individual to their District Tournament.
			</p>
		</span>

		<span class="quarter centeralign">
			<a 
				class="buttonwhite bluetext invert"
				href="https://www.speechanddebate.org/wp-content/uploads/District-Tournament-Single-Entry-Letter-of-Intent.pdf"
			>Download Form</a>
		</span>

		<form 
			id     = "intentSave"
			action = "nsda_single_entry_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

<%perl>

		my %student_entries = ();
		my %student_partners = ();

		my @student_ids = sort keys %{$district_entry{"entries"}};

		@student_ids = 
			sort { $district_entry{'entries'}{$b} <=> $district_entry{'entries'}{$a} } 
			@student_ids;

		foreach my $student_id (@student_ids) { 

			foreach my $entry_id ( @{$district_entry{"entries"}{$student_id}} ) { 

				push @{$student_entries{$student_id}}, $entry_id;
				my $partner_string;

				foreach my $partner_id (@{$district_entry{"entry_students"}{$entry_id}} ) { 

					next if $partner_id == $student_id;

					push @{$student_partners{$student_id}}, $partner_id;
					$student_partners{"entry"}{$student_id}{$partner_id} = $entry_id;

					unless ($partner_string) { 
						$partner_string = "Partner w/";
					} else { 
						$partner_string .= " &amp; "
					}

					$partner_string .= $district_entry{"first_name"}{$partner_id}." ".$district_entry{"last_name"}{$partner_id};

				}

				$district_entry{"partner_string"}{$entry_id}{$student_id} = $partner_string;

			}

		}

		my %event_mix = ();

		foreach my $student_id (@student_ids) { 

			foreach my $entry_id (@{$student_entries{$student_id}}) { 

				if (scalar (@{$district_entry{"entry_students"}{$entry_id}}) == 2) {

					$event_mix{$student_id}{"partnerships"}++;

				} else { 

					$event_mix{$student_id}{"individuals"}++;

				}

			}

		}

		my %forced_choices = ();

		foreach my $student_id (@student_ids) { 

			# Do I have any team events?  That's the only way I would face a
			# forced choice.

			if ($event_mix{$student_id}{"partnerships"} > 0)  { 

				# Do I also have individual event entries?

				if ($event_mix{$student_id}{"individuals"} > 0)  { 
						

					# Does my partner also have an individual event?  
					# If yes, you can choose either way. 
					# If no, then you must choose the partnership event.

					my $live_free;

					foreach my $partner_id (@{$student_partners{$student_id}}) { 

						if ($event_mix{$partner_id}{"individuals"} > 0)  { 
							$live_free++;
						} 
					
						# However, both must choose the same way
						
						if ($live_free && ($student_id < $partner_id)) { 
						
							my $partner_picked;
						
							foreach my $entry_id (@{$student_entries{$student_id}}) { 
							
								if (scalar (@{$district_entry{"entry_students"}{$entry_id}}) > 1) { 
									$partner_picked = $priorities{$student_id}{$entry_id};
								}
							}

							if ($partner_picked) { 

								my $priority_picked = 2;

								foreach my $entry_id (
									sort {$priorities{$partner_id}{$a} <=> $priorities{$partner_id}{$b} }
									@{$student_entries{$partner_id}}
								) { 
								
									if (scalar (@{$district_entry{"entry_students"}{$entry_id}}) > 1) { 

										$priorities{$partner_id}{$entry_id} = $partner_picked;

									} else { 

										my $picked = $partner_picked - 1;

										if ($picked < 1) { 
											$picked = $priority_picked++;
										}

										$priorities{$partner_id}{$entry_id} = $picked;
									}

									$forced_choices{$partner_id}++;
								}
							}
						}

					}

					unless ($live_free) {


						$forced_choices{$student_id}++;

						foreach my $entry_id (@{$student_entries{$student_id}}) { 

							if (scalar (@{$district_entry{"entry_students"}{$entry_id}}) == 1) { 

								$priorities{$student_id}{$entry_id} = 2;

							} else { 

								$priorities{$student_id}{$entry_id} = 1;
							}
						}
					}

				} else { 

					# I have no individual entries.  So I get linked choices
					# with my partner

					my %seen;

					@{$student_partners{$student_id}} = 
						grep { ! $seen{$_} ++ } 
						@{$student_partners{$student_id}};
					
					if (scalar @{$student_partners{$student_id}} == 1) { 

						# I only have one partner which means I just lock the 2nd set of
						# preferences

						my $partner_id = ${$student_partners{$student_id}}[0];

						if ($student_id > $partner_id) { 
							$forced_choices{$student_id}++;
						}

					} else { 

						# If I have two different partners, then the later
						# weekend takes precedence always. 

						my $later_entry;
						my $former_entry;

						foreach my $partner_id (@{$student_partners{$student_id}}) { 

							my $this_entry = $student_partners{"entry"}{$student_id}{$partner_id};

							if ($later_entry) { 

								my $this_date = $district_entry{"entry_time"}{$this_entry};
								my $later_date = $district_entry{"entry_time"}{$later_entry};

								if ($this_date > $later_date) { 
									$former_entry = $later_entry;
									$later_entry = $this_entry;
								}
								
							} else { 
								
								$later_entry = $this_entry;

							}

						}

						$priorities{$student_id}{$later_entry} = 1;
						$priorities{$student_id}{$former_entry} = 2;

						$forced_choices{$student_id}++;

					}

				}

			}

		}

		@student_ids = 
			sort { $district_entry{'first_name'}{$a} 
					cmp $district_entry{'first_name'}{$b} 
				} @student_ids;

		@student_ids = 
			sort { $district_entry{'last_name'}{$a} 
					cmp $district_entry{'last_name'}{$b} 
				} @student_ids;

		@student_ids = 
			sort { $district_entry{'student_total'}{$b} 
					<=> $district_entry{'student_total'}{$a} 
				} @student_ids;

		foreach my $student_id (@student_ids) { 

</%perl>

			<div class="small row">

				<span class="fifth bluetext semibold">
					<% $district_entry{"first_name"}{$student_id} %>
					<% $district_entry{"last_name"}{$student_id} %>
				</span>

				<span class="fifth nospace">

					<div class="full marno">
						<% $district_entry{'student_total'}{$student_id} %> entries:
					</div>

					<div class="full nospace">
%						foreach my $entry_id (@{$student_entries{$student_id}}) { 
							<span 
								class="third hover marno semibold"
								title="<% $district_entry{"partner_string"}{$entry_id}{$student_id} %>"
							>
								<% $district_entry{"entry_event_abbr"}{$entry_id} %>
							</span>
%						}
					</div>

				</span>

				<span class="threefifths marno">

%					my $count = scalar  @{$student_entries{$student_id}} + 1;
%					my $first++ if scalar @{$student_entries{$student_id}} == 1;

%					foreach my $slot (1 .. $count) { 

						<span class="fifth marno">
							<% $slot %>.
							<select 
								id       = "<% $student_id %>-<% $slot %>"
								student  = "<% $student_id %>"
								slot     = "<% $slot %>"
								class    = "fixedtiny plain slotselects"
								name     = "<% $student_id %>-<% $slot %>"
								onChange = "disableSelected(this);";
								<% $slot == 1 && $forced_choices{$student_id} 
									? 'disabled="true"' 
									: ""
								%>
							>

								<option value=""></option>

%								foreach my $entry_id (@{$student_entries{$student_id}}) { 

									<option 
										id      = "<% $student_id %>-<% $entry_id %>-<% $slot %>"
										class   = "slotOptions <% $student_id %>-<% $entry_id %>"
										value   = "<% $entry_id %>"
										<% ($priorities{$student_id}{$entry_id} eq $slot)
											|| $first && $slot == 1
											? 'selected="selected"' 
											:  ""
										%>
									> <% $district_entry{"entry_event_abbr"}{$entry_id} %> </option>
%								}

								<option 
									id      = "<% $student_id %>-WS-<% $slot %>"
									value   = "WS"
									class   = "WS slotOptions <% $student_id %>-WS"
									<% ($priorities{$student_id}{"WS"} eq $slot)
										? 'selected="selected"' 
										:  ""
									%>
								>World Schools</option>

							</select>
				
						</span>
%					}

%					if ($forced_choices{$student_id}) { 
						<span class="fifth redtext"
							title="Choices are locked because of partnership rules"
						>
							<span class="fa fa-lock fa-lg redtext"></span>
							Locked to partner
						</span>
%					}

				</span>

			</div>

%		}

		<div class="liblrow rightalign">

			<input 
				type    = "submit"
				value   = "Save Preferences"
			>

			</form>

		</div>

	</div>
