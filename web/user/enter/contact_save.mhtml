<%args>
	$school_id
	$contact_name   => undef
	$contact_number => undef
	$contact_email  => undef
	$school_code    => undef
	$refund_payable => undef
	$refund_address => undef
	$individuals    => undef
	$coaches        => undef
	$tbook_coaches  => undef
	$onsite         => undef
</%args>
<%perl>

	my $school = Tab::School->retrieve($school_id);
	my $tourn = $school->tourn;
	my $other = Tab::School->search( tourn => $tourn->id, code => $school_code)->first;

	undef ($other) if $other && $other->id == $school_id;

	$school->setting("contact_name", $contact_name);
	$school->setting("contact_number", $contact_number);
	$school->setting("contact_email", $contact_email);
	$school->setting("individuals", $individuals);
	$school->chapter->setting("coaches", $coaches);
	$school->setting("tbook_coaches", $tbook_coaches);
	$school->setting("second_contact_number", $ARGS{"second_contact_number"});

	# Middle School 
	$school->setting("contact_hotel", $ARGS{"contact_hotel"});
	$school->setting("hotel", $ARGS{"hotel"});
	$school->setting("contact_hotel_rooms", $ARGS{"contact_hotel_rooms"});

	$school->setting("hotel", $ARGS{"hotel"});

	if ($ARGS{"contact_hotel_checkout"}) { 

		my $dt;
		my $tz = $tourn->tz;
		$tz = "UTC" unless $tz;

		my $time = "00:00:00";

		eval {
			$dt = Tab::dtme($ARGS{"contact_hotel_checkout"}, $time, $tz);
		};

		$school->setting("contact_hotel_checkout", "date", $dt) if $dt;
	}

	my %contacts; 

	foreach my $category ($m->comp("/funclib/school_categories.mas", school => $school)) { 
		$contacts{$category->id}{"name"}  = $ARGS{$category->id."_name"};
		$contacts{$category->id}{"email"} = $ARGS{$category->id."_email"};
		$contacts{$category->id}{"phone"} = $ARGS{$category->id."_phone"};
		$contacts{$category->id}{"phone"} =~ s/[\D_]//g;
	}

	my $encoded = eval{ 
		return JSON::encode_json(\%contacts);
	};

	$school->setting('category_contacts', "text", $encoded);

	$school->setting("refund_method", $ARGS{"refund_method"});
	$school->setting("refund_judge_bond", $ARGS{"refund_judge_bond"});
	$school->setting("refund_payable", "text", $refund_payable) if $refund_payable;
	$school->setting("refund_address", "text", $refund_address) if $refund_address;
	$school->setting("refund_payable", 0) unless $refund_payable;
	$school->setting("refund_address", 0) unless $refund_address;

	if ($tourn->setting("school_codes") eq "registrant" && $school_code) { 
		$school->code(substr($school_code, 0, 6)) unless $other;
	}

	$school->update;	

	my $err = "School code $school_code taken; please choose a unique code" if $other;

	$m->redirect("/user/enter/onsite.mhtml?school_id=".$school->id."?err=$err") if $onsite;

	$m->redirect("/user/enter/entry.mhtml?school_id=".$school->id."?err=$err");

</%perl>
