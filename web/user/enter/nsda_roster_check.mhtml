<%args>
	$person
	$session
	$school
	$tourn
	$disclaimed => undef
</%args>
<%init>

	use POSIX;

	my %tourn_settings = $tourn->all_settings;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now(time_zone => $tz);

	my %school_settings = $school->all_settings;

	if ($tourn_settings{"disclaimer"}) { 

		if ($disclaimed) { 

			$school->setting("disclaimed", $person->id);
			$school->setting("disclaimed_at", "date", $now);

		} elsif ($school_settings{"disclaimed"}) { 

		} else { 

			$m->redirect("disclaimer.mhtml?school_id=".$school->id) 
		}

	}

	my $chapter = $school->chapter;

	my %student_settings = $m->comp(
		"/funclib/chapter_student_settings.mas",
		chapter => $chapter
	);

</%init>

	<div class="main">

		<h4>
			Districts Competitor Eligibility
		</h4>

		<span class="fivesixths semibold italic linemore">
			Competitors must be a paid member, with 25 or more points &amp; an
			email address on file.
		</span>

		<span 
			class = "sixth rightalign"
			id    = "status_sortable_buttonarea"
		></span>

		<& 
			"/funclib/tablesorter.mas", 
			table => "status_sortable"
		&>

		<table id="status_sortable">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						Grad Year
					</th>

					<th>
						Merit #
					</th>

					<th>
						25+ pts
					</th>

					<th>
						Paid
					</th>

					<th>
						Email
					</th>

					<th>
						Eligible?
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $student ($chapter->students( retired => 0 )) { 
		
					<tr>

						<td>
							<% $student->first %>
						</td>

						<td>
							<% $student->last %>
						</td>

						<td>
							<% $student->grad_year %>
						</td>

						<td>
							<% $student->ualt_id %>
						</td>

						<td class="centeralign">

							<% $student_settings{$student->id}{"nsda_points"} %>

							<p class="hiddencsv">
								<% $student_settings{$student->id}{"nsda_points"} > 24 ? "Y - " : "N - " %>
							</p>

							<span class="fa fa-lg <%
								$student_settings{$student->id}{"nsda_points"} > 24 
								? "fa-check greentext"
								: "fa-times redtext"
							%>"></span>

						</td>

						<td class="centeralign">

							<p class="hiddencsv">
								<% $student_settings{$student->id}{"nsda_paid"} ? "Y" : "N" %>
							</p>

							<span class="fa fa-lg <%
								$student_settings{$student->id}{"nsda_paid"}
								? "fa-check greentext"
								: "fa-times redtext"
							%>"></span>

						</td>

						<td class="centeralign">

							<p class="hiddencsv">
								<% $student_settings{$student->id}{"student_email"} ? "Y" : "N" %>
							</p>

							<span class="fa fa-lg <%
								$student_settings{$student->id}{"student_email"}
								? "fa-check greentext"
								: "fa-times redtext"
							%>"></span>

						</td>

						<td class="centeralign">

							<p class="hiddencsv"><%
								$student_settings{$student->id}{"student_email"}
								&& $student_settings{$student->id}{"nsda_paid"}
								&& $student_settings{$student->id}{"nsda_points"} > 24 
								? "Y"
								: "N"
							%></p>

							<span class="fa fa-2x <%
								$student_settings{$student->id}{"student_email"}
								&& $student_settings{$student->id}{"nsda_paid"}
								&& $student_settings{$student->id}{"nsda_points"} > 24 
								? "fa-check-square-o greentext"
								: "fa-times-circle-o redtext"
							%>"></span>
						</td>

					</tr>

%				}

			</tbody>

		</table>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h5>NSDA Membership</h5>

			<a 
				class  = "buttonwhite greentext centeralign block bigger padless martopmore"
				target = "_blank"
				href   = "https://www.speechanddebate.org/account/"
			>Check Your NSDA Account</a>

			<a 
				class      = "buttonwhite greentext centeralign block bigger padless martopmore"
				target_id  = "<% $chapter->id %>"
				on_success = "refresh"
				onClick    = "postSwitch(this, '/funclib/chapter_nsda_sync.mas');"
			>Sync Roster with NSDA</a>

			<a 
				class = "buttonblue centeralign block bigger padless martopmore"
				href  = "/user/enter/entry.mhtml?school_id=<% $school->id %>"
			>Continue to registration</a>

		</div>

	</div>

