<%args>
	$person
	$school
</%args>
<%init>

	use POSIX;

	my $tourn = $school->tourn;
	my %tourn_settings = $tourn->all_settings;

	my $hide_codes++ if $tourn_settings{"hide_codes"};

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now(time_zone => $tz);

	my $adult;

	my %school_settings = $school->all_settings();

	$adult++ if ($school_settings{"contact_number"} 
		&& $school_settings{"contact_name"} 
		&& $school_settings{"contact_email"});

	$adult++ unless $tourn_settings{"require_adult_contact"};  #not required so don't complain

	my $payup++ if $tourn_settings{"onsite_only_paid"};

	my $fee;
	my $feline_ref;
	my $total_ref;

	if ($payup) { 

		($fee, $feline_ref, $total_ref) = $m->comp(
			"/funclib/school_fees.mas", 
			school => $school,
			all    => 1
		);

		if ($fee > 0) { 
			$fee = sprintf ("%.2f", $fee);
			my $symbol = $tourn_settings{'currency'};
			$symbol = '$' unless $symbol;
			$fee = $symbol.$fee;
		} else { 
			undef $fee;
		}
	}

</%init>

	<div class="main">

		<& tabbar.mas, school => $school, whoami => "onsite" &>

%		if ($fee) { 

			<h5 class="centeralign martopmore">
				You are not eligible to register online
			</h5>

			<h6 class="martop centeralign">
				You have an outstanding registration balance of <% $fee %>,
				and the tournament is accepting onsite confirmation only from
				paid entrants.
			</h6>

			<h6 class="centeralign"> 
				Please go to in-person registration or contact the tournament
				to proceed. 
			</h6>

%		} else { 

%			if (not defined $adult) { 

				<h5>This tournament requires an adult contact</h5>

				<p>
					Before you can register further, you must supply the name and phone
					number for the responsible adult who is attending the tournament.
				</p>

%			} 

%			if ($school->onsite) { 

				<h5>Your registration has been confirmed.</h5>

%				if ($school_settings{"registered_by"}) { 
%					my $regged = Tab::Person->retrieve($school_settings{"registered_by"});
					<div class="row borderbottom">
						<span class="quarter semibold redtext">
							Confirmed by:
						</span>
						<span class="threeeighths marno">
							<% $regged->first." ".$regged->last %> 
						</span>
						<span class="threeeighths">
							<a href="mailto:<% $regged->email %>" class="plain hover full">
								(<% $regged->email %>)
							</a>
						</span>
					</div>
%				}

%				my $registered_on = $school_settings{"registered_on"};

%				if ($registered_on) { 
					<div class="row borderbottom">
						<span class="quarter semibold redtext padvertmore">
							Confirmed on:
						</span>
						<span class="threequarter marno">
							<% Tab::nicedt($registered_on->set_time_zone($tz)) %>
						</span>
					</div>
%				}

%				if ($tourn_settings{"onsite_notes"}) { 
					<h5>Tournament Announcements:</h5>
					<p>
						<% $tourn_settings{"onsite_notes"} %>
					</p>
%				}
% 		   	    if ($tourn_settings{"registration_packet"}) { 
					<h5 class="martop">Reference and tournament materials:</h5>

					<div class="centeralign">
						<a 
							class="buttonwhite bluetext bigger"
							href="<% $Tab::s3_url %>/<% $tourn->id %>/<% $tourn_settings{"registration_packet"} %>"
						>
							<h5>Download Registration Packet</h5>
						</a>
					</div>
%       	   	}   

%			} else { 

%				if ($tourn_settings{"onsite_notes"}) { 
					<h5>Tournament Announcements:</h5>
					<p>
						<% $tourn_settings{"onsite_notes"} %>
					</p>
%				}
% 		   	    if ($tourn_settings{"registration_packet"}) { 
					<h5 class="martop">Reference and tournament materials:</h5>

					<div class="centeralign">
						<a 
							class="buttonwhite bluetext bigger"
							href="<% $Tab::s3_url %>/<% $tourn->id %>/<% $tourn_settings{"registration_packet"} %>"
						>
							<h5>Download Registration Packet</h5>
						</a>
					</div>
%       	   	}   

				<h5>Adult Contact</h5>

				<form action="contact_save.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>
				<input 
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>
				<input 
					type  = "hidden"
					name  = "onsite"
					value = "1"
				>

				<div class="row">

					<span class="half">
						Responsible Adult
					</span>

					<span class="half">
						<input 
							size  = "25"
							type  = "text"
							name  = "contact_name"
							value = "<% $school_settings{"contact_name"} %>"
						>
					</span>

				</div>

				<div class="row">

					<span class="half">
						Phone
					</span>
					
					<span class="half">
						<input 
							size  = "25"
							type  = "tel"
							name  = "contact_number"
							value = "<% $school_settings{"contact_number"} %>"
						>
					</span>

				</div>

				<div class="row">

					<span class="half">
						Email
					</span>
					
					<span class="half">
						<input 
							size  = "25"
							type  = "email"
							name  = "contact_email"
							value = "<% $school_settings{"contact_email"} %>"
						>
					</span>

				</div>

				<div class="libl rightalign padvertless">
					<input  
						type="submit" 
						value="Save Contact Info"
					>
					</form>
				</div>

<%perl>

				my $drop_deadline = $tourn_settings{"drop_deadline"};
				$drop_deadline = $tourn->reg_end unless $drop_deadline;
				$drop_deadline->set_time_zone($tz);

				my $judge_deadline = $tourn_settings{"judge_deadline"};
				$judge_deadline = $tourn->reg_end unless $judge_deadline;
				$judge_deadline->set_time_zone($tz);

				my @already_entered = Tab::Entry->search( 
					school   => $school->id,
					waitlist => 0,
				);

				my @hybrides = $m->comp("/funclib/school_hybrids.mas", school => $school);
				my $hybrids++ if @hybrides;

				push (@already_entered, @hybrides); 

				my %seen = (); 
				@already_entered = grep { ! $seen{$_->id} ++ } @already_entered;

</%perl>

				<h5>Entries</h5>

					<table class="smallish">

						<tr class="yellow">

							<th class="smallish">
								Code
							</th>

							<th class="smallish">
								Name
							</th>

							<th class="smallish">
								Event
							</th>

							<th colspan="3">
							</th>

						</tr>

<%perl>

		 				foreach my $already (@already_entered) { 

							my $other;

							if ($hybrids) { 
								foreach my $student ($already->students) { 
									next if $student->chapter->id == $school->chapter->id;
									$other = Tab::School->search( 
										chapter => $student->chapter->id,
										tourn   => $tourn->id
									)->first;
								}
							}

</%perl>
							<tr class="row">
					
								<td class="leftalign">
									<% $already->dropped ? "DROP" : $hide_codes ? "" : $already->code %>
								</td>

								<td class="leftalign <% $already->dropped ? "strike" : "" %> nowrap"> 
									<% $already->name %>
								</td>

								<td class="leftalign nowrap">
									<% $already->event->abbr %>
								</td>

								<td>
%									if ($already->event->setting("apda")) { 
										<span class="inline white padno">
											<a 
												class="white padless" 
												href="details.mhtml?entry_id=<% $already->id %>&school_id=<% $school->id %>">
												<% $already->setting("registered_seed") 
													? ucfirst($already->setting("registered_seed")) 
													: "No"  %> seed
											</a>
										</span>
%									}

%									if ($other) { 
										<span class="inline white">
										<% $other->short_name %> Hybrid		
										</span>
%									}

%									if ($already->ada) { 
										ADA/Access*
%									}

								</td>

%								if ($now < $judge_deadline) { 

%									unless ($already->dropped) {

%										my $warn = "Are you sure you want to drop that judge?";
								
										<td class="centeralign nospace padless">
											<a class="buttonwhite bluetext fa fa-lg fa-edit"
												href="details.mhtml?school_id=<% $school->id %>&entry_id=<% $already->id %>&from=onsite">
											</a>
										</td>

										<td class="centeralign nospace padless">
											<a class="buttonwhite redtext fa fa-lg fa-trash"
												<& "/funclib/confirm.mas", warn => $warn &> 
												href="entry_drop.mhtml?school_id=<% $school->id %>&entry_id=<% $already->id %>&from=onsite">
											</a>
										</td>
%									}

%								}  else { 
									<td class="centeralign smallish">
										Contact the tournament to change/drop entries.
									</td>
%								}

							</tr>

%		 				} #end of foreach my already

					</table>
				
				<h5>Judges</h5>

				<table>

					<tr class="yellow">

						<th class="smallish">
							Code
						</th>
	
						<th class="smallish">
							Name
						</th>

						<th class="smallish">
							Division
						</th>

						<th class="smallish">
							Notes
						</th>

						<th></th>

					</tr>

%					foreach my $judge ($school->judges) { 
						
						<tr class="row">

							<td>
								<% $judge->code %>
							</td>

							<td>
								<% $judge->first." ".$judge->last %>
							</td>

							<td>
								<% $judge->category->abbr %> 
							</td>

							<td>
<%perl>
		 			          	foreach my $strike (
									sort {$a->type cmp $b->type} 
									$judge->strikes(conflictee => 1)
								) { 
</%perl>
									<% $m->comp("/funclib/strike_name.mas", strike => $strike) %>
%		          				 }   
								<% $judge->setting('notes') %>
								<% $judge->setting('special_job') %>
							</td>
							
							<td class="centeralign nospace padless">
%								if ($now < $drop_deadline) { 
%									my $warn = "Are you sure you want to drop that entry?";
								
									<a 
										class="buttonwhite redtext fa fa-lg fa-trash"
										href="judge_drop.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>&from=onsite"
										<& "/funclib/confirm.mas", warn => $warn &> 
									></a>
%								}
							</td>

						</tr>

%					}
				
				</table>

				<h6 class="martopmore bluetext">
					Do you solemnly swear the above is correct and everyone is
					on site?
				</h6>

				<div class="libl rightalign padvertless">

					<form action="onsite_confirm.mhtml" method="post">
						<input 
							type  = "hidden"
							name  = "school_id"
							value = "<% $school->id %>"
						>
						<input 
							type  = "submit"
							value = "Yes I do.  Register Me!"
						>
					</form>
				</div>

%			}
%		}

	</div>

	<div class="menu">
	
		<div class="sidenote">

			<h5>Onsite registration</h5>

			<p>
				Please only register once you have arrived at the tournament
				location and can confirm all your entries and judges.  Confirming
				inaccurate entries can seriously harm a tournament's operations
			</p>

%			if ($payup) { 
				<p>
					You may only register online if you have paid in full ahead of
					time.  Otherwise consult the tournament website or invitation
					for where you should register and provide payment. 
				</p>
%			}

		</div>
	</div>
