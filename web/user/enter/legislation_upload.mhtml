<%args>
	$person
	$school
	$tick
</%args>
<%init>

	my $tourn = $school->tourn;
	my $msg;

	my $now = DateTime->now();

    if ($ARGS{"legislation_".$tick}) {

		my $req = Apache2::Request->new($r);
		my $upload = $req->upload("legislation_".$tick);
		my $filename  = $upload->filename;

		$filename =~ s/[^\w.]//g;
		$filename =~ s/\.(?=.*\.)//g;
		$filename =~ s/\s//g;

		my $filetemp = $upload->tempname;

		my $label = $ARGS{"label"};
		$label = $filename unless $label;

		my $file = Tab::File->create({
			event    => $ARGS{"event_id"},
			school   => $school->id,
			tourn    => $tourn->id,
			filename => $filename,
			label    => $label,
			type     => "legislation",
			uploaded => $now,
		});

		system $Tab::s3_cmd." put $filetemp ".$Tab::s3_bucket."/tourns/".$tourn->id."/legislation/".$file->id."/".$filename;

		$msg .= "<br />" if $msg;
		$msg .= "Legislation $label uploaded";

	}   

	$m->redirect("legislation.mhtml?school_id=".$school->id."&msg=$msg");

</%init>

