<%args>
	$session
	$school
	$person
	$person_settings
</%args>
<%init>

	my $tourn = $school->tourn;
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	Tab::Event->set_sql(legislation_events => "
		select event.*
		from event, event_setting
		where event.tourn = ? 
		and event.id = event_setting.event
		and event_setting.tag = 'upload_legislation'
		and exists (
			select entry.id
			from entry
			where entry.school = ? 
			and entry.event = event.id
		)"
	);

	my @legislation = Tab::Event->search_legislation_events(
		$tourn->id,
		$school->id
	);

</%init>

	<div class="main">

	<& "tabbar.mas", 
		school => $school,
		whoami => "legislation"
	&>

	<h4>Submit Legislation</h4>

	<div class="full semibold bluetext">
		<% $tourn->setting("legislation_message") %>
	</div>

<%perl>

	foreach my $event (@legislation) { 

		my $limit = $event->setting("legislation_cap");
		my $counter;

		my @bills = $school->files(
			type  => "legislation",
			event => $event->id
		);

		unless ($limit) { 
			$limit = (scalar @bills) + 1;
		}

		foreach my $tick (1 .. $limit) { 

			my $existing = shift @bills if @bills;

			if ($existing) { 

</%perl>
				
				<div class="row full marno">

					<span class="twentieth strong">
						<% $tick %>.
					</span>

					<span class="half">
						<a 
							class = "bluetext full hover"
							href  = "<% $Tab::s3_url %>/<% $tourn->id."/legislation/".$existing->id."/".$existing->filename %>">
							<% $existing->label %>
						</a>
					</span>

					<span class="sixth rightalign">
						Submitted:
					</span>

					<span class="sixth nospace">

						<span class="half">
							<% Tab::shortdate($existing->uploaded->set_time_zone($tz)) %>
						</span>

						<span class="half">
							<% Tab::shorttime($existing->uploaded->set_time_zone($tz)) %>
						</span>

					</span>

					<span class="eighth rightalign">
						<a
							class = "redtext buttonwhite fa fa-lg fa-trash"
							href  = "legislation_rm.mhtml?school_id=<% $school->id %>&file_id=<% $existing->id %>"
						></a>
					</span>

				</div>

%			} else { 

				<form 
					enctype  = "multipart/form-data"
					onsubmit = "return uploadThis()"
					name     = "legislation"
					action   = "legislation_upload.mhtml"
					method   = "post"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>" 
				>

				<input 
					type  = "hidden"
					name  = "event_id"
					value = "<% $event->id %>" 
				>

				<input 
					type  = "hidden"
					name  = "tick"
					value = "<% $tick %>" 
				>

				<div class="row full marno">

					<span class="twentieth strong">
						<% $tick %>.
					</span>

					<span class="half">
						<input 
							type        = "text"
							name        = "label"
							size        = "48"
							placeholder = "Title or label"
						>
					</span>

					<span class="third centeralign">

						<div class="uploader">

							<input 
								type     = "file"
								name     = "legislation_<% $tick %>"
								style    = "opacity: 0;"
								onchange = "uploaderName(
									'legislation_<% $tick %>',
									'legislation_<% $tick %>_file'
								)"
								id       = "legislation_<% $tick %>"
							>

							<span 
								id  = "legislation_<% $tick %>_file"
								class = "filename"
								style = "-webkit-user-select: none;"
							>No file selected</span>

							<span 
								class = "action"
								style = "-webkit-user-select: none;"
							>Choose File</span>
						</div>

					</span>

					<span class="eighth rightalign">
						<input 
							type  = "submit"
							class = "thin"
							value = "Submit"
						>
					</span>

				</div>

				</form>

%			}

%		}

%	}

	</div>

