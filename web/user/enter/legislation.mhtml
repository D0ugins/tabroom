<%args>
	$session
	$school
	$person
	$person_settings
</%args>
<%init>

	my $tourn = $school->tourn;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	Tab::Event->set_sql(legislation_events => "
		select event.*
		from event, event_setting
		where event.tourn = ? 
		and event.id = event_setting.event
		and event_setting.tag = 'upload_legislation'
		and exists (
			select entry.id
			from entry
			where entry.school = ? 
			and entry.event = event.id
			and (entry.active = 1 OR entry.waitlist = 1)
		)"
	);

	my @legislation = Tab::Event->search_legislation_events(
		$tourn->id,
		$school->id
	);

</%init>

	<div class="main">

	<& "tabbar.mas", 
		school => $school,
		whoami => "legislation"
	&>


<%perl>

	my %settings;

	foreach my $event (@legislation) { 

		my %event_settings = $event->all_settings();

		$settings{$event->id} = \%event_settings;

		my $limit = $event_settings{"legislation_cap"};

		my $counter;

		my @bills = $school->files(
			type  => "legislation",
			event => $event->id
		);

		unless ($limit) { 
			$limit = (scalar @bills) + 1;
		}

		my %bill_categories = eval {
			return %{ JSON::decode_json($event_settings{"bill_categories"})};
		};



</%perl>

		<h5>Legislation in <% $event->name %></h5>

		<p>

%		if ($event_settings{"bill_deadline"}) { 
			All legislation must be submitted by 
			<span class="semibold redtext inline">
				<& "/funclib/showdate.mas",
					dt     => $event_settings{"bill_deadline"},
					tz     => $tz,
					length => "medium"
				&>

				at 
				<& "/funclib/showtime.mas",
					dt      => $event_settings{"bill_deadline"},
					tz      => $tz,
					tz_name => 1,
					length  => "medium"
				&>
			</span>.
%		}

%		if ($event_settings{"bill_author_required"}) { 
			Each submission <span class="semibold inline redtext">must</span> have an
			entry listed as author.
%		}

%		if ($event_settings{"bill_category_required"}) { 
			Each submission <span class="semibold inline redtext">must</span> fall within
			one of the categories listed.
%		}

%		if ($event_settings{"bill_category_cap"}) { 
			Each school may submit no more than <span class="semibold inline redtext"><% $event_settings{"bill_category_cap"} %> piece of legislation per category</span> 
%		}

%		if ($event_settings{"bill_category"}) { 
%		}

<%perl>
		foreach my $tick (1 .. $limit) { 

			my $existing = shift @bills if @bills;
			if ($existing) { 
</%perl>
				
				<div class="row full marno">

					<span class="twentieth semibold bluetext">
						<% $tick %>.
					</span>

					<span class="half">
						<a 
							class = "bluetext full hover"
							href  = "<% $Tab::s3_url %>/<% $tourn->id."/legislation/".$existing->id."/".$existing->filename %>">
							<% $existing->label %>
						</a>
					</span>

					<span class="sixth rightalign">
						Submitted:
					</span>

					<span class="sixth nospace">

						<span class="half">
							<% Tab::shortdate($existing->uploaded->set_time_zone($tz)) %>
						</span>

						<span class="half">
							<% Tab::shorttime($existing->uploaded->set_time_zone($tz)) %>
						</span>

					</span>

					<span class="eighth rightalign">
						<a
							class = "redtext buttonwhite fa fa-lg fa-trash"
							href  = "legislation_rm.mhtml?school_id=<% $school->id %>&file_id=<% $existing->id %>"
						></a>
					</span>

				</div>

%			} else { 

				<form 
					enctype  = "multipart/form-data"
					onsubmit = "return uploadThis()"
					name     = "legislation"
					action   = "legislation_upload.mhtml"
					method   = "post"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>" 
				>

				<input 
					type  = "hidden"
					name  = "event_id"
					value = "<% $event->id %>" 
				>

				<input 
					type  = "hidden"
					name  = "tick"
					value = "<% $tick %>" 
				>

				<div class="row full marno">

					<span class="twentieth semibold bluetext">
						<% $tick %>.
					</span>

					<span class="half">
						<input 
							type        = "text"
							name        = "label"
							size        = "48"
							placeholder = "Title or label"
						>

%						if (%bill_categories) { 
							<br />
							<span class="quarter semibold 
								<% $event_settings{"bill_category_required"} ? 'required' : "" %>
							">Category:
							</span>
							<span class="threequarters">
								<select name="category" class="fixedmed">
									<option value=""></option>
%									foreach my $category (sort {$a cmp $b} keys %bill_categories) { 
										<option 
											value="<% $category %>"
										><% $category %></option>
%									}
								</select>
							</span>
%						}
					</span>

					<span class="third centeralign">

						<div class="uploader wider">

							<input 
								type     = "file"
								name     = "legislation_<% $tick %>"
								style    = "opacity: 0;"
								onchange = "uploaderName(
									'legislation_<% $tick %>',
									'legislation_<% $tick %>_file'
								)"
								id       = "legislation_<% $tick %>"
							>

							<span 
								id  = "legislation_<% $tick %>_file"
								class = "filename"
								style = "-webkit-user-select: none;"
							>No file selected</span>

							<span 
								class = "action"
								style = "-webkit-user-select: none;"
							>Choose File</span>
						</div>

%						if ($event_settings{"bill_author_required"}) { 
							<br />

							<span class="quarter semibold required"
							>Author:</span>

							<span class="threequarters">
								<select name="category" class="fixedmed">
									<option value=""></option>
%									foreach my $entry (sort {$a cmp $b} $school->entries(event => $event)) { 
										<option 
											value="<% $entry->id %>"
										><% $entry->name %></option>
%									}
								</select>
							</span>
%						}

					</span>

					<span class="eighth rightalign">
						<input 
							type  = "submit"
							class = "thin"
							value = "Submit"
						>
					</span>

				</div>

				</form>

%			}
%		}
%	}

	</div>

	<div class="menu">

		<div class="sidenote">

			<% $tourn->setting("legislation_message") %>

%			foreach my $event (@legislation) { 

				<h4><% $event->name %></h4>

%				foreach my $type ("bill", "resolution", "amendment") {
%					next unless $settings{$event->id}->{$type."_template"};

					<a 
						class="blue full"
						href   = "<%
							$Tab::s3_url
							."/". $tourn->id
							."/". $event->id
							."/".$type."_template/". $settings{$event->id}->{$type."_template"}
						%>"
					><% ucfirst($type) %> Template</a>

%				}
%			}
		</div>

	</div>

