<%args>
	$person
	$panel_id  => undef
	$entry_id  => undef
</%args>
<%init>

	my $panel = Tab::Panel->retrieve($panel_id) if $panel_id;
	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;

	my $round = $panel->round;

	unless ($round->setting('strikes_published')) { 
		my $err = "That strike card is no longer available";
		$m->redirect("strike_cards.mhtml?err=$err");
	}

	my $now = DateTime->now();
	my $deadline = $round->setting('strikes_due');

	if ($deadline < $now) { 
		my $err = "The deadline to fill out that strike card has passed";
		$m->redirect("strike_cards.mhtml?err=$err");
	}

	my $limit = $round->setting('strikes');
	my $autostrike = $round->setting('strikes_autostrike');

	my $msg;

	if ($entry) { 

		foreach my $ballot ($panel->ballots( entry => $entry->id)) { 

			my $judge = $ballot->judge;
				
			next unless $judge;

			if ($limit > 0 && $ARGS{$judge->id}) { 

				$msg .= "<br />" if $msg;
				$msg .= $judge->first." ".$judge->last." struck for ".$entry->code;

				Tab::Score->create({
					ballot => $ballot->id,
					tag    => "strike",
					value  => 1
				});

				$limit--;
			} 

		}

		if ($limit > 0 && $ARGS{$panel->id."_nope"}) { 

			$limit = 0;

			my $ballot = $panel->ballots(entry => $entry->id)->first;
			
			$msg .= "<br />" if $msg;
			$msg .= "Balance of strikes were refused";

			Tab::Score->create({
				ballot => $ballot->id,
				tag    => "no_strike",
				value  => 1
			});

		}
	}

	my $err;

	if ($limit) { 
		undef $msg;
		$err .= "You still have ".$limit." strike(s) remaining.  Please select or choose No Strikes";
	}

	if ($msg) { 

		Tab::ChangeLog->create({
			type        => "strikecard",
			school      => $entry->school->id,
			description => $msg,
			old_panel   => $panel->id,
			person      => $person->id
		});

	}
	
	$m->redirect("strike_cards.mhtml?err=$err&msg=$msg");

</%init>
