<%args>
	$person
	$person_settings
</%args>
<%init>

	my @rounds;
	my %panels;

	my $dbh = Tab::DBI->db_Main();

</%init>

	<div class="main">

		<h4>Coinflips</h4>
<%perl>

		my $sth = $dbh->prepare("
			select
				ballot.id,
				panel.flip_at, panel.flip_done, panel.flip,
				flip_win.value,
				entry.id, entry.code, entry.name,
				school.id, school.code,
				judge.id, judge.first, judge.last,
				panel.id,
				round.label, round.name, round.id, round.published,
				round.start_time, timeslot.start,
				opponent.code,
				event.id, event.abbr, event.name,
				tourn.tz

			from (
				person, ballot, panel, round, timeslot,
				judge, entry, tourn, school, permission,
				event,
				round_setting, entry_student es, student
			)

				left join ballot b2
					on b2.panel = panel.id
					and b2.entry != entry.id

				left join entry opponent
					on opponent.id = b2.entry

				left join score flip_win
					on flip_win.ballot = ballot.id
					and flip_win.tag = 'flip_win'

			where person.id = ?

				and (
					permission.person = person.id
					OR student.person = person.id
				)

				and permission.chapter = school.chapter

				and school.id    = entry.school
				and school.tourn = tourn.id
				and entry.id     = ballot.entry
				and entry.id     = es.entry
				and es.student   = student.id
				and ballot.panel = panel.id
				and ballot.judge = judge.id
				and panel.round  = round.id
				and round.id     = round_setting.round
				and round.event  = event.id

				and round_setting.tag   = 'flip_published'
				and round_setting.value = 1
				and round.timeslot      = timeslot.id

				and panel.bye 	!= 1

			group by ballot.id
			order by round.start_time
		");

		$sth->execute($person->id);

		my %entries;

		while (
			my (
				$ballot_id,
				$flip_at, $flip_done, $flip,
				$flip_win,
				$entry_id, $entry_code, $entry_name,
				$school_id, $school_code,
				$judge_id, $judge_first, $judge_last,
				$panel_id,
				$round_label, $round_name, $round_id, $round_published,
				$start_time, $timeslot_start,
				$opponent_code,
				$event_id, $event_abbr, $event_name,
				$tz
			) = $sth->fetchrow_array()
		) {

</%perl>
			<div class='odd padleftmore ltbordervert marbottom'>

				<span class="half">
					<h5><% $entry_code %></h5>
				</span>
				<span class="half rightalign semibold bigger redtext">
					<% $event_abbr %>
				</span>

				<div class="row padsetting">

					<span class="sixth semibold">
						<% $round_label
							? $round_label
							: "Round ".$round_name
						%>
					</span>

					<span class="sixth semibold">
						Flip deadline
					</span>

					<span class="sixth">
						<& "/funclib/showdt.mas",
							string => $flip_at,
							tz     => $tz,
							tzname => "yasqueen"
						&>
					</span>

					<span class="sixth semibold">
						Round start
					</span>
					<span class="sixth">
%						if ($start_time) {
							<& "/funclib/showdt.mas",
								string => $start_time,
								tz     => $tz,
								tzname => "yasqueen"
							&>
%						} else {
							<& "/funclib/showdt.mas",
								string => $timeslot_start,
								tz     => $tz,
								tzname => "yasqueen"
							&>
%						}
					</span>

				</div>
			</div>
%		}
