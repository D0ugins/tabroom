<%args>
	$person
	$person_settings
</%args>
<%init>

	my @rounds;
	my %panels;

	my $dbh = Tab::DBI->db_Main();

	my $now = DateTime->now();

</%init>

	<div class="main">

		<h4>Coinflips</h4>
<%perl>

		my $student_sth = $dbh->prepare("
			select
				ballot.id, ballot.side,
				panel.flip_at, panel.flip_done, panel.flip,
				flip_win.value,
				entry.id, entry.code, entry.name,
				school.id, school.code,
				judge.id, judge.first, judge.last,
				panel.id,
				round.label, round.name, round.id, round.published,
				round.start_time, timeslot.start,
				opponent.code,
				event.id, event.abbr, event.name,
				aff.value, neg.value, split_flights.value,
				tourn.tz

			from (
				person, ballot, panel, round, timeslot,
				judge, entry, tourn, school,
				event,
				round_setting, entry_student es, student
			)

				left join ballot b2
					on b2.panel = panel.id
					and b2.entry != entry.id

				left join entry opponent
					on opponent.id = b2.entry

				left join score flip_win
					on flip_win.ballot = ballot.id
					and flip_win.tag = 'flip_win'

				left join event_setting aff
					on aff.event = event.id
					and aff.tag = 'aff_string'

				left join event_setting neg
					on neg.event = event.id
					and neg.tag = 'neg_string'

				left join event_setting split_flights
					on split_flights.event = event.id
					and split_flights.tag = 'flip_split_flights'

			where person.id = ?

				and person.id = student.person

				and school.id    = entry.school
				and school.tourn = tourn.id
				and entry.id     = ballot.entry
				and entry.id     = es.entry
				and es.student   = student.id
				and ballot.panel = panel.id
				and ballot.judge = judge.id
				and panel.round  = round.id
				and round.id     = round_setting.round
				and round.event  = event.id

				and round_setting.tag   = 'flip_published'
				and round_setting.value = 1
				and round.timeslot      = timeslot.id

				and panel.bye 	!= 1

			group by ballot.id
			order by round.start_time, flip_win.value DESC
		");

		$student_sth->execute($person->id);

		my $sth = $dbh->prepare("
			select
				ballot.id,
				panel.flip_at, panel.flip_done, panel.flip,
				flip_win.value,
				entry.id, entry.code, entry.name,
				school.id, school.code,
				judge.id, judge.first, judge.last,
				panel.id,
				round.label, round.name, round.id, round.published,
				round.start_time, timeslot.start,
				opponent.code,
				event.id, event.abbr, event.name,
				aff.value, neg.value, split_flights.value,
				tourn.tz

			from (
				person, ballot, panel, round, timeslot,
				judge, entry, tourn, school, permission,
				event,
				round_setting, entry_student es, student
			)

				left join ballot b2
					on b2.panel = panel.id
					and b2.entry != entry.id

				left join entry opponent
					on opponent.id = b2.entry

				left join score flip_win
					on flip_win.ballot = ballot.id
					and flip_win.tag = 'flip_win'

				left join event_setting aff
					on aff.event = event.id
					and aff.tag = 'aff_string'

				left join event_setting neg
					on neg.event = event.id
					and neg.tag = 'neg_string'

				left join event_setting split_flights
					on split_flights.event = event.id
					and split_flights.tag = 'flip_split_flights'

			where person.id = ?

				and permission.person = person.id
				and permission.chapter = school.chapter
				and permission.tag = 'chapter'

				and school.id    = entry.school
				and school.tourn = tourn.id
				and entry.id     = ballot.entry
				and entry.id     = es.entry
				and es.student   = student.id
				and ballot.panel = panel.id
				and ballot.judge = judge.id
				and panel.round  = round.id
				and round.id     = round_setting.round
				and round.event  = event.id

				and round_setting.tag   = 'flip_published'
				and round_setting.value = 1
				and round.timeslot      = timeslot.id

				and panel.bye 	!= 1

			group by ballot.id
			order by round.start_time, flip_win.value DESC
		");

		$sth->execute($person->id);

		my %entries;

		my @raw;
		push @raw, $sth->fetchall_arrayref();
		push @raw, $student_sth->fetchall_arrayref();

		my @refs;

		foreach my $ref (@raw) {
			next unless $ref;
			push @refs, @{$ref};
		}

		foreach my $ref (@refs) {

			next unless $ref;

			my (
				$ballot_id, $ballot_side,
				$flip_at, $flip_done, $flip,
				$flip_win,
				$entry_id, $entry_code, $entry_name,
				$school_id, $school_code,
				$judge_id, $judge_first, $judge_last,
				$panel_id,
				$round_label, $round_name, $round_id, $round_published,
				$start_time, $timeslot_start,
				$opponent_code,
				$event_id, $event_abbr, $event_name,
				$aff_string, $neg_string, $split_flights,
				$tz
			) = @{$ref};

			$aff_string = "Aff" unless $aff_string;
			$neg_string = "Neg" unless $neg_string;

			my $flip_dt = $m->comp("/funclib/showdt.mas",
				string => $flip_at,
				tz     => $tz,
				tzname => "yasqueen",
				object => "youbetcha"
			);

</%perl>
			<div class='odd padleftmore ltbordervert marbottommore'>

				<span class="half">
					<h5><% $entry_code %></h5>
				</span>
				<span class="half rightalign semibold bigger redtext">
					<% $event_abbr %>
				</span>

				<div class="row padsetting">

					<span class="sixth semibold">
						<% $round_label
							? $round_label
							: "Round ".$round_name
						%>
					</span>

					<span class="sixth semibold rightalign">
						Flip deadline:
					</span>

					<span class="sixth">
						<& "/funclib/showdt.mas",
							dt     => $flip_dt,
							tz     => $tz,
							tzname => "yasqueen"
						&>
					</span>

					<span class="sixth semibold rightalign">
						Round start:
					</span>
					<span class="sixth">
%						if ($start_time) {
							<& "/funclib/showdt.mas",
								string => $start_time,
								tz     => $tz,
								tzname => "yasqueen"
							&>
%						} else {
							<& "/funclib/showdt.mas",
								string => $timeslot_start,
								tz     => $tz,
								tzname => "yasqueen"
							&>
%						}
					</span>

					<span class="sixth semibold rightalign <% $flip_win ? "greentext" : "redtext" %>">
						<% $flip_win ? "You WON the flip" : "You LOST the flip" %>
					</span>

				</div>

%				if ($flip_done) {

					<div class="row">

						<span class="sixth">
						</span>

						<span class="sixth semibold rightalign redtext">
							Flip Done
						</span>

						<span class="sixth semibold rightalign redtext">
							Side:
								<% $ballot_side == 1 ? $aff_string : "" %>
								<% $ballot_side == 2 ? $neg_string : "" %>
						</span>

					</div>

%				} elsif ($flip_win && ($flip_dt < $now)) {

					<div class="row padtop">

						<span class="sixth semibold rightalign">
						</span>

						<span class="sixth semibold rightalign redtext">
							Choose side:
						</span>

						<label for="side_<% $entry_id %>_1">
							<span class="sixth semibold centeralign yellowhover">
								<% $aff_string %>
								<input
									type  = 'radio'
									class = "notfirst"
									name  = "side_<% $entry_id %>"
									id    = "side_<% $entry_id %>_1"
									value = "1"
								>
							</span>
						</label>

						<label for="side_<% $entry_id %>_2">
							<span class="sixth semibold centeralign yellowhover">
								<% $neg_string %>
								<input
									type  = 'radio'
									class = "notfirst"
									name  = "side_<% $entry_id %>"
									id    = "side_<% $entry_id %>_2"
									value = "2"
								>
							</span>
						</label>

						<span class="sixth semibold centeralign">
							<a
								class     = "buttonwhite bluetext invert"
								name      = "side"
								target_id = "<% $entry_id %>"
								onClick   = "postConfirm('This choice is final. Are you sure?',
										this,
										'flip_save.mhtml'
								);"
							>Confirm</a>
						</span>

						<span class="sixth semibold redtext">
							Deadline:
						</span>

						<span class="sixth semibold centeralign">
						</span>
					</div>

%					if ($split_flights) {

						<div class="row padsetting">
							<span class="sixth semibold rightalign orangetext">
								Or speaker order:
							</span>

							<label for="order_<% $entry_id %>_1">
								<span class="sixth semibold centeralign yellowhover">
									First
									<input
										type  = 'radio'
										name  = "order_<% $entry_id %>"
										id    = "order_<% $entry_id %>_1"
										value = "1"
									>
								</span>
							</label>

							<label for="order_<% $entry_id %>_2">
								<span class="sixth semibold centeralign yellowhover">
									Second
									<input
										type  = 'radio'
										name  = "order_<% $entry_id %>"
										id    = "order_<% $entry_id %>_2"
										value = "2"
									>
								</span>
							</label>

							<span class="sixth semibold centeralign">
								<a
									class     = "buttonwhite bluetext"
									name      = "side"
									target_id = "order_<% $entry_id %>"
									onClick   = "postConfirm('This choice is final. Are you sure?', this, 'flip_save.mhtml');"
								>Confirm</a>
							</span>
						</div>
%					}
%				}

			</div>
%		}

	</div>

