<%args>
	$person
</%args>
<%init>

	my @rounds;
	my %panels;

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select ballot.id,
			entry.id, entry.code, entry.name,
			school.id, school.code,
			judge.id, judge.first, judge.last, 
			strike.id,
			no_strike.id,
			panel.id,
			round.label, round.name, round.id, round.published,
			opponent.code,
			tourn.tz

		from (ballot, panel, round, judge, entry, tourn, school, permission, round_setting)

		left join score strike on ballot.id = strike.ballot and strike.tag = 'strike'
		left join score no_strike on ballot.id = no_strike.ballot and no_strike.tag = 'no_strike'
		left join ballot b2 on b2.panel = panel.id and b2.id != ballot.id
		left join entry opponent on opponent.id = b2.entry

		where permission.person = ? 
		and permission.chapter = school.chapter
		and school.id = entry.school
		and school.tourn = tourn.id
		and entry.id = ballot.entry
		and ballot.panel = panel.id
		and ballot.judge = judge.id
		and panel.round = round.id
		and panel.bye != 1

		and round.id = round_setting.round
		and round_setting.tag = 'strikes_published'
		and round_setting.value = 1
		group by ballot.id
		order by round.start_time
	");

	$sth->execute($person->id);


	while (
		my ($ballot_id,
			$entry_id, $entry_code, $entry_name, 
			$school_id, $school_code, 
			$judge_id, $judge_first, $judge_last,
			$strike_id, $no_strike_id, 
			$panel_id,
			$round_label, $round_name, $round_id, $round_published,
			$opponent_code,
			$tz
		) = $sth->fetchrow_array()
	) { 

		$panels{$panel_id}{"judges"}{$judge_id}{"name"} = $judge_first." ".$judge_last;
		$panels{$panel_id}{$entry_id}{$judge_id} = $ballot_id;

		$panels{$panel_id}{$entry_id}{"tz"}          = $tz;
		$panels{$panel_id}{$entry_id}{"tz"}          = "UTC" unless $tz;
		$panels{$panel_id}{$entry_id}{"entry_code"}  = $entry_code;
		$panels{$panel_id}{$entry_id}{"opp_code"}    = $opponent_code;
		$panels{$panel_id}{$entry_id}{"entry_name"}  = $entry_name;
		$panels{$panel_id}{$entry_id}{"school_id"}   = $school_id;
		$panels{$panel_id}{$entry_id}{"school_code"} = $school_code;

		if ($strike_id) { 
			$panels{$panel_id}{$entry_id}{"strikes"}{$judge_id}++;
		}
		
		if ($no_strike_id) { 
			$panels{$panel_id}{$entry_id}{"no_strikes"}++;
		}

		if ($round_label) { 
			$panels{$panel_id}{$entry_id}{"round_name"} = $round_label;
		} else { 
			$panels{$panel_id}{$entry_id}{"round_name"} = "Round ".$round_name;
		}
		$panels{$panel_id}{$entry_id}{"round_id"} = $round_id;
		$panels{$panel_id}{$entry_id}{"round_published"} = $round_published;
	}

	$sth = $dbh->prepare("
		select ballot.id,
			entry.id, entry.code, entry.name,
			school.id, school.code,
			judge.id, judge.first, judge.last, 
			strike.id,
			no_strike.id,
			panel.id,
			round.label, round.name, round.id, round.published,
			opponent.code,
			tourn.tz

		from (ballot, panel, round, judge, entry, school, tourn, entry_student, 
			student, round_setting, chapter_setting)

		left join score strike on ballot.id = strike.ballot and strike.tag = 'strike'
		left join score no_strike on ballot.id = no_strike.ballot and no_strike.tag = 'no_strike'
		left join ballot b2 on b2.panel = panel.id and b2.id != ballot.id
		left join entry opponent on opponent.id = b2.entry

		where student.person = ? 
		and entry_student.student = student.id
		and entry_student.entry = entry.id
		and student.chapter = chapter_setting.chapter
		and chapter_setting.tag = 'self_prefs'
		and chapter_setting.value = 1
		and school.id = entry.school
		and school.tourn = tourn.id
		and entry.id = ballot.entry
		and ballot.panel = panel.id
		and ballot.judge = judge.id
		and panel.round = round.id

		and round.id = round_setting.round
		and round_setting.tag = 'strikes_published'
		and round_setting.value = 1
		group by ballot.id
		order by round.start_time
	");

	$sth->execute($person->id);


	while (
		my ($ballot_id,
			$entry_id, $entry_code, $entry_name, 
			$school_id, $school_code, 
			$judge_id, $judge_first, $judge_last,
			$strike_id, $no_strike_id, 
			$panel_id,
			$round_label, $round_name, $round_id, $round_published,
			$opponent_code,
			$tz
		) = $sth->fetchrow_array()
	) { 

		$panels{$panel_id}{"judges"}{$judge_id}{"name"} = $judge_first." ".$judge_last;
		$panels{$panel_id}{$entry_id}{$judge_id} = $ballot_id;

		$panels{$panel_id}{$entry_id}{"tz"}          = $tz;
		$panels{$panel_id}{$entry_id}{"tz"}          = "UTC" unless $tz;
		$panels{$panel_id}{$entry_id}{"entry_code"}  = $entry_code;
		$panels{$panel_id}{$entry_id}{"opp_code"}    = $opponent_code;
		$panels{$panel_id}{$entry_id}{"entry_name"}  = $entry_name;
		$panels{$panel_id}{$entry_id}{"school_id"}   = $school_id;
		$panels{$panel_id}{$entry_id}{"school_code"} = $school_code;
		$panels{$panel_id}{$entry_id}{"judge_id"}    = $judge_id;

		if ($strike_id) { 
			$panels{$panel_id}{$entry_id}{"strikes"}{$judge_id}++;
		}
		
		if ($no_strike_id) { 
			$panels{$panel_id}{$entry_id}{"no_strikes"}++;
		}

		if ($round_label) { 
			$panels{$panel_id}{$entry_id}{"round_name"} = $round_label;
		} else { 
			$panels{$panel_id}{$entry_id}{"round_name"} = "Round ".$round_name;
		}
		$panels{$panel_id}{$entry_id}{"round_id"} = $round_id;
		$panels{$panel_id}{$entry_id}{"round_published"} = $round_published;
	}

</%init>

	<script>

		function submitConfirm (button, event) { 
					
			alertify.confirm(
				"Last chance!",
				"You will not be able change a strike after saving it.  Are you sure?",
				function (e) {
					button.form.submit(); // submit form skipping jQuery bound handler
				},
				function(e) {
					alertify.error("OK, try again!");
				}
			);
		}

		function checkStrikes(strikeLimit, panelId) { 

			if ( $("."+panelId+"_nope:checked").length) { 

				$("."+panelId+":checkbox:not(:checked)").attr('disabled', true);
				$("."+panelId+"_rows").removeClass("yellowhover");

			} else if ( $("."+panelId+":checked").length >= strikeLimit) { 

				$("."+panelId+":checkbox:not(:checked)").attr('disabled', true);
				$("."+panelId+"_rows").removeClass("yellowhover");

			} else { 

				$("."+panelId+":disabled").removeAttr("disabled", true);
				$("."+panelId+"_rows").addClass("yellowhover");
			}
		}

	</script>

	<div class="main">

		<h4>Open Strike Cards</h4>

		<div class="centeralign">
			<p class="bigger semibold redtext threequarters">
				Once both teams save strike cards they will auto process; the
				system will not wait until the deadline.  Please be certain before
				submitting. 
			</p>
		</div>

		<div class="full marno odd">

<%perl>

		my $now = DateTime->now();
		my %rounds; 


		foreach my $panel_id (sort keys %panels) { 
			
			my @judges = sort keys %{$panels{$panel_id}{"judges"}};

			ENTRY:
			foreach my $entry_id (sort keys (%{$panels{$panel_id}})) { 

				next if $entry_id eq "judges";

				my $round_id = $panels{$panel_id}{$entry_id}{"round_id"};

				unless ($rounds{$round_id}) { 
					my $round = Tab::Round->retrieve($round_id);
					my %round_settings = $round->all_settings();
					$rounds{$round_id} = \%round_settings;
					$rounds{$round_id}{"object"} = $round;

					# When you don't give a shit wrap it in an eval!
				
					if ($rounds{$round_id}{"strikes_due"}) { 
						$rounds{$round_id}{"strikes_due"}->set_time_zone($panels{$panel_id}{$entry_id}{'tz'});
						$rounds{$round_id}{"time_left"} = $rounds{$round_id}{"strikes_due"} - $now;
					}
				}
			
				next if $rounds{$round_id}{"strikes_due"} < $now;

				my %struck_panels = eval { 
					return %{JSON::decode_json($rounds{$round_id}{"strike_panels"})};
				};

</%perl>

				<div class="full padbottommore martopmore ltborder whiteback">

					<span class="quarter">
						<h5 class="marleftmore bluetext">
							<% $panels{$panel_id}{$entry_id}{"round_name"} %>
						</h5>
					</span>

					<span class="quarter bluetext semibold">
						Strike up to <% $rounds{$round_id}{"strikes"} %>
					</span>

					<span class="half redtext semibold rightalign">
						Deadline: <& "/funclib/showtime.mas", 
							dt      => $rounds{$round_id}{"strikes_due"},
							tz      => $panels{$panel_id}{$entry_id}{'tz'},
							show_tz => 1
						&>

						<span class="orangetext inline borderleft marleft padleft">
							Time left: 
							<& "/funclib/stopwatch.mas",
								label     => "deadline",
								inline    => "true",
								autostart => "true",
								default   => ($rounds{$round_id}{"time_left"}->in_units('minutes'))
							&>
						</span>

					</span>

%				if ($panels{$panel_id}{$entry_id}{"round_published"}) { 

					<div class="padvertmore full">

						<span class="full bigger semibold redtext centeralign">
							Round has been published!
						</span>

						<span class="full bigger semibold redtext centeralign">
							<a 
								class="buttonwhite bluetext invert"
								href="/index/tourn/postings/round.mhtml?round_id=<% $round_id %>"
							>View Schematic</a>
						</span>

					</div>

%					next ENTRY;

%				}
	
				<form 
					action   = "strike_card_save.mhtml"
					method   = "post"
				>

				<input 
					type  = "hidden"
					name  = "panel_id"
					value = "<% $panel_id %>"
				>

				<input 
					type  = "hidden"
					name  = "entry_id"
					value = "<% $entry_id %>"
				>

				<script>
					$(document).ready(function() {
						checkStrikes('<% $rounds{$round_id}{"strikes"} %>', '<% $panel_id %>_<% $entry_id %>');
					});
				</script>

				<p class="semibold bluetext centeralign bigger">
					<% $panels{$panel_id}{$entry_id}{"entry_code"} %>
					vs.
					<% $panels{$panel_id}{$entry_id}{"opp_code"} %>
				</p>

				<span class="full nospace centeralign">

					<span class="threequarters nospace leftalign">

%						foreach my $judge_id (keys %{$panels{$panel_id}{"judges"}} ) { 

							<label for="<% $entry_id %>_<% $judge_id %>">

								<div class="<% $panel_id %>_<% $entry_id %>_rows full row yellowhover marno padless">

									<span class="threequarters semibold">
										<% $panels{$panel_id}{"judges"}{$judge_id}{"name"} %>
									</span>
									<span class="quarter centeralign">
										<input 
											class    = "<% $panel_id."_".$entry_id %> larger notfirst"
											type     = "checkbox"
											name     = "<% $entry_id %>_<% $judge_id %>"
											id       = "<% $entry_id %>_<% $judge_id %>"
											value    = 1
											<% $panels{$panel_id}{$entry_id}{"strikes"}{$judge_id} ? "checked" : "" %>
											onChange = "checkStrikes(
												'<% $rounds{$round_id}{"strikes"} %>',
												'<% $panel_id."_".$entry_id %>'
											);";
										>
									</span>
								</div>
							</label>
%						}

						<label for="<% $panel_id."_".$entry_id %>_nope">

							<div class="<% $panel_id."_".$entry_id %>_rows full row yellowhover marno padless">

								<span class="threequarters semibold">
									No Strikes/Remaining Blank
								</span>

								<span class="quarter centeralign">
									<input 
										class    = "<% $panel_id."_".$entry_id %>_nope larger notfirst"
										type     = "checkbox"
										name     = "<% $panel_id."_".$entry_id %>_nope"
										id       = "<% $panel_id."_".$entry_id %>_nope"
										value    = 1
										<% $panels{$panel_id}{$entry_id}{"no_strikes"}
											? "checked" 
											: ""
										%>
										onChange = "checkStrikes('<% $rounds{$round_id}{"strikes"} %>', '<% $panel_id %>_<% $entry_id %>');";
									>
								</span>
							</div>
						</label>

						<div class="full libl marno centeralign">
							<button 
								type    = "button"
								class   = "buttonwhite bluetext invert"
								onClick = "submitConfirm(this);";
							>Save Strikes for This Debate</button>
						</div>

					</span>

%				}

				</form>
			</span>
			</div>
%		}
	
		</div>

	</div>

%	undef @rounds;
%	undef %panels;
