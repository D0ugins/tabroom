<%args> 
	$school
	$person
	$event_id => undef
</%args>
<%init>

	my $tourn = $school->tourn;
	my $event = Tab::Event->retrieve($event_id) if $event_id;	

	my @events = sort {$a->name cmp $b->name} $tourn->events;

	$event = $events[0] if scalar @events == 1;
	$event_id = $event->id if scalar @events == 1;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $drop_deadline = $tourn->setting("drop_deadline");
	$drop_deadline = $tourn->reg_end unless $drop_deadline;
	$drop_deadline->set_time_zone($tz);

    my $now = DateTime->now;
							
	my $hide_codes = $tourn->setting("hide_codes");

	my @already_entered = Tab::Entry->search( 
		school      => $school->id,
		waitlist    => 0,
		unconfirmed => 0
	);

	my @waitlist = Tab::Entry->search( 
		school      => $school->id,
		waitlist    => 1,
		unconfirmed => 0
	);

	my @hybrid_entries = $m->comp("/funclib/school_hybrids.mas", school => $school);

	my %is_hybrid = map {$_->id => 1} @hybrid_entries; 
	push (@already_entered, @hybrid_entries); 

	my %seen = (); 
	@already_entered = grep { ! $seen{$_->id} ++ } @already_entered;

	my $tourn_cap = $tourn->setting("overall_cap");
	my $tourn_school_cap = $tourn->setting("school_overall_cap");

	my %events_by_id = map {$_->id => $_} @events;

	my %entries_by_event = ();

	foreach my $entry (@already_entered) { 
		push @{$entries_by_event{$entry->event->id}{"confirmed"}}, $entry;
	}

	foreach my $entry (@waitlist) { 
		push @{$entries_by_event{$entry->event->id}{"waitlist"}}, $entry;
	}

	my %entry_setting = $m->comp("/funclib/school_entry_settings.mas", school => $school);
	my %event_setting = $m->comp("/funclib/event_settings.mas", tourn => $tourn);

</%init>

	<script>

		function showOneEvent() { 

			var eventID = $("#showMeBaby option:selected").val();

			$(".sidebar_add").addClass("hidden");
			$(".event_description").addClass("hidden");

			showEvent(eventID);

		}

		function showEventByButton(eventID) { 

			if (eventID == null) { 
				eventID = "ALL";
			}

			$(".eventbutton").removeClass('invert');
			$("#button_"+eventID).addClass('invert');

			showEvent(eventID);

		}

		function showEvent(eventID) {

			if (eventID === "ALL") { 

				$(".roster").removeClass("hidden");

			} else { 

				$(".roster").addClass("hidden");
				$("."+eventID).removeClass("hidden");
			}

		}

	</script>

	<div class="main">
	
		<h2><% $tourn->name %></h2>
		
		<& menu.mas, school => $school, whoami => "by_event" &>

		<div class="full nospace">

			<span class="twofifths nospace">

				<h4>
					<% $school->name %> competitors
				</h4>

			</span>

			<span class="half centeralign">

%				if ((scalar(keys %entries_by_event)) > 6) { 

					<h6 class="inline marright"> 
						Show:
					</h6>

					<select
						onChange = "showOneEvent();"
						class="fixedsmall"
						id = "showMeBaby"
					>
						<option value="ALL">All</option>

%						foreach my $event_id (sort {$events_by_id{$a}->name cmp $events_by_id{$b}->name} keys %entries_by_event) { 
							<option value="<% $event_id %>"><% $events_by_id{$event_id}->abbr %></option>
%						}

					</select>

%				} else { 

					<a 
						class   = "buttonwhite button bluetext marleft eventbutton invert"
						onClick = "showEventByButton();"
						id      = "button_ALL"
					>
						ALL
					</a>
%					foreach my $event_id (sort {$events_by_id{$a}->name cmp $events_by_id{$b}->name} keys %entries_by_event) { 
						<a 
							class="buttonwhite button bluetext marleft eventbutton"
							onClick="showEventByButton(<% $event_id %>)"
							id="button_<% $event_id %>"
						>
							<% $events_by_id{$event_id}->abbr %>
						</a>
%					}
%				}

			</span>

			<span class="sixth rightalign">

				<a 
					href="entry_print.mhtml?&school_id=<% $school->id %>"
					class="fa-sm fa fa-file-pdf-o button buttonwhite greentext marrightmore"
				></a>
				<a 
					href="entry_csv.mhtml?&school_id=<% $school->id %>"
					class="fa fa-file-excel-o button buttonwhite greentext fa-sm marleftmore"
				></a>
			</span>

			</span>

		</div>

%		if ($drop_deadline && $now > $drop_deadline) { 

			<h4 class="redtext centeralign">Change deadline has passed</h4>
							
			<p>
				If you have additional changes, you can no longer enter them
				online.  Please contact the tournament directly.
			</p>

%		}

%		foreach my $event_id (sort {$events_by_id{$a}->name cmp $events_by_id{$b}->name} keys %entries_by_event) { 

%			my $event = $events_by_id{$event_id};
%			my @already = @{$entries_by_event{$event_id}{"confirmed"}} if $entries_by_event{$event_id}{"confirmed"};
%			my @waitlist = @{$entries_by_event{$event_id}{"waitlist"}} if $entries_by_event{$event_id}{"waitlist"};

			<div class="<% $event_id %> roster full nospace">

				<div class="full nospace martop">
					<span class="half nospace">
						<h5><% $event->name %></h5>
					</span>

					<span class="quarter nospace">
						<h6>
							<% scalar @already %> entered
						</h6>
					</span>

%					if (@waitlist) { 
						<span class="quarter nospace">
							<h6>
								<% scalar @waitlist %> waitlisted
							</h6>
						</span>
%					}

				</div>

				<table id="sortable">

					<thead>

						<tr class="yellowrow smallish">

							<th>
								Event
							</th>

%							unless ($hide_codes) { 
								<th>
									Code
								</th>
%							}

							<th>
								Name
							</th>

							<th>
								Status
							</th>

							<th>
							</th>

							<th>
							</th>


						</tr>

					</thead>

					<tbody>
				
%	 				foreach my $entry (@already, @waitlist) { 

						<tr class="lightrow">
				
							<td>
								<% $event->abbr %>
							</td>

%							unless ($hide_codes) { 
								<td>
									<% $entry->code %>
								</td>
%							}

							<td>
								<% $entry->name %>
							</td>

							<td class="centeralign">
%								if ($entry->dropped) { 
									<span class="redtext strong marno padless"> 
										DROPPED
									</span>
%								} elsif ($entry->waitlist) { 
									<span class="orangetext strong marno padless"> 
										WAITLIST
									</span>
%								} 

							</td>

							<td>

%								if ($event_setting{$event_id}{"apda"}) { 
									<span class="quarter">
										<% ucfirst($entry_setting{$entry->id}{"registered_seed"}) %>
									</span>
%								}

%								my $other;

<%perl>

								if ($is_hybrid{$entry->id}) { 
									foreach my $student ($entry->students) { 
										next if $student->chapter->id == $school->chapter->id;
										$other = Tab::School->search( 
											chapter => $student->chapter->id, 
											tourn => $tourn->id
										)->first;
									}
								}

</%perl>

%								if ($other) { 
									<span class="half">
										Hybrid w/<% $other->short_name %> 
									</span>
%								}

%								if ($entry->ada) { 
									<span class="half">
										ADA Rooms Requested
									</span>
%								}

%								if ($event_setting{$event_id}{'ask_quals'}) { 

									<span class="half">
										<% scalar $entry->qualifiers %> qualifiers
									</span>
									
%									if ($entry_setting{$entry->id}{"atlarge"}) { 
										<span class="half">
											At-Large Entry
										</span>
%									}
%								}

%	 							if ($event_setting{$event_id}{"ask_for_titles"}) {

									<div class="full nospace">

										<span class="half">
											<% $entry_setting{$entry->id}{"title"}  %>
										</span>

%										if ($entry_setting{$entry->id}{"author"}) {
											<span class="half">
												by <% $entry_setting{$entry->id}{"author"} %>
											</span>
%										}

									</div>

%								}

							</td>


							<td class="centeralign">

%								my $url = "details.mhtml";
%								$url = "tba_assign.mhtml" if $entry->tba;

%								if ($now < $drop_deadline) { 

%									if ( not defined $event_setting{$event_id}{"deadline"} 
%											||	$now < $event_setting{$event_id}{"deadline"} 
%									) { 

									<a 
										class = "bluetext button buttonwhite fa-edit fa fa-sm marleftmore marrightmore"
										title = "EDIT ENTRY"
										alt   = "EDIT ENTRY"
										href  = "<% $url %>?entry_id=<% $entry->id %>&school_id=<% $school->id %>"
									>
									</a>
%									}

%								}

%								if ($now < $drop_deadline) { 

%									if ($entry->dropped) {

%										my $warn = "This button adds the entry back to your registration.  ";
%										$warn .= "Your fees and judge burdens may change.  Continue?";

										<a 
											class = "greentext button buttonwhite fa-undo fa fa-sm marleftmore marrightmore"
											alt   = "UN-DROP ENTRY"
											title = "UN-DROP ENTRY"
											href="entry_drop.mhtml?school_id=<% $school->id %>&entry_id=<% $entry->id %>"
											<& "/funclib/confirm.mas", warn => $warn &>  
										>
										</a>

%									} else  {

<%perl>
										my $warn = "Are you sure you want to drop that entry?";

										$warn = "This action drops your entry and loses the slot.  If instead you want to give the slot to one of your waitlisted entries, hit Cancel, then Edit instead and do a name change.  Otherwise, hit OK to confirm the drop." 
											if @waitlist; 
										
										$warn = "This entry is waitlisted and will lose its place in line if you drop.  Hit cancel, then edit and swap the entry to another student to keep the place in line.  Otherwise, hit OK to continue" 
											if $entry->waitlist;
							
</%perl>
										<a 
											class = "redtext button buttonwhite fa-trash fa fa-sm marleftmore"
											alt   = "DROP ENTRY"
											title = "<% $warn %>"
											<& "/funclib/confirm.mas", warn => $warn &> 
											href="entry_drop.mhtml?school_id=<% $school->id %>&entry_id=<% $entry->id %>"
										>
										</a>
%									}


%								} 

							</td>

						</tr>

%	 				} 

					</tbody>

				</table>

			</div>

%		}

%		foreach my $event (@events) { 

% 			if ($event_setting{$event->id}{"description"}) { 

				<div class="full nospace hidden event_description <% $event->id %>">

					<h4>Description and rules for <% $event->name %> </h4>

					<p>
						<% $event_setting{$event->id}{"description"} %>
					</p>

				</div>
% 			}
% 		}
	
	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Add Entries</h4>

			<form action="students.mhtml" method="post">
			<input type="hidden" name="school_id" value="<% $school->id %>">

			<div class="lighteven full centeralign">

				<select
					name="event_id"
					class="fixedmed"
					onChange="this.form.submit();"
				>

					<option value=""></option>

%					foreach my $oevent (@events) { 
						<option 
							value="<% $oevent->id %>"
							<% $event && $oevent->id == $event->id ? 'selected="selected"' : "" %>
						><% $oevent->name %></option>
%					}

				</select>

			</div>

			</form>

		</div>
	
%		if ($event) { 

			<div class="sidenote">

				<h4><% $event->abbr %> Stats & Deadlines</h4> 

%				my $event_deadline = $event_setting{$event->id}{"deadline"};

%				if ($event_deadline && $event_deadline->epoch && $now > $event_deadline) { 

					<div class="yellow full">
						<span class="half">
							<% $event->abbr %> Add Deadline 
						</span>
						<span class="half">
							<% Tab::niceshortdt($event_deadline->set_time_zone($tz)) %>
						</span>
					</div>

%				} else { 

					<div class="full row event_deadline <% $event->id %>">
						<span class="half">
							Add Deadline 
						</span>
						<span class="half">
							<% Tab::niceshortdt($tourn->reg_end->set_time_zone($tz)) %>
						</span>
					</div>
%				}

				<div class="full row">
					<span class="half">
						Drop Deadline 
					</span>
					<span class="half">
						<% Tab::niceshortdt($drop_deadline) %>
					</span>
				</div>

%				if ($event_setting{$event->id}{"school_cap"}) {

					<div class="full row">
						<span class="half">
							School limit in <% $event->abbr %>
						</span>
						<span class="half">
							<% $event_setting{$event->id}{"school_cap"} %>
						</span>
					</div>
%				}

%				if ($event_setting{$event->id}{"cap"}) {
					<div class="full row">
						<span class="half">
							Total limit in <% $event->abbr %>
						</span>
						<span class="half">
							<% $event_setting{$event->id}{"cap"} %>
						</span>
					</div>
%				}

%				if ($tourn_cap) {
					<div class="full row">
						<span class="half">
							Tourn overall cap
						</span>
						<span class="half">
							<% $tourn_cap %>
						</span>
					</div>
%				}

%				if ($tourn_school_cap) {

					<div class="full row">
						<span class="half">
							School tourn cap
						</span>
						<span class="half">
							<% $tourn_school_cap %>
						</span>
					</div>
%				}

<%perl>

				my $waitlist_status = $m->comp("/funclib/waitlist_status.mas", 
										event  => $event,
										school => $school
									);
</%perl>

%				if ($waitlist_status) { 
					<div class="centeralign dkred full">
						<% $waitlist_status %>
					</div>
%				}

			</div>

<%perl>

			my $reg_over;

			$reg_over++ if $now > $tourn->reg_end;
			$reg_over++ if $event_deadline && $now > $event_deadline;



</%perl>

%			unless ($reg_over) { 

%			    my @clean_students = $m->comp("/funclib/students_evententer.mas", 
%							event  => $event,
%							school => $school);

				<div class="sidenote">

%					if ($event_setting{$event->id}{"max_entry"} > 2) {
	
						<a href="student_save.mhtml?school_id=<% $school->id %>&event_id=<% $event->id %>" class="dkblue full">
							Add <% $waitlist_status ? "to waitlist" : "entry" %> in <% $event->abbr %>
						</a>

%					} else { 

					<h4 class="marless padless">
						Add <% $waitlist_status ? "to waitlist" : "entry" %> in <% $event->abbr %>
					</h4>

					<form action="student_save.mhtml" method="post">

						<input type="hidden" name="school_id" value="<% $school->id %>">
						<input type="hidden" name="waitlist" value="<% ($waitlist_status) ? 1 : 0 %>"> 
						<input type="hidden" name="event_id" value="<% $event->id %>">

						<div class="lightrow full centeralign">

							<select 
								name             = "student_id"
								data-placeholder = "Competitor..."
								class            = "fixedmed chosen"
							>

%								foreach my $student (@clean_students) { 
									<option 
										value="<% $student->id %>"
										> <% $student->last.", ".$student->first %> </option>
%								}

							</select>

						</div>

%						if ($event_setting{$event_id}{"max_entry"} == 2) { 

							<div class="lightrow full centeralign">

								<select 
									name             = "partner_id"
									data-placeholder = "Competitor..."
									class            = "fixedmed chosen"
								>

%									if ($event_setting{$event_id}{"min_entry"} == 1) { 
										<option value="">--Single/Maverick--</option>
%									}

%									foreach my $student (@clean_students) { 
										<option value="<% $student->id %>"> <% $student->last.", ".$student->first %> </option>
%									}

								</select>
							</div>
%						}

					<div class="liblrow rightalign">
						<input type="submit"  value="Add Entry" class="thin">
						</form>
					</div>

%				} 

%				if ($event_setting{$event_id}{"hybrids"}) { 

%					my $waitlist++ if $waitlist_status;

					<a 
						class="yellow full" 
						href="hybrid_entry.mhtml?event_id=<% $event->id %>&school_id=<% $school->id %>&waitlist=<% $waitlist %>">
						Enter Hybrid Team
					</a>
%				}

				<a class="yellow full martop" href="/user/chapter/students.mhtml?chapter_id=<% $school->chapter->id %>">
					Add New Competitors to Roster
				</a>


%				if ($event_setting{$event->id}{"cap"} 
%					|| $event_setting{$event->id}{"school_cap"} 
%					|| $event_setting{$event->id}{"always_tba"} 
%					|| $event_setting{$event->id}{"waitlist"} 
%					|| $event_setting{$event->id}{"waitlist_all"} 
%				) { 

					<h4 class="martop">
						TBA Slots in <% $event->abbr %>
					</h4>

						<form action="tba_save.mhtml">
						<input type="hidden" name="school_id" value="<% $school->id %>">
						<input type="hidden" name="event_id" value="<% $event->id %>">

						<div class="even full">

							<span class="quarter rightalign">
								Claim 
							</span>

							<span class="half">
								<input type="number" min="1" max="20" size="2" name="slots" class="smaller"> slots 
							</span>

							<span class="quarter">
								<input type="submit" class="thin" value="Go">
							</span>
						</div>
						</form>

%				}
	
				</div>

%			}  else { 

				<p class="explain">
%					$m->print("Tournament registration deadline has passed") if ($now > $tourn->reg_end);
%					$m->print("Event registration deadline has passed") if ($event_deadline && $now > $event_deadline);
%					$m->print("Event wide limit has been reached") if ($waitlist_status && ($event_setting{$event_id}{"waitlist"} < 1));
				</p>

%			}

%		}

	</div>

