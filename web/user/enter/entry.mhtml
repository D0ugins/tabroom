<%args>
	$person
	$session
	$school
	$tourn
	$disclaimed => undef
</%args>
<%init>

	use POSIX;
	my %tourn_settings = $tourn->all_settings;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now(time_zone => $tz);
	my $year = $tourn->start->year;
	my %school_settings = $school->all_settings();

	if ($tourn_settings{"disclaimer"}) {

		if ($disclaimed) {

			$school->setting("disclaimed", $person->id);
			$school->setting("disclaimed_at", "date", $now);

		} elsif ($school_settings{"disclaimed"}) {

		} else {

			$m->redirect("disclaimer.mhtml?school_id=".$school->id)
		}
	}

	my @empties = $m->comp(
		"/funclib/school_empty_entries.mas",
		school => $school
	);

	my %reasons = ();

	if ($tourn_settings{"nsda_nats"}) {

		%reasons = $m->comp(
			"/funclib/judgemath/nats_check_judging.mas",
			school => $school
		);

        foreach my $student ($m->comp('/funclib/school_students.mas', school => $school)) {
            $m->comp("/funclib/status_check.mas",
                school  => $school,
                student => $student
            );
        }
	}

</%init>

	<div class="main">

		<& "tabbar.mas",
			school         => $school,
			whoami         => "tourn",
			tourn_settings => \%tourn_settings,
			reasons        => \%reasons
		&>

%		if ($tourn_settings{"registration_message"}) {
			<div class="full padmore">
				<% $tourn_settings{"registration_message"} %>
			</div>
%		}

%		if (@empties) {

			<div class="full bluetext warnbox centeralign">

				<h5 class="redtext">
					Something has gone horribly, horribly wrong!
				</h5>

				There are no competitors assigned to entries:

%					foreach my $empty (@empties) {

						<div class="full centeralign">
							<a
								href="/user/enter/details.mhtml?school_id=<% $school->id %>&entry_id=<% $empty->id %>"
								class="button dkred"
							>
								<% $empty->code %> in
								<% $empty->event->abbr %>
							</a>
						</div>
%					}

				Please assign competitors to these entries or they will not
				advance or receive points.
			</div>

%		}

%		if ($tourn_settings{"ask_regions"}) {

			<h3>Region</h3>

			<form action="region_save.mhtml" method="post">

			<input
				type  = "hidden"
				name  = "school_id"
				value = "<% $school->id %>"
			>

			<div class="row">
				<span class="half">
					Your Region/District:
				</span>

				<span class="third">
					<select
						name="region_id"
						class="fixedmed"
					>

						<option value="">Please choose one:</option>

%						foreach my $region ($tourn->regions) {
							<option
								value="<% $region->id %>"
								<% $region->id == $school->region
									? 'selected="selected"'
									: ""
								%>
							><% $region->name %></option>
%						}
					</select>
				</span>

				<span class="sixth">
					<input
						type  = "submit"
						value = "Save"
						class = "thin"
					>
				</span>

				</form>
			</div>
<%perl>

		}

		if ($tourn_settings{"nsda_nats"}) {

			my $dbh = Tab::DBI->db_Main();

			my $pending_sth = $dbh->prepare("
		        select entry.id
				from entry
					where entry.school = ?
					and entry.unconfirmed = 1
					and not exists (
						select es.id
						from entry_setting es
						where es.tag = 'rejected_by'
						and es.entry = entry.id
					)
					and not exists (
						select es.id
						from entry_setting es
						where es.tag = 'dropped_by'
						and es.entry = entry.id
					)
					and not exists (
						select evs.id
						from event_setting evs
						where evs.event = entry.event
						and (
							evs.tag = 'supp'
							or evs.tag = 'conn'
							or evs.tag = 'stefan'
						)
					)
			");

			$pending_sth->execute($school->id);

			my $entries;
			my $unconfirmed;

			while (
				my ($entry_id) = $pending_sth->fetchrow_array()
			) {
				$unconfirmed++;
			}

			$entries++ if $unconfirmed;

			my $incomplete_sth = $dbh->prepare("
				select student.id, student.first, student.last, status.value, GROUP_CONCAT(reason.value_text)
				from (student, entry, entry_student es)
					left join entry_setting status
						on status.entry = entry.id
						and status.tag = 'status'
					left join entry_setting reason
						on reason.entry = entry.id
						and reason.tag = 'incomplete_reasons'
				where entry.school = ?
					and entry.id = es.entry
					and entry.active = 1
					and es.student = student.id
				group by student.id
			");

			my %done;
			my $entry_reasons;
			$incomplete_sth->execute($school->id);

			while (
				my ($student_id, $first, $last, $status, $reason) = $incomplete_sth->fetchrow_array()
			) {

				next unless $reason;
				next if $status eq "complete";
				next if $done{$student_id}++;

				$reason =~ s/,/-/g;
				my @reasons = split(/\-/, $reason);

				$entry_reasons .= "</div>" if $entry_reasons;
				$entry_reasons .= '<div class="full padno marless padtop">';
				$entry_reasons .= '<span class="semibold bluetext inline">'.$first.' '.$last.'</span>  ';

				my %used;
				foreach my $reason (@reasons) {
					$reason =~ s/^\s+//;
					$reason =~ s/\s+$//;
					next if $used{$reason}++;
					$entry_reasons .= '<br />&nbsp;&nbsp;&nbsp;'.$reason;
				}
			}

			my $usa_wsdc_sth = $dbh->prepare("
				select student.id, student.first, student.last, entry.code
				from entry, event, entry_student es, student, event_setting usa
					where student.chapter = ?
					and student.id        = es.student
					and es.entry          = entry.id
					and entry.event       = usa.event
					and usa.tag           = 'usa_wsdc'
					and entry.event       = event.id
					and event.tourn       = ?
			");

			$usa_wsdc_sth->execute($school->chapter->id, $tourn->id);

			my %forms;

			while (
				my ($student_id, $student_first, $student_last, $entry_code) = $usa_wsdc_sth->fetchrow_array()
			) {

				unless (%forms) {
					%forms = eval{
						return %{JSON::decode_json($school->setting('release_forms'))};
					};
				}

				next if $forms{$student_id};
				$entry_reasons .= "</div>" if $entry_reasons;
				$entry_reasons .= '<div class="full padno marless padtop">';
				$entry_reasons .= '<span class="semibold bluetext inline">'.$student_first.' '.$student_last.'</span>  ';
				$entry_reasons .= "<br />Missing release forms for World Schools (".$entry_code.")";
			}

			$usa_wsdc_sth->finish();

			# Missing coaches
			my $missing_coaches = $dbh->prepare("

				select entry.name, entry.id, event.abbr

				from (entry, event)

				where entry.school = ?
					and entry.event = event.id
					and entry.active = 1

					and not exists (
						select coach.id
						from entry_setting coach
						where coach.entry = entry.id
						and coach.tag = 'coach_points'
					)
			");

			$missing_coaches->execute($school->id);

			while (
				my (
					$entry_name, $entry_id, $event_abbr
				) = $missing_coaches->fetchrow_array()
			) {

				$entry_reasons .= "</div>" if $entry_reasons;
				$entry_reasons .= '<div class="full padno marless padtop">';
				$entry_reasons .= '<span class="semibold bluetext inline">'.$entry_name.'</span>  ';
				$entry_reasons .= "<br />Missing coach for points credit in ".$event_abbr;
			}

			$entry_reasons .= "</div>" if $entry_reasons;
			$entries++ if $entry_reasons;

			my @fees = $m->comp("/funclib/school_fees.mas",
				school => $school,
				all    => 1
			);

			my $money_due = shift @fees;
			my $felines = shift @fees;
			my $totals = shift @fees;

			undef $money_due if $money_due < 0;

</%perl>

			<div class="full nospace martopmuchmore marbottom">
				<h5 class="nospace">
					Registration Status
				</h5>
			</div>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">

					<div class="yellowrow smallish semibold">
						<span class='quarter'>
							Area
						</span>

						<span class='half nospace'>
							Issues
						</span>

						<span class='quarter centeralign'>
							Status
						</span>
					</div>

					<div class="row">
						<span class='quarter semibold bluetext padsetting'>
							Entries
						</span>

						<span class='half nospace'>
%							if ($unconfirmed) {
								<% $unconfirmed %> slots pending acceptance/rejection
%							}
%							if ($entry_reasons) {
								<% $entry_reasons %>
%							}
%							unless ($entries) {
								No issues found
%							}
						</span>

						<span class='quarter centeralign'>
%							unless ($entries) {
								<span class="fa fa-2x fa-check-circle greentext"></span>
%							} else {
								<span class="fa fa-2x fa-times-circle redtext"></span>
%							}
						</span>
					</div>

					<div class="row">
						<span class='quarter semibold bluetext padsetting'>
							Judging
						</span>

						<span class='half nospace'>
%						if ($reasons{"nope"}) {
							<% $school->setting("judging_unmet") %>
%						} else {
							Judging obligation met
%						}
						</span>

						<span class='quarter centeralign'>
%							if ($reasons{"nope"}) {
								<span class="fa fa-2x fa-times-circle redtext"></span>
%							} else {
								<span class="fa fa-2x fa-check-circle greentext"></span>
%							}
						</span>
					</div>

					<div class="row">
						<span class='quarter semibold bluetext padsetting'>
							Fees
						</span>

						<span class='half nospace'>
%							if ($money_due) {
								&#x24;<% $money_due %> still owed (
%								if ($totals->{entry_fees}) {
									&#x24; <% $totals->{entry_fees} %> entry fees
%								}
%								if ($totals->{concessions}) {
									&#x24; <% $totals->{concessions} %> concessions
%								}
%								if ($totals->{payments}) {
									&#x24; <% $totals->{payments} * -1 %> paid
%								}
								)
%							}
						</span>

						<span class='quarter centeralign'>
%							if ($money_due) {
								<span class="fa fa-2x fa-times-circle redtext"></span>
%							} else {
								<span class="fa fa-2x fa-check-circle greentext"></span>
%							}
						</span>
					</div>

				</span>
			</div>
%		}

		<form action="contact_save.mhtml" method="post">

		<div class="full nospace martopmuchmore marbottom">
			<span class="third nospace">
				<h5 class="nospace">
					Contact Information
				</h5>
			</span>

			<span class="twothirds rightalign semibold italic redtext">
<%perl>

				if ($tourn_settings{"require_adult_contact"} && !(
					   $school_settings{"contact_name"}
					   && $school_settings{"contact_email"}
					   && $school_settings{"contact_number"}
					   #if you listen closely, you can hear the loudest sigh in the world
				   )) {
</%perl>
						An adult contact is required before you can continue with
						registration.
%					}
			</span>
		</div>

		<div class="centeralign nospace">
			<span class="ninetenths leftalign">

				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>

				<div class="yellowrow smallish semibold">

					<span class='tenth marno centeralign'>
					</span>

					<span class='threetenths'>
						Name
					</span>

					<span class='threetenths'>
						Email
					</span>

					<span class='fifth'>
						Phone
					</span>
				</div>

				<div class="row">

					<span class="eighth semibold bluetext marno centeralign padno">
%					if ($tourn_settings{"category_adult_contact"}) {
						Overall
%					} elsif ($tourn_settings{"second_adult_contact"}) {
						Primary
%					}
					</span>

					<span class="threetenths">
						<input
							size  = "24"
							type  = "text"
							name  = "contact_name"
							value = "<% $school_settings{"contact_name"} %>"
						>
					</span>

					<span class="threetenths">
						<input
							size  = "24"
							type  = "email"
							name  = "contact_email"
							value = "<% $school_settings{"contact_email"} %>"
						>
					</span>

					<span class="fifth">
						<input
							size  = "18"
							type  = "tel"
							name  = "contact_number"
							value = "<% Tab::phone($school_settings{"contact_number"}) %>"
						>
					</span>

				</div>

%				if ($tourn_settings{"second_adult_contact"}) {
					<div class="row">

						<span class="eighth semibold bluetext marno centeralign padno">
							Secondary
						</span>

						<span class="threetenths">
							<input
								size  = "24"
								type  = "text"
								name  = "second_contact_name"
								value = "<% $school_settings{"second_contact_name"} %>"
							>
						</span>

						<span class="threetenths">
							<input
								size  = "24"
								type  = "email"
								name  = "second_contact_email"
								value = "<% $school_settings{"second_contact_email"} %>"
							>
						</span>

						<span class="fifth">
							<input
								size  = "18"
								type  = "tel"
								name  = "second_contact_number"
								value = "<% Tab::phone($school_settings{"second_contact_number"}) %>"
							>
						</span>

					</div>
%				}

<%perl>
				if ($tourn_settings{"category_adult_contact"}) {

					my %contacts = eval{
						return %{JSON::decode_json($school->setting('category_contacts'))};
					};

					foreach my $category ($m->comp("/funclib/school_categories.mas", school => $school)) {
</%perl>

						<div class="row">

							<span class="eighth semibold bluetext marno centeralign padno">
								<% $category->name %>
							</span>

							<span class="threetenths">
								<input
									type  = "text"
									name  = "<% $category->id %>_name"
									size  = "24"
									value = "<% $contacts{$category->id}{"name"} %>"
								>
							</span>

							<span class="threetenths">
								<input
									type  = "email"
									name  = "<% $category->id %>_email"
									size  = "24"
									value = "<% $contacts{$category->id}{"email"} %>"
								>
							</span>

							<span class="fifth">
								<input
									type  = "tel"
									name  = "<% $category->id %>_phone"
									size  = "18"
									value = "<% Tab::phone($contacts{$category->id}{"phone"}) %>"
								>
							</span>


						</div>
%					}
%				}

				<div class="libl rightalign marvertno padvertless padrightmore">
					<span class="true quarter centeralign nospace">
						<input  type="submit" value="Save Coaches">
					</span>
				</div>
			</span>
		</div>

%		if ($tourn_settings{"nsda_nats"}) {

			<h5 class="martopmore">
				Tournament Book Coaches
			</h5>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">

			<p>
				Coaches listed as recieving points for an entry will
				automatically be listed in the tournament book.  List
				additional coaches below.
			</p>

			<div class="row">

				<span class="third marno bluetext semibold centeralign padsetting">
					Automatically listed coaches:
				</span>

				<span class="twothirds padsetting">
						<%
							$m->comp("/funclib/school_tbook.mas",
								school => $school,
								text => 'yup'
							)
						%>
				</span>

			</div>

			<div class="row">

				<span class="third marno bluetext semibold centeralign padsetting">
					Additional Names <span class="inline redtext">not listed above</span>:
					<div class="full explain nospace padleft normalweight">
						Separate names with commas
					</div>
				</span>

				<span class="twothirds">
%					if ($now > $tourn->reg_end) {
						<input
							type  = "hidden"
							name  = "tbook_coaches"
							size  = "48"
							value = "<% $school->setting("tbook_coaches") %>"
						>
						<% $school->setting("tbook_coaches") %>
%					} else {
						<input
							type        = "text"
							name        = "tbook_coaches"
							size        = "64"
							value       = "<% $school->setting("tbook_coaches") %>"
							placeholder = "Separate multiple names with commas"
						>
%					}
				</span>
			</div>

			<div class="libl rightalign marvertno padvertless padrightmore">
				<span class="true quarter centeralign nospace">
					<input  type="submit" value="Save Coaches">
				</span>
			</div>

			</span>
			</div>

%		}


%		if ($tourn_settings{"nsda_ms_nats"}) {

			<div class="row">

				<span class="third marno">
					Coaches (for recognition on team awards)
				</span>

				<span class="twothirds">
					<textarea
						cols  = "48"
						rows  = "3"
						type  = "text"
						name  = "coaches"
					><% $school->chapter->setting("coaches")  %></textarea>
				</span>
			</div>

			<div class="libl rightalign marvertno padvertless padrightmore">
				<span class="true quarter centeralign nospace">
					<input  type="submit" value="Save Coaches">
				</span>
			</div>
%		}

%		my @hotels = $tourn->hotels();

%		if (@hotels) {

			<h5 class="martopmore">
				Hotel Information
			</h5>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">

%			if ($tourn_settings{"hotel_message"}) {
				<div class="biggish">
					<% $tourn_settings{"hotel_message"} %>
				</div>
%			}

			<div class="row">

				<span class="quarter semibold bluetext centeralign">
					Choose Hotel
				</span>

				<span class="threequarters">
					<select name="hotel" class="fixedbigger">
<%perl>
					foreach my $hotel (
						sort {
						$b->multiple cmp $a->multiple
						|| $b->surcharge cmp $a->surcharge
						|| $a->name cmp $b->name
						} @hotels
					) {

</%perl>
						<option value="<% $hotel->id %>"
							<% $hotel->id == $school_settings{"hotel"}
								? 'selected="selected"'
								: ""
							%>
						><% $hotel->name %> <%
								$hotel->multiple > 1
								? "(Entry fee surcharge of ".$hotel->multiple."X applies)"
								: ""
						%>
						<%
								$hotel->surcharge > 0
								? "(Surcharge of \$".$hotel->surcharge." per competitor applies)"
								: ""
						%><%
								$hotel->surcharge < 0
								? "(\$".abs($hotel->surcharge)."/competitor discount)"
								: ""
						%></option>
						</option>
%					}

					</select>

				</span>
			</div>

			<div class="libl rightalign marvertno padvertless padrightmore">
				<span class="true quarter centeralign nospace">
					<input  type="submit" value="Save Hotel">
				</span>
			</div>

			</span>
			</div>

%		} elsif ($tourn_settings{"nsda_ms_nats"}) {

				<div class="row">

					<span class="third marno">
						Hotel You Are Staying At
					</span>

					<span class="twothirds">
						<input
							size  = "48"
							type  = "text"
							name  = "contact_hotel"
							value = "<% $school_settings{"contact_hotel"}  %>"
						>
					</span>

				</div>

			<div class="row">

				<span class="third marno">
					Number of hotel rooms booked
				</span>

				<span class="twothirds">
					<input
						size  = "48"
						type  = "number"
						min   = 0
						max   = 999
						name  = "contact_hotel_rooms"
						value = "<% $school_settings{"contact_hotel_rooms"}  %>"
					>
				</span>

			</div>

			<& "/funclib/datepicker.mas",
				id  => "hotel_checkout",
				min => $tourn->start
			&>

			<div class="row">

				<span class="third marno">
					Hotel checkout date
				</span>

				<span class="twothirds">
					<input
						id    = "hotel_checkout"
						size  = "16"
						type  = "text"
						name  = "contact_hotel_checkout"
						value = "<%
							$school_settings{"contact_hotel_checkout"}
							? Tab::pickerdate($school_settings{"contact_hotel_checkout"})
							: Tab::pickerdate($tourn->end->add(days => 1))
						%>"
					>
				</span>

			</div>

%		}

<%perl>

		if ($tourn_settings{"per_person_fee"}) {

			my $bodies = $m->comp("/funclib/school_bodies.mas", school => $school);

			if ($school_settings{"individuals"} < $bodies) {
				$school->setting("individuals", $bodies);
				$school_settings{"individuals"}  = $bodies;
			}

</%perl>
			<div class="row">

				<span class="third marno">
					# of individuals in your party
				</span>

				<span class="twothirds">
					<input
						size  = "5"
						type  = "number"
						min   = 0
						max   = 9999
						name  = "individuals"
						value = "<% $school_settings{"individuals"} %>"
					>
				</span>

			</div>

%		}

%		if ($tourn_settings{"school_codes"} eq "registrant") {

			<div class="row">

				<span class="third marno">
					Your School Code*
				</span>

				<span class="twothirds">
					<input
						size      = "10"
						type      = "text"
						name      = "school_code"
						value     = "<% ($school->code) ? $school->code : "" %>"
						maxlength = "6">
				</span>

			</div>
%		}

%		if ($tourn_settings{"refund_information"}) {

			<span class="twothirds nospace martopmuchmore">
				<h5 class="nospace semibold">
					Overpayments &amp; refunds
				</h5>
			</span>
			<span class="third nospace rightalign redtext semibold martopmuchmore">
				Deadline: <&
					"/funclib/showdate.mas",
					dt     => $tourn_settings{"refund_deadline"},
					length => "medium"
				&> at <&
					"/funclib/showtime.mas",
					dt => $tourn_settings{"refund_deadline"}
				&>
			</span>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">

%					if ($tourn_settings{"refund_judge_bond"}) {
<%perl>
						if ($tourn_settings{"nsda_nats"}
							|| $tourn_settings{"nsda_ms_nats"}
						) {

</%perl>
							<div class="padleftmore padbottom bigger">
								<% $tourn_settings{"judgebond_message"} %>
							</div>

							<div class="row">

								<span class="third semibold">
									Preferred refund method:
								</span>

								<span class="twothirds semibold">

									<label for="credit">
										<span class="half hover">
											<input
												type     = "radio"
												name     = "refund_method"
												id       = "credit"
												value    = "credit"
												onChange = "toggleRefund('credit');"
												<% $school_settings{'refund_method'} eq "credit"
													? "checked"
													: ""
												%>
											> Credit towards 2019
										</span>
									</label>

									<label for="check">
										<span class="half hover">
											<input
												type     = "radio"
												name     = "refund_method"
												id       = "check"
												value    = "check"
												onChange = "toggleRefund('check');"
												<% $school_settings{'refund_method'} eq "check"
													? "checked"
													: ""
												%>
											> Check
										</span>
									</label>
								</span>
							</div>
%						}
%					}

					<div class="refundcheck <% $school_settings{'refund_method'} eq "check"
						? ""
						: "hidden"
					%> toggle">

						<div class="row padvert">

							<span class="third semibold bluetext">
								Make refund checks payable to:
							</span>

							<span class="twothirds">
								<input
									type  = "text"
									name  = "refund_payable"
									size  = "64"
									value = "<% $school->setting('refund_payable') %>"
								>
							</span>

						</div>

						<div class="row">

							<span class="third semibold bluetext">
								Address to send refund checks
							</span>

							<span class="twothirds">
								<textarea
									name = "refund_address"
									cols = "48"
									rows = "4"
								><% $school->setting('refund_address') %></textarea>
							</span>

						</div>

					</div>

					<div class="libl rightalign marvertno padvertless padrightmore">
						<span class="true quarter centeralign nospace">
							<input  type="submit" value="Save Refund Info">
						</span>
					</div>

				</span>
			</div>

%		}

	</form>

	<div class="full martopmore nospace">

		<span class="twothird nospace">
			<h5 class="martopmore semibold">
				Tournament Deadlines
			</h5>
		</span>

		<span class="third martopmore rightalign semibold purpletext">
			All times are in <% Tab::tzname($tz) %>
		</span>

	</div>

	<div class="centeralign nospace">
		<span class="ninetenths leftalign">

<%perl>
			if ($tourn_settings{"nsda_district"}) {

				foreach my $weekend ($tourn->weekends()) {

					$m->print('<h6 class="martopmore semibold">'.$weekend->name."</h6>");

					$m->comp("deadlines.mas",
						object => $weekend,
						nats   => $tourn_settings{"nsda_nats"},
						tz     => $tourn->tz
					);

				}

			} else {

				my @deadlines = (
					"drop_deadline",
					"freeze_deadline",
					"judge_deadline",
					"fine_deadline",
					"supp_deadline"
				);

				foreach my $deadline (@deadlines) {
					Tab::Tourn->columns(TEMP => $deadline);
					$tourn->$deadline($tourn_settings{$deadline});
				}

				$m->comp("deadlines.mas",
					object => $tourn,
					nats   => $tourn_settings{"nsda_nats"},
					tz     => $tourn->tz
				);

			}

			foreach my $category ($tourn->categories) {

				my $deadline = $category->setting("deadline");
				my $strike_start = $category->setting("strike_start");
				my $strike_end = $category->setting("strike_end");

				if ($deadline) {

</%perl>
					<div class="row">

						<span class="semibold smallish half">
							<% $category->name %> judges are due by:
						</span>

						<span class="smallish half">
							<% &Tab::nicedt($deadline->set_time_zone($tourn->tz)) %>
						</span>

					</div>

%				}

%				if ($strike_start) {

					<div class="full row marno padless small">

						<span class="semibold threefifths bluetext">
							<% $category->name %> prefs/strikes open:
						</span>

						<span class="quarter">
							<% &Tab::nicedate($strike_start->set_time_zone($tourn->tz)) %>
						</span>

						<span class="eighth">
							<% &Tab::nicetime($strike_start->set_time_zone($tourn->tz)) %>
						</span>

					</div>

%				}

%				if ($strike_end) {

					<div class="full row marno padless small">

						<span class="semibold threefifths bluetext">
							<% $category->name %> prefs/strikes deadline
						</span>

						<span class="quarter">
							<% &Tab::nicedate($strike_end->set_time_zone($tourn->tz)) %>
						</span>

						<span class="eighth">
							<% &Tab::nicetime($strike_end->set_time_zone($tourn->tz)) %>
						</span>

					</div>
<%perl>

				}
			}

			foreach my $concession ($tourn->concessions) {

				next unless $concession->deadline;

</%perl>
				<div class="full row marno padless small">

					<span class="semibold threefifths">
						<% $concession->name %> orders are due by:
					</span>

					<span class="quarter">
						<%
							Tab::nicedate($concession->deadline->set_time_zone($tz))
						%>
					</span>

					<span class="eighth">
						<%
							Tab::nicetime($concession->deadline->set_time_zone($tz))
						%>
					</span>

				</div>
%			}

			</span>
		</div>

<%perl>
		if ($tourn_settings{"disclaimer"}) {

			my $disclaimed = Tab::Person->retrieve($school_settings{"disclaimed"});
			my $disclaimed_at = $school_settings{'disclaimed_at'};
			$disclaimed_at->set_time_zone($tz) if $disclaimed_at;
</%perl>

			<div class="full martopmore">
				<span class="nospace third">
					<h5>
						Notes &amp; Disclaimer
					</h5>
				</span>

%				if ($disclaimed) {

					<span class="nospace twothirds rightalign">
						<p class="explain marno padless semibold purpletext">
							Agreed to by
							<% $disclaimed->first." ".$disclaimed->last." (".$disclaimed->email.")" %>
							on <% Tab::nicedt($disclaimed_at) %>
						</p>
					</span>

%				} else {

					<span class="nospace twothirds rightalign">
						<span class="buttonwhite redtext">
							No Coach Agreed
						</span>
					</span>
%				}

			</div>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">
					<div class="padmuchmore borderredthin semibold bluetext">
						<% $tourn_settings{"disclaimer"}%>
					</div>
				</span>
			</div>
%		}
	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Printouts</h4>

%			if ($tourn_settings{"nsda_nats"}) {
				<a
					href="/register/reports/problem_children.mhtml?school_id=<% $school->id %>"
					class="yellow full"
				>
					Print Updated Problem Sheet
				</a>
%			}

			<a
				href="entry_print.mhtml?school_id=<% $school->id %>"
				class="blue full"
			>
				<span class="nospace half">
					Print Registration
				</span>
				<span class="nospace half">
					By Event
				</span>
			</a>

			<a
				href="by_person_print.mhtml?school_id=<% $school->id %>"
				class="blue full"
			>
				<span class="nospace half">
					Print Registration
				</span>
				<span class="nospace half">
					By Competitor
				</span>
			</a>

			<a
				href="entry_csv.mhtml?school_id=<% $school->id %>"
				class="blue full"
			>
				Excel Registration
			</a>

%			unless ($tourn_settings{"nsda_ms_nats"} || $tourn_settings{"nsda_nats"}) {
				<a
					href="invoice_print.mhtml?school_id=<% $school->id %>"
					class="blue full martop"
				>
					Print Tournament Invoice
				</a>

				<hr />
%			}

<%perl>

	   my ($payments, $payments_ref) = $m->comp(
		   "/funclib/school_fees.mas",
			   school   => $school,
			   payments => 1
		   );

		unless ($payments
			|| ($now > $tourn_settings{"freeze_deadline"}
			|| $tourn_settings{"nsda_district"}
			|| $tourn_settings{"nsda_nats"}
		) ) {

			my $warn = "This will drop your entire entry, including any spots on waitlists.  Be very sure!";

</%perl>
			<a
				href  = "drop_school.mhtml?school_id=<% $school->id %>"
				class = "dkred full martopmore"
				<& "/funclib/confirm.mas", warn => $warn &>
			>
				DROP ENTIRE ENTRY
			</a>

%		}

		</div>

%		my @forms = $tourn->files( type  => "school_form");

%		if (@forms) {

			<div class="sidenote">

				<h4>School Entry Forms</h4>

%				foreach my $form (@forms) {
					<& "/funclib/school_forms.mas", school => $school, form => $form &>
%				}

			</div>

%		}

		<div class="sidenote">

			<h4>School Contacts</h4>

<%perl>
			my @followers = Tab::Follower->search(
				school => $school->id,
				type   => 'contact'
			);

</%perl>

			<p class="semibold bluetext leftalign padno">
				Get tournament emails &amp; announcements
			</p>

%			foreach my $follower (@followers) {

				<a
					class = "blue full"
					href  = "school_unfollow.mhtml?follower_id=<% $follower->id %>&school_id=<% $school->id %>"
				>
					<% $follower->follower
						? $follower->follower->first." ".$follower->follower->last
						: $follower->email
					%>
				</a>
%			}


				<form
					action="school_follow.mhtml"
					method="post"
				>

				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input
					type  = "hidden"
					name  = "type"
					value = "contact"
				>

				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>

				<div class="row">

					<span class="threequarter nospace centeralign">
						<input
							type        = "text"
							class       = "thin"
							name        = "email"
							size        = "24"
						>
					</span>

					<span class="nospace quarter">
						<input
							type  = "submit"
							value = "Go"
							class = "thin">
					</span>

				</div>

				</form>

			</form>

			<h4 class="martopmore">
				Live updates
			</h4>

<%perl>

			@followers = Tab::Follower->search(
				school => $school->id,
				type   => 'school'
			);

</%perl>

%			if (@followers) {
				<p class="explain smaller padless">
					The following people will receive emailed pairings for the
					school in one message:
				</p>
%			}

%			foreach my $follower (@followers) {

				<a
					class = "blue full"
					href  = "school_unfollow.mhtml?follower_id=<% $follower->id %>&school_id=<% $school->id %>"
				>
					<% $follower->follower
						? $follower->follower->first." ".$follower->follower->last
						: $follower->email
					%>
				</a>
%			}

			<p class="semibold bluetext leftalign padno">
				Get all pairings (email only; no SMS/text)
			</p>

				<form
					action="school_follow.mhtml"
					method="post"
				>

				<input
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>

				<div class="row">

					<span class="threequarter nospace centeralign">
						<input
							type        = "text"
							class       = "thin"
							name        = "email"
							size        = "24"
						>
					</span>

					<span class="nospace quarter">
						<input
							type  = "submit"
							value = "Go"
							class = "thin">
					</span>

				</div>

				</form>

			</form>

		</div>

%		if ($tourn_settings{"nsda_ms_nats"} || $tourn_settings{"nsda_nats"}) {

			<div class="sidenote">

				<h4>Privacy Notice</h4>

				<p class="biggish">
					The information on this page will be used only for emergency
					contact during the national tournament. The contact number you
					provide will be used in the event of a medical emergency
					involving one of your students or a tournament related problem
					such as a missing ballot. The hotel information is used to
					locate you in the event of an emergency.
				</p>

			</div>
%		}


<%perl>

		if ($tourn_settings{"nsda_district"}) {

			$m->comp(
				"/funclib/chapter_nsda_update.mas",
				chapter =>  $school->chapter
			);

		}

</%perl>

	</div>

	<script>

		function toggleRefund(thing) {

			$(".toggle").addClass("hidden");
			$(".refund"+thing).removeClass("hidden");

		}

	</script>

