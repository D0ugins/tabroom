<%args>
	$person
	$session
	$school
	$tourn
	$disclaimed => undef
</%args>
<%init>

	use POSIX;

	my %tourn_settings = $tourn->all_settings;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now(time_zone => $tz);

	my $year = $tourn->start->year;

	my %school_settings = $school->all_settings();

	if ($tourn_settings{"disclaimer"}) { 

		if ($disclaimed) { 

			$school->setting("disclaimed", $person->id);
			$school->setting("disclaimed_at", "date", $now);

		} elsif ($school_settings{"disclaimed"}) { 

		} else { 

			$m->redirect("disclaimer.mhtml?school_id=".$school->id) 
		}

	}


	my @empties = $m->comp(
		"/funclib/school_empty_entries.mas", 
		school => $school
	);

	my %reasons;

    %reasons = $m->comp(
        "/funclib/judgemath/nats_check_judging.mas", 
        school => $school
    ) if $tourn_settings{"nsda_nats"};

</%init>

	<div class="main">

		<& "tabbar.mas", 
			school         => $school,
			whoami         => "tourn",
			tourn_settings => \%tourn_settings,
			reasons        => \%reasons
		&>

%		if ($tourn_settings{"registration_message"}) { 

			<div class="full padmore">
				<% $tourn_settings{"registration_message"} %>
			</div>
%		}

%		if (@empties) { 

			<div class="full bluetext warnbox centeralign">

				<h5 class="redtext">
					Something has gone horribly, horribly wrong!
				</h5>

				There are no competitors assigned to entries: 

%					foreach my $empty (@empties) { 

						<div class="full centeralign">
							<a 
								href="/user/enter/details.mhtml?school_id=<% $school->id %>&entry_id=<% $empty->id %>"
								class="button dkred"
							>
								<% $empty->code %> in
								<% $empty->event->abbr %>
							</a>
						</div>
%					}

				Please assign competitors to these entries or they will not
				advance or receive points.
			</div>

%		}


%		if ($tourn_settings{"ask_regions"}) { 

			<h3>Region</h3>

			<form action="region_save.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "school_id"
				value = "<% $school->id %>"
			>

			<div class="row">
				<span class="half">
					Your Region/District:
				</span>

				<span class="third">
					<select 
						name="region_id" 
						class="fixedmed"
					>

						<option value="">Please choose one:</option>

%						foreach my $region ($tourn->regions) { 
							<option 
								value="<% $region->id %>" 
								<% $region->id == $school->region 
									? 'selected="selected"' 
									: ""
								%>
							><% $region->name %></option>
%						}
					</select>
				</span>

				<span class="sixth">
					<input 
						type  = "submit"
						value = "Save"
						class = "thin"
					>
				</span>

				</form>
			</div>
			
%		}

		<h6 class="martopmore semibold">
			Adult Contact Information
		</h6>
	
<%perl>

		if ($tourn_settings{"require_adult_contact"} && !(
               $school_settings{"contact_name"} 
			   && $school_settings{"contact_email"} 
			   && $school_settings{"contact_number"} 
			   #if you listen closely, you can hear the loudest sigh in the world
           )) { 

</%perl>
			<p class="semibold bigger redtext centeralign">
				Adult contact information is required before you can continue with
				registration.
			</p>
%		}

		<form action="contact_save.mhtml" method="post">

		<input 
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input 
			type  = "hidden"
			name  = "tourn_id"
			value = "<% $tourn->id %>"
		>

		<div class="yellowrow smallish semibold">

			<span class='tenth marno centeralign'>
			</span>

			<span class='threetenths'>
				Name
			</span>

			<span class='threetenths'>
				Email
			</span>

			<span class='threetenths'>
				Phone
			</span>
		</div>

		<div class="row">

			<span class="tenth semibold bluetext marno centeralign padno">
				All
			</span>

			<span class="threetenths">
				<input 
					size  = "24"
					type  = "text"
					name  = "contact_name"
					value = "<% $school_settings{"contact_name"} %>"
				>
			</span>

			<span class="threetenths">
				<input 
					size  = "24"
					type  = "email"
					name  = "contact_email"
					value = "<% $school_settings{"contact_email"} %>"
				>
			</span>

			<span class="threetenths">
				<input 
					size  = "24"
					type  = "tel"
					name  = "contact_number"
					value = "<% Tab::phone($school_settings{"contact_number"}) %>"
				>
			</span>

		</div>

<%perl>
		if ($tourn_settings{"category_adult_contact"}) { 

			my %contacts = eval{ 
				return %{JSON::decode_json($school->setting('category_contacts'))};
			};  

			foreach my $category ($m->comp("/funclib/school_categories.mas", school => $school)) {
</%perl>

				<div class="row">

					<span class="tenth semibold bluetext marno centeralign padno">
						<% $category->name %>
					</span>

					<span class="threetenths">
						<input 
							type  = "text"
							name  = "<% $category->id %>_name"
							size  = "24"
							value = "<% $contacts{$category->id}{"name"} %>"
						>
					</span>

					<span class="threetenths">
						<input 
							type  = "email"
							name  = "<% $category->id %>_email"
							size  = "24"
							value = "<% $contacts{$category->id}{"email"} %>"
						>
					</span>

					<span class="threetenths">
						<input 
							type  = "tel"
							name  = "<% $category->id %>_phone"
							size  = "24"
							value = "<% Tab::phone($contacts{$category->id}{"phone"}) %>"
						>
					</span>


				</div>
%			}
%		}

%		if ($tourn_settings{"nsda_nats"} || $tourn_settings{"nsda_ms_nats"}) { 

			<div class="row">

				<span class="third marno">
					<div class="full marno padless">
						Secondary Cell Phone
					</div>

					<div class="full explain nospace redtext padleft">
						In case the primary contact is unreachable.
					</div>
				</span>
				
				<span class="twothirds">
					<input 
						size  = "48"
						type  = "tel"
						name  = "second_contact_number"
						value = "<% Tab::phoneme($school_settings{"second_contact_number"}) %>"
					>
				</span>

			</div>
%		}

%		if ($tourn_settings{"nsda_nats"}) { 

			<div class="row"> 

				<span class="third marno">
					Tournament Book Coaches
				</span>

				<span class="twothirds padsetting">
						<%
							$m->comp("/funclib/school_tbook.mas", 
								school => $school, 
								text => 'yup'
							)
						%>
				</span>

			</div>

			<div class="row"> 

				<span class="third marno">
					<div class="full marno padless">
						Additional T-Book Coaches
					</div>

					<div class="full explain nospace redtext padleft">
						Separate each coach name with commas
					</div>
				</span>

				<span class="twothirds">
%					if ($now > $tourn->reg_end) { 
						<input 
							type  = "hidden"
							name  = "tbook_coaches"
							size  = "48"
							value = "<% $school->setting("tbook_coaches") %>"
						> 
						<% $school->setting("tbook_coaches") %>
%					} else { 
						<input 
							type  = "text"
							name  = "tbook_coaches"
							size  = "48"
							value = "<% $school->setting("tbook_coaches") %>"
						> 
%					}
				</span>

			</div>

%		}


%		if ($tourn_settings{"nsda_ms_nats"}) { 

			<div class="row">

				<span class="third marno">
					Coaches (for recognition on team awards)
				</span>
				
				<span class="twothirds">
					<textarea 
						cols  = "48"
						rows  = "3"
						type  = "text"
						name  = "coaches"
					><% $school->chapter->setting("coaches")  %></textarea>
				</span>
			</div>
%		}

%		my @hotels = $tourn->hotels();

%		if (@hotels) { 

			<div class="full nospace">
				<h6 class="martopmore semibold">
					Hotel Information
				</h6>
			</div>

%			if ($tourn_settings{"hotel_message"}) { 
				<div class="biggish semibold">
					<% $tourn_settings{"hotel_message"} %>
				</div>
%			}


				<div class="row">

					<span class="quarter">
						Hotel
					</span>

					<span class="threequarters">
						<select name="hotel" class="fixedbigger">

<%perl>

						foreach my $hotel (
							sort {
							$b->multiple cmp $a->multiple
							|| $b->surcharge cmp $a->surcharge
							|| $a->name cmp $b->name
							} @hotels
						) { 

</%perl>
							<option value="<% $hotel->id %>"  
								<% $hotel->id == $school_settings{"hotel"}
									? 'selected="selected"' 
									: ""   
								%>
							><% $hotel->name %> <%   
									$hotel->multiple > 1  
									? "(Entry fee surcharge of ".$hotel->multiple."X applies)" 
									: ""   
							%>
							<%   
									$hotel->surcharge > 0
									? "(Surcharge of \$".$hotel->surcharge." per competitor applies)" 
									: ""   
							%><%   
									$hotel->surcharge < 0
									? "(\$".abs($hotel->surcharge)."/competitor discount)" 
									: ""   
							%></option>
							</option>
%						} 
					
						</select>

					</span>

				</div>

			<div class="libl rightalign marvertno padvertless padrightmore">
				<input  type="submit" value="Save">
			</div>

%		} elsif ($tourn_settings{"nsda_ms_nats"}) { 

				<div class="row">

					<span class="third marno">
						Hotel You Are Staying At
					</span>
					
					<span class="twothirds">
						<input 
							size  = "48"
							type  = "text"
							name  = "contact_hotel"
							value = "<% $school_settings{"contact_hotel"}  %>"
						>
					</span>

				</div>

			<div class="row">

				<span class="third marno">
					Number of hotel rooms booked
				</span>
				
				<span class="twothirds">
					<input 
						size  = "48"
						type  = "number"
						min   = 0
						max   = 999
						name  = "contact_hotel_rooms"
						value = "<% $school_settings{"contact_hotel_rooms"}  %>"
					>
				</span>

			</div>

			<& "/funclib/datepicker.mas", 
				id  => "hotel_checkout",
				min => $tourn->start
			&> 

			<div class="row">

				<span class="third marno">
					Hotel checkout date
				</span>
				
				<span class="twothirds">
					<input 
						id    = "hotel_checkout"
						size  = "16"
						type  = "text"
						name  = "contact_hotel_checkout"
						value = "<%
							$school_settings{"contact_hotel_checkout"}
							? Tab::pickerdate($school_settings{"contact_hotel_checkout"})
							: Tab::pickerdate($tourn->end->add(days => 1))
						%>"
					>
				</span>

			</div>

%		}

<%perl>

		if ($tourn_settings{"per_person_fee"}) { 

			my $bodies = $m->comp("/funclib/school_bodies.mas", school => $school);

			if ($school_settings{"individuals"} < $bodies) { 
				$school->setting("individuals", $bodies);
				$school_settings{"individuals"}  = $bodies;
			}
			
</%perl>
			<div class="row">

				<span class="third marno">
					# of individuals in your party
				</span>
			
				<span class="twothirds">
					<input 
						size  = "5"
						type  = "number"
						min   = 0
						max   = 9999
						name  = "individuals"
						value = "<% $school_settings{"individuals"} %>"
					>
				</span>

			</div>

%		}

%		if ($tourn_settings{"school_codes"} eq "registrant") { 

			<div class="row">

				<span class="third marno">
					Your School Code*
				</span>
		
				<span class="twothirds">
					<input 
						size      = "10"
						type      = "text"
						name      = "school_code"
						value     = "<% ($school->code) ? $school->code : "" %>"
						maxlength = "6">
				</span>

			</div>
%		}

%		if ($tourn_settings{"refund_information"}) { 

			<span class="twothirds nospace martopmuchmore">
				<h6 class="nospace semibold">
					Overpayments &amp; refunds	
				</h6>
			</span>
			<span class="third nospace rightalign redtext semibold martopmuchmore">
				Deadline: <& 
					"/funclib/showdate.mas", 
					dt     => $tourn_settings{"refund_deadline"},
					length => "medium"
				&> at <& 
					"/funclib/showtime.mas", 
					dt => $tourn_settings{"refund_deadline"}
				&>
			</span>

<%perl>
			if ($tourn_settings{"refund_judge_bond"}) {

				if ($tourn_settings{"nsda_nats"} 
					|| $tourn_settings{"nsda_ms_nats"}
				) { 
					
</%perl>
					<div class="padleftmore bordertop padbottom">
						<% $tourn_settings{"judgebond_message"} %>
					</div>

					<div class="row">

						<span class="third semibold">
							Preferred refund method:
						</span>

						<span class="twothirds semibold">
			
							<label for="credit">
								<span class="half hover">
									<input 
										type     = "radio"
										name     = "refund_method"
										id       = "credit"
										value    = "credit"
										onChange = "toggleRefund('credit');"
										<% $school_settings{'refund_method'} eq "credit" 
											? "checked" 
											: ""
										%>
									> Credit towards 2019
								</span>
							</label>

							<label for="check">
								<span class="half hover">
									<input 
										type     = "radio"
										name     = "refund_method"
										id       = "check"
										value    = "check"
										onChange = "toggleRefund('check');"
										<% $school_settings{'refund_method'} eq "check" 
											? "checked" 
											: ""
										%>
									> Check
								</span>
							</label>
						</span>
					</div>

%				}

				<div class="refundcheck <% $school_settings{'refund_method'} eq "check" 
					? "" 
					: "hidden" 
				%> toggle">

					<div class="row padvert">

						<span class="third semibold bluetext">
							Make refund checks payable to:
						</span>

						<span class="twothirds">
							<input 
								type  = "text"
								name  = "refund_payable"
								size  = "64"
								value = "<% $school->setting('refund_payable') %>"
							>
						</span>

					</div>

					<div class="row">

						<span class="third semibold bluetext">
							Address to send refund checks
						</span>

						<span class="twothirds">
							<textarea 
								name = "refund_address"
								cols = "48"
								rows = "4"
							><% $school->setting('refund_address') %></textarea>
						</span>

					</div>

				</div>

%			}

%		}

		<div class="libl rightalign marvertno padvertless padrightmore">
			<input  type="submit" value="Save">
			</form>
		</div>

			<div class="full martopmore nospace">

				<span class="twothird nospace">
					<h6 class="martopmore semibold">Tournament Deadlines:</h6>
				</span>

				<span class="third martopmore rightalign semibold purpletext">
					All times are in <% Tab::tzname($tz) %>
				</span>

			</div>

<%perl>
			if ($tourn_settings{"nsda_district"}) { 

				foreach my $weekend ($tourn->weekends()) { 

					$m->print('<h6 class="martopmore semibold">'.$weekend->name."</h6>");

					$m->comp("deadlines.mas", 
						object => $weekend,
						nats   => $tourn_settings{"nsda_nats"},
						tz     => $tourn->tz
					);

				}

			} else { 

				my @deadlines = (
					"drop_deadline",
					"freeze_deadline",
					"judge_deadline",
					"fine_deadline",
					"supp_deadline"
				);

				foreach my $deadline (@deadlines) { 
					Tab::Tourn->columns(TEMP => $deadline);
					$tourn->$deadline($tourn_settings{$deadline});
				}

				$m->comp("deadlines.mas", 
					object => $tourn,
					nats   => $tourn_settings{"nsda_nats"},
					tz     => $tourn->tz
				);

			}
   			
			foreach my $category ($tourn->categories) {

				my $deadline = $category->setting("deadline");
				my $strike_start = $category->setting("strike_start");
				my $strike_end = $category->setting("strike_end");
   		
				if ($deadline) { 
			
</%perl>
					<div class="row">
		
						<span class="semibold smallish half">	
							<% $category->name %> judges are due by:
						</span>

						<span class="smallish half">
							<% &Tab::nicedt($deadline->set_time_zone($tourn->tz)) %>
						</span>

					</div>
			
%				}

%				if ($strike_start) { 

					<div class="full row marno padless small">

						<span class="semibold threefifths bluetext">
							<% $category->name %> prefs/strikes open:
						</span>

						<span class="quarter">
							<% &Tab::nicedate($strike_start->set_time_zone($tourn->tz)) %>
						</span>

						<span class="eighth">
							<% &Tab::nicetime($strike_start->set_time_zone($tourn->tz)) %>
						</span>

					</div>
					
%				}

%				if ($strike_end) { 

					<div class="full row marno padless small">

						<span class="semibold threefifths bluetext">
							<% $category->name %> prefs/strikes deadline
						</span>

						<span class="quarter">
							<% &Tab::nicedate($strike_end->set_time_zone($tourn->tz)) %>
						</span>

						<span class="eighth">
							<% &Tab::nicetime($strike_end->set_time_zone($tourn->tz)) %>
						</span>

					</div>
<%perl>

				}
			}

			foreach my $concession ($tourn->concessions) {

				next unless $concession->deadline;

</%perl>
				<div class="full row marno padless small">

					<span class="semibold threefifths">
						<% $concession->name %> orders are due by:
					</span>

					<span class="quarter">
						<%
							Tab::nicedate($concession->deadline->set_time_zone($tz))
						%>
					</span>

					<span class="eighth">
						<%
							Tab::nicetime($concession->deadline->set_time_zone($tz))
						%>
					</span>

				</div>
%			}
			
<%perl>


		if ($tourn_settings{"disclaimer"}) { 

			my $disclaimed = Tab::Person->retrieve($school_settings{"disclaimed"});
			my $disclaimed_at = $school_settings{'disclaimed_at'};
			$disclaimed_at->set_time_zone($tz) if $disclaimed_at;

</%perl>

			<div class="full martopmore">

				<span class="nospace third"> 

					<h6 class="semibold">
						Notes/Disclaimer
					</h6>

				</span>

%				if ($disclaimed) { 

					<span class="nospace twothirds rightalign"> 

						<p class="explain marno padless semibold purpletext">
							Agreed to by 
							<% $disclaimed->first." ".$disclaimed->last." (".$disclaimed->email.")" %>
							on <% Tab::nicedt($disclaimed_at) %>
						</p>
					</span>

%				} else { 

					<span class="nospace twothirds rightalign"> 

						<span class="buttonwhite redtext">
							No Coach Agreed
						</span>

					</span>
%				} 

				</div>

			<div class="padmuchmore borderredthin semibold bluetext">
				<% $tourn_settings{"disclaimer"}%>
			</div>

%		}

	</div>

	<div class="menu">
	
		<div class="sidenote">

			<h4>Printouts</h4>

			<a 
				href="entry_print.mhtml?school_id=<% $school->id %>" 
				class="blue full"
			>
				<span class="nospace half">
					Print Registration 
				</span>
				<span class="nospace half">
					By Event
				</span>
			</a>

			<a 
				href="by_person_print.mhtml?school_id=<% $school->id %>" 
				class="blue full"
			>
				<span class="nospace half">
					Print Registration 
				</span>
				<span class="nospace half">
					By Competitor
				</span>
			</a>

			<a 
				href="entry_csv.mhtml?school_id=<% $school->id %>" 
				class="blue full"
			>
				Excel Registration
			</a>

%			unless ($tourn_settings{"nsda_ms_nats"} || $tourn_settings{"nsda_nats"}) { 
				<a 
					href="invoice_print.mhtml?school_id=<% $school->id %>" 
					class="blue full martop"
				>
					Print Tournament Invoice
				</a>

				<hr />
%			}

<%perl>

	   my ($payments, $payments_ref) = $m->comp(
		   "/funclib/school_fees.mas", 
			   school   => $school,
			   payments => 1
		   );

		unless ($payments 
			|| ($now > $tourn_settings{"freeze_deadline"} 
			|| $tourn_settings{"nsda_district"}
			|| $tourn_settings{"nsda_nats"}
		) ) { 

			my $warn = "This will drop your entire entry, including any spots on waitlists.  Be very sure!";

</%perl>
			<a 
				href  = "drop_school.mhtml?school_id=<% $school->id %>" 
				class = "dkred full martopmore"
				<& "/funclib/confirm.mas", warn => $warn &>  
			>
				DROP ENTIRE ENTRY
			</a>

%		}

		</div>

%		my @forms = $tourn->files( type  => "school_form");

%		if (@forms) { 

			<div class="sidenote">

				<h4>School Entry Forms</h4>

%				foreach my $form (@forms) { 
					<& "/funclib/school_forms.mas", school => $school, form => $form &>
%				}

			</div>

%		}


%		unless ($tourn_settings{"nsda_nats"}) { 
		<div class="sidenote">

			<h4>School Contacts</h4>

<%perl>
			my @followers = Tab::Follower->search( 
				school => $school->id,
				type   => 'contact' 
			);

</%perl>

			<p class="semibold bluetext leftalign padno">
				Get tournament emails &amp; announcements
			</p>

%			foreach my $follower (@followers) { 

				<a 
					class = "blue full" 
					href  = "school_unfollow.mhtml?follower_id=<% $follower->id %>&school_id=<% $school->id %>"
				>
					<% $follower->follower 
						? $follower->follower->first." ".$follower->follower->last 
						: $follower->email
					%>
				</a>
%			}


				<form 
					action="school_follow.mhtml" 
					method="post"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input 
					type  = "hidden"
					name  = "type"
					value = "contact"
				>

				<input 
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>
			
				<div class="row">
				
					<span class="threequarter nospace centeralign">
						<input 
							type        = "text"
							class       = "thin"
							name        = "email"
							size        = "24"
						>
					</span>

					<span class="nospace quarter">
						<input 
							type  = "submit"
							value = "Go"
							class = "thin">
					</span>

				</div>

				</form>

			</form>

			<h4 class="martopmore">
				Live updates
			</h4>

<%perl>

			@followers = Tab::Follower->search( 
				school => $school->id,
				type   => 'school' 
			);

</%perl>

%			if (@followers) { 
				<p class="explain smaller padless">
					The following people will receive emailed pairings for the
					school in one message:
				</p>
%			}

%			foreach my $follower (@followers) { 

				<a 
					class = "blue full" 
					href  = "school_unfollow.mhtml?follower_id=<% $follower->id %>&school_id=<% $school->id %>"
				>
					<% $follower->follower 
						? $follower->follower->first." ".$follower->follower->last 
						: $follower->email
					%>
				</a>
%			}

			<p class="semibold bluetext leftalign padno">
				Get all pairings (email only; no SMS/text)
			</p>

				<form 
					action="school_follow.mhtml" 
					method="post"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input 
					type  = "hidden"
					name  = "tourn_id"
					value = "<% $tourn->id %>"
				>
			
				<div class="row">
				
					<span class="threequarter nospace centeralign">
						<input 
							type        = "text"
							class       = "thin"
							name        = "email"
							size        = "24"
						>
					</span>

					<span class="nospace quarter">
						<input 
							type  = "submit"
							value = "Go"
							class = "thin">
					</span>

				</div>

				</form>

			</form>

		</div>

%		}

%		if ($tourn_settings{"nsda_ms_nats"} || $tourn_settings{"nsda_nats"}) { 

			<div class="sidenote">

				<h4>Privacy Notice</h4>

				<p class="biggish">
					The information on this page will be used only for emergency
					contact during the national tournament. The contact number you
					provide will be used in the event of a medical emergency
					involving one of your students or a tournament related problem
					such as a missing ballot. The hotel information is used to
					locate you in the event of an emergency.
				</p>

			</div>
%		}


<%perl>

		if ($tourn_settings{"nsda_district"}) { 

			$m->comp(
				"/funclib/chapter_nsda_update.mas", 
				chapter =>  $school->chapter
			);

		}

</%perl>

	</div>

	<script>

		function toggleRefund(thing) { 

			$(".toggle").addClass("hidden");
			$(".refund"+thing).removeClass("hidden");

		}

	</script>

