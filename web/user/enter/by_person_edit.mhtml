<%args> 
	$school
	$student_id => undef
	$entry_id   => undef
</%args>
<%init>

	my $tourn = $school->tourn;

	my $student = Tab::Student->retrieve($student_id);

	$m->abort unless $student;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now;

	my $reg_end = $tourn->reg_end;

	my @entries = $m->comp(
		"/funclib/student_entries.mas", 
			student => $student,
			tourn   => $tourn
	);

	my %ok_events = $m->comp(
		"/funclib/student_clear_events.mas", 
			student => $student,
			school  => $school
	);

	my $hide_codes = $tourn->setting("hide_codes");
	my $freeze_deadline = $tourn->setting("freeze_deadline");

	$freeze_deadline = $tourn->reg_end unless $freeze_deadline;
	$freeze_deadline->set_time_zone($tz);

</%init>

	<script>

		function showEntry(entryID) { 
			$("#"+entryID).toggleClass("hidden");
			$("#button_"+entryID).toggleClass("invert");

		};

		$(document).ready(function() { 
			$(".hideme").addClass('hidden');
		});

	</script>

	<div class="menu">

		<div class="sidenote">

			<h4>Competitor</h4>

			<div class="row full">
				<% $student->first." ".$student->middle." ".$student->last %>
			</div>

			<div class="row full">
				Graduates: <% $student->grad_year %>
			</div>

			<div class="row full">
				<% $student->person ? $student->person->email : "" %>
			</div>

		</div>

%		if ($tourn->setting("housing")) { 

			<div class="sidenote">

				<h4>Housing for <% $student->first %></h4>

					<div class="row">

						<span class="quarter">
							Gender:
						</span>

						<span class="threequarters">

							<form action="sex_change.mhtml" method="post">

							<input
								type = "hidden"
								name = "return_to"
								value= "by_person"
							>

							<input 
								type  = "hidden"
								name  = "student_id"
								value = "<% $student->id %>">

							<input 
								type  = "hidden"
								name  = "school_id"
								value = "<% $school->id %>"
							>

							<label for="F">
								<span class="third marno hover centeralign">

									F
									<input 
										type     = "radio"
										name     = "gender"
										value    = "F"
										id       = "F"
										onChange = "this.form.submit();"
										<% ($student->gender eq "F") ? "checked" : "" %> 
									>

								</span>
							</label>

							<label for="M">
								<span class="third marno hover centeralign">

									M
									<input 
										type     = "radio"
										name     = "gender"
										value    = "M"
										id       = "M"
										onChange = "this.form.submit();"
										<% ($student->gender eq "M") ? "checked" : "" %>
									>

								</span>
							</label>

							<label for="O">
								<span class="third marno hover centeralign">

									O
									<input 
										type     = "radio"
										name     = "gender"
										value    = "O"
										id       = "O"
										onChange = "this.form.submit();"
										<% ($student->gender eq "O") ? "checked" : "" %>
									>

								</span>
					
								</form>

							</label>

						</span>

					</div>

%					my @days = $m->comp("/funclib/tourn_days.mas", tourn => $tourn, add_one => "aye");

%				   	foreach my $day (sort {$a->epoch <=> $b->epoch} @days) {

%					   next unless Tab::HousingSlots->search( night => $day->ymd, tourn => $tourn->id );

						<div class="row">

							<span class="quarter">
								<% $day->day_abbr %>
							</span>

%   						my $housing = $student->housing($tourn, $day);

%	   						if ($housing) {

%								if ($housing->waitlist) { 
									<span 
										class = "orangetext strong quarter"
										title = "On Waitlist"
									> 
										WL
									</span>

%								} else { 

									<span 
										alt   = "Housing Confirmed"
										title = "Housing Confirmed"
										class = "hover quarter fa-2x fa fa-check-circle-o greentext centeralign">
									</span>

%								}
								
								<span class="half centeralign smallish">

%								   if ($now->epoch < $reg_end->epoch) {

										<a 
											title = "Transfer housing to other student"
											class = "bluetext buttonwhite fa fa-edit fa-lg marright"
											href  = "housing_transfer.mhtml?return=byperson&housing_id=<% $housing->id %>&school_id=<% $school->id %>"
										>
										</a>

%										my $warn = "This will DELETE this housing request.  If housing is limited, ";
%										$warn .= "you may want to press the BLUE EDIT icon instead to TRANSFER it ";
%										$warn .= "to another competitor or judge!";

										<a 
											title = "Delete housing request"
											class = "redtext buttonwhite fa fa-trash fa-lg"
											href  = "housing_revoke.mhtml?return=byperson&housing_id=<% $housing->id %>&school_id=<% $school->id %>"
											<& "/funclib/confirm.mas", warn => $warn &>
										>
										</a>
%									}
								</span>

%						  	} else { 

								<span class="threequarters rightalign">

%	                               if ($now->epoch < $reg_end->epoch) {
										<a 
										  class = "dkblue button" 
										  href  = "housing_plz.mhtml?return=byperson&student_id=<% $student->id %>&tourn_id=<% $tourn->id %>&school_id=<% $school->id %>&day=<% $day->ymd %>"
										 >
										  	REQUEST
										</a>
%									} else { 

										<p class="nospace explain">Deadline was <% Tab::niceshortdt($reg_end) %></p>
%									}

								</span>

%							}

						</div>

%					}
			
			</div>

%		}

	</div>

	<div class="main">
	
		<& tabbar.mas, school => $school, whoami => "by_person" &>

		<div class="full nospace">

			<span>
				<a 
					title="Return to full roster"
					href="by_person.mhtml?school_id=<% $school->id %>" 
					class="fa fa-arrow-left fa-2x bluetext"
				></a>

			</span>

			<span class="half">
				<h4><% $student->first." ".$student->last %></h4>
			</span>

%			if (keys %ok_events && ($now->epoch < $reg_end->epoch) ) { 

				<form action="by_person_add.mhtml" method="post">

				<input 
					type  = "hidden"
					name  = "student_id"
					value = "<% $student->id %>"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<span class="twofifths rightalign nospace">

					<span class="half rightalign">
						Add entry in:
					</span>

					<span class="half leftalign">

						<select 
							name     = "event_id"
							class    = "fixedmed"
							onChange = "this.form.submit();"
						>

							<option value=""></option>

%							my @ok_event_keys = 
%								sort {$ok_events{$a}{"name"} cmp $ok_events{$b}{"name"} } 
%								keys %ok_events;

%							foreach my $event_id (@ok_event_keys) {
								<option 
									value="<% $event_id %>"
								> <% $ok_events{$event_id}{"name"} %>
								</option>
%							}

						</select>


					</span>

				</span>
				</form>
%			}

		</div>

		<form action="by_person_save.mhtml" method="post">

		<input 
			type="hidden" 
			name="school_id" 
			value="<% $school->id %>"
		>
		<input 
			type  = "hidden"
			name  = "student_id"
			value = "<% $student->id %>"
		>

<%perl>

		foreach my $entry (@entries) { 

			my $event = $entry->event;

			my $status;
			my $description;
			my $status_class;

			my $hybrid;

			if ($entry && $event->setting("hybrids")) { 

				foreach my $student ($entry->students) { 

					next if $student && $student->chapter->id == $school->chapter->id;

					$hybrid = Tab::School->search({
						tourn   => $tourn->id,
						chapter => $student->chapter->id
					})->first;

				}
				
			}


			if ($entry->dq) { 

				$status	   = "Disqualified";
				$description  = "The tournament officials have disqualified this entry";
				$status_class = "redtext strong";

			} elsif ($entry->dropped) { 

				$status = "Dropped";
				$description  = "This entry has been marked as a drop";
				$status_class = "redtext strong";

			} elsif ($entry->unconfirmed) {

				$description  = "This competitor registered but no coach has confirmed their entry";
				$status_class = "orangetext strong";
				$status = "Unconfirmed";

			} elsif ($entry->waitlist) { 

				$status = "Waitlisted";
				$description  = "This entry is still on the waitlist for a confirmed spot";
				$status_class = "orangetext strong";

			} else {

				$status = "";
				$description  = "This entry is fully regstered into the tournament";
				$status_class = "greentext fa fa-2x fa-check-circle-o centeralign";
			}


</%perl>
			<div class="row full marno">

				<span class="fifth">
					<% $entry->event->name %>
				</span>

%				unless ($hide_codes) { 
					<span class="quarter">
						<% $entry->code %>
					</span>
%				}

				<span class="<% $hide_codes ? "half" : "quarter" %>">
					<% $entry->name %>
					<% $hybrid ? "(Hybrid)" : "" %>
				</span>

				<span class="eighth rightalign <% $status_class %>" title="<% $description %>">
					<% $status %>
				</span>

				<span class="eighth rightalign">
					<a 
						id      = "button_<% $entry->id %>"
						class   = "fa fa-edit fa-sm buttonwhite bluetext <% scalar @entries > 1 ? "" : "invert"  %> "
						onclick = "showEntry(<% $entry->id %>);"
					></a>

%					my $warn = "This will drop ".$entry->code." in ".$event->abbr."  Are you sure?";

					<a 
						id    = "button_<% $entry->id %>"
						class = "fa fa-trash fa-sm buttonwhite redtext marleftmore"
						href  = "entry_drop.mhtml?student_id=<% $student->id %>&entry_id=<% $entry->id %>&school_id=<% $school->id %>&from=by_person"
						<& "/funclib/confirm.mas", warn => $warn &>
					></a>
				</span>

			</div>

			<div class="entryforms <% scalar @entries > 1 ? "hideme" : "" %> " id="<% $entry->id %>">

				<& 
					entry_edit.mas, 
					student => $student,
					entry   => $entry,
					hybrid  => $hybrid
				&>

			</div>

%		}

%		if (@entries) { 

			<div class="liblrow rightalign">
				<input type="submit" value=" Save Changes ">
				</form>
			</div>

%		}

	</div>

