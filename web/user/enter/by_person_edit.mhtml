<%args> 
	$school
	$student_id => undef
	$entry_id   => undef
</%args>
<%init>

	my $tourn = $school->tourn;

	my $student = Tab::Student->retrieve($student_id);

	$m->abort unless $student;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $now = DateTime->now;

	my @entries = $m->comp("/funclib/student_entries.mas", 
		student => $student,
		tourn   => $tourn );

	my %ok_events = $m->comp("/funclib/student_clear_events.mas", 
		student => $student,
		school  => $school );

	my $hide_codes = $tourn->setting("hide_codes");

</%init>

	<script>

		function showEntry(entryID) { 
			$("#"+entryID).toggleClass("hidden");
			$("#button_"+entryID).toggleClass("invert");

		};

	</script>

	<div class="menu">

		<div class="sidenote">

			<div class="row full">
				<% $student->first." ".$student->middle." ".$student->last %>
			</div>

			<div class="row full">
				Graduates: <% $student->grad_year %>
			</div>

			<div class="row full">
				<% $student->person ? $student->person->email : "" %>
			</div>

		</div>

	</div>

	<div class="main">
	
		<h2><% $tourn->name %></h2>
		
		<& menu.mas, school => $school, whoami => "by_person" &>

		<div class="full nospace">

			<span>
				<a 
					title="Return to full roster"
					href="by_person.mhtml?school_id=<% $school->id %>" 
					class="fa fa-arrow-left fa-2x bluetext"
				></a>

			</span>
			<span class="half">
				<h4>Events for <% $student->first." ".$student->last %></h4>
			</span>

%			if (keys %ok_events) { 

				<form action="by_person_add.mhtml" method="post">

				<span class="twofifths rightalign nospace">

					<span class="half rightalign">

						<input type="hidden" name="student_id" value="<% $student->id %>">
						Add entry in:

					</span>

					<span class="half leftalign">

						<select name="event_id" class="fixedmed">

							<option value=""></option>

%							foreach my $event_id (sort {$ok_events{$a}{"name"} cmp $ok_events{$b}{"name"} } keys %ok_events) { 
								<option 
									value="<% $event_id %>"
								> <% $ok_events{$event_id}{"name"} %>
								</option>
%							}

						</select>


					</span>

				</span>
				</form>
%			}

		</div>

		<form action="by_person_save.mhtml" method="post">
		<input type="hidden" name="school_id" value="<% $school->id %>">
		<input type="hidden" name="student_id" value="<% $student->id %>">

%		foreach my $entry (@entries) { 

<%perl>

			my $event = $entry->event;

			# Code style
			my $code_style = $event->setting("code_style");

			# Titles and authors
			my $ask_for_titles = $event->setting("ask_for_titles");

			# Switch students

			# Hybrid

			# APDA seeds
			my $apda = $event->setting("apda");

			my $max = $event->setting("max_entry");
			my $min = $event->setting("min_entry");

			#quals
			my $ask_quals = $event->setting("ask_quals");
			my $more_quals = $event->setting("more_quals");
			my $at_larges = $event->setting("at_larges");

			my $status;
			my $description;
			my $status_class;

			if ($entry->dq) { 

				$status       = "Disqualified";
				$description  = "The tournament officials have disqualified this entry";
				$status_class = "redtext strong";

			} elsif ($entry->dropped) { 

				$status = "Dropped";
				$description  = "This entry has been marked as a drop";
				$status_class = "redtext";

			} elsif ($entry->unconfirmed) {

				$description  = "This competitor registered but no coach has confirmed their entry";
				$status_class = "orangetext strong";
				$status = "Unconfirmed";

			} elsif ($entry->waitlist) { 

				$status = "Waitlisted";
				$description  = "This entry is still on the waitlist for a confirmed spot";
				$status_class = "orangetext strong";

			} else {

				$status = "";
				$description  = "This entry is fully regstered into the tournament";
				$status_class = "greentext fa fa-2x fa-check-circle-o centeralign";
			}


</%perl>
			<div class="lightrow full marno">

				<span class="quarter">
					<% $entry->event->name %>
				</span>

				<span class="quarter">
%					unless ($hide_codes) { 
						<% $entry->code %>
%					}
				</span>

				<span class="quarter">
					<% $entry->name %>
				</span>

				<span class="sixth rightalign <% $status_class %>" title="<% $description %>">
					<% $status %>
				</span>

				<span class="tenth rightalign">
					<a 
						id	  = "button_<% $entry->id %>"
						class   = "fa fa-edit fa-sm button buttonwhite bluetext <% scalar @entries > 1 ? "" : "invert"  %> "
						onclick = "showEntry(<% $entry->id %>);"
					></a>
				</span>

			</div>

%			my $hideme = 1 if scalar @entries > 1;
	
			<div class="entryforms <% scalar @entries > 1 ? "hidden" : "" %> " id="<% $entry->id %>">

				<& entry_edit.mas, hideme => $hideme, student => $student, entry => $entry &>

			</div>

%		}

		<div class="liblrow rightalign">
			<input type="submit" value=" Save Changes ">
			</form>
		</div>

	</div>

