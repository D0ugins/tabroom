<%args>
	$judge_id
	$school_id
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);
	my $school = Tab::School->retrieve($school_id);

	unless ($judge && $school ) { 
		$m->print("I have no judge or school.  Hit back and try again");
		$m->abort();
	}

	my $category = $judge->category;

	my %category_settings = $category->all_settings();

	my $tourn = $category->tourn;

	my $rounds_per = $category_settings{"rounds_per"} if $category;

</%init>

	<div class="main"> 

		<h2>Additional details needed</h2> 

		<form 
			action = "judge_details_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "judge_id"
			value = "<% $judge->id %>"
		>

		<input 
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<div class="yellowrow hover martop">

			<span class="twofifth <% $judge->setting('notes') ? "redtext" : "" %>">
				Judge Notes.  Please delete if no longer relevant:
			</span>

			<span class="threefifths rightalign">
				<input 
					type  = "text"
					name  = "notes"
					size  = "48"
					value = "<% $judge ? $judge->setting("notes") : "" %>">
			</span>

		</div>

%		my %strike_by_event = ();

		<span class="pagehalf">

		<h4>Other Info</h4>

%		if ($category_settings{"min_registrant_jpools"}) { 

			<script>

				function checkMinimums(lastChanged) { 

					var checked = 0;
					var minimum = $(lastChanged).attr("minimum");

					$('.jpools').each(function() { 
						checked++ if $(this).prop('checked');
					}

					if (minimum > checked) { 
						$(lastChanged).prop('checked', true);
						alertify.warning("Each judge must be in a minimum of "+minimum+" pools");
						return;
					}
				}

			</script>

			<h5>Judge pools</h5>

			<p class="semibold">
				Each judge must be put in a minimum of 
				<% $category_settings{"min_registrant_jpools"} %>
				pools
			</p>

<%perl>

			my %jpool_judges = 
				map {$_->jpool->id => 1} 
				Tab::JPoolJudge->search(judge => $judge->id);

			foreach my $jpool 
				($category->jpools(registrant => 1)
			) { 

</%perl>
				<div class="row">

					<span class="third">
						<% $jpool->name %>
					</span>

					<span class="third">
						<% $jpool->site ? $jpool->site->name : "" %>
					</span>

					<label for="<% $jpool->id %>">
						<span class="third hover centeralign">
							<input 
								type     = "checkbox"
								name     = "<% $jpool->id %>"
								id       = "<% $jpool->id %>"
								class    = "jpools"
								minimum  = "<% $category_settings{"min_registrant_jpools"} %>"
								value    = 1
								onChange = "checkMinimums(this);"
								<% $jpool_judges{$jpool->id} ? "checked" : "" %>
							>
						</span>
					</label>

				</div>
%			}

%		}

%		if ($category_settings{"ask_alts"}) { 

			<div class="row"> 
				
				<span class="fifth">
					Also judges category:
				</span> 
				
				<span class="fourfifth">
					<select name="alt_id">
					
						<option value="">
							None Selected
						</option>
<%perl>

						foreach my $other_category (
							sort {$a->name cmp $b->name} 
							$tourn->categories
						) { 

						   next if $category->id == $other_category->id;

						   next if $category_settings{"tab_room"};

</%perl>

							<option 
								value="<% $other_category->id %>" 
								<% $judge->alt_category 
									&& ($other_category->id eq $judge->alt_category->id) 
										? 'selected' 
										: ''
								%>
							><% $other_category->name %></option>
%					   }

					</select>

				</span>

			</div>


%		}

%		if ($category_settings{"diversity_selfie"}) { 

			<h4>Judge Diversity</h4>

			<div class='full explain'>
				<% $category_settings{"diversity_notice"} %>
			</div>
		
			<label for="diversity">

				<div class="row hover"> 
					
					<span class="fourfifth">
						Diversity-enhancing judge
					</span> 
					
					<span class="fifth">
						<input 
							type  = "checkbox"
							id    = "diversity"
							name  = "diverse"
							value = "1"
							<% $judge->setting("diverse") ? 'checked="checked"' : "" %>
						>
					</span>

				</div>
			</label>

%		}

%		if ($rounds_per) { 
			
			<div class="row hover">

				<span class="fourfifth">
					Prelim round judging obligation
				</span>

				<span class="fifth">
					<input 
						type  = "number"
						name  = "rounds"
						size  = "5"
						min   = "1"
						max   = "<% $category_settings{"max_rounds"} %>"
						value = "<% $judge->obligation %>"
					>
				</span>
				
			</div>
%		}

			<label for="ada">
				<div class="row hover">
			
					<span class="fourfifths">
						ADA/Accessible Rooms Needed
					</span>

					<span class="fifth">
						<input 
							type  = "checkbox"
							id    = "ada"
							name  = "ada"
							value = "1"
							<% $judge->ada ? 'checked="checked"' : "" %>> 
					</span>

				</div>
			</label>

%			if ($category_settings{"ask_parli"}) { 

				<label for="parli">

					<div class="row hover">
				
						<span class="fourfifths">
							Qualified Parliamentarian?
						</span>

						<span class="fifth">
							<input 
								type  = "checkbox"
								id    = "parli"
								name  = "parli"
								value = "1"
								<% $judge->setting("parli") ? 'checked="checked"' : "" %>> 
						</span>

					</div>
				</label>


%			}

%			if ($category_settings{"neutrals"}) { 

				<label for="neutral">
					<div class="row hover">

						<span class="fourfifth">
							Judge is neutral (can judge your students)
						</span>

						<span class="fifth">
							<input 
								type  = "checkbox"
								id    = "neutral"
								name  = "neutral"
								value = "1"
								<% $judge->setting("neutral") ? "checked" : "" %>> 
						</span>

					</div>
				</label>

%			}

%			if ($category_settings{"first_year_outs"}) { 

%				my $fyo_label = $category_settings{"fyo_label"};

				<label for="fyo">
					<div class="row hover">

						<span class="fourfifth">
							<% $fyo_label ?  $fyo_label : "Judge is a first-year graduate" %>
							<% $category_settings{"fyo_free_strikes"} ? "(automatic free strike)" : "" %>
						</span>

						<span class="fifth">
							<input 
								type  = "checkbox"
								id    = "fyo"
								name  = "fyo"
								value = "1"
								<% $judge->setting("first_year") ? "checked" : "" %>> 
						</span>

					</div>
				</label>

%			}

%			if ($category_settings{"free_strikes_dont_count"} 
%					&& not defined $category_settings{"fyo_free_strikes"}) { 

				<label for="free_strike">
					<div class="row hover">

						<span class="fourfifth">
							Judge is a free strike 
							(rounds will not count towards obligation)
						</span>

						<span class="fifth">
							<input 
								type  = "checkbox"
								id    = "free_strike"
								name  = "free_strike"
								value = "1"
								<% $judge->setting("free_strike") ? "checked" : "" %>> 
						</span>

					</div>
				</label>
%			}

%			if ($category_settings{"judge_cells"}) { 

				<div class="row hover">

					<span class="twofifth">
						Judge Cell Phone Number
					</span>

					<span class="threefifths rightalign">
						<input 
							type="tel" 
							name="phone" 
							size="24" 
							value="<% $judge ? $judge->setting("phone") : "" %>">
					</span>

				</div>

%			}

		</span>

		<span class="pagehalf marno">

%			if ($category_settings{"judge_quals"}) { 

				<h4>Qualification History</h4>

				<div class="row">

					<span class="twofifth">
						<p class="padless marless">
							Please provide a summary of tournaments and number
							of rounds judged at this level (High school,
							college, etc) in the past year.
						</p>

					</span>

					<span class="threefifth">
						<textarea 
							name = "qual_history"
							rows = "5"
							cols = "30"
						><% $judge ? $judge->setting("qual_history") : "" %></textarea>
					</span>

				</div>

%			}

%			if ($category_settings{"coach_ratings"}) { 

				<h4>Please rate this judge</h4>

%				if ($category->rating_subsets) { 

%					foreach my $subset ($category->rating_subsets) { 

%						my $rating = $judge->ratings( rating_subset => $subset->id )->first;
%						my $tier = $rating->rating_tier if $rating;
		
						<div class="yellow">
		
							<span class="quarter">
								<h4>
									<% $subset->name %> 
								</h4>
							</span>

							<span class="threequarter">
								<h5>
%									my $notfirst;
%									foreach my $event ($subset->events) { 
										<% ($notfirst) ? ", " : "" %>
										<% $event->name %>
%										$notfirst++;
%									}
								</h5>
							</span>

						<div>

<%perl>

						foreach my $tier (
							sort {$a->name cmp $b->name} 
								$category->rating_tiers(type => "coach")
						) {

							my $checked = 'checked="checked"' if $rating 
										&& $rating->rating_tier 
										&& $rating->rating_tier->id == $tier->id;

</%perl>
							<label for="<% $subset->id."-".$tier->id %>">

								<div class="row nospace">

									<span class="sixth">
										<input 
											type  = "radio"
											name  = "<% $subset %>"
											value = "<% $tier->id %>"
											id    = "<% $subset->id."-".$tier->id %>"
											<% $checked %>
										>
									</span>

									<span class="sixth">
										<% $tier->name %>
									</span>

									<span class="twothird smallish">
										<% $tier->description %>
									</span>

								</div>
							</label>

<%perl>

						} 

					}

				} else { 

					my $rating = $judge->ratings->first;

					my $judge_tier = $rating->rating_tier if $rating;

					my @tiers  = 
						sort {$a->name cmp $b->name} 
						$category->rating_tiers(type => "coach");

					foreach my $tier (@tiers) { 

</%perl>
						<label for="<% $tier->id %>">
							<div class="row hover nospace">

								<span class="sixth">
									<input 
										type  = "radio"
										name  = "rating_id"
										value = "<% $tier->id %>"
										id    = "<% $tier->id %>"
										<% ($judge_tier && $tier->id == $judge_tier->id) ? "checked" : "" %>>
								</span>

								<span class="sixth">
									<% $tier->name %>
								</span>

								<span class="twothird">
									<% $tier->description %>
								</span>

							</div>
						</label>

%					} 

%				}

%			}

		</span>

<%perl>

		foreach my $strike (
			Tab::Strike->search( 
				type       => "event",
				judge      => $judge->id,
				registrant => 1
			)
		) { 

			$strike_by_event{$strike->event->id} = $strike;
		}

		my @selfstrike = $m->comp("/funclib/event_selfstrike.mas", category => $category);

</%perl>

%		if (@selfstrike) { 

			<span class="pagehalf">

			<h4>Division/Event specific constraints</h4>

%			foreach my $event ($m->comp("/funclib/event_selfstrike.mas", category => $category)) { 

				<label for="<% $event->id %>">

					<div class="row hover">

						<span class="fifth">

							<input 
								type  = "checkbox"
								id    = "<% $event->id %>"
								name  = "<% $event->id %>"
								value = "1"
								<% $strike_by_event{$event->id} ? "checked" : "" %>> 
						</span>

						<span class="fourfifth smallish">
							Judge should not judge <% $event->name %>
						</span>

					</div>
				</label>

%			}

			</span>

%		}


	<div class="libl rightalign">
		<input 
			type  = "submit"
			value = "Save Details">
		</form>
	</div>

			
</div>

<div class="menu">

	<div class="sidenote">
		
		<h4>Judge</h4>

		<p class="even full">
			<% $judge->first." ".$judge->last %>
		</p>

		<p class="full odd">
			<% $judge->category->name %>
		</p>

		<p class="full even">
			<% $judge->school ? $judge->school->short_name : "Hired Judge" %>
		</p>

%		if ($judge->person) { 
			<p class="full odd">
				Linked to: <% $judge->person->email %>
			</p>
%		}

	</div>

</div>

