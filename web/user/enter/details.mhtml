<%args>
	$tourn
	$entry_id
	$school_id
	$person
	$from => undef
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id);

	$m->abort unless $entry;

	my $event = $entry->event;
	my $school = Tab::School->retrieve($school_id);

	my %event_settings = $event->all_settings;
	my %entry_settings = $entry->all_settings;

	my $max = $event_settings{"max_entry"};
	my $min = $event_settings{"min_entry"};

	my $code_style = $event_settings{"code_style"};

	my @clear_students = $m->comp(
		"/funclib/students_evententer.mas", 
			event  => $event,
			school => $school
	);

	my @students = $entry->students;

	my %tourn_settings = $tourn->all_settings();

</%init>

	<div class="main">

		<& "tabbar.mas", school => $school, whoami => "by_event" &>

		<h4>Entry Details</h4>

		<form action="details_save.mhtml" method="post">

		<input 
			type  = "hidden"
			name  = "entry_id"
			value = "<% $entry->id %>"
		>

		<input 
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input 
			type  = "hidden"
			name  = "from"
			value = "<% $from %>"
		>

%		unless ($tourn_settings{"hide_codes"}) { 

			<div class="lightrow borderbottom">

				<span 
					class="half padmuchmore
						<% ($code_style eq "register" || $code_style eq "initials") ? "required" : "" %>">
						Entry Code
				</span>

				<span class="half">

%					if ($code_style eq "initials" 
%						|| $code_style eq "register" 
%						|| $code_style eq "full_initials") {


						<input 
							type  = "text"
							size  = "30"
							name  = "code"
							value = "<% $entry->code %>"
						>

%					} else { 

						<span class="padtop padbottom">
							<% $entry->code %>
						</span>

%					}
				</span>
			</div>

%		}

%			foreach my $count (1 .. $max) { 

<%perl>

				my $student = shift @students if @students;

				my $hybrid = Tab::School->search( 
					chapter => $student->chapter->id,
					tourn   => $tourn->id 
				)->first

					if $student 
						&& $student->chapter 
						&&  $student->chapter->id != $school->chapter->id;

</%perl>
				<div class="lightrow">

					<span class="<% $count > $min ? "" : "required" %> half">
						Student <% $max > 1 ? $count : "" %>
						<% $hybrid ? "(".$hybrid->name.")" : "" %>
					</span>

					<span class="half">

						<select name="student_<% $count %>" class="fixedbig">

%							if ($student) { 
								<option value="<% $student->id %>"
									><% $person->site_admin ? $student->id." " : "" %><% $student->first." ".$student->last %> </option>
%							}

							<option value="">NONE</option>
<%perl>
							if ($hybrid) { 

								foreach my $student (
									$m->comp(
										"/funclib/students_evententer.mas", 
										event  => $event,
										school => $hybrid
									)
								) {
</%perl>
									<option 
										value="<% $student->id %>"
									><% $person->site_admin ? $student->id." " : "" %><% $student->first." ".$student->last %> </option>
%								}

%							} else { 

%								foreach my $student (@clear_students) { 
									<option 
										value="<% $student->id %>"
									><% $person->site_admin ? $student->id." " : "" %><% $student->first." ".$student->last %> </option>
%								}

%							}

						</select>

					</span>

				</div>

%				$count++;

%			}

%			if ($event_settings{"apda"}) { 

				<div class="lightrow">

					<span class="half">
						Prelim Seeding
					</span>

					<span class="half martop">

						<select name="seed" class="fixedsmall">

							<option value="">None</option>

							<option 
								value="half" 
								<% $entry_settings{"registered_seed"} eq "half" ? "selected" : "" %>
							>Half</option>

							<option 
								value="full" 
								<% $entry_settings{"registered_seed"} eq "full" ? "selected" : "" %>
							>Full</option>

							<option 
								value="free" 
								<% $entry_settings{"registered_seed"} eq "free" ? "selected" : "" %>
							>Free</option>

						</select>
					</span>

				</div>

%			}

			<label for="ada">
				<div class="lightrow hover">

					<span class="half">
						ADA/Accessible Rooms Needed
					</span>

					<span class="half">
						<input 
							type  = "checkbox"
							class = "largecheck"
							id    = "ada"
							name  = "ada"
							value = "1" <% $entry->ada ? "checked" : "" %>>
					</span>

				</div>
			</label>
			
<%perl>

			if (
				($tourn_settings{"nsda_district"} && $event_settings{"ask_for_titles"})
				|| 	( 	
						($tourn_settings{"nsda_nats"} || $tourn_settings{"nsda_ms_nats"})
						&& $event_settings{"ask_for_titles"}
					)
			) { 

</%perl>
		
				<h4 class="martopmore">
					Required information for 
						<% $tourn_settings{"nsda_district"} ? "District Qualifiers" : "" %>
						<% $tourn_settings{"nsda_nats"} ? "Nationals" : "" %>
				</h4>

				<div class="lightrow">

					<span class="required half">
						Piece/speech title 
					</span>

					<span class="half">
						<input 
							type  = "text"
							name  = "title"
							value = "<% $entry_settings{"title"} %>"
							size  = "40"
						>
					</span>

				</div>

%				if ($event_settings{"ask_for_authors"}) {

					<div class="lightrow">

						<span class="required half">
							Author
						</span>

						<span class="half">
							<input 
								type  = "text"
								name  = "author"
								value = "<% $entry_settings{"author"} %>"
								size  = "40"
							>
						</span>

					</div>

					<p class="strong redtext centeralign martopmore">
						You must fill out either the Print or Digital publication information:
					</p>

					<h5 class="padtopmore">
						Print Publications
					</h5>

					<div class="lightrow">

						<span class="half">
							Publisher
						</span>

						<span class="half">
							<input 
								type  = "text"
								name  = "publisher"
								value = "<% $entry_settings{"publisher"} %>"
								size  = "40"
							>
						</span>

					</div>

					<div class="lightrow">

						<span class="half">
							Publication Year
						</span>

						<span class="half">
							<input 
								type  = "text"
								name  = "publish_date"
								value = "<% $entry_settings{"publish_date"} %>"
								size  = "40"
							>
						</span>

					</div>

					<div class="lightrow">

						<span class="half">
							ISBN Number
						</span>

						<span class="half">
							<input 
								type  = "text"
								name  = "publish_isbn"
								value = "<% $entry_settings{"publish_isbn"} %>"
								size  = "40"
							>
						</span>

					</div>

					<h5 class="padtopmore">
						For	Digital	(Online) Publication:
					</h5>

					<div class="lightrow">

						<span class="half">
							Date the web page was printed:
						</span>

						<& /funclib/datepicker.mas, id => "publish_print_date" &>

%						my $publish_print_date = $entry_settings{"publish_print_date"};

						<span class="half">
							 <input 
								type  = "text"
								name  = "publish_print_date"
								id    = "publish_print_date"
								size  = "7"
								value = "<% Tab::pickerdate($publish_print_date) %>" 
							>
						</span>

					</div>

					<div class="lightrow">

						<span class="half">
							URL (web address) of the script's first page:
						</span>

						<span class="half">
							<input 
								type  = "url"
								name  = "publish_url"
								value = "<% $entry_settings{"publish_url"} %>"
								size  = "40"
							>
						</span>

					</div>

%				}

%			} else { 
	
%				if ($event_settings{"ask_for_titles"}) {
			
					<div class="lightrow">

						<span class="required half">
							Piece title:
						</span>

						<span class="half">
							<input 
								type  = "text"
								name  = "title"
								value = "<% $entry_settings{"title"} %>"
								size  = "40">
						</span>

					</div>
%				}

%				if ($event_settings{"ask_for_authors"}) {

					<div class="lightrow">

						<span class="required half">
							Piece author
						</span>

						<span class="half">
							<input 
								type  = "text"
								name  = "author"
								value = "<% $entry_settings{"author"} %>"
								size  = "40">
						</span>

					</div>

<%perl>

				}

			}


			my $quals = $event_settings{'ask_quals'}; 
			my $required = $quals;
			$quals = 15 if $event_settings{"more_quals"};

		if ($quals) { 

</%perl>

			<div class="full nospace martopmore">
				<span class="pagehalf nospace">
					<h4>Qualifiers</h4>
				</span>

				<span class="pagehalf rightalign nospace">
					<h5><% $required %> Required</h5>
				</span>

			</div>

%			if ($event_settings{"at_larges"}) { 

				<label for="at_large">
					<div class="lightrow hover">

						<span class="half rightalign padtopmore padbottommore">
							At-large applicant? 
						</span>

						<span class"third">
							<input 
								id    = "at_large"
								type  = "checkbox"
								class = "largecheck"
								name  = "atlarge"
								value = "1"
								<% $entry && $entry_settings{"atlarge"} ? 'checked="checked"' : "" %>
							>
						</span>

					</div>
				</label>
				
%			}

			<div class="yellowrow martop strong smallish">

				<span class="fifth">
					Qualifier
				</span>

				<span class="twofifths">
					Tournament
				</span>

				<span class="twofifths">
					Finish/Points
				</span>

			</div>

%			my @qualifiers = $entry->qualifiers;

%			foreach my $tick (1 .. $quals) { 

%				my $qual = shift @qualifiers if @qualifiers;

				<div class="lightrow">

					<span class="fifth <% $tick > $required ? "" : "required" %>">
						Qualifier <% $tick %>
					</span>

					<span class="twofifths">
						<input 
							type="text" 
							name="qual_<% $tick %>" 
							value="<% $qual ? $qual->name : "" %>" 
							size="24"
						>
					</span>

					<span class="twofifths">
						<input 
							type="text" 
							name="qualpts_<% $tick %>" 
							value="<% $qual ? $qual->result : "" %>"
							size="24"
						>
					</span>

				</div>

%			}

%		}

			
		<div class="libllightrow rightalign">
			<input 
				type  = "submit"
				value = " Save Entry Details "
			>
			</form>
		</div>

		<p class="required">
			 = Required field
		</p>

	</div>

	<div class="menu">
	
		<div class="sidenote">

			<h4>Entry</h4>

%			if ($entry->waitlist) { 
				<span class="centeralign full">
					<span class="buttonwhite redtext bigger">
						On Waitlist
					</span>
				</span>
%			}

			<p class="lightrow bigger">
				<% $entry->name %>
			</p>

			<p class="lightrow bigger">
				<% $entry->code %>
			</p>

			<p class="lightrow bigger">
				<% $event->name %>
			</p>


			<h4><% $event->abbr %></h4>

			<a 
				class="blue full"
				href="students.mhtml?school_id=<% $school_id %>&event_id=<% $event->id %>">
				Return to <% $event->abbr %> Entry
			</a>
		</div>

%			if ($tourn_settings{"nsda_nats"} || $tourn_settings{"nsda_ms_nats"}) {

%				if ($tourn_settings{"entry_release"}) { 

					<div class="sidenote">

						<h4>Entry Release Forms</h4>

						<p class="centeralign greentext biggish marbottom">
							A signed copy of this form is required for every student at Nationals.
						</p>

						<span class="full centeralign bigger marbottommore">
							<a 
								class="buttonwhite bluetext hover strong"
								href="<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$tourn_settings{"entry_release"} %>">
								Download Form
							</a>
						</span>


					<form 
						enctype  = "multipart/form-data"
						onsubmit = "return uploadThis()"
						name     = "entry_releases"
						action   = "entry_release_upload.mhtml"
						method   = "post"
					>

					<input 
						type  = "hidden"
						name  = "school_id"
						value = "<% $school->id %>"
					>

					<input 
						type  = "hidden"
						name  = "entry_id"
						value = "<% $entry->id %>"
					>

%					my $count = 1;
%					foreach my $student ($entry->students) { 

						<div class="lightrow centeralign strong">
							<% $count++ %>.
							<% $student->first %> <% $student->last %>
						</div>

						<div class="lightrow centeralign padmore">
%							if ($school->setting("entry_release_".$student->id)) { 

								<span class="fa fa-lg fa-check-circle-o fa-2x greentext">
								</span>

								<a 
									class = "greentext bigger"
									href  = "<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$school->id."/".$student->id."/".$school->setting("entry_release_".$student->id) %>" 
								>
									Uploaded
								</a>

%							} else { 
								<span class="centeralign strong redtext padmore">
									Not Uploaded
								</span>
%							}
						</div>

						<div class="lightrow centeralign">
						
							<div class="uploader">

								<input 
									type     = "file"
									name     = "entry_release_<% $student->id %>"
									style    = "opacity: 0;"
									onchange = "uploaderName(
										'entry_release_<% $student->id %>',
										'entry_release_<% $student->id %>_file'
									)"
									id       = "entry_release_<% $student->id %>"
								>

								<span 
									id  = "entry_release_<% $student->id %>_file"
									class = "filename"
									style = "-webkit-user-select: none;"
								>No file selected</span>

								<span 
									class = "action"
									style = "-webkit-user-select: none;"
								>Choose File</span>
							</div>
								
						</div>

%					}

					<div class="libl full rightalign">

						<input
							type  = "submit"
							value = "Upload Forms"
						>

					</div>

%				}

%			}


	</div>

