<%args>
	$person
	$session
	$school
	$tourn
	$disclaimed => undef
</%args>
<%init>

	use POSIX;

	my %tourn_settings = $tourn->all_settings;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

    my $now = DateTime->now(time_zone => $tz);

	my %school_settings = $school->all_settings;

	if ($tourn_settings{"disclaimer"}) { 

		if ($disclaimed) { 

			$school->setting("disclaimed", $person->id);
			$school->setting("disclaimed_at", "date", $now);

		} elsif ($school_settings{"disclaimed"}) { 

		} else { 

			$m->redirect("disclaimer.mhtml?school_id=".$school->id) 
		}

	}

	my $adult++ if ( 
		$school_settings{"contact_number"} 
		&& $school_settings{"contact_name"} 
		&& $school_settings{"contact_email"}
	);

	$adult++ unless $tourn_settings{"require_adult_contact"};

	my @empties = $m->comp(
		"/funclib/school_empty_entries.mas", 
		school => $school
	);

</%init>

	<div class="main">

		<h2>
			<% $tourn->name %>
		</h2>

		<& "tabbar.mas",
			school => $school, 
			whoami => "signup"
		&>

			<form 
				enctype  = "multipart/form-data"
				action   = "signup_save.mhtml"
				method   = "post"
				onsubmit = "return uploadThis();"
			>

			<input 
				type  = "hidden"
				name  = "school_id"
				value = "<% $school->id %>"
			>

			<input 
				type  = "hidden"
				name  = "tourn_id"
				value = "<% $tourn->id %>"
			>

%		if ($school_settings{"signup_deadline"}) { 

			<div class="full centeralign">

				<span class="pagehalf centeralign odd">

					<span class="threefifths semibold greentext bigger">
						Signup sheet active:
					</span>

					<span class="twofifths rightalign">

						<label class="switch marless">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $school->id %>"
								setting_name = "signup_active"
								target_id    = "<% $school->id %>"
								onChange     = "postSwitch( this, 'school_switch.mhtml');"

								<% $school_settings{"signup_active"} ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</span>

				</span>

			</div>

%		}

		<span class="pagehalf">

			<h5>Signup sheet settings:</h5>

			<div class="row padvert">

				<span class="twofifths padleft padvert">
					Info Packet
				</span>

				<span class="threefifths nospace">

					<div class="uploader wider">
						<input 
							type     = "file"
							name     = "signup_memo"
							style    = "opacity: 0;"
							onchange = "uploaderName()"
							id       = "upload"
						>
						<span 
							id    = "filename"
							class = "filename"
							style = "-webkit-user-select: none;"
						>No file selected</span>

						<span 
							class = "action"
							style = "-webkit-user-select: none;"
						>Choose File</span>
					</div>

				</span>

			</div>

%			my $file = $school->files(type => "signup")->first;

%			if ($file) { 

				<div class="row padvert">

					<span class="twofifths padleft">
						Existing Memo:
					</span>

					<span class="half">
						<a class="white nowrap full marno bluetext"
							href="<% $Tab::s3_url."/".$tourn->id."/signups/".$school->id."/".$file->filename %>"
						> <span class="inline fa fa-sm fa-file-o"></span> <% $file->filename %>
						</a>
					</span>

					<span class="tenth rightalign nospace">
						<a class="buttonwhite redtext fa fa-lg fa-trash-o"
							href="signup_rm.mhtml?school_id=<% $school->id %>"
						></a>
					</span>

				</div>

%			}

			<div class="row">

				<span class="twofifths padvert padleft required">
					Signup deadline
				</span>

				<& "/funclib/datepicker.mas",
					id => "signup_deadline" , 
					max => $tourn->reg_end
				&>

				<span class="threetenths">
					<input 
						type  = "text"
						name  = "signup_deadline"
						id    = "signup_deadline"
						size  = "13"
						value = "<% Tab::pickerdate($school_settings{"signup_deadline"}) %>" 
					>
				</span>

				<span class="threetenths">
					at
					<& "/funclib/timepicker.mas", 
						name => "signup_deadlinetime",
						size => 8,
						time => $school_settings{"signup_deadline"}
					&>
				</span>

			</div>


			<div class="row padvert">

				<span class="twofifths padvert padleft martop">
					Tournament deadline
				</span>

%				my $reg_end = $tourn->reg_end->set_time_zone($tz);

				<span class="threetenths">
					<% Tab::niceshortdayte($reg_end) %>
				</span>

				<span class="threetenths">
					at <% Tab::nicetime($reg_end) %> <% Tab::tzname($tz) %>
				</span>

			</div>

		</span>

		<span class="pagehalf">

			<& "/funclib/editor.mas", half => 1 &>

			<h5>Message above competitor signup page:</h5>

			<div class="padmore">
				<textarea 
					class = "half padbottom"
					rows  = 9 
					cols  = 32
					name  = "signup_notice"
					value = "<% $school_settings{"signup_notice"} %>"
				></textarea>
			</div>

		</span>

		<div class="rightalign liblrow">
			<input type="submit" value="Save Signup Information">
			</form>
		</div>

		<p class="redtext centeralign explain bigger">
			*You must set a signup deadline before you can enable the online
			signup sheet
		</p>
			
	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Wait, what is this?!</h4>

			<p class="bigger">
				Enable the online signup sheet and your students can sign up
				for tournaments online directly in Tabroom.  Then come back
				here to approve or deny their requests for tournaments slots.
			</p>

			<p class="bigger">
				When a student signs up for a tournament, they will be emailed
				any message you put in the box at left, as well as any
				file/memo you upload.  In team/paired events their teammates
				will also be notified.  Lastly, if you or they input parent
				contact information into their student profiles, they too will
				be notified and recieve copies of this information. 
			</p>


		</div>

	</div>
