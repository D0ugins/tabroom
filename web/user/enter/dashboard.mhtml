<%args>
	$school
	$person
</%args>
<%init>

	# The Where My People At summary dashboard.  Idea courtesy Tripp Reprovick.

	my $tourn = $school->tourn;
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $school_id = $school->id;

	my %tourn_settings = $tourn->all_settings;

	# Time Frame begins 15 minutes ago and shows the future
	my $now = DateTime->now();
	$now->subtract(minutes => 15);

	my $now_string = DateTime::Format::MySQL->format_datetime($now);

	my $after++ if $now > $tourn->end;

	my $dbh = Tab::DBI->db_Main();

	my $now_sth = $dbh->prepare("
		select
			entry.id, entry.code, entry.name,
			room.name, panel.letter, panel.id, panel.flight, panel.publish,
			panel.bye,
			ballot.id, ballot.side, ballot.speakerorder, ballot.audit, ballot.judge_started,
			ballot.bye, ballot.forfeit,
			opponent.code,
			winloss.value, point.value, rank.value, rfd.content, comments.content,
			round.name, round.label, round.start_time, round.flighted,
			round.published, round.post_results,
			flight_offset.value,
			judge_publish_results.value,
			timeslot.start, timeslot.end,
			event.id, event.abbr, event.type,
			judge.id, judge.code, judge.first, judge.last,
			aff_label.value, neg_label.value,
			point_student.id, point_student.last, point_student.first,
			rank_student.id, rank_student.last, rank_student.first,
			coach_wins.value, coach_points.value, coach_feedback.value,
			public_feedback.value


		from (entry, ballot, panel, round, timeslot, event)

			left join score winloss
				on winloss.ballot = ballot.id
				and winloss.tag = 'winloss'

			left join score point
				on point.ballot = ballot.id
				and point.tag = 'point'

			left join student point_student
				on point_student.id = point.student

			left join score rank
				on rank.ballot = ballot.id
				and rank.tag = 'rank'

			left join student rank_student
				on rank_student.id = rank.student

			left join score rfd
				on rfd.ballot = ballot.id
				and rfd.tag = 'rfd'

			left join score comments
				on comments.ballot = ballot.id
				and comments.tag = 'comments'

			left join room on panel.room = room.id
			left join judge on ballot.judge = judge.id

			left join ballot otherballot
				on otherballot.panel = panel.id
				and otherballot.entry != entry.id

			left join entry opponent
				on otherballot.entry = opponent.id

			left join event_setting flight_offset
				on flight_offset.event = event.id
				and flight_offset.tag = 'flight_offset'

			left join event_setting judge_publish_results
				on judge_publish_results.event = event.id
				and judge_publish_results.tag = 'judge_publish_results'

			left join event_setting aff_label
				on aff_label.event = event.id
				and aff_label.tag = 'aff_label'

			left join event_setting neg_label
				on neg_label.event = event.id
				and neg_label.tag = 'neg_label'

			left join round_setting coach_wins
				on coach_wins.round = round.id
				and coach_wins.tag = 'coach_wins'

			left join round_setting coach_points
				on coach_points.round = round.id
				and coach_points.tag = 'coach_points'

			left join round_setting coach_feedback
				on coach_feedback.round = round.id
				and coach_feedback.tag = 'coach_feedback'

			left join round_setting public_feedback
				on public_feedback.round = round.id
				and public_feedback.tag = 'public_feedback'

			where entry.school = ?
				and entry.id = ballot.entry
				and ballot.panel = panel.id
				and panel.round = round.id
				and round.timeslot = timeslot.id
				and round.event = event.id

			order by event.abbr, entry.code, round.name
	");

	$now_sth->execute($school_id);
	my %now;
	my %events;

	my $current_count;

	while (
		my (
			$entry_id, $entry_code, $entry_name,
			$room_name, $panel_letter, $panel_id, $panel_flight, $panel_publish,
			$panel_bye,
			$ballot_id, $ballot_side, $ballot_speakerorder, $ballot_audit, $ballot_started,
			$ballot_bye, $ballot_forfeit,
			$opponent_code,
			$winloss_value, $point_value, $rank_value, $rfd_value, $comments_value,
			$round_name, $round_label, $round_start_time, $round_flighted,
			$round_published, $round_post_results,
			$flight_offset,
			$judge_publish_results,
			$timeslot_start, $timeslot_end,
			$event_id, $event_abbr, $event_type,
			$judge_id, $judge_code, $judge_first, $judge_last,
			$aff_label, $neg_label,
			$point_student_id, $point_student_last, $point_student_first,
			$rank_student_id, $rank_student_last, $rank_student_first,
			$coach_wins, $coach_points, $coach_feedback,
			$public_feedback
		) = $now_sth->fetchrow_array()

	) {

		next unless $round_published;

		$events{$event_id} = $event_abbr;

		unless ($now{"entries"}{$entry_id}) {

			$now{"entries"}{$entry_id}{entry_code} = $entry_code;
			$now{"entries"}{$entry_id}{entry_name} = $entry_name;
			$now{"entries"}{$entry_id}{event_abbr} = $event_abbr;
			$now{"entries"}{$entry_id}{event_id}   = $event_id;
			$now{"entries"}{$entry_id}{event_type} = $event_type;
		}

		unless ($now{"entries"}{$entry_id}{"sections"}{$panel_id}) {

			$now{"entries"}{$entry_id}{"sections"}{$panel_id}{room_name} = $room_name;
			$now{"entries"}{$entry_id}{"sections"}{$panel_id}{round_num} = $round_name;
			$now{"entries"}{$entry_id}{"sections"}{$panel_id}{round_name} = $round_name;
			$now{"entries"}{$entry_id}{"sections"}{$panel_id}{round_name} = $round_label
				if $round_label;
			$now{"entries"}{$entry_id}{"sections"}{$panel_id}{round_flighted} = $round_flighted;
			$now{"entries"}{$entry_id}{"sections"}{$panel_id}{panel_flight} = $panel_flight;

			$now{"entries"}{$entry_id}{"sections"}{$panel_id}{side_number} = $ballot_side;

			if ($event_type eq "congress") {

			} elsif ($event_type eq "wudc") {

				if ($ballot_speakerorder == 1) {
					$now{"entries"}{$entry_id}{"sections"}{$panel_id}{order} = "1G";
				} elsif ($ballot_speakerorder == 2) {
					$now{"entries"}{$entry_id}{"sections"}{$panel_id}{order} = "1O";
				} elsif ($ballot_speakerorder == 3) {
					$now{"entries"}{$entry_id}{"sections"}{$panel_id}{order} = "2G";
				} elsif ($ballot_speakerorder == 4) {
					$now{"entries"}{$entry_id}{"sections"}{$panel_id}{order} = "2O";
				}

			} elsif ($ballot_speakerorder) {

				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{order} = $ballot_speakerorder;

			} elsif ($panel_bye) { 

				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{side} = "Bye";

			} elsif ($ballot_side == 1) {

				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{side} = $aff_label;
				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{side} = "Aff" unless
					$now{"entries"}{$entry_id}{"sections"}{$panel_id}{side};

			} elsif ($ballot_side == 2) {
				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{side} = $neg_label;

				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{side} = "Neg" unless
					$now{"entries"}{$entry_id}{"sections"}{$panel_id}{side};
			}

			my $dt;

			$round_start_time = $timeslot_start unless $round_start_time;

			unless ($now{"starts"}{$round_start_time}) {
				$dt = DateTime::Format::MySQL->parse_datetime($round_start_time);
				$dt->set_time_zone("UTC");
				$dt->set_time_zone($tz);
				$now{"starts"}{$round_start_time} = $dt;
			} else {
				$dt = $now{"starts"}{$round_start_time};
			}

			my $end_dt;

			unless ($now{"starts"}{$timeslot_end}) {
				$end_dt = DateTime::Format::MySQL->parse_datetime($timeslot_end);
				$end_dt->set_time_zone("UTC");
				$end_dt->set_time_zone($tz);
				$now{"starts"}{$timeslot_end} = $end_dt;
			} else {
				$end_dt = $now{"starts"}{$timeslot_end};
			}

			if ($round_flighted > 1 && $flight_offset) {
				my $clone = $dt->clone();
				$dt = $clone;
				$dt->add( minutes => $flight_offset * ($panel_flight - 1) );
			}

			$now{"entries"}{$entry_id}{"sections"}{$panel_id}{"start_time"} = $dt;

			if (
				($dt->epoch < $now->epoch)
				&& ($end_dt->epoch > $now->epoch)
			) {
				$current_count++;
				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{"status"} = "current";
			} elsif ($dt->epoch > $now->epoch) {
				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{"status"} = "future";
			} else {
				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{"status"} = "past";
			}

		}

		unless ($round_published == 2) {

			unless ($now{"entries"}{$entry_id}{"sections"}{$panel_id}{judges}{$judge_id}) {
				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{judges}{$judge_id}{"code"}  = $judge_code;
				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{judges}{$judge_id}{"first"} = $judge_first;
				$now{"entries"}{$entry_id}{"sections"}{$panel_id}{judges}{$judge_id}{"last"}  = $judge_last;
			}

			my $judge = $now{"entries"}{$entry_id}{"sections"}{$panel_id}{judges}{$judge_id};

			unless ($judge->{"started"}) {
				if ($ballot_started) {
					$judge->{"started"} = eval {
						return DateTime::Format::MySQL->parse_datetime($ballot_started);
					};

					if ($judge->{'started'}) {
						$judge->{"started"}->set_time_zone("UTC");
						$judge->{"started"}->set_time_zone($tz);
					}
				}
			}

			if ($ballot_audit) {

				$judge->{"audited"}++;
				my $show_rfd;

				unless ($round_post_results) {
					if ($panel_publish) {
						if ($judge_publish_results eq "all") {
							$round_post_results = 2;
						} elsif ($judge_publish_results eq "winloss") {
							$round_post_results = 1;
						}
					}
				}

				unless ($round_post_results) {
					if ($coach_wins) {
						$round_post_results = 1;
					}
				}

				if ($coach_points) {
					$round_post_results = 2;
				}

				if ($round_post_results == 2 || $coach_feedback || $public_feedback) {
					$show_rfd++;
				}

				if ($round_post_results) {

					if ($event_type eq "speech") {

						$judge->{"rank"}  = $rank_value;

						if ($round_post_results == 2) {
							$judge->{"point"}  = $point_value;
						}

					} elsif ($event_type eq "wudc") {

						$judge->{"rank"}  = 4 - $rank_value;

					} elsif ($event_type eq "congress") {

					} elsif ($event_type eq "wsdc" || $event_type eq "debate") {

						if ($panel_bye || $ballot_bye) {
							$judge->{"win"}  = "Bye";
						} elsif ($ballot_forfeit) {
							$judge->{"win"}  = "Fft";
						} elsif ($winloss_value == 1) {
							$judge->{"win"}  = "W";
						} elsif ($winloss_value == 0) {
							$judge->{"win"}  = "L";
						}

						if ($round_post_results == 2) {

							if ($point_student_id) {
								$judge->{students}{$point_student_id}{"name"}
									= $point_student_last." ".$point_student_first;
							} elsif ($rank_student_id) {
								$judge->{students}{$rank_student_id}{"name"}
									= $rank_student_last." ".$rank_student_first;
							}

							if ($point_value) {
								$judge->{"point"}{$point_student_id}  = $point_value;
							}

							if ($rank_value) {
								$judge->{"rank"}{$rank_student_id}  = $rank_value;
							}
						}
					}
				}

				if ($show_rfd && ($rfd_value || $comments_value)) {
					$judge->{"rfd"}      = $rfd_value;
					$judge->{"comments"} = $comments_value;
					$now{"entries"}{$entry_id}{"sections"}{$panel_id}{rfd}++;
				}

			} else {

			}
		}
	}

	my $judge_now_sth = $dbh->prepare("

		select
			judge.id, judge.code, judge.first, judge.last,
			category.abbr,
			room.name,
			panel.letter, panel.id, panel.flight, panel.publish, panel.bye,
			ballot.audit,
			round.name, round.label, round.start_time, round.published, round.post_results,
			timeslot.start, timeslot.end,
			event.id, event.abbr, event.type,
			ballot.id, ballot.side, ballot.speakerorder, ballot.judge_started,
			entry.id, entry.code, entry.name,
			point_student.id, point_student.first, point_student.last,
			rank_student.id, rank_student.first, rank_student.last,
			winloss.value, point.value, rank.value,
			rfd.content, comments.content,
			judge_publish_results.value,
			aff_label.value, neg_label.value,
			coach_wins.value, coach_points.value, coach_feedback.value,
			public_feedback.value

			from (judge, ballot, panel, round, timeslot, event, category, entry)

			left join score winloss
				on winloss.ballot = ballot.id
				and winloss.tag = 'winloss'

			left join score point
				on point.ballot = ballot.id
				and point.tag = 'point'

			left join student point_student
				on point_student.id = point.student

			left join score rank
				on rank.ballot = ballot.id
				and rank.tag = 'rank'

			left join student rank_student
				on rank_student.id = rank.student

			left join score rfd
				on rfd.ballot = ballot.id
				and rfd.tag = 'rfd'

			left join score comments
				on comments.ballot = ballot.id
				and comments.tag = 'comments'

			left join event_setting judge_publish_results
				on judge_publish_results.event = event.id
				and judge_publish_results.tag = 'judge_publish_results'

			left join event_setting aff_label
				on aff_label.event = event.id
				and aff_label.tag = 'aff_label'

			left join event_setting neg_label
				on neg_label.event = event.id
				and neg_label.tag = 'neg_label'

			left join round_setting coach_wins
				on coach_wins.round = round.id
				and coach_wins.tag = 'coach_wins'

			left join round_setting coach_points
				on coach_points.round = round.id
				and coach_points.tag = 'coach_points'

			left join round_setting coach_feedback
				on coach_feedback.round = round.id
				and coach_feedback.tag = 'coach_feedback'

			left join round_setting public_feedback
				on public_feedback.round = round.id
				and public_feedback.tag = 'public_feedback'

			left join room on panel.room = room.id

			where judge.school = ?
				and judge.id = ballot.judge
				and ballot.panel = panel.id
				and panel.round = round.id
				and round.timeslot = timeslot.id
				and round.event = event.id
				and judge.category = category.id
				and ballot.entry = entry.id

			order by category.abbr, judge.last, timeslot.start
	");

	$judge_now_sth->execute($school_id);

	while (
		my (
			$judge_id, $judge_code, $judge_first, $judge_last,
			$category_abbr,
			$room_name,
			$panel_letter, $panel_id, $panel_flight, $panel_publish, $panel_bye,
			$ballot_audit,
			$round_name, $round_label, $round_start_time, $round_published, $round_post_results,
			$timeslot_start, $timeslot_end,
			$event_id, $event_abbr, $event_type,
			$ballot_id, $ballot_side, $ballot_speakerorder, $ballot_started,
			$entry_id, $entry_code, $entry_name,
			$point_student_id, $point_student_first, $point_student_last,
			$rank_student_id, $rank_student_first, $rank_student_last,
			$winloss_value, $point_value, $rank_value,
			$rfd_value, $comments_value,
			$judge_publish_results,
			$aff_label, $neg_label,
			$coach_wins, $coach_points, $coach_feedback,
			$public_feedback
		) = $judge_now_sth->fetchrow_array()
	) {

		next unless $round_published;
		next if $round_published == 2;

		$events{$event_id} = $event_abbr;

		unless ($now{"judges"}{$judge_id}) {

			$now{"judges"}{$judge_id}{judge_code} = $judge_code;
			$now{"judges"}{$judge_id}{judge_first} = $judge_first;
			$now{"judges"}{$judge_id}{judge_last} = $judge_last;
			$now{"judges"}{$judge_id}{category_abbr} = $category_abbr;
		}

		unless ($now{"judges"}{$judge_id}{"sections"}{$panel_id}) {

			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{room_name} = $room_name;
			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{round_num} = $round_name;
			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{round_name} = $round_name;
			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{round_name} = $round_label
				if $round_label;

			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{panel_bye} = $panel_bye;
			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{panel_flight} = $panel_flight;
			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{event_abbr} = $event_abbr;
			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{event_id} = $event_id;
			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{event_type} = $event_type;
			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{audited} = $ballot_audit;

			my $dt;

			unless ($now{"starts"}{$round_start_time}) {
				$dt = DateTime::Format::MySQL->parse_datetime($round_start_time);
				$dt->set_time_zone("UTC");
				$dt->set_time_zone($tz);
				$now{"starts"}{$round_start_time} = $dt;
			} else {
				$dt = $now{"starts"}{$round_start_time};
			}

			$now{"judges"}{$judge_id}{"sections"}{$panel_id}{"start_time"} = $dt;

			if ($dt > $now && (not defined $now{"judges"}{$judge_id}{"current"} )) {
				$now{"judges"}{$judge_id}{"current"}++;
				$now{"judges"}{$judge_id}{"sections"}{$panel_id}{"status"} = "current";
			} elsif ($dt > $now) {
				$now{"judges"}{$judge_id}{"sections"}{$panel_id}{"status"} = "future";
			} else {
				$now{"judges"}{$judge_id}{"sections"}{$panel_id}{"status"} = "past";
			}
		}

		my $section = $now{"judges"}{$judge_id}{"sections"}{$panel_id};

		$section->{entries}{$entry_id}{"code"}  = $entry_code;
		$section->{entries}{$entry_id}{"name"}  = $entry_name;

		unless ($section->{"started"}) {
			$section->{"started"} = eval {
				return DateTime::Format::MySQL->parse_datetime($ballot_started);
			};

			if ($section->{"started"}) {
				$section->{"started"}->set_time_zone("UTC");
				$section->{"started"}->set_time_zone($tz);
			}
		}

		if ($event_type eq "congress") {

		} elsif ($event_type eq "wudc") {

			if ($ballot_speakerorder == 1) {
				$section->{entries}{$entry_id}{"order"} = "1G";
			} elsif ($ballot_speakerorder == 2) {
				$section->{entries}{$entry_id}{"order"} = "1O";
			} elsif ($ballot_speakerorder == 3) {
				$section->{entries}{$entry_id}{"order"} = "2G";
			} elsif ($ballot_speakerorder == 4) {
				$section->{entries}{$entry_id}{"order"} = "2O";
			}

		} elsif ($ballot_speakerorder) {
			$section->{entries}{$entry_id}{"order"} = $ballot_speakerorder;
		} elsif ($ballot_side == 1) {
			$section->{entries}{$entry_id}{"side"} = $aff_label;
			$section->{entries}{$entry_id}{"side"} = "Aff" unless
				$section->{entries}{$entry_id}{"side"};

		} elsif ($ballot_side == 2) {
			$section->{entries}{$entry_id}{"side"} = $neg_label;

			$section->{entries}{$entry_id}{"side"} = "Neg" unless
				$section->{entries}{$entry_id}{"side"};
		}

		my $entry = $section->{entries}{$entry_id};

		if ($ballot_audit) {

			$section->{"audited"}++;
			my $show_rfd;

			unless ($round_post_results) {
				if ($panel_publish) {
					if ($judge_publish_results eq "all") {
						$round_post_results = 2;
					} elsif ($judge_publish_results eq "winloss") {
						$round_post_results = 1;
					}
				}
			}

			if ($coach_wins && (not defined $round_post_results)) {
				$round_post_results = 1;
			}

			if ($coach_points) {
				$round_post_results = 2;
			}

			if ($coach_feedback || $public_feedback || $round_post_results == 2) {
				$show_rfd++;
			}

			if ($round_post_results) {

				if ($event_type eq "speech") {

					$entry->{"rank"} = $rank_value;

					if ($round_post_results == 2) {
						$entry->{"point"} = $point_value;
					}

				} elsif ($event_type eq "wudc") {

					$entry->{"rank"} = 4 - $rank_value;

				} elsif ($event_type eq "congress") {

				} elsif ($event_type eq "wsdc" || $event_type eq "debate") {

					if ($winloss_value == 1) {
						$entry->{"win"}  = "W";
					} elsif ($winloss_value == 0) {
						$entry->{"win"}  = "L";
					}

					if ($round_post_results == 2) {

						if ($point_student_id) {
							$entry->{students}{$point_student_id}{"name"}
								= $point_student_last." ".$point_student_first;
						} elsif ($rank_student_id) {
							$entry->{students}{$rank_student_id}{"name"}
								= $rank_student_last." ".$rank_student_first;
						}

						if ($point_value) {
							$entry->{"point"}{$point_student_id}  = $point_value;
						}

						if ($rank_value) {
							$entry->{"rank"}{$rank_student_id}  = $rank_value;
						}
					}
				}
			}

			if ($show_rfd && ($rfd_value || $comments_value)) {
				$section->{rfd}      = $rfd_value;
				$section->{comments}++ if $comments_value;
				$entry->{"comments"} = $comments_value;
			}

		} else {

		}
	}

	my $jpool_sth = $dbh->prepare("
		select judge.id, judge.first, judge.last, judge.code,
			jpool.id,
			jpool.name, message.value_text, publish.value

		from (jpool, jpool_judge jpj, judge, jpool_setting publish)

			left join jpool_setting message
				on message.jpool = jpool.id
				and message.tag = 'message'

		where judge.school = ?
			and judge.id = jpj.judge
			and jpj.jpool = jpool.id
			and jpool.id = publish.jpool

			and not exists (
				select registrant.id
				from jpool_setting registrant
				where registrant.jpool = jpool.id
				and registrant.tag = 'registrant'
			)

	");

	my %jpools;

	$jpool_sth->execute($school_id);

	while (
		my (
		 	$judge_id, $judge_first, $judge_last, $judge_code,
			$jpool_id, $jpool_name, $message, $publish
		) = $jpool_sth->fetchrow_array()
	) {
		next unless $publish;
		$jpools{$judge_id}{$jpool_id}{"judge_name"} = $judge_first." ".$judge_last;
		$jpools{$judge_id}{$jpool_id}{"judge_code"} = $judge_code;
		$jpools{$judge_id}{$jpool_id}{"name"} = $jpool_name;
		$jpools{$judge_id}{$jpool_id}{"message"} = $message;
	}

	$jpool_sth->finish();

	Tab::Round->columns(TEMP => "strikeschool");

	Tab::Round->set_sql( school_strikes => "
		select round.*, entry.school as strikeschool
		from round, round_setting, panel, ballot, entry, school
		where entry.school = school.id
		and school.id = ?
		and entry.id = ballot.entry
		and ballot.panel = panel.id
		and panel.bye != 1
		and panel.round = round.id
		and round.id = round_setting.round
		and round_setting.tag = 'strikes_published'
		and round_setting.value = 1
		order by round.start_time
	");

	my @cards = Tab::Round->search_school_strikes($school_id);

	my %strike_cards = map {$_->strikeschool => 1} @cards;

    Tab::Round->set_sql( entry_flips => "
        select distinct round.*
        from round, round_setting, panel, ballot, entry, panel_setting
		where entry.school = ?
			and ballot.entry = entry.id
			and ballot.panel = panel.id
			and panel.bye != 1
			and panel.round = round.id
			and round.id = round_setting.round
			and round_setting.tag = 'flip_published'
			and panel_setting.panel = panel.id
			and panel_setting.tag = 'flip_status'
			and panel_setting.value != 'done'
        order by round.start_time
    ");

	my @flip_cards = Tab::Round->search_entry_flips($school_id);

</%init>

%	if ($ARGS{"results"}) {

		 <& "/user/results/menu.mas",
			 whoami => "dashboard",
			 person => $person,
			 school => $school
		 &>

%	} else {
		 <& "/user/menu.mas",
			 whoami => "dashboard",
			 person => $person
		 &>
%	}

	<script>

		function showRFD(sectionID) {
			$("#"+sectionID+"_button").toggleClass("invert");
			$("#"+sectionID+"_rfd").toggleClass("hidden");
		}

		function showEvent(selector) {

			var eventID = $(selector).val();

			if (eventID === "all") {
				$(".events").removeClass("eventHide");
			} else {
				$(".events").addClass("eventHide");
				$("."+eventID).removeClass("eventHide");
			}

			doHide();
			return;
		}

		function showTime(classID) {

			$(".timebutton").removeClass('invert');
			$(".timebutton").removeClass('bluetext');
			$(".timebutton").addClass('graytext');

			$("#"+classID).addClass("invert");
			$("#"+classID).addClass("bluetext");
			$("#"+classID).removeClass("graytext");

			if (classID === "all") {
				$(".timerows").removeClass("timeHide");
			} else {
				$(".timerows").addClass("timeHide");
				$(".row_"+classID).removeClass("timeHide");
			}

			doHide();
			return;
		}

		function doHide() {
			$(".events").removeClass("hidden");
			$(".timeHide").addClass("hidden");
			$(".eventHide").addClass("hidden");
			$("table").trigger("applyWidgets");
			return;
		}

		$(document).ready(function() {
%			if ($ARGS{"results"} || $after || (not defined $current_count)) {
				showTime("past");
%			} else {
				showTime("current");
%			}
		});

	</script>

	<div class="main">

		<span class="seventenths nowrap nospace">
			<h5 class="wrap">Dashboard: <% $tourn->name %></h5>
		</span>

		<span class="fifth rightalign nowrap nospace semibold bluetext bigger">
			<% $now->day_abbr %> / <& "/funclib/showtime.mas", dt => $now &>
		</span>

		<span class="tenth rightalign nospace">
			<a
				href="/user/chapter/tournaments.mhtml?chapter_id=<% $school->chapter->id %>"
				title="Return to <% $school->chapter->name %> Home"
				class="fa fa-lg fa-home buttonwhite greentext"
			></a>
		</span>


		<div class="ltbordervert odd centeralign">
<%perl>

			my %rooms;

			if ($tourn_settings{"online_rooms"}) {

				if (@{$tourn_settings{"online_rooms"}}) {

					foreach my $room (@{$tourn_settings{"online_rooms"}}) {

						if ($room->{access} eq "coach") {
							$rooms{"coach"}{$room->{id}}{name} = $room->{"name"};
							$rooms{"coach"}{$room->{id}}{thing} = $room;
						}
					}
				}
			}

			if ($tourn_settings{"nsda_campus_purchased"}) {
</%perl>

				<span class="third leftalign">
					<span class="threequarters semibold bluetext">
						<span class="halfspace"></span>
						<% Tab::short_name($school->name) %> Squad Room
					</span>

					<span class="quarter centeralign padvert nospace">
						<& "/funclib/online_room.mas",
							school => $school->id,
							person => $person,
							show   => 1,
							class  => "fa"
						&>
					</span>
				</span>
%			}

%			foreach my $room_id (keys %{$rooms{"coach"}}) {

				<span class="third leftalign">
					<span class="threequarters semibold bluetext">
						<span class="halfspace"></span>
						<% $rooms{"coach"}{$room_id}{"name"} %>
					</span>

					<span class="quarter centeralign padvert nospace">
						<& "/funclib/online_room.mas",
							util   => $rooms{"coach"}{$room_id}{"thing"},
							person => $person,
							show   => 1,
							class  => "fa"
						&>
					</span>
				</span>
%			}

		</div>

%		if (@flip_cards) {
			<div class="full padvertmore centeralign ltbordertop redborderbottom">
				<a
					href  = "/user/enter/flip.mhtml"
					class = "buttonwhite orangetext hover invert"
				>Coinflip Choices Available</a>
			</div>

			<br />
%		}

%		if ($strike_cards{$school_id}) {

			<div class="full padvertmore centeralign ltbordertop redborderbottom">

				<a
					href  = "/user/enter/strike_cards.mhtml"
					class = "buttonwhite orangetext hover invert"
				>Strike Cards Available</a>

			</div>
			<br />
%		}

		<& /funclib/tablesorter.mas, table => $school_id."_entries" &>

		<span class="fifth nospace">
			<h5>Entries</h5>
		</span>

		<span class="twofifths centeralign nospace">
			<a
				id      = "current"
				class   = "buttonwhite bluetext timebutton fifth"
				onClick = "showTime('current');"
			>Current</a>
			<a
				id      = "future"
				class   = "buttonwhite greytext timebutton fifth"
				onClick = "showTime('future');"
			>Future</a>
			<a
				id      = "past"
				class   = "buttonwhite greytext timebutton fifth"
				onClick = "showTime('past');"
			>Past</a>
			<a
				id      = "all"
				class   = "buttonwhite greytext timebutton fifth"
				onClick = "showTime('all');"
			>All</a>
		</span>

		<span class="threetenths centeralign padno">
			<select
				id       = "event_selector"
				class    = "fixedmed"
				onChange = "showEvent(this);"
			>
				<option value="all">All Events</option>

%				foreach my $event_id ( sort {$events{$a} cmp $events{$b}} keys %events) {
					<option value="<% $event_id %>"><% $events{$event_id} %></option>
%				}

			</select>
		</span>

		<span
			id="<% $school_id %>_entries_buttonarea"
			class="tenth rightalign">
		</span>

		<table id="<% $school_id %>_entries" class="smallish">

			<thead>
				<tr class="yellowrow smaller">

					<th>
						Code
					</th>

					<th>
						Entry
					</th>

					<th>
						Event
					</th>

					<th>
						Rnd
					</th>

					<th>
						Start
					</th>

					<th>
						Room
					</th>

					<th title="Speakerorder">
						Spk
					</th>

					<th>
						Judging
					</th>

					<th>
						Status
					</th>

					<th>
						Feedback
					</th>
				</tr>
			</thead>

			<tbody>
<%perl>
				foreach my $entry_id (
					sort {
						$now{"entries"}{$a}{"entry_code"} <=> $now{"entries"}{$b}{"entry_code"}
						|| $now{"entries"}{$a}{"entry_code"} cmp $now{"entries"}{$b}{"entry_code"}
					} keys %{$now{"entries"}}
				) {

					my $entry = $now{"entries"}{$entry_id};

					foreach my $section_id (
						sort {
							$entry->{"sections"}{$a}{round_num}
								<=>
							$entry->{"sections"}{$b}{round_num}
						} keys %{$entry->{"sections"}}
					) {

						my $section = $entry->{'sections'}{$section_id};

</%perl>

						<tr class="timerows <% $section->{status} %> row_<% $section->{status} %> <% $entry->{event_id} %> events">

							<td class="semibold bluetext">
								<% $entry->{"entry_code"} %>
							</td>

							<td class="bluetext">
								<% $entry->{"entry_name"} %>
							</td>

							<td class="centeralign">
								<% $entry->{"event_abbr"} %>
							</td>

							<td class="centeralign">
								<% $section->{round_name} %>
								<%
									$section->{round_flighted} > 1
									? "Flt ".$section->{panel_flight}
									: ""
								%>
							</td>

							<td class="centeralign nospace">
								<span class="third">
									<% $section->{start_time}
										?  $section->{start_time}->day_abbr
										: ""
									%>
								</span>
								<span class="twothirds">
									<& "/funclib/showtime.mas",
										dt => $section->{start_time}
									&>
								</span>
							</td>

							<td>
								<% $section->{room_name} %>
							</td>

							<td class="centeralign">
								<% $section->{order}
									? Lingua::EN::Numbers::Ordinate::ordinate($section->{order})
									: ""
								%>
								<% $section->{side} %>
							</td>

							<td class="nospace">
<%perl>
								foreach my $judge_id (
									keys %{$section->{judges}}
								) {

									my $judge = $section->{judges}{$judge_id};
</%perl>
									<div class="full nospace padvertless smallish">

%										if ($tourn_settings{"ncfl"}) {

											<% $judge->{code} %>

%										} else {

%											if ($judge->{code}) {
												<span class="quarter nospace">
													<% $judge->{code} %>
												</span>

												<span class="threequarters nospace">
%											}

											<% $judge->{last} %>, <% $judge->{first} %>

%											if ($judge->{code}) {
												</span>
%											}
%										}
									</div>
%								}
							</td>

							<td class="nospace">

%								if ($section->{panel_bye}) {
									<div class="full centeralign redtext semibold">
										BYE
									</div>
<%perl>
								} else {
								foreach my $judge_id (
									keys %{$section->{judges}}
								) {

									my $judge = $section->{judges}{$judge_id};

									if ($judge->{point} || $judge->{rank} || $judge->{win}) {

										if ($entry->{event_type} eq "debate"
											|| $entry->{event_type} eq "wudc"
										) {

											if ($judge->{point} || $judge->{rank}) {

												my @students = keys %{$judge->{students}};
</%perl>
												<div class="full nospace padvertless smallish">
													<span class="fifth semibold nospace centeralign
														<% $judge->{win} eq "W"
															? "greentext"
															: $judge->{win} eq "L"
																? "redtext"
																: "bluetext"
														%>"
													>
														<% $judge->{win} %>
													</span>

													<span class="fourfifths nospace">
%														if (scalar @students > 1) {
%															foreach my $student_id (sort @students) {

																<div
																	title="<% $judge->{students}{$student_id}{"name"} %>"
																	class="full nospace smaller hover"
																>

																	<span class="half nowrap nospace padvertless">
																		<% $judge->{students}{$student_id}{"name"} %>
																	</span>

																	<span class="threeeighths nospace rightalign">
																		<% $judge->{point}{$student_id} %>
																	</span>

																	<span class="eighth nospace">
																		<% $judge->{rank}{$student_id} %>
																	</span>
																</div>
%															}
%														} elsif (@students) {
															<span class="half">
																<% $judge->{point}{$students[0]} %>
															</span>

															<span class="half">
																<% $judge->{rank}{$students[0]} %>
															</span>
%														}
													</span>

												</div>

%											} else {

												<div class="full nospace padvertless semibold centeralign
													<% $judge->{win} eq "W"
														? "greentext"
														: $judge->{win} eq "L"
															? "redtext"
															: "bluetext"
													%>"
												>
													<% $judge->{win} %>
												</div>
%											}

%										} elsif ($entry->{event_type} eq "speech") {

											<div class="full nospace smallish">
												<span class="third centeralign">
													<% $judge->{rank} %>
												</span>

												<span class="half rightalign">
													<% $judge->{point} %>
												</span>
											</div>

%										} elsif ($entry->{event_type} eq "wudc") {

%											my @students = keys %{$judge->{students}};

											<div class="full nospace smallish">
												<span class="third">
													<% $judge->{rank} %>
												</span>

%												if (scalar @students > 1) {
													<span class="twothirds">
%													foreach my $student_id (@students) {
														<div class="full nospace padvertless">
															<span class="twothirds">
																<% $judge->{students}{$student_id}{"name"} %>
															</span>

															<span class="third">
																<% $judge->{point}{$student_id} %>
															</span>
														</div>
%													}
													</span>
%												}
											</div>
%										}

%									} elsif ($judge->{audited}) {

										<div class="full nospace padvertless semibold redtext centeralign">
											VOTED
										</div>

%									} elsif ($judge->{started}) {

										<div class="full nospace padvertless semibold greentext centeralign">
											Started @
											<& "/funclib/showtime.mas",
												dt => $judge->{started}
											&>
										</div>

%									} else {

										<div class="full nospace padvertless semibold bluetext">
										</div>
%									}
%								} }
							</td>

							<td class="centeralign nospace">
%								if ($section->{rfd}) {
									<a
										class   = "fa fa-sm buttonwhite bluetext fa-file-text marless"
										id      = "<% $section_id %>_button"
										onClick = "showRFD(<% $section_id %>);"
									></a>
%								}
							</td>

						</tr>

<%perl>
						if ($section->{rfd}) {
							foreach my $judge_id (
								keys %{$section->{judges}}
							) {

								my $judge = $section->{judges}{$judge_id};

								next unless $judge->{rfd} || $judge->{comments};
</%perl>
								<tr id="<% $section_id %>_rfd" class="hidden odd bordertop borderbottom">

									<td colspan="23">

									<h6 class="centeralign">
										Feedback from <% $judge->{code}." ".$judge->{first}." ".$judge->{last} %>
									</h6>

%									if ($judge->{rfd}) {
										<p><div class="semibold bluetext full nospace padverless">RFD</div>
											<% Tab::Score::uncompress($judge->{rfd}) %>
										</p>
%									}

%									if ($judge->{comments}) {
										<p><div class="semibold bluetext full nospace padverless">Comments</div>
											<% Tab::Score::uncompress($judge->{comments}) %>
										</p>
%									}

									</td>
								</tr>
<%perl>
							}
						}
					}
				}
</%perl>
			</tbody>

		</table>

		<& /funclib/tablesorter.mas, table => $school_id."_judges" &>

		<span class="threequarters nospace">
			<h5>Judges</h5>
		</span>

		<span
			id="<% $school_id %>_judges_buttonarea"
			class="quarter rightalign">
		</span>

		<table id="<% $school_id %>_judges">

			<thead>
				<tr class="yellowrow">

					<th>
						Judge
					</th>

					<th>
						Event
					</th>

					<th>
						Rnd
					</th>

					<th>
						Start
					</th>

					<th>
						Room
					</th>

					<th>
						Entries
					</th>

					<th>
						Results
					</th>

					<th>
						Feedback
					</th>
				</tr>
			</thead>

			<tbody>
<%perl>

				foreach my $judge_id (
					sort {
						$now{"judges"}{$a}{"judge_last"} cmp $now{"judges"}{$b}{"judge_last"}
					} keys %{$now{"judges"}}
				) {

					my $judge = $now{"judges"}{$judge_id};

					foreach my $section_id (
						sort {
							$judge->{"sections"}{$a}{round_num}
								<=>
							$judge->{"sections"}{$b}{round_num}
						} keys %{$judge->{"sections"}}
					) {

						my $section = $judge->{'sections'}{$section_id};
</%perl>

						<tr class="timerows <% $section->{status} %> row_<% $section->{status} %> <% $section->{event_id} %> events">

							<td class="semibold bluetext">
								<% $judge->{"judge_last"} %>, <% $judge->{"judge_first"} %>
							</td>

							<td class="centeralign">
								<% $section->{"event_abbr"} %>
							</td>

							<td class="centeralign">
								<% $section->{round_name} %>
								<%
									$section->{round_flighted} > 1
									? "Flt ".$section->{panel_flight}
									: ""
								%>
							</td>

							<td class="centeralign">
								<span class="third">
									<% $section->{start_time}
										?  $section->{start_time}->day_abbr
										: ""
									%>
								</span>
								<span class="twothirds">
									<& "/funclib/showtime.mas",
										dt => $section->{start_time}
									&>
								</span>
							</td>

							<td>
								<% $section->{room_name} %>
							</td>

							<td>
<%perl>
								if ($section->{event_type} eq "debate") {
									foreach my $entry_id (
										sort {
											$section->{entries}{$a}{side_number} <=> $section->{entries}{$b}{side_number}
											|| $section->{entries}{$a}{order} <=> $section->{entries}{$b}{order}
										} keys %{$section->{entries}}
									) {

										my $entry = $section->{entries}{$entry_id};
</%perl>
										<div class="full nospace padvertless">
											<span class="fifth nospace">
												<% $entry->{side} %>
											</span>
											<span class="fourfifths nospace">
												<% $entry->{code} %>
											</span>
										</div>
%									}
%								}
							</td>

							<td class="nospace limithalf smallish">
<%perl>
								foreach my $entry_id (
									sort {
										$section->{entries}{$a}{side_number} <=> $section->{entries}{$b}{side_number}
										|| $section->{entries}{$a}{order} <=> $section->{entries}{$b}{order}
									} keys %{$section->{entries}}
								) {

									my $entry = $section->{entries}{$entry_id};

									if ($entry->{point} || $entry->{rank} || $entry->{win}) {

										if ($section->{event_type} eq "debate"
											|| $section->{event_type} eq "wudc"
										) {

											if ($entry->{point} || $entry->{rank}) {

												my @students = keys %{$entry->{students}};
</%perl>
												<div class="full nospace padvertmuchless
													<% scalar @students > 1 ? "ltborderbottom" : "padvertless" %>"
												>

													<span class="fifth semibold nospace centeralign
														<% $entry->{win} eq "W" ? "greentext" : "redtext" %>"
													>
														<% $entry->{win} %>
													</span>

													<span class="fourfifths nospace">
%														if (scalar @students > 1) {
%															foreach my $student_id (sort @students) {

																<div
																	title="<% $entry->{students}{$student_id}{"name"} %>"
																	class="full nospace hover"
																>

																	<span class="half nowrap nospace padvertless">
																		<% $entry->{students}{$student_id}{"name"} %>
																	</span>

																	<span class="threeeighths nospace rightalign">
																		<% $entry->{point}{$student_id} %>
																	</span>

																	<span class="eighth nospace">
																		<% $entry->{rank}{$student_id} %>
																	</span>
																</div>
%															}
%														} elsif (@students) {
															<span class="half nospace">
																<% $entry->{point}{$students[0]} %>
															</span>

															<span class="fourtenths nospace">
																<% $entry->{rank}{$students[0]} %>
															</span>
%														}
													</span>
												</div>

%											} else {

												<div class="full nospace padvertless semibold leftalign padleft
													<% $entry->{win} eq "W" ? "greentext" : "redtext" %>"
												>
													<% $entry->{win} %>
												</div>
%											}

%										} elsif ($section->{event_type} eq "speech") {

											<span class="half">
												<% $entry->{code} %>
											</span>

											<span class="sixth centeralign">
												<% $entry->{rank} %>
											</span>

											<span class="third rightalign">
												<% $entry->{point} %>
											</span>

%										} elsif ($section->{event_type} eq "wudc") {

%											my @students = keys %{$entry->{students}};

											<span class="third">
												<% $entry->{rank} %>
											</span>

%											if (scalar @students > 1) {
												<span class="twothirds">
%												foreach my $student_id (@students) {
													<div class="full nospace padvertless">
														<span class="twothirds">
															<% $entry->{students}{$student_id}{"name"} %>
														</span>

														<span class="third">
															<% $entry->{point}{$student_id} %>
														</span>
													</div>
%												}
												</span>
%											}
%										}

%									} elsif ($section->{audited}) {

										<div class="full nospace padvertless semibold redtext centeralign">
											VOTED
										</div>

%									} elsif ($section->{started}) {

										<div class="full nospace padvertless semibold greentext centeralign">
											Started @
											<& "/funclib/showtime.mas",
												dt => $section->{started}
											&>
										</div>

%									} else {

										<div class="full nospace padvertless semibold bluetext">
										</div>
%									}
%								}

							</td>

							<td class="centeralign nospace">
%								if ($section->{rfd} || $section->{comments}) {
									<a
										class   = "fa fa-sm buttonwhite bluetext fa-file-text marless"
										id      = "<% $section_id %>_button"
										onClick = "showRFD(<% $section_id %>);"
									></a>
%								}
							</td>
						</tr>

%						if ($section->{rfd} || $section->{comments}) {

							<tr id="<% $section_id %>_rfd" class="hidden odd bordertop borderbottom">

								<td colspan="23">

%									if ($section->{rfd}) {
										<h6 class="centeralign">
											RFD
										</h6>

										<p><div class="semibold bluetext full nospace padverless">RFD</div>
											<% Tab::Score::uncompress($section->{rfd}) %>
										</p>
%									}

<%perl>
									foreach my $entry_id (
										sort {
											$section->{entries}{$a}{side_number} <=> $section->{entries}{$b}{side_number}
											|| $section->{entries}{$a}{order} <=> $section->{entries}{$b}{order}
										} keys %{$section->{entries}}
									) {

										my $entry = $section->{entries}{$entry_id};
										next unless $entry->{comments};
</%perl>

										<h6 class="centeralign">
											Feedback for <% $entry->{code}." ".$entry->{first}." ".$entry->{last} %>
										</h6>

%										if ($entry->{comments}) {
											<p><div class="semibold bluetext full nospace padverless">Comments</div>
												<% Tab::Score::uncompress($entry->{comments}) %>
											</p>
%										}
%									}

								</td>
							</tr>
<%perl>
						}
					}
				}
</%perl>

			</tbody>
		</table>

%		if (keys %jpools) {

			<& /funclib/tablesorter.mas,
				table => $school_id."_jpools"
			&>

			<span class="threequarters nospace">
				<h5>Judge Pools</h5>
			</span>

			<span
				id="<% $school_id %>_jpools_buttonarea"
				class="quarter rightalign">
			</span>

			<table id="<% $school_id %>_jpools">

				<thead>
					<tr class="yellowrow">
						<th>
							Judge Name
						</th>

						<th>
							Judge Code
						</th>

						<th>
							Pool Name
						</th>

						<th>
						</th>
					</tr>
				</thead>

				<tbody>
%					foreach my $judge_id (sort keys %jpools) {
%						foreach my $jpool_id (sort keys %{$jpools{$judge_id}}) {
							<tr>
								<td>
									<% $jpools{$judge_id}{$jpool_id}{"judge_name"} %>
								</td>

								<td>
									<% $jpools{$judge_id}{$jpool_id}{"judge_code"} %>
								</td>

								<td>
									<span class="padvertless full marno">
									<% $jpools{$judge_id}{$jpool_id}{"name"} %>
									</span>
								</td>

								<td>
									<% $jpools{$judge_id}{$jpool_id}{"message"} %>
								</td>
							</tr>
%						}
%					}
				</tbody>
			</table>
%		}


		<p class="martopmuchmore whitetext centeralign">
			The idea for this dashboard was brought to you by Tripp Rebrovick
		</p>

	</div>

%	$dbh->disconnect();
