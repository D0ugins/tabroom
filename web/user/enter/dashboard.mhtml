<%args>
	$school
	$person
</%args>
<%init>

	# The Where My People At summary dashboard.  Idea courtesy Tripp Reprovick.

	my $tourn = $school->tourn;
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $school_id = $school->id;

	my %tourn_settings = $tourn->all_settings;

	# Time Frame begins 15 minutes ago and shows the future
	my $now = DateTime->now();
	$now->subtract(minutes => 15);

	my $now_string = DateTime::Format::MySQL->format_datetime($now);

	my $after++ if $now > $tourn->end;

	my $dbh = Tab::DBI->db_Main();

	my $now_sth = $dbh->prepare("
		select
			entry.id, entry.code, entry.name,
			room.name, panel.letter, panel.id, panel.flight, panel.publish,
			panel.bye,
			ballot.id, ballot.side, ballot.speakerorder, ballot.audit, ballot.judge_started,
			ballot.bye, ballot.forfeit, ballot.chair,
			opponent.code,
			score.id, score.tag, score.value, score.speech, score.content, score.topic, score.position,
			score_student.id, score_student.first, score_student.last,
			round.name, round.label, round.start_time, round.flighted,
			round.published, round.post_primary, round.post_secondary, round.post_feedback,
			flight_offset.value,
			judge_publish_results.value,
			timeslot.start, timeslot.end,
			event.id, event.abbr, event.type,
			judge.id, judge.code, judge.first, judge.last, judgeschool.name,
			aff_label.value, neg_label.value,
			online.value, online_mode.value

		from (entry, ballot, panel, round, timeslot, event)

			left join room on panel.room = room.id
			left join judge on ballot.judge = judge.id

			left join school judgeschool on judgeschool.id = judge.school

			left join ballot otherballot
				on otherballot.panel = panel.id
				and otherballot.entry != entry.id

			left join entry opponent
				on otherballot.entry = opponent.id

			left join event_setting online
				on online.event = event.id
				and online.tag = 'online'

			left join event_setting online_mode
				on online_mode.event = event.id
				and online_mode.tag = 'online_mode'

			left join event_setting flight_offset
				on flight_offset.event = event.id
				and flight_offset.tag = 'flight_offset'

			left join event_setting judge_publish_results
				on judge_publish_results.event = event.id
				and judge_publish_results.tag = 'judge_publish_results'

			left join event_setting aff_label
				on aff_label.event = event.id
				and aff_label.tag = 'aff_label'

			left join event_setting neg_label
				on neg_label.event = event.id
				and neg_label.tag = 'neg_label'

			left join score on ballot.id = score.ballot

			left join student score_student
				on score_student.id = score.student

		where entry.school = ?
			and entry.id = ballot.entry
			and ballot.panel = panel.id
			and panel.round = round.id
			and round.timeslot = timeslot.id
			and round.event = event.id

		order by event.abbr, entry.code, round.name
	");

	$now_sth->execute($school_id);
	my %now;
	my %events;

	my $current_count;

	while (
		my (
			$entry_id, $entry_code, $entry_name,
			$room_name, $panel_letter, $panel_id, $panel_flight, $panel_publish,
			$panel_bye,
			$ballot_id, $ballot_side, $ballot_speakerorder, $ballot_audit, $ballot_started,
			$ballot_bye, $ballot_forfeit, $ballot_chair,
			$opponent_code,

			$score_id, $score_tag, $score_value, $score_speech, $score_content, $score_topic, $score_position,
			$score_student_id, $score_student_first, $score_student_last,

			$round_name, $round_label, $round_start_time, $round_flighted,
			$round_published, $post_primary, $post_secondary, $post_feedback,
			$flight_offset,
			$judge_publish_results,
			$timeslot_start, $timeslot_end,
			$event_id, $event_abbr, $event_type,
			$judge_id, $judge_code, $judge_first, $judge_last, $judgeschool_name,
			$aff_label, $neg_label,
			$online, $online_mode
		) = $now_sth->fetchrow_array()

	) {

		next unless (
			$round_published > 0
			|| $post_primary > 0
			|| $post_secondary > 0
			|| $post_feedback > 0
		);


		if (
			($now{"nein_publish"}{$panel_id} > 0)
			|| ($ballot_audit < 1)
		) {
			undef $post_primary;
			undef $post_secondary;
			undef $post_feedback;
			undef $panel_publish;
			$now{"nein_publish"}{$panel_id}++;
		}

		if ($event_type eq "congress") {
			next if ($ballot_chair && (not defined $score_tag));
		}

		$events{$event_id} = $event_abbr;

		unless ($now{"entries"}{$entry_id}) {

			$now{"entries"}{$entry_id}{entry_code} = $entry_code;
			$now{"entries"}{$entry_id}{entry_name} = $entry_name;
			$now{"entries"}{$entry_id}{event_abbr} = $event_abbr;
			$now{"entries"}{$entry_id}{event_id}   = $event_id;
			$now{"entries"}{$entry_id}{event_type} = $event_type;

			$now{"entries"}{$entry_id}{online} = $online;
			$now{"entries"}{$entry_id}{online_mode} = $online_mode;
		}

		unless ($now{"entries"}{$entry_id}{"section"}{$panel_id}) {

			$now{"entries"}{$entry_id}{"section"}{$panel_id}{room_name} = $room_name;
			$now{"entries"}{$entry_id}{"section"}{$panel_id}{round_num} = $round_name;

			if ($round_label) {
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{round_name} = $round_label;
			} else {
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{round_name} = $round_name;
			}

			$now{"entries"}{$entry_id}{"section"}{$panel_id}{round_flighted} = $round_flighted;
			$now{"entries"}{$entry_id}{"section"}{$panel_id}{panel_flight} = $panel_flight;
			$now{"entries"}{$entry_id}{"section"}{$panel_id}{side_number} = $ballot_side;

			if ($event_type eq "congress") {

			} elsif ($event_type eq "wudc") {

				if ($ballot_speakerorder == 1) {
					$now{"entries"}{$entry_id}{"section"}{$panel_id}{order} = "1G";
				} elsif ($ballot_speakerorder == 2) {
					$now{"entries"}{$entry_id}{"section"}{$panel_id}{order} = "1O";
				} elsif ($ballot_speakerorder == 3) {
					$now{"entries"}{$entry_id}{"section"}{$panel_id}{order} = "2G";
				} elsif ($ballot_speakerorder == 4) {
					$now{"entries"}{$entry_id}{"section"}{$panel_id}{order} = "2O";
				}

			} elsif ($ballot_speakerorder && $ballot_side == 1) {

				$now{"entries"}{$entry_id}{"section"}{$panel_id}{order} = $ballot_speakerorder;
				$aff_label = "Aff" unless $aff_label;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side_init} = substr($aff_label,0,1);
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side} = $aff_label;

			} elsif ($ballot_speakerorder && $ballot_side == 2) {

				$now{"entries"}{$entry_id}{"section"}{$panel_id}{order} = $ballot_speakerorder;
				$neg_label = "Neg" unless $neg_label;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side} = $neg_label;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side_init} = substr($neg_label,0,1);

			} elsif ($ballot_speakerorder) {

				$now{"entries"}{$entry_id}{"section"}{$panel_id}{order} = $ballot_speakerorder;

			} elsif ($panel_bye) {

				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side} = "Bye";

			} elsif ($ballot_side == 1) {

				$aff_label = "Aff" unless $aff_label;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side_init} = substr($aff_label,0,1);
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side} = $aff_label;

			} elsif ($ballot_side == 2) {

				$neg_label = "Neg" unless $neg_label;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side} = $neg_label;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{side_init} = substr($neg_label,0,1);
			}

			my $dt;

			$round_start_time = $timeslot_start unless $round_start_time;

			unless ($now{"starts"}{$round_start_time}) {
				$dt = DateTime::Format::MySQL->parse_datetime($round_start_time);
				$dt->set_time_zone("UTC");
				$dt->set_time_zone($tz);
				$now{"starts"}{$round_start_time} = $dt;
			} else {
				$dt = $now{"starts"}{$round_start_time};
			}

			my $end_dt;

			unless ($now{"starts"}{$timeslot_end}) {
				$end_dt = DateTime::Format::MySQL->parse_datetime($timeslot_end);
				$end_dt->set_time_zone("UTC");
				$end_dt->set_time_zone($tz);
				$now{"starts"}{$timeslot_end} = $end_dt;
			} else {
				$end_dt = $now{"starts"}{$timeslot_end};
			}

			if ($round_flighted > 1 && $flight_offset) {
				my $clone = $dt->clone();
				$dt = $clone;
				$dt->add( minutes => $flight_offset * ($panel_flight - 1) );
			}

			$now{"entries"}{$entry_id}{"section"}{$panel_id}{"start_time"} = $dt;

			if (
				($dt->epoch < $now->epoch)
				&& ($end_dt->epoch > $now->epoch)
			) {
				$current_count++;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{"status"} = "current";
			} elsif ($dt->epoch > $now->epoch) {
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{"status"} = "future";
			} else {
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{"status"} = "past";
			}
		}

		if (
			$round_published == 1
			|| $post_primary > 0
			|| $post_secondary > 0
			|| $post_feedback > 0
		) {

			unless ($now{"entries"}{$entry_id}{"section"}{$panel_id}{judges}{$judge_id}) {
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{judges}{$judge_id}{"code"}  = $judge_code;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{judges}{$judge_id}{"first"} = $judge_first;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{judges}{$judge_id}{"last"}  = $judge_last;
				$now{"entries"}{$entry_id}{"section"}{$panel_id}{judges}{$judge_id}{"school"}  = $judgeschool_name;
			}

			my $judge = $now{"entries"}{$entry_id}{"section"}{$panel_id}{judges}{$judge_id};

			unless ($judge->{"started"}) {
				if ($ballot_started) {
					$judge->{"started"} = eval {
						return DateTime::Format::MySQL->parse_datetime($ballot_started);
					};

					if ($judge->{'started'}) {
						$judge->{"started"}->set_time_zone("UTC");
						$judge->{"started"}->set_time_zone($tz);
					}
				}
			}

			if ($event_type eq "congress") {
				$judge->{chair} = $ballot_chair;
			}

			if ($ballot_audit) {

				$judge->{"audited"}++;

				if ($ballot_bye) {

					$now{"entries"}{$entry_id}{"section"}{$panel_id}{bye} = "Bye";

				} elsif ($ballot_forfeit) {

					$now{"entries"}{$entry_id}{"section"}{$panel_id}{bye} = "Forfeit";

				} elsif ($panel_publish && $judge_publish_results eq "all") {

					$post_primary   = 3;
					$post_secondary = 3;
					$post_feedback  = 3;

				} elsif ($panel_publish && $judge_publish_results eq "winloss") {

					$post_primary   = 3;
				}

				if ($event_type eq "speech" || $event_type eq "wudc" || $event_type eq "congress") {

					if ($post_primary > 0 && $score_tag eq "rank")  {
						$judge->{$score_tag}  = $score_value;
					}

					if ($post_secondary > 0 && $score_tag eq "point") {
						$judge->{$score_tag}  = $score_value;
					}

				} elsif ($event_type eq "wsdc" || $event_type eq "debate") {

					if ($post_primary > 0 && $score_tag eq "winloss") {

						if ($panel_bye || $ballot_bye) {
							$judge->{$score_tag}  = "Bye";
						} elsif ($ballot_forfeit) {
							$judge->{$score_tag}  = "Fft";
						} elsif ($score_value == 1) {
							$judge->{$score_tag}  = "W";
						} elsif ($score_value == 0) {
							$judge->{$score_tag}  = "L";
						}
					}

					if ($post_secondary > 0 && ($score_tag eq "point" || $score_tag eq "rank")) {

						if ($score_student_id) {

							$judge->{by_student}{$score_tag}++;

							$judge->{students}{$score_student_id}{"name"}
								= $score_student_first." ".substr($score_student_last, 0, 1);

							$judge->{students}{$score_student_id}{"initials"}
								= substr($score_student_first,0,1).substr($score_student_last,0,1);

							$judge->{$score_tag}{$score_student_id}  = $score_value;

						} else {

							$judge->{by_entry}{$score_tag}++;
							$judge->{$score_tag}  = $score_value;
						}
					}
				}

				if ($post_feedback > 0) {

					if ($score_content && ($score_tag eq "rfd" || $score_tag eq "comments")) {
						$judge->{$score_tag} = $score_content;
						$judge->{"topic"} = $score_topic;
						$now{"entries"}{$entry_id}{"section"}{$panel_id}{"rfd"}++;
					}

					if ($score_tag eq 'speech') {
						$now{"entries"}{$entry_id}{"section"}{$panel_id}{"rfd"}++;
						$judge->{"speeches"}{$score_speech}{"point"}    = $score_value;
						$judge->{"speeches"}{$score_speech}{"position"} = $score_position;
						$judge->{"speeches"}{$score_speech}{"topic"}    = $score_topic;
						$judge->{"speeches"}{$score_speech}{"content"}  = $score_content;
					}
				}

			} else {

			}
		}
	}

	my $judge_now_sth = $dbh->prepare("

		select
			judge.id, judge.code, judge.first, judge.last,
			category.abbr,
			room.name,
			panel.letter, panel.id, panel.flight, panel.publish, panel.bye,
			ballot.id, ballot.side, ballot.speakerorder, ballot.judge_started, ballot.audit, ballot.chair,

			score.id, score.tag, score.value, score.speech, score.content, score.topic, score.position,
			score_student.id, score_student.first, score_student.last,

			round.name, round.label, round.start_time,
			round.published, round.post_primary, round.post_secondary, round.post_feedback,
			timeslot.start, timeslot.end,
			event.id, event.abbr, event.type,
			entry.id, entry.code, entry.name, entryschool.name,
			judge_publish_results.value,
			aff_label.value, neg_label.value

		from (judge, ballot, panel, round, timeslot, event, category, entry)

			left join score on score.ballot = ballot.id

			left join school entryschool on entryschool.id = entry.school

			left join student score_student
				on score_student.id = score.student

			left join event_setting judge_publish_results
				on judge_publish_results.event = event.id
				and judge_publish_results.tag = 'judge_publish_results'

			left join event_setting aff_label
				on aff_label.event = event.id
				and aff_label.tag = 'aff_label'

			left join event_setting neg_label
				on neg_label.event = event.id
				and neg_label.tag = 'neg_label'

			left join room on panel.room = room.id

		where judge.school = ?
			and judge.id = ballot.judge
			and ballot.panel = panel.id
			and panel.round = round.id
			and round.timeslot = timeslot.id
			and round.event = event.id
			and judge.category = category.id
			and ballot.entry = entry.id

		order by category.abbr, judge.last, timeslot.start
	");

	$judge_now_sth->execute($school_id);

	while (
		my (
			$judge_id, $judge_code, $judge_first, $judge_last,
			$category_abbr,
			$room_name,
			$panel_letter, $panel_id, $panel_flight, $panel_publish, $panel_bye,
			$ballot_id, $ballot_side, $ballot_speakerorder, $ballot_started, $ballot_audit, $ballot_chair,

			$score_id, $score_tag, $score_value, $score_speech, $score_content, $score_topic, $score_position,
			$score_student_id, $score_student_first, $score_student_last,

			$round_name, $round_label, $round_start_time,
			$round_published, $post_primary, $post_secondary, $post_feedback,
			$timeslot_start, $timeslot_end,
			$event_id, $event_abbr, $event_type,
			$entry_id, $entry_code, $entry_name, $entryschool_name,
			$judge_publish_results,
			$aff_label, $neg_label
		) = $judge_now_sth->fetchrow_array()
	) {

		next unless (
			$round_published > 0
			|| $post_primary > 0
			|| $post_secondary > 0
			|| $post_feedback > 0
			|| $panel_publish
		);

		$events{$event_id} = $event_abbr;

		unless ($now{"judges"}{$judge_id}) {

			$now{"judges"}{$judge_id}{judge_code}    = $judge_code;
			$now{"judges"}{$judge_id}{judge_first}   = $judge_first;
			$now{"judges"}{$judge_id}{judge_last}    = $judge_last;
			$now{"judges"}{$judge_id}{category_abbr} = $category_abbr;
		}

		unless ($now{"judges"}{$judge_id}{"section"}{$panel_id}) {

			$now{"judges"}{$judge_id}{"section"}{$panel_id}{room_name}  = $room_name;
			$now{"judges"}{$judge_id}{"section"}{$panel_id}{round_num}  = $round_name;
			$now{"judges"}{$judge_id}{"section"}{$panel_id}{round_name} = $round_name;
			$now{"judges"}{$judge_id}{"section"}{$panel_id}{round_name} = $round_label
				if $round_label;

			$now{"judges"}{$judge_id}{"section"}{$panel_id}{panel_bye}    = $panel_bye;
			$now{"judges"}{$judge_id}{"section"}{$panel_id}{panel_flight} = $panel_flight;
			$now{"judges"}{$judge_id}{"section"}{$panel_id}{event_abbr}   = $event_abbr;
			$now{"judges"}{$judge_id}{"section"}{$panel_id}{event_id}     = $event_id;
			$now{"judges"}{$judge_id}{"section"}{$panel_id}{event_type}   = $event_type;
			$now{"judges"}{$judge_id}{"section"}{$panel_id}{audited}      = $ballot_audit;

			my $dt;

			unless ($now{"starts"}{$round_start_time}) {

				$dt = eval{
					my $dt = DateTime::Format::MySQL->parse_datetime($round_start_time);
					$dt->set_time_zone("UTC");
					$dt->set_time_zone($tz);
					return $dt;
				};

				if ($dt) {
					$now{"starts"}{$round_start_time} = $dt;
				}

			} else {
				$dt = $now{"starts"}{$round_start_time};
			}

			$now{"judges"}{$judge_id}{"section"}{$panel_id}{"start_time"} = $dt;

			if ($dt > $now && (not defined $now{"judges"}{$judge_id}{"current"} )) {
				$now{"judges"}{$judge_id}{"current"}++;
				$now{"judges"}{$judge_id}{"section"}{$panel_id}{"status"} = "current";
			} elsif ($dt > $now) {
				$now{"judges"}{$judge_id}{"section"}{$panel_id}{"status"} = "future";
			} else {
				$now{"judges"}{$judge_id}{"section"}{$panel_id}{"status"} = "past";
			}
		}

		my $section = $now{"judges"}{$judge_id}{"section"}{$panel_id};

		$section->{entries}{$entry_id}{"code"}  = $entry_code;
		$section->{entries}{$entry_id}{"name"}  = $entry_name;
		$section->{entries}{$entry_id}{"school"}  = $entryschool_name;

		unless ($section->{"started"}) {
			$section->{"started"} = eval {
				return DateTime::Format::MySQL->parse_datetime($ballot_started);
			};

			if ($section->{"started"}) {
				$section->{"started"}->set_time_zone("UTC");
				$section->{"started"}->set_time_zone($tz);
			}
		}

		if ($event_type eq "congress") {

		} elsif ($event_type eq "wudc") {

			if ($ballot_speakerorder == 1) {
				$section->{entries}{$entry_id}{"order"} = "1G";
			} elsif ($ballot_speakerorder == 2) {
				$section->{entries}{$entry_id}{"order"} = "1O";
			} elsif ($ballot_speakerorder == 3) {
				$section->{entries}{$entry_id}{"order"} = "2G";
			} elsif ($ballot_speakerorder == 4) {
				$section->{entries}{$entry_id}{"order"} = "2O";
			}

		} elsif ($ballot_speakerorder) {
			$section->{entries}{$entry_id}{"order"} = $ballot_speakerorder;

			if ($ballot_side == 1) {
				$section->{entries}{$entry_id}{"side"} = $aff_label;
				$section->{entries}{$entry_id}{"side_init"} = substr($aff_label,0,1);
			} elsif ($ballot_side == 2) {
				$neg_label = "Neg" unless $neg_label;
				$section->{entries}{$entry_id}{"side"} = $neg_label;
				$section->{entries}{$entry_id}{"side_init"} = substr($neg_label,0,1);
			}

		} elsif ($ballot_side == 1) {

			$aff_label = "Aff" unless $aff_label;
			$section->{entries}{$entry_id}{"side"} = $aff_label;
			$section->{entries}{$entry_id}{"side_init"} = substr($aff_label,0,1);

		} elsif ($ballot_side == 2) {

			$neg_label = "Neg" unless $neg_label;
			$section->{entries}{$entry_id}{"side"} = $neg_label;
			$section->{entries}{$entry_id}{"side_init"} = substr($neg_label,0,1);
		}

		my $entry = $section->{entries}{$entry_id};

		if ($ballot_audit) {

			$section->{"audited"}++;

			if ($panel_publish) {

				if ($judge_publish_results eq "all") {

					$post_primary   = 3;
					$post_secondary = 3;
					$post_feedback  = 3;

				} elsif ($judge_publish_results eq "winloss") {

					$post_primary   = 3;
				}
			}

			if ($event_type eq "speech" || $event_type eq "wudc" || $event_type eq 'congress') {

				if ($post_primary > 0 && $score_tag eq "rank") {
					$entry->{$score_tag} = $score_value;
				}

				if ($post_secondary > 0 && $score_tag eq "point") {
					$entry->{$score_tag} = $score_value;
				}

			} elsif ($event_type eq "wsdc" || $event_type eq "debate") {

				if ($post_primary > 0 && $score_tag eq "winloss") {

					if ($score_value == 1) {
						$entry->{$score_tag}  = "W";
					} elsif ($score_value == 0) {
						$entry->{$score_tag}  = "L";
					}
				}

				if ($post_secondary > 0 && ($score_tag eq "rank" || $score_tag eq "point")) {

					if ($score_student_id) {

						$entry->{students}{$score_student_id}{"name"}
							= $score_student_first." ".substr($score_student_last,0,1);

						$entry->{students}{$score_student_id}{"initials"}
							= substr($score_student_first,0,1).substr($score_student_last,0,1);

						$entry->{$score_tag}{$score_student_id}  = $score_value;

					} else {
						$entry->{$score_tag} = $score_value;
					}
				}
			}

			if ($post_feedback > 0) {

				if ($score_content && ($score_tag eq "rfd" || $score_tag eq "comments")) {
					$entry->{$score_tag} = $score_content;
					$entry->{"topic"} = $score_topic;
					$section->{"has_rfd"}++;

					if ($score_tag eq "rfd") {
						$section->{rfd} = $score_content;
					}
				}

				if ($score_tag eq 'speech') {
					$section->{"has_rfd"}++;
					$entry->{"speeches"}{$score_speech}{"point"}    = $score_value;
					$entry->{"speeches"}{$score_speech}{"position"} = $score_position;
					$entry->{"speeches"}{$score_speech}{"topic"}    = $score_topic;
					$entry->{"speeches"}{$score_speech}{"content"}  = $score_content;
				}
			}

		} else {

		}
	}

	my $jpool_sth = $dbh->prepare("
		select judge.id, judge.first, judge.last, judge.code,
			jpool.id,
			jpool.name, message.value_text, publish.value

		from (jpool, jpool_judge jpj, judge, jpool_setting publish)

			left join jpool_setting message
				on message.jpool = jpool.id
				and message.tag = 'message'

		where judge.school = ?
			and judge.id = jpj.judge
			and jpj.jpool = jpool.id
			and jpool.id = publish.jpool

			and not exists (
				select registrant.id
				from jpool_setting registrant
				where registrant.jpool = jpool.id
				and registrant.tag = 'registrant'
			)

	");

	my %jpools;

	$jpool_sth->execute($school_id);

	while (
		my (
		 	$judge_id, $judge_first, $judge_last, $judge_code,
			$jpool_id, $jpool_name, $message, $publish
		) = $jpool_sth->fetchrow_array()
	) {
		next unless $publish;
		$jpools{$judge_id}{$jpool_id}{"judge_name"} = $judge_first." ".$judge_last;
		$jpools{$judge_id}{$jpool_id}{"judge_code"} = $judge_code;
		$jpools{$judge_id}{$jpool_id}{"name"} = $jpool_name;
		$jpools{$judge_id}{$jpool_id}{"message"} = $message;
	}

	$jpool_sth->finish();

	Tab::Round->columns(TEMP => "strikeschool");

	Tab::Round->set_sql( school_strikes => "
		select round.*, entry.school as strikeschool
		from round, round_setting, panel, ballot, entry, school
		where entry.school = school.id
		and school.id = ?
		and entry.id = ballot.entry
		and ballot.panel = panel.id
		and panel.bye != 1
		and panel.round = round.id
		and round.id = round_setting.round
		and round_setting.tag = 'strikes_published'
		and round_setting.value = 1
		order by round.start_time
	");

	my @cards = Tab::Round->search_school_strikes($school_id);

	my %strike_cards = map {$_->strikeschool => 1} @cards;

    Tab::Round->columns(TEMP => "setting");
    Tab::Round->columns(TEMP => "panelid");

    Tab::Round->set_sql( entry_flips => "
        select distinct round.*, panel.id as panelid, panel_setting.value as setting
        from round, round_setting, panel, ballot, entry, panel_setting
		where entry.school = ?
			and ballot.entry = entry.id
			and ballot.panel = panel.id
			and ballot.audit != 1
			and panel.bye != 1
			and panel.round = round.id
			and round.id = round_setting.round
			and round_setting.tag = 'flip_published'
			and panel_setting.panel = panel.id
			and panel_setting.tag = 'flip_status'
			and panel_setting.value != 'done'
        order by round.start_time
    ");

	my @flip_cards = Tab::Round->search_entry_flips($school_id);

</%init>

%	if ($ARGS{"results"}) {

		 <& "/user/results/menu.mas",
			 whoami => "dashboard",
			 person => $person,
			 school => $school
		 &>

%	} else {
		 <& "/user/menu.mas",
			 whoami => "dashboard",
			 person => $person
		 &>
%	}

	<script>

		function showRFD(sectionID) {
			$("#"+sectionID+"_button").toggleClass("invert");
			$("#"+sectionID+"_rfd").toggleClass("hidden");
		}

		function showEvent(selector) {

			var eventID = $(selector).val();

			if (eventID === "all") {
				$(".events").removeClass("eventHide");
			} else {
				$(".events").addClass("eventHide");
				$("."+eventID).removeClass("eventHide");
			}

			doHide();
			return;
		}

		function showTime(classID) {

			$(".timebutton").removeClass('invert');
			$(".timebutton").removeClass('bluetext');
			$(".timebutton").addClass('graytext');

			$("#"+classID).addClass("invert");
			$("#"+classID).addClass("bluetext");
			$("#"+classID).removeClass("graytext");

			if (classID === "all") {
				$(".timerows").removeClass("timeHide");
			} else {
				$(".timerows").addClass("timeHide");
				$(".row_"+classID).removeClass("timeHide");
			}

			if (classID === "past") {
				$(".past").removeClass("hidden");
			} else {
				$(".past").addClass("hidden");
			}

			if (classID === "all") {
				$(".firstnot").removeClass("ltbordertop");
			} else {
				$(".firstnot").addClass("ltbordertop");
			}

			doHide();
			return;
		}

		function doHide() {
			$(".events").removeClass("hidden");
			$(".timeHide").addClass("hidden");
			$(".eventHide").addClass("hidden");
			$("table").trigger("applyWidgets");
			return;
		}

		$(document).ready(function() {
%			if ($ARGS{"results"} || $after || (not defined $current_count)) {
				showTime("past");
%			} else {
				showTime("current");
%			}
		});

	</script>

	<div class="main">

		<span class="seventenths nowrap nospace">
			<h5 class="wrap">Dashboard: <% $tourn->name %></h5>
		</span>

		<span class="fifth rightalign nowrap nospace semibold bluetext bigger">
			<% $now->day_abbr %> / <& "/funclib/showtime.mas", dt => $now &>
		</span>

		<span class="tenth rightalign nospace">
			<a
				href  = "/user/chapter/tournaments.mhtml?chapter_id=<% $school->chapter->id %>"
				title = "Return to <% $school->name %> Home"
				class = "fa fa-lg fa-home buttonwhite greentext"
			></a>
		</span>


		<div class="ltbordervert odd centeralign">
<%perl>

			my %rooms;

			if ($tourn_settings{"online_rooms"}) {

				if (@{$tourn_settings{"online_rooms"}}) {

					foreach my $room (@{$tourn_settings{"online_rooms"}}) {

						if ($room->{access} eq "coach") {
							$rooms{"coach"}{$room->{id}}{name} = $room->{"name"};
							$rooms{"coach"}{$room->{id}}{thing} = $room;
						}
					}
				}
			}

			if ($tourn_settings{"nsda_campus_purchased"}) {
</%perl>

				<span class="third leftalign">
					<span class="threequarters semibold bluetext">
						<span class="halfspace"></span>
						<% Tab::short_name($school->name) %> Squad Room
					</span>

					<span class="quarter centeralign padvert nospace">
						<& "/funclib/online_room.mas",
							school => $school->id,
							person => $person,
							show   => 1,
							class  => "fa"
						&>
					</span>
				</span>
%			}

%			foreach my $room_id (keys %{$rooms{"coach"}}) {

				<span class="third leftalign">
					<span class="threequarters semibold bluetext">
						<span class="halfspace"></span>
						<% $rooms{"coach"}{$room_id}{"name"} %>
					</span>

					<span class="quarter centeralign padvert nospace">
						<& "/funclib/online_room.mas",
							util   => $rooms{"coach"}{$room_id}{"thing"},
							person => $person,
							show   => 1,
							class  => "fa"
						&>
					</span>
				</span>
%			}

		</div>

%		if (@flip_cards) {
			<div class="full padvertmore centeralign ltbordertop redborderbottom">
				<a
					href  = "/user/enter/flip.mhtml"
					class = "buttonwhite orangetext hover invert"
				>Coinflip Choices Available</a>
			</div>

			<br />
%		}

%		if ($strike_cards{$school_id}) {

			<div class="full padvertmore centeralign ltbordertop redborderbottom">

				<a
					href  = "/user/enter/strike_cards.mhtml"
					class = "buttonwhite orangetext hover invert"
				>Strike Cards Available</a>

			</div>
			<br />
%		}

		<& /funclib/tablesorter.mas, table => $school_id."_entries" &>

		<span class="fifth nospace">
			<h5>Entries</h5>
		</span>

		<span class="twofifths centeralign nospace">
			<a
				id      = "current"
				class   = "buttonwhite bluetext timebutton fifth"
				onClick = "showTime('current');"
			>Current</a>
			<a
				id      = "future"
				class   = "buttonwhite greytext timebutton fifth"
				onClick = "showTime('future');"
			>Future</a>
			<a
				id      = "past"
				class   = "buttonwhite greytext timebutton fifth"
				onClick = "showTime('past');"
			>Past</a>
			<a
				id      = "all"
				class   = "buttonwhite greytext timebutton fifth"
				onClick = "showTime('all');"
			>All</a>
		</span>

		<span class="threetenths centeralign padno">
			<select
				id       = "event_selector"
				class    = "fixedmed"
				onChange = "showEvent(this);"
			>
				<option value="all">All Events</option>

%				foreach my $event_id ( sort {$events{$a} cmp $events{$b}} keys %events) {
					<option value="<% $event_id %>"><% $events{$event_id} %></option>
%				}

			</select>
		</span>

		<span
			id="<% $school_id %>_entries_buttonarea"
			class="tenth rightalign">
		</span>

		<table id="<% $school_id %>_entries" class="smallish">

			<thead>
				<tr class="yellowrow smaller">

					<th>
						Code
					</th>

					<th>
						Entry
					</th>

					<th>
						Event
					</th>

					<th>
						Rnd
					</th>

					<th>
						Start
					</th>

					<th>
						Room
					</th>

					<th title="Side &amp; Speaker Orders">
						Sd/Sp
					</th>

					<th>
						Judging
					</th>

					<th>
						Result
					</th>

					<th title="Feedback">
						Fdbk
					</th>
				</tr>
			</thead>

			<tbody>
<%perl>
				my $last_entry;
				my $firstnot;

				foreach my $entry_id (
					sort {
						$now{"entries"}{$a}{"entry_code"} <=> $now{"entries"}{$b}{"entry_code"}
						|| $now{"entries"}{$a}{"entry_code"} cmp $now{"entries"}{$b}{"entry_code"}
					} keys %{$now{"entries"}}
				) {

					my $entry = $now{"entries"}{$entry_id};

					foreach my $section_id (
						sort {
							$entry->{"section"}{$b}{round_num} <=> $entry->{"section"}{$a}{round_num}
						} keys %{$entry->{"section"}}
					) {

						my $section = $entry->{'section'}{$section_id};

						if ($entry_id ne $last_entry) {
</%perl>
							<tr class="ltbordertop timerows <% $section->{status} %> row_<% $section->{status} %> <% $entry->{event_id} %> events">

%						} elsif ($firstnot) {
							<tr class="firstnot timerows <% $section->{status} %> row_<% $section->{status} %> <% $entry->{event_id} %> events">

%						} else {

							<tr class="timerows <% $section->{status} %> row_<% $section->{status} %> <% $entry->{event_id} %> events">
%						}

							<td class="semibold bluetext">
%								if ($entry_id ne $last_entry) {
									<% $entry->{"entry_code"} %>
%								} else {
									<span class="hidden <% $firstnot ? "past" : "" %>">
										<% $entry->{"entry_code"} %>
									</span>
%								}
							</td>

							<td class="semibold bluetext">
%								if ($entry_id ne $last_entry) {
									<% $entry->{"entry_name"} %>
%								} else {
									<span class="hidden <% $firstnot ? "past" : "" %>">
										<% $entry->{"entry_name"} %>
									</span>
%								}
							</td>

							<td class="semibold bluetext">
%								if ($entry_id ne $last_entry) {
									<% $entry->{"event_abbr"} %>
%									$last_entry = $entry_id;
%									$firstnot++;
%								} else {
									<span class="hidden <% $firstnot ? "past" : "" %>">
										<% $entry->{"event_abbr"} %>
									</span>
%									undef $firstnot;
%								}
							</td>

							<td class="centeralign">
								<% $section->{round_name} %>
								<%
									$section->{round_flighted} > 1
									? "Flt ".$section->{panel_flight}
									: ""
								%>
							</td>

							<td class="centeralign nospace">
								<span class="third">
									<% $section->{start_time}
										?  $section->{start_time}->day_abbr
										: ""
									%>
								</span>
								<span class="twothirds">
									<& "/funclib/showtime.mas",
										dt => $section->{start_time}
									&>
								</span>
							</td>

							<td>
								<% $section->{room_name} %>
							</td>

							<td class="centeralign nowrap nospace">
								<span class="third nospace">
									<% $section->{side_init} %>
								</span>
								<span class="twothirds nospace">
									<% $section->{order}
										? Lingua::EN::Numbers::Ordinate::ordinate($section->{order})
										: ""
									%>
								</span>
							</td>

							<td class="nospace">
<%perl>
								foreach my $judge_id (
									sort {
										$section->{judges}{$b}{"chair"} <=> $section->{judges}{$a}{"chair"}
										|| $section->{judges}{$b}{"last"} cmp $section->{judges}{$a}{"last"}
									} keys %{$section->{judges}}
								) {

									my $judge = $section->{judges}{$judge_id};
</%perl>
									<div
										title="<% $judge->{school} %>"
										class="full nospace padvertless padleftless smallish nowrap"
									>

%										if ($entry->{event_type} eq "congress" && $judge->{chair}) {
											<span class="tenth nospace padleftless semibold redtext" title="Parliamentarian">
												P
											</span>

											<span class="ninetenths nospace nowrap">
%										}

%										if ($tourn_settings{"ncfl"}) {

											<% $judge->{code} %>

%										} else {

											<% $judge->{last} %>, <% $judge->{first} %>
%										}

%										if ($entry->{event_type} eq "congress" && $judge->{chair}) {
											</span>
%										}
									</div>
%								}
							</td>

							<td class="nospace">

%								if ($section->{panel_bye}) {

									<div class="full centeralign redtext semibold">
										BYE
									</div>

%								} elsif ($now{"entries"}{$entry_id}{"section"}{$section_id}{bye}) {

									<div class="full centeralign redtext semibold padless">
										<% $now{"entries"}{$entry_id}{"section"}{$section_id}{bye} %>
									</div>
<%perl>
								} else {

								foreach my $judge_id (
									sort {
										$section->{judges}{$b}{"chair"} <=> $section->{judges}{$a}{"chair"}
										|| $section->{judges}{$b}{"last"} cmp $section->{judges}{$a}{"last"}
									} keys %{$section->{judges}}
								) {

									my $judge = $section->{judges}{$judge_id};

									if ($judge->{point} || $judge->{rank} || $judge->{winloss}) {

										if ($entry->{event_type} eq "debate"
											|| $entry->{event_type} eq "wsdc"
										) {

											if ($judge->{point} || $judge->{rank} || $judge->{point}) {

												my @students = eval {
													return sort {$a <=> $b} keys %{$judge->{students}};
												};
</%perl>
												<div class="full nospace padvertless smallish">
													<span class="fifth semibold nospace centeralign
														<% $judge->{winloss} eq "W"
															? "greentext"
															: $judge->{winloss} eq "L"
																? "redtext"
																: "bluetext"
														%>"
													>
														<% $judge->{winloss} %>
													</span>

													<span class="fourfifths nospace">
<%perl>
														foreach my $student_id (@students) {
															my $notfirst;
															foreach my $score_tag ("point", "rank", "refute") {

																next unless $judge->{by_student}{$score_tag};
</%perl>
%																unless ($notfirst || (scalar @students == 1)) {
																	<div
																		title="<% $judge->{students}{$student_id}{"name"} %>"
																		class="full nospace smaller hover limit"
																	>

																	<span class="half nowrap nospace padvertless">
																		<% $judge->{students}{$student_id}{"name"} %>
																	</span>
%																}

																	<span class="quarter nospace rightalign">
																		<% $judge->{point}{$student_id} %>
																	</span>

																	<span class="quarter nospace">
																		<% $judge->{rank}{$student_id} %>
																	</span>

%																unless ($notfirst++) {
																	</div>
%																}
<%perl>
															}
														}

														foreach my $score_tag ("point", "rank", "refute") {
															next unless $judge->{by_entry}{$score_tag};
</%perl>
															<span class="half">
																<% $judge->{$score_tag} %>
															</span>
%														}
													</span>
												</div>

%											} else {

												<div class="full nospace padvertless semibold centeralign
													<% $judge->{winloss} eq "W"
														? "greentext"
														: $judge->{winloss} eq "L"
															? "redtext"
															: "bluetext"
													%>"
												>
													<% $judge->{winloss} %>
												</div>
%											}

%										} elsif ($entry->{event_type} eq "speech" || $entry->{event_type} eq "congress") {

											<div class="full nospace smallish">
												<span class="third centeralign">
													<% $judge->{rank} %>
												</span>

												<span title="points" class="half rightalign">
%													if ($judge->{point}) {
														<% $judge->{point} %>
%													}
<%perl>
													if ($judge->{"speeches"}) {
														my $notfirst;
														foreach my $speech (sort {$a <=> $b} keys %{$judge->{"speeches"}}) {
															$m->print(", ") if $notfirst++;
															$m->print($judge->{"speeches"}{$speech}{"point"});
														}
													}
</%perl>
												</span>
											</div>

%										} elsif ($entry->{event_type} eq "wudc") {

%											my @students = keys %{$judge->{students}};

											<div class="full nospace smallish">
												<span class="third">
													<% 4 - $judge->{rank} %> pts
												</span>

%												if (scalar @students > 1) {
													<span class="twothirds">
%													foreach my $student_id (@students) {
														<div class="full nospace padvertless">
															<span class="twothirds">
																<% $judge->{students}{$student_id}{"name"} %>
															</span>

															<span class="third">
																<% $judge->{point}{$student_id} %>
															</span>
														</div>
%													}
													</span>
%												}
											</div>
%										}

%									} elsif ($entry->{event_type} eq "congress" && $judge->{chair}) {

										<div class="full nospace padvertless semibold greytext centeralign">
											&nbsp;
										</div>

%									} elsif ($judge->{audited} &! ($entry->{event_type} eq "congress" && $judge->{chair})) {

										<div class="full nospace padvertless semibold redtext centeralign">
											VOTED
										</div>

%									} elsif ($judge->{started}) {

										<div class="full nospace padvertless semibold greentext leftalign nowrap">
											<span class="twofifths nospace">
												Start
											</span>
											<span class="threefifths nospace">
												<& "/funclib/showtime.mas",
													dt => $judge->{started}
												&>
											</span>
										</div>

%									} else {

										<div class="full nospace padvertless semibold bluetext">
										</div>
%									}
%								} }
							</td>

							<td class="centeralign nospace">
%								if ($section->{rfd}) {
									<a
										class   = "fa fa-sm buttonwhite bluetext fa-file-text marno"
										id      = "<% $section_id %>_button"
										onClick = "showRFD(<% $section_id %>);"
									></a>
%								}
							</td>

						</tr>

<%perl>
						if ($section->{rfd}) {

							my $notfirst;

							foreach my $judge_id (
								sort {
									$section->{judges}{$b}{"chair"} <=> $section->{judges}{$a}{"chair"}
									|| $section->{judges}{$b}{"last"} cmp $section->{judges}{$a}{"last"}
								} keys %{$section->{judges}}
							) {

								my $judge = $section->{judges}{$judge_id};

								next unless ($judge->{rfd} || $judge->{comments} || $judge->{speeches});

								unless ($notfirst++) {
									$m->print('<tr id="'.$section_id.'_rfd" class="hidden odd bordertop borderbottom">');
									$m->print('<td colspan="23">');
								}
</%perl>
									<h6 class="centeralign padtop">
										Feedback from <% $judge->{code}." ".$judge->{first}." ".$judge->{last} %>
									</h6>

%									if ($judge->{rfd}) {
										<p><div class="semibold bluetext full nospace padverless">RFD</div>
											<% Tab::Score::uncompress($judge->{rfd}) %>
										</p>
%									}

%									if ($judge->{comments}) {
										<p><div class="semibold bluetext full nospace padverless">Comments</div>
											<% Tab::Score::uncompress($judge->{comments}) %>
										</p>
%									}

%									if ($judge->{"speeches"}) {
										<div class="semibold bluetext full nospace padverless">Speeches</div>

%										foreach my $speech (sort {$a <=> $b} keys %{$judge->{"speeches"}}) {

											<div class="full ltborderbottom">
												<span class="sixth semibold bluetext biggish">
													Speech <% $speech %>
												</span>
												<span class="sixth semibold bluetext biggish">
													<% $judge->{"speeches"}{$speech}{"point"} %> Points
												</span>
												<span class="sixth semibold orangetext biggish rightalign">
													<% $judge->{"speeches"}{$speech}{"position"} == 1 ? "FOR" : "AGAINST" %>
												</span>
												<span class="half biggish">
													<% $judge->{"speeches"}{$speech}{"topic"} %>
												</span>
											</div>

											<div class="full ltborderbottom">
												<% Tab::Score::uncompress($judge->{speeches}{$speech}{"content"}) %>
											</div>
<%perl>
										}
									}

							}

							if ($notfirst) {
								$m->print('</td></tr>');
							}
						}
					}
				}
</%perl>
			</tbody>

		</table>

		<& /funclib/tablesorter.mas, table => $school_id."_judges" &>

		<span class="threequarters nospace">
			<h5>Judges</h5>
		</span>

		<span
			id="<% $school_id %>_judges_buttonarea"
			class="quarter rightalign">
		</span>

		<table id="<% $school_id %>_judges" class="smallish">

			<thead>
				<tr class="yellowrow">

					<th>
						Judge
					</th>

					<th>
						Event
					</th>

					<th>
						Rnd
					</th>

					<th>
						Start
					</th>

					<th>
						Room
					</th>

					<th>
						Entries
					</th>

					<th>
						Results
					</th>

					<th>
						Feedback
					</th>
				</tr>
			</thead>

			<tbody>
<%perl>
				my $last_judge;

				foreach my $judge_id (
					sort {
						$now{"judges"}{$a}{"judge_last"} cmp $now{"judges"}{$b}{"judge_last"}
					} keys %{$now{"judges"}}
				) {

					my $judge = $now{"judges"}{$judge_id};

					foreach my $section_id (
						sort {
							$judge->{"section"}{$a}{round_num}
								<=>
							$judge->{"section"}{$b}{round_num}
						} keys %{$judge->{"section"}}
					) {

						my $section = $judge->{"section"}{$section_id};

						if ($judge_id ne $last_judge) {
</%perl>
							<tr class="ltbordertop timerows <% $section->{status} %> row_<% $section->{status} %> <% $section->{event_id} %> events">

%						} else {
							<tr class="timerows <% $section->{status} %> row_<% $section->{status} %> <% $section->{event_id} %> events">
%						}

							<td class="semibold bluetext">
%								if ($last_judge ne $judge_id) {
									<% $judge->{"judge_first"} %> <% $judge->{"judge_last"} %>
%									$last_judge = $judge_id;
%								} else {
									<span class="hidden">
										<% $judge->{"judge_first"} %> <% $judge->{"judge_last"} %>
									</span>
%								}
							</td>

							<td class="centeralign">
								<% $section->{"event_abbr"} %>
							</td>

							<td class="centeralign">
								<% $section->{round_name} %>
								<%
									$section->{round_flighted} > 1
									? "Flt ".$section->{panel_flight}
									: ""
								%>
							</td>

							<td class="centeralign">
								<span class="third">
									<% $section->{start_time}
										?  $section->{start_time}->day_abbr
										: ""
									%>
								</span>
								<span class="twothirds">
									<& "/funclib/showtime.mas",
										dt => $section->{start_time}
									&>
								</span>
							</td>

							<td>
								<% $section->{room_name} %>
							</td>

							<td class="nospace">
<%perl>
								foreach my $entry_id (
									sort {
										$section->{entries}{$a}{side_number} <=> $section->{entries}{$b}{side_number}
										|| $section->{entries}{$a}{order} <=> $section->{entries}{$b}{order}
									} keys %{$section->{entries}}
								) {

									my $entry = $section->{entries}{$entry_id};

									if ($section->{event_type} eq "debate" || $section->{event_type} eq "wsdc") {
</%perl>
										<div class="full nospace padvertless">
											<span class="quarter nospace padleft">
												<% $entry->{side_init} %>
												<% $entry->{order} ? Lingua::EN::Numbers::Ordinate::ordinate($entry->{order}) : "" %>
											</span>
											<span class="threequarters nospace nowrap" title="<% $entry->{name}." ".$entry->{school} %>">
												<% $entry->{code} %>
											</span>
										</div>
%									} elsif ($section->{event_type} eq "speech") {

										<div class="full nospace padvertless">
											<span class="quarter nospace padleft">
												<% $entry->{order} ? Lingua::EN::Numbers::Ordinate::ordinate($entry->{order}) : "" %>
											</span>
											<span class="threequarters nospace nowrap" title="<% $entry->{name}." ".$entry->{school} %>">
												<% $entry->{code} %>
											</span>
										</div>
%									}
%								}
							</td>

							<td class="nospace limithalf smallish">
<%perl>
								foreach my $entry_id (
									sort {
										$section->{entries}{$a}{side_number} <=> $section->{entries}{$b}{side_number}
										|| $section->{entries}{$a}{order} <=> $section->{entries}{$b}{order}
									} keys %{$section->{entries}}
								) {

									my $entry = $section->{entries}{$entry_id};

									if ($entry->{point} || $entry->{rank} || $entry->{winloss}) {

										if ($section->{event_type} eq "debate"
											|| $section->{event_type} eq "wsdc"
										) {

											if ($entry->{point} || $entry->{rank} || $entry->{reply}) {

												my @students = keys %{$entry->{students}};
</%perl>
												<div class="full nospace padvertmuchless
													<% scalar @students > 1 ? "ltborderbottom" : "padvertless" %>"
												>

													<span class="fifth semibold nospace centeralign
														<% $entry->{winloss} eq "W" ? "greentext" : "redtext" %>"
													>
														<% $entry->{winloss} %>
													</span>

													<span class="fourfifths nospace">
%														if (scalar @students > 1) {
%															foreach my $student_id (sort @students) {

																<div
																	title="<% $entry->{students}{$student_id}{"name"} %>"
																	class="full nospace hover"
																>

																	<span class="half nowrap nospace padvertless">
																		<% $entry->{students}{$student_id}{"name"} %>
																	</span>

																	<span class="threeeighths nospace rightalign">
																		<% $entry->{point}{$student_id} %>
																	</span>

																	<span class="eighth nospace">
																		<% $entry->{rank}{$student_id} %>
																		<% $entry->{reply}{$student_id} %>
																	</span>
																</div>
%															}
%														} elsif (@students) {
															<span class="half nospace">
																<% $entry->{point}{$students[0]} %>
															</span>

															<span class="fourtenths nospace">
																<% $entry->{rank}{$students[0]} %>
															</span>
%														}
													</span>
												</div>

%											} else {

												<div class="full nospace padvertless semibold leftalign padleft
													<% $entry->{winloss} eq "W" ? "greentext" : "redtext" %>"
												>
													<% $entry->{winloss} %>
												</div>
%											}

%										} elsif ($section->{event_type} eq "speech") {

											<div class="full nospace padvertless">

												<span class="sixth centeralign nospace">
													<% $entry->{rank} %>
												</span>

												<span class="third rightalign nospace">
													<% $entry->{point} %>
												</span>
											</div>

%										} elsif ($section->{event_type} eq "wudc") {

%											my @students = keys %{$entry->{students}};

											<span class="third">
												<% 4 - $entry->{rank} %>
											</span>

%											if (scalar @students > 1) {
												<span class="twothirds">
%												foreach my $student_id (@students) {
													<div class="full nospace padvertless">
														<span class="twothirds">
															<% $entry->{students}{$student_id}{"name"} %>
														</span>

														<span class="third">
															<% $entry->{point}{$student_id} %>
														</span>
													</div>
%												}
												</span>
%											}
%										}

%									} elsif ($section->{audited}) {

										<div class="full nospace padvertless semibold redtext centeralign">
											VOTED
										</div>

%									} elsif ($section->{started}) {

										<div class="full nospace padvertless semibold greentext leftalign nowrap">
											<span class="twofifths nospace">
												Start
											</span>
											<span class="threefifths nospace">
												<& "/funclib/showtime.mas",
													dt => $section->{started}
												&>
											</span>
										</div>

%									} else {

										<div class="full nospace padvertless semibold bluetext">
										</div>
%									}
%								}

							</td>

							<td class="centeralign nospace">
%								if ($section->{has_rfd}) {
									<a
										class   = "fa fa-sm buttonwhite bluetext fa-file-text marno"
										id      = "<% $section_id %>_button"
										onClick = "showRFD(<% $section_id %>);"
									></a>
%								}
							</td>
						</tr>

%						if ($section->{has_rfd}) {

							<tr id="<% $section_id %>_rfd" class="hidden odd bordertop borderbottom">

								<td colspan="23">

%									if ($section->{rfd}) {
										<h6 class="centeralign">
											RFD
										</h6>

										<p>
											<% Tab::Score::uncompress($section->{rfd}) %>
										</p>
%									}
<%perl>
									foreach my $entry_id (
										sort {
											$section->{entries}{$a}{side_number} <=> $section->{entries}{$b}{side_number}
											|| $section->{entries}{$a}{order} <=> $section->{entries}{$b}{order}
										} keys %{$section->{entries}}
									) {

										my $entry = $section->{entries}{$entry_id};
										next unless $entry->{comments} || $entry->{speeches};
</%perl>
%										if ($entry->{comments}) {

											<h6 class="centeralign">
												Feedback for <% $entry->{code}." ".$entry->{first}." ".$entry->{last} %>
											</h6>

											<p><div class="semibold bluetext full nospace padverless">Comments</div>
												<% Tab::Score::uncompress($entry->{comments}) %>
											</p>
%										}

%										if ($entry->{speeches}) {

											<div class="semibold bluetext full nospace padverless">
												Speeches for <% $entry->{code} %> <% $entry->{code} ne $entry->{name} ? $entry->{name} : "" %>
											</div>

%											foreach my $speech (sort {$a <=> $b} keys %{$entry->{"speeches"}}) {

												<div class="full ltborderbottom">
													<span class="sixth semibold bluetext biggish">
														Speech <% $speech %>
													</span>
													<span class="sixth semibold bluetext biggish">
														<% $entry->{"speeches"}{$speech}{"point"} %> Points
													</span>
													<span class="sixth semibold orangetext biggish rightalign">
														<% $entry->{"speeches"}{$speech}{"position"} == 1 ? "FOR" : "AGAINST" %>
													</span>
													<span class="half biggish">
														<% $entry->{"speeches"}{$speech}{"topic"} %>
													</span>
												</div>

												<div class="full ltborderbottom">
													<% Tab::Score::uncompress($entry->{speeches}{$speech}{"content"}) %>
												</div>
%											}
%										}
%									}

								</td>
							</tr>
<%perl>
						}
					}
				}
</%perl>

			</tbody>
		</table>

%		if (keys %jpools) {

			<& /funclib/tablesorter.mas,
				table => $school_id."_jpools"
			&>

			<span class="threequarters nospace">
				<h5>Judge Pools</h5>
			</span>

			<span
				id="<% $school_id %>_jpools_buttonarea"
				class="quarter rightalign">
			</span>

			<table id="<% $school_id %>_jpools">

				<thead>
					<tr class="yellowrow">
						<th>
							Judge Name
						</th>

						<th>
							Judge Code
						</th>

						<th>
							Pool Name
						</th>

						<th>
						</th>
					</tr>
				</thead>

				<tbody>
%					foreach my $judge_id (sort keys %jpools) {
%						foreach my $jpool_id (sort keys %{$jpools{$judge_id}}) {
							<tr>
								<td>
									<% $jpools{$judge_id}{$jpool_id}{"judge_name"} %>
								</td>

								<td>
									<% $jpools{$judge_id}{$jpool_id}{"judge_code"} %>
								</td>

								<td>
									<span class="padvertless full marno">
									<% $jpools{$judge_id}{$jpool_id}{"name"} %>
									</span>
								</td>

								<td>
									<% $jpools{$judge_id}{$jpool_id}{"message"} %>
								</td>
							</tr>
%						}
%					}
				</tbody>
			</table>
%		}


		<p class="martopmuchmore whitetext centeralign">
			The idea for this dashboard was brought to you by Tripp Rebrovick
		</p>

	</div>

%	$dbh->disconnect();
