<%args>
	$entry_id => undef
	$school 
	$person
</%args>
<%init>

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;

	my $err;
	my $msg;

	unless ($entry) { 
		$err = "No entry found with the ID number $entry_id.";
	}

	my $tourn = $school->tourn;

	if ($entry->setting("rejected_by")) { 

		$err = "This entry was already rejected.  If this was an error contact the National Office immediately";

	} elsif ($entry->unconfirmed) { 

		my $nope;

		foreach my $student ($entry->students) { 

			my %entries = $m->comp(
				"/funclib/nationals_entries.mas",
				student => $student,
				tourn   => $tourn
			);

			if ($entries{"main"}) { 

				my $entry = shift @{$entries{"main"}};

				$err = $student->first." ".$student->last." #".$student->ualt_id." is already registered in a Nationals main category:. <br />";
				$err .= $entry->name." in ".$entry->event->abbr."<br />";
				$err .= "The other entry must first be rejected or dropped before you can proceed.";

			}

		}

		if ($err) { 

		} else { 

			$msg = "Entry accepted.  Further details & forms are required before the entry is complete";

			my $now = DateTime->now();

			$entry->unconfirmed(0);
			$entry->setting('accepted_by', $person->id);
			$entry->setting('accepted_at', "date", $now);
			$entry->update();

		}

	} else { 

		$err = "This entry is not eligible for acceptance";
	}

	undef $entry;

	$m->redirect("entries.mhtml?school_id=".$school->id."&err=$err") if $err;

	$m->redirect("entries.mhtml?school_id=".$school->id."&msg=$msg");

</%init>

