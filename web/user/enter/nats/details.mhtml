<%args>
	$school
	$student_id => undef
</%args>
<%init>

	my $student = Tab::Student->retrieve($student_id) if $student_id;

	unless ($student) {
		$m->comp('/funclib/abort.mas',
			message => "No student record found for ID number $student_id"
		);
	}

	unless ($student->chapter->id == $school->chapter->id) {
		$m->comp('/funclib/abort.mas',
			message => "Student ".$student->first." ".$student->last." does not belong to your school."
		);
	}

	my $tourn = $school->tourn();
	my %tourn_settings = $tourn->all_settings();

	my %release_forms = eval {
		return %{JSON::decode_json($school->setting("release_forms"))};
	};

	my %entries = $m->comp(
		"/funclib/nationals_entries.mas",
		student => $student,
		tourn => $tourn
	);

	my %events;

	foreach my $event ($tourn->events) {

		if ($event->setting("supp")) {
			push @{$events{"supp"}}, $event;
		} elsif ($event->setting("conn")) {
			push @{$events{"conn"}}, $event;
		} elsif ($event->setting("stefan")) {
			push @{$events{"stefan"}}, $event;
		} else {
			push @{$events{"main"}}, $event;
		}
	}


	my $coaches;

	my $roster = $m->comp("/funcli/school_roster.mas", chapter => $school->chapter);

	foreach my $person (@{$roster}) {
		if ($person->{role} eq "Coach")
			push @{$coaches}, $person;
		}
	}

	my $drop_deadline = $tourn_settings{"drop_deadline"};
	$drop_deadline = $tourn->reg_end unless $drop_deadline;

	my $script_deadline = $tourn_settings{"script_deadline"};
	$script_deadline = $drop_deadline unless $script_deadline;

	my $release_deadline = $tourn_settings{"release_deadline"};
	$release_deadline = $drop_deadline unless $release_deadline;

	my $supp_deadline = $tourn_settings{"supp_deadline"};
	$supp_deadline = $drop_deadline unless $supp_deadline;

	my $now = DateTime->now();

</%init>

	<div class="menu">

		<div class="sidenote">

			<h4>Navigate</h4>

			<a
				href="entries.mhtml?school_id=<% $school->id %>"
				class="full blue"
			>Return to School Entry</a>

			<h4 class="martop">Notes &amp; Details</h4>

			<% $tourn_settings{"suppconn_message"} %>

		</div>

	</div>

	<div class="main">

		<& "../tabbar.mas",
			school => $school,
			whoami => "entries"
		&>

		<span class="twothirds nospace">
			<h4><% $student->first." ".$student->last %></h4>
		</span>
		<span class="third rightalign nospace">
			<h6>NSDA ID <% $student->nsda %></h4>
		</span>

		<h5 class="normalweight nospace martopmore marbottom">
			1. Pre-register for Supplementals
		</h5>

		<div class="centeralign nospace">

			<span class="ninetenths leftalign">

%				my $nosupp;
%				if ($now > $supp_deadline) {
%					$nosupp++;

					<p class="semibold redtext centeralign">
						The deadline to change your supps &amp; conns entries has passed
					</p>

%				} else {

					<form
						action="supps_save.mhtml"
						method="post"
					>
						<input
							type  = "hidden"
							name  = "school_id"
							value = "<% $school->id %>"
						>

						<input
							type  = "hidden"
							name  = "student_id"
							value = "<% $student->id %>"
					>
%				}

%				if ($events{'supp'}) {

					<div class="row bordertop padvert">

						<span class="sixth semibold rightalign">
							Supplementals
						</span>

						<span class="fivesixths nospace padleft smaller">

%							foreach my $supp (@{$events{'supp'}}) {
%								my $name = $supp->name;
%								$name =~ s/Extemporaneous/Extemp/g;

								<label for="<% $supp->id %>">
									<span
										class = "realfifth hover nospace ltborderright"
										title = "<% $supp->name %>"
									>
										<span class="threequarters smallish marno padleft">
											<% $name %>
										</span>

										<span class="fifth centeralign marno">
											<input
												type  = "checkbox"
												<% $nosupp ? 'disabled' : "" %>
												name  = "<% $supp->id %>"
												id    = "<% $supp->id %>"
												value = "1"
												<% $entries{$supp->id} ? "checked" : "" %>
											>
										</span>
									</span>
								</label>
%							}
						</span>
					</div>
%				}

%				if ($events{'conn'}) {

					<div class="row padvert">
						<span class="sixth semibold padvert rightalign">
							Consolations
						</span>

						<span class="fivesixths nospace padleft smaller">

%							foreach my $conn (@{$events{'conn'}}) {

								<label for="<% $conn->id %>">
									<span
										class = "realfifth hover nospace ltborderright"
										title = "<% $conn->name %>"
									>
										<span class="threequarters smallish marno padleft">
											<% $conn->name %>
										</span>

										<span class="fifth centeralign marno">
											<input
												type  = "checkbox"
												name  = "<% $conn->id %>"
												id    = "<% $conn->id %>"
												value = "1"
												<% $nosupp ? 'disabled' : "" %>
												<% $entries{$conn->id} ? "checked" : "" %>
											>
										</span>
									</span>
								</label>
%							}
						</span>
					</div>
%				}

%				unless ($nosupp) {
					<div class="liblrow rightalign">
						<span class="centeralign true third nospace">
							<input
								type="submit"
								value="Save Pre-Registration"
							>
						</span>
					</div>
%				}

			</span>
		</div>

		</form>

		<h5 class="normalweight nospace martopmore marbottomless">
			2. Entry Release Form
		</h5>

		<div class="centeralign nospace">

			<span class="ninetenths leftalign">

			<form
				enctype  = "multipart/form-data"
				action   = "details_save.mhtml"
				method   = "post"
			>

			<input
				type  = "hidden"
				name  = "school_id"
				value = "<% $school->id %>"
			>

			<input
				type  = "hidden"
				name  = "student_id"
				value = "<% $student->id %>"
			>

%		if ($now > $release_deadline) {

			<div class="bordertop padtop">

				<span class="threequarters redtext semibold biggish centeralign">
					The deadline to upload or change the release form has passed.
				</span>

				<span class="quarter nospace centeralign">
					<a
						class = "greentext semibold"
						href  = "<% $Tab::s3_url %>/<% $tourn->id."/".$school->id."/releases/".$student->id."/".$release_forms{$student->id} %>"
					> <% $release_forms{$student->id} %> </a>
				</span>
			</div>

%		} else {

			<div class="bordertop padtop">

				<span class="fourfifths nospace bluetext semibold biggish centeralign">
					A signed copy is required for each student.
					Download &amp; sign, then scan &amp; upload:
				</span>

				<span class="fifth centeralign nospace">
					 <a
						class = "white full bluetext semibold ltborder padvertmore marno"
						href  = "<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$tourn->setting("entry_release") %>">
						<span class='fa fa-sm fa-file-pdf-o'></span>
						Release Form
					</a>
				</span>
			</div>


			<div class="row bordertop borderbottom martop">

				<span class="sixth semibold bluetext rightalign">
					Signed copy
				</span>

				<span class="third centeralign">
					<div class="uploader wider">

						<input
							type	 = "file"
							name	 = "entry_release_<% $student->id %>"
							style	= "opacity: 0;"
							onchange = "uploaderName(
								'entry_release_<% $student->id %>',
								'entry_release_<% $student->id %>_file'
							)"
							id	   = "entry_release_<% $student->id %>"
						>

						<span
							id  = "entry_release_<% $student->id %>_file"
							class = "filename"
							style = "-webkit-user-select: none;"
						>Upload File</span>

						<span
							class = "action"
							style = "-webkit-user-select: none;"
						>Choose File</span>
					</div>

				</span>

				<span class="fourtenths rightalign padvert">

%				if ($release_forms{$student->id}) {

					<span
						class="fa fa-lg fa-check fa-lg greentext sixth rightalign">
					</span>

					<span class="fivesixths leftalign">
						<a
							class = "greentext semibold nospace"
							href  = "<% $Tab::s3_url %>/<% $tourn->id."/".$school->id."/releases/".$student->id."/".$release_forms{$student->id} %>"
						> <% $release_forms{$student->id} %> </a>
					</span>

%				} else {

					<span
						class="fa fa-sm fa-times redtext marless"
					></span>

					<span class="semibold redtext align bigger padrightmuchmore marrightmore">
						Not Uploaded
					</span>
%		   		}

				</span>

				<span class='twenty rightalign nospace'>
					<input type="submit" value="Save">
				</span>

			</div>
%	 	}

		</span>
		</div>

		<h5 class="normalweight nospace martopmuchmore marbottomless">
			3. Pronunciation Guide
		</h5>

		<div class="centeralign nospace">
			<span class="ninetenths leftalign">
				<div class="row bordertop padvert">

					<span class="bluetext semibold rightalign half">
						Short phonetic pronunciation guide for awards
					</span>

					<span class="fourtenths centeralign">

						<input
							type  = "text"
							name  = "phonetic"
							size  = "28"
							value = "<% $student->phonetic %>"
						>
					</span>

					<span class='tenth rightalign nospace'>
						<input type="submit" value="Save">
					</span>
				</div>
			</span>
		</div>

		<h5 class="normalweight nospace martopmuchmore marbottomless">
			4. Main Event Details
		</h5>

		<div class="centeralign nospace">
			<span class="ninetenths leftalign">
%				my $past;
%				$past++ if ($now > $script_deadline);
%				if ($entries{"main"}) {
%					foreach my $entry (@{$entries{"main"}}) {
						<div class="row nospace">
							<& "entry_details.mas",
								entry   => $entry,
								coaches => $coaches,
								tourn   => $tourn,
								student => $student,
								past    => $past
							&>
						</div>
%					}
%				}
			</span>
		</div>

%		if ($entries{"supp"}) {

			<h5 class="normalweight nospace martopmuchmore marbottomless">5. Supplementals</h5>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">
%					foreach my $entry (@{$entries{"supp"}}) {
						<div class="row nospace">
							<& "entry_details.mas",
								entry   => $entry,
								coaches => $coaches,
								past    => $past,
								tourn   => $tourn
							&>
						</div>
%					}
				</span>
			</div>
%		}

%		if ($entries{"conn"}) {

			<h5 class="normalweight nospace marbottomless martopmuchmore">6. Consolations</h5>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">
%					foreach my $entry (@{$entries{"conn"}}) {
						<div class="row nospace">
							<& "entry_details.mas",
								entry   => $entry,
								coaches => $coaches,
								past    => $past,
								tourn   => $tourn
							&>
						</div>
%					}
				</span>
			</div>
%		}

	</div>
