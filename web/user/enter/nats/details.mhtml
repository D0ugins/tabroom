<%args>
	$school
	$student_id => undef
</%args>
<%init>

	my $student = Tab::Student->retrieve($student_id) if $student_id;

	unless ($student) { 
		$m->comp('/funclib/abort.mas', 
			message => "No student record found for ID number $student_id"
		);
	}

	unless ($student->chapter->id == $school->chapter->id) {
		$m->comp('/funclib/abort.mas', 
			message => "Student ".$student->first." ".$student->last." does not belong to your school."
		);
	}

	my $tourn = $school->tourn();

	my %release_forms = eval { 
		return %{JSON::decode_json($school->setting("release_forms"))};
	};

	my %entries = $m->comp(
		"/funclib/nationals_entries.mas",
		student => $student,
		tourn => $tourn
	);

	my %events;

	foreach my $event ($tourn->events) {

		if ($event->setting("supp")) { 
			push @{$events{"supp"}}, $event;
		} elsif ($event->setting("conn")) { 
			push @{$events{"conn"}}, $event;
		} elsif ($event->setting("stefan")) { 
			push @{$events{"stefan"}}, $event;
		} else { 
			push @{$events{"main"}}, $event;
		}

	}

	my @coaches = $m->comp(
		"/funclib/nsda_school_coaches.mas",
		school => $school
	);

</%init>

	<div class="menu">

		<div class="sidenote">

			<h4>Navigate</h4>

			<a 
				href="entries.mhtml?school_id=<% $school->id %>"
				class="full blue"
			>Return to School Entry</a>

			<h4 class="martop">Notes &amp; Details</h4>

			<% $tourn->setting("suppconn_message") %>

		</div>

	</div>

	<div class="main">

		<& "../tabbar.mas", 
			school => $school, 
			whoami => "entries"
		&>

		<span class="twothirds nospace">
			<h4><% $student->first." ".$student->last %></h4>
		</span>
		<span class="third rightalign">
			<h6>Merit #<% $student->ualt_id %></h4>
		</span>

		<h5 class="normalweight nospace martopmore marbottomless">
			1. Select Supplementals &amp; Consolations
		</h5> 

		<form 
			action="supps_save.mhtml" 
			method="post"
		>

			<input 
				type  = "hidden"
				name  = "school_id"
				value = "<% $school->id %>"
			>

			<input 
				type  = "hidden"
				name  = "student_id"
				value = "<% $student->id %>"
			> 

			<div class="row bordertop padvert"> 

				<span class="sixth semibold rightalign">
					Supplemental(s):
				</span>

				<span class="fivesixths nospace padleft smaller">

%					if ($events{'supp'}) { 
%						foreach my $supp (@{$events{'supp'}}) { 
							<label for="<% $supp->id %>">
								<span 
									class = "realfifth hover nospace ltborderright"
									title = "<% $supp->name %>"
								>
									<span class="threequarters smallish marno padleft">
										<% $supp->name %>
									</span>

									<span class="fifth centeralign marno">
										<input 
											type  = "checkbox"
											name  = "<% $supp->id %>"
											id    = "<% $supp->id %>"
											value = "1"
											<% $entries{$supp->id} ? "checked" : "" %>
										>
									</span>
								</span>
							</label>
%						}
%					}

				</span>
			</div>

			<div class="row padvert">
				<span class="sixth semibold padvert rightalign">
					Consolation(s):
				</span>

				<span class="fivesixths nospace padleft smaller">

%					if ($events{'conn'}) { 
%						foreach my $conn (@{$events{'conn'}}) { 

							<label for="<% $conn->id %>">
								<span 
									class = "realfifth hover nospace ltborderright"
									title = "<% $conn->name %>"
								>
									<span class="threequarters smallish marno padleft">
										<% $conn->name %>
									</span>

								 	<span class="fifth centeralign marno">
										<input 
											type  = "checkbox"
											name  = "<% $conn->id %>"
											id    = "<% $conn->id %>"
											value = "1"
											<% $entries{$conn->id} ? "checked" : "" %>
										>
									</span>
								</span>
							</label>
%						}
%					}

				</span>
			</div>

			<div class="liblrow rightalign">
				<input 
					type="submit"
					value="Register Supplementals"
				>
			</div>

		</form>

		<h5 class="normalweight nospace martopmore marbottomless">
			2. Entry Release Form
		</h5> 

		<div class="bordertop padtop"> 

			<span class="seveneighths nospace bluetext semibold biggish centeralign">
				A signed copy of this form is required for each student.
				Download &amp; sign, then scan &amp; upload:
			</span>

			<span class="eighth rightalign">
				 <a 
					class = "buttonwhite orangetext invert"
					href  = "<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$tourn->setting("entry_release") %>">
					<span class="inline fa fa-arrow-down"></span> Form
				</a>
			</span>
		</div>

		<form 
			enctype  = "multipart/form-data"
			onsubmit = "return uploadThis()"
			action   = "details_save.mhtml"
			method   = "post"
		>

		<input 
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input 
			type  = "hidden"
			name  = "student_id"
			value = "<% $student->id %>"
		> 

		<div class="row bordertop borderbottom martop">

			<span class="sixth semibold bluetext rightalign">
				Signed copy:
			</span>

			<span class="third centeralign">
				<div class="uploader wider">

					<input 
						type	 = "file"
						name	 = "entry_release_<% $student->id %>"
						style	= "opacity: 0;"
						onchange = "uploaderName(
							'entry_release_<% $student->id %>',
							'entry_release_<% $student->id %>_file'
						)"
						id	   = "entry_release_<% $student->id %>"
					>

					<span 
						id  = "entry_release_<% $student->id %>_file"
						class = "filename"
						style = "-webkit-user-select: none;"
					>Upload File</span>

					<span 
						class = "action"
						style = "-webkit-user-select: none;"
					>Choose File</span>
				</div>

			</span>

			<span class="half rightalign padvert">

%				if ($release_forms{$student->id}) {

					<span 
						class="fa fa-lg fa-check fa-lg greentext sixth centeralign">
					</span>

					<a 
						class = "greentext semibold"
						href  = "<% $Tab::s3_url %>/<% $tourn->id."/".$school->id."/releases/".$student->id."/".$release_forms{$student->id} %>" 
					> <% $release_forms{$student->id} %> </a>

%				} else {

					<span 
						class="fa fa-lg fa-times-circle redtext marless"
					></span>

					<span class="semibold redtext align bigger padrightmuchmore marrightmore">
						Not Uploaded
					</span>
%		   		}

			</span>


		</div>

		<h5 class="normalweight nospace martopmuchmore marbottomless">
			3. Pronunciation Guide
		</h5> 

		<div class="row bordertop padvert">

			<span class="bluetext semibold rightalign half">
				Short phonetic pronunciation guide for awards, etc:
			</span>

			<span class="half centeralign">

				<input 
					type  = "text"
					name  = "phonetic"
					size  = "32"
					value = "<% $student->phonetic %>"
				>
			</span>
		</div>

		<h5 class="normalweight nospace martopmuchmore marbottomless">
			4. Main Event Details
		</h5> 

%		if ($entries{"main"}) { 
%			foreach my $entry (@{$entries{"main"}}) { 

				<div class="row nospace">
				<& "entry_details.mas", 
					entry   => $entry,
					coaches => \@coaches,
					tourn   => $tourn
				&>
				</div>
%			}
%		}

%		if ($entries{"supp"}) { 

			<h5 class="normalweight nospace martopmuchmore marbottomless">5. Supplementals</h5> 

%			foreach my $entry (@{$entries{"supp"}}) { 
				<div class="row nospace">
				<& "entry_details.mas", 
					entry   => $entry,
					coaches => \@coaches,
					tourn   => $tourn
				&>
				</div>
%			}
%		}

%		if ($entries{"conn"}) { 

			<h5 class="normalweight nospace marbottomless martopmuchmore">6. Consolations</h5> 

%			foreach my $entry (@{$entries{"conn"}}) { 
				<div class="row nospace">
				<& "entry_details.mas",
					entry   => $entry,
					coaches => \@coaches,
					tourn   => $tourn
				&>
				</div>
%			}
%		}

		<div class="liblrow rightalign">
			<input 
				type  = "submit"
				value = "Save Details"
			>
		</div>

		</form>

	</div>
