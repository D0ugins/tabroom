<%args>
	$school
	$student_id => undef
</%args>
<%init>

	my $student = Tab::Student->retrieve($student_id) if $student_id;

	unless ($student) {
		$m->comp('/funclib/abort.mas',
			message => "No student record found for ID number $student_id"
		);
	}

	unless ($student->chapter->id == $school->chapter->id) {
		$m->comp('/funclib/abort.mas',
			message => "Student ".$student->first." ".$student->last." does not belong to your school."
		);
	}

	my $tourn = $school->tourn();
	my %tourn_settings = $tourn->all_settings();

	my %release_forms = eval {
		return %{JSON::decode_json($school->setting("release_forms"))};
	};

	my %entries = $m->comp(
		"/funclib/nationals_entries.mas",
		student => $student,
		tourn => $tourn
	);

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			event.id, event.abbr, event.name,
			pattern.id, pattern.name, pattern.type, pattern.max, pattern.exclude,
			supp.value, conn.value, stefan.value,
			online_hybrid.value
		from event
			left join pattern on event.pattern = pattern.id
			left join event_setting supp on supp.event = event.id and supp.tag = 'supp'
			left join event_setting conn on conn.event = event.id and conn.tag = 'conn'
			left join event_setting stefan on stefan.event = event.id and stefan.tag = 'stefan'
			left join event_setting online_hybrid on online_hybrid.event = event.id and online_hybrid.tag = 'online_hybrid'
		where event.tourn = ?
	");

	$sth->execute($tourn->id);

	my %events;
	my %patterns;
	my %types;

	while (
		my (
			$event_id, $event_abbr, $event_name,
			$pattern_id, $pattern_name, $pattern_type, $pattern_max, $pattern_exclude,
			$supp_value, $conn_value, $stefan_value, $online
		) = $sth->fetchrow_array()
	) {

		if ($stefan_value) {
			$events{$event_id}{"type"} = "stefan";
			$events{"by_pattern"}{"stefan"}{$event_id}++;
			$events{"by_type"}{"stefan"}{$event_id}++;
			$types{"stefan"}++;
		} elsif ($conn_value) {
			$events{$event_id}{"type"} = "conn";
			$events{"by_pattern"}{"conn"}{$event_id}++;
			$events{"by_type"}{"conn"}{$event_id}++;
			$types{"conn"}++;
		} elsif ($supp_value) {
			$events{$event_id}{"type"} = "supp";
			$events{"by_type"}{"supp"}{$event_id}++;
			$events{"by_pattern"}{"supp"}{$event_id}++;
			$types{"supp"}++;
		} else {
			$events{$event_id}{"type"} = "main";
			$types{"main"}++;
			$events{"by_pattern"}{"main"}{$event_id}++;
		}

		$events{$event_id}{"online"} = $online;
		$events{$event_id}{"abbr"} = $event_abbr;
		$events{$event_id}{"name"} = $event_name;

		if ($pattern_id) {

			$events{$event_id}{"pattern"} = $pattern_id;
			$events{"by_pattern"}{$pattern_id}{$event_id}++;

			unless ($patterns{$pattern_id}) {

				$patterns{$pattern_id}{"name"} = $pattern_name;
				$patterns{$pattern_id}{"max"}  = $pattern_max;
				$patterns{$pattern_id}{"type"} = $pattern_type;

				if ($pattern_exclude) {
					$patterns{$pattern_id}{"exclude"} = eval {
						return JSON::decode_json($pattern_exclude);
					};
				}
			}
		}
	}

	my $coaches;
	my $roster_ref = $m->comp(
		"/funclib/nsda/school_roster.mas",
		chapter => $school->chapter
	);

	my @roster = eval {
		return @{$roster_ref};
	};

	foreach my $person (@roster) {
		if ($person->{role} eq "Coach") {
			push (@{$coaches}, $person);
		} elsif ($person->{role} eq "Advisor") {
			push (@{$coaches}, $person);
		}
	}

	my $drop_deadline = $tourn_settings{"drop_deadline"};
	$drop_deadline = $tourn->reg_end unless $drop_deadline;

	my $script_deadline = $tourn_settings{"script_deadline"};
	$script_deadline = $drop_deadline unless $script_deadline;

	my $release_deadline = $tourn_settings{"release_deadline"};
	$release_deadline = $drop_deadline unless $release_deadline;

	my $supp_deadline = $tourn_settings{"supp_deadline"};
	$supp_deadline = $drop_deadline unless $supp_deadline;

	my $now = DateTime->now();

	unless ($entries{"online"}) {
		# Check freebie count.  There can be only tourn_settings{"nsda_nonquals"}!;
	}

</%init>

	<div class="menu">

		<div class="sidenote">

			<h4>Navigate</h4>

			<a
				href="entries.mhtml?school_id=<% $school->id %>"
				class="full blue"
			>Return to School Entry</a>

			<h4 class="martop">Notes &amp; Details</h4>

			<% $tourn_settings{"suppconn_message"} %>

		</div>

	</div>

%	my $counter = 1;

	<div class="main">

		<& "../tabbar.mas",
			school => $school,
			whoami => "entries"
		&>

		<span class="twothirds nospace">
			<h4><% $student->first." ".$student->last %></h4>
		</span>
		<span class="third rightalign nospace">
			<h6>NSDA ID <% $student->nsda %></h4>
		</span>

		<div class="full martopmore marbottom nospace">
			<span class="half nospace">
				<h5 class="normalweight nospace">
					<% $counter++ %>. <% $entries{"main"} ? "Pre-register" : "Register" %> for Supplementals
				</h5>
			</span>

			<span class="half nospace rightalign bigger semibold orangetext">
				Supplementals have changed!  See note at right &rarr;
			</span>
		</div>

		<div class="centeralign nospace">

			<span class="ninetenths leftalign">

%				my $nosupp;
%				if ($now > $supp_deadline) {
%					$nosupp++;

					<p class="semibold redtext centeralign">
						The deadline to change your supplemental entries has passed
					</p>

%				} else {

					<form
						action="supps_save.mhtml"
						method="post"
					>
						<input
							type  = "hidden"
							name  = "school_id"
							value = "<% $school->id %>"
						>

						<input
							type  = "hidden"
							name  = "student_id"
							value = "<% $student->id %>"
					>
%				}

%				if ($types{"supp"}) {

					<div class="full nospace">

%						if ($types{"conn"}) {
							<span class="sixth semibold bigger">
								Supplemental Events
							</span>
							<span class="fivesixths nospace padleft smaller">
%						}

%							if (%patterns && (scalar (keys %patterns)) < 1) {

%								foreach my $pattern_id (sort keys %patterns) {

									<div class='full nospace padvertless row'>

										<span class='fifth bluetext bigger semibold'>
											<%  $patterns{$pattern_id}{"name"}
												? "Pattern ".$patterns{$pattern_id}{"name"}
												: "Supplementals"
											%>
										</span>

%										if ($patterns{$pattern_id}{"type"} > 0) {
%											if ($patterns{$pattern_id}{"max"} > 1) {
												<span class='fifth redtext semibold'>
													Max <% $patterns{$pattern_id}{"max"} %>
													events in <% $patterns{$pattern_id}{"name"} %>
												</span>
<%perl>
											}
										}

									foreach my $supp_id ( sort {
											$events{$a}{"abbr"} cmp $events{$b}{"abbr"}
										} keys %{$events{"by_pattern"}{$pattern_id}}
									) {

										my $supp_name = $events{$supp_id}{"name"};
										$supp_name =~ s/Extemporaneous/Extemp/g;
</%perl>
										<label for="<% $supp_id %>">
											<span
												class = "realfifth hover nospace ltborderright"
												title = "<% $events{$supp_id}{"name"} %>"
											>
												<span class="tenth centeralign marno">
%													if ($events{$supp_id}{"online"}) {
														<span class="full fa fa-sm fa-laptop greentext" title="Online/In Person Hybrid Event">
															Yo
														</span>
%													} else {
%													}
												</span>
												<span class="threequarters smallish marno padleft">
													<% $supp_name %>
												</span>

												<span class="tenth centeralign marno">
													<input
														type  = "checkbox"
														class = "<% $pattern_id %>"
														<% $nosupp ? 'disabled' : "" %>
														name  = "<% $supp_id %>"
														id    = "<% $supp_id %>"
														value = "1"
														<% $entries{$supp_id} ? "checked" : "" %>
													>
												</span>
											</span>
										</label>
<%perl>
									}

									$m->print("</div>");
								}

							} else {

								$m->print("<div class='odd nospace bluebordertop'>");

								foreach my $supp_id ( sort {
										$events{$a}{"abbr"} cmp $events{$b}{"abbr"}
									} keys %{$events{"by_type"}{"supp"}}
								) {

									my $supp_name = $events{$supp_id}{"name"};
									$supp_name =~ s/Extemporaneous/Extemp/g;
</%perl>
									<label for="<% $supp_id %>">
										<span
											class = "third almosttrue hover nospace ltborderright ltborderbottom"
											title = "<% $events{$supp_id}{"name"} %>"
										>
											<span class="tenth centeralign marno">
%												if ($events{$supp_id}{"online"}) {
													<span class="full fa fa-sm fa-laptop greentext" title="Online/In Person Hybrid Event">
													</span>
%												} else {
													<span class="full fa fa-sm fa-users bluetext" title="Live in Person Only">
													</span>
%												}
											</span>
											<span class="threequarters smallish marno padleft">
												<% $supp_name %>
											</span>

											<span class="tenth centeralign marno">
												<input
													type  = "checkbox"
													<% $nosupp ? 'disabled' : "" %>
													name  = "<% $supp_id %>"
													id    = "<% $supp_id %>"
													value = "1"
													<% $entries{$supp_id} ? "checked" : "" %>
												>
											</span>
										</span>
									</label>
%								}
								</div>
%							}
%						if ($types{"conn"}) {
							</span>
%						}
					</div>
%				}

%				if ($events{'conn'}) {

					<div class="row padvert">
						<span class="sixth semibold padvert rightalign">
							Consolations
						</span>

						<span class="fivesixths nospace padleft smaller">

%							foreach my $conn (@{$events{'conn'}}) {

								<label for="<% $conn->id %>">
									<span
										class = "realfifth hover nospace ltborderright"
										title = "<% $conn->name %>"
									>
										<span class="threequarters smallish marno padleft">
											<% $conn->name %>
										</span>

										<span class="fifth centeralign marno">
											<input
												type  = "checkbox"
												name  = "<% $conn->id %>"
												id    = "<% $conn->id %>"
												value = "1"
												<% $nosupp ? 'disabled' : "" %>
												<% $entries{$conn->id} ? "checked" : "" %>
											>
										</span>
									</span>
								</label>
%							}
						</span>
					</div>
%				}

%				unless ($nosupp) {
					<div class="liblrow rightalign">
						<span class="centeralign true third nospace">
							<input
								type="submit"
								value="Save Pre-Registration"
							>
						</span>
					</div>
%				}

			</span>
		</div>

		</form>

%		if ($entries{"main"} || $entries{"realsupp"}) {

			<div class="full martopmuchmore marbottomless">
				<span class="third nospace">
					<h5 class="normalweight nospace">
						<% $counter++ %>. Online Entry
					</h5>
				</span>
				<span class="twothirds rightalign explain semibold bluetext nospace">
					Only available for supp-only entries. A competitor may not enter
					both in-person and online events.
				</span>
			</div>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">
					<div class="row bluebordertop padvert centeralign semibold biggish bluetext padvertmuchmore">
						<span class="full padvertless marno redtext">
%						foreach my $entry (@{$entries{"main"}}, @{$entries{"realsupp"}} ) {
							<% $entry->event->abbr %>
%						}
							are in-person only event(s).
						</span>
						You must drop/reject any in-person only entries before
						registering as an online competitor
					</div>
				</span>
			</div>

%		} elsif ($entries{'supp'} && $tourn_settings{"supp_online_hybrid"}) {

			<div class="full martopmuchmore marbottomless">
				<span class="third nospace">
					<h5 class="normalweight nospace">
						<% $counter++ %>. Online Entry
					</h5>
				</span>
				<span class="twothirds rightalign explain semibold bluetext nospace">
					Only available for supp-only entries. A competitor may not
					enter both live and online events. <br/> This switch will change
					ALL this competitor's entries.
				</span>
			</div>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">
					<div class="row bluebordertop padvert">

						<span class="fourfifths centeralign semibold biggish">
							Competitor will participate in online asynchronous
							events, not live in person:
						</span>
						<span class='tenth rightalign nospace'>
                             <& "/funclib/bool_switch.mas",
                                 tag       => "online_hybrid",
                                 value     => $entries{"online"},
                                 target    => $student->id,
								 tourn_id  => $tourn->id,
								 school_id => $school->id,
								 url       => "student_switch.mhtml",
                                 smaller   => 1,
                             &>
						</span>
					</div>
				</span>
			</div>
%		}

%		if (keys %entries) {

		<form
			enctype  = "multipart/form-data"
			action   = "details_save.mhtml"
			method   = "post"
		>

		<input
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input
			type  = "hidden"
			name  = "student_id"
			value = "<% $student->id %>"
		>

		<div class="full martopmuchmore marbottomless">
			<span class="fourfifths nospace">
				<h5 class="normalweight nospace">
					<% $counter++ %>. Tabroom account
				</h5>
			</span>
			<span class="fifth centeralign nospace">
%				if ($student->person > 1) {
					<span class="fa fa-2x greentext fa-check"></span>
%				} else {
					<span class="fa fa-2x redtext fa-times-circle-o"></span>
%				}
			</span>
		</div>

		<div class="centeralign nospace">
			<span class="ninetenths leftalign">
				<div class="row bluebordertop padvert">

					<span class="bluetext semibold rightalign half">
						Must be linked to a Tabroom.com account
					</span>

					<span class="fourtenths centeralign">
						<input
							type        = "text"
							name        = "tabroom_email"
							size        = "28"
							value       = "<% $student->person ? $student->person->email : "" %>"
							placeholder = "Enter email address of student's Tabroom.com account"
						>
					</span>

					<span class='tenth rightalign nospace'>
						<input type="submit" value="Save">
					</span>
				</div>
			</span>
		</div>

		<div class="full martopmore marbottomless">
			<span class="half nospace">
				<h5 class="normalweight nospace">
					<% $counter++ %>. Pronunciation Guide
				</h5>
			</span>

			<span class="twofifths nospace rightalign semibold orangetext">
				Optional
			</span>
		</div>

		<div class="centeralign nospace">
			<span class="ninetenths leftalign">
				<div class="row bluebordertop padvert">

					<span class="bluetext semibold rightalign half">
						Short phonetic pronunciation guide for awards
					</span>

					<span class="fourtenths centeralign">

						<input
							type  = "text"
							name  = "phonetic"
							size  = "28"
							value = "<% $student->phonetic %>"
						>
					</span>

					<span class='tenth rightalign nospace'>
						<input type="submit" value="Save">
					</span>
				</div>
			</span>
		</div>

		<div class="full martopmore marbottomless">
			<span class="half nospace">
				<h5 class="normalweight nospace">
					<% $counter++ %>. Entry Release Form
				</h5>
			</span>

			<span class="twofifths nospace rightalign semibold orangetext">
				Optional
			</span>
		</div>

		<div class="centeralign nospace">
			<span class="ninetenths leftalign">

				<div class="bluebordertop padtop odd marno">
					<p class="biggish semibold marno padleft padright padtopmore padbottommore">
						The coach must acquire a signed form for this student and
						retain it through December 31, <% $tourn->start->year %>. It is

						<span class="inline orangetext">NO LONGER REQUIRED</span> that
						you upload the form here, though you are welcome to for
						record-keeping purposes.
					</p>
				</div>

				<div class="row borderbottom marvertno">
					<div class="full ltborderbottom">
						<span class="quarter semibold bluetext rightalign">
							Download blank form
						</span>

						<span class="twenty">
						</span>
						<span class="spacer">
						</span>

						<span class="quarter nospace rightalign">
							 <a
								class = "white full bluetext semibold ltborder padvertmore marno centeralign link-underline"
								href  = "<% $Tab::s3_url %>/<% $tourn->id."/entry_release/".$tourn->setting("entry_release") %>">
								<span class='fa fa-sm fa-file-pdf-o'></span>
								Release Form
							</a>
						</span>
					</div>

%					if ($release_forms{$student->id}) {

						<div class="full ltborderbottom">
							<span class="quarter semibold bluetext rightalign">
								Current uploaded form
							</span>

							<span class="threequarters leftalign padvert">
								<a class = "greentext semibold nospace"
									href  = "<% $Tab::s3_url %>/<% $tourn->id."/".$school->id."/entry_release/".$student->id."/".$release_forms{$student->id} %>"
								><% $release_forms{$student->id} %></a>
							</span>
						</div>
%					}

					<div class="full nospace">
						<span class="quarter semibold bluetext rightalign">
							Upload signed copy
						</span>

						<span class="half rightalign">
							<span class="ninetenths centeralign">
								<div class="uploader dynamic">
									<input
										type	 = "file"
										name	 = "entry_release_<% $student->id %>"
										style	= "opacity: 0;"
										onchange = "uploaderName(
											'entry_release_<% $student->id %>',
											'entry_release_<% $student->id %>_file'
										)"
										id	   = "entry_release_<% $student->id %>"
									>

									<span
										id  = "entry_release_<% $student->id %>_file"
										class = "filename"
										style = "-webkit-user-select: none;"
									>Upload File</span>

									<span
										class = "action"
										style = "-webkit-user-select: none;"
									>Choose File</span>
								</div>
							</span>
						</span>

						<span class='quarter centeralign padvert'>
							<input type="submit" value="Save">
						</span>
					</div>
				</div>
%				}
			</span>
		</div>

%		my $past;

%		if ($entries{"main"}) {
			<h5 class="normalweight nospace martopmuchmore marbottomless">
				<% $counter++ %>.  Main Event Details
			</h5>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">
%					$past++ if ($now > $script_deadline);
%					if ($entries{"main"}) {
%						foreach my $entry (@{$entries{"main"}}) {
							<& "entry_details.mas",
								entry   => $entry,
								coaches => $coaches,
								tourn   => $tourn,
								student => $student,
								past    => $past
							&>
%						}
%					}
				</span>
			</div>
%		}

%		if ($entries{"supp"}) {

			<h5 class="normalweight nospace martopmuchmore marbottomless">
				<% $counter++ %>. Supplemental Events
			</h5>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">
%					foreach my $entry (@{$entries{"supp"}}) {
						<& "entry_details.mas",
							entry   => $entry,
							coaches => $coaches,
							past    => $past,
							tourn   => $tourn
						&>
%					}
				</span>
			</div>
%		}

%		if ($entries{"conn"}) {
			<h5 class="normalweight nospace marbottomless martopmuchmore">
				<% $counter++ %>. Consolations
			</h5>

			<div class="centeralign nospace">
				<span class="ninetenths leftalign">
%					foreach my $entry (@{$entries{"conn"}}) {
						<& "entry_details.mas",
							entry   => $entry,
							coaches => $coaches,
							past    => $past,
							tourn   => $tourn
						&>
%					}
				</span>
			</div>
%		}

		<div class="centeralign padleft padright">
			<span class="ninetenths rightalign libl bluebordertop">
				<span class="third centeralign">
					<input type="submit" value="Save All Entries">
				</span>
			</span>
		</div>

	</div>
