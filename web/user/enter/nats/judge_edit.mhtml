<%args>
	$school
	$category_id => undef
	$judge_id    => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id) if $judge_id;

	my %judge_settings;
	%judge_settings = $judge->all_settings() if $judge;

	my $category;

	if ($judge) { 
		$category = $judge->category();
	} elsif ($category_id) { 
		$category = Tab::Category->retrieve($category_id);
	}

	unless ($category) { 
		my $err = "Something went wrong: no valid judge or judge category sent?";
		$m->redirect("judges.mhtml?school_id=".$school->id."&err=$err");
	}

	my %category_settings = $category->all_settings();

	if ($judge && 
		$judge->school->id != $school->id
	) { 
		my $err = "That judge does not belong to your school.";
		$m->redirect("judges.mhtml?school_id=".$school->id."&err=$err");
	}

	my @alreadys = $school->judges;

	my %already = map { $_->chapter_judge->id => $_ } @alreadys;

	my %already_ualts = ();

	foreach my $already (@alreadys) { 

		if ($already->person) { 
			$already_ualts{$already->person->ualt_id} = $already;
		} elsif ($already->chapter_judge) { 
			
			if ($already->chapter_judge->setting("nsda")) {
				$already_ualts{$already->chapter_judge->setting("nsda")} = $already;
			}

		}


</%init>

	<div class="main">

		<& "../tabbar.mas", 
			school => $school, 
			whoami => "judges"
		&>

		<span class="twothirds nospace">
			<h5><% $judge ? $judge->first." ".$judge->last : "Add a judge" %></h5>
		</span>

		<span class="third rightalign bluetext semibold bigger">
			<% $category->name %>
		</span>

		<form action="judge_save.mhtml" method="post">

		<input	
			type  = "hidden"
			name  = "judge_id"
			value = "<% $judge %>"
		>

		<input	
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input	
			type  = "hidden"
			name  = "category_id"
			value = "<% $category->id %>"
		>

		<span class="pagehalf">

			<div class="row">

				<span class="third semibold">
					Tabroom roster judge
				</span>

				<span class="twothirds centeralign">
					<select 
						name  = "chapter_judge_id"
						class = "fixedbig"
					>
<%perl>
					foreach my $chapter_judge (
						$school->chapter->chapter_judges(retired => 0)
					) { 

						next if $already{$chapter_judge->id};
</%perl>
						<option 
							value="<% $chapter_judge->id %>"
							<% $judge && $chapter_judge->id == $judge->chapter_judge->id 
								? 'selected="selected"'
								: ""
						%>><% $chapter_judge->first." ".$chapter_judge->last %></option>
%					}
				</span>

			</div>

			<div class="row">

				<span class="third semibold">
					NSDA Coach Record
				</span>

				<span class="twothirds centeralign">
<%perl>
					foreach my $coach (
						$m->comp(
							"/funclib/nsda_school_coaches.mas",
							school => $school
						)
					) { 

						next if $already_ualt_id{$coach->ualt_id};
</%perl>
						<option 
							value="<% $coach->ualt_id %>"
							<% $judge 
								&& $judge->chapter_judge 
								&& $judge->chapter_judge->setting('nsda') == $coach->ualt_id 	
								? 'selected="selected"'
								: "" 
							%>
						><% $coach->ufname." ".$coach->ulname %></option>
%					}
				</span>
			</div>

			<div class="row">
				<span class="third semibold">
					Tabroom account
				</span>

				<span class="twothirds centeralign">
					<input 
						type="email"
						name="email"
						size="64"
						value="<% $judge && $judge->person 
							? $judge->person->email 
							: ""
						%>"
					>
				</span>
			</div>

		</span>

		<span class="pagehalf">

			<div class="row">

				<span class="third semibold">
					First
				</span>

				<span class="twothirds">	
					<input 
						type  = "text"
						name  = "first"
						size  = "24"
						value = "<% $judge ? $judge->first : "" %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="third semibold">
					Last
				</span>

				<span class="twothirds">	
					<input 
						type  = "text"
						name  = "last"
						size  = "24"
						value = "<% $judge ? $judge->last : "" %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="third semibold">
					Phone
				</span>

				<span class="twothirds">	
					<input 
						type  = "tel"
						name  = "phone"
						size  = "24"
						value = "<% $judge && $judge->person 
								? Tab::phoneme($judge->person->phone)
								: Tab::phoneme($judge_settings{"phone"}) %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="third semibold">
					Email
				</span>

				<span class="twothirds">	
					<input 
						type  = "email"
						name  = "email"
						size  = "24"
						value = "<% $judge && $judge->person 
								? Tab::emailme($judge->person->email)
								: Tab::emailme($judge_settings{"email"}) %>"
					>
				</span>
			</div>

		</span>

%		if ($judge && $category_settings{"nats_category"}) { 

			<div class="row">
				<span class="quarter semibold">
					Round Committment
				</span>
				<span class="quarter centeralign">
					<input 
						type="number"
						min = "0"
						max = "<% $category_settings{"max_rounds"} 
							?  $category_settings{"max_rounds"} 
							:  "9"
						%>"
					>
				</span>
			</div>

%		}

		<div class="full libl rightalign marvertno">
			<input 
				type="submit"
				value="<% $judge ? "Save Judge" : "Add Judge" %>"
			>
		</div>

	</div>
