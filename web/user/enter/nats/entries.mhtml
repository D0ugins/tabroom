<%args>
	$person
	$school
	$tourn
</%args>
<%init>

	my $tz = $tourn->tz;
	my %tourn_settings = $tourn->all_settings();

	my $now = DateTime->now();

	my %students = $m->comp(
		"/funclib/nationals_students.mas",
		school => $school,
		tourn  => $tourn,
		limit  => "all"
	);

	my %release_forms = eval { 
		return %{JSON::decode_json($school->setting("release_forms"))};
	};

</%init>

	<div class="main">

		<& "../tabbar.mas", 
			school => $school, 
			whoami => "entries"
		&>

		<span class="fourfifths">
			<h4>Entries</h4>
		</span>

		<span 
			class = "fifth rightalign"
			id    = "mains_buttonarea"
		>
		</span>

		<& 
			"/funclib/tablesorter.mas", 
			table => 'mains'
		&>

		<table id="mains">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						Competitor
					</th>

					<th>
						Main Event
					</th>

					<th>
						Supplementals
					</th>

					<th>
						Consolations
					</th>

					<th> 
						Details
					</th>

					<th> 
						Status
					</th>

				</tr>

			</thead>

			<tbody>
<%perl>
				my %done;

				foreach my $student_id (
					sort {
						$students{$a}{"main_id"} <=> $students{$b}{"main_id"} 
					}
					keys %students
				) { 

					my $student = $students{$student_id}{"object"};

					my $incomplete;

					$incomplete++ unless $release_forms{$student->id};

</%perl>

					<tr>

						<td title="<% $student->ualt_id %>">
							<% $student->first." ".$student->last %>
						</td>

						<td class="nospace">

<%perl>
							my $main;

							foreach my $entry (@{$students{$student_id}{"main"}}) { 

								$main = $entry if $entry->active;

								$incomplete++ unless $entry->coach_points;
								$incomplete++ unless $entry->coach_script;

								my $partners++ if scalar (split (/\,/, $entry->studentids)) > 1;

</%perl>

								<div class="full nospace">

									<span class="sixth semibold bluetext">
										<% $entry->event->abbr %>
									</span>

%									if ($entry->event->type eq "wsdc") { 

										<span 
											class = "fivesixths"
											title = "Only district chairs can change district team entries"
										><% $entry->code %></span>

<%perl>
									} else { 

										if ($entry->rejected_by) { 

											my $whodunnit = Tab::Person->retrieve($entry->rejected_by);
											my $date = eval { 
												return Tab::shortdate(
													DateTime::Format::MySQL->parse_datetime(
														$entry->rejected_at
													)
												);
											};
</%perl>
											<span class="fivesixths graytext italic">
												Rejected by <% $whodunnit 
													? $whodunnit->first." ".$whodunnit->last
													: ""
												%><% $date ? " on ".$date : "" %>
											</span>

%										} elsif ($entry->unconfirmed && $now > $tourn->reg_end)  {
										
											<span class="half semibold redtext padvertno">
												Acceptance Deadline Passed
											</span>

%										} else { 

%											if ($entry->unconfirmed) { 

												<span class="quarter nospace centeralign">
													<a  class="buttonwhite greentext smallish"
														href = "accept.mhtml?entry_id=<% $entry->id %>"
													>ACCEPT</a>
												</span>

												<span class="quarter nospace centeralign">
%													if ($now < $tourn_settings{'drop_deadline'}) { 
														<a 
															class="buttonwhite redtext smallish"
															href = "reject.mhtml?entry_id=<% $entry->id %>"
														><% $entry->unconfirmed ? "REJECT" : "DROP" %></a>
%													} else { 
														<span class="full semibold redtext nospace">
															Drop deadline passed.
														</span>
%													}
												</span>

%											} else { 

												<span class="half semibold greentext nospace centeralign">
													ACCEPTED
												</span>
%											}

%										}

%										if ($partners) { 
											<span class="third marno padless graytext smallish rightalign">
												<% $entry->name %>
											</span>
%										}

%									}

								</div>
%							}
						</td>

						<td class="nospace smaller">
<%perl>
							foreach my $entry (@{$students{$student_id}{"supp"}}) { 
								$incomplete++ unless $entry->coach_points;
								$incomplete++ unless $entry->coach_script;
</%perl>

								<% $entry->event->abbr %>
%							}
						</td>

						<td class="nospace smaller">
<%perl>
							foreach my $entry (@{$students{$student_id}{"conn"}}) { 
								$incomplete++ unless $entry->coach_points;
								$incomplete++ unless $entry->coach_script;
</%perl>
								<% $entry->event->abbr %>
%							}
						</td>

						<td class="centeralign semibold nospace padless">
%							if ($main) { 
								<a	
									class="fa fa-edit buttonwhite bluetext"
									href="details.mhtml?student_id=<% $student->id %>&school_id=<% $school->id %>"
								></a>
%							}
						</td>

						<td 
							title="<% $incomplete 
								? "Details and/or forms are still missing" 
								: "Entry details and information are complete"
							%>"
							class="centeralign nospace"
						><span 
							class="semibold fa fa-2x normalweight <% $incomplete 
								? "redtext fa-times-circle" 
								: "greentext fa-check-circle"
							%>
						"></span></td>


					</tr>

%				}

			</tbody>

		</table>

	</div>

