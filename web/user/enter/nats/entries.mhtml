<%args>
	$person
	$school
	$tourn
</%args>
<%init>

	my $tz = $tourn->tz;
	my %tourn_settings = $tourn->all_settings();

	my $now = DateTime->now();

	my %students = $m->comp(
		"/funclib/nationals_students.mas",
		school => $school,
		tourn  => $tourn,
		limit  => "all"
	);

	my %release_forms = eval {
		return %{JSON::decode_json($school->setting("release_forms"))};
	};

	my @eligibles;
	my @rejects;

	foreach my $student_id (keys %students) {

		my $ok;
		my $rejected;

		foreach my $entry (@{$students{$student_id}{"main"}}) {
			$ok++ unless $entry->rejected_by;
			$rejected++ if $entry->rejected_by;
		}

		foreach my $entry (@{$students{$student_id}{"supp"}}) {
			$ok++ if $entry && $entry->unconfirmed != 1;
		}
		foreach my $entry (@{$students{$student_id}{"conn"}}) {
			$ok++ if $entry && $entry->unconfirmed != 1;
		}

		push @eligibles, $student_id if $ok;
		push @rejects, $student_id if $rejected;
	}

    my %reasons;

    %reasons = $m->comp(
        "/funclib/judgemath/nats_check_judging.mas",
        school => $school
    ) if $tourn_settings{"nsda_nats"};


	my $drop_deadline = $tourn_settings{"drop_deadline"};
	$drop_deadline = $tourn->reg_end unless $drop_deadline;

	my $script_deadline = $tourn_settings{"script_deadline"};
	$script_deadline = $drop_deadline unless $script_deadline;

	my $release_deadline = $tourn_settings{"release_deadline"};
	$release_deadline = $drop_deadline unless $release_deadline;

	my $supp_deadline = $tourn_settings{"supp_deadline"};
	$supp_deadline = $drop_deadline unless $supp_deadline;

	foreach my $dt ($drop_deadline, $script_deadline, $release_deadline, $supp_deadline) {
		next unless $dt && $dt->epoch;
		$dt->set_time_zone($tz);
	}
</%init>

	<div class="blankfull">

		<& "../tabbar.mas",
			school         => $school,
			tourn_settings => \%tourn_settings,
    		reasons        => \%reasons,
			whoami         => "entries"
		&>

		<span class="fourfifths nospace martopmore">
			<h4 class="nospace">Entries</h4>
		</span>

		<span
			class = "fifth rightalign nospace martopmore"
			id    = "mains_buttonarea"
		>
		</span>

%		if ($now > $drop_deadline) {

			<p class='bigger centeralign redtext semibold marbottommore'>
				The deadline to make drops or changes online has passed.
			</p>

%		} elsif ($now > $tourn->reg_end) {

			<p class='bigger centeralign redtext semibold marbottom'>
				The deadline to add entries has passed.
			</p>

%		}

		<&
			"/funclib/tablesorter.mas",
			table => 'mains'
		&>

		<table id="mains">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						Competitor
					</th>

					<th>
						Main Event
					</th>

					<th>
						Supplementals
					</th>

					<th>
						Consolations
					</th>

					<th>
						Edit
					</th>

					<th>
						Status
					</th>

				</tr>

			</thead>

			<tbody>
<%perl>
				my $not_a_total_moron;

				foreach my $student_id (
					sort {
						$students{$a}{"main_id"} <=> $students{$b}{"main_id"}
						|| $a <=> $b
					}
					@eligibles
				) {

					my $student = $students{$student_id}{"object"};
					my $incomplete;

					$incomplete++ unless $release_forms{$student->id};
					$not_a_total_moron++ if $release_forms{$student->id};

</%perl>

					<tr>

						<td title="<% $student->nsda %>">
							<% $student->first." ".$student->last %>
						</td>

						<td class="nospace">

<%perl>
							my $details;
							my $num_entries = scalar @{$students{$student_id}{"main"}};
							my $count;

							foreach my $entry (@{$students{$student_id}{"main"}}) {

								next if $entry->rejected_by;

								unless ($entry->event->setting('usa_wsdc')) {
									$incomplete++ unless $entry->coach_points;
									$incomplete++ unless $entry->coach_script;
									$incomplete++ unless $entry->setting('status') eq "complete";
								}

								my $partners++ if scalar (split (/\,/, $entry->studentids)) > 1;

</%perl>

								<div class="full <% $count++ ? "bordertop" :  "" %>
									<% $num_entries > 1 ? "marno" : "nospace" %>">

									<span class="sixth semibold bluetext marno padleft">
										<% $entry->event->abbr %>
									</span>

%									if ($entry->event->type eq "wsdc") {

										<span
											class = "fivesixths"
											title = "Only district chairs can change district team entries"
										><% $entry->code %></span>

<%perl>
									} else {

										my $created_at = $entry->created_at;
										$created_at->add(days => 7);

										if ($entry->unconfirmed
											&& $now > $tourn->reg_end
											&& $now > $created_at
										)  {
</%perl>

											<span class="half semibold redtext padvertno">
												Accept Deadline Passed
											</span>

%										} elsif ($entry->unconfirmed) {

											<span class="quarter nospace centeralign">
												<a  class="buttonwhite greentext smallish"
													href = "accept.mhtml?entry_id=<% $entry->id %>"
												>ACCEPT</a>
											</span>

											<span class="quarter nospace centeralign">
%												if ($now < $tourn_settings{'drop_deadline'}) {
													<a
														class="buttonwhite redtext smallish"
														href = "reject.mhtml?entry_id=<% $entry->id %>"
													><% $entry->unconfirmed ? "REJECT" : "DROP" %></a>
%												} else {
													<span class="full semibold redtext nospace">
														Drop deadline passed.
													</span>
%												}
											</span>

%										} else {

											<span class="half semibold greentext nospace centeralign">
												ACCEPTED
											</span>
%										}

%										if ($partners) {
											<span class="third marno padless graytext smallish rightalign">
												<% $entry->name %>
											</span>
%										}

%									}

								</div>
%							}
						</td>

							<td class="nospace smallish centeralign">
<%perl>
								foreach my $entry (@{$students{$student_id}{"supp"}}) {
									$incomplete++ unless $entry->coach_points;
									$incomplete++ unless $entry->coach_script;
									$incomplete++ unless $entry->setting('status') eq "complete";
									$not_a_total_moron++;
									$m->print($entry->event->abbr." ");
								}
</%perl>
							</td>

							<td class="nospace smallish centeralign">
<%perl>
								foreach my $entry (@{$students{$student_id}{"conn"}}) {
									$incomplete++ unless $entry->coach_points;
									$incomplete++ unless $entry->coach_script;
									$incomplete++ unless $entry->setting('status') eq "complete";
									$not_a_total_moron++;
</%perl>
									<% $entry->event->abbr %>
%								}
							</td>

						<td class="centeralign nospace">
							<a
								class="fa fa-sm fa-edit buttonwhite bluetext marvert"
								href="details.mhtml?student_id=<% $student->id %>&school_id=<% $school->id %>"
							></a>
						</td>

						<td
							title="<% $incomplete
								? "Details and/or forms are still missing"
								: "Entry details and information are complete"
							%>"
							class="centeralign nospace"
						>
							<span class="hidden"><% $incomplete ? "1" : "0" %></span>
							<span
								class="semibold fa fa-2x normalweight <% $incomplete
									? "redtext fa-times-circle"
									: "greentext fa-check-circle"
								%>
							"></span>
						</td>


					</tr>

%				}

			</tbody>

%			unless ($not_a_total_moron) {

				<tr>

					<td colspan="4" class="italic rightalign semibold orangetext">
						Use this edit button to upload scripts &amp; forms, enter supps, etc.
					</td>

					<td class="centeralign padvertmore">
						<span class="fa fa-arrow-up fa-lg orangetext"></span>
					</td>

					<td>
					</td>

				</tr>
%			}

		</table>

%		if (@rejects) {

			<div class="full nospace martopmuchmore">

				<span class="fourfifths nospace">
					<h5>
						Rejected Entries
					</h5>
				</span>

				<span
					class = "fifth rightalign nospace"
					id    = "rejecteds_buttonarea"
				>
				</span>

			</div>

			<&
				"/funclib/tablesorter.mas",
				table => 'rejecteds'
			&>

			<table id="rejecteds">

				<thead>
					<tr class="yellowrow smallish">
						<th>Competitor</th>
						<th>Entry Names</th>
						<th>Events</th>
						<th>Rejected by</th>
						<th>Rejected at</th>
					</tr>
				</thead>

				<tbody>
<%perl>

					foreach my $student_id (sort {$a <=> $b} @rejects) {

						my $student = $students{$student_id}{"object"};
						foreach my $entry (@{$students{$student_id}{"main"}}) {

							next unless $entry->rejected_by;
</%perl>

							<tr class='smallish'>

								<td class="nospace padleftmore">
									<% $student->first." ".$student->last %>
								</td>

								<td class="nospace">
									<div class="full padleftmore">
										<% $entry->name %>
									</div>
								</td>

								<td class="nospace centeralign">
									<div class="full nospace">
										<% $entry->event->abbr %>
									</div>
								</td>

								<td class="nospace">
									<div class="full padleftmore">
%										my $rejector = Tab::Person->retrieve($entry->rejected_by);
										<% $rejector ? $rejector->first." ".$rejector->last : "" %>
									</div>
								</td>

								<td class="nospace">
<%perl>
									my $date = eval {
										return Tab::shortdate(
											DateTime::Format::MySQL->parse_datetime(
												$entry->rejected_at
											)
										);
									};
</%perl>
									<% $date %>
								</td>

							</tr>
%						}
%					}
				</tbody>
			</table>
%		}

		<br />
		<br />

		<p class='bigger centeralign redtext semibold borderbottom'>
			<span class="third rightalign">
				Entries incomplete on/after
			</span>
			<span class="third centeralign">
				<& "/funclib/showdate.mas", dt => $tourn->reg_end, length => "murica" &>
				at <& "/funclib/showtime.mas", dt => $tourn->reg_end &>
				<% Tab::tzname($tourn->tz) %>
			</span>
			<span class="third leftalign">
				are subject to a late penalty fine
			</span>
		</p>

%		if ($now < $drop_deadline) {
			<p class='bigger centeralign bluetext semibold'>
				<span class="third leftalign">
					Entry drops and name changes open until
				</span>
				<span class="sixth">
					<& "/funclib/showdate.mas", dt => $drop_deadline, length => "murica" &>
				</span>
				<span class="sixth">
					at <& "/funclib/showtime.mas", dt => $drop_deadline &>
				</span>
			</p>
%		}
%		if ($now < $script_deadline) {
			<p class='bigger centeralign bluetext semibold'>
				<span class="third leftalign">
					Script details &amp; entry details enabled until
				</span>
				<span class="sixth">
					<& "/funclib/showdate.mas", dt => $script_deadline, length => "murica" &>
				</span>
				<span class="sixth">
					at <& "/funclib/showtime.mas", dt => $script_deadline &>
				</span>
			</p>
%		}

%		if ($tourn_settings{"nsda_nats"} && ($now < $supp_deadline)) {
			<p class='bigger centeralign bluetext semibold'>
				<span class="third leftalign">
					Supplemental entries due
				</span>
				<span class="sixth">
					<& "/funclib/showdate.mas", dt => $supp_deadline, length => "murica" &>
				</span>
				<span class="sixth">
					at <& "/funclib/showtime.mas", dt => $supp_deadline &>
				</span>
			</p>
%		}
%		if ($now < $release_deadline) {
			<p class='bigger centeralign bluetext semibold'>
				<span class="third leftalign">
					Release forms uploads enabled until
				</span>
				<span class="sixth">
					<& "/funclib/showdate.mas", dt => $release_deadline, length => "murica" &>
				</span>
				<span class="sixth">
					at <& "/funclib/showtime.mas", dt => $release_deadline &>
				</span>
			</p>
%		}

	</div>

