<%args>
	$person
	$school
	$student_id => undef
</%args>
<%init>

	my $now = DateTime->now();

	my $student = Tab::Student->retrieve($student_id) if $student_id;

	unless ($student) { 
		$m->comp('/funclib/abort.mas', 
			message => "No student record found for ID number $student_id"
		);
	}

	unless ($student->chapter->id == $school->chapter->id) {
		$m->comp('/funclib/abort.mas', 
			message => "Student ".$student->first." ".$student->last." does not belong to your school."
		);
	}

	my $tourn = $school->tourn();

	my %entries = $m->comp(
		"/funclib/nationals_entries.mas",
		student => $student,
		tourn => $tourn
	);

	my %events;

	foreach my $event ($tourn->events) {

		if ($event->setting("supp")) { 
			push @{$events{"supp"}}, $event;
		} elsif ($event->setting("conn")) { 
			push @{$events{"conn"}}, $event;
		} elsif ($event->setting("stefan")) { 
			push @{$events{"stefan"}}, $event;
		} else { 
			push @{$events{"main"}}, $event;
		}

	}

	my $counter;

	foreach my $tag ("supp", "conn") { 

		if ($events{$tag}) {

			foreach my $event (@{$events{$tag}}) { 

				my $in = $ARGS{$event->id};

				$counter++ if $in;

				if ($entries{$event->id}) { 

					unless ($in) { 
						$entries{$event->id}->delete();
					}

				} else { 

					if ($in) { 

						my $entry = Tab::Entry->create({
							event      => $event->id,
							school     => $school->id,
							tourn      => $tourn->id,
							name       => $student->first." ".$student->last,
							dropped    => 0,
							created_at => $now,
						});

						$entry->setting("registered_by", $person->id);

						my $es = Tab::EntryStudent->create({
							entry   => $entry->id,
							student => $student->id
						});

					}
				}
			}
		}
	}

	foreach my $tag ("supp", "conn") { 
		foreach my $event (@{$events{$tag}}) { 
			undef $entries{$event->id}; 
		}
	}

	my %used; 

	foreach my $entry (
		$m->comp(
			"/funclib/student_entries.mas", 
			student     => $student,
			tourn       => $tourn,
			entry_check => 1
		)
	) { 

		if ($used{$entry->event->id}++) { 
			$entry->delete();
		}
		
	}

	my $msg = $student->first." ".$student->last." has been pre-registered into $counter supplementals &amp; consolations";

	$m->redirect("details.mhtml?student_id=".$student->id."&school_id=".$school->id."&msg=$msg");

</%init>
