<%args>
	$person
	$school
	$tourn
</%args>
<%init>

	my $tz = $tourn->tz;
	my %tourn_settings = $tourn->all_settings();

	my $now = DateTime->now();
	$now->set_time_zone($tz);

	my @categories = $m->comp(
		"/funclib/school_categories.mas",
		school => $school
	);

	my $judge_deadline = $tourn_settings{"judge_deadline"};
	$judge_deadline->set_time_zone($tz);


	my $main;
	my %main_settings;

</%init>

	<div class="main">

		<& "../tabbar.mas",
			school         => $school,
			tourn          => $tourn,
			tourn_settings => \%tourn_settings,
			whoami         => "judges"
		&>
<%perl>

		foreach my $category (sort {$a->abbr cmp $b->abbr} @categories) {

			next unless $category->setting("nats_category");

			$main = $category;

			my $drop_deadline;

			if ($category->setting("open_switcheroo")
				&& $category->setting("open_switcheroo") < $now
			) {
				$drop_deadline++;
			}


			my ($provided, $burden) = $m->comp(
				"/funclib/judgemath/nats_judging.mas",
				category => $category,
				school   => $school
			);

			my @jpools = $m->comp(
				"/funclib/category_jpools.mas",
				category => $category,
				limit	=> "registrant"
			);

			my %jpool_settings = $m->comp(
				"/funclib/jpool_settings.mas",
				category => $category
			);

			@jpools = sort {
				$jpool_settings{$a}{"hire"} <=> $jpool_settings{$b}{"hire"}
			} @jpools;

			my $last_hirable;

			foreach my $jpool (@jpools) {

				unless ($jpool_settings{$jpool->id}{"hire"}) {
					$last_hirable = $jpool->id;
				}
			}

			my @judges = $m->comp(
				"/funclib/nationals_judges.mas",
				category => $category,
				school   => $school
			);

			my $judge_hire = Tab::JudgeHire->search(
				category => $category->id,
				school   => $school->id
			)->first;

</%perl>

			<div class="martopmore borderbottom padbottom">

				<span class="threefifths nospace">
					<h5 class="nospace">
						Main Tournament
					</h5>
				</span>

				<span class="fifth rightalign semibold bigger">
					Judging Days
				</span>

				<span
					class = "fifth rightalign"
					id	  = "obligation_<% $category->id %>_buttonarea"
				></span>

<%perl>
				if ($provided->{'minimum_unmet'}
					&& (not defined $school->setting("no_judge_warnings"))
				) {
</%perl>
					<div class="full odd marno padless centeralign">
						<p class='redtext semibold bigger'>
							You must bring at least
							<span id="minimum" class="inline"><% $category->setting("minimum_supplied") %></span>
							days of judging.  These days cannot be hired out.
							You are under by <span id="min_provided" class="inline"><% $provided->{"minimum_unmet"} %></span>.
						</p>
					</div>
%				}

				<&
					"/funclib/tablesorter.mas",
					table => "obligation_".$category->id
				&>

				<table id="obligation_<% $category->id %>">

					<thead>

						<tr class="yellowrow smallish">

							<th class="nosort">
							</th>

%							foreach my $jpool (@jpools) {
								<th
									title="<% $jpool_settings{$jpool->id}{"hire"} ? "" : "Not Hirable" %>"
									class="nosort <% $last_hirable == $jpool->id ? "borderright" :"" %>"
								>
									<% $jpool->name %><% $jpool_settings{$jpool->id}{"hire"} ? "" : "*" %>
								</th>
%							}

							<th class="nosort">
								Total
							</th>

						</tr>

					</thead>

					<tbody>

						<tr class="bluetext semibold centeralign even">

							<td class="bluetext semibold">
								Needed
							</td>

%							foreach my $jpool (@jpools) {
								<td
									class="<% $last_hirable == $jpool->id ? "borderright" :"" %>"
								>
									<% $burden->{$jpool->id} %>
								</td>
%							}

							<td id="needed">
								<% $burden->{"total"} %>
							</td>

						</tr>

						<tr class="semibold centeralign even">

							<td class="bluetext semibold">
								Provided
							</td>

%							foreach my $jpool (@jpools) {
								<td
									class="<% $last_hirable == $jpool->id ? "borderright" :"" %>"
								>
									<% $provided->{$jpool->id} %>
								</td>
%							}

							<td id="provided">
								<% $provided->{"total"} %>
							</td>

						</tr>

						<tr class="centeralign even">

							<td class="greentext semibold">
								Hired
							</td>

%							foreach my $jpool (@jpools) {
								<td class="<% $last_hirable == $jpool->id ? "borderright" :"" %>">
								</td>
%							}

							<td
								class = "nospace"
								id    = "hire_total"
							>
								<span
									id    = "hired"
									class = "full greentext semibold replybucket marno"
								>
									<% $judge_hire ? $judge_hire->rounds_accepted() : "" %>
								</span>
							</td>

						</tr>

						<tr class="semibold centeralign even">

							<td class="redtext semibold">
								Still Owed
							</td>
<%perl>
							$provided->{"owed"}{"total"} -= $judge_hire->rounds_accepted()
								if $judge_hire;

							foreach my $jpool (@jpools) {

								$provided->{"owed"}{"total"}
									+= ($burden->{$jpool->id} - $provided->{$jpool->id});

								my $owed = ($burden->{$jpool->id} - $provided->{$jpool->id});
								$owed = 0 if $owed < 0;



</%perl>
								<td class="
									<% $jpool_settings{$jpool->id}{"hire"} ? "" : "nohires"  %>
									<% $last_hirable == $jpool->id ? "borderright" :"" %>">
									<% $owed %>
								</td>
%							}

							<td
								class = "redtext"
								id    = "owed"
							>
								<% $burden->{"total"} - $provided->{"total"} %>
							</td>

						</tr>

					</tbody>

				</table>

%				if ($now < $judge_deadline) {

					<div class="full bordertop odd marno martopmuchmore padless">

						<span class="third centeralign semibold bluetext">
							*No hired judging in: <br />
<%perl>
							my $notfirst;
							foreach my $jpool (@jpools) {
								next if $jpool_settings{$jpool->id}{"hire"};
								$m->print(", ") if $notfirst++;
								$m->print($jpool->name);
							}
</%perl>
						</span>

						<span class="third rightalign semibold">
							<div class="full nospace">
								You can hire up to
								<span class="inline redtext" id="hire"><% $provided->{"hire"}{"total"} %></span>
								days.
							</div>
							<div class="full nospace padtopless">
								Days you wish to hire for:
							</div>
						</span>

						<span class="sixth centeralign">
							<input
								type  = "number"
								name  = "hires"
								id    = "hires"
								min   = 0
								value = "<% $judge_hire ? $judge_hire->rounds_accepted : "" %>"
							>
						</span>

						<span class="sixth centeralign">
							<input
								value   = "Save Hires"
								type	= "submit"
								onClick = "postHires('<% $category->id %>', <% $provided->{'hire'}{'total'} %>);"
							>
						</span>
					</div>

					<div
						class = "martop orangetext explain centeralign biggish"
						style = "line-height: 16px;"
					>
						Please note: judges will be assigned pools for their
						full obligation, even if your school is over quota.  Do
						not register judges for more days than intended to
						facilitate later swaps; you can do so AFTER initial
						pools are set and swaps are enabled.
					</div>

%				}  else {

					<p class="centeralign semibold redtext martopmore">
						The deadline to change judging
						<& "/funclib/showdt.mas", dt => $judge_deadline &> has passed.
					</p>
%				}

				<div class="nospace martopmore">

					<span class="threefifths nospace">
						<h5>
							Main Tournament Judges
						</h5>
					</span>

					<span class="fifth rightalign semibold bigger">
					</span>

					<span
						class = "fifth rightalign"
						id	= "judges_<% $category->id %>_buttonarea"
					>
					</span>

				</div>

			<&
				"/funclib/tablesorter.mas",
				table => "judges_".$category->id
			&>

			<table id="judges_<% $category->id %>">

%				if (@judges) {

				<thead>

					<tr class="yellowrow smallish">

						<th>
							First
						</th>

						<th>
							Last
						</th>

						<th>
							Days
						</th>

						<th>
							Pools
						</th>

						<th>
							Status
						</th>

						<th>
							Edit
						</th>

%						if ($now < $judge_deadline) {
							<th>
								Drop
							</th>
%						}

					</tr>

				</thead>

				<tbody>

%					foreach my $judge (@judges) {

						<tr>

							<td>
								<% $judge->first %>
							</td>

							<td>
								<% $judge->last %>
							</td>

							<td class="centeralign">
								<% $judge->obligation %>
							</td>

							<td>
								<% $judge->setting("tab_room")
									? "<span class='full redtext semibold inline'>TAB ROOM</span>"
									: ""
								%> <% $judge->jpoolnames %>
							</td>

							<td class="centeralign">
								<% $judge->setting("incomplete")
									? '<span class="semibold redtext">INCOMPLETE</span>'
									: '<span class="semibold greentext">OK</span>'
								%>
							</td>

							<td class="centeralign nospace padvert">
								<a
									class="buttonwhite bluetext fa fa-edit fa-sm"
									href="judge_edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
								></a>
							</td>

%							if ($now < $judge_deadline) {
								<td class="centeralign nospace padvert">
%									unless ($drop_deadline) {
									<a
										class="buttonwhite redtext fa fa-trash fa-sm"
										href="judge_drop.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
									></a>
%									}
								</td>
%							}

						</tr>

%					}

					</tbody>

%				}

				<tr class="liblrow">

					<td colspan="42" class="rightalign">

						<span class="true quarter centeralign">
							<a
								href  = "judge_edit.mhtml?category_id=<% $category->id %>&school_id=<% $school->id %>"
								class = "buttonwhite bluetext invert"
							>
								<span class="fa fa-lg fa-plus"></span>
								Add <% $category->abbr %> Judge
							</a>
						</span>

					</td>

				</tr>

			</table>

		</div>

<%perl>

		}

		foreach my $category (sort {$a->abbr cmp $b->abbr} @categories) {

			my %category_settings = $category->all_settings();

			if ($category_settings{"nats_category"}) {
				%main_settings = %category_settings;
				next;
			}

			my ($unc, $over) = $m->comp(
				"/funclib/judgemath/uncovered_burden_by_category.mas",
					school            => $school,
					category_settings => \%category_settings,
					tourn_settings    => \%tourn_settings,
					category          => $category
			);

			my @registered_judges = $m->comp(
				"/funclib/judgemath/judges_by_category.mas",
				school            => $school,
				category_settings => \%category_settings,
				category          => $category,
				tourn_settings    => \%tourn_settings
			);

			my $obligation = $m->comp(
				"/funclib/judgemath/judges_needed_by_category.mas",
					school            => $school,
					category_settings => \%category_settings,
					tourn_settings    => \%tourn_settings,
					category          => $category
			);

</%perl>

			<div class="martopmore">

				<span class="threeeighths nospace">
					<h5 class="nospace">
						<% $category->name %>
					</h5>
				</span>

%				if ($category_settings{"usa_wsdc"}) {
					<span class="half bluetext semibold centeralign">
						World Schools judges are managed by District Chairs
					</span>
%				} else {
					<span class="quarter centeralign semibold nospace">
						<% $obligation %> judges owed
					</span>

					<span class="quarter centeralign semibold nospace">
						<% scalar @registered_judges %> judges provided
					</span>
%				}

				<span
					class = "eighth rightalign nospace"
					id	= "<% $category->id %>_buttonarea"
				>
				</span>


				<&
					"/funclib/tablesorter.mas",
					table => $category->id
				&>

				<table id="<% $category->id %>">

					<thead>

						<tr class="yellowrow smallish">

							<th>
								First
							</th>

							<th>
								Last
							</th>

							<th>
								Notes
							</th>

							<th>
								Status
							</th>

							<th>
								Edit
							</th>

%							unless ($category_settings{"usa_wsdc"}) {
								<th>
									Drop
								</th>
%							}
						</tr>

					</thead>

					<tbody>

%						foreach my $judge (@registered_judges) {

							<tr>

								<td>
									<% $judge->first %>
								</td>

								<td>
									<% $judge->last %>
								</td>

								<td>
									<% $judge->setting("notes") %>
								</td>

								<td class="centeralign">
									<% $judge->active ? "ACTIVE" : "INACTIVE" %>
								</td>

								<td class="centeralign nospace padvert">
									<a
										class="buttonwhite bluetext fa fa-edit fa-sm"
										href="judge_edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
									></a>
								</td>

%								unless ($category_settings{"usa_wsdc"}) {
									<td class="centeralign nospace padvert">
										<a
											class="buttonwhite redtext fa fa-trash fa-sm"
											href="judge_drop.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
										></a>
									</td>
%								}

							</tr>

%						}

					</tbody>

					<tr class="liblrow">

						<td colspan="42" class="rightalign">

							<a
								href="judge_edit.mhtml?category_id=<% $category->id %>&school_id=<% $school->id %>"
								class="buttonwhite bluetext invert"
							>
								<span class="fa fa-lg fa-plus"></span>
								Add <% $category->abbr %> Judge
							</a>

						</td>

					</tr>

				</table>

			</div>

%		}

	</div>


	<div class="menu">

		<div class="sidenote">

			<h4>Judge Categories</h4>
<%perl>

			my $hires;
			my $bad;

			my %reasons = $m->comp(
				"/funclib/judgemath/nats_check_judging.mas",
				school => $school
			);

			foreach my $category (@categories) {

				my $uncovered++ if $reasons{$category->id};
				$bad++ if $reasons{$category->id};

</%perl>

				<div class="<% ($uncovered < 1) ? "blue" : "red" %>text semibold full nowrap marno bordertop borderbottom">

					<span class="quarter nowrap bigger">
						<% $category->abbr %>
					</span>

					<span class="threeeighths nowrap">
						<span class="fifth semibold rightalign marrightmore">
							<% $reasons{"obligation"}{$category->id} || 0 %>
						</span>
						<span class="threequarters">
							owed
						</span>
					</span>

					<span class="threeeighths nowrap">
						<span class="fifth semibold rightalign marrightmore">
							<% $reasons{"provided"}{$category->id} || 0 %>
						</span>
						<span class="threequarters">
							provided
						</span>
					</span>
				</div>
%			}

		</div>

%		if ($bad) {

			<div class="sidenote">
				<h4>Judging Status</h4>

%				foreach my $category (@categories) {

%					next unless $reasons{$category->id};

					<span class="full marno semibold bigger">
						<% $category->abbr %>
					</span>

					<span class="full nospace bordertop biggish semibold redtext">
						<% $reasons{$category->id} %>
					</span>
%				}
			</div>
%		}

<%perl>
		if ($main) {

			if ($main_settings{"open_switcheroo"} < $now
				&& $main_settings{"close_switcheroo"} > $now
			) {
</%perl>
				<div class="sidenote">

					<h4>Judge Assignment Swaps</h4>

					<p>
						You may see your judge assignments and swap
						between judges as needed until
					</p>

					<p class="centeralign marvert semibold redtext">
						<& "/funclib/showdt.mas",
							dt     => $main_settings{"close_switcheroo"},
							tz     => $tz,
							tzname => 1
						&>
					</p>

					<a
						href="judge_swaps.mhtml?school_id=<% $school->id %>&category_id=<% $main->id %>"
						class="full yellow"
					>Swap Judging</a>

				</div>
%			} elsif ($main_settings{"open_switcheroo"} < $now) {
				<div class="sidenote">
					<a
						href="judge_pools.mhtml?school_id=<% $school->id %>&category_id=<% $main->id %>"
						class="full yellow"
					>Judge Pool Assignments</a>
				</div>
%			}
%		}

		</div>

	</div>


	<script>

		function totalOwed () {

			var needed = parseInt($('#needed').text()) || 0;
			var provided = parseInt($('#provided').text()) || 0;
			var hired = parseInt($('#hired').text()) || 0;

	        if (hired < 0) {
                hired = 0;
            }

            var owed = parseInt(needed - provided - hired);
            var amtOwed = 0;

            $(".hirestill").each(function() {
                amtOwed += parseInt($(this).text()) || 0;
            });

            if (owed < amtOwed) {
                owed = amtOwed;
            }

            if (owed < 0) {
                owed = 0;
            }

			$("#owed").text(owed);
		}

		function countHires() {

			var provided = parseInt($('#provided').text()) || 0;

			var maxRounds = parseInt($("#needed").text()) || 0;
			maxRounds -= provided;

			var minimum = parseInt($('#minimum').text()) || 0;
			minimum -= provided;

			if (minimum < 0) {
				minimum = 0;
			}

			$(".nohires").each(function() {
				maxRounds -= parseInt($(this).text()) || 0;
				minimum -= parseInt($(this).text()) || 0;
			});

			if (maxRounds < 0) {
				maxRounds = 0;
			}

			maxRounds -= minimum;
			$("#hire").text(maxRounds);

			return maxRounds;
		}

		$(document).ready(function() {
			countHires();
			totalOwed();
		});

		function postHires(categoryID) {

			var hireNumber = $("#hires").val();
			var maxRounds = countHires();

			if (hireNumber > maxRounds) {
				hireNumber = maxRounds;
				$("#hires").val(hireNumber);

				alertify.notify("You can only hire for "+maxRounds+" days", "warning");
			}

			$.ajax({

				type	: 'POST',
				url	    : "judge_hires.mhtml",
				data	: {
					school_id   : "<% $school->id %>",
					category_id : categoryID,
					hires       : hireNumber,
					max         : maxRounds,
				},

				success : function(data) {

					if (data.reply) {
						$(".replybucket").text(data.reply);
						$(".replyappend").append(data.reply);
						totalOwed();
					}

					if (data.error) {

						alertify.error(data.message);

					} else if (data.message) {

						alertify.notify(data.message, "custom");

					} else {

						console.log(data);
						alertify.warning("An error condition was tripped.");
					}
				}

			});
		}

	</script>

