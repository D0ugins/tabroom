<%args>
	$person
	$school
	$tourn
</%args>
<%init>

	my $tz = $tourn->tz;
	my %tourn_settings = $tourn->all_settings();

	my $now = DateTime->now();

	my @categories = $m->comp(
		"/funclib/school_categories.mas", 
		school => $school
	);


</%init>

	<div class="main">

		<& "../tabbar.mas", 
			school => $school, 
			whoami => "judges"
		&>

<%perl>

		foreach my $category (sort {$a->abbr cmp $b->abbr} @categories) { 

			next unless $category->setting("nats_category");

			my %burden = $m->comp(
				"/funclib/judgemath/nats_burden.mas", 
				category => $category,
				school   => $school
			);

			my %provided = $m->comp(
				"/funclib/judgemath/nats_judging.mas", 
				category => $category,
				school   => $school
			);

			my @jpools = $m->comp(
				"/funclib/category_jpools.mas",
				category => $category,
				limit    => "registrant"
			);

			my %jpool_settings = $m->comp(
				"/funclib/jpool_settings.mas",
				category => $category
			);

			my @judges = $m->comp(
				"/funclib/nationals_judges.mas",
				category => $category,
				school   => $school
			);

			my $judge_hire = Tab::JudgeHire->search(
				category => $category->id,
				school   => $school->id
			)->first;

</%perl>

			<div class="martopmore">

				<span class="threefifths nospace">
					<h5 class="nospace">
						Main Tournament Obligations
					</h5>
				</span>

				<span class="fifth rightalign semibold bigger">
					Rounds Needed
				</span>

				<span 
					class = "fifth rightalign"
					id    = "obligation_<% $category->id %>_buttonarea"
				>
				</span>

				<& 
					"/funclib/tablesorter.mas", 
					table => "obligation_".$category->id
				&>

				<table id="obligation_<% $category->id %>">

					<thead>

						<tr class="yellowrow smallish">

							<th>
							</th>

		
%							foreach my $jpool (@jpools) { 
								<th>
									<% $jpool->name %>
								</th>
%							}

							<th>
								Total
							</th>

						</tr>

					</thead>

					<tbody>

						<tr class="bluetext semibold centeralign even">

							<td class="bluetext semibold">
								Needed
							</td>

%							foreach my $jpool (@jpools) { 
								<td>
									<% $burden{$jpool->id} %>
								</td>
%							}

							<td>
								<% $burden{"total"} %>
							</td>

						</tr>

						<tr class="semibold centeralign even">

							<td class="bluetext semibold">
								Provided
							</td>

%							foreach my $jpool (@jpools) { 
								<td>
									<% $provided{$jpool->id} %>
								</td>
%							}

							<td>
								<% $provided{"total"} %>
							</td>

						</tr>

						<tr class="semibold centeralign even">

							<td class="redtext semibold">
								Hirable
							</td>

%							foreach my $jpool (@jpools) { 
								<td
									<% $provided{"hire"}{$jpool->id} eq "X" 
										? 'class="hover" title="Rounds in this pool cannot be hired"'
										: ""
									%>
								> <% $provided{"hire"}{$jpool->id} eq "X" 
										? "-"
										: $provided{"hire"}{$jpool->id}
									%>
								</td>
%							}

							<td>
								<% $provided{"hire"}{"total"} %>
							</td>

						</tr>

						<tr class="semibold centeralign even">

							<td class="redtext semibold">
								Still Owed
							</td>

<%perl>

							$provided{"owed"}{"total"} -= $judge_hire->rounds_accepted()
								if $judge_hire;

							foreach my $jpool (@jpools) { 

								my $owed = $burden{$jpool->id} - $provided{$jpool->id};

								$provided{"owed"}{"total"} += $owed;

</%perl>
								<td> 
									<% ($burden{$jpool->id} - $provided{$jpool->id}) %>
								</td>
%							}

							<td>
								<% $provided{"owed"}{"total"} %>
							</td>

						</tr>

					</tbody>

				</table>

				<div class="full bordertop odd marno martopmuchmore padless">

					<form 
						action = "hire_rounds.mhtml"
						method = "post"
					>

						<input 
							type = "hidden"
							name = "school_id"
							value= "<% $school->id %>"
						>

						<input 
							type = "hidden"
							name = "category_id"
							value= "<% $category->id %>"
						>

						<span class="threefifths rightalign semibold">
							Rounds you wish to hire for:
						</span>

						<span class="fifth centeralign">
							<input
								type  = "number"
								name  = "hires"
								min   = 0
								max   = "<% $provided{"hire"}{"total"} %>"
								value = "<% $judge_hire ? $judge_hire->rounds_accepted : "" %>"
							>
						</span>

						<span class="fifth centeralign">
							<input 
								type  = "submit"
								value = "Save Hires"
								class = "thin"
							>
						</span>

					</form>

				</div>

				<div class="nospace martopmuchmore">

					<span class="threefifths nospace">
						<h5 class="nospace">
							Main Tournament Judges
						</h5>
					</span>

					<span class="fifth rightalign semibold bigger">
					</span>

					<span 
						class = "fifth rightalign"
						id    = "judges_<% $category->id %>_buttonarea"
					>
					</span>

				</div>

			<& 
				"/funclib/tablesorter.mas", 
				table => "judges_".$category->id
			&>

			<table id="judges_<% $category->id %>">

%				if (@judges) { 

				<thead>

					<tr class="yellowrow smallish">

						<th>
							First
						</th>

						<th>
							Last
						</th>

						<th>
							Rounds
						</th>

						<th>
							Pools
						</th>

						<th>
							Status
						</th>

						<th>
							Edit
						</th>

					</tr>

				</thead>

				<tbody>

%					foreach my $judge (@judges) { 

						<tr>

							<td>
								<% $judge->first %>
							</td>

							<td>
								<% $judge->last %>
							</td>

							<td class="centeralign">
								<% $judge->obligation %>
							</td>

							<td>
								<% $judge->jpoolnames %>
							</td>

							<td class="centeralign">
								<% $judge->setting("incomplete") 
									? '<span class="semibold redtext">INCOMPLETE</span>'
									: '<span class="semibold greentext">OK</span>'
								%>
							</td>

							<td class="centeralign">
								<a 
									class="buttonwhite bluetext fa fa-edit "
									href="judge_edit.mhtml?judge_id=<% $judge->id %>&school_id=<% $school->id %>"
								></a>
							</td>

						</tr>

%					}

					</tbody>

%				}

				<tr class="liblrow">
				
					<td colspan="42" class="rightalign">

						<a 
							href="judge_edit.mhtml?category_id=<% $category->id %>&school_id=<% $school->id %>"
							class="buttonwhite bluetext invert"
						>
							<span class="fa fa-lg fa-plus"></span>
							Add Judge
						</a>

					</td>

				</tr>

			</table>

		</div>

<%perl>

		}

		foreach my $category (sort {$a->abbr cmp $b->abbr} @categories) { 

			my %category_settings = $category->all_settings();

			next if $category_settings{"nats_category"};

			my ($unc, $over) = $m->comp(
				"/funclib/judgemath/uncovered_burden_by_category.mas",
					school            => $school,
					category_settings => \%category_settings,
					tourn_settings    => \%tourn_settings,
					category          => $category
			);

			my @category_judges = $school->judges(category => $category->id);

			my $obligation = $m->comp(
				"/funclib/judgemath/judges_needed_by_category.mas",
					school            => $school,
					category_settings => \%category_settings,
					tourn_settings    => \%tourn_settings,
					category          => $category
			);

</%perl>

			<div class="martopmore">

				<span class="twofifths">
					<h5><% $category->name %></h5>
				</span>

				<span class="fifth centeralign semibold">
					<% $obligation %> judges owed
				</span>

				<span class="fifth centeralign semibold">
					<% scalar @category_judges %> judges provided
				</span>

				<span 
					class = "fifth rightalign"
					id    = "<% $category->id %>_buttonarea"
				>
				</span>

				<& 
					"/funclib/tablesorter.mas", 
					table => $category->id
				&>

				<table id="<% $category->id %>">

					<thead>

						<tr class="yellowrow smallish">

							<th>
								First
							</th>

							<th>
								Last
							</th>

							<th>
								Notes
							</th>

							<th>
								Status
							</th>

						</tr>

					</thead>

					<tbody>

					</tbody>

				</table>

			</div>

%		}

	</div>

