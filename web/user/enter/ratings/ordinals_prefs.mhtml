<%args>
	$school
	$person
	$category_id => undef
	$entry_id    => undef
	$prefs       => undef
</%args>
<%init>

	my $category = Tab::Category->retrieve($category_id) if $category_id;

	my $tourn = $school->tourn;
	my %ratings_by_judge = ();
	my %conflicts_by_id = ();

	my @judges;

	use POSIX;

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;
	$category = $entry->event->category unless $category;

	my %category_settings = $category->all_settings;

	my $rounds_per = $category_settings{"rounds_per"};

	my $no_others++;

	if ($person) { 
		undef $no_others if $person->site_admin;
		foreach my $admin ($school->chapter->admins) { 
			undef $no_others if $admin->id == $person->id;
		}
	}

	my $no_frees = $category_settings{"free_strikes_no_pref"};

	my $now = DateTime->now;
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $strike_end = $category_settings{"strike_end"};
	$strike_end->set_time_zone($tz) if $strike_end;

	my $read_only++ if $strike_end < $now;

	my $strike_start = $category_settings{"strike_start"};
	$strike_start->set_time_zone($tz) if $strike_start;

	$read_only++ if $strike_start > $now;

	undef $read_only if $entry && $entry->setting("open_prefs");

	my $switch;

    my %rating_name = (); 
    foreach my $tier ($category->rating_tiers) { 
        $rating_name{$tier->id} = $tier->name;
    }   

	my $coach_ratings = $category_settings{"coach_ratings"};

    my %coach_rating_by_judge = (); 

    foreach my $rating (
		$m->comp(
			"/funclib/category_ratings.mas", 
			category => $category,
			type     => "coach"
		)
	) { 

		next unless $rating->judge;
		next unless $rating->rating_tier;
        $coach_rating_by_judge{$rating->judge->id} = $rating_name{$rating->rating_tier->id};
    }   

	my $freebieref = $m->comp("/funclib/free_strikes.mas", category => $category);
	my %freebie = %{$freebieref};

	my %neutrals = 
		map {$_->judge->id => 1} 
		$m->comp(
			"/funclib/category_judge_settings.mas", 
			category => $category, 
			tag => "neutral"
		) 
	if $category_settings{"neutrals"};

	my @event_struck_judges = $m->comp(
		"/funclib/event_strike_judges.mas", 
		event => $entry->event
	) if $entry;

	my %event_struck = map {$_->id => 1} @event_struck_judges;

	#this is to show judges who can't hear stuff in open
	Tab::Strike->columns(TEMP => qw/judge_id/);
	Tab::Strike->columns(TEMP => qw/event_name/);
	Tab::Strike->set_sql( strikes => "
		select judge.id as judge_id, event.name as event_name
		from judge, strike, event
		where judge.category = ? 
		and strike.judge=judge.id
		and strike.type='event'
		and event.id=strike.event
	");

	my @strikes = Tab::Strike->search_strikes($category->id);
	my %judge_event_strike;
	foreach my $strike(@strikes) {
		$judge_event_strike{$strike->judge_id} = $strike->event_name;
	}

	my $diverse_total;
	my $diverse_top_half = 0;
	my $diverse_total_ordpct;
	
</%init>

	<div class="main">

%		unless ($prefs) {
			<& 
				"/user/enter/tabbar.mas", 
				school => $school, 
				whoami => "ratings" 
			&>
%		}

%		unless ($entry) { 

			<h3>Judge Ratings in <% $category->name %> </h3>
			<p>Choose an entry at right to continue</p>

%		} else { 

<%perl>
			@judges = Tab::Judge->search( category => $category->id, active => 1 );
			@judges = sort {$a->last cmp $b->last} @judges;
			@judges = sort {$a->school->short_name cmp $b->school->short_name} @judges;

			foreach ( $m->comp( "/funclib/entry_conflicts.mas", entry => $entry) ) { 
				$conflicts_by_id{$_->judge->id} = $_; 
			}

			foreach ( $m->comp( "/funclib/school_conflicts.mas", school => $school ) ) { 
				$conflicts_by_id{$_->judge->id} = $_; 
			}

			my %ordinal_by_judge = ();

			my @ratings = Tab::Rating->search( 
				entry       => $entry->id,
				type        => "entry",
				rating_tier => 0
			);

			foreach my $rating (@ratings) {
				$ratings_by_judge{$rating->judge->id} = $rating;
				$ordinal_by_judge{$rating->judge->id} = $rating->ordinal if $rating;
			}

			@judges = sort { $ordinal_by_judge{$a->id} <=> $ordinal_by_judge{$b->id} } @judges;

</%perl>
		
			<& "/funclib/tablesorter.mas", 
				table => "ordinals", 
				hover => "yes" 
			&>

			<div>
				<span class="twothird nowrap">
					<h4>Rate <% $category->abbr %> Judges for <% $entry->name %></h4>
				</span>

				<span class="third rightalign">

%					unless ($read_only) { 
						<a 
							class="bluetext buttonwhite hover bigger"
							href="ordinals_prefs_sortable.mhtml?entry_id=<% $entry_id %>&school_id=<% $school->id %>#yo">
							Drag & Drop
						</a>
%					}

					<a 
						class = "buttonwhite greentext fa fa-file-excel-o hover"
						href  = "export_prefs.mhtml?entry_id=<% $entry->id %>&school_id=<% $school->id %>&style=ordinals"
					>
					</a>

				</span>

			</div>

%			if ($read_only) { 

				<div class="full nospace">

					<span class="half centeralign">

						<h6>
							Prefs open 
							<% Tab::shortdate($strike_start) %> 
							<% Tab::nicetime($strike_start) %> <% Tab::tzname($tz) %>
						</h6>

					</span>

					<span class="half centeralign">

						<h6>
							Pref deadline: 
							<% Tab::shortdate($strike_start) %> 
							<% Tab::nicetime($strike_start) %> <% Tab::tzname($tz) %>
						</h6>
					</span>

				</div>

%			}

%			if (%freebie) { 
				<p class="explain padless">
					Judges marked in green are free; they do not count against rating quotas.
				</p>
%			}

			<div class="noscroll ltborder">

				<form action="ordinals_prefs_save.mhtml" method="post">

				<input 
					type="hidden" 
					name="entry_id" 
					value="<% $entry->id %>"
				>

				<input 
					type  = "hidden"
					name  = "school_id"
					value = "<% $school->id %>"
				>

				<input 
					type  = "hidden"
					name  = "category_id"
					value = "<% $category->id %>"
				>

				<table class="hoverme" id="ordinals">

					<thead>

					<tr class="yellowrow smallish">

						<th>
							First
						</th>

						<th>
							Last
						</th>

%						if ($category_settings{"show_diversity"}) { 

							<th 
								class = "smallish"
								title = "Diversity enhancing"
							>
								Diversity <br />
								Enhancing
							</th>

%						}

						<th>
							School
						</th>

%						if ($rounds_per) { 
							<th>
								Rounds
							</th>
%						}

%						if ($coach_ratings) { 
							<th class="smaller">
								Exp.
							</th>
%						}

						<th>
							Rating
						</th>

						<th>
							Percentile
						</th>

					</tr>

				</thead>

				<tbody>

%				my $total;

%				foreach my $judge (@judges) { 

<%perl>

					
					next if ($judge->school->id == $school->id) 
					&& (not defined $neutrals{$judge->id});

					next if $event_struck{$judge->id};
					next if $conflicts_by_id{$judge->id};
					next if $no_frees && $freebie{$judge->id};

					my $paradigm = $judge->person->setting("paradigm") if $judge->person;

					$total++;

</%perl>
					<tr class="<% $freebie{$judge->id} ? 'ligrnrow' : $switch++ % 2 ? 'oddhover' : 'evenhover' %>" >

						<td class="last smallish padless">

%							if ($paradigm) { 

								<a 
									class  = "white"
									href   = "/index/paradigm.mhtml?judge_person_id=<% $judge->person->id %>"
									target = "_blank"
								>

%      	                   	} else { 

    	         				<a 
									class    = "white"
									href     = "http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>"
									target   = "_blank"
									tabindex = "-1"
								>

%                  			}   
								<% $judge->first %>
							</a>

						</td> 

						<td class="last smallish padless">

%							if ($paradigm) { 
								<a 
									class = "white"
									href  = "/index/paradigm.mhtml?judge_person_id=<% $judge->person->id %>" target = "_blank">
%      	                  	} else { 
    	                 		<a 
									class    = "white"
									href     = "http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>"
									target   = "_blank"
									tabindex = "-1">
%                          	}   

							<% $judge->last %>

<%perl>
							if ($judge_event_strike{$judge}) { 
								$m->print("(Can't judge ".$judge_event_strike{$judge}.")");
							}

</%perl>

							</a>

						</td>

%						if ($category_settings{"show_diversity"}) { 

							<td class="smaller nowrap centeralign">

<%perl>

							if ( $judge->setting("diverse") ) {

								$m->print("YES");

								$diverse_total++;

								if ( $ratings_by_judge{$judge->id} ) {

									$diverse_total_ordpct += 
										$ratings_by_judge{$judge->id}->percentile ;

									$diverse_top_half ++ 
										if $ordinal_by_judge{$judge->id} 
											<= ( scalar(@judges) / 2) ;
								}
							}
</%perl>

							</td>

%						}
						
						<td class="smaller nowrap">
							<% ($judge->school && $judge->school->id) 
								? $judge->school->short_name." ".$judge->school->chapter->state 
								: "Hire "
							%>
						</td>

%						if ($rounds_per) {
							<td class="smallish padless centeralign">
								<% $judge->obligation + $judge->hired %>
							</td>
%						}

%						if ($coach_ratings) { 
							<td class="smallish padless centeralign">
								<% $coach_rating_by_judge{$judge->id} %>
							</td>
%						}

						<td class="smallish padless centeralign">

							<span style="display: none;">
								<% $ordinal_by_judge{$judge->id} %>
							</span>

%							if ($read_only) { 

								<% $ordinal_by_judge{$judge->id} %>

%							} else {

								<input 
									type  = "number"
									min   = "0"
									max   = "<% 2 * (scalar @judges) %>"
									name  = "rating_<% $judge->id %>"
									size  = "5"
									value = "<% $ordinal_by_judge{$judge->id} %>"
								>
%							} 

						</td>

						<td class="smallish padless centeralign">
							<% $ratings_by_judge{$judge->id} ?  sprintf("%.2f", $ratings_by_judge{$judge->id}->percentile) : "" %>
						</td>

					</tr>

%				}

				</tbody>

			</table>
			</div>

%			unless ($read_only) { 

				<div class="liblrow padmore">

					<label for="fill">
						<span class="centeralign half hover">
							<input type="checkbox" id="fill" name="fill" value="1">
								Fill in gaps
						</span>
					</label>

					<span class="rightalign half">
						<input type="submit" value="Save Ratings">
					</span>

				</div>
%			}

			</form>

%		}

	</div>

    <div class="menu">

%		if ($entry && $read_only < 1) { 

			<div class="sidenote">

				<h4>Dolly the Sheep</h4>

<%perl>

				my $warn = "You are about to WIPE any existing prefs and
				calculate them based on previous rankings.  OK continues and
				Cancel goes back";

</%perl>

				<a 
					class="yellow block" 
					<& "/funclib/confirm.mas", warn => $warn &> 
					href="ordinals_auto_pref.mhtml?school_id=<% $school->id %>&entry_id=<% $entry->id %>"
				>
					Fill in based on our pref sheets
				</a>

				<p>Fill in based on prefs by:</p>

				<div class="row">
%					unless ($read_only) { 
						<form action="ordinals_auto_pref.mhtml" method="post">
						<input type="hidden" name="entry_id" value="<% $entry->id %>">
						<input type="hidden" name="school_id" value="<% $school->id %>">
%					}

					<span class="threequarters centeralign">

					<select name="student_id" class="fixedsmall chosen">
<%perl>
						my @chapters;
						my %used;
						my $school_year = Tab::school_year->year;

						foreach my $student ($entry->students) { 
							push @chapters, $student->chapter;
							next if $used{$student."s"}++;
</%perl>
							<option 
								value="<% $student->id %>"
							><% $student->last.", ".$student->first %></option>
<%perl>
						}

						my %chapter;

						foreach my $chapter (@chapters) { 

							next if $used{$chapter."c"}++;

							foreach my $student ($chapter->students(retired => 0)) { 

								next if $used{$student."s"}++;
								next if $student->grad_year <= ($school_year - 1);
</%perl>
								<option 
									value="<% $student->id %>"
								><% $student->last.", ".$student->first %></option>
%							}
%						}


					</select>

					</span>

					<span class="quarter centeralign">
						<input 
							type  = "submit"
							class = "thin"
							value = "Go"
							style = "padding-left: 2px; padding-right: 2px;"
						>
					</span>
					</form>

				</div>

%				unless ($no_others) { 

					<p>Clone these prefs onto:</p>

					<div class="row">
%						unless ($read_only) { 
							<form action="clone.mhtml" method="post">
							<input type="hidden" name="clone_id" value="<% $entry->id %>">
							<input type="hidden" name="school_id" value="<% $school->id %>">
							<input type="hidden" name="style" value="ordinals">
%						}
					
						<span class="threequarters centeralign">

						<select name="entry_id" class="fixedsmall chosen">


<%perl>
							foreach my $other (
								$m->comp('/funclib/category_entries.mas', 
									category => $category,
									school   => $school
								)
							) { 

								next if $entry->id == $other->id;
								next if $entry->dropped;
</%perl>
								<option value="<% $other->id %>"><% $other->name %></option>
%							}
						</select>

						</span>

						<span class="quarter centeralign">
							<input 
								type  = "submit"
								class = "thin"
								value = "Go"
								style = "padding-left: 2px; padding-right: 2px;"
							>
						</span>
						</form>
					</div>
%				}

			</div>
%		}

		<& menu.mas, 
			person      => $person,
			school      => $school,
			whoami      => "entry_ratings",
			prefs       => $prefs,
			category_id => $category->id,
			entry_id    => $entry_id,
			nodiv       => 1 
		&>

%		if ($entry && $category_settings{"show_diversity"} && $diverse_total > 0) { 

			<div class="sidenote">

				<h4>Ratings of Diverse Judges</h4>

				<div class="lightrow">

					<span class="threequarters">
						Total judges
					</span>
					<span class="quarter">
						<% scalar(@judges) %>
					</span>
				</div>


				<div class="lightrow">
					<span class="threequarters">
						Number of diverse judges
					</span>
					<span class="quarter">
						<% $diverse_total %>
					</span>
				</span>


				<div class="lightrow">
					<span class="threequarters">
						Diverse judges in top half: 
					</span>
					<span class="quarter">
						<% $diverse_top_half %> 
						(<% sprintf("%.1f", ($diverse_top_half/$diverse_total)*100) %>%)
					</span>
				</div>


				<div class="lightrow">
					<span class="threequarters">
						Avg percentile: 
					</span>
					<span class="quarter">
						<% sprintf("%.2f", $diverse_total_ordpct/$diverse_total) %>
					</span>
				</div>
				
			</div>
%		}	

	</div>
