<%args>
	$school
	$category_id => undef 
	$entry_id => undef
	$person
</%args>
<%init>

	my $category = Tab::Category->retrieve($category_id) if $category_id;
	my $tourn = $school->tournament;
	my @judges;
	my %ratings_by_judge = ();
	my %conflicts_by_id = ();

	use POSIX;

	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;
	$category = $entry->event->category unless $category;

	my $now = DateTime->now;
	my $switch;
	my $no_frees = $category->setting("free_strikes_no_pref");
	
	my %total_by_qual = ();

	my $has_max;
	my $has_min;

</%init>

	<h2><% $school->name %> at the <% $tourn->name %></h2>

%	unless ($prefs) {
		<& /user/tourn/entry/menu.mas, school => $school, whoami => "ratings" &>
%	}

	<div class="main" style="width: 615px;">

%		unless ($entry) { 

			<h3>Judge Ratings in <% $category->name %> </h3>
			<p>Choose a competitor to continue</p>

%		} else { 

<%perl>
			my @quals = Tab::Qual->search( 	category => $category->id, type => "mpj" );
			@quals = sort {$a->name cmp $b->name} @quals;

			my %qualname_by_id = ();

			foreach (@quals) { 
				$qualname_by_id{$_->id} = $_->name; 
				$has_max++ if $_->max;
				$has_min++ if $_->min;
			}

			@judges = Tab::Judge->search( category => $category->id, active => 1 );

			@judges = sort {$a->last cmp $b->last} @judges;
			@judges = sort {$a->school->name cmp $b->school->name} @judges;

			my @conflicts = $entry->conflicts;
			foreach (@conflicts) { $conflicts_by_id{$_->judge->id} = $_; }

			my @ratings = Tab::Rating->search( entry => $entry->id, type => "entry");

			foreach my $rating (@ratings) {
				$ratings_by_judge{$rating->judge->id} = $rating->qual->id;
			}

			@judges = sort { $qualname_by_id{$ratings_by_judge{$a}} cmp $qualname_by_id{$ratings_by_judge{$b}} } @judges;


</%perl>

			<h3>Rate <% $category->abbr %> Judges for <% $entry->team_name %></h3>

			<table cellpadding="5" cellspacing="1" width="100%">

				<tr class="liblrow">
					<th>
						Judge
					</th>

					<th>
						School
					</th>

%					if ($category->coach_ratings) { 
	
						<th class="smaller">
							Ex
						</th>

%					}

					<th>
						Your Rating
						<form action="entry_ratings_save.mhtml" method="post">
						<input type="hidden" name="entry_id" value="<% $entry->id %>">
						<input type="hidden" name="school_id" value="<% $entry->school->id %>">
						<input type="hidden" name="category_id" value="<% $category->id %>">
					</th>

				</tr>

%				my $total;
%				my $ratings;

%				foreach my $judge (@judges) { 

%					next if $judge->school->id == $entry->school->id;

%					next if $conflicts_by_id{$judge->id};

%					$total++;

%					if ($ratings && not defined $ratings_by_judge{$judge->id}) { 

						<tr <% ($switch++ % 2) ? "class=\"lirdrow\"" : "class=\"redrow\""%> >	

%					} else { 
	
						<tr <% ($switch++ % 2) ? "class=\"oddhover\"" : "class=\"evenhover\""%> >	

%					} 

						<td class="last">
							<a class="white" style="padding-bottom: 2px; padding-top: 2px;" 
								href="http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>" target="_blank">
								<% $judge->first." ".$judge->last %>
							</a>
						</td> 
						
						<td class="smaller">
							<% ($judge->school && $judge->school->id) ? $judge->school->short_name.", ".$judge->school->chapter->state : "Hire "%>
						</td>

%						if ($category->coach_ratings) { 
							<td class="smaller">
								<% $m->comp('/funclib/judge_rating.mas', judge => $judge, print => 1 %>
							</td>
%						}

						<td>

%							foreach my $qual (@quals) {

%								$ratings++ if $ratings_by_judge{$judge->id};
%								$total_by_qual{$qual->id}++ if ($qual->id == $ratings_by_judge{$judge->id});

								<span style="width: 40px; display: inline-block; border-right: 1px dotted #ccc;">
									<label for="<% $qual->id."_".$judge->id %>">
										<input type="radio" name="<% $judge->id %>" class="<% $qual->id %>"
											<% ($qual->id == $ratings_by_judge{$judge->id}) ? "checked" : "" %> 
											value="<% $qual->id %>" id="<% $qual->id."_".$judge->id %>">

										<% $qual->name %>
									</label>
								</span>
%							}

						</td>

					</tr>

%				}

				<tr class="liblrow">

					<td colspan="4" class="rightalign">
						<input type="submit" value="Save Ratings">
					</td>
				</tr>

			</table>

%		}

	</div>

    <div class="menu" style="width: 185px;">

		<& menu.mas,
			person      => $person,
			school      => $school,
			whoami      => "entry_ratings",
			category_id => $category->id,
			entry_id    => $entry_id
		&>

%		if ($category) { 

<%perl>

	        my @ratable_judges;

    	    foreach my $judge (@judges) {
    	        next if $judge->school->id == $school->id;
    	        next if $conflicts_by_id{$judge->id};
    	        push (@ratable_judges, $judge);
    	    }

			undef($switch);
</%perl>
			<span style="display: inline-block;">
				<h5 style="font-size: 80%; letter-spacing: 0px; padding-right: 20px; padding-top: 5px;">Guide</h5>
			</span>
			<span style="font-style: italic; display: inline-block; font-size: 80%;">
				<% scalar @ratable_judges %> judges (besides yours)
			</span>

			<table cellpadding="2" cellspacing="1" width="100%">

				<tr class="lirdrow">

					<th class="smaller">
					</th>

%					if ($has_max) { 
						<th class="smallctr">
							Maximum
						</th>
%					}

%					if ($has_min) { 
						<th class="smallctr">
							Minimum
						</th>
%					}

					<th class="smallctr">
						Yours
					</th>

				</tr>

%				foreach my $qual (sort {$a->name cmp $b->name} Tab::Qual->search( category => $category->id, type => "mpj")) {

					<tr <% ($switch++% 2) ? "class=\"oddrow\"" : "class=\"evenrow\"" %>>	


						<th class="smallctr">
							<% ($qual->strike) ? "Strike" : $qual->name %>
						</td>

%						if ($qual->max) { 
							<td class="smaller" align="center">
								<% ($qual->max > 0 ) ? ceil( $qual->max * scalar @ratable_judges / 100) : "" %>
							</td>
%						}

%						if ($qual->min) { 
							<td class="smaller" align="center">
								<% ($qual->min > 0 ) ? ceil( $qual->min * scalar @ratable_judges / 100) : "" %>
							</td>
%						}

						<td class="smaller" align="center">
							<% $total_by_qual{$qual->id} %>
						</td>
						

					</tr>

%				}

				<tr class="liblrow">
					<td colspan="4" class="rightalign">
						<input name="only" class="skinny" type="submit" value="Save Ratings & Update Totals">
						</form>
					</td>
				</tr>

			</table>

%			if ($category->cumulate_mjp) { 

				<p class="explain" style="line-height: 13px; padding: 0px; padding-left: 5px;">
					If you rate extra judges in a category, that requires you
					to rate fewer judges in lower rating categories
				</p>

%			}

%			if ($entry && scalar $school->entries( event => $entry->event->id ) > 1) {

				<h4></h4>

				<table>
					<tr class="even">
						<td>
							<form action="clone.mhtml" method="post">

							<input 
								type  = "hidden"
								name  = "source_id"
								value = "<% $entry->id %>"
							>

							<input 
								type    = "hidden"
								name    = "school_id"
								value   = "<% $entry->school->id %>"
							>

							<input 
								type  = "hidden"
								name  = "style"
								value = "tiers"
							>

							<select name="target_id">
								<option value="all">All Entries in <% $entry->event->abbr %></option>
<%perl>
								foreach my $other (
									$entry->school->entries( 
										event  => $entry->event->id,
										active => 1
									)
								) { 
									next if $entry->id == $other->id;
</%perl>
									<option value="<% $other->id %>"><% $other->team_name %></option>
%								}
							</select>
						</td>

						<td class="rightalign">
							<input type="submit" class="skinny" value="  Clone ">
							</form>
						</td>
					</tr>

				</table>

%			}


			<br />

%		}

	</div>
