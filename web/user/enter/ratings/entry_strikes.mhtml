<%args>
	$school
	$person
	$entry_id    => undef
	$category_id => undef
</%args>
<%init>

	my $category = Tab::Category->retrieve($category_id) if $category_id;
	my $entry = Tab::Entry->retrieve($entry_id) if $entry_id;
	my $tourn = $school->tourn;

	use POSIX;
	my $now = DateTime->now;
	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;

	my $strike_end = $category->setting("strike_end");
	$strike_end->set_time_zone($tz) if $strike_end;
	my $read_only++ if $strike_end < $now;

	my $strike_start = $category->setting("strike_start");
	$strike_start->set_time_zone($tz) if $strike_start;
	$read_only++ if $strike_start > $now;

	undef $read_only if $entry && $entry->setting("open_prefs");

	my %freebie = $m->comp("/funclib/free_strikes.mas", category => $category);

    my %rating_name = (); 
    foreach my $tier ($category->rating_tiers) { 
        $rating_name{$tier->id} = $tier->name;
    }   

	my @shifts = $category->shifts; 

	my $coach_ratings = $category->setting("coach_ratings");
    my %rating_by_judge = (); 

	if ($coach_ratings)  {
		foreach my $rating (
			$m->comp(
				"/funclib/category_ratings.mas", 
				category => $category,
				type     => "coach"
			)
		) { 
			$rating_by_judge{$rating->judge->id} = $rating_name{$rating->rating_tier->id} 
				if $rating->judge && $rating->rating_tier;
		}   
	}   

	my @judges = $m->comp("judges.mas", category => $category);

	my %conflicts_by_id = ();

	my @entry_conflicts = $m->comp(
		"/funclib/entry_conflicts.mas", 
			entry     => $entry,
			category  => $category,
			conflicts => 'only'
	) if $entry;

	my @school_conflicts = $m->comp(
		"/funclib/school_conflicts.mas", 
			school    => $school,
			category  => $category,
			conflicts => 'only'
	) if $entry;

	foreach (@entry_conflicts, @school_conflicts) { 
		$conflicts_by_id{$_->judge->id} = $_; 
	}

	my @entry_strikes = $m->comp(
		"/funclib/entry_strikes.mas", 
			entry    => $entry,
			category => $category
	) if $entry;

	my %strikes_by_id = map {$_->judge->id => $_} @entry_strikes;

    my @school_strikes = $m->comp(
		"/funclib/school_strikes.mas", 
			school => $school, 
			category => $category 
		);

	my %school_strikes_by_id = map {$_->judge->id => $_} @school_strikes;

	@judges = sort { $school_strikes_by_id{$b->id} <=> $school_strikes_by_id{$a->id} } @judges;
	@judges = sort { $strikes_by_id{$b->id} <=> $strikes_by_id{$a->id} } @judges;

	my @event_struck_judges = $m->comp(
		"/funclib/event_strike_judges.mas", 
		event => $entry->event
	) if $entry;

	my %event_struck = map {$_->id => 1} @event_struck_judges;

	my %paradigms = $m->comp("/funclib/judge_paradigms.mas", tourn => $tourn);

</%init>

	<script>
		function strikeCount() { 
			$(".strikebox").parent().removeClass('hidden');
			var limit = <% $category->setting("entry_strikes") %>;
			var counter = $(".strikebox:checked").not(".free").length;
			if (counter >= limit) {
				$(".strikebox").not('free').not(":checked").parent().addClass('hidden');
				$(".free").parent().removeClass('hidden');
			}
		}

		$(document).ready(function() {
			strikeCount();
		});

	</script>

	<& /funclib/tablesorter.mas, 
		table     => "strikes",
		nobuttons => 1
	&>

    <div class="menu">
		<& menu.mas, 
			person   => $person,
			school   => $school,
			whoami   => "entry_strikes",
			nodiv    => 1,
			category_id => $category->id,
			entry_id => $entry_id
		&>
	</div>

	<div class="main">

		<& ../tabbar.mas, 
			school => $school,
			whoami => "ratings"
		&>

%		unless ($entry) { 

			<h5>Choose an entry at right to enter strikes for</h5>

%		} else { 

		<span class="twothird nospace">
			<h4>Strikes for <% $entry->name %></h4>
		</span>

		<span class="third rightalign nospace">
			<h6>Limit: <% $category->setting("entry_strikes") %></h6>
		</span>

%		if ($read_only) { 
			<p class="redtext semibold centeralign biggish">
				Pref deadline was <% Tab::nicedt($strike_end) %> <% Tab::tzname($tz) %>  
			</p>
%		} else { 
			<p class="bluetext semibold centeralign biggish">
				Pref deadline is <% Tab::nicedt($strike_end) %> <% Tab::tzname($tz) %>  
			</p>

%			if (%freebie) { 
				<p class="semibold centeralign greentext biggish">
					Judges highlighted in green are free strikes
				</p>
%			}
%		}

		<table id="strikes">

			<thead>

				<tr class="yellowrow">

					<th>
						Judge
					</th>
	
					<th>
						School
					</th>

%					if ($coach_ratings) { 
						<th>
							Exp
						</th>
%					}

%					if (@shifts) {
						<th>
							Constraints 
						</th>
%					}

					<th>
						Strike
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
				foreach my $judge (@judges) {

					next if $event_struck{$judge->id};
					next if $judge->school && $judge->school->id == $school->id;

					my $paradigm = $paradigms{$judge->id}{"paradigm"};
</%perl>

					<tr <% $freebie{$judge->id} ? 'class="ligrnrow"' : "" %>>

						<td class="smallish">

							<span class="hidden"><% $judge->last %></span>

%							if ($paradigm) {
								<a 
									class  = "white bluetext padvert marno"
									target = "_blank"
									href="/index/paradigm.mhtml?judge_person_id=<% $judge->person->id %>" 
								>
%							} else { 
								<a class="white redtext" >
%							} 
								<% $judge->first." ".$judge->last %>
							</a>
						</td>
				
						<td class="smallish">
							<% ($judge->school->id) ? $judge->school->short_name." ".$judge->school->chapter->state : "Hire" %>
						</td>

%						if ($coach_ratings) { 
							<td class="smallish centeralign">
								<% $rating_by_judge{$judge->id} %>
							</td>
%						}
				
%						if (@shifts) {
							<td class="smallish">
%								foreach my $shift (@shifts) { 
									<div>
										<% ($shift->strike($judge)) ? "No rounds ".$shift->name : "" %>
									</div>
%								}
							</td>
%						}

						<td class="centeralign padless">

%							if ($conflicts_by_id{$judge->id}) { 
								<a class="orangetext semibold">Conflict</a>
%							} elsif ($school_strikes_by_id{$judge->id}) { 
								<a class="orangetext semibold">School Strike</a>
%							} elsif ($read_only) { 
								<span class="semibold <% $strikes_by_id{$judge->id} ? "invert redtext" : "bluetext" %>">
									<% ($strikes_by_id{$judge->id}) ? "Struck" : "Not Struck" %>
								</span>
%							} else { 

								<label class="switch">
									<input 
										type          = "checkbox"
										class         = "strikebox <% $freebie{$judge->id} ? "free" : "" %>"
										value         = "1"
										id            = "<% $judge->id %>_strike"
										property_name = "<% $entry_id %>"
										setting_name  = "entry"
										target_type   = "judge"
										target_id     = "<% $judge->id %>"
										onChange      = "postSwitch( this, 'strike_switch.mhtml'); 
														 strikeCount();"
										<% $strikes_by_id{$judge->id} ? 'checked="checked"' : "" %>
									>
									<div class="slider onred offgreen"></div>
								</label>
%							}
						</td>
					</tr>	
%				}	
			</tbody>
		</table>
%		}
	</div>
