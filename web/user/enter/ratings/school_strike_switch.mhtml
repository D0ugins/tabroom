<%args>
	$school_id
	$judge_id
	$category_id
	$person
</%args>
<%perl>

	my $school = Tab::School->retrieve($school_id);
	my $judge = Tab::Judge->retrieve($judge_id);

	my $category = Tab::Category->retrieve($category_id);

    # Get the list of existing strikes.
    my @strikes = $m->comp("/funclib/school_strikes.mas", school => $school, category => $category);
    my %strikes_by_id = ();

    my $freebieref = $m->comp("/funclib/free_strikes.mas", category => $category); 
    my %freebie = %{$freebieref}; 

	my $bank = $category->setting("school_strikes");

    foreach (@strikes) { 
		$strikes_by_id{$_->judge->id} = $_; 
		$bank-- unless $freebie{$_->judge->id};
	}
	
	if ($strikes_by_id{$judge_id}) {

		$strikes_by_id{$judge_id}->delete;
		my $msg = "You have un-struck ".$judge->first." ".$judge->last;
		$m->redirect("school_strikes.mhtml?school_id=".$school->id."&category_id=".$category->id."&msg=$msg");

	} elsif ($bank || $freebie{$judge_id}) { 

		my $strike = Tab::Strike->create({
			tourn => $category->tourn->id,
			school => $school->id,
			type => "school",
			registrant => 1,
			judge => $judge_id
		});

		my $msg = "You have struck ".$judge->first." ".$judge->last;
		$m->redirect("school_strikes.mhtml?school_id=".$school->id."&category_id=".$category->id."&msg=$msg");
	
	} else { 

		my $msg = "You already have reached your strike limit.  Unstrike a judge if you hate that judge sufficiently to strike them";
		$m->redirect("school_strikes.mhtml?school_id=".$school->id."&category_id=".$category->id."&msg=$msg");

	}
	
</%perl>

