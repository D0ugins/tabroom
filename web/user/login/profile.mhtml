<%args>
	$person
	$person_settings
	$session
	$defaults
	$first   => undef
</%args>
<%init>

	unless ($person) {
		$m->redirect("/index/index.mhtml?err=Your account does not appear to exist. Please log in");
	}

	my $token = $m->comp("/funclib/generate_randomstring.mas", length => 64);
	$defaults->{"token"} = $token;
	$session->default($defaults);

</%init>

	<div class="main">

		<h2>Your Tabroom.com Profile</h2>

		<form
			action = "profile_save.mhtml"
			method = "post"
		>

		<input
			type = "hidden"
			name = "token"
			value = "<% $token %>"
		>

		<span class="pagehalf">

%		if ($person_settings->{'scream_in_pain'}) {

			<div class="row fixedheight">
				<span class="twofifths">
					Please stop screaming
				</span>

				<span class="rightalign nospace">
					<label for="stop_screaming">
						<span class="hover padrightmore">
							<input
								type  = "checkbox"
								name  = "please_stop_screaming"
								value = 1
								id    = "stop_screaming"
								<% $person_settings->{"please_stop_screaming"} ? 'checked="true"' : "" %>
							>
						</span>
					</label>
				</span>
			</div>
%		}

		<div class="row fixedheight">
			<span class="twofifths">
				Email/Username
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "email"
					value = "<% $person->email %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				First Name
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "first"
					value = "<% $person->first %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				Middle Name
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "middle"
					value = "<% $person->middle %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				Last Name
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "last"
					value = "<% $person->last %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				Phone Number
			</span>

			<span class="threefifths rightalign">
				<input
					type  = "tel"
					name  = "phone"
					value = "<% Tab::phone($person->phone) %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				Cell provider *
			</span>

			<span class="threefifths rightalign">
				<select
					name  = "provider"
					class = "fixedmed"
				>
					<& "/funclib/cell_domains.mas",
						provider => $person->provider
					&>
				</select>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				Pronouns &dagger;
			</span>

			<span class="threefifths rightalign">
				<input
					type  = "text"
					name  = "pronoun"
					value = "<% $person ? $person->pronoun : "" %>"
					size  = "24"
				>
			</span>
		</div>
	</span>

	<span class="pagehalf">

		<div class="row fixedheight fixedheight">
			<span class="twofifths">
				Time Zone
			</span>

			<span class="threefifths rightalign">
				<select
					name="timezone"
					class="fixedmed">
					<& /funclib/timezones.mas, tz => $person->tz &>
				</select>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				Street Address
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "street"
					value = "<% $person->street %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				City
			</span>

			<span class="threefifths rightalign" >
				<input
					type  = "text"
					name  = "city"
					value = "<% $person->city %>"
					size  = "24"
				>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				State
			</span>

			<span class="threefifths rightalign">
				<select
					name="state"
					class="fixedmed"
				>
					<&
						"/funclib/state_select.mas",
						state => $person->state
					&>
				</select>
			</span>
		</div>

		<div class="row fixedheight">
			<span class="twofifths">
				Country
			</span>

			<span class="threefifths rightalign">
				<select
					name  = "country"
					class = "fixedmed"
				>
					<& "/funclib/country_select.mas",
						country => $person->country
					&>
				</select>
			</span>
		</div>

%		if ($person->country eq "US") {

			<div class="row fixedheight">
				<span class="twofifths">
					ZIP code
				</span>

				<span class="threefifths rightalign" >
					<input
						type  = "text"
						name  = "zip"
						value = "<% sprintf("%05d", $person->zip) %>"
						size  = "8"
					>
				</span>
			</div>

%		} else {

			<div class="row fixedheight">
				<span class="twofifths">
					Postal code
				</span>

				<span class="threefifths rightalign" >
					<input
						type  = "text"
						name  = "postal"
						value = "<% $person->postal %>"
						size  = "16"
					>
				</span>
			</div>
%		}

%			my $warn = "Fair warning: Checking this option prevents you from getting ANY emails, text blasts, or tournament notices!";

			<label for="shaddap">
				<div class="row fixedheight hover">
					<span class="threequarters padsetting">
						Send No Emails or Texts **
					</span>

					<span class="quarter centeralign">
						<input
							type     = "checkbox"
							id       = "shaddap"
							value    = "1"
							name     = "no_email"
							onChange = "warnEmail()"
							<% ($person->no_email) ? "checked" : "" %>
						>
					</span>

				</div>
			</label>

			<script>
				function warnEmail() {
					if ($("#shaddap").prop("checked")) {
						alertify.alert('Please confirm', '<% $warn %>');
					}
				}
			</script>
		</span>

		<div class="libl pagefull rightalign">
			<span class="third centeralign">
				<input
					type  = "submit"
					value = "<%($person) ? 'Save Changes' : 'Create Account' %>"
				>
			</span>
		</div>
		</form>

%		my @logins= $person->logins;

		<div class="full martopmore nospace">
			<span class="third nospace">
				<h5>Change Your Password</h5>
			</span>

			<span class="twothirds rightalign italic orangetext nospace semibold">
				Last changed <& "/funclib/showdt.mas",
					dt     => $person_settings->{"pass_timestamp"},
					tz     => $person->tz,
					length => "long"
				&>
			</span>
		</div>

		<form
			action = "passwd.mhtml"
			method = "post"
		>

			<input
				type  = "hidden"
				name  = "person_id"
				value = "<% $person->id %>"
			>

			<input
				type  = "hidden"
				name  = "token"
				value = "<% $token %>"
			>

			<div class="row fixedheight marno">
				<span class="quarter rightalign semibold bluetext">
					Current Password
				</span>

				<span class="half">
					<input
						type        = "password"
						name        = "oldpass"
						size   		= "32"
					>
				</span>
			</div>

			<div class="row fixedheight marno">
				<span class="quarter rightalign semibold bluetext">
					New Password
				</span>

				<span class="third">
					<input
						type        = "password"
						name        = "newpass"
						id          = "newpass"
						size        = "32"
						onKeyUp     = "checkStrength();"
					>
				</span>

				<span class="fourtenths nospace">
					<span class="quarter smallish italic">
						Strength
					</span>
					<span class="twothirds nospace">
						<meter
							id      = "passwordStrength"
							value   = "00"
							max     = "100"
							low     = "15"
							high    = "35"
							optimum = "60"
							style   = "width: 98%;"
						></meter>
					</span>
				</span>
			</div>

			<div class="row fixedheight marno">
				<span class="quarter rightalign semibold bluetext">
					Repeat New Password
				</span>

				<span class="half">
					<input
						type        = "password"
						name        = "repeatpass"
						size        = "32"
					>
				</span>
			</div>

			<div class="libl rightalign">
				<span class="third centeralign">
					<input
						type  = "submit"
						value = "Change Password"
					>
				</span>
			</div>
		</form>

		<h5>Account Data</h5>

		<div class="odd martop bluebordertop">
			<span class="twothirds padvert">
				You have logged into Tabroom
			</span>
			<span class="third semibold bluetext">
				<% $person_settings->{"accesses"} %> times
			</span>
		</div>

		<div class="odd">
			<span class="twothirds padvert">
				Your last successful login was on
			</span>
			<span class="third semibold bluetext">
				<& "/funclib/showdt.mas",
					dt => $person_settings->{"last_access"},
					tz => $person->tz,
					length => "murica",
					at => 1
				&>
			</span>
		</div>

%		if ($person_settings->{"last_attempt"}) {
			<div class="odd">
				<span class="twothirds padvert">
					Your last unsuccessful login was on
				</span>
				<span class="third semibold bluetext">
					<& "/funclib/showdt.mas",
						dt => $person_settings->{"last_attempt"},
						tz => $person->tz,
						length => "murica",
						at => 1
					&>
				</span>
			</div>

			<div class="odd">
				<span class="twothirds padvert">
					That attempt IP address was
				</span>
				<span class="third semibold bluetext">
					<% $person_settings->{"last_attempt_ip"} %>
				</span>
			</div>
%		}

<%perl>

		if ($person->nsda) {

		    my ($person_ref, $flubber) = $m->comp(
				"/funclib/nsda/api_client.mas",
				path => "/members/".$person->nsda
			) if $person->nsda;

			if ($person_ref) {
</%perl>
				<div class="odd">
					<span class="twothirds padvert">
						Your Tabroom profile is linked to NSDA Member
					</span>

					<span class="third greentext semibold">
						#<% $person_ref->{person_id} %>
						(<% $person_ref->{first}." ".$person_ref->{middle}." ".$person_ref->{last} %>)
					</span>
				</div>

				<div class="odd blueborderbottom">
					<span class="twothirds padvert">
						Your NSDA Merit Point total is
					</span>

					<span class="third greentext semibold">
						<& "/funclib/commify.mas", number => $person_ref->{points} &>
					</span>
				</div>
%			}
%		}


		<div class="explain padtopmore biggish">
			<p>
				<span class="semibold redtext inline">*CELL PROVIDER:</span>
				Tabroom needs to know this in order to send you text message
				alerts of assignments &amp; results. If you set it to the wrong
				provider you won't get text blasts. Set to "Landline/Do Not Text Me"
				if you only want email alerts.  Note that some tournaments may
				require you have a phone number listed to register as a judge.
			</p>


			<p class="padtop">
				<span class="semibold redtext inline">&dagger;PRONOUNS:</span>
				These pronouns will be sent to judges and competitors in your
				section/debate via text message and emails as part of
				assignment blasts. Pronouns also will appear on judges' online
				or printed ballots. They will NOT appear on the public
				Tabroom.com website either to tournament/tab staff or on the
				public schematics/pairings/entry lists.
			</p>

			<p>
				Please leave blank if you do not consent to these pronouns
				being disclosed to the competitors and judges in the rounds you
				are competing or judging in, or anyone who might be subscribed
				to their text/email notifications.
			</p>

			<p class="padtop">
				<span class="semibold redtext inline">**NO EMAILS:</span>
				This setting will prevent you from getting ANY tournament and
				circuit announcement emails. If you're not active anymore,
				that's fine, but otherwise you'll almost certainly miss
				something important by checking this box.
			</p>

			<p>
				If another coach has taken over your program, you should
				go to your home screen, add them to the chapter's
				access tab, and remove yourself.
			</p>

		</div>
	</div>

	<div class="menu">

%		if ($person_settings->{"api_key"}) {

			<div class="sidenote">

				<h4>API Key</h4>

				<div class="row fixedheight">
					<span class="third semibold">
						<span class="halfspacer"></span>
						Account ID
					</span>

					<span class="twothirds padvertless">
						<% $person->id %>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third semibold">
						<span class="halfspacer"></span>
						API Key
					</span>

					<span class="twothirds padvertless">
						<% $person_settings->{"api_key"} %>
					</span>
				</div>
			</div>
%		}

		<div class="sidenote">

			<h4>External Login Sync</h5>

			<p>
				Tabroom accounts are also used to Classrooms.cloud
				and the casewiki. If your password stops working on
				either service, but still works on Tabroom, resync it
			</p>

			<div class="libl rightalign">
				<span class="third centeralign">
					<button
						class     = "full buttonwhite bluetext invert"
						onClick   = "postSwitch(this, 'ldap_sync.mhtml');"
						target_id = "<% $person->id %>"
					>Resync</button>
				</span>
			</div>
		</div>

		<div class="sidenote">
			<h6 class="semibold redtext">
				Don't Share Passwords
			</h6>

			<p class="padleft biggish explain">
				Your password controls access to your records school, &amp;
				tournaments. If someone uses your account to pull shenanigans,
				you could be on the hook. So, every individual should use their
				OWN tabroom.com account. Grant others access to your chapter or
				tournament instead of sharing passwords.
			</p>

			<h6 class="semibold redtext">
				Privacy
			</h6>

			<p class="padleft biggish explain">
				Tabroom.com is a website created &amp; run for the benefit of
				the forensics community by the

				<a 	class="inline hover bluetext"
					href="http://www.speechanddebate.org"
				>National Speech and Debate Association.</a>

				Circuit officials and tournament directors will be able to see
				registering coaches' &amp; judges' contact info, &mdash; but
				cannot see competitor contact info directly. Tabroom staff and
				NSDA officials can see any contact information to operate the
				site. But we will never sell or give away your contact
				information to anyone else without your consent.
			</p>

			<h6 class="semibold redtext">
				Account Deletion
			</h6>

			<div class='full martopmore centeralign'>
				<a
					class="buttonwhite redtext invert bigger semibold"
					href="user_remove.mhtml"
				>Delete your Tabroom account</a>

			</div>
		</div>

		<script
			type = "text/javascript"
			src  = "/lib/javascript/sources/jquery.complexify.js"
		></script>
		<script
			type = "text/javascript"
			src  = "/lib/javascript/sources/jquery.complexify.banlist.js"
		></script>

		<script type="text/javascript">
			function checkStrength() {
				$("#newpass").complexify({}, function (valid, complexity) {
					$("#passwordStrength").val(complexity);
				});
			}
		</script>

	</div>
