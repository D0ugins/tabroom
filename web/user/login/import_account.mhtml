<%args>
	$username
	$password
</%args>
<%init>

	use Tab::NSDA::Login;
	use Tab::NSDA::Person;
	use Tab::NSDA::PersonSchool;
	use Tab::NSDA::MemberSchool;

	use Digest::MD5 qw(md5_hex);

	my $now = DateTime->now;

	chomp $username;
	chomp $password; 

	# STEP ONE:  Find the user's login 

	my $nsda_login = Tab::NSDA::Login->search( username => $username )->first;

	my @nsda_persons; 

	if ($nsda_login) { 

		push @nsda_persons, Tab::NSDA::Person->search( 
			user_id => $nsda_login->person_id,
			utype   => "Coach" 
		);

		push @nsda_persons, Tab::NSDA::Person->search( 
			user_id => $nsda_login->person_id,
			utype   => "PKDCoach"
		);

	} else { 

		push @nsda_persons, Tab::NSDA::Person->search( 
			uemail => $username,
			utype  => "Coach" 
		);

		push @nsda_persons, Tab::NSDA::Person->search( 
			uemail => $username,
			utype  => "PKDCoach" 
		);

	}

	unless (@nsda_persons) { 

		$err .= " No NSDA or PKD coach records found with username $username .";
		$err .= " Be sure to use your email address or username on record with ";
		$err .= " the NSDA/PKD Points system";

		$m->redirect("/user/login/new_user.mhtml?err=$err");
	}

	my $email;
	my $success; 
	my $err; 
	my @nsda_logins;

	foreach my $nsda_person (@nsda_persons) { 

		push @nsda_logins, Tab::NSDA::Login->search( 
			person_id => $nsda_person->user_id 
		);

	}

	LOGIN:
	foreach my $trial_nsda_login (@nsda_logins) { 

		my $nsda_hash = md5_hex($password.$username.$Tab::points_salt);

		$success++ if $nsda_hash eq $nsda_login->password; 

		if ($success) { 

			$nsda_login = $trial_nsda_login;

			my $nsda_login_person = Tab::NSDA::Person->retrieve($

			last LOGIN;
		}
	}

	unless ($success && $nsda_login) { 

		$err .= " Your NSDA or PKD login was not successful.  Make sure you're ";
		$err .= " using the correct password and try again. ";

		$m->redirect("/user/login/new_user.mhtml?err=$err");

	}

	my @nsda_schools; 

	foreach my $nsda_person (@nsda_persons) { 

		Tab::NSDA::PersonSchool->set_sql( my_schools => "
			select distinct person_school
			from NEW_USERS_TO_SCHOOLS person_school
			where person_school.ualt_id = ? 
			and person_school.hasaccess = 1
			and person_school.isadmin = 1
			and (
				person_school.enddate != "0000-00-00 00:00:00" 
				or and person_school.enddate > ?
			)
		");

		my @person_schools = Tab::NSDA::PersonSchool->search_my_schools( 
								$nsda_person->ualt_id, 
								DateTime::Format::MySQL->format_datetime($now)
						); 

		foreach my $person_school (@person_schools) { 

			push @nsda_schools, Tab::NSDA::School->retrieve($person_school->school_id);

		}
								
	}

	unless (@nsda_schools) { 

		$err .= " I found your NSDA or PKD account, but found no institutions you ";
		$err .= " have admin access to.  Please have the coach of record create your";
		$err .= " account";

		$m->redirect("/user/login/new_user.mhtml?err=$err");

	}

	# STEP TWO: CREATE SCHOOLS, ADMINS and STUDENTS unless they already exist

	foreach my $nsda_school (@nsda_schools) { 

		$m->print("<div class='blankfull'>");

		# Create my login 

		# Search for already existing ones

		my @already_logins; 

		push @already_logins, Tab::Login->search( username => $nsda_login->username )->first;
		push @already_logins, Tab::Login->search( username => $username )->first;

		my @already_people; 

		if (@already_logins) { 

			$m->print("<h5>Found the following existing logins</h5>");

			my %used = ();

			foreach my $already (@already_people) { 
				next if $used{$already}++;
				$m->print('<p class="padleft">'.$already->id." ".$already->email."</p>");
			}
		}

		push @already_people, Tab::Person->search( email => $username )->first;

		if (@already_people) { 

			$m->print("<h5>Found the following existing people</h5>");

			my %used = ();

			foreach my $already (@already_people) { 
				next if $used{$already}++;
				$m->print("<p>".$already->id." ".$already->username."</p>");
			}

		}

		# Create the chapter

		my @already_chapters; 

		foreach my $nsda_chapter (@person_schools) { 

			push @already_chapters, Tab::Chapter->search(nsda => $nsda_chapter->school_id ); 

		}

		# my $chapter = Tab::Chapter->search( nsda => $nsda_school->school_id ); 

		if (@already_chapters) { 

			$m->print("<h5>Found the following existing chapters</h5>");

			my %used = ();

			foreach my $already (@already_chapters) { 

				next if $used{$already}++;
				$m->print("<p>".$already->id." ".$already->name."</p>");

			}

		}

		# Create all the admins

		# Create the students

	}

</%init>
