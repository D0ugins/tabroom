<%perl>

	use Data::Dumper;

	my %cookies = eval { 
		return Apache2::Cookie->fetch($r);
	};

	Tab::debuglog("Cookies are");
	Tab::debuglog(Dumper(\%cookies));

    if ( defined eval{$cookies{'TabroomToken'}->value} ) { 

		my $user_key = $cookies{'TabroomToken'}->value;

		# Authentication key must correspond to a session in the database
		my $session = Tab::Session->search( 
			userkey => $user_key 
		)->first;

		my $check_key = crypt($session->id.$Tab::string, $user_key) if $session;

		if ($session) { 

			# Userid must correspond to a user in the database
			my $person = $session->person;

			unless ($person && $person->email && ($check_key eq $user_key) ) { 
				$session->delete;
				my $err = "Your current session has expired or is somehow invalid.  Please log in again";
				$m->redirect("/index/index.mhtml?err=$err");
			} else { 
				return ($person, $session);
			}

		}

	}

	return;

</%perl>
