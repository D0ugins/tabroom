<%perl>

	my %cookies = Apache2::Cookie->fetch;

	if ( defined eval{$cookies{'Tab-AuthToken'}->value} ) { 

		my $user_key = $cookies{'Tab-AuthToken'}->value;

		# Authentication key must correspond to a session in the database
		my $session = Tab::Session->search( userkey => $user_key )->first;

		if ($session) { 

			# Userid must correspond to a user in the database 
			my $person = $session->person;

			unless ($person && $person->email) { 
				$session->delete;
				my $msg = "You do not have a current active session.  Please login";
				$m->redirect("/index/index.mhtml?msg=$msg");
			} else { 
				return ($person, $session);
			}

		}

	} 

	return;

</%perl>
