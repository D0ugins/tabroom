<%args>
	$person
	$certain => undef
</%args>
<%init>

	my $msg;
	my $err;
	return unless $person && $person->id;

	if ($certain eq "I am certain") { 

		my %scrub_other = (
			chapter_judge => "person_request",
			judge         => "person_request",
			student       => "person_request"
		);

		foreach my $key (keys %scrub_other) { 
			my $target = $scrub_other{$key};
			next unless $target;
			my $method = "scrub_$key";
			Tab::Person->set_sql( $method => "update $key set $target = 0 where $target = ?");
			$method = "sql_".$method;
			Tab::Person->$method->execute($person->id) if $person;
		}

		Tab::JudgeSetting->set_sql( delete_value => "delete from judge_setting where value = ?");

		Tab::JudgeSetting->sql_delete_value($person->email);
		Tab::JudgeSetting->sql_delete_value($person->phone);

		my @deleteme = (
			"change_log",
			"conflict",
			"follower",
			"login",
			"permission",
			"person_setting",
			"session",
			"tourn_ignore"
		);

		foreach my $delete (@deleteme) { 
			
			Tab::Person->set_sql( "delete_$delete" => "
				delete from $delete where person = ? 
			");

			my $method = "sql_delete_".$delete;
			Tab::Person->$method->execute($person->id);
		}

		my @scrubme = (
			"chapter_judge",
			"file",
			"judge",
			"student"
		);

		foreach my $scrub (@scrubme) { 
			
			Tab::Person->set_sql( "scrub_$scrub" => "
				update $scrub set person = 0 where person = ? 
			");

			my $method = "sql_scrub_".$scrub;
			Tab::Person->$method->execute($person->id);
		}

		Tab::Person->set_sql( followee => "
			delete from follower where follower = ? 
		");

		Tab::Person->sql_followee->execute($person->id);
		$msg = $person->email."'s account, access and records have been completely deleted.";
		$person->delete();
		
		$m->redirect("/index/index.mhtml?msg=$msg");

	} elsif ($certain) { 

		$err = "You did not type 'I am certain' exactly.  Please do if you want to continue.";

	}

</%init>

	<div class="main">

		<div class="centeralign">

			<span class="threequarters">

				<h3>Account Removal</h3>

				<p class="bigger">
					This process will remove your account and access to Tabroom
					entirely.  You will lose access to any competitor history,
					judge records, school records, or so on. 
				</p>

				<p class="bigger">
					Your personal contact information will be deleted from
					Tabroom. 
				</p>

				<p class="bigger semibold bluetext martopmore marbottommore">
					Please indicate this deletion is what you want to do by
					typing "I am certain" in the box below. 
				</p>

				<p class="bigger semibold redtext">
					<% $err %> 
				</p>

				<form action="user_remove.mhtml" method="post">

					<div class="full centeralign martopmuchmore">
						<input 
							type = "text"
							size = "32"
							name = "certain"
						>
					</div>

					<div class="full centeralign">

						<input
							type  = "submit"
							value = "Delete Account"
							class = "red padmuchmore"
						>
					</div>

				</form>
			</span>
		</div>
	</div>
