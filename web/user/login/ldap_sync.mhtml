<%args>
	$person    => undef
	$target_id => undef
</%args>
<%init>

    $m->clear_buffer();
    $r->content_type('application/json');

	if (
		(not defined $person)
		|| ($person->site_admin)
	) {
		$person = eval {
			return Tab::Person->retrieve($target_id);
		};
	}

	if ($person) {

		my %logins = map {$_->username => $_} $person->logins();

		unless ($logins{$person->email}) {

			my @all = sort {
				$logins{$b}->last_access cmp $logins{$a}->last_access
			} keys %logins;

			my $primary = shift @all;

			my $taken = Tab::Login->search( username => $person->email )->first;

			if ($taken) {

				$taken->person($person->id);
				$taken->sha512($logins{$primary}->sha512);
				$taken->update();

			} else {

				Tab::Login->create({
					person   => $person->id,
					username => $person->email,
					sha512   => $logins{$primary}->sha512,
				});
			}
		}

		$m->comp("/funclib/ldap_person.mas",
			person => $person,
			reset  => 1
		);
	}

	my $msg = "Your account has been re-synced with external services";

    $m->print('{
        "error": false,
        "message": "'.$msg.'"
    }');

    $m->abort();

</%init>
