<%args>
	$person
	$login_id => undef
</%args>
<%init>

	my $msg;
	my $err;

	if ($login_id) {

		my $login = Tab::Login->retrieve($login_id);
		my @all = $person->logins();

		if (not defined $login) {

			$err = "No such login found";

		} elsif ($login->person != $person) {

			$err = "No such login found";

		} elsif (lc($login->username) eq lc($person->email)) {

			$err = "You may not delete your primary login (the login that matches your account email)";

		} elsif (scalar @all == 1) {

			$login->username(lc($person->email));
			$login->update();

			$err = "You may not delete your only login.  Updated to match email.";

		} else {

			$msg = "Spare login ".$login->username." deleted";
			$login->delete();
		}

	}

	$m->redirect("/user/login/profile.mhtml?err=$err&msg=$msg");

</%init>
