<%args>
	$person
	$first                 => undef
	$middle                => undef
	$last                  => undef
	$email                 => undef
	$googleplus            => undef
	$phone                 => undef
	$provider              => undef
	$street                => undef
	$city                  => undef
	$state                 => undef
	$no_email              => undef
	$zip                   => undef
	$pronoun               => undef
	$timezone              => undef
	$please_stop_screaming => 0
</%args>
<%init>

	$m->abort unless $person;

	$m->abort unless $first;
	$m->abort unless $last;
	$m->abort unless $email;

	$email =~ s/\s+//g;

	unless ($email eq $person->email) { 

		my @existing_emails = Tab::Person->search( email => $email);

		if (@existing_emails) { 

			my $err = "Email address $email already has an person: ".$existing_emails[0]->first." ".$existing_emails[0]->last;
			$m->redirect("/user/login/profile.mhtml?err=$err");			

		}

	}

	$googleplus =~ s/\s+//g;
	$phone =~ s/[\D_]//g;

	foreach my $login ($person->logins) { 
		next unless $login->username eq $person->email;

		if ($login->username ne $email) { 
			$login->username($email);
			$login->update;
			$m->comp("/funclib/ldap_person.mas", login => $login);
		}
	}
	
	$person->first($first);
	$person->middle($middle);
	$person->last($last);
	$person->street($street);
	$person->city($city);
	$person->email($email);
	$person->googleplus($googleplus);
	$person->state($state);
	$person->no_email($no_email);
	$person->zip($zip);
	$person->pronoun($pronoun);
	$person->phone($phone);
	$person->provider($provider);
	$person->tz($timezone);
	$person->update;

	$person->setting("please_stop_screaming", $please_stop_screaming);

	Tab::log("PROFILE CHANGE: Account ID ".$person->id." ($email) was modified from IP address ".$ENV{REMOTE_ADDR});

	
	my $msg = "Changes saved";
	
	$m->redirect("/user/login/profile.mhtml?msg=$msg");

</%init>
