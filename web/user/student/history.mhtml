<%args>
	$person
	$student_id => undef
	$tourn_id   => undef
</%args>
<%init>

	my $tourn = Tab::Tourn->retrieve($tourn_id);
	$m->abort unless $tourn;

	my @panels;
	my $student;
	my @done_panels;

	if ($student_id) { 

		$student = Tab::Student->retrieve($student_id);

		@panels = $m->comp(
			"/funclib/student_panels.mas", 
			student => $student, 
			tourn => $tourn
		);

		@done_panels = $m->comp(
			"/funclib/student_panels.mas", 
			student => $student,
			done    => 1,
			tourn   => $tourn
		);

		my $ok;

		$ok++ if $person->site_admin;

		$ok++ if $student->person && $student->person->id == $person->id;

		foreach my $admin ($m->comp(
			"/funclib/chapter_admins.mas", 
			chapter => $student->chapter)
		) { 
			$ok++ if $admin->id == $person->id;
		} 

		unless ($ok) { 
			my $err = "You do not have access to that debater record.";
			$m->redirect("/user/home.mhtml?err=$err");
		}

	} else { 

		@panels = $m->comp(
			"/funclib/person_student_panels.mas", 
			person  => $person,
			student => 1,
			tourn   => $tourn
		);

		@done_panels = $m->comp(
			"/funclib/person_student_panels.mas", 
			person  => $person,
			done    => 1,
			student => 1,
			tourn   => $tourn
		);
	} 

	my $now = DateTime->now;

</%init>

	<& "/user/menu.mas", whoami => "student", person => $person &>

	<div class="main">

%		if ($student_id) { 

			<h2><% $student->chapter->name %></h2>
			
			<& /user/chapter/tabbar.mas, chapter => $student->chapter, whoami => "students" &> 

			<div class="block marno padno">

				<span class="twothird">
					<h4><% $student->first." ".$student->last %></h4>
				</span>

				<span class="third rightalign smallish">
					<a 
						class="dkblue button centeralign" 
						href="index.mhtml?student_id=<% $student->id %>">
						Return to Debater Record
					</a>
				</span>
			</div>


%		} else { 

			<h2><% $tourn->name %></h2>

%		} 

%		if (@panels) { 

			<h4>Rounds w/o Results</h4>

			<table>

				<tr class="yellowrow">

					<th class="smallish">
						Round
					</th>

					<th class="smallish">
						Start
					</th>

					<th class="smallish">
						Room
					</th>

					<th class="smallish">
						Pos
					</th>
						
					<th class="smallish">
						Judging
					</th>

				</tr>

%				my $switch;

<%perl>

				foreach my $panel (@panels) { 

					my $event = $panel->round->event;

					my $tz = $event->tourn->tz;
					$tz = "UTC" unless $tz;
					my $tzname = Tab::tzname($tz);

					my $aff_string = $event->setting("aff_label");
					my $neg_string = $event->setting("neg_label");
					$aff_string = "Aff" unless $aff_string;
					$neg_string = "Neg" unless $neg_string;

</%perl>

					<tr class="row">

						<td>
							<% $panel->round->realname %>
						</td>

						<td>
							<% Tab::niceshortdt($panel->round->timeslot->start) %> <% $tzname %>
						</td>

						<td>
							<% $panel->room ? $panel->room->name : "No Room" %>
						</td>

						<td>
%							if ($event->type eq "wudc") { 
								<% $panel->pos == 1 ? "1st Gov" : "" %>
								<% $panel->pos == 2 ? "1st Opp" : "" %>
								<% $panel->pos == 3 ? "2nd Gov" : "" %>
								<% $panel->pos == 4 ? "2nd Opp" : "" %>

%							} elsif ($panel->round->event->type eq "speech") { 
								<% Lingua::EN::Numbers::Ordinate::ordinate($panel->pos) %>
%							} else { 
								<% $panel->bye ? "Bye" : $panel->side == 1 ? $aff_string : $neg_string %>
%							} 

						</td>

						<td>
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 
								<div class="smallish">
%									if ($judge->person && $judge->person > 0) {

										<a 
											href="/ndt/JudgeRecord.php?judgeid=<% $judge->person->id %>" 
											class="white">

%									} else { 
										<a class="white">
%									}
										<span class="threefifths nowrap">
											<% $judge->last.", ".$judge->first %> 
										</span>
										<span class="twofifths">
											(<% $judge->school ? $judge->school->short_name : "Hire" %>)
										</span>
									</a>
								</div>
%							}
						</td>

					</tr>

%				}

			</table>
			
			<br />

%		}

%		if (@done_panels) { 

			<h4>Published Results</h4>

			<table>

				<tr class="yellowrow">

					<th class="smallish">
						Round
					</th>

					<th class="smallish">
						Pos
					</th>
						
					<th class="smallish">
						Judging
					</th>

					<th class="smallish">
						Result
					</th>

					<th class="smallish">
						Comments
					</th>
				</tr>

%				my $switch;

%				foreach my $panel (@done_panels) { 

<%perl>

					my $ballot_comments;

					my $entry = Tab::Entry->retrieve($panel->entryid);
					my $event = $panel->round->event;

					my $aff_string = $event->setting("aff_label");
					my $neg_string = $event->setting("neg_label");
					$aff_string = "Aff" unless $aff_string;
					$neg_string = "Neg" unless $neg_string;

					my %student_by_id = ();

					foreach my $student ($entry->students) { 
						$student_by_id{$student->id} = $student;
					}

</%perl>
					<tr class="row">

						<td>
							<% $panel->round->realname %>
						</td>

						<td>
%							if ($event->type eq "wudc") { 
								<% $panel->pos == 1 ? "1st Gov" : "" %>
								<% $panel->pos == 2 ? "1st Opp" : "" %>
								<% $panel->pos == 3 ? "2nd Gov" : "" %>
								<% $panel->pos == 4 ? "2nd Opp" : "" %>
%							} elsif ($event->type eq "speech") { 
								<% Lingua::EN::Numbers::Ordinate::ordinate($panel->pos) %>
%							} else { 
								<% $panel->bye ? "Bye" : $panel->side == 1 ? $aff_string : $neg_string %>
%							} 
						</td>

						<td class="smallish">

%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

								<div class="smallish nowrap padmuchmore">

%									if ($judge->person && $judge->person > 0) {

										<a 
											href="/ndt/JudgeRecord.php?judgeid=<% $judge->person->id %>" 
											class="white nospace" target="_blank"
										>
%									} else { 
										<a class="white">
%									}
										<span class="threefifths nowrap">
											<% $judge->last.", ".$judge->first %> 
										</span>
										<span class="twofifths">
											<% $judge->school > 0? $judge->school->short_name : "Hired" %>
										</span>
									</a>
								</div>
%							}
						</td>

						<td>
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

%								my @scores = $m->comp("/funclib/panel_scores.mas", 
%														panel => $panel, 
%														judge => $judge, 
%														entry_id => $panel->entryid);

								<div class="smallish nowrap padmuchmore">

%									if ($panel->round->post_results > 0) {
										<span class="sixth nospace strong">
%											foreach my $score (@scores) { 
												<% $score->tag eq "ballot" ? $score->value == 1 ? "W" : "L" : ""%>
%											}
										</span>
%									}

									<div class="fivesixths nospace">

%									if ($panel->round->post_results == 2) {
%										foreach my $student ($entry->students) { 
											<div class="full padless marno">
%												my $done;

%												foreach my $score (@scores) { 
%													next if $score->tag eq "ballot";
%													next unless $score->studentid == $student->id;
													<span class="third nospace">
													<% $score->tag eq "points" ? $score->value : "" %>
													<% $score->tag eq "rank" ? Lingua::EN::Numbers::Ordinate::ordinate($score->value) : "" %>
													</span>
%													$done++;
%												}
												<span class="third nospace">
													<% $done ? "-".$student->last : ""%>
												</span>
											</div>
%										}
%									}

									</div>


								</div>
%							}

						</td>

						<td>
%							foreach my $judge ($m->comp("/funclib/panel_judges.mas", panel => $panel)) { 

								<div class="smallish nowrap centeralign marno">

%								my @comments = $m->comp("/funclib/panel_scores.mas", 
%														panel    => $panel,
%														judge    => $judge,
%														comments => "yesmaam",
%														entry_id => $panel->entryid);

%								if (@comments) { 
									<a 
										target="_blank" 
										class="dkblue marno button" 
										href="rfd_view.mhtml?entry_id=<% $entry->id %>&panel_id=<% $panel->id %>&judge_id=<% $judge->id %>">
										RFD & Comments
									</a>

%								} else {
									&nbsp;
%								} 
								</div>
%							}
						</td>
					</tr>

%				}

			</table>
			
			<br />
%		}

	</div>

