<%args>
	$person
	$entry_id => undef
	$panel_id => undef
</%args>
<%init>

	my $chamber = Tab::Panel->retrieve($panel_id) if $panel_id;
	my $voter = Tab::Entry->retrieve($entry_id) if $entry_id;

	unless ($chamber && $voter) {
		my $err = "No voter found for ID $entry_id or no chamber found for $panel_id";
		$m->redirect("/user/student/index.mhtml?err=$err");
	}

	my $student = $voter->students->first;

	unless ($student->person == $person) {
		my $err = "Your account does not have access to that ballot record";
		$m->redirect("/user/student/index.mhtml?err=$err");
	}

	my $round = $chamber->round;

	unless ($round->setting('student_vote_open')) {
		my $err = "That round is not open for voting";
		$m->redirect("/user/student/index.mhtml?err=$err");
	}

	my $event = $round->event;
	my $tourn = $event->tourn;

	my %votes;

	my $truncate;
	$truncate = $event->setting("student_truncate_fill") if $event;

	my $dbh = Tab::DBI->db_Main();


</%init>

	<div class="main">

<%perl>

		my $sth = $dbh->prepare("
			select voter.id, vote.entry, vote.id, vote.rank
				from (student_vote vote, entry voter)

				left join entry_student es on es.entry = voter.id
				left join student on es.student = student.id
			where vote.panel = ?
			and vote.voter = ?
			and vote.voter = voter.id
		");

		$sth->execute($chamber->id, $voter->id);

		my %ballot;

		while (
			my ($voter, $entry_id, $vote_id, $rank) = $sth->fetchrow_array()
		) {
			$ballot{$entry_id} = $rank;
		}

		$sth->finish();

</%perl>
		<form action="student_vote_save.mhtml" method="post">

		<input
			type  = "hidden"
			name  = "panel_id"
			value = "<% $chamber->id %>"
		>

		<input
			type  = "hidden"
			name  = "voter_id"
			value = "<% $voter->id %>"
		>

			<div class="full">

			<span class="third nospace">
				<h5 class="normalweight nospace">
					<% $event->abbr %> Chamber <% $chamber->letter %>
				</h5>
			</span>

			<span class="third nospace semibold redtext centeralign">
%				if ($truncate) {
					Rank 1 - <% $truncate - 1 %>, leave the rest blank
%				}
			</span>

			<span class="third nospace rightalign">
				<h5 class="normalweight nospace">
					<% $voter->code %>
				</h5>
			</span>

			</div>

			<& "/funclib/tablesorter.mas", nobuttons => 1, table => $chamber->id &>

			<table id="<% $chamber %>">

				<thead>

					<tr class="yellowrow smallish">
						<th>
							Entry Code
						</th>

						<th>
							Name
						</th>

						<th>
							Vote
						</th>
					</tr>

				</thead>

				<tbody>
<%perl>
					my @entries = $m->comp("/funclib/panel_entries.mas", panel => $chamber);
					my $panel_size = scalar @entries - 1;
					my $counter = 1;

					foreach my $entry (@entries) {

						next if $entry->id == $voter->id;
</%perl>
						<tr>

							<td>
								<% $entry->code %>
							</td>

							<td>
								<span class="hidden"><% $entry->lastname %></span>
								<% $entry->name %>
							</td>

							<td class="centeralign padless">

								<span class="hidden">
									<% $ballot{$entry->id} ? $ballot{$entry->id} : "-1" %>
								</span>

								<input
									type          = "number"
									tabindex      = "<% $counter++ %>"
									name          = "<% $entry->id %>"
									value         = "<% $ballot{$entry->id} != $truncate ? $ballot{$entry->id} : ""%>"
									min 		  = 1
									max           = "<% $truncate ? $truncate : $panel_size %>"
								>
							</td>

						</tr>
%					}
				</tbody>
			</table>

			<div class="libl rightalign pagefull">
				<input type="submit" value="Save Ballot">
			</div>

		</form>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Return</h4>

			<a
				class="full blue"
				href="/user/student/index.mhtml"
			>Return to <% $person->first %> <% $person->last %>
			</a>

		</div>

	</div>
