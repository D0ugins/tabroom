<%args>
	$person
	$entry_id => undef
	$panel_id => undef
</%args>
<%init>

	my $chamber = Tab::Panel->retrieve($panel_id) if $panel_id;
	my $voter = Tab::Entry->retrieve($entry_id) if $entry_id;

	unless ($chamber && $voter) {
		my $err = "No voter found for ID $entry_id or no chamber found for $panel_id";
		$m->redirect("/user/student/index.mhtml?err=$err");
	}

	my $student = $voter->students->first;

	unless ($student->person == $person) {
		my $err = "Your account does not have access to that ballot record";
		$m->redirect("/user/student/index.mhtml?err=$err");
	}

	my $round = $chamber->round;

	unless ($round->setting('student_vote_open')) {
		my $err = "That round is not open for voting";
		$m->redirect("/user/student/index.mhtml?err=$err");
	}

	my $event = $round->event;
	my $tourn = $event->tourn;

	my %votes;

	my $truncate;
	$truncate = $event->setting("student_truncate_fill") if $event;

	my $dbh = Tab::DBI->db_Main();


</%init>

	<div class="main">

<%perl>

		my $nom_sth = $dbh->prepare("
			select
				vote.id, vote.entry, vote.tag, vote.value
				from (student_vote vote)
			where vote.panel = ?
			and vote.tag = 'nominee'
		");

		$nom_sth->execute($chamber->id);

		my %noms;
		my $limited;

		while (
			my (
				$id, $entry, $tag, $value
			)  = $nom_sth->fetchrow_array()
		) {
			$noms{$entry} = $value;
			$limited++;
		}

		$nom_sth->finish();
		my $votes;

		if ($limited) {
			$votes = $limited;
			$votes = $truncate if (defined $truncate) && $truncate < $limited;
		} else {
			$votes = $truncate if (defined $truncate);
		}

		my $sth = $dbh->prepare("
			select voter.id, vote.entry, vote.id, vote.tag, vote.value
				from (student_vote vote, entry voter)

				left join entry_student es on es.entry = voter.id
				left join student on es.student = student.id
			where vote.panel = ?
			and vote.voter = ?
			and vote.voter = voter.id
		");

		$sth->execute($chamber->id, $voter->id);

		my %ballot;

		while (
			my (
				$voter_id, $entry_id, $id, $tag, $value
			) = $sth->fetchrow_array()
		) {
			$ballot{$entry_id} = $value;
		}

		$sth->finish();

</%perl>
		<form action="student_vote_save.mhtml" method="post">

		<input
			type  = "hidden"
			name  = "panel_id"
			value = "<% $chamber->id %>"
		>

		<input
			type  = "hidden"
			name  = "voter_id"
			value = "<% $voter->id %>"
		>

			<div class="full">

				<span class="third true">
					<h4 class="nospace">
						Competitor Vote
					</h4>
				</span>

				<span class="third true centeralign">
					<h5 class="nospace">
						<% $event->abbr %> Chamber <% $chamber->letter %>
					</h5>
				</span>

				<span class="third true rightalign">
					<h4 class="bluetext semibold nospace">
						<% $voter->code %>
					</h4>
				</span>

			</div>

			<span class="full semibold redtext centeralign bigger italic odd marbottommore">
%				if ($truncate) {
					Rank the best entries 1 - <% $truncate - 1 %>, leave any others blank. No ties.
%				} else {
					Rank all entries in order, 1 being best, without any ties.
%				}
			</span>

			<div class="yellowrow smallish semibold">
				<span class="quarter">
					Entry Code
				</span>


				<span class="threequarters">
					Vote
				</span>
			</div>

<%perl>
			my @entries = $m->comp("/funclib/panel_entries.mas", panel => $chamber);
			my $panel_size = scalar @entries;
			my $counter = 1;

			foreach my $entry (@entries) {

				next if $limited && (not defined $noms{$entry->id});

</%perl>
				<div class="row">

					<span class="quarter borderright padvert marno semibold bluetext padleft">
						<% $entry->code %>
					</span>

					<span class="threequarters nospace padleft">

%						if ($votes && $votes < 13) {
%							foreach my $vote (1 .. $votes) {
								<label for="<% $entry->id %>_<% $vote %>">
									<span class="marno twelfth hover">
										<% $vote %>
										<input
											type  = "radio"
											name  = "<% $entry->id %>"
											id    = "<% $entry->id %>_<% $vote %>"
											value = "<% $vote %>"
											<% $ballot{$entry->id} == $vote ? "checked" : "" %>
										>
									</span>
								</label>
%							}
%						} else {
							<span class="hidden">
								<% $ballot{$entry->id} ? $ballot{$entry->id} : "-1" %>
							</span>

							<input
								type          = "number"
								tabindex      = "<% $counter++ %>"
								name          = "<% $entry->id %>"
								value         = "<% $ballot{$entry->id} != $truncate ? $ballot{$entry->id} : ""%>"
								min 		  = 1
								max           = "<% $truncate ? $truncate : $panel_size %>"
							>
%						}
					</span>
				</div>
%			}

			<div class="liblrow rightalign">
				<span class="quarter centeralign">
					<input type="submit" value="Save Ballot">
				</span>
			</div>
		</form>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Return</h4>

			<a
				class="full blue"
				href="/user/student/index.mhtml"
			>Return to <% $person->first %> <% $person->last %>
			</a>

		</div>

	</div>
