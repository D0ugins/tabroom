<%args>
	$entry
	$person
	$student    => undef
	$student_id => undef
</%args>
<%init>

	return unless $entry && $entry->id;

	my $event = $entry->event;
	my $tourn = $event->tourn;

	my $no_side_constraints++ if $event->setting('no_side_constraints');

	$student = Tab::Student->retrieve($student_id) unless $student;

	$m->abort unless $student;

	my @panels = $m->comp("/funclib/entry_panels.mas", entry => $entry);

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $tzname = Tab::tzname($tz);

	my $aff_string = $event->setting("aff_label");
	my $neg_string = $event->setting("neg_label");

	$aff_string = "Aff" unless $aff_string;
	$neg_string = "Neg" unless $neg_string;

	my $show_paradigms;

	$show_paradigms++ unless (
		$event->type eq "speech"
		|| $event->type eq "congress"
	);

	my @students;

</%init>			

	<div class="full nospace">

		<span class="half nowrap nospace">
			<h5><% $event->abbr %> at <% $tourn->name %></h5>
		</span>

		<span class="quarter rightalign">
			<h5><% $entry->code %></h5>
		</span>

		<span 
			id    = "<% $entry->id %>_buttonarea"
			class = "quarter nospace rightalign">

			<a href  = "/user/student/entry_print.mhtml?student_id=<% $student->id %>&tourn_id=<% $tourn->id %>"
			   class = "fa fa-sm buttonwhite bluetext fa fa-file-pdf-o"
			>
			</a>
		</span>

	</div>

	<& 
		"/funclib/tablesorter.mas",
		table     => $entry->id,
		nobuttons => 1
	&>

	<table id="<% $entry->id %>">

		<thead>

		<tr class="smallish semibold yellowrow">

			<th class="smallish">
				Round
			</th>

			<th class="smallish">
				Start
			</th>

			<th class="smallish">
				Room
			</th>

			<th class="smallish">
%				if ($event->type eq "speech") { 
					Speak
%				} elsif ($event->type eq "wudc") { 
					Position
%				} elsif ($event->type eq "congress") {
%				} elsif ($no_side_constraints) { 
%				} else { 
					Side 
%				}
			</th>
		
%			if ($event->type ne "speech" && $event->type ne "debate") { 
				<th class="smallish">
					Opponents
				</th>
%			}

			<th class="smallish">
				Judge
			</th>

			<th class="smallish">
				Results
			</th>

		</tr>
		</thead>
		<tbody>

<%perl>

		foreach my $panel (@panels) { 

			my $round = $panel->round;

			next unless $round->published > 0 
				|| $round->post_results > 0;

		    my $start = $round->start_time;
		    $start = $round->timeslot->start unless $start;
		    $start->set_time_zone($tz);

			my $sidelocks++ 
				if $round->type eq "elim" 
				&& (not defined $no_side_constraints);

			undef $sidelocks 
				if $tourn->setting("nsda_nats") 
				&& (not defined $event->setting("not_nats"));
						
						
			my @judges = $m->comp("/funclib/panel_judges.mas", panel => $panel);

			my @entries = $m->comp("/funclib/panel_entries.mas", panel => $panel);

</%perl>

			<tr class="row">

				<td>
					<% $panel->round->realname %>
				</td>

				<td>
					<span class="third">
						<% $panel->round->timeslot->start->day_abbr %>
					</span>
					<span class="twothirds">
						<% Tab::nicetime($start) %>
					</span>
				</td>

				<td>
					<% $panel->room > 0 ? $panel->room->name : "No Room" %>
				</td>


				<td class="centeralign">
%					if ($event->type eq "wudc") { 
						<% $panel->pos == 1 ? "1st Gov" : "" %>
						<% $panel->pos == 2 ? "1st Opp" : "" %>
						<% $panel->pos == 3 ? "2nd Gov" : "" %>
						<% $panel->pos == 4 ? "2nd Opp" : "" %>
%					} elsif ($event->type eq "speech") { 
						<% Lingua::EN::Numbers::Ordinate::ordinate($panel->pos) %>
%					} else { 
						<% $panel->bye ? "Bye" : $panel->side == 1 ? $aff_string : $neg_string %>
%					}
				</td>

%				if ($event->type ne "speech" && $event->type ne "debate") { 

					<td class="nospace padleft">
%						foreach my $opp (@entries) { 

%							next if $entry->id == $opp->id;

							<div class="full">
								<% $opp->code %>
							</div>
%						}
					</td>

%				} 

				<td 
					class = "nospace"
				>

%					if ($round->published == 1) { 

%						foreach my $judge (@judges) { 

							<div 
								title = "<% $judge->school > 0 ? $judge->school->short_name : "" %>"
								class="full marno hover"
							>

<%perl>
							if ($show_paradigms) { 

								my $judge_paradigm = 
									$judge->person->setting("paradigm") 
									if $judge->person;

								if ($judge_paradigm) { 
</%perl>
									 <a 
										 class  = "full hover nospace plain"
										 href   = "/index/paradigm.mhtml?judge_person_id=<% $judge->person->id %>"
										 target = "_blank"
									 >
%								} else { 
		
									 <a 
										 class  = "full hover nospace plain"
										 href   = "http://judgephilosophies.wikispaces.com/<% $judge->last %>%2C+<% $judge->first %>"
										 target = "_blank">
%								}

%							}

								<% $judge->last.", ".$judge->first %> 


								</a>

							</div>

%						}

%					}

				</td>

				<td class="nospace smallish">

<%perl>
					if ($round->post_results > 0) { 

						my %scores;
						my %students;

						foreach my $ballot ($m->comp(
							"/funclib/entry_ballots.mas", 
								entry => $entry,
								round => $round
							)
						) { 

							$scores{"bye"}++ if $ballot->bye;

							$scores{"forfeit"}++ if $ballot->forfeit;

							foreach my $score ($ballot->scores) { 

								if ($score->tag eq "ballot") { 

									$scores{"winloss"}{$ballot->judge->id} = "W" if $score->value == 1;
									$scores{"winloss"}{$ballot->judge->id} = "L" if $score->value != 1;

								} elsif ($score->student > 0) { 

									$students{$score->student->id}++;
									$scores{$score->tag}{$score->student->id}{$ballot->judge->id} = $score->value;

								} elsif ($score->tag eq "congress_speech") { 

									push @{$scores{$score->tag}{$ballot->judge->id}}, $score->value;

								} else { 

									$scores{$score->tag}{$ballot->judge->id} = $score->content;

								}

							}

						}

						foreach my $judge (@judges) { 

</%perl>
							<div class="full padtouchless marno limitless">

								<span class="quarter padleft marno">
									<% $scores{"bye"} ? "BYE" : "" %>
									<% $scores{"forfeit"} ? "FFT" : "" %>
									<% $scores{"winloss"}{$judge->id} ? $scores{"winloss"}{$judge->id} : "" %>
								</span>

%								if ($panel->round->post_results >= 2) {

									<span class="half marno">

%									if ($scores{"rank"}{$judge->id}) { 

										<span class="third">
											<% $scores{"rank"}{$judge->id} %>
										</span>
<%perl>

									}

									if ($scores{"congress_speech"}{$judge->id}) { 
										
										my $notfirst;
										$m->print('<span class="third">');
										foreach my $score (@{$scores{"congress_speech"}{$judge->id}}) { 
											$m->print(", ") if $notfirst++;
											$m->print($score) if $notfirst++;
										}

										$m->print('</span">');
									}


									if ($scores{"points"}{$judge->id}) { 
</%perl>
										<span class="third">
											<% $scores{"points"}{$judge->id} %>
										</span>
<%perl>
									}

									my $num_students = scalar(keys %students);

									if ($num_students > 0) { 

										foreach my $student_id (sort keys %students) { 

											my $student = Tab::Student->retrieve($student_id);
											my $length = "half";
											my $otherlength = "twofifths";

</%perl>
											<div class="full marno padno">

%												if ($num_students > 1) { 
													<span class="half nowrap">
														<% $student->last.", ".$student->first." ".$student->middle %>
													</span>
%													$length = "quarter";
%													$otherlength = "fifth";
%												}

%												if ($scores{"rank"}{$student_id}{$judge->id}) { 
													<span class="<% $otherlength %> centeralign ">
														<% $scores{"rank"}{$student_id}{$judge->id} %>
													</span>
%												}

%												if ($scores{"points"}{$student_id}{$judge->id}) { 
													<span class="<% $length %> rightalign ">
														<% $scores{"points"}{$student_id}{$judge->id} %>
													</span>
%												}

%												if ($scores{"rebuttal_points"}{$student_id}{$judge->id}) { 
													<span class="<% $otherlength %> rightalign">
														<% $scores{"rebuttal_points"}{$student_id}{$judge->id} %>
													</span>
%												}

											</div>

<%perl>

										}
									}

									$m->print('</span>');

								}

								if ($scores{"rfd"}{$judge->id} 
									|| $scores{"comments"}{$judge->id}
								) { 

</%perl>
									<span class="quarter nospace rightalign">
										<a 
											class  = "buttonwhite bluetext smallish padless thin marno"
											target = "_blank"
											href   = "/user/student/rfd_view.mhtml?entry_id=<% $entry->id %>&panel_id=<% $panel->id %>&judge_id=<% $judge->id %>"
										>RFD</a>
									</span>
%								}


							</div>

%						}

%					}

				</td>

			</tr>

%		}

		</tbody>

		</table>
			
