<%args>
	$entry
	$person
	$student    => undef
	$student_id => undef
</%args>
<%init>

	use Switch;

	return unless $entry && $entry->id;

	$student = Tab::Student->retrieve($student_id) unless $student;
	$m->abort unless $student;

	my $event = $entry->event;
	my $school = $entry->school;
	my $tourn = $event->tourn;
	my $event_type = $event->type;
	my $is_pf;

	my $tz = $tourn->tz;
	$tz = "UTC" unless $tz;
	my $tzname = Tab::tzname($tz);

	my $student_ballot = $event->setting("student_online_ballots");

	my @students;

    Tab::Round->set_sql( entry_strikes => "
        select distinct round.*
        from round, round_setting, panel, ballot
		where ballot.entry = ?
			and ballot.panel = panel.id
			and panel.bye != 1
			and panel.round = round.id
			and round.id = round_setting.round
			and round_setting.tag = 'strikes_published'
			and round_setting.value = 1
        order by round.start_time
    ");

	my @strike_cards = Tab::Round->search_entry_strikes($entry->id);

    Tab::Round->set_sql( entry_flips => "
        select distinct round.*
        from round, round_setting, panel, ballot, panel_setting flip_at, panel_setting flip_status
		where ballot.entry = ?
			and ballot.panel = panel.id
			and panel.bye != 1
			and panel.round = round.id

			and flip_at.tag = 'flip_at'
			and flip_at.panel = panel.id

			and flip_status.tag = 'flip_status'
			and flip_status.panel = panel.id
			and flip_status.value != 'done'

			and round.id = round_setting.round
			and round_setting.tag = 'flip_published'
			and round_setting.value = 1
        order by round.start_time
    ");

	my @flip_cards = Tab::Round->search_entry_flips($entry->id);

</%init>

	<div class="full nospace marbottommore padtopmore padbottom ltborderbottom">
		<span class="threefifths nospace">
			<h5 class='bluetext semibold inline'>
				<% $tourn->name %>
			</h5>
		</span>

		<span class="fifth nospace redtext semibold biggish rightalign">
			<% $event->name %>
		</span>

		<span class="fifth nospace bluetext semibold biggish rightalign">
			Code: <% $entry->code %>
		</span>
	</div>

<%perl>

	if ($event->setting("online")) {

		my $mode = $event->setting("online_mode");
		my $prep = $event->setting("online_prep");

		if ($mode eq "nsda_jitsi" || $mode eq "nsda_private") {

			my @local_rooms = eval{
				return @{$tourn->setting('online_rooms')};
			};

			my @rooms;

			foreach my $room (@local_rooms) {
				if (
					$room->{access} eq "entry"
					&& (
						(not defined $room->{event_id})
						|| $room->{event_id} == $event->id
					)
				) {
					push @rooms, $room;
				}
			}

</%perl>

			<p class="semibold redtext">
				Online Spaces
			</p>

			<div class="ltbordervert odd centeralign">

				<span class="third leftalign">
					<span class="threequarters semibold bluetext">
						<span class="halfspace"></span>
						<% Tab::short_name($school->name) %> Squad Room
					</span>

					<span class="quarter centeralign padvert nospace">
						<& "/funclib/online_room.mas",
							school => $school->id,
							person => $person,
							show   => 1,
							class  => "fa"
						&>
					</span>
				</span>

%				if ($prep) {
					<span class="third leftalign">
						<span class="threequarters semibold bluetext">
							<span class="halfspace"></span>
							<% $entry->code %> Prep Room
						</span>
						<span class="quarter centeralign padvert nospace">
							<& "/funclib/online_room.mas",
								entry  => $entry,
								person => $person,
								show   => 1,
								class  => "fa"
							&>
						</span>
					</span>
%				}

%				foreach my $room (@rooms) {
					<span class="third leftalign">
						<span class="threequarters semibold bluetext">
							<span class="halfspace"></span>
							<% $room->{"name"} %>:
						</span>
						<span class="quarter centeralign padvert nospace">
							<& "/funclib/online_room.mas",
								util   => $room,
								person => $person,
								show   => 1,
								class  => "fa"
							&>
						</span>
					</span>
%				}
			</div>
%		}
%	}

<%perl>

	if ($student_ballot) {

		Tab::Panel->columns(TEMP => "roundname");
		Tab::Panel->columns(TEMP => "roundlabel");
		Tab::Panel->columns(TEMP => "side");
		Tab::Panel->columns(TEMP => "feedback");

		Tab::Panel->set_sql(open_ballot => "
			select panel.*, round.name as roundname, round.label as roundlabel,
				ballot.side as side
			from panel, ballot, round, round_setting
			where ballot.entry = ?
			and ballot.panel = panel.id
			and panel.round = round.id
			and round.id = round_setting.round
			and round_setting.tag = 'student_vote_open'
			group by panel.id
		");

		my @panels = Tab::Panel->search_open_ballot($entry->id);

		foreach my $panel (@panels) {

</%perl>
			<div class="odd padvert marbottommore martopmore">
				<span class="fivetenths nospace semibold redtext bigger">
					Competitor Vote Open
				</span>

				<span class="threetenths nospace semibold bluetext bigger">
					<% $panel->roundlabel ? $panel->roundlabel." Session" : "Session ".$panel->roundname %>
				</span>

				<span class="twotenths nospace">
					<a
						class = "buttonwhite redtext invert"
						href  = "student_vote.mhtml?entry_id=<% $entry->id %>&panel_id=<% $panel->id %>"
					>Vote Online</a>
				</span>
			</div>
<%perl>
 		}
		undef @panels;
 	}

	if (@strike_cards) {

</%perl>

		<div class="full ltborder">
			<span class="threefifths rightalign semibold bluetext">
<%perl>
				foreach my $strike_card (@strike_cards) {
					my $due = $strike_card->setting("strikes_due");
					$due->set_time_zone($tz) if $due;
</%perl>
					Strike card available for <% $strike_card->realname %>
					<% $due ? "Due by ".Tab::nicetime($due) : "" %>:
%				}
			</span>

			<span class="quarter centeralign">
				<a 	class="buttonwhite bluetext invert"
					href="/user/enter/strike_cards.mhtml"
				>
					Strike Card
				</a>
			</span>
		</div>
%	}

%	if (@flip_cards) {

		<div class="full ltborder">
			<span class="half rightalign semibold bluetext bigger">
<%perl>
				foreach my $flip_card (@flip_cards) {
					my $due = $flip_card->setting("flips_due");
					$due->set_time_zone($tz) if $due;
</%perl>
					Flip choice available for <% $flip_card->realname %> <br />
					<% $due ? "Due by ".Tab::nicetime($due) : "" %>
%				}
			</span>

			<span class="third centeralign">
				<a 	class="buttonwhite bluetext invert"
					href="/user/enter/flip.mhtml"
				>
					Choose Flips
				</a>
			</span>
		</div>
%	}

	<&
		"/funclib/tablesorter.mas",
		table     => $entry->id,
		nobuttons => 1
	&>

<%perl>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			entry.id, entry.code, entry.name,
			panel.id, panel.letter,
			flip_status.value,
			CONVERT_TZ(flip_at.value_date, '+00:00', tourn.tz),
			panel.bye, panel.flight,
			ballot.id, ballot.side, ballot.speakerorder, ballot.bye, ballot.forfeit, ballot.audit,
			round.id, round.name, round.label, round.type,
				round.published, round.post_primary, round.post_secondary, round.post_feedback, round.flighted,
				public_wins.value, public_points.value,
				entry_wins.value, entry_points.value,
			CONVERT_TZ(round.start_time, '+00:00', tourn.tz),
			CONVERT_TZ(round.start_time, '+00:00', person.tz),
			CONVERT_TZ(timeslot.start, '+00:00', tourn.tz),
			CONVERT_TZ(timeslot.start, '+00:00', person.tz),
			person.tz,
			tourn.tz, tourn.hidden,
			event.id, event.abbr, event.name, event.type,
			tourn.id, tourn.name,
			score.id, score.tag, score.value, score.speech,
			room.id, room.name, room.url, room.notes,
			judge.id, judge.code, judge.first, judge.last,
			student.id, student.first, student.last,
			scorestudent.id, scorestudent.first, scorestudent.last,
			judge.person, paradigm.id,
			ldparadigm.id, cxparadigm.id,
			jpool.id,
			flight_offset.value,
			opponent.code,
			aff_label.value,
			neg_label.value,
			online.value,
			online_mode.value,
			online_prep.value,
			no_side_constraints.value,
			sidelock_elims.value,
			include_room_notes.value,
			publish_prelim_chamber.value

		from (entry, event, tourn, entry_student es, student, person)

			left join ballot on entry.id = ballot.entry

			left join panel on panel.id = ballot.panel

			left join round on panel.round = round.id and round.event = event.id

			left join timeslot on timeslot.id = round.timeslot

			left join score on ballot.id = score.ballot

			left join student scorestudent on scorestudent.id = score.student

			left join room on panel.room = room.id

			left join judge on ballot.judge = judge.id

			left join panel_setting flip_at
				on flip_at.panel = panel.id
				and flip_at.tag = 'flip_at'

			left join panel_setting flip_status
				on flip_status.panel = panel.id
				and flip_status.tag = 'flip_status'

			left join person_setting paradigm
				on paradigm.person = judge.person
				and paradigm.tag = 'paradigm'

			left join judge_setting ldparadigm
				on ldparadigm.judge = judge.id
				and ldparadigm.tag = 'form_LDParadigm'

			left join judge_setting cxparadigm
				on cxparadigm.judge = judge.id
				and cxparadigm.tag = 'form_CXParadigm'

			left join event_setting nats_jpool
				on nats_jpool.event = event.id
				and nats_jpool.tag = 'nats_jpool'

			left join jpool on jpool.id = nats_jpool.value

			left join event_setting flight_offset
				on flight_offset.event = event.id
				and flight_offset.tag = 'flight_offset'

			left join event_setting aff_label
				on aff_label.event = event.id
				and aff_label.tag = 'aff_label'

			left join event_setting neg_label
				on neg_label.event = event.id
				and neg_label.tag = 'neg_label'

			left join event_setting online
				on online.event = event.id
				and online.tag = 'online'

			left join event_setting online_mode
				on online_mode.event = event.id
				and online_mode.tag = 'online_mode'

			left join event_setting online_prep
				on online_prep.event = event.id
				and online_prep.tag = 'online_prep'

			left join event_setting no_side_constraints
				on no_side_constraints.event = event.id
				and no_side_constraints.tag = 'no_side_constraints'

			left join event_setting sidelock_elims
				on sidelock_elims.event = event.id
				and sidelock_elims.tag = 'sidelock_elims'

			left join round_setting include_room_notes
				on include_room_notes.round = round.id
				and include_room_notes.tag = 'include_room_notes'

			left join round_setting public_wins
				on public_wins.round = round.id
				and public_wins.tag = 'public_wins'

			left join round_setting public_points
				on public_points.round = round.id
				and public_points.tag = 'public_points'

			left join round_setting entry_wins
				on entry_wins.round = round.id
				and entry_wins.tag = 'entry_wins'

			left join round_setting entry_points
				on entry_points.round = round.id
				and entry_points.tag = 'entry_points'

			left join round_setting publish_prelim_chamber
				on publish_prelim_chamber.round = round.id
				and publish_prelim_chamber.tag = 'publish_prelim_chamber'

			left join ballot oppballot
				on oppballot.panel = panel.id
				and oppballot.entry != entry.id

			left join entry opponent
				on opponent.id = oppballot.entry

		where entry.id = ?
			and person.id      = ?
			and student.person = person.id
			and student.id     = es.student
			and es.entry       = entry.id
			and entry.event    = event.id
			and event.tourn    = tourn.id
			and tourn.hidden   != 1
			and tourn.start    < now()
			and tourn.end      > now()

		order by event.abbr, entry.code, round.name desc, score.speech, ballot.audit
	");

	$sth->execute($entry->id, $person);

	my %current = ();

	while (
		my (
			$entry_id, $entry_code, $entry_name,
			$panel_id, $panel_letter, $panel_flip_status, $panel_flip_at, $panel_bye, $panel_flight,
			$ballot_id, $ballot_side, $ballot_speakerorder, $ballot_bye, $ballot_forfeit, $ballot_audit,
			$round_id, $round_name, $round_label, $round_type,
				$round_published, $post_primary, $post_secondary, $post_feedback, $round_flighted,
				$public_wins, $public_points,
				$entry_wins, $entry_points,
			$round_start_time,
			$my_round_start_time,
			$timeslot_start,
			$my_timeslot_start,
			$person_tz,
			$tourn_tz, $tourn_hidden,
			$event_id, $event_abbr, $event_name, $event_type,
			$tourn_id, $tourn_name,
			$score_id, $score_tag, $score_value, $score_speech,
			$room_id, $room_name, $room_url, $room_notes,
			$judge_id, $judge_code, $judge_first, $judge_last,
			$student_id, $student_first, $student_last,
			$scorestudent_id, $scorestudent_first, $scorestudent_last,
			$judge_person, $paradigm_id,
			$ldparadigm, $cxparadigm,
			$nats_jpool,
			$flight_offset,
			$opponent_code,
			$aff_label,
			$neg_label,
			$online,
			$online_mode,
			$online_prep,
			$no_side_constraints,
			$sidelock_elims,
			$include_room_notes,
			$publish_prelim_chamber
		) = $sth->fetchrow_array()
	) {

		unless ($round_published > 0
			|| ( $event_type eq "congress"
				&& $round_name == 1
				&& $publish_prelim_chamber == 1
			)
		) {
			next;
		}

		$current{$panel_id}{"round_number"} = $round_name;

		if ($publish_prelim_chamber) {
			$current{$panel_id}{"round_name"} = "Prelim Chamber";
		} elsif ($round_label) {
			$current{$panel_id}{"round_name"} = $round_label;
		} else {
			$current{$panel_id}{"round_name"} = "Round ".$round_name;
		}

		unless ($publish_prelim_chamber || $current{$panel_id}{"round_start"}) {

			if ($online && $person_tz && $person_tz ne $tourn_tz) {

				if ($round_start_time) {
					$current{$panel_id}{"round_start"} = $round_start_time;
					$current{$panel_id}{"my_round_start"} = $my_round_start_time;
				} else {
					$current{$panel_id}{"round_start"} = $timeslot_start;
					$current{$panel_id}{"my_round_start"} = $my_timeslot_start;
				}

				unless ($current{$panel_id}{"tourn_tz"}) {
					$current{$panel_id}{"tourn_tz"} = Tab::tzname($tourn_tz);
				}
				unless ($current{$panel_id}{"person_tz"}) {
					$current{$panel_id}{"person_tz"} = Tab::tzname($person_tz);
				}

			} else {

				if ($round_start_time) {
					$current{$panel_id}{"round_start"} = $round_start_time;
				} else {
					$current{$panel_id}{"round_start"} = $timeslot_start;
				}
			}
		}

		if ($current{$panel_id}{"not_done"}
			|| ($ballot_audit < 1)
		) {
			undef $post_primary;
			undef $post_secondary;
			undef $post_feedback;
			undef $current{$panel_id}{"post_primary"};
			undef $current{$panel_id}{"post_secondary"};
			undef $current{$panel_id}{"post_feedback"};
			$current{$panel_id}{"not_done"}++;
		}

		if ($online) {
			$current{$panel_id}{"online_mode"}  = $online_mode;
			$current{$panel_id}{"online_prep"}  = $online_prep;
			$current{$panel_id}{"post_primary"} = $post_primary;
			$current{$panel_id}{"room_name"}    = $room_name;
		} else {
			$current{$panel_id}{"room_name"} = $room_name;
			$current{$panel_id}{"room_url"}  = $room_url;

			if ($include_room_notes) {
				$current{$panel_id}{"room_notes"} = $room_notes;
			}
		}

		unless (
			$publish_prelim_chamber || $round_published == 2
		) {

			if ($judge_id > 0
				&& (not defined $current{$panel_id}{"judgenames"}{$judge_id})
			) {
				$current{$panel_id}{"judgenames"}{$judge_id} = $judge_last.", ".$judge_first;
			}

			if (
				$judge_id > 0
				&& $post_feedback > 1
				&& ($score_tag eq "rfd"|| $score_tag eq "comments" || $score_tag eq 'speech')
			) {
				$current{$panel_id}{"scores"}{$judge_id}{"rfd"}++;
			}
		}

		if ($event_type eq "speech") {

			$current{$panel_id}{"side_sort"} = $ballot_speakerorder;
			$current{$panel_id}{"order"}     = $ballot_speakerorder;

			if ($judge_id > 0) {

				if (
					$post_primary > 1 && $score_tag eq "rank"
				) {
					$current{$panel_id}{"scores"}{$judge_id}{$score_tag} = $score_value;
				}

				if (
					$post_secondary > 1
					&& $score_tag eq "point"
				) {
					$current{$panel_id}{"scores"}{$judge_id}{$score_tag} = $score_value;
				}
			}

		} elsif ($event_type eq "wudc") {

			$current{$panel_id}{"side_sort"} = $ballot_speakerorder;

			switch ($ballot_speakerorder) {
				case 1 { $current{$panel_id}{"side"} = "1G"; }
				case 2 { $current{$panel_id}{"side"} = "1O"; }
				case 3 { $current{$panel_id}{"side"} = "2G"; }
				case 4 { $current{$panel_id}{"side"} = "2O"; }
			}

			if ($judge_id > 0) {

				if (
					$post_primary > 1
					&& ($score_tag eq "rank" || $score_tag eq "winloss")
				) {
					$current{$panel_id}{"scores"}{$judge_id}{$score_tag} = $score_value;
				}

				if (
					$post_primary > 1
					&& $score_tag eq "point"
				) {

					$current{$panel_id}{"scores"}{$judge_id}{$score_tag} = $score_value;

					$current{$panel_id}{"students"}{$scorestudent_id}{"name"}
						= ucfirst(substr($scorestudent_first,0,1)).ucfirst(substr($scorestudent_last,0,1));
				}

			}

			if ($ldparadigm && $event_abbr eq "LD") {
				$current{$panel_id}{"nats_paradigm"}{$judge_id} = $nats_jpool;
			} elsif ($cxparadigm && $event_abbr eq "CX") {
				$current{$panel_id}{"nats_paradigm"}{$judge_id} = $nats_jpool;
			} elsif ($paradigm_id) {
				$current{$panel_id}{"paradigm"}{$judge_id} = $judge_person;
			}

		} elsif ($event_type eq "congress") {

			$current{$panel_id}{"letter"} = $panel_letter;

			if ($judge_id > 0) {

				if (
					$post_primary > 1 && $score_tag eq "rank"
				) {
					$current{$panel_id}{"scores"}{$judge_id}{"rank"} = $score_value;
				}

				if (
					$post_secondary > 1
					&& ($score_tag eq "speech" || $score_tag eq "point")
				) {
					if ($score_tag eq "speech") {

						if ($current{$panel_id}{"scores"}{$judge_id}{$score_tag}) {
							$current{$panel_id}{"scores"}{$judge_id}{$score_tag} .= ",";
						}

						$current{$panel_id}{"scores"}{$judge_id}{$score_tag} .= $score_value;

					} else {

						$current{$panel_id}{"scores"}{$judge_id}{$score_tag} = $score_value;
					}
				}

			}

		} elsif ($panel_bye) {

			$current{$panel_id}{"bye"}++;

		} else {

			$aff_label = "Aff" unless $aff_label;
			$neg_label = "Neg" unless $neg_label;

			if (
				($round_type eq "elim"
					&& (not defined $sidelock_elims))
				|| $no_side_constraints
			) {

				$is_pf = $no_side_constraints;

				if ($panel_flip_status eq "done" || $ballot_audit) {
					$current{$panel_id}{"order"} = $ballot_speakerorder;
					if ($ballot_side == 1) {
						$current{$panel_id}{"side"} = $aff_label;
					} elsif ($ballot_side == 2) {
						$current{$panel_id}{"side"} = $neg_label;
					}
				}

			} else {

				if ($ballot_side == 1) {
					$current{$panel_id}{"side"} = $aff_label;
				} elsif ($ballot_side == 2) {
					$current{$panel_id}{"side"} = $neg_label;
				}
			}

			$current{$panel_id}{"opponent"}  = $opponent_code;
			$current{$panel_id}{"side_sort"} = $ballot_side;

			unless ($round_published > 1) {
				if ($ballot_bye) {
					$current{$panel_id}{"bye"}++;
				} elsif ($ballot_forfeit) {
					$current{$panel_id}{"forfeit"}++;
				}
			}

			if ($judge_id > 0) {

				if (
					$post_primary > 1 && $score_tag eq "winloss"
				) {

					if ($score_value == 1) {
						$current{$panel_id}{"scores"}{$judge_id}{"winloss"} = "W";
					} else {
						$current{$panel_id}{"scores"}{$judge_id}{"winloss"} = "L";
					}
				}

				if (
					$post_secondary > 1
					&& ($score_tag eq "point" || $score_tag eq "rank" || $score_tag eq "refute")
				) {

					if ($scorestudent_id) {
						$current{$panel_id}{"scores"}{$judge_id}{$score_tag}{$scorestudent_id} = $score_value;
						$current{$panel_id}{"students"}{$scorestudent_id}{"name"}
							= ucfirst(substr($scorestudent_first,0,1)).ucfirst(substr($scorestudent_last,0,1));
					} else {
						$current{$panel_id}{"scores"}{$judge_id}{$score_tag}{"team"} = $score_value;
					}
				}
			}

			if ($ldparadigm && $event_abbr eq "LD") {
				$current{$panel_id}{"nats_paradigm"}{$judge_id} = $nats_jpool;
			} elsif ($cxparadigm && $event_abbr eq "CX") {
				$current{$panel_id}{"nats_paradigm"}{$judge_id} = $nats_jpool;
			} elsif ($paradigm_id) {
				$current{$panel_id}{"paradigm"}{$judge_id} = $judge_person;
			}

		}
	}

</%perl>

%	if (keys %current) {

		<div class="full nospace martopmore">

		<table id="<% $entry->id %>">
			<thead>
				<tr class="smallish semibold yellowrow">

					<th class="smallish">
						Round
					</th>

					<th class="smallish">
						Start
					</th>

					<th class="smallish">
						Room
					</th>

%					if ($event_type eq "speech") {
						<th class="smallish">
							Order
						</th>
%					} elsif ($event_type eq "congress") {
						<th class="smallish">
							Chamber
						</th>

%					} elsif ($event_type eq "wudc") {

						<th class="smallish">
							Position
						</th>

						<th class="smallish">
							Opponent
						</th>

%					} else {
						<th class="smallish">
							Side
						</th>

						<th class="smallish">
							Opponent
						</th>
%					}

					<th class="smallish nosort">
						<span class="threesevenths">
							Judges
						</span>
						<span class="threesevenths padleft">
							Results/Comments
						</span>
					</th>
				</tr>
			</thead>

			<tbody>
<%perl>

			foreach my $panel_id (
				sort {
					$current{$b}{"round_number"} <=> $current{$a}{"round_number"}
				} keys %current
			) {
</%perl>
				<tr class="row">

					<td class="smallish centeralign">
						<% $current{$panel_id}{"round_name"} %>
					</td>

					<td class="smallish leftalign">
						<span class="rightalign" style="min-width: 75%;">
%						if ($current{$panel_id}{"my_round_start"}) {

							<div class="nospace padvertless">
								<& "/funclib/showtime.mas",
									length      => "day",
									string      => $current{$panel_id}{"my_round_start"},
									add_minutes => ($current{$panel_id}{"flight_offset"}
													* ($current{$panel_id}{"panel_flight"} - 1))
								&>
								<% $current{$panel_id}{"person_tz"} %>
							</div>

							<div class="nospace padvertless">
								<& "/funclib/showtime.mas",
									length      => "shortish",
									string      => $current{$panel_id}{"round_start"},
									add_minutes => ($current{$panel_id}{"flight_offset"}
													* ($current{$panel_id}{"panel_flight"} - 1))
								&>
								<% $current{$panel_id}{"tourn_tz"} %>
							</div>

%						} else {

							<& "/funclib/showtime.mas",
								length      => "day",
								string      => $current{$panel_id}{"round_start"},
								add_minutes => ($current{$panel_id}{"flight_offset"}
												* ($current{$panel_id}{"panel_flight"} - 1))
							&>
%						}
						</span>
					</td>

					<td class="centeralign nospace padvertless limit3">
%						if ($current{$panel_id}{"online_mode"} eq "async") {
							Async Video
<%perl>
						} elsif (
							$current{$panel_id}{"online_mode"}
							&& ($current{$panel_id}{"post_primary"} < 1)
						) {

							my $current;

							if ($current{$panel_id}{"online_mode"} eq "sync") {
								$current = "fa_sm";
</%perl>
								<span class="twothirds">
									<% $current{$panel_id}{"room_name"} %>
								</span>
								<span class="quarter centeralign nospace">
%							}

							<& "/funclib/online_room.mas",
								panel  => $panel_id,
								person => $person,
								show   => 1,
								class  => $current
							&>

%							if ($current{$panel_id}{"online_mode"} eq "sync") {
								</span>
%							}

%						} else {
%							if ($current{$panel_id}{"room_url"}) {
								<span class="threequarters">
									<% $current{$panel_id}{"room_name"} %>
								</span>

								<span class="quarter centeralign nospace">
									<a
                                        class = "fa fa-map fa-sm buttonwhite bluetext"
                                        href  = "<% $current{$panel_id}{"room_name"} %>"
                                    ></a>
								</span>
%							} else {
								<% $current{$panel_id}{"room_name"} %>
%							}

%							if ($current{$panel_id}{"room_notes"}) {
								<span class="nospace martopless">
									<% $current{$panel_id}{"room_notes"} %>
								</span>
%							}
%						}
					</td>

%					if ($event_type eq "speech") {
						<td class="smallish centeralign">
							<% Lingua::EN::Numbers::Ordinate::ordinate($current{$panel_id}{"order"}) %>
						</td>
%					} elsif ($event_type eq "congress") {

						<td class="smallish centeralign semibold redtext">
							<% $current{$panel_id}{"letter"} %>
						</td>

%					} elsif ($event_type eq "wudc") {

						<td class="smallish centeralign">
							<% $current{$panel_id}{"side"} %>
						</td>

						<td class="smallish">
							<% $current{$panel_id}{"opponent"} %>
						</td>

%					} else {

						<td class="smallish centeralign">
							<% $current{$panel_id}{"side"} %>

%						if ($is_pf && $current{$panel_id}{"order"} > 0) {
							<span class="full nospace padless">
								<% Lingua::EN::Numbers::Ordinate::ordinate($current{$panel_id}{"order"}) %>
							</span>
%						}
						</td>

						<td class="smallish">
							<% $current{$panel_id}{"opponent"} %>
						</td>
%					}

					<td class="smallish nospace">
%						if ($current{$panel_id}{"bye"}) {
							<div class="nospace centeralign full semibold redtext">
								BYE
							</div>
%						} elsif ($current{$panel_id}{"forfeit"}) {
							<div class="nospace centeralign full semibold redtext">
								FORFEIT
							</div>
%						} else {

%							foreach my $jid (sort keys %{$current{$panel_id}{"judgenames"}}) {
%								my $scores = $current{$panel_id}{"scores"}{$jid};

								<div class="full nospace ltborderbottom resultsmin">

								<span
									class="<% $scores ? "threesevenths" : "full" %> nowrap padvertless marvertno padleftless smallish"
									title="<% $current{$panel_id}{"judgenames"}{$jid} %>"
								>
%									if ($current{$panel_id}{"nats_paradigm"}{$jid}) {
%										my $jpool = $current{$panel_id}{"nats_paradigm"}{$jid};
										<span class="fifth centeralign nospace" title="Nationals Paradigm">
											<a
												class  = "greytext buttonwhite smaller padmuchless marno"
												target = "_blank"
												href   = "/index/tourn/paradigm.mhtml?tourn_id=<% $tourn->id %>&judge_id=<% $jid %>&jpool_id=<% $jpool %>"
											>P</a>
										</span>
%									} elsif ($current{$panel_id}{"paradigm"}{$jid}) {
										<span class="fifth centeralign nospace" title="Paradigm">
											<a
												class  = "greytext buttonwhite smaller padmuchless marno"
												target = "_blank"
												href   = "/index/paradigm.mhtml?judge_person_id=<% $current{$panel_id}{"paradigm"}{$jid} %>"
											>P</a>
										</span>
%									} else {
										<span class="fifth centeralign nospace" title="Paradigm">
											&nbsp;
										</span>
%									}
									<% $current{$panel_id}{"judgenames"}{$jid} %>
								</span>

%								if ($scores) {
									<span class="ltborderright ltborderleft threesevenths nospace">
<%perl>
									if ($event_type eq "speech"
										|| $event_type eq "congress"
									) {
</%perl>
										<span class="sixth marno semibold centeralign">
											<% $current{$panel_id}{"scores"}{$jid}{"rank"} %>
										</span>

										<span class="twothirds nospace">
											<% $current{$panel_id}{"scores"}{$jid}{"point"} %>
										</span>

%									} elsif ($event_type eq "wudc") {

										<span class="sixth marno semibold centeralign">
											<% $current{$panel_id}{"scores"}{$jid}{"rank"} %>
										</span>

										<span class="twothirds nospace">
%											foreach my $sid (sort %{$current{$panel_id}{"students"}}) {
												<span class="full padvertless marno">
													<span class="half nospace">
														<% $current{$panel_id}{"students"}{$sid}{"name"} %>
													</span>
													<span class="half nospace">
														<% $current{$panel_id}{"scores"}{$jid}{"point"}{$sid} %>
													</span>
												</span>
%											}
										</span>

%									} else {

										<span class="sixth marno semibold centeralign nospace">
											<% $current{$panel_id}{"scores"}{$jid}{"winloss"} %>
										</span>

										<span class="fivesixths nospace rightalign">
%											if ($current{$panel_id}{"students"}) {
%												foreach my $sid (sort %{$current{$panel_id}{"students"}}) {
%													next unless ($current{$panel_id}{"scores"}{$jid}{"point"}{$sid}
%														|| $current{$panel_id}{"scores"}{$jid}{"rank"}{$sid});

													<span class="full padno padvertless leftalign marno nowrap">
														<span class="third padno marno smaller">
															<% $current{$panel_id}{"students"}{$sid}{"name"} %>
														</span>
														<span class="truethird nospace smaller">
															<% $current{$panel_id}{"scores"}{$jid}{"point"}{$sid} %>
														</span>
														<span class="truethird nospace">
															<% $current{$panel_id}{"scores"}{$jid}{"rank"}{$sid} %>
															<% $current{$panel_id}{"scores"}{$jid}{"refute"}{$sid} %>
														</span>
													</span>
%												}
%											}
										</span>
%									}
								</span>

%								if ($current{$panel_id}{"scores"}{$jid}{"rfd"}) {
									<span class="tenth centeralign">
										<a
											class  = "bluetext marno fa fa-tiny padmuchless fa-file-text-o block"
											target = "_blank"
											title  = "RFD, Comments and Feedback"
											href   = "/user/student/rfd_view.mhtml?entry_id=<% $entry->id %>&panel_id=<% $panel_id %>&judge_id=<% $jid %>"
										></a>
									</span>
%								}
%							}

							</div>
%						}
%						}
					</td>
				</tr>
%			}

			</tbody>
		</table>
		</div>
%	}
