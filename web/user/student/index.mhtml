<%args>
	$person
</%args>
<%init>

	my $now = DateTime->now();

	my @students;
	my @panels;
	my @done_panels;

	@students = Tab::Student->search( 
		person => $person->id 
	);

	my @current_entries = $m->comp(
		"/funclib/person_entries.mas", 
		person => $person, 
		present => 1
	);

	my @upcoming_entries = $m->comp(
		"/funclib/person_entries.mas", 
		person => $person, 
		future => 1
	);

	my %current = map {$_->id => 1} @current_entries;

	my @upcoming;

	foreach my $uc (@upcoming_entries) {
		next if $current{$uc->id};
		push @upcoming, $uc;
	}

	Tab::Tourn->columns(TEMP => "schoolid");

	Tab::Tourn->set_sql(signups => "
		select tourn.id, school.id as schoolid
		from tourn, school, school_setting, student
		where tourn.id = school.tourn
		and student.chapter = school.chapter
		and student.id = ? 
		and school.id = school_setting.school
		and school_setting.tag = 'signup_active'
	");


	my %done;

</%init>

	<& "/user/menu.mas", 
		whoami => "competitor", 
		person => $person,
	&>

	<div class="main">

%		if (@current_entries) { 

			<h4>Current Tournament</h4>

%			foreach my $entry (@current_entries) {

%				next if $done{$entry->event->tourn->id}++;

				<& "show_entry.mas",
					entry      => $entry,
					student_id => $entry->studentid,
					person     => $person
				&>
%			}

%		}

%		if (@upcoming) { 

			<span class="twothirds nospace martopmore">
				<h4>Upcoming Tournaments</h4>
			</span>

			<span 
				id="upcoming_buttonarea"
				class="third nospace rightalign">
			</span>

			<& 
				"/funclib/tablesorter.mas",
				table     => "upcoming"
			&>

			<table id="upcoming">

				<thead>

					<tr class="smallish semibold yellowrow">

						<th class="smallish">
							Tournament
						</th>

						<th class="smallish">
							Dates
						</th>

						<th class="smallish">
							Event
						</th>

						<th class="smallish">
							Info
						</th>

						<th class="smallish">
							Status
						</th>

						<th class="smallish">
						</th>

					</tr>

				</thead>

				<tbody>

<%perl>
				foreach my $entry (@upcoming) { 

					next if $done{$entry->event->tourn->id}++;

					my $event = $entry->event;
					my $tourn = $event->tourn;

					my $tz = $tourn->tz;
					$tz = "UTC" unless $tz;

					my $school = $entry->school;

					my $signup_deadline = $school->setting("signup_deadline");

					my $signup_active = $school->setting("signup_active");

					my $signup_memo = $school->files(type => "signup")->first;

</%perl>

					<tr id="<% $entry->id %>">

						<td>
							<div class="nowrap full nospace">
								<% $tourn->name %>
							</div>
							<div class="nowrap full nospace">
								<% $tourn->city %>
								<% $tourn->state ? $tourn->state : $tourn->country %>
							</div>
						</td>

						<td>
							<% 
								Tab::niceshortdayte($tourn->start->set_time_zone($tz)) 
							%><% 
								$tourn->start->day != $tourn->end->day 
									? "-".Tab::niceshortdayte($tourn->end->set_time_zone($tz)) 
									: ""
							%>
						</td>

						<td class="nospace centeralign">
							<a 
								class="plain full marno padmore hover" 
								target="_blank" 
								href="/index/tourn/events.mhtml?event_id=<% $event->id %>"
							><% $event->abbr %></a>
						</td>

						<td class="centeralign">
%							if ($signup_memo) { 
								<a class="fa fa-sm buttonwhite redtext fa-file-o"
									href="<% $Tab::s3_url."/".$tourn->id."/signups/".$school->id."/".$signup_memo->filename %>" 
								></a>
%							}
						</td>

						<td class="nospace centeralign">

%							if ($entry->unconfirmed) { 

								<span class="full marno redtext semibold">
									No Coach Approval
								</span>

%							} elsif ($entry->waitlist) { 

								<span class="full marno orangetext semibold">
									Waitlisted
								</span>

%							} elsif ($entry->dropped) { 

								<span class="full marno orangetext semibold">
									Dropped
								</span>

%							} elsif ($entry->active) { 

								<span class="full marno bluetext semibold">
									Confirmed!
								</span>

%							}
						</td>

						<td class="centeralign">

%							if ($signup_active && $entry->unconfirmed && $signup_deadline > $now) { 

%								my $warn = "This will drop your signup for this tournament.  Your partner(s), if any, will be notified as well.  You sure?";

                                <a 
                                    id            = "<% $entry->id %>"
                                    target_id     = "<% $entry->id %>"
									on_success    = "destroy"
									property_name = "<% $entry->studentid %>"
                                    onClick       = "postConfirm('<% $warn %>', this, 'drop_entry.mhtml');"
                                    class         = "buttonwhite fa-sm fa fa-arrow-down redtext hover"
                                    title         = "Drop This Entry"
                                >
                                </a>
%							}
						</td>

					</tr>
%				}

				</tbody>

			</table>

<%perl>

		}

		foreach my $student (sort {$b->grad_year <=> $a->grad_year} @students) { 

			next if $student->retired;

			my @signups = Tab::Tourn->search_signups($student->id);

			if (@signups) { 

</%perl>

			<span class="twothirds nospace martopmore">
				<h4><% $student->chapter->short_name %>'s Tournaments Open for Signup</h4>
			</span>

			<span 
				id    = "signups_buttonarea"
				class = "third nospace rightalign">
			</span>

			<& 
				"/funclib/tablesorter.mas",
				table     => "signups",
				nobuttons => 1
			&>

			<table id="upcoming">

				<thead>

					<tr class="smallish semibold yellowrow">

						<th class="smallish">
							Tournament
						</th>

						<th class="smallish">
							Dates
						</th>

						<th class="smallish">
							Signup Deadline
						</th>

						<th class="smallish">
							Events Offered
						</th>

						<th class="smallish">
							Info
						</th>

						<th class="smallish">
							Signup
						</th>

					</tr>

				</thead>

				<tbody>

<%perl>
				foreach my $tourn (@signups) { 

					my $tz = $person->tz;
					$tz = $tourn->tz unless $tz;
					$tz = "UTC" unless $tz;

					my $school = Tab::School->retrieve($tourn->schoolid);

					my $signup_deadline = $school->setting("signup_deadline");
					my $signup_active = $school->setting("signup_active");
					my $signup_memo = $school->files(type => "signup")->first;

</%perl>

					<tr id="<% $tourn->id %>">

						<td class="nospace">

							<a 	class  = "plain hover" 
								target = "_blank"
								href   = "/index/tourn/index.mhtml?tourn_id=<% $tourn->id %>"
							>
								<div class="nowrap full nospace padvertless limit2">
									<% $tourn->name %>
								</div>
								<div class="nowrap full nospace padvertless limit2">
									<% $tourn->city %>
									<% $tourn->state ? $tourn->state : $tourn->country %>
								</div>
							</a>
						</td>

						<td>
							<% 
								Tab::niceshortdayte($tourn->start->set_time_zone($tz)) 
							%><% 
								$tourn->start->day != $tourn->end->day 
									? " - ".Tab::niceshortdayte($tourn->end->set_time_zone($tz)) 
									: ""
							%>
						</td>

						<td>
							<% Tab::niceshortdayte($signup_deadline->set_time_zone($tz))  %>
							at <% Tab::shorttime($signup_deadline) %>
						</td>

						<td class="nospace centeralign limitless nospace smallish">
<%perl>						
							my $notfirst;

							foreach my $event ($tourn->events) { 
								$m->print(", ") if $notfirst++;
								$m->print($event->abbr);
							}

</%perl>						
						</td>

						<td class="centeralign">
%							if ($signup_memo) { 
								<a class="fa-sm fa buttonwhite redtext fa-file-o"
									href="<% $Tab::s3_url."/".$tourn->id."/signups/".$school->id."/".$signup_memo->filename %>" 
								></a>
%							}
						</td>

						<td class="centeralign nospace">
							<a class = "fa-sm fa buttonwhite bluetext fa-user-plus"
								href = "signup.mhtml?school_id=<% $school->id %>&student_id=<% $student->id %>"
							></a>
						</td>

					</tr>
%				}

				</tbody>

			</table>

<%perl>

			}

		}

		foreach my $student (sort {$b->grad_year <=> $a->grad_year} @students) { 
   
			my $ndt;

			if ($student->chapter) { 
				foreach my $circuit ($student->chapter->circuits) {
					$ndt++ if $circuit->id == 43;
				}
			}

</%perl>

			<a name="history"></a>

			<span class="fourfifths nospace martopmore">
				<h4>
					History at <% $student->chapter->short_name %>
				</h4>
			</span>

			<span 
				id    = "<% $student->id %>_buttonarea"
				class = "fifth rightalign nospace"
			>
			</span>
			
				<& "/funclib/tablesorter.mas", table => $student->id &>

				<table id="<% $student->id %>">

					<thead>

						<tr class="yellowrow">

							<th class="smaller">
								Tourn
							</th>

							<th class="smaller">
								Date
							</th>

							<th class="smaller">
								Code
							</th>

							<th class="smaller">
								Division
							</th>
							
							<th class="smaller">
								Results
							</th>


						</tr>

					</thead>

					<tbody>

<%perl>

					foreach my $entry (sort {$b <=> $a} $student->entries) { 

						next unless $entry->event && $entry->event->tourn;

						my $tourn = $entry->event->tourn;
						next if $tourn->end > $now;
						my $tz = $tourn->tz;
						$tz = "UTC" unless $tz;

</%perl>

						<tr>


							<td class="smaller nospace">
								<a 
									class  = "white full padvert"
									target = "_blank"
									href="history.mhtml?tourn_id=<% $tourn->id %><% $student->id ? "&student_id=$student->id" : ""%>">
									<% $tourn->name %>
								</a>
							</td>


							<td class="smaller">
								<% Tab::pickerdate($tourn->start->set_time_zone($tz)) %>
							</td>

							<td class="smaller nowrap">
								<% $entry->code %>
							</td>

							<td class="smaller">
								<% $entry->event->name %>
							</td>

							<td class="smallish centeralign nospace">
								<a 
									class  = "buttonwhite smallish bluetext padmore hover"
									target = "_blank"
									href   = "history.mhtml?tourn_id=<% $tourn->id %><% $student->id ? "&student_id=$student->id" : ""%>">
									See Results
								</a>
							</td>

						</tr>

%					}

					</tbody>

				</table>

<%perl>

				if ($ndt) { 

					my $ok++ if $student->person && $student->person->id == $person->id;

					foreach my $admin (
						$m->comp("/funclib/chapter_admins.mas", 
							chapter => $student->chapter
						)
					) { 
						$ok++ if $admin->id == $person->id;
					} 

					$ok++ if $person->site_admin;

					unless ($ok) { 
						my $err = "You do not have access to add honors to that debater record.";
						$m->redirect("/user/home.mhtml?err=$err");
					}

					my $tz = $person->tz;
					$tz = "UTC" unless $tz;

					my $now = DateTime->now->set_time_zone($tz);

					my $year = $now->year;
					$year-- if $now->month < 8;
					my $limit = $year."-07-01 00:00:00";

					Tab::Student->set_sql( partners => "
						select distinct student.*
						from student, entry_student es1, entry_student es2
						where es1.entry = es2.entry
						and es1.student = ?
						and es2.student = student.id
						and student.id != es1.student
						and es1.timestamp > ?
					");
</%perl>
					<h4><% $student->first." ".$student->last %> honors</h4>

					<div class="oddrow">

						<span class="threequarter smallish">
							Bid Sheet Honors
						</span>

						<span class="quarter rightalign">
							<a class="buttonwhite bluetext" 
								href="/user/chapter/ndt_bid_honors.mhtml?student_id=<% $student->id %>&chapter_id=<% $student->chapter %>">
								NDT Honors
							</a>
						</span>
					</div>

<%perl>
					my @partners = Tab::Student->search_partners( $student->id, $limit );
					my %partner_results = ();

					my @used_partners;

					foreach my $partner (@partners) { 

						Tab::Result->set_sql( honors => "
							select distinct result.*
							from result
							where honor is not null
							and student = ?
							and timestamp > ?
						");

						my @p_results = Tab::Result->search_honors( $partner->id, $limit );

						if (@p_results) { 
							push (@used_partners, $partner);
							@{$partner_results{$partner->id}} = @p_results;
						}
					}
</%perl>


%					foreach my $other (@partners) { 

						<br />

						<div class="evenrow">

							<span class="twothird">
								<h4>Partner: <% $other->first." ".$other->last %></h4>
							</span>

							<span class="third rightalign smallish">
								<a 
									class="buttonwhite bluetext" 
									href="/ndt/TeamBidSheet.php?id1=<% $other->id %>&id2=<% $student->id %>"
								>
									NDT Bid Sheet w/<% $other->last %>
								</a>
							</span>

						</div>

%					}

%				}

		
%			}

	</div>


