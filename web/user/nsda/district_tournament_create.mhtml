<%args>
	$person
	$person_settings
	$district_id => undef
	$name        => undef
	$city        => undef
	$state       => undef
</%args>
<%init>

	my $district = Tab::District->retrieve($district_id)
		if $district_id;

	$m->abort unless $district;

	my $permission = Tab::Permission->search(
		district => $district->id,
		person   => $person->id
	)->first;

	$permission++ if $person->site_admin;
	$permission++ if $person_settings->{"nsda_admin"};

	unless ($permission) {
		$m->print('<div class="main"><h4 class="warning">');
		$m->print("You do not have access to that district");
		$m->print('</h4></div>');
		$m->abort();
	}

	my @exists = $m->comp(
		"/funclib/district_tourns.mas",
		district => $district
	);

	my $existing = $exists[0] if @exists;

	my %questions = $m->comp("/funclib/districts_awards.mas");

	my $tz = $existing->tz if $existing;
	$tz = $person->tz unless $tz;
	$tz = "America/Chicago" unless $tz;

</%init>

	<div class="menu">

		<& "nsda_step.mas", step => 1 &>

		<div class="sidenote">

			<h5>Districts Signup Notes</h5>

			<p>
				This year, you should create a district tournament series
				within Tabroom whether or not you will be using it to tabulate.
				The Tabroom district listing will inform the NSDA Office of
				information we need to know about events, dates, and locations.
				Also, once your district tournament(s) are finished, you will
				upload results into Tabroom even if you tabulation on Joy of
				Tournaments.
			</p>

			<p>
				This process will streamline both Nationals registration, and
				will allow district chairs to confirm promotion of alternates
				for declined entries to Nationals.
			</p>

			<p>
				All districts on Tabroom will consist of one and only one
				master tournament.  You can configure a tournament to run on
				multiple weekends now to support that; the tournament will have
				separate dates, registration deadlines, etc for each weekend
				you run on.
			</p>


		</div>


	</div>

	<div class="main">

		<h2>Create a New District Tournament</h2>

		<form
			action = "district_tournament_create_events.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "district_id"
			value = "<% $district->id %>"
		>

		<h4>General Information</h4>

			<div class="row">

				<span class="third semibold bluetext">
					Time Zone
				</span>

				<span class="twothirds">

					<select
						name  = "tz"
						class = "fixed"
					>
						<&
							"/funclib/timezones.mas",
							country => "US",
							tz      => $tz
						&>
					</select>
				</span>

			</div>

			<h4>Dates/Weekends</h4>

			<p>
				If you don't know the precise dates of all your weekends, put
				in your best estimate; it can be changed later.  Dates must be
				finalized by Oct 31 if your district series starts in 2018 or
				Nov 30 if your district series starts in 2019.
			</p>

			<p>
				There's <span class="inline redtext semibold">
					no need to include your district name in the weekend label
				</span>
				; it will be included automatically.  Names like "IE
				&amp; Congress" or "Debate" are fine.
			</p>

%			my @weekends = $existing->weekends() if $existing;

%			foreach my $notch (1 .. 5) {

%				my $weekend = shift @weekends if @weekends;

				<div class="row">

					<span class="tenth semibold">
						<% $notch %>.
					</span>

					<span class="twofifths">
						<input
							type        = "text"
							name        = "name_<% $notch %>"
							size        = "32"
							placeholder = "Weekend Label (IE, Debate, Congress, etc)"
							value       = "<% $weekend ? $weekend->name : "" %>"
						>
					</span>

					<span class="fifth">

						<& "/funclib/datepicker.mas", id => "start_".$notch &>

						<input
							name        = "start_date_<% $notch %>"
							type        = "text"
							id          = "start_<% $notch %>"
							size        = 12
							placeholder = "Start Date"
							value       = "<% $weekend ? Tab::pickerdate($weekend->start) : "" %>"
						>
					</span>

					<span class="fifth">

						<& "/funclib/datepicker.mas", id => "end_".$notch &>

						<input
							name        = "end_date_<% $notch %>"
							type        = "text"
							id          = "end_<% $notch %>"
							size        = 12
							placeholder = "End Date"
							value       = "<% $weekend ? Tab::pickerdate($weekend->end) : "" %>"
						>
					</span>

				</div>
%			}

			<h4 class="martopmore">Rules</h4>

			<div class="nospace">

				<p>
					The software you choose  must be used for all events of the
					district tournament series.
				</p>

				<p>
					At the conclusion of the district tournament series,
					you will be responsible for uploading any results from
					JOT or Speechwire to Tabroom.  We'll provide
					instructions on how to do so.
				</p>

				<div class="full redtext semibold centeralign">
					Remember: scheduling &amp; tabbing by hand is no longer an
					option for Districts
				</div>

				<p>
					The NSDA is continuting to pilot a simplified version of
					the district tournament series in 2019-2020.
				</p>

				<p>
					The format of these rules is designed to more closely
					follow those of a traditional tournament, to be more
					familiar to coaches and students, and therefore easier to
					run.  Districts can pilot the speech, debate, or Congress
					method, or any combination of the three.
				</p>

				<p>
					If you elect to use the rules be aware that some additional
					setup may be required on the software of your choice.  The
					pilot manual is available at
					<a
						class = "bluetext semibold inline"
						href  = "https://www.speechanddebate.org/pilot-district-qualification-manual"
					>https://www.speechanddebate.org <span class='fa fa-sm fa-share-square inline'></span></a>.
				</p>

			</div>

			<script>
				function checkSpeech() {

					if ($("#nsda_pilot_speech").prop('checked')) {

						$(".ierules").addClass("hidden");

						if ($("#nsda_pilot_debate").prop('checked')) {
							if ($("#nsda_pilot_congress").prop('checked')) {
								$("#speechwire").prop("disabled", false);
							} else {
								$("#speechwire").prop("checked", false);
								$("#speechwire").prop("disabled", true);
							}
						} else {
							$("#speechwire").prop("checked", false);
							$("#speechwire").prop("disabled", true);
						}
					} else {
						$(".ierules").removeClass("hidden");
						$("#speechwire").prop("checked", false);
						$("#speechwire").prop("disabled", true);
					}
				}

				function checkTabroom() {
					if ($("#tabroom").prop('checked')) {
						$(".tabroom_first").removeClass("hidden");
					} else {
						$(".tabroom_first").addClass("hidden");
					}
				}

				$(document).ready(function() {
					checkSpeech();
					checkTabroom();
				});

			</script>

			<div class="row">

				<span class="quarter semibold redtext padvertmore marvertmore">
					Use Pilot District Rules:
				</span>

				<label for="nsda_pilot_speech">
					<span class="hover quarter">
						<input
							type  = "checkbox"
							name  = "nsda_pilot_speech"
							id    = "nsda_pilot_speech"
							value = "1"
							<% $existing && $existing->setting("nsda_pilot_speech")
								? 'checked="checked"'
								: ""
							%>
							onChange = "checkSpeech();";
						> Speech
					</span>
				</label>

				<label for="nsda_pilot_debate">
					<span class="hover quarter">
						<input
							type  = "checkbox"
							name  = "nsda_pilot_debate"
							id    = "nsda_pilot_debate"
							value = "1"
							<% $existing && $existing->setting("nsda_pilot_debate")
								? 'checked="checked"'
								: ""
							%>
							onChange = "checkSpeech();";
						> Debate
					</span>
				</label>

				<label for="nsda_pilot_congress">
					<span class="hover quarter">
						<input
							type  = "checkbox"
							name  = "nsda_pilot_congress"
							id    = "nsda_pilot_congress"
							value = "1"
							<% $existing && $existing->setting("nsda_pilot_congress")
								? 'checked="checked"'
								: ""
							%>
							onChange = "checkSpeech();";
						> Congress
					</span>
				</label>

			</div>

			<div class="row">

				<span class="quarter semibold bluetext padvertmore marvertmore">
					Tabbing Software
				</span>

				<label for="tabroom">
					<span class="quarter leftalign hover">
						<input
							type    = "radio"
							name    = "nsda_tabbing_software"
							id      = "tabroom"
							value   = "tabroom"
							<% $existing && $existing->setting("nsda_tabbing_software") ne "jot"
								? 'checked="checked"'
								: ""
							%>
							onChange = "checkTabroom();";
						> Tabroom.com
					</span>
				</label>

				<label for="jot">
					<span class="quarter leftalign hover">
						<input
							type    = "radio"
							name    = "nsda_tabbing_software"
							id      = "jot"
							value   = "jot"
							<% $existing && $existing->setting("nsda_tabbing_software") eq "jot"
								? 'checked="checked"'
								: ""
							%>
							onChange = "checkTabroom();";
						> Joy of Tournaments
					</span>
				</label>

				<label for="speechwire">
					<span class="quarter leftalign hover speechwire">
						<input
							type    = "radio"
							name    = "nsda_tabbing_software"
							id      = "speechwire"
							value   = "speechwire"
							disabled
							<% $existing && $existing->setting("nsda_tabbing_software") eq "speechwire"
								? 'checked="checked"'
								: ""
							%>
						> Speechwire.com*
					</span>
				</label>

			<div class="row ierules">

				<span class="quarter semibold bluetext padvertmore marvertmore">
					IE Ruleset
				</span>

				<label for="doubledown">

					<span class="quarter leftalign hover">
						<input
							type  = "radio"
							name  = "nsda_speech_method"
							id    = "doubledown"
							value = "doubledown"
							<% $existing && $existing->setting("nsda_speech_method") eq "doubledown"
								? 'checked="checked"'
								: ""
							%>

						>Double Downs
					</span>

				</label>

				<label for="california_3">

					<span class="quarter leftalign hover">

						<input
							type  = "radio"
							name  = "nsda_speech_method"
							id    = "california_3"
							value = "california_3"
							<% $existing && $existing->setting("nsda_speech_method") eq "california_3"
								? 'checked="checked"'
								: ""
							%>
						>CA Plan w/3 judges

					</span>

				</label>

				<label for="california_2">

					<span class="quarter leftalign hover marno">

						<input
							type  = "radio"
							name  = "nsda_speech_method"
							id    = "california_2"
							value = "california_2"
							<% $existing && $existing->setting("nsda_speech_method") eq "california_2"
								? 'checked="checked"'
								: ""
							%>
						>CA Plan w/2 judges

					</span>
				</label>
			</div>

			<label for="nsda_tabroom_first">
				<div class="row tabroom_first hidden hover">

					<span class="threequarters semibold">
						Is this your first time using Tabroom for districts?
					</span>

					<span class="quarter leftalign hover">

						<input
							type  = "checkbox"
							name  = "nsda_tabroom_first"
							id    = "nsda_tabroom_first"
							value = 1
							<% $existing && $existing->setting("nsda_tabroom_first")
								? 'checked="checked"'
								: ""
							%>
						> Yes
					</span>
				</div>
			</label>

			<p class="centeralign graytext semibold italic">
				* Speechwire is available only if you select Pilot Rules in all
				three event types.
			</p>

			<h5>Pilot Competition Rules</h5>

			<p class="semibold bluetext martopmore">
				Pilot Internet Rules
			</p>

			<p>
				The revised internet rules are still available as an optional pilot
				in 2019-2020.  A copy is available on
				<a href="https://www.speechanddebate.org/pilot-internet-rules/"
				   target="_blank"
				   class="bluetext semibold"
				>https://www.speechanddebate.org <span class='fa fa-sm fa-share-square inline'></span></a>.

			<div class="row">

				<span class="quarter semibold redtext marvertmore">
					<a
						href   = "https://www.speechanddebate.org/pilot-internet-rules/"
						target = "_blank"
					>Use Pilot Internet Rules</a>
				</span>

				<label for="nsda_internet_extemp">
					<span class="hover quarter">
						<input
							type  = "checkbox"
							name  = "nsda_internet_extemp"
							id    = "nsda_internet_extemp"
							value = "1"
							<% $existing && $existing->setting("nsda_internet_extemp")
								? 'checked="checked"'
								: ""
							%>
							onChange = "checkSpeech();";
						>
						Extemp
					</span>
				</label>

				<label for="nsda_internet_debate">
					<span class="hover quarter">
						<input
							type  = "checkbox"
							name  = "nsda_internet_debate"
							id    = "nsda_internet_debate"
							value = "1"
							<% $existing && $existing->setting("nsda_internet_debate")
								? 'checked="checked"'
								: ""
							%>
							onChange = "checkSpeech();";
						>
						Debate
					</span>
				</label>

				<label for="nsda_internet_congress">
					<span class="hover quarter">
						<input
							type  = "checkbox"
							name  = "nsda_internet_congress"
							id    = "nsda_internet_congress"
							value = "1"
							<% $existing && $existing->setting("nsda_internet_congress")
								? 'checked="checked"'
								: ""
							%>
							onChange = "checkSpeech();";
						>
						Congress
					</span>
				</label>

			</div>

			<p class="semibold bluetext martopmore">
				Pilot Congress Time Limits
			</p>

			<p>
				New for 2019-2020: Optional pilot rules are available that limit the
				amount of time spent on each piece of legislation to 1/3 of the
				total floor time in the session.   For more details, see the
				<a class='semibold inline bluetext'
					target="_blank"
					href="https://www.speechanddebate.org/wp-content/uploads/HS-Unified-Manual-2019-2020.pdf"
				>HS Unified Manual <span class='fa fa-sm fa-share-square inline'></span></a> on page 34.
			</p>

			<label for="nsda_congress_timelimits">
				<div class="even hover">

					<span class="half semibold redtext">
						Use Pilot Congress Time Limits
					</span>

					<span class="quarter leftalign">
						<input
							type  = "checkbox"
							name  = "nsda_congress_timelimits"
							id    = "nsda_congress_timelimits"
							value = 1
							<% $existing && $existing->setting("nsda_congress_timelimits")
								? 'checked="checked"'
								: ""
							%>
						> Yes
					</span>
				</div>
			</label>

			<h4 class="martopmore">Orders</h4>

%			foreach my $key (sort keys %questions) {

%				next unless $questions{$key}{'short'} eq "Ext";
				<div class="row">

					<span class="threefifths">
						<% $questions{$key}{"text"} %>
					</span>

					<label for="<% $questions{$key}{"label"} %>_yes">
						<span class="fifth hover marno">
							<input
								type  = "radio"
								id    = "<% $questions{$key}{"label"} %>_yes"
								name  = "<% $questions{$key}{"label"} %>"
								value = "1"
								<% $existing && $existing->setting($questions{$key}{"label"})
									? 'checked="checked"'
									: ""
								%>
							> Yes
						</span>
					</label>

					<label for="<% $questions{$key}{"label"} %>_no">
						<span class="fifth hover marno">
							<input
								type  = "radio"
								id    = "<% $questions{$key}{"label"} %>_no"
								name  = "<% $questions{$key}{"label"} %>"
								value = "0"
								<% $existing && $existing->setting($questions{$key}{"label"})
									? ""
									: 'checked="checked"'
								%>
							> No
						</span>
					</label>
				</div>
%			}

%			foreach my $event ("CX", "LD", "PF") {

				<div class="row">
					<span class="threefifths">
						<% $event %> Debate Ballots
					</span>

					<span class="twofifths">
						Number required:
						<input
							type  = "number"
							name  = "<% $event %>_ballots"
							size  = 8
						>
					</span>
				</div>
%			}

			<h5>District Awards</h5>

%			foreach my $key (sort keys %questions) {

%				next if $questions{$key}{'short'} eq "Ext";

				<span class="pagehalf borderbottom">

					<span class="threefifths">
						<% $questions{$key}{"text"} %>
					</span>

					<label for="<% $questions{$key}{"label"} %>_yes">
						<span class="fifth hover">
							<input
								type  = "radio"
								id    = "<% $questions{$key}{"label"} %>_yes"
								name  = "<% $questions{$key}{"label"} %>"
								value = "1"
								<% $existing && $existing->setting($questions{$key}{"label"})
									? 'checked="checked"'
									: ""
								%>
							> Yes
						</span>
					</label>

					<label for="<% $questions{$key}{"label"} %>_no">
						<span class="fifth hover">
							<input
								type  = "radio"
								id    = "<% $questions{$key}{"label"} %>_no"
								name  = "<% $questions{$key}{"label"} %>"
								value = "0"
								<% $existing && $existing->setting($questions{$key}{"label"})
									? ""
									: 'checked="checked"'
								%>
							> No
						</span>
					</label>
				</span>
%			}

			<p class="semibold redtext padtop">
				Where should qualifying award plaques, the above awards, and/or ballots be shippped?
			</p>

			<div class="martopmore padtopmore padbottommore ltbordertop even">
				<span class="third nospace">
				</span>
				<span class="twothirds nospace">
					<input
						type		= "text"
						name		= "address_name"
						size		= "64"
						value	   = "<% $person->first." ".$person->last %>"
						placeholder = "Name"
					>
				</span>

				<span class="third nospace">
				</span>
				<span class="twothirds nospace">
					<input
						type		= "text"
						name		= "address_street"
						size		= "64"
						value	   = "<% $person->street %>"
						placeholder = "Street"
					>
				</span>

				<span class="third nospace bigger redtext semibold centeralign">
				</span>
				<span class="twothirds nospace">
					<input
						type        = "text"
						name        = "address_street2"
						size        = "64"
						placeholder = "Street Cont'd"
					>
				</span>

				<span class="third nospace">
				</span>
				<span class="quarter nospace">
					<input
						type        = "text"
						name        = "address_city"
						size        = "32"
						value       = "<% $person->city %>"
						placeholder = "City"
					>
				</span>

				<span class="fifth nospace">
					<select name="address_state" class="fixedsmall">
						<& "/funclib/state_select.mas",
							state   => $person->state,
							country => "US"
						&>
					</select>
				</span>

				<span class="fifth nospace">
					<input
						type        = "text"
						name        = "address_zip"
						size        = "16"
						value       = "<% $person->zip ? sprintf("%05d", $person->zip) : $person->postal %>"
						placeholder = "Zip/Postal"
					>
				</span>

				<span class="third nospace">
				</span>
				<span class="twothirds nospace">
					<select name="address_country" class="fixedbig">
						<& "/funclib/country_select.mas",
							country => $person->country
						&>
					</select>
				</span>

			</div>

			<div class="liblrow rightalign">
				<input
					type  = "submit"
					value = "Step Two: Assign Events to Dates"
				>
				</form>
			</div>
	</div>
