<%args>
	$person
	$district_id => undef
	$name        => undef
	$city        => undef
	$state       => undef
	$tz          => undef
</%args>
<%init>

	my $district = Tab::District->retrieve($district_id) if $district_id;

	$m->abort unless $district;

	my $permission = Tab::Permission->search( 
		district => $district->id,
		person   => $person->id 
	)->first;

	unless ($permission) { 
		$m->print('<div class="main"><h4 class="warning">');
		$m->print("You do not have access to that district");
		$m->print('</h4></div>');
	}

	unless ($person->setting("nsda_beta")) { 

		$m->print('<div class="main"><h4 class="warning">');
		$m->print("You do not have access to create a district tournament on Tabroom.  Yet.");
		$m->print('</h4></div>');

	}

	Tab::Site->set_sql( by_admin => "
		select site.*
		from site, tourn_site, permission
		where site.id = tourn_site.site
		and tourn_site.tourn = permission.tourn
		and permission.person = ? 
	");

	Tab::Site->set_sql( by_membership => "
		select site.*
		from site, circuit, chapter_circuit, chapter
		where site.circuit = circuit.id
		and circuit.id = chapter_circuit.circuit
		and chapter_circuit.chapter = chapter.id
		and chapter.district = ?
	");

	my @sites = Tab::Site->search_by_admin($person->id);
	push @sites, Tab::Site->search_by_membership($district->id);

	my %seen;
	@sites = grep { ! $seen{$_->id} ++ } @sites;
	@sites = sort {$a->name cmp $b->name} @sites;

	my @existing = $m->comp("/funclib/district_tourns.mas", 
		district => $district
	);

	my %events_done;

	my $event_ref = {

		"HOU" => { name => "House"  , code => "HOU" , type => "congress" } ,
		"SEN" => { name => "Senate" , code => "SEN" , type => "congress" } ,

		"CX"  => { name => "Policy"          , code => "CX" , type  => "debate" } ,
		"LD"  => { name => "Lincoln Douglas" , code => "LD" , type  => "debate" } ,
		"PF"  => { name => "Public Forum"    , code => "PF" , type  => "debate" } ,

		"IX"  => { name => "International Extemp"   , code => "IX"  , type => "speech" } ,
		"UX"  => { name => "US Extemp"              , code => "UX"  , type => "speech" } ,
		"DI"  => { name => "Dramatic Interp"        , code => "DI"  , type => "speech" } ,
		"HI"  => { name => "Humorous Interp"        , code => "HI"  , type => "speech" } ,
		"DUO" => { name => "Duo Interp"             , code => "DUO" , type => "speech" } ,
		"OO"  => { name => "Original Oratory"       , code => "OO"  , type => "speech" } ,
		"POI" => { name => "Programmed Oral Interp" , code => "POI" , type => "speech" } ,
		"INF" => { name => "Informative Speaking"   , code => "INF" , type => "speech" }
	};

	my %events = %{$event_ref};

	my @types = ("congress", "debate", "speech");

	my $speech_method;

</%init>

	<div class="menu">

%		if (@existing) { 

			<div class="sidenote">

			<h4>Existing Districts</h4>

%			foreach my $existing (@existing) {  

%				$speech_method = $existing->setting("nsda_speech_method");

%				unless ($existing->hidden) { 
%					foreach my $event ($existing->events) { 
%						$events_done{$event->abbr}++;
%					}
%				}


				<div class="lightrow full">

					<span class="fourfifths">
						<div class="full marless padno">
							<% $existing->name %>
							<% $existing->hidden ? "TEST" : "" %>
						</div>

						<div class="full marless padno">
							<% Tab::niceshortdayte($existing->start) %>
							<% Tab::niceshortdayte($existing->end) %>
						</div>
					</span>

					<span class="fifths">
						<a 
							class="fa buttonwhite fa-lg greentext fa-edit"
							href="/user/tourn/select.mhtml?tourn_id=<% $existing->id %>">
						</a>
					</span>

				</div>

%			}


			</div>
%		}

	
	</div>

	<div class="main">

		<h3>Create a New District Tournament</h3>

		<form 
			action = "district_tournament_save.mhtml"
			method = "post"
		>

		<input 
			type  = "hidden"
			name  = "district_id"
			value = "<% $district->id %>"
		>

		<h4>General Information</h4>

			<div class="lightrow">

				<span class="third ">
					Tournament Name
				</span>

				<span class="twothirds">
					<input 
						type = "text"
						name = "name"
						size = "48"
						value= "<% $name ? $name : $district->name." District Tournament" %>"
					>
				</span>

			</div>

			<div class="lightrow">

				<span class="third ">
					Location
				</span>

				<span class="twothirds">
				
					<span class="half">

						City
						<input 
							type = "text"
							name = "city"
							size = "12"
							value= "<% $city %>"
						>
					</span>

					<span class="half">

						State:
					
						<select 
							name  = "state"
							class = "fixedsmall"
						>

							<& 
								"/funclib/state_select.mas", 
								country => "US",
								state   => $state
							&>

						</select>
					</span>
				</span>

			</div>

			<div class="lightrow">

				<span class="third ">
					Time Zone
				</span>

				<span class="twothirds">
				
					<select 
						name  = "tz"
						class = "fixed"
					>

						<& 
							"/funclib/timezones.mas", 
							country => "US",
							tz      => $tz
						&>

					</select>
				</span>

			</div>

			<h4>Tournament Host Site</h4>

            <div class="full lightrow">

                <span class="third ">
					Existing site:
                </span> 

				<span class="twothirds">

					<select 
						name  = "site_id"
						class = "fixedbig"
					>
				
						<option value=""></option>

%						foreach my $site (@sites) {
							<option value="<% $site->id %>"> <% $site->name %> </option>
%                   	}

					</select>
				</span>

			</div>

            <div class="full lightrow">

                <span class="third ">
					Or, a new location:
                </span>

                <span class="twothird ">
					<input 
						type        = "text"
						name        = "site_name"
						size        = "48"
						value       = ""
						placeholder = 'e.g. "Lexington HS" or "University of Massachusetts"'
					>
				</span>
            </div>


		<h4>Dates & Deadlines</h4>

			<div class="lightrow">
			
				<span class="third ">
					Tournament Starts
				</span>

				<span class="third">

					<& "/funclib/datepicker.mas", id => "start" &>

					Date:
					<input 
						name = "start_date"
						type = "text"
						id   = "start"
						size = 12
					>
				</span>

				<span class="third">
					Time:
					<& "/funclib/timepicker.mas", 
						name => "start_time",
						size => 6,
					&>
				</span>

				<span class="third">
					
					Tournament Ends

				</span>

				<span class="third">

					<& "/funclib/datepicker.mas", id => "end" &>

					Date:

					<input 
						name = "end_date"
						type = "text"
						id   = "end"
						size = 12 
					>
				</span>

				<span class="third">
					Time:

					<& "/funclib/timepicker.mas", 
						name => "end_time",
						size => 6,
					&>
				</span>

			</div>

			<div class="lightrow">
			
				<span class="third ">
					Registration Opens
				</span>

				<span class="third">

					<& "/funclib/datepicker.mas", id => "reg_start" &>

					Date:

					<input 
						name = "reg_start"
						type = "text"
						id   = "reg_start"
						size = 12
					>
				</span>

				<span class="third">

					Time:

					<& "/funclib/timepicker.mas", 
						name => "reg_start_time",
						size => 6,
					&>

				</span>

			
				<span class="third ">
					Registration Due
				</span>

				<span class="third">

					<& "/funclib/datepicker.mas", id => "reg_end" &>

					Date:

					<input 
						name = "reg_end"
						type = "text"
						id   = "reg_end"
						size = 12
					>
				</span>

				<span class="third">

					Time:

					<& "/funclib/timepicker.mas", 
						name => "reg_end_time",
						size => 6,
					&>

				</span>

			</div>

			<div class="lightrow">
			
				<span class="third ">
					Drop &amp; Name Change Deadline
				</span>

				<span class="third">

					<& "/funclib/datepicker.mas", id => "drop_end" &>

					Date:

					<input 
						name = "drop_end"
						type = "text"
						id   = "drop_end"
						size = 12
					>
				</span>

				<span class="third">

					Time:

					<& "/funclib/timepicker.mas", 
						name => "drop_end_time",
						size => 6,
					&>

				</span>

			</div>

			<div class="lightrow">
			
				<span class="third ">
					Judge Deadline
				</span>

				<span class="third">

					<& 
						"/funclib/datepicker.mas", 
						id => "judge_end" 
					&>

					Date:

					<input 
						name = "judge_end"
						type = "text"
						id   = "judge_end"
						size = 12
					>
				</span>

				<span class="third">

					Time:

					<& 
						"/funclib/timepicker.mas", 
						name => "judge_end_time",
						size => 6,
					&>

				</span>

			</div>

			<div class="lightrow">
			
				<span class="third ">
					Obligations Freeze 
				</span>

				<span class="third">

					<& 
						"/funclib/datepicker.mas", 
						id => "freeze_end" 
					&>

					Date:

					<input 
						name = "freeze_end"
						type = "text"
						id   = "freeze_end"
						size = 12
					>
				</span>

				<span class="third">

					Time:

					<& "/funclib/timepicker.mas", 
						name => "freeze_end_time",
						size => 6,
					&>

				</span>

			</div>

			<h4>Events Held</h4>

			<script>

				function unHide(type, eventID) { 
					if ($("#"+eventID).prop("checked")) { 
						$(".hide"+type).removeClass('hidden');
					}
				}

				function clickCategory(type) { 
					if ($("#"+type).prop("checked")) { 
						$("."+type).prop("checked", true);
						$(".hide"+type).removeClass('hidden');
					} else {
						$("."+type).prop("checked", false);
						$(".hide"+type).addClass('hidden');
					}
				}

			</script>

%			foreach my $type (@types) { 

				<span class="third top">

					<div class="full nospace">

						<span class="twothirds">
							<h5>
								<% ucfirst($type) %>
							</h5>
						</span>

						<label for="<% $type %>">
							<span class="third hover centeralign">
								All: 
								<input 
									type    = 'checkbox'
									id      = "<% $type %>"
									onclick = "clickCategory('<% $type %>');"
								>
							</span>

						</label>

					</div>

%					foreach my $key (keys %events) { 

%						next if $events{$key}{"type"} ne $type;

						<label for="<% $events{$key}{"code"} %>">

							<div class="lightrow full hover">

								<span class="quarter nospace">

%									my $class;

%									if ($events_done{$key}) { 

%										$class = "greentext";

										<a 
											class="buttonwhite fa fa-sm fa-check greentext"
											title="A district tournament for this event is already scheduled"
										>
										</a>

%									} else { 

										<input 
											type    = "checkbox"
											name    = "<% $events{$key}{"code"} %>"
											value   = "1"
											class   = "<% $type %>"
											id      = "<% $events{$key}{"code"} %>"
											onclick = "unHide('<% $type %>', '<% $events{$key}{"code"} %>');"
										>
%									} 
								</span>

								<span class="threequarters nospace <% $class %>">
									<% $events{$key}{"name"} %>
								</span>
							</div>

						</label>

%					}

				</span>

%			}

			<h4>Judges</h4>

			<div class="lightrow hidespeech hidden">

				<span class="third">
					Speech Judge Obligation
				</span>

				<span class="twothirds">

					One judge per

					<input 
						type = "number"
						name = "speechjudges"
						min  = 0
						max  = 99
					>
					entries

				</span>

			</div>

			<div class="lightrow hidedebate hidden">

				<span class="third">
					Debate Judge Obligation
				</span>

				<span class="twothirds">

					One judge per

					<input 
						type = "number"
						name = "debatejudges"
						min  = 0
						max  = 99
					>
					entries
				</span>

			</div>

			<div class="lightrow hidecongress hidden">

				<span class="third">
					Congress Judge Obligation
				</span>

				<span class="twothirds">
					One judge per

					<input 
						type = "number"
						name = "congressjudges"
						min  = 0
						max  = 99
					>
					entries
				</span>
			</div>

			<div class="hidespeech">
				<h4>Rules</h4>
			</div>

			<div class="lightrow hidespeech hidden">

				<span class="third">
					IE Ruleset
				</span>

				<span class="twothird nospace">

					<label for="doubledrop">
				
						<span class="half hover">

							<input 
								type  = "radio"
								name  = "nsda_speech_method"
								id    = "doubledrop"
								value = "doubledrop"
								<% $speech_method ? 
									$speech_method eq "doubledrop" ? 
									'disabled checked="checked"' : "disabled"
									: 'checked="checked"'
								%>	
							>Double Drop

						</span>

					</label>

					<label for="california">

						<span class="half hover">

							<input 
								type  = "radio"
								name  = "nsda_speech_method"
								id    = "california"
								value = "california"
								<% $speech_method ? 
									$speech_method eq "california" ? 
									'disabled checked="checked"' : "disabled"
									: ""
								%>
							>California Plan

						</span>

					</label>

					<label for="california_twojudges">

						<span class="half hover">

							<input 
								type  = "radio"
								name  = "nsda_speech_method"
								id    = "california_twojudges"
								value = "california_twojudges"
								<% $speech_method ? 
									$speech_method eq "california_twojudges" ? 
									'disabled checked="checked"' : "disabled"
									: ""
								%>
							>California Plan w/2 judges

						</span>

					</label>

				</span>

			</div>

			<div class="lightrow">

				<span class="third">
					Test Tournament
				</span>

				<label for="hidden">
					<span class="twothirds hover">

						<input 
							type  = "checkbox"
							name  = "hidden"
							id    = "hidden"
							value = "1"
						> Will not be publicly available

					</span>
				</label>

			</div>


			<div class="lightrow">

				<span class="third">
					Double Entry
				</span>

				<span class="twothirds">
					By default, double entry is allowed to the extent of NSDA
					rules.  If your district has further double entry
					restrictions, set them up under Setup -&gt; once your
					tournament is finished. 
				</span>

			</div>


			<div class="liblrow rightalign">
				<input 
					type  = "submit"
					value = "Create District Tournament"
				>

				</form>
			</div>

	</div>
