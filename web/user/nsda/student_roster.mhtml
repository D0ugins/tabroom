<%args>
	$person
	$session
	$chapter_id
	$tourn_id => undef
</%args>
<%init>

	use Tab::NSDA::MemberSchool;
	use Tab::NSDA::Person;
	use Tab::NSDA::Login;
	use Tab::NSDA::PersonSchool;

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	my %student_settings = $m->comp(
		"/funclib/chapter_student_settings.mas", 
		chapter => $chapter
	);

	my $tourn = Tab::Tourn->retrieve($tourn_id) if $tourn_id;

    my $nsda_deadline;

	if ($tourn) { 
		my $tz = $tourn->tz;
		$tz = "UTC" unless $tz;
		$nsda_deadline = $tourn->start;
	    $nsda_deadline->set_time_zone($tz);
		$nsda_deadline->subtract( days => 7 );
	}

	my $ok;
	$ok++ if $person->site_admin;
	foreach my $admin ($chapter->admins) { 
		$ok++ if $admin->id == $person->id;
	}
	
	unless ($ok) { 
		$m->print("<div class='blankfull'>You have no access to that school.</div>");
		$m->abort;
	}

	my $now = DateTime->now;
	my $grad_year_limit = $now->year;
	$grad_year_limit++ if $now->month > 8;

    my @students = Tab::Student->search_where( 
		chapter   => $chapter->id,
		retired   => 0,
		grad_year => { ">=", $grad_year_limit}
	);

    @students = sort {$a->last cmp $b->last} @students;

	# sorts already linked people to the bottom;
    @students = sort {length($a->nsda) <=> length($b->nsda)} @students;  

	Tab::NSDA::Person->set_sql( students => "
		select distinct NEW_USERS.* 
		from NEW_USERS, NEW_USERS_TO_SCHOOLS
		where NEW_USERS_TO_SCHOOLS.school_id = ? 
		and NEW_USERS_TO_SCHOOLS.ualt_id = NEW_USERS.ualt_id
		and (
			NEW_USERS.utype = 'Student' 
			or NEW_USERS.utype = 'MIDStudent' 
			or NEW_USERS.utype = 'PKDStudent'
		)
		and NEW_USERS_TO_SCHOOLS.enddate = '0000-00-00 00:00:00'
		and NEW_USERS.grad_yr >= ? 
		order by NEW_USERS.ulname, NEW_USERS.ufname
	");

	my @nsda_students = Tab::NSDA::Person->search_students( $chapter->nsda, $grad_year_limit );

	my %student_mid = map {$_->ufname." ".$_->umname." ".$_->ulname => $_->user_id} @nsda_students;

	my %student_name = map {$_->ufname." ".$_->ulname => $_->user_id} @nsda_students;

	my %student_by_user_id = map {$_->user_id => $_} @nsda_students;

	my %used_students = map {$_->nsda => 1} @students;
	
</%init>

%	if ($tourn) { 

		<div class="blankfull">

			<span class="threequarters">
				<h2>Student eligbility to compete in districts:</h2>
			</span>

			<span class="quarter rightalign">
				<a 
					href  = "/user/enter/students.mhtml?chapter_id=<% $chapter->id %>&tourn_id=<% $tourn_id %>"
					class = "buttonwhite bluetext hover"
				>
					Return to Districts
				</a>
				<a 
					href  = "/user/chapter/nsda_chapter_fix.mhtml?chapter_id=<% $chapter->id %>&tourn_id=<% $tourn_id %>"
					class = "buttonwhite greentext hover"
				>
					Sync NSDA records
				</a>
			</span>

%	} else {

		<& "menu.mas", 
			chapter => $chapter, 
			person => $person, 
			whoami => "link" 
		&>

		<div class="main">

			<h2><% $chapter->name %></h2>

			<& "/user/chapter/tabbar.mas", 
				chapter => $chapter,
				person  => $person,
				session => $session,
				whoami  => "students"
			&>

			<h4>Match Names &amp; Link Students</h4>

			<span class="fourfifths">
				If the student you're looking for does not appear on this page, please use the 
				<span class="inline redtext semibold">"Import NSDA roster to Tabroom.com"</span> 
				function found to the right.
			</span>
			<span 
				class="fifth rightalign"
				id="roster_buttonarea"
			>
			</span>

%	}

		<& "/funclib/tablesorter.mas", table => "roster" &>

		<form action="student_link.mhtml" method="post">

		<input 
			type  = "hidden"
			name  = "chapter_id"
			value = "<% $chapter_id %>"
		>

		<input 
			type  = "hidden"
			name  = "tourn_id"
			value = "<% $tourn_id %>"
		>

		<table id="roster">

			<thead>
				<tr class="smallish yellowrow">

					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						Grad
					</th>

%					if ($tourn) { 
	
						<th>
							Reason Ineligible
						</th>
	
%					} else { 
						<th>
							NSDA Student
						</th>
%					}


					<th>
					</th>

				</tr>
			</thead>

			<tbody>

%				my $notfirst;
%				foreach my $student (@students) { 
%					if ($student->nsda) { 
%						unless ($notfirst++) { 
							<tr class="liblrow">
								<td colspan="5" class="rightalign">
									<input type="submit" value="Save Links">
								</td>
							</tr>
%						}
%					}

					<tr 
						class="smallish"
					>

						<td
							title="<% $student->id %>"
						>
							<% $student->first %>
						</td>

						<td>
							<% $student->last %>
						</td>

						<td>
							<% $student->grad_year %>
						</td>

						<td>

%							my $checked;
%							if ($student->nsda) { 
%								my $nsda_student = $student_by_user_id{$student->nsda};
%								if ($nsda_student) { 

									<span class="fifth">
										#<% $nsda_student->user_id %>
									</span>

%									if ($tourn) { 

										<span 
											class = "fifth hover"
											title = "Student must earn 25 points for 1 degree"
										>


%											if ($student_settings{$student->id}{"nsda_points"} > 24) { 
												<span class="fa fa-lg fa-check greentext"></span>
%											} else { 
												<span class="fa fa-lg fa-times redtext"></span>
%											} 
											<% $student_settings{$student->id}{"nsda_points"} %> Points
										</span>

										<span 
											class = "quarter hover"
											title = "This requirement may be waived by request to the NSDA office"
										>
%											if ($student_settings{$student->id}{"nsda_joined"} < $nsda_deadline) { 
												<span class="fa fa-lg fa-check greentext"></span>
%											} else { 
												<span class="fa fa-lg fa-times redtext"></span>
%											} 
											Joined by <% Tab::shortdate($nsda_deadline) %>
										</span>

										<span 
											class = "fifth hover"
											title = "Fix this by having the student create a login on the NSDA website and link them"
										>
%											if ($student_settings{$student->id}{"student_email"}) { 
												<span class="fa fa-lg fa-check greentext"></span>
%											} else { 
												<span class="fa fa-lg fa-times redtext"></span>
%											} 
											Email/Star
										</span>

										<span 
											class="sixth hover"
											title = "Student must have paid their lifetime membership fee; pay via the points system"
										>
%											if ($student_settings{$student->id}{"nsda_paid"}) { 
												<span class="fa fa-lg fa-check greentext"></span>
%											} else { 
												<span class="fa fa-lg fa-times redtext"></span>
%											} 
											Paid Fee
										</span>



%									} else { 
										<span class="fourtenths">
											<% $nsda_student->ufname." ".$nsda_student->umname." ".$nsda_student->ulname %>
										</span>

										<span class="eighth">
											'<% $nsda_student->grad_yr %>
										</span>

										<span class="sixth">
											<% int($nsda_student->total_pts) %> pts
										</span>
%									}

%								}

%							} else { 

%								my $name = $student->first;
%								$name .= " ".$student->middle if $student->middle;
%								$name .= " ".$student->last;


%								if ($tourn) { 
									<span class="twofifths redtext biggish strong">
										<span class="fa fa-lg fa-times"></span>
										No NSDA Linked Member:
									</span>
%								}

								<select name="student_<% $student->id %>" class="fixedbig">

									<option value=""></option>

<%perl>

									foreach my $nsda_student (@nsda_students) { 

										next if $used_students{$nsda_student->user_id};

										my $nsda_name = $nsda_student->ufname;
										$nsda_name .= " ".$nsda_student->umname if $nsda_student->umname;
										$nsda_name .= " ".$nsda_student->ulname;

										my $selected;

										$selected++ if $student_name{$name} == $nsda_student->user_id;
										$selected++ if $student_mid{$name} == $nsda_student->user_id;

										$checked++ if $selected;

</%perl>

										<!-- student name is <% $name %> and name is <% $student_name{$name} %> -->
										<!-- selected is <% $selected %>-->


										<option 
											value="<% $nsda_student->user_id %>" 
											<% $selected ? 'selected="selected"' : "" %>
										>#<% $nsda_student->user_id %> <% $nsda_name %>
											<% $nsda_student->grad_yr %>
										</option>
%									}
									<option value="">Do not link</option>
								</select>
%							}
						</td>

						<td class="nospace">

%							if ($student->nsda) { 

%								my $warn = "Doing this will disable auto-posting points for this competitor.  Are you sure?";

								<label for="delink_<% $student->id %>">

									<span class="full redhover nowrap centeralign marno">

										Delink: 
											<input 
												type  = "checkbox"
												value = "1"
												id    = "delink_<% $student->id %>"
												name  = "delink_<% $student->id %>"
												<& "/funclib/warn.mas", warn => $warn &>
											>
									</span>

								</label>

%							} else {

								<label for="confirm_<% $student->id %>">

									<span class="full hover nowrap centeralign marno">

										Confirm:
											<input 
												type    = "checkbox"
												value   = "1"
												id      = "confirm_<% $student->id %>"
												name    = "confirm_<% $student->id %>"

												<% $checked ? 'checked="true"' : "" %>
											>
									</span>
								</label>
%							}
						</td>

					</tr>

%				}

			</tbody>

			<tr class="liblrow">

				<td colspan="5" class="rightalign">
					<input type="submit" value=" Link Students ">
					</form>
				</td>

			</tr>

		</table>

	</div>
