<%args>
	$school_id   => undef
	$category_id => undef
	$judge_id    => undef
</%args>
<%init>

	my $judge;
	my $school;
	my $category;

	my %judge_settings;

	if ($judge_id) {
		$judge = Tab::Judge->retrieve($judge_id);
		%judge_settings = $judge->all_settings() if $judge;
	}

	if ($school_id) {
		$school = Tab::School->retrieve($school_id);
	}

	if ($judge) {
		$category = $judge->category();
		$school = $judge->school() unless $school;
	} elsif ($category_id) {
		$category = Tab::Category->retrieve($category_id);
	}

	unless ($category) {
		my $err = "Something went wrong: no valid judge or judge category sent?";
		$m->redirect("judges.mhtml?school_id=".$school->id."&err=$err");
	}

	my $district = $school->district;
	my $tourn = $school->tourn;

	Tab::ChapterJudge->columns(TEMP => "chaptername");

	Tab::ChapterJudge->set_sql( district_judges => "
		select distinct chapter_judge.*, chapter.name as chaptername
		from chapter_judge, chapter
		where chapter_judge.chapter = chapter.id
		and chapter_judge.retired != 1
		and chapter.district = ?
		and not exists (
			select distinct judge.id
			from judge, category
			where category.tourn = ?
			and category.id = judge.category
			and judge.chapter_judge = chapter_judge.id
		)
		order by chapter.name, chapter_judge.last
	");

	my $original_school;
	$original_school = $judge->setting("original_school") if $judge;

</%init>

	<div class="menu">

		<div class="sidenote">

			<h4>Judging</h4>

			<a
				href="wsdc_judge_edit.mhtml?school_id=<% $school->id %>&category_id=<% $category->id %>"
				class="full blue martop marbottom"
			>Add another judge</a>

			<a
				href="/user/nsda/district.mhtml?district_id=<% $district->id %>"
				class="full blue martop marbottom"
			>Return to District Registration</a>

		</div>

%		if ($judge) {

%			if ($judge_settings{"incomplete"}) {

				<div class="sidenote">

					<p class="semibold marbottom redtext bigger centeralign">
						Registration Incomplete:
					</p>

					<% $judge_settings{"incomplete"} %>

				</div>
%			}

			<div class="sidenote">

				<h4>Questionnaires</h4>

				<p class="semibold">
					These questionnaires may be filled out by the judges themselves
					if you have them linked to a Tabroom.com account, or you can
					fill them out here.
				</p>

				<div class="nospace martopmore">
					<span class='half nospace'>
						<h6>Demographics</h6>
					</span>
					<span class='half bigger italic rightalign semibold bluetext'>
						Optional
					</span>
				</div>


				<p class="explain smaller marno marbottom">
					In order to assess and promote diversity in judging panels,
					we request all judges fill out the diversity questionnaire.
				</p>

				<div class="centeralign nospace">
					<a
						href="questionnaire.mhtml?school_id=<% $school->id %>&judge_id=<% $judge->id %>&tag=NSDADiversity"
						class="buttonwhite bluetext invert bigger"
						target="_blank"
					>Diversity Questionnaire</a>
				</div>

			</div>

%		}

	</div>


	<div class="main">

		<span class="threequarters nospace">
			<h5><% $judge
				? $judge->first." ".$judge->last
				: "Add a judge"
			%></h5>
		</span>

		<span class="quarter rightalign bluetext semibold">
			<% $category->name %>
		</span>

		<form action="wsdc_judge_save.mhtml" method="post">

		<input
			type  = "hidden"
			name  = "judge_id"
			value = "<% $judge %>"
		>

		<input
			type  = "hidden"
			name  = "school_id"
			value = "<% $school->id %>"
		>

		<input
			type  = "hidden"
			name  = "category_id"
			value = "<% $category->id %>"
		>

		<span class="pagehalf">

%			unless ($judge) {
				<div class="row centeralign redtext semibold padvertoption">
					For a judge not in Tabroom:
				</div>
%			}

			<div class="row">

				<span class="fifth semibold padleftmore">
					First
				</span>

				<span class="threequarters">
					<input
						type  = "text"
						name  = "first"
						size  = "32"
						value = "<% $judge ? $judge->first : "" %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="fifth semibold padleftmore">
					Last
				</span>

				<span class="threequarters">
					<input
						type  = "text"
						name  = "last"
						size  = "32"
						value = "<% $judge ? $judge->last : "" %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="fifth semibold padleftmore">
					Phone
				</span>

				<span class="threequarters">
					<input
						type  = "tel"
						name  = "phone"
						size  = "32"
						value = "<% $judge && $judge->person
								? Tab::phoneme($judge->person->phone)
								: Tab::phoneme($judge_settings{"phone"}) %>"
					>
				</span>
			</div>

			<div class="row">

				<span class="fifth semibold padleftmore">
					Email
				</span>

				<span class="threequarters">
					<input
						type  = "email"
						name  = "email"
						size  = "32"
						value = "<% $judge && $judge->person
								? $judge->person->email
								: $judge_settings{"email"} %>"
					>
				</span>
			</div>

		</span>

		<span class="pagehalf">

%			unless ($judge) {
				<div class="row centeralign redtext semibold padvertoption">
					Or, select all that apply to this judge:
				</div>
%			}

			<div class="row">

				<span class="third semibold padleft">
					Tabroom judge
				</span>

				<span class="twothirds centeralign">

					<select
						name  = "chapter_judge_id"
						class = "fixedbiggish"
					>

					<option value=""></option>
					<option value="0">None</option>

%					if ($judge) {
						<option
							value="<% $judge->id %>"
							selected="selected"
						><% $judge->first." ".$judge->last %> <% $judge->chapter_judge->chapter->name %></option>
%					}

%					foreach my $chapter_judge (
%						Tab::ChapterJudge->search_district_judges($district->id, $tourn->id)
%					) {

						<option
							value="<% $chapter_judge->id %>"
							<% $judge
								&& $chapter_judge->id == $judge->chapter_judge->id
								? 'selected="selected"'
								: ""
						%>><% $chapter_judge->first." ".$chapter_judge->last %> - <% Tab::short_name($chapter_judge->chaptername) %></option>
%					}

					</select>
				</span>

			</div>

			<div class="row">

				<span class="third semibold padleft">
					NSDA Coach:
				</span>

				<span class="twothirds centeralign">

					<select
						name  = "nsda"
						class = "fixedbiggish"
					>
						<option value=""></option>
						<option value="0">None</option>

%						if ($judge && $judge->setting("nsda")) {
							<option
								selected="selected"
								value="<% $judge->setting("nsda") %>"
							><% $judge->first." ".$judge->last %> (#<% $judge->setting("nsda") %>)</option>
<%perl>
						}

                        my $district_coachref = $m->comp(    
                            "/funclib/nsda/district_coaches.mas",    
                            district => $district,    
                            tourn    => $tourn    
                        );    

						my @district_coaches = eval { 
							return @{$district_coachref};
						};
    
                        foreach my $coach (@district_coaches) {    

							next unless $coach->{"role"} eq "Coach";
</%perl>
							<option
								value="<% $coach->{person_id} %>"
								<% $judge
									&& $judge->chapter_judge
									&& $judge->chapter_judge->nsda == $coach->{person_id}
									? 'selected="selected"'
									: ""
								%>
							><% $coach->{first}." ".$coach->{last} %> (ID #<% $coach->{person_id} %>)</option>
%						}

					</select>
				</span>
			</div>

			<div class="row">
				<span class="third semibold padleft">
					Tabroom email:
				</span>

				<span class="twothirds centeralign">
					<input
						type        = "email"
						name        = "tabroom_email"
						size        = "32"
						placeholder = "Email used for a Tabroom.com account"
						value = "<% $judge && $judge->person
							? $judge->person->email
							: ""
						%>"
					>
				</span>
			</div>

%			if ($judge_settings{"diamonds"} || $judge_settings{"tab_room"}) {
				<div class="row semibold centeralign padsetting">
%					if ($judge_settings{"diamonds"}) {
						<span class='half nospace bluetext'>
							<% $judge_settings{"diamonds"} %>
							<% $judge_settings{"diamonds"} > 1 ? "Diamonds" : "Diamond" %> coach
						</span>
%					}
%					if ($judge_settings{"tab_room"}) {
						<span class='half nospace purpletext'>
							Tab Room Staff
						</span>
%					}
				</div>
%			}

		</span>

		<div class="full row marvertno">

			<span class="quarter bluetext semibold">
				School affiliation:
			</span>

			<span class="threequarters">

				<select name="original_school_id" class="fixedbig">

					<option value=""></option>
					<option value="0">None</option>

%					foreach my $school ($tourn->schools(district => $district->id)) {
%						next unless $school->chapter > 0;
						<option
							value="<% $school->id %>"
							<% $school->id == $original_school ? "selected" : "" %>
						><% $school->short_name %></option>
%					}
				</select>

			</span>

		</div>


%		if ($judge) {

			<div class="full row marvertno">

			<label for="diverse">
				<span class="half hover nospace">

					<span class="fourfifths semibold">
						Identify as a diversity-enhancing judge
					</span>

					<span class="sixth centeralign">
						<input
							type  = "checkbox"
							name  = "diverse"
							value = "1"
							id    = "diverse"
							<% $judge->setting("diverse")
								? 'checked="checked"'
								: ""
							%>
						>
					</span>
				</span>
			</label>

			</div>
%		}

		<div class="full libl rightalign marvertno">
			<input
				type="submit"
				value="<% $judge ? "Save Judge" : "Add Judge" %>"
			>
		</div>


	</div>

	<script>

		function revealOptions() {

			$(".options").addClass("hidden");

			$(".jpools:checked").each(function(jpoolbox) {

				console.log("One is checked: "+this.id);

				$("."+this.id).removeClass('hidden');
			});

		}

		$(document).ready(function() {
			revealOptions();
		});

	</script>
