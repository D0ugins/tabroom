<%args>
	$person
	$person_settings
	$district
	$chapter    => undef
	$default    => undef
</%args>
<%init>

	my $now = DateTime->now;

	my $school_year_start = $now->year;
	$school_year_start-- if $now->month < 8;

	my $chapter_id;
	$chapter_id = $chapter->id if $chapter;

	my $tz = $person->tz;
	$tz = "UTC" unless $tz;
	$now->set_time_zone($tz);

	my %committee;
	my $is_chair;
	my $is_member;
	my @tabs;

	%committee = $m->comp(
		"/funclib/district_committee.mas",
		district => $district
	);

	@tabs = ("district");

	foreach my $role ("chair", "member", "alternate") {
		next unless $committee{$role};
		foreach my $member (@{$committee{$role}}) {
			if ($member->id == $person->id) {
				$is_chair++ if $role eq "chair";
				$is_member++;
			}
		}
	}

	$is_member++ if $person_settings->{"nsda_admin"};
	$is_member++ if $person->site_admin;

	my $nationals = $m->comp("/funclib/current_nationals.mas");
	undef $nationals if $nationals && $nationals->reg_start > $now;
	my %links;

	my %order = (
		district  => 1,
		nationals => 2,
		judges    => 3
	);

	if ($nationals) {

		$default = "nationals" unless $default;
		push @tabs, "nationals";

		if ($is_chair) {
			$links{"judges"} = "/user/nsda/district_judge_noms.mhtml?chapter_id=".$chapter_id."&district_id=".$district->id;
		}
	}

	$default = "district" unless $default;

	if ($default eq "judges") {
		$links{"district"} = "/user/chapter/nsda.mhtml?chapter_id=".$chapter_id."&default=district";
		$links{"nationals"} = "/user/chapter/nsda.mhtml?chapter_id=".$chapter_id."&default=nationals";
		undef @tabs;

	}

	my @tourns = $m->comp(
		"/funclib/district_tourns.mas",
		district => $district
	);

	my $tourn = shift @tourns if @tourns;
	my $create;

	$create++ if $is_chair;
	undef $create if $tourn;
	$create++ if $person_settings->{"nsda_admin"};
	$create++ if $person->site_admin;

	my $open_setting = Tab::TournSetting->search(
		tourn => 0,
		tag => "nsda_district_open"
	)->first;

	my $deadline_setting = Tab::TournSetting->search(
		tourn => 0,
		tag => "nsda_district_deadline"
	)->first;


	my $open = $open_setting->value_date() if $open_setting;
	my $deadline = $deadline_setting->value_date() if $deadline_setting;

	my $first_year;
	my $second_year;

	if ($open) {
		$first_year = $open->year;
		$second_year = $first_year++;
	}

</%init>

	<div class="full nospace borderbottom">

		<span class="threefifths bluetext padtopmore">
			<h4 class="nospace">
				National Speech &amp; Debate Association
			</h4>
		</span>

		<span class = "twofifths rightalign nospace">
% 	   		unless ( (scalar @tabs) + (scalar(keys %links)) < 2) {
				<&
					"/funclib/tabs.mas",
						tabs    => \@tabs,
						links   => \%links,
						order   => \%order,
						default => $default,
						right   => "yes",
						buttons => "yes",
				&>
%	       	}
		</span>
	</div>

%	return if $default eq "judges";

	<div class="screens district">

<%perl>

		if ($chapter) {

			my %chapter_settings = $chapter->all_settings();

</%perl>

			<span class="pagehalf">

				<h5>
					Your NSDA Member School
				</h5>

				<div class="row padless">

					<span class="half semibold">
						Strength
					</span>

					<span class="half">
						<% $chapter_settings{"nsda_strength"} %>
					</span>

				</div>

				<div class="row padless">

					<span class="half semibold">
						<% $school_year_start."-".($school_year_start + 1) %> Status
					</span>

					<span class="fifth">
						<% $chapter_settings{"nsda_paid"} ? "Paid" : "Unpaid" %>
					</span>

					<span class="fifth">
						<% $chapter_settings{"nsda_charter"} ? "Charter" : "" %>
					</span>

				</div>

%				if ($chapter->level eq "highschool") {

					<div class="row padless">
						<span class="half semibold">
							District
						</span>

						<span class="half">
							#<% $district->code %> <% $chapter->district->name %>
						</span>
					</div>

					<div class="row padless">
						<span class="half semibold">
							District Level
						</span>

						<span class="half">
							<% $district->level %>
						</span>
					</div>
%				}
			</span>

			<span class="pagehalf">
%		}

		<h5>
			District Committee
		</h5>

<%perl>

		foreach my $role ("chair", "member", "alternate") {

			next unless $committee{$role};

			foreach my $member (@{$committee{$role}}) {
</%perl>

				<div class="row padless">

					<span class="quarter semibold">
						<% ucfirst($role) %>
					</span>

					<span class="half">
						<% $member->first." ".$member->last %>
					</span>

					<span class="quarter nospace rightalign">
						<a
							href  = "mailto:<% $member->email %>"
							class = "buttonwhite bluetext smaller fa-sm fa fa-envelope marno"
							title = "Email <% $member->email %>"
						>
						</a>
					</span>

				</div>
%			}
%		}

%		if ($chapter) {
			</span>
%		}

		</span>

<%perl>

		if ($tourn) {

			my $school =  Tab::School->search(
				chapter => $chapter->id,
				tourn   => $tourn->id
			)->first if $chapter;

			my @weekends = $tourn->weekends();

			my $is_open;

			foreach my $weekend (@weekends) {
				$is_open++ if $weekend->reg_start < $now
						&& $now < $weekend->reg_end;
			}

</%perl>

			<div class="full nospace martopmuchmore">
				<span class="threequarters nospace">
					<h5 class="martopmore">
						<% $tourn->name %>
					</h5>
				</span>

				<span class="quarter true rightalign nospace">
%				 	if ($school) {
						<a
							class = "bluetext buttonwhite invert smallish marno"
							href  = "/user/enter/entry.mhtml?school_id=<% $school->id %>"
						>Your Districts Registration</a>
%					} elsif ($is_open && $chapter && $tourn) {
						<a
							class = "greentext buttonwhite invert smallish marno"
							href="/user/enter/create.mhtml?chapter_id=<% $chapter->id %>&tourn_id=<% $tourn->id %>"
						>Register for Districts</a>
%					}
				</span>
			</div>
<%perl>

			foreach my $weekend ($tourn->weekends()) {

				my $start = $weekend->start->set_time_zone($tourn->tz);
				my $end = $weekend->end->set_time_zone($tourn->tz);

				my $reg_start = $weekend->reg_start->set_time_zone($tourn->tz);
				my $reg_end = $weekend->reg_end->set_time_zone($tourn->tz);

				my %weekend_events = ();

				foreach my $event (sort {$a->abbr cmp $b->abbr} $tourn->events) {
					push @{$weekend_events{$event->setting("weekend")}}, $event;
				}
</%perl>

				<div class="row padless marno">

					<span class="sixth nospace padleft semibold bluetext">
						<div class="full nospace padvert">
							<% $weekend->name %>
						</div>
					</span>

					<span class="third nospace topalign">
						<div class="full nospace padvert">
							<% $weekend->site ? $weekend->site->name : $weekend->city %>
						</div>
						<div class="full marno padless">
							<% Tab::niceshortdayte($start) %>
							<% $end->day != $start->day ? "&ndash; ".Tab::niceshortdayte($end) : ""%>
						</div>
					</span>

					<span class="threetenths nospace topalign">
						<p class="semibold nospace">
							Registration
						</p>
						<div class="full marno padless smallish">
							<span class="third nospace">
								Opens
							</span>
							<% Tab::niceshortdt($reg_start) %>
						</div>
						<div class="full marno padless smallish">
							<span class="third nospace">
								Due
							</span>
							<% Tab::niceshortdt($reg_end) %>
						</div>
					</span>

					<span class="quarter nospace topalign">
						<p class="semibold nospace">
							Events Offered
						</p>

						<div class="full marno padless">
%							foreach my $event (@{$weekend_events{$weekend->id}}) {
								<span class="padless">
									<% $event->abbr %>
								</span>
%							}
						</div>
					</span>
				</div>
%			}
%		}

	</div>

	<div class="screens committee padtopmore">

%		if ($now < $open) {

			<h5 class="ltbordertop">
				District Tournament Series
			</h5>

			<p class="bigger semibold redtext centeralign">
				Registration for the District Tournament Series begins on
				<& "/funclib/showdate.mas",
					dt => $open
				&> at <& "/funclib/showtime.mas",
					dt      => $open,
					tz      => "America/Chicago",
					show_tz => 1
				&>
			</p>

%		} elsif ($now > $deadline) {

%		} elsif ($create) {
			
			<h5 class="ltbordertop">
				Create District Tournament Series
			</h5>

%			$deadline->subtract(days => 1);

			<p class="bigger semibold centeralign half">
				District Tournament Series info is due by <br />

				<span class="inline redtext">
					<& "/funclib/showdate.mas",
						dt => $deadline
					&>
					at <& "/funclib/showtime.mas",
						dt      => $deadline,
						tz      => "America/Chicago",
						show_tz => 1
					&>
				</span>

				<br />if your tournament series will be held in
				<span class="inline redtext">
					<% $second_year %>
				</span>
			</p>

%			$deadline->subtract(months => 1);

			<p class="bigger semibold half centeralign">

				District Tournament Series info is due by <br />

				<span class="inline redtext">
					<& "/funclib/showdate.mas", dt => $deadline &>
					at
					<& "/funclib/showtime.mas",
						dt      => $deadline,
						tz      => "America/Chicago",
						show_tz => 1
					&>
				</span>


				<br />if your tournament series will be held in
				<span class="inline redtext">
					<% $first_year %>
				</span>
			</p>

			<div class="row centeralign padvertmore">
				<a
					class = "buttonblue"
					href  = "/user/nsda/district_tournament_create.mhtml?district_id=<% $district->id %>"
				>
					Create Your District Tournament
				</a>
			</div>

%		} elsif ($tourn) {  


%		} else {

			<p class="explain bigger semibold redtext rightalign">
				This year's district tournament has not been created yet.  The
				District Chair needs to create the tournament before you can
				proceed.
			</p>
%		}

<%perl>

		my $district_members;
		my $junque;

		if ($district->id > 0) {
			($district_members, $junque) = $m->comp(
				"/funclib/nsda/api_client.mas",
				path => "/districts/".$district->id."/schools"
			);
		}

</%perl>


		<div class="full nospace martop">

			<span class="twothirds nospace">
				<h5>
					District Members
				</h5>
			</span>

			<span
				id    = "district_list_buttonarea"
				class = "third rightalign nospace martop"
			>

%			if ($is_member) {
%				if ($chapter) {
					<a
						class = "buttonwhite bluetext fa-sm fa fa-refresh marno"
						title = "Update points and records from Points DB"
						href  = "/user/nsda/district_update.mhtml?district_id=<% $district->id %>&whoami=chapter&chapter_id=<% $chapter->id %>"
					>
					</a>

%				} else {
					<a
						class = "buttonwhite bluetext fa-sm fa fa-refresh marno"
						title = "Update points and records from Points DB"
						href  = "/user/nsda/district_update.mhtml?district_id=<% $district->id %>&whoami=district"
					>
					</a>
%				}
%			}

			</span>
		</div>

		<& "/funclib/tablesorter.mas", table => "district_list" &>

		<table id="district_list">

			<thead>

				<tr class="yellowrow">

					<th>
						School
					</th>

					<th>
						Strength
					</th>

					<th>
						Paid this Year
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
				foreach my $member (
					sort {$b->{"strength"} <=> $a->{"strength"}}
					@{$district_members}
				) {

					next unless $member->{"strength"} > 0;
</%perl>

					<tr>
						<td class="leftalign">
							<% $member->{official_name} %>
						</td>

						<td class="rightalign">
							<% $member->{"strength"} %>
						</td>

						<td class="centeralign <% $member->{'active'} ? "bluetext" : "redtext semibold" %>">
							<% $member->{"active"} ? "Y" : "N"  %>
						</td>

					</tr>
%				}

			</tbody>
		</table>
	</div>

	<div class="screens nationals">

%		if ($nationals) {

			<div class="full nospace martopmore">

				<span class="fourfifths nospace">
					<h2 class="normalweight padless marno">
						<% $nationals->name %>
						<% $nationals->start->year %>
					</h2>
				</span>

				<span class="fifth rightalign nospace">
					<img
						src   = "<% $Tab::s3_url %>/<% $nationals->id."/".$nationals->setting("logo") %>"
						alt   = ""
						style = "max-width: 128px; max-height: 128px;"
					/>
				</span>
			</div>
<%perl>

			my $nationals_school =
				$chapter->schools(
					tourn => $nationals->id
				)->first if $chapter;

			if ($nationals_school) {
</%perl>

				<div class="full centeralign martopmore">
					<a
						class="buttonblue invert bigger"
						href="/user/enter/entry.mhtml?school_id=<% $nationals_school->id %>"
					>Nationals Registration for <% $nationals_school->name %></a>
				</div>

%			}

%			if ($is_chair) {

				<& "/user/nsda/district_nats.mas",
					district => $district,
					tourn    => $nationals,
					person   => $person,
					chapter  => $chapter
				&>
%			}
%		}
	</div>

