<%args>
	$person
	$person_settings
	$perms
	$district_id => undef
</%args>
<%init>

	my $district = Tab::District->retrieve($district_id) if $district_id;
	$m->abort unless $district; 

	unless (
		$person->site_admin
		|| $person_settings->{'nsda_admin'}
		|| Tab::Permission->search( tag => "chair", district => $district->id)->first
		|| Tab::Permission->search( tag => "member", district => $district->id)->first
	) { 

		$m->print("<p>You do not have access to see that district</p>");
	}

</%init>

	<& 
		"/user/menu.mas", 
		person   => $person,
		district => $district
	&>

	<div class="main">

		<div class="full nospace">

			<span class="threefifths">
				<h2>District: <% $district->name %></h2>
			</span>

			<span class="fifth">
				<h5>
					<% $district->location ? $district->location : "" %>
				</h5>
			</span>
				
			<span class="fifth">
				<h5>
					#<% $district->code %>
					Level: <% $district->level %>
				</h5>
			</span>

		</div>

<%perl>

			my @tourns = $m->comp(
				"/funclib/district_tourns.mas", 
				district => $district
			);

			my %committee = $m->comp(
				"/funclib/district_committee.mas", 
				district => $district
			);

			my $is_chair;
			my $is_member;
</%perl>

%			foreach my $role ("chair", "member", "alternate") { 

%				next unless $committee{$role};

%				foreach my $member (@{$committee{$role}}) { 

					<div class="full lightrow">

						<span class="sixth strong">
							<% ucfirst($role) %>
						</span>

						<span class="third">
							<% $member->first." ".$member->last %>
						</span>

						<span class="third">
							<a 
								href="mailto:<% $member->email %>" 
								class="plain"
							>
								<% $member->email %>
							</a>
						</span>

						<span class="sixth marno rightalign">
%							if ($member->id == $person->id) { 
%								$is_chair++ if $role eq "chair";
%								$is_member++;
								(aka, you)
%							}
						</span>

					</div>

%				}

%			}

%			if ($is_member) { 

				<div class="full nospace">

					<span class="twothirds">
						<h4 class="martop">
							District Tournaments on Tabroom
						</h4>
					</span>

					<span class="third rightalign">

%						if ($person->setting("nsda_beta")) { 
							<a 
								class = "buttonwhite bluetext"
								href  = "/user/nsda/district_tournament_create.mhtml?district_id=<% $district->id %>"
							>Create District Tournament
							</a>
%						}
					</span>

				</div>

%				foreach my $tourn (@tourns) { 

%					next if $tourn->hidden && (not defined $is_member);

%					my $start = $tourn->start->set_time_zone($tourn->tz);
%					my $end = $tourn->end->set_time_zone($tourn->tz);

					<div class="full nospace lightrow">

						<div class="quarter nospace padleft">
							<a 
								class="plain full"
								href="/index/tourn/index.mhtml?tourn_id=<% $tourn->id %>"
							>

							<% $tourn->name %>
							</a>
						</div>

						<div class="third nospace padless">
%							foreach my $event (sort {$a->abbr cmp $b->abbr} $tourn->events) { 
								<span class="sixth marno">
									<% $event->abbr %>
								</span>
%							}
						</div>

						<div class="fifth">
							<% Tab::niceshortdayte($start) %>
							<% $end->day != $start->day ? "&ndash; ".Tab::niceshortdayte($end) : ""%>
						</div>

					</div>

%				}

				<div class="full nospace">

					<span class="twothirds">
						<h4 class="martop">
							District Members in Tabroom
						</h4>
					</span>

					<span class="third rightalign">
						<a 
							class = "buttonwhite bluetext"
							href  = "district_update.mhtml?district_id=<% $district->id %>"
						>Update District Records
						</a>
					</span>
				</div>


					<& "/funclib/tablesorter.mas", table => "sortmebaby" &>

					<table id="sortmebaby">

						<thead>
							<tr class="yellowrow">

								<th>
									School
								</th>

								<th>
									Degrees
								</th>

								<th>
									Paid
								</th>

								<th>
									Type
								</th>

							</tr>

						</thead>

						<tbody>

%						foreach my $chapter ($district->chapters) { 

							<tr>

								<td>
									<% $chapter->name %>
								</td>

								<td class="rightalign">
									<% $chapter->setting("nsda_degrees") %>
								</td>

								<td class="centeralign">
									<% $chapter->setting("nsda_paid") ? "Y" : "N"  %>
								</td>

								<td class="centeralign">
									<% $chapter->setting("nsda_charter") %>
								</td>

							</tr>

%						}

						</tbody>

					</table>

%				}

		</div>

	</div>


