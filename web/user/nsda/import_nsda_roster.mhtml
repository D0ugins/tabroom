<%args>
	$person
	$chapter_id => undef
	$confirm    => undef
	$return     => undef
</%args>
<%init>

	use Tab::NSDA::MemberSchool;
	use Tab::NSDA::Person;
	use Tab::NSDA::Login;
	use Tab::NSDA::PersonSchool;

	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($chapter) {
		$m->comp("/funclib/abort.mas", message => "No valid chapter ID sent: $chapter_id");
	}

	my $now = DateTime->now;
	my $grad_year_limit = $now->year;
	$grad_year_limit++ if $now->month > 8;

    my @students = Tab::Student->search_where(
		chapter => $chapter->id,
		retired => 0,
		grad_year => { ">=", $grad_year_limit}
	);

    @students = sort {$a->last cmp $b->last} @students;

	# sorts already linked people to the bottom;
    @students = sort {length($a->nsda) <=> length($b->nsda)} @students;

	Tab::NSDA::Person->set_sql( students => "
		select distinct NEW_USERS.*
		from NEW_USERS, NEW_USERS_TO_SCHOOLS
		where NEW_USERS_TO_SCHOOLS.school_id = ?
		and NEW_USERS_TO_SCHOOLS.ualt_id = NEW_USERS.ualt_id
		and (
			NEW_USERS.utype = 'Student'
			or NEW_USERS.utype = 'PKDStudent'
			or NEW_USERS.utype = 'MIDStudent'
		)
		and NEW_USERS_TO_SCHOOLS.enddate = '0000-00-00 00:00:00'
		and NEW_USERS.grad_yr >= ?
		order by NEW_USERS.ulname, NEW_USERS.ufname
	");

	my @nsda_students = Tab::NSDA::Person->search_students( $chapter->nsda, $grad_year_limit );

	my %used_students = map {$_->nsda => 1} @students;

	Tab::debuglog("Student for Woodring is ".$used_students{10571755});

	my %student_name = map {$_->first." ".$_->middle." ".$_->last => 1} @students;
	my %student_grad = map {$_->first." ".$_->middle." ".$_->last => $_->grad_year} @students;

	my $school_year = Tab::school_year();

	if ($confirm) {

		my $count;

		NSDA:
		foreach my $nsda_student (@nsda_students) {

			next if $used_students{$nsda_student->user_id};
			next if $ARGS{"exclude_".$nsda_student->user_id};

			my $name = lc($nsda_student->ufname." ".$nsda_student->umname." ".$nsda_student->ulname);

			# Prevent duplications.
			next if $student_name{$name};

			my $grad_year = $nsda_student->grad_yr;
			$grad_year = $school_year unless $grad_year;

			my $student = Tab::Student->create({
				first     => $nsda_student->ufname,
				last      => $nsda_student->ulname,
				chapter   => $chapter->id,
				grad_year => $nsda_student->grad_yr,
				novice    => 0,
				retired   => 0,
				ualt_id   => $nsda_student->ualt_id,
				nsda      => $nsda_student->user_id
			});

			$m->comp("/funclib/nsda_person_link.mas", student => $student);

			$used_students{$nsda_student->user_id}++;
			$student_name{$name}++;
			$count++;
		}

		return if $return;
		my $msg = "$count entrants imported from the NSDA to your roster";
		$m->redirect("/user/chapter/students.mhtml?chapter_id=$chapter_id&msg=$msg");

	}

</%init>

	<& "menu.mas",
		person => $person,
		whoami => "import"
	&>

	<div class="main">

		<span class="threequarters nospace">
			<h2 class="nospace">Import your NSDA Roster</h2>
		</span>

		<span
			class = "quarter rightalign"
			id    = "nsda_roster_buttonarea"
		> </span>

		<& "/funclib/tablesorter.mas",
			table => "nsda_roster"
		&>

		<form
			action = "import_nsda_roster.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "chapter_id"
			value = "<% $chapter_id %>"
		>

		<p class="centeralign bluetext semibold">
			The following competitors will be added to your Tabroom.com roster:
		</p>

		<table id="nsda_roster">

			<thead>
				<tr class="smallish yellowrow">

					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						Grad Year
					</th>

					<th>
						Membership ID
					</th>

					<th>
						Exclude?
					</th>

				</tr>
			</thead>

			<tbody>

%				foreach my $nsda_student (@nsda_students) {

%					Tab::debuglog("Skipping because Woodring?") if $nsda_student->user_id == 10571755;
%					next if $used_students{$nsda_student->user_id};
%					Tab::debuglog("Mysteriously, nope") if $nsda_student->user_id == 10571755;

					<tr class="smallish">

						<td>
							<% $nsda_student->ufname %>
						</td>

						<td>
							<% $nsda_student->ulname %>
						</td>

						<td class="centeralign">
							<% $nsda_student->grad_yr %>
						</td>

						<td class="centeralign">
							<% $nsda_student->user_id %>
						</td>

						<td class="nospace">

							<label for="exclude_<% $nsda_student->user_id %>">

								<span class="full redhover nowrap centeralign marno">
									<span class="redtext semibold inline">
										Exclude:
									</span>
									<input
										type  = "checkbox"
										value = "1"
										id    = "exclude_<% $nsda_student->user_id %>"
										name  = "exclude_<% $nsda_student->user_id %>"
									>
								</span>
							</label>
						</td>
					</tr>
%				}

			</tbody>

			<tr class="liblrow">

				<td colspan="5" class="rightalign">
					<input
						type  = "submit"
						name  = "confirm"
						value = "Import Students"
					>
					</form>
				</td>

			</tr>

		</table>

	</div>
