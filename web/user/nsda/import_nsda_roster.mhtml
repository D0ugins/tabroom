<%args>
	$person
	$chapter_id => undef
	$confirm    => undef
	$return     => undef
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($chapter) {
		$m->comp("/funclib/abort.mas", message => "No valid chapter ID sent: $chapter_id");
	}

    # Get the NSDA roster for the school

    my $nsda_roster_ref = $m->comp("/funclib/nsda/school_roster.mas", chapter => $chapter);

    my @nsda_roster = eval {
		return @{$nsda_roster_ref};
	};

    my @student_roster;

    foreach my $roster (@nsda_roster) {
        next unless $roster->{'role'} eq "Student";
        push @student_roster, $roster;
    }

    my %student_by_person_id = map {$_->{person_id} => $_} @student_roster;

	my $now = DateTime->now;
	my $school_year = $now->year;
	$school_year++ if $now->month > 8;

    my @students = Tab::Student->search_where(
		chapter => $chapter->id,
		retired => 0,
		grad_year => { ">=", $school_year}
	);

    @students = sort {$a->last cmp $b->last} @students;

	# sorts already linked people to the bottom;
    @students = sort {length($a->nsda) <=> length($b->nsda)} @students;

	my %linked_students = map {$_->nsda => 1} @students;
	my %student_name = map { lc($_->first." ".$_->middle." ".$_->last." ".$_->grad_year) => 1} @students;

	if ($confirm) {

		my $count;

		NSDA:
		foreach my $nsda_student (@student_roster) {

			next if $linked_students{$nsda_student->{person_id}};
			next if $ARGS{"exclude_".$nsda_student->{person_id}};

			# Prevent duplications.
			my $name = lc($nsda_student->{first}." ".$nsda_student->{middle}." ".$nsda_student->{last}." ".$nsda_student->{grad_year});
			next if $student_name{$name};

			my $grad_year = $nsda_student->{grad_year};
			$grad_year = $school_year unless $grad_year;

			my $novice = 0;
			$novice = 1 if ($grad_year - $school_year) > 3;

			my $student = Tab::Student->create({
				first     => $nsda_student->{first},
				middle    => $nsda_student->{middle},
				last      => $nsda_student->{last},
				chapter   => $chapter->id,
				grad_year => $grad_year,
				novice    => $novice,
				retired   => 0,
				nsda      => $nsda_student->{person_id}
			});

			$m->comp("/funclib/nsda/student_link.mas",
				student     => $student,
				student_ref => $nsda_student
			);

			$linked_students{$nsda_student->{person_id}}++;
			$student_name{$name}++;
			$count++;
		}

		return if $return;

		my $msg = "$count entrants imported from the NSDA to your roster";
		$m->redirect("/user/chapter/students.mhtml?chapter_id=$chapter_id&msg=$msg");

	}

</%init>

	<& "menu.mas",
		person => $person,
		whoami => "import"
	&>

	<div class="main">

		<span class="threequarters nospace">
			<h2 class="nospace">Import NSDA Roster for <% $chapter->name %></h2>
		</span>

		<span
			class = "quarter rightalign"
			id    = "nsda_roster_buttonarea"
		> </span>

		<& "/funclib/tablesorter.mas",
			table => "nsda_roster"
		&>

		<form
			action = "import_nsda_roster.mhtml"
			method = "post"
		>

		<input
			type  = "hidden"
			name  = "chapter_id"
			value = "<% $chapter_id %>"
		>

		<p class="centeralign bluetext semibold">
			The following competitors will be added to your Tabroom.com roster:
		</p>

		<table id="nsda_roster">

			<thead>
				<tr class="smallish yellowrow">

					<th>
						First
					</th>

					<th>
						Last
					</th>

					<th>
						Grad Year
					</th>

					<th>
						Membership ID
					</th>

					<th>
						Points
					</th>

					<th>
						Exclude?
					</th>

				</tr>
			</thead>

			<tbody>

%				foreach my $nsda_student (@student_roster) {

%					next if $linked_students{$nsda_student->{person_id}};

					<tr class="smallish">

						<td>
							<% $nsda_student->{first} %>
						</td>

						<td>
							<% $nsda_student->{last} %>
						</td>

						<td class="centeralign">
							<% $nsda_student->{grad_year} %>
						</td>

						<td class="centeralign">
							<% $nsda_student->{person_id} %>
						</td>

						<td class="centeralign">
							<% $nsda_student->{points} %>
						</td>

						<td class="nospace">

							<label for="exclude_<% $nsda_student->{person_id} %>">

								<span class="full redhover nowrap centeralign marno">
									<span class="redtext semibold inline">
										Exclude:
									</span>
									<input
										type  = "checkbox"
										value = "1"
										id    = "exclude_<% $nsda_student->{person_id} %>"
										name  = "exclude_<% $nsda_student->{person_id} %>"
									>
								</span>
							</label>
						</td>
					</tr>
%				}

			</tbody>

		</table>

		<span class="liblrow rightalign">

			<input
				type  = "submit"
				name  = "confirm"
				value = "Import Students"
			>
			</form>
		</span>

	</div>
