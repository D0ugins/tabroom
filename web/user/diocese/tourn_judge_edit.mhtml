<%args>
	$judge_id => undef
	$category_id => undef
	$region
	$tourn
	$person
	$missing => undef
</%args>
<%init>

	my $judge = Tab::Judge->retrieve($judge_id);
	my $category = Tab::Category->retrieve($category_id) unless $judge;

	$category = $judge->category if $judge;

	my %category_settings = $category->all_settings();

	my @subsets =
		sort {$a->name cmp $b->name}
		$category->rating_subsets;

	my @tiers =
		sort {$a->name cmp $b->name}
		$category->rating_tiers;

	my @alts = $m->comp(
		"/funclib/region_judges.mas",
		region   => $region,
		alt      => "yes",
		category => $category
	);

	my @prelim_jpools = $m->comp(
		"/funclib/category_jpools.mas",
		category => $category,
		limit    => "ncfl_prelims"
	);

	my @elim_jpools = $m->comp(
		"/funclib/category_jpools.mas",
		category => $category,
		limit    => "ncfl_elims"
	);

	my $prelim_jpool = $judge->setting("prelim_jpool") if $judge;

	my @schools =
		sort {$a->name cmp $b->name}
		Tab::School->search(
			region => $region->id,
			tourn => $tourn->id
		);

	my $online_ballots;

	foreach my $event ($category->events) {
		$online_ballots++ if $event->setting("online_ballots");
	}

</%init>

	<div class="menu">

		<div class="sidenote">

			<h4><% $category->abbr %> Judging</h4>

			<a
				class="blue block"
				href="tourn_judges.mhtml?region_id=<% $region->id %>&tourn_id=<% $tourn->id %>&category_id=<% $category->id %>">
				Return to <% $category->abbr %> judge list
			</a>

<%perl>

			my @judges = $m->comp(
				"/funclib/ncfl/covering_judges.mas",
				diocese  => $region,
				category => $category
			);

			my $judge_burden = $m->comp(
				"/funclib/ncfl/judge_obligation.mas",
				diocese  => $region,
				category => $category
			);

			my $remainder = $judge_burden - scalar @judges;

</%perl>
			<h4>Stats</h4>

			<div class="block padless even">
				<span class="threequarter">
					Judges:
				</span>
				<span class="quarter">
					<% scalar @judges %>
				</span>
			</div>

			<div class="block padless">
				<span class="threequarter">
					Requirement:
				</span>
				<span class="quarter">
					<% $judge_burden %>
				</span>
			</div>

			<div class="block padless even">
				<span class="threequarter">
					Remaining need:
				</span>
				<span class="quarter">
					<% $remainder > 0 ? $remainder : "" %>
				</span>
			</div>

%			if (@prelim_jpools) {

				<h4>Prelim Pools</h4>

<%perl>

				foreach my $jpool (@prelim_jpools) {

					my @jpool_judges = $m->comp(
						"/funclib/region_judges.mas",
						region => $region,
						jpool  => $jpool
					);

					my $jpool_burden = $m->comp(
						"/funclib/ncfl/prelim_jpool_obligation.mas",
						diocese => $region,
						jpool   => $jpool
					);

					my $needed = $jpool_burden - scalar @jpool_judges;
					$needed = 0 if $needed < 0;

</%perl>

					<div
						class="full marless padless <% $needed > 0 ? "dkred" : "green" %>"
					>

						<span class="threequarter">
							<% $jpool->name %>
						</span>
						<span class="quarter">
							<% scalar @jpool_judges %>/<% $jpool_burden %>
						</span>
					</div>

%				}
%			}

		</div>

%		if ($online_ballots) {
			<div class="sidenote">

				<h4>
					<span class="inline redtext semibold">*</span> Online Ballots!</h4>

				<p class="bigger">
					We're asking for judge emails because we are
					using online balloting in all debate
						<span class="inline semibold redtext">and speech</span>
					categories.
				</p>

				<p class="bigger">
					Please advise your judges to bring an Internet
					capable device with them to the tournament, and
					to create a Tabroom.com account by hitting "Sign Up"
					on the top right corner of the main site.  Once
					they have, enter their account email here to link
					them for online ballot access.
				</p>

				<p class="bigger">
					If you don't have their contact they will have the
					opportunity to link their accounts at the tournament as
					well.
				</p>

				<p class="bigger">
					Online balloting is not mandatory but is strongly
					encouraged; it makes for a much easier weekend for both the
					judging and the tournament staff, and greatly helps us to
					stay on time.
				</p>

			</div>
%		}


	</div>

	<div class="main">

		<h2><% $region->arch ? "Archdiocese" : "Diocese" %> of <% $region->name %> at <% $tourn->name %></h2>

		<& "menubar.mas",
			tourn  => $tourn,
			region => $region,
			whoami => "judges"
		&>

		<h4><% ($judge) ? "Edit Judge " : "Add an ".$category->abbr." Judge " %> </h4>

		<form action="tourn_judge_save.mhtml">

		<input
			type  = "hidden"
			name  = "judge_id"
			value = "<% $judge_id %>">

		<input
			type  = "hidden"
			name  = "category_id"
			value = "<% $category->id %>">

		<input
			type  = "hidden"
			name  = "tourn_id"
			value = "<% $tourn->id %>">

		<input
			type  = "hidden"
			name  = "region_id"
			value = "<% $region->id %>"
		>

		<table>

			<tr class="<% $missing =~ /first/ ? "lirdrow" : "lightrow" %>">

				<td>
					First Name:
				</td>

				<td colspan="3">

					<input
						type  = "text"
						name  = "first"
						value = "<% ($judge && $judge->first) ?  $judge->first : "" %>"
						size  = "32"
					>
				</td>

			</tr>

			<tr class="<% $missing =~ /last/ ? "lirdrow" : "lightrow" %>">

				<td>
					Last Name:
				</td>

				<td colspan="3">
					<input
						type  = "text"
						name  = "last"
						value = "<% ($judge && $judge->last) ?  $judge->last : "" %>"
						size  = "32">
				</td>

			</tr>

			<tr class="<% $missing =~ /gender/ ? "lirdrow" : "lightrow" %>">

				<td>
					Gender:
				</td>

				<td colspan="3" class="nospace">

					<label for="F">
						<span class="centeralign quarter hover">
							F <input
									type  = "radio"
									name  = "gender"
									id    = "F"
									value = "F"
									<% ($judge && $judge->setting('gender') eq "F") ? "checked" : "" %>
								>
						</span>
					</label>

					<label for="M">

						<span class="centeralign quarter hover">
							M <input
								type  = "radio"
								name  = "gender"
								id    = "M"
								value = "M"
								<% ($judge && $judge->setting('gender') eq "M") ? "checked" : "" %>
							>
						</span>

					</label>

					<label for="O">

						<span class="centeralign quarter hover">
							Other <input
								type  = "radio"
								name  = "gender"
								id    = "O"
								value = "O"
								<% ($judge && $judge->setting('gender') eq "O") ? "checked" : "" %>
							>
						</span>

					</label>
				</td>

			</tr>

			<tr class="<% $missing =~ /school/ ? "lirdrow" : "lightrow" %>">

				<td>
					School:
				</td>

				<td colspan="3">
					<select name="school_id" class="fixedbig">
%						foreach my $school (@schools) {
							<option
								value="<% $school->id %>"
								<% ($judge && $judge->school->id == $school->id) ? "selected" : "" %>
							> <% $school->short_name %> </option>
%						}

					</select>
				</td>

			</tr>

%			if ($online_ballots) {
				<tr class="<% $missing =~ /rating/ ? "lirdrow" : "lightrow" %>">

					<td>
						Tabroom Account Email <span class="semibold inline redtext">*</span>
					</td>

					<td colspan="2">

						<input
							type  = "text"
							name  = "email"
							value = "<% ($judge && $judge->person) ?  $judge->person->email : "" %>"
							size  = "32"
						>
					</td>

					<td class="centeralign">
						<% $judge && $judge->person
							? '<span class="fa fa-2x greentext fa-check-circle"></span>'
							: ""
						%>
					</td>

				</tr>
%			}

			<tr class="<% $missing =~ /rating/ ? "lirdrow" : "lightrow" %>">

				<td>
					Experience:
				</td>

				<td class="smallish" colspan="3">
<%perl>

					if (@subsets) {

						my $notfirst;

						foreach my $subset (@subsets) {

							my $set_tier = Tab::Rating->search(
								rating_subset => $subset->id,
								judge => $judge->id
							)->first if $judge;

</%perl>

							<div class="full <% $notfirst++ ? "bordertop" : "" %> nospace">

								<span class="fifth semibold bluetext biggish">
									<% $subset->name %>:
								</span>

								<span class="threequarters">

									<select
										name        = "<% $subset->id %>"
										class       = "fixedbig"
										placeholder = "Please choose one"
									>
										<option value=""></option>

%										foreach my $rating_tier (sort {$a->name cmp $b->name} @tiers) {
											<option value="<% $rating_tier->id %>"
												<% ($set_tier && $set_tier->rating_tier->id == $rating_tier->id) ? "selected" : "" %>
											> <% $rating_tier->name %> - <% $rating_tier->description %> </option>
%	  									}
									</select>
								</span>
							</div>

%						}

%					} else {

%						my $set_tier = $judge->ratings->first if $judge;

						<select name="rating_tier" class="fixedbig">

							<option value="">Choose an experience rating:</option>

%							foreach my $rating_tier (sort {$a->name cmp $b->name} @tiers) {

								<option value="<% $rating_tier->id %>"
								<% ($set_tier && $set_tier->rating_tier->id == $rating_tier->id) ? "selected" : "" %>> <% $rating_tier->name %> - <% $rating_tier->description %> </option>
%							}
						</select>

%					}

				</td>

			</tr>

%			if ($category_settings{"ask_parli"}) {

%				if ($region->quota > 4) {
					<tr class="lightrow">
						<td colspan="3" class="dkredtext">
							<p>
								Dioceses who may qualify 5 or 6 entrants
									<span class="semibold redtext inline">MUST</span>

								bring a qualified parliamentarian to serve as
								their Congress judge.  If your judge is not a
								qualified parliamentarian, substitute one who
								is.

							</p>
						</td>
					</tr>
%				}

				<tr class="<% $missing =~ /parli/ ? "lirdrow" : "lightrow" %>">

					<td>
						Qualified as Parliamentarian?
					</td>

					<td colspan="3" style="padding-left: 15px;">

						<label for="parli_y">Yes</label>

						<input
							type  = "radio"
							name  = "parli"
							id    = "parli_y"
							value = "Y"
							<% ($judge && $judge->setting("parli") eq "Y") ? "checked" : "" %>
						>

						<label for="parli_n">No</label>

						<input
							type  = "radio"
							name  = "parli"
							id    = "parli_n"
							value = "N"
							<% ($judge && $judge->setting("parli") eq "N") ? "checked" : "" %>
						>
					</td>

				</tr>
%			}


%			if (@prelim_jpools) {

				<tr class="<% $missing =~ /jpool/ ? "lirdrow" : "lightrow" %>">

			        <td>
						Prelim Pool
					</td>

			        <td colspan="5">
						<select name="jpool_id">

%       					foreach my $jpool (@prelim_jpools) {
								<option value="<% $jpool->id %>"
									<%  ($prelim_jpool == $jpool->id )
										?  "selected"
										: ""
									%> > <% $jpool->name %> <% ($jpool->site && $jpool->site->id) ? " at ".$jpool->site->name : "" %> </option>
%							}

						</select>
					</td>

				</tr>

%			}

	        <tr class="lightrow">

				<td>
					Notes/Comments for Tab
				</td>

				<td class="smallish" colspan="3">
					<input
						type  = "text"
						name  = "notes"
						value = "<% $judge ? $judge->setting('notes') : "" %>"
						size  = "64">
				</td>

			</tr>

<%perl>

			if (
				$category_settings{"ask_alts"}
				&& (
						scalar @alts < $category_settings{"alt_max"}
						|| ($judge && $judge->alt_category )
					)
			) {

</%perl>

				<tr class="<% $missing =~ /alt_category/ ? "lirdrow" : "odd" %> bordertop">

					<td colspan="2">

						<p class="bigger semibold redtext">
							Alternate pool required for Congress judges
						</p>

						<p>
							We cannot use every diocese's Congress judge in
							Congress prelims.
						</p>

						<p>
							Please designate which pool we should move this judge
							into if we are unable to use them in Congress.
						</p>

						<p>
							You will get credit for one judge
							<span class="inline semibold redtext">both</span>
							in Congress and in the alternate pool.
						</p>

					</td>

				</tr>

	        	<tr class="lightrow">

					<td>
						Alternate Pool:
					</td>

					<td>

						<select name="alt_category" class="fixedbig">

							<option value="">Choose an alternate:</option>

%							foreach my $alt_category ($tourn->categories) {

%								next if $category->id == $alt_category->id;

								<option
									value="<% $alt_category->id %>"
									<% $judge
										&& $judge->alt_category
										&& $judge->alt_category->id == $alt_category->id
											? "selected"
											: ""
									%>
									> <% $alt_category->name %> </option>
%							}

						</select>
					</td>
				</tr>
%			}

			<tr class="liblrow">
				<td colspan="4" align="right">
					<input
						type  = "submit"
						name  = "save"
						value = "Save and Add Another"
						style = "padding-left: 10px; padding-right: 10px;"
					>
				</td>
			</tr>

		</table>
	</div>
