<%args>
	$person
	$region_id => undef
	$tourn_id  => undef
</%args>
<%init>

	my $tourn = Tab::Tourn->retrieve($tourn_id) if $tourn_id;
	my $region = Tab::Region->retrieve($region_id) if $region_id;

	unless ($tourn && $region) {
		$m->comp("/funclib/abort.mas",
			warning => "Tournament not found for ID $tourn_id or diocese not found for ID $region_id"
		);
	}

	my @results = $m->comp(
		'/funclib/region_results.mas',
		tourn  => $tourn,
		region => $region,
	);

	my @result_values = $m->comp(
		'/funclib/region_result_values.mas',
		tourn  => $tourn,
		region => $region
	);

	my %values_by_result = ();

	foreach my $value (@result_values) {
		push @{$values_by_result{$value->result->id}}, $value;
	}

</%init>

	<& "menu.mas",
		region => $region,
		tourn  => $tourn,
		whoami => "report"
	&>

	<div class="main">

		<h2><% $region->name %>: Results</h2>

		<h4><% $tourn->name %></h4>

<%perl>

		my $current_result;
		my $ballot_spacer;

		foreach my $result (@results) {

			next unless $values_by_result{$result->id};
			next unless @{$values_by_result{$result->id}};

			unless ($result->result_set->id == $current_result) {

				my $result_set = $result->result_set;

				if ($current_result) {
</%perl>
					</tbody>
					</table>
<%perl>
				}

				$current_result = $result_set->id;

				$ballot_spacer = "quarter";
				$ballot_spacer = "quarter" if $result->entry->event->type eq "ld";
				$ballot_spacer = "third" if $result->entry->event->type eq "pf";
				$ballot_spacer = "third" if $result->entry->event->type eq "parli";
				$ballot_spacer = "third" if $result->entry->event->type eq "policy";
				$ballot_spacer = "third" if $result->entry->event->type eq "debate";

				$ballot_spacer = "quarter"
					if $ballot_spacer eq "third"
					&& $result_set->label eq "Speaker Awards";

</%perl>

				<h4> <% $result->entry->event->abbr %> <% $result_set->label %> </h4>

				<& /funclib/tablesorter.mas, table => $current_result &>

				<table id="<% $current_result %>" class="narrow">

				<thead>

					<tr class="yellowrow smaller">

						<th class=" centeralign">
							Place
						</th>

						<th class="centeralign">
							<% $result_set->label eq "Speaker Awards" ? "Speaker" : "Entry" %>
						</th>

						<th class="centeralign">
							Tiebreakers
						</th>

						<th class="centeralign">
							Ballots
						</th>

					</tr>

				</thead>

				<tbody>
%	 		}

%			my $seed = $result->rank;

			<tr>
				<td class="smaller centeralign nowrap ">
					<% $seed %>
				</td>

				<td class="smaller" title="<% $result->entry->code %>">
					<% $result->student
						? "<div>".$result->student->first." <br /> ".$result->student->last."</div>"
						: $result->entry->name
					%>
				</td>

				<td class="smallish mono nospace padtop nowrap limit2">

<%perl>
					foreach my $value (@{$values_by_result{$result->id}}) {

						my $tag = $value->result_key->tag;

						next if $tag eq "Ballots";
						next if $tag eq "Place";
						next if $tag eq "Order";
						next if $tag eq "Seed";
						next if $tag eq "Rnd";
						next if $tag eq "Rand";
						my $tag = $tag;
						$tag =~ s/\s+//g;
</%perl>
						<span class="third centeralign">
							<div
								class = "bold tiny"
								title = "<% $value->result_key->description %>"
							><% $tag %></div>
							<div><% $value->value %></div>
						</span>
%					}
				</td>

				<td class="smallish mono padleft nospace">
<%perl>
					foreach my $value (@{$values_by_result{$result->id}}) {

						my $tag = $value->result_key->tag;
						next unless $tag eq "Ballots";

						my $ballots = $value->value;
						$ballots =~ s/^\s+//;
						$ballots =~ s/^&nbsp;//;
						$ballots =~ s/&nbsp;/<\/span><span class="$ballot_spacer marno">/g;
						$ballots =~ s/\r\n/<\/span><span class="$ballot_spacer marno">/g;
						$ballots =~ s/\n\n/<\/span><span class="$ballot_spacer marno">/g;
						$ballots =~ s/\n/<\/span><span class="$ballot_spacer marno">/g;
</%perl>
						<span class="<% $ballot_spacer %> marno">
							<% $ballots %>
						</span>
%					}
				</td>
			</tr>
%		}

		</tbody>
		</table>

	</div>
