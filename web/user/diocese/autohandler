<%args>
	$person
	$perms
	$region_id => undef
	$tourn_id  => undef
</%args>
<%init>

	if ($r->uri =~ /ncfl_enter.mhtml/ || $r->uri =~ /entry_drop.mhtml/ || $r->uri =~ /diocese_rm.mhtml/) { 
		
		$m->call_next( );

	} else { 

		my $region = Tab::Region->retrieve($region_id) if $region_id;

		# The below moment of spectcular laziness brought to you by the
		# complete deficit of fucks I give about the NCFL, a condition arrived
		# at through two decades of the most insane disregard for normalcy in
		# tournament operations known to mankind.  luv, CLP.

		Tab::Region->columns(TEMP => "arch");
		Tab::Region->columns(TEMP => "quota");

		$region->arch($region->setting("arch"));
		$region->quota($region->setting("quota"));

		my $err = "Diocese not found.  Please contact the NCFL if you think this in error";

		$m->redirect("/user/home.mhtml?err=$err")
			unless $region;

		$err = "You do not have access to that diocese.  Please contact the NCFL if you think this in error";

		$m->redirect("/user/home.mhtml?err=$err")
			unless $perms->{"region"}{$region->id} || $person->site_admin;

		my $tourn = Tab::Tourn->retrieve($tourn_id) if $tourn_id;

		$m->call_next( 
			region => $region,
			tourn  => $tourn
		);

	}

</%init>

