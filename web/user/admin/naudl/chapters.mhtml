<%args>
	$person
	$person_settings
	$tourn
</%args>
<%init>

	use JSON;
	use Tab::NSDA::EventCategory;

	my $now = DateTime->now();

	Tab::Chapter->columns(TEMP => "regioncode");
	Tab::Chapter->columns(TEMP => "regionname");

	Tab::Chapter->set_sql( naudl => "
		select distinct chapter.*, region.code as regioncode, region.name as regionname
		from chapter, chapter_circuit, region, circuit_setting
		where chapter.id = chapter_circuit.chapter
		and chapter_circuit.region = region.id
		and chapter_circuit.circuit = circuit_setting.circuit
		and circuit_setting.tag = 'naudl'
	");

	my @chapters = Tab::Chapter->search_naudl();

</%init>

	<& "../menu.mas", 
		person          => $person,
		person_settings => $person_settings,
		whoami          => "naudl_chapters"
	&>

	<div class="main">

		<span class="threequarters">
			<h2><% scalar @chapters %> NAUDL Schools</h2>
		</span>

		<span 
			class = "quarter rightalign"
			id    = "naudl_schools_buttonarea"
		>

		</span>

	<& "/funclib/tablesorter.mas", table => "naudl_schools" &>

	<table id="naudl_schools">

		<thead>

			<tr class="smallish yellowrow">

				<th>
					ID
				</th>

				<th>
					Name
				</th>

				<th>
					League Code
				</th>

				<th>
					League
				</th>

				<th>
					Level
				</th>

				<th>
					Last change	
				</th>

				<th>
					Banish
				</th>


			</tr>

		</thead>

		<tbody>

%			foreach my $chapter (@chapters) { 

%				my $region_name = $chapter->regionname;
%				$region_name =~ s/Urban Debate League//g;
%				$region_name =~ s/Debate League//g;
%				$region_name =~ s/UDL//g;

				<tr id = "<% $chapter->id %>" >

					<td>
						TR<% $chapter->id %>
					</td>

					<td>
						<% $chapter->name %>
					</td>

					<td>
						<% $chapter->regioncode %>
					</td>

					<td>
						<% $region_name %>
					</td>

					<td>
						<% $chapter->level %>
					</td>

					<td>
						<% Tab::csvdt($chapter->timestamp) %>
					</td>

%					my $warn = "This will remove ".$chapter->name." from NAUDL affilation altogether.";
%					$warn .= " Are you sure?  This will be hard to undo.";

					<td class="padless centeralign">
						<a 
							value       = "1"
							target_type = "chapter"
							target_id   = "<% $chapter->id %>"
							on_success  = "destroy"
							class       = "buttonwhite fa-lg fa fa-arrow-down redtext hover"
							title       = "Remove this school from NAUDL reporting"
							onClick     = "postConfirm('<% $warn %>', this, 'chapter_banish.mhtml');"
						>
						</a>
					</td>

				</tr>
%			}

		</tbody>

	</table>

	</div>


