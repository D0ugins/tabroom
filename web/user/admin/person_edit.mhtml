<%args>
	$person
	$person_settings
	$edit_id => undef
</%args>
<%init>

	my $edit = Tab::Person->retrieve($edit_id);
	my $switch;

	unless ($edit) {
		$m->print("No user was found with that ID");
		$m->abort();
	}

	my %edit_settings = $edit->all_settings;

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			log.id,
			tourn.name, tourn.id, tourn.tz,
			log.timestamp,
			log.description
		from campus_log log
			left join tourn on tourn.id = log.tourn
		where log.person = ?
			order by log.id DESC
		limit 5
	");

	$sth->execute( $edit_id );

	my %campus;

	while (
		my (
			$id,
			$last_campus, $tourn_id, $tourn_tz, $last_campus_timestamp, $last_campus_description
		) = $sth->fetchrow_array()
	) {
		$campus{$id}{"tourn"} = $last_campus;
		$campus{$id}{"tourn_id"} = $tourn_id;
		$campus{$id}{"tz"} = $tourn_tz;
		$campus{$id}{"timestamp"} = $last_campus_timestamp;
		$campus{$id}{"description"} = $last_campus_description;
	}


	$sth->finish();
	$dbh->disconnect();

</%init>

	<&
		"menu.mas",
		whoami          => "persons",
		person          => $person,
		edit_id         => $edit_id,
		person_settings => $person_settings
	&>

	<div class="main">

		<h2>Edit <% $edit->first." ".$edit->last %>'s details</h2>

		<span class="pagehalf nospace">
			<h4>
				Person Record
			</h4>
		</span>

		<span class="third nospace rightalign">
			<h5 class="bluetext">
				Tabroom ID#
			</h5>
		</span>

		<span class="sixth nospace leftalign marleft padleft">
			<h5 class="bluetext">
				<% $edit->id %>
			</h5>
		</span>

		<form
			action = "person_save.mhtml"
			method = "post"
		>

			<input
				type  = "hidden"
				name  = "edit_id"
				value = "<% $edit->id %>"
			>

			<span class="pagehalf">

				<div class="row">
					<span class="third">
						First
					</span>

					<span class="rightalign twothirds">
						<input
							type  = "text"
							name  = "first"
							value = "<% $edit->first %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						Middle
					</span>

					<span class="rightalign twothirds">
						<input
							type  = "text"
							name  = "middle"
							value = "<% $edit->middle %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						Last
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "last"
							value = "<% $edit->last %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						Street Address
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "street"
							value = "<% $edit->street %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						City
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "city"
							value = "<% $edit->city %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						State/Province
					</span>

					<span class="rightalign twothirds" >
						<select
							name  = "state"
							class = "fixedmed chosen"
						>
							<&
								"/funclib/state_select.mas",
								state => $edit->state
							&>
						</select>
					</span>
				</div>

				<div class="row">
					<span class="third">
						Country
					</span>

					<span class="rightalign twothirds" >
						<select name="country" class="fixedmed">

							<& "/funclib/country_select.mas",
								country => $edit->country
							&>

						</select>
					</span>
				</div>

				<div class="row">
					<span class="third">
						ZIP code
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "zip"
							value = "<% sprintf("%05d", $edit->zip) %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						Time Zone
					</span>

					<span class="twothirds rightalign">
						<select name="timezone" class="fixedmed">
							<& /funclib/timezones.mas, tz => $edit->tz &>
						</select>
					</span>
				</div>

				<div class="row">
					<span class="third">
						Pronouns
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "pronoun"
							value = "<% $edit->pronoun %>"
							size  = "24"
						>
					</span>
				</div>

			</span>
			<span class="pagehalf">

				<div class="row">
					<span class="third">
						Email
					</span>

					<span class="rightalign twothirds">
						<input
							type  = "text"
							name  = "email"
							value = "<% $edit->email %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						Phone Number
					</span>
					<span class="rightalign twothirds">
						<input
							type  = "tel"
							name  = "phone"
							value = "<% Tab::phone($edit->phone) %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						Cell provider
					</span>

					<span class="rightalign twothirds">
						<select name="provider" class="fixedmed chosen">
							<& /funclib/cell_domains.mas, provider => $edit->provider &>
						</select>
					</span>
				</div>

				<label for="no_email">
					<div class="row hover">
						<span class="fourfifths">
							No Emails or Texts
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								id    = "no_email"
								value = "1"
								name  = "no_email"
								<% ($edit->no_email) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<label for="email_unconfirmed">
					<div
						title = "User has not confirmed their email address"
						class = "row hover"
					>
						<span class="fourfifths">
							Email is not confirmed
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								value = "1"
								id    = "email_unconfirmed"
								name  = "email_unconfirmed"
								<% ($edit_settings{"email_unconfirmed"}) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<div class="row">
					<span class="fortyfive">
						Email Confirmation Code
					</span>

					<span class="rightalign half marleftmore">
						<input
							type      = "text"
							name      = "email_confirmation_key"
							value     = "<% $edit_settings{"email_confirmation_key"} %>"
							size      = "24"
							maxlength = "6"
						>
					</span>
				</div>

				<div class="row">
					<span class="third">
						NSDA ID Number
					</span>

					<span class="rightalign twothirds">
						<input
							style = "width: 172px;"
							type  = "number"
							name  = "nsda"
							value = "<% $edit->nsda %>"
							min   = "000"
							max   = "9999999999999"
							step  = "1"
							size  = "24"
						>
					</span>
				</div>

				<label for="site_admin">
					<div class="row hover">
						<span class="fourfifths">
							Tabroom Site Admin (God-like powers)
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								value = "1"
								id    = "site_admin"
								name  = "site_admin"
								<% ($edit->site_admin) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<label for="nsda_admin">
					<div class="row hover">
						<span class="fourfifths">
							NSDA Office Staff access
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								value = "1"
								id    = "nsda_admin"
								name  = "nsda_admin"
								<% ($edit_settings{"nsda_admin"}) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<label for="naudl_admin">
					<div class="row hover">
						<span class="fourfifths">
							NAUDL Data Admin access
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								value = "1"
								id    = "naudl_admin"
								name  = "naudl_admin"
								<% ($edit_settings{"naudl_admin"}) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>
			</span>

			<div class="libl pagefull rightalign padvertless">
				<span class="centeralign third">
					<input
						type  = "submit"
						value = "Save Changes"
					>
				</span>
			</div>

			<h5>Logins</h5>

<%perl>
				my $counter = 1;
				my @logins = sort {$b->accesses <=> $a->accesses} $edit->logins;

</%perl>
				<div class="pagefull">

%				foreach my $login (@logins) {

					<div class="row">
						<span class="twenty semibold bluetext centeralign">
							<% $counter++ %>
						</span>

						<span class="fourtenths">

%						if ($login->username eq $edit->email) {

							<span
								title = "Primary login username may not be changed independent of the primary email"
								class = "semibold redtext padvert marno"
							>
								<% $login->username %>
							</span>

%						} else {
							<input
								type  = "text"
								name  = "<% $login->id %>_username"
								size  = "42"
								value = "<% $login->username %>"
							>
%						}
						</span>

						<span class="eighth">
							<span class="semibold bluetext half">
								Used
							</span>
							<span class="half">
								<% $login->accesses %>
							</span>
						</span>

						<span class="threetenths">
							<span class="third semibold bluetext nospace">
								Last Login
							</span>
							<span class="twothirds nospace rightalign">
								<& "/funclib/showdt.mas", dt => $login->last_access, length => 'medium' &>
							</span>
						</span>

						<span class="twenty nospace centeralign">
							<a
								target = "_blank"
								class  = "buttonwhite bluetext fa fa-sm fa-retweet"
								href   = "/user/login/forgot_send.mhtml?username=<% $login->username %>"
								title  = "Trigger Password Reset"
							></a>
						</span>

%						unless ($login->username eq $edit->email) {
							<span class="twenty nospace">
								<a
									class  = "buttonwhite redtext fa fa-sm fa-trash"
									href   = "login_rm.mhtml?login_id=<% $login->id %>"
								>
								</a>
							</span>
%						}

					</div>
%				}

				<div class="libl rightalign marvertno padvertless">
					<span class="centeralign third">
					<input type="submit" value="Save Logins">
					</span>
				</div>
			</div>
		</form>

		<h5>NSDA Campus Entries</h5>

		<div class="row padvert">
			<span class="fifth semibold bluetext">
				Competition Test
			</span>

			<span class="threetenths">
				<& "/funclib/showdt.mas",
					dt     => $person_settings->{"campus_test_private"},
					tz     => $edit->tz,
					tzname => 1
				&>
			</span>

			<span class="fifth semibold bluetext">
				Practice Test
			</span>

			<span class="threetenths">
				<& "/funclib/showdt.mas",
					dt     => $person_settings->{"campus_test_public"},
					tz     => $edit->tz,
					tzname => 1
				&>
			</span>
		</div>

		<p class="semibold redtext martopmore">Last Campus Rooms Entered</h6>

%		foreach my $id (sort {$b <=> $a} keys %campus) {

			<div class="row padvert">

				<span class="half nospace">
					<a
						href  = "/user/tourn/select.mhtml?tourn_id=<% $campus{$id}{"tourn_id"} %>"
						class = "white marno semibold bluetext"
						target= "_blank"
					>
						<span class="halfspacer"></span>
						<% $campus{$id}{"tourn"} %>
					</a>
				</span>

				<span class="quarter">
					<& "/funclib/showdt.mas",
						string => $campus{$id}{"timestamp"},
						tz     => $campus{$id}{"tz"},
						tzname => 1
					&>
				</span>

				<span class="quarter">
					<% $campus{$id}{"description"} %>
				</span>
			</div>
%		}

	</div>
