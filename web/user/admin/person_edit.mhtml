<%args>
	$person
	$person_settings
	$edit_id => undef
</%args>
<%init>

	my $edit = Tab::Person->retrieve($edit_id);
	my $switch;

	unless ($edit) {
		$m->print("No user was found with that ID");
		$m->abort();
	}

	my %edit_settings = $edit->all_settings;

	my $now = DateTime->now();

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			log.id,
			tourn.name, tourn.id, tourn.tz,
			log.timestamp,
			log.description
		from campus_log log
			left join tourn on tourn.id = log.tourn
		where log.person = ?
			order by log.id DESC
		limit 5
	");

	$sth->execute( $edit_id );

	my %campus;

	while (
		my (
			$id,
			$last_campus, $tourn_id, $tourn_tz, $last_campus_timestamp, $last_campus_description
		) = $sth->fetchrow_array()
	) {
		$campus{$id}{"tourn"} = $last_campus;
		$campus{$id}{"tourn_id"} = $tourn_id;
		$campus{$id}{"tz"} = $tourn_tz;
		$campus{$id}{"timestamp"} = $last_campus_timestamp;
		$campus{$id}{"description"} = $last_campus_description;
	}


	$sth->finish();
	$dbh->disconnect();

</%init>

	<&
		"menu.mas",
		whoami          => "persons",
		person          => $person,
		edit_id         => $edit_id,
		person_settings => $person_settings
	&>

	<div class="main">

		<h2>Edit <% $edit->first." ".$edit->last %>'s details</h2>

		<span class="pagehalf nospace">
			<h4>
				Person Record
			</h4>
		</span>

		<span class="third nospace rightalign">
			<h5 class="bluetext">
				Tabroom ID#
			</h5>
		</span>

		<span class="sixth nospace leftalign marleft padleft">
			<h5 class="bluetext">
				<% $edit->id %>
			</h5>
		</span>

		<form
			action = "person_save.mhtml"
			method = "post"
		>

			<input
				type  = "hidden"
				name  = "edit_id"
				value = "<% $edit->id %>"
			>

			<span class="pagehalf">

				<div class="row fixedheight">
					<span class="twofifths nospace">
						<span class="halfspacer"></span>
						Email/Username
					</span>

					<span class="rightalign threefifths">
						<input
							type  = "text"
							name  = "email"
							value = "<% $edit->email %>"
							size  = "32"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						First
					</span>

					<span class="rightalign twothirds">
						<input
							type  = "text"
							name  = "first"
							value = "<% $edit->first %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						Middle
					</span>

					<span class="rightalign twothirds">
						<input
							type  = "text"
							name  = "middle"
							value = "<% $edit->middle %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						Last
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "last"
							value = "<% $edit->last %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						Street Address
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "street"
							value = "<% $edit->street %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						City
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "city"
							value = "<% $edit->city %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						State/Province
					</span>

					<span class="rightalign twothirds" >
						<select
							name  = "state"
							class = "fixedmed chosen"
						>
							<&
								"/funclib/state_select.mas",
								state => $edit->state
							&>
						</select>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						Country
					</span>

					<span class="rightalign twothirds" >
						<select name="country" class="fixedmed">

							<& "/funclib/country_select.mas",
								country => $edit->country
							&>

						</select>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						ZIP code
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "zip"
							value = "<% sprintf("%05d", $edit->zip) %>"
							size  = "24"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						Time Zone
					</span>

					<span class="twothirds rightalign">
						<select name="timezone" class="fixedmed">
							<& /funclib/timezones.mas, tz => $edit->tz &>
						</select>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third">
						Pronouns
					</span>

					<span class="rightalign twothirds" >
						<input
							type  = "text"
							name  = "pronoun"
							value = "<% $edit->pronoun %>"
							size  = "24"
						>
					</span>
				</div>

			</span>
			<span class="pagehalf">

				<div class="row fixedheight">
					<span class="quarter nospace">
						<span class="halfspacer"></span>
						Phone
					</span>
					<span class="rightalign threequarters">
						<input
							type  = "tel"
							name  = "phone"
							value = "<% Tab::phone($edit->phone) %>"
							size  = "32"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third nospace">
						<span class="halfspacer"></span>
						Cell provider
					</span>

					<span class="rightalign twothirds">
						<select name="provider" class="fixedmed chosen">
							<& /funclib/cell_domains.mas, provider => $edit->provider &>
						</select>
					</span>
				</div>

				<label for="no_email">
					<div class="row fixedheight hover">
						<span class="fourfifths nospace">
							<span class="halfspacer"></span>
							No Emails or Texts
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								id    = "no_email"
								value = "1"
								name  = "no_email"
								<% ($edit->no_email) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<label for="email_unconfirmed">
					<div
						title = "User has not confirmed their email address"
						class = "row fixedheight hover"
					>
						<span class="fourfifths nospace">
							<span class="halfspacer"></span>
							Email is not confirmed
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								value = "1"
								id    = "email_unconfirmed"
								name  = "email_unconfirmed"
								<% ($edit_settings{"email_unconfirmed"}) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<div class="row fixedheight">
					<span class="fortyfive nospace">
						<span class="halfspacer"></span>
						Email Confirmation Code
					</span>

					<span class="rightalign half marleftmore">
						<input
							type      = "text"
							name      = "email_confirmation_key"
							value     = "<% $edit_settings{"email_confirmation_key"} %>"
							size      = "24"
							maxlength = "6"
						>
					</span>
				</div>

				<div class="row fixedheight">
					<span class="third nospace">
						<span class="halfspacer"></span>
						NSDA ID Number
					</span>

					<span class="rightalign twothirds">
						<input
							style = "width: 172px;"
							type  = "number"
							name  = "nsda"
							value = "<% $edit->nsda %>"
							min   = "000"
							max   = "9999999999999"
							step  = "1"
							size  = "24"
						>
					</span>
				</div>

				<label for="site_admin">
					<div class="row fixedheight hover">
						<span class="fourfifths nospace">
							<span class="halfspacer"></span>
							Tabroom Site Admin (God-like powers)
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								value = "1"
								id    = "site_admin"
								name  = "site_admin"
								<% ($edit->site_admin) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<label for="nsda_admin">
					<div class="row fixedheight hover">
						<span class="fourfifths nospace">
							<span class="halfspacer"></span>
							NSDA Office Staff (Demigod)
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								value = "1"
								id    = "nsda_admin"
								name  = "nsda_admin"
								<% ($edit_settings{"nsda_admin"}) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<label for="naudl_admin">
					<div class="row fixedheight hover">
						<span class="fourfifths nospace">
							<span class="halfspacer"></span>
							NAUDL Data Admin access
						</span>

						<span class="fifth padvertless">
							<input
								type  = "checkbox"
								value = "1"
								id    = "naudl_admin"
								name  = "naudl_admin"
								<% ($edit_settings{"naudl_admin"}) ? "checked" : "" %>
							>
						</span>
					</div>
				</label>

				<div class="row fixedheight" title="Don't mess with this unless Palmer has told you to.">
					<span class="quarter nospace">
						<span class="halfspacer"></span>
						API Key
					</span>

					<span class="half">
						<input
							type  = "text"
							id    = "api_key"
							name  = "api_key"
							size  = "24"
							value = "<% $edit_settings{"api_key"} %>"
						>
					</span>

%					my $warn = "Changing the API key can break connections to Tabroom for this user. Are you sure?";

					<span class="quarter rightalign">
						<a
							class         = "buttonwhite redtext fa fa-refresh"
							target_id     = "<% $edit->id %>"
							property_name = "api_key"
%							if ($edit_settings{"api_key"}) {
								onClick       = "postConfirm(this, '<% $warn %>', 'api_generate.mhtml');"
%							} else {
								onClick       = "postSwitch(this, 'api_generate.mhtml');"
%							}
						></a>
					</span>
				</div>
			</span>

			<div class="libl pagefull rightalign padvertless">
				<span class="centeralign third">
					<input
						type  = "submit"
						value = "Save Changes"
					>
				</span>
			</div>

			<h5>Account Data</h5>

			<div>
				<div class="odd martop">
					<span class="half padvert redtext semibold">
						Last Password Change
					</span>
					<span class="threetenths semibold bluetext">
						<& "/funclib/showdt.mas",
							dt     => $edit_settings{"pass_timestamp"},
							tz     => $person->tz,
							tzname => "yes",
							length => "long",
							at     => 1
						&>
					</span>

					<span class="eighth semibold rightalign redtext">
						Send Reset
					</span>
					<span class="twenty semibold centeralign">
						<a
							target = "_blank"
							class  = "buttonwhite redtext fa fa-sm fa-retweet"
							href   = "/user/login/forgot_send.mhtml?username=<% $edit->email %>"
							title  = "Trigger Password Reset"
						></a>
					</span>
				</div>
			</div>
<%perl>
			if (
				$edit_settings{"pass_changekey"}
				&& $edit_settings{"pass_change_expires"}->epoch > $now->epoch)
			{
</%perl>
				<div>
					<div class="odd">
						<span class="half padvert orangetext semibold">
							Password Change Link Active Until
						</span>
						<span class="threetenths semibold bluetext">
							<& "/funclib/showdt.mas",
								dt     => $edit_settings{"pass_change_expires"},
								tz     => $person->tz,
								tzname => "yes",
								length => "long",
								at     => 1
							&>
						</span>

						<span class="eighth semibold rightalign redtext">
							Change Link
						</span>
						<span class="twenty semibold centeralign">
							<a
								class  = "buttonwhite redtext fa fa-sm fa-link"
								href   = "/user/login/forgot_change.mhtml?id=<% $edit->id%>&key=<% $edit_settings{"pass_changekey"} %>"
								title  = "Password Change Link"
							></a>
						</span>
					</div>
				</div>
%			}

			<div>
				<div class="odd martopmore bluebordertop">
					<span class="twothirds padvert">
						User has logged into Tabroom
					</span>
					<span class="third semibold bluetext">
						<% $edit_settings{"accesses"} %> times
					</span>
				</div>

				<div class="odd">
					<span class="twothirds padvert">
						Last successful login was on
					</span>
					<span class="third semibold bluetext">
						<& "/funclib/showdt.mas",
							dt => $edit_settings{"last_access"},
							tz => $person->tz,
							length => "long",
							at => 1
						&>
					</span>
				</div>

%				if ($edit_settings{"last_attempt"}) {
					<div class="odd">
						<span class="twothirds padvert">
							Last unsuccessful login was on
						</span>
						<span class="third semibold bluetext">
							<& "/funclib/showdt.mas",
								dt => $edit_settings{"last_attempt"},
								tz => $person->tz,
								length => "long",
								at => 1
							&>
						</span>
					</div>

					<div class="odd">
						<span class="twothirds padvert">
							That attempt IP address was
						</span>
						<span class="third semibold bluetext">
							<% $edit_settings{"last_attempt_ip"} %>
						</span>
					</div>

					<div class="odd">
						<span class="twothirds padvert">
							That attempt user agent
						</span>
						<span class="third semibold bluetext">
							<% $edit_settings{"last_attempt_agrnt"} %>
						</span>
					</div>
%				}
<%perl>
				if ($edit->nsda) {

					my ($person_ref, $flubber) = $m->comp(
						"/funclib/nsda/api_client.mas",
						path => "/members/".$edit->nsda
					) if $edit->nsda;

					if ($person_ref) {
</%perl>
						<div class="odd">
							<span class="twothirds padvert">
								NSDA Member link
							</span>

							<span class="third greentext semibold">
								#<% $person_ref->{person_id} %>
								(<% $person_ref->{first}." ".$person_ref->{middle}." ".$person_ref->{last} %>)
							</span>
						</div>

						<div class="odd blueborderbottom">
							<span class="twothirds padvert">
								NSDA Merit Point total is
							</span>

							<span class="third greentext semibold">
								<& "/funclib/commify.mas", number => $person_ref->{points} &>
							</span>
						</div>
%					}
%				}

			</div>
		</form>

		<h5 class="martopmore">
			NSDA Campus Usage
		</h5>

		<div class="row  padvert">
			<span class="fifth semibold bluetext">
				Competition Test
			</span>

			<span class="threetenths">
				<& "/funclib/showdt.mas",
					dt     => $edit_settings{"campus_test_private"},
					tz     => $edit->tz,
					tzname => 1
				&>
			</span>

			<span class="fifth semibold bluetext">
				Practice Test
			</span>

			<span class="threetenths">
				<& "/funclib/showdt.mas",
					dt     => $edit_settings{"campus_test_public"},
					tz     => $edit->tz,
					tzname => 1
				&>
			</span>
		</div>

		<p class="semibold bluetext martopmore">Last Campus Rooms Entered</h6>

%		foreach my $id (sort {$b <=> $a} keys %campus) {

			<div class="row  padvert">

				<span class="half nospace">
					<a
						href  = "/user/tourn/select.mhtml?tourn_id=<% $campus{$id}{"tourn_id"} %>"
						class = "white marno semibold bluetext"
						target= "_blank"
					>
						<span class="halfspacer"></span>
						<% $campus{$id}{"tourn"} %>
					</a>
				</span>

				<span class="quarter">
					<& "/funclib/showdt.mas",
						string => $campus{$id}{"timestamp"},
						tz     => $campus{$id}{"tz"},
						tzname => 1
					&>
				</span>

				<span class="quarter">
					<% $campus{$id}{"description"} %>
				</span>
			</div>
%		}

	</div>
