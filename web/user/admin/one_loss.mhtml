<%args>
	$person
</%args>
<%init>

	unless ($person->site_admin) {
		$m->abort();
	}

	Tab::Event->columns(TEMP => "tournname");

	Tab::Event->set_sql( district_debate => "
		select event.*, tourn.name as tournname
		from (event, tourn, tourn_setting)
		where tourn.start > '2018-08-01 00:00:00'
			and tourn.id = tourn_setting.tourn
			and tourn_setting.tag = 'nsda_pilot_debate'
			and	tourn.id = event.tourn
			and event.type = 'debate'
		order by tourn.id, event.name
	");

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select des.entry as eid, entry.id as id, entry.code as code, event.abbr as event
		from entry, entry_student es, student, event, entry_student des

		where event.tourn = 11965
			and event.id = entry.event
			and entry.id = es.entry
			and es.student = student.id
			and student.id = des.student
			and des.entry = ?
	");

	my $entry_sth = $dbh->prepare("
		select entry.id, entry.code, entry.active, entry.dropped, entry.waitlist,
			vacated.value as vacated, round.type, round.name roundname

			from (entry, round)
				left join entry_setting vacated
					on entry.id = vacated.entry
					and vacated.tag = 'nsda_vacate'

			where entry.id = ?
			and round.event = entry.event

			and round.name = (
				select max(myround.name)
				from panel, ballot, round myround
				where panel.id = ballot.panel
				and panel.round = myround.id
				and ballot.entry = entry.id
				and myround.event = entry.event
			)

			group by entry.id
			order by round.name
	");

	$m->print('<div class="main">');

	foreach my $event (Tab::Event->search_district_debate()) {

		my %losses = $m->comp("/funclib/entry_losses.mas", event => $event, all => 1);
		my %wins = $m->comp("/funclib/entry_wins.mas", event => $event, all => 1);

		next if $event->abbr eq "BQ";

		foreach my $entry (keys %losses) {

			if ($losses{$entry} == 1 && $wins{$entry} > 1) {

				$sth->execute($entry);
				$entry_sth->execute($entry);

				my $hashref = $sth->fetchall_hashref("eid");
				my $entryref = $entry_sth->fetchall_hashref("id");

				next if ($entryref->{$entry}{vacated});
				next if ($entryref->{$entry}{dropped});

				if ($hashref->{$entry}) {

				} else {

					$m->print("<p class='semibold'>$entry did not attend Nationals (".$wins{$entry}."-".$losses{$entry}.")");

					if ($entryref->{$entry}{vacated}) {
						$m->print("  VACATED");
						$m->print("</p>");
						next;
					} elsif ($entryref->{$entry}{active}) {

					} else {

						if ($entryref->{$entry}{dropped}) {
							$m->print("- DROPPED");
						}
					}

					$m->print($entryref->{$entry}{type}." round ".$entryref->{$entry}{"roundname"}." - ");
					$m->print($entryref->{$entry}{code}." ".$event->tournname." ".$event->abbr);
					$m->print("</p>");
				}
			}
		}
	}

	$m->print('</div>');

</%init>
