<%args>
	$person
	$person_settings
</%args>
<%init>

	use Tab::NSDA::EventCategory;
	my @codes = Tab::NSDA::EventCategory->retrieve_all();

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select event.id, event.name, event.abbr, event.type,
			tourn.name, tourn.start, tourn.end

			from tourn, event

			where tourn.end < NOW()
			and tourn.id = event.tourn
			and event.type != 'congress'
			and not exists (
				select es.id
				from event_setting es
				where es.event = event.id
				and es.tag = 'nsda_points_posted'
			)

			and exists (
				select es.id
				from event_setting es
				where es.event = event.id
				and es.tag = 'nsda_point_codefail'
			)

			and exists (
				select school.id
				from school, chapter
				where school.tourn = tourn.id
				and school.chapter = chapter.id
				and chapter.nsda > 0
			)

			and tourn.start > '2019-08-01 00:00:00'

			order by tourn.end, tourn.name, event.abbr
	");

	$sth->execute();

</%init>


	<div class="main">

		<span class="twothirds nospace">
			<h5>Unposted uncategorized events</h5>
		</span>
		<span
			class = "third rightalign"
			id    = "unposted_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas", table => "unposted" &>

		<table id="unposted">

			<thead>
				<tr class="yellowrow">

					<th>
						Tournament
					</th>

					<th>
						Ended
					</th>

					<th>
						Event Name
					</th>

					<th>
						Abbr
					</th>

					<th class="nosort">
						Type
					</th>

					<th class="nosort">
						Post
					</th>
				</tr>
			</thead>
			<tbody>
<%perl>

				while (
					my  (
						$event_id, $event_name, $event_abbr, $event_type,
						$tourn_name, $tourn_start, $tourn_end
					) = $sth->fetchrow_array()
				) {
</%perl>

					<tr id="<% $event_id %>">

						<td>
							<% $tourn_name %>
						</td>

						<td>
							<% $tourn_end %>
						</td>

						<td>
							<% $event_name %>
						</td>

						<td>
							<% $event_abbr %>
						</td>

						<td class="centeralign">
							<select
								name  = "code"
								id    = "<% $event_id %>_code"
								class = "fixedmed"
							>
%							foreach my $code (@codes) {
								<option
									value="<% $code->id %>"
									<% $event_type eq "debate" && $code->id == "101" ? "selected" : "" %>
									<% $event_type eq "speech" && $code->id == "201" ? "selected" : "" %>
								><% $code->name %></option>
%							}
							</select>
						</td>

						<td class="centeralign">
							<a
								class       = "fa fa-arrow-up fa-lg buttonwhite bluetext"
								target_id   = "<% $event_id %>"
								other_value = "<% $event_id %>_code"
								onClick     = "postSwitch(this, 'post_event.mhtml');"
							></a>
						</td>
					</tr>
%				}
			</tbody>
		</table>

	</div>

</%init>
