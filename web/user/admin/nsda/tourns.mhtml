<%args>
	$person
	$person_settings
	$future => undef
</%args>
<%init>

	my $after = &Tab::school_year();

	$after = DateTime->now() if $future;

	Tab::Tourn->set_sql( districts => "
		select distinct tourn.*
		from tourn, tourn_setting
		where tourn.id = tourn_setting.tourn
		and tourn_setting.tag = 'nsda_district'
		and tourn_setting.value > 0
		and tourn.start > ?
		group by tourn.id
		order by tourn.start, tourn_setting.value
	");

	my @tourns = Tab::Tourn->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

	my @nsda_contacts = $m->comp("/funclib/nsda_admins.mas");

	my @tabs = ("events", "settings");

	my $contact_target = "tourn_contacts.mhtml";

</%init>

	<script>

        function postResult(url, target, value, message) { 

			$.post(
				url, 

				{ target_id : target, value: value },

				function(reply) { 

					$("#"+target).val(reply);

					if (message) { 
						$.jGrowl(message, { 
							header   : 'Result:',
							life     : 4000,
							position : 'top-center',
							closer   : false
						});
					}
				}
			);

        };  

	</script>

	<& 
		"../menu.mas",
		whoami          => "district_tourns",
		person          => $person,
		person_settings => $person_settings,
		district_menu   => "tourns"
	&>

<div class="main">

	<h2>District Tournaments</h2>

	<& "/funclib/tablesorter.mas", table => "tourns" &>

	<& "/funclib/tabs.mas", tabs => \@tabs, default => "settings" &>

	<div class="events screens">

		<table id="tourns">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						Name 
					</th>

					<th>
						District
					</th>

					<th>
						Events
					</th>

					<th>
						IE Rules
					</th>

					<th class="nosort">
					</th>

				</tr>

			</thead>

			<tbody>

%			foreach my $tourn (@tourns) { 

%				my $district = Tab::District->retrieve($tourn->setting("nsda_district"));

				<tr class="smallish">

					<td class="nospace">

						<div class="full padleft padless">
							<% $tourn->name %>
						</div>

						<div class="full padleft padless martop">
							<% $tourn->city.", ".$tourn->state %>
						</div>

					</td>

					<td class="centeralign">
						<a 
							class = "plain padmuchmore hover marno"
							title = "<% $district->name %>"
							href  = "district_edit.mhtml?district_id=<% $district->id %>"
						>
							<% $district->code %>
						</a>
					</td>

					<td>
%						my @events = sort {$a->type cmp $b->type} $tourn->events;
%						my $last_type;

%						foreach my $event (@events) { 

%							if ($last_type ne $event->type) { 
%								$m->print("&mdash;") if $last_type;
%								$last_type = $event->type;
%							}

							<span class="padmore">
								<% $event->abbr %>
							</span>
%						}

					</td>

					<td class="centeralign">
						<% $tourn->setting("nsda_speech_method") eq "california" ? "CA Plan" : "Downs" %>
					</td>

					<td class="centeralign padless">
						<a 
							class = "bluetext buttonwhite fa fa-edit"
							title = "Enter Tournament as Admin"
							href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
						></a>
					</td>

				</tr>

%			}

			</tbody>

		</table>

	</div>

	<& "/funclib/tablesorter.mas", table => "contacts" &>

	<div class="screens settings">

		<table id="contacts">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						Name 
					</th>

					<th>
						Start
					</th>

					<th>
						End
					</th>

					<th>
						Strikes
					</th>

					<th>
						Ratings
					</th>

					<th>
						Office Contact Rotation
					</th>

					<th class="nosort">
					</th>

				</tr>

			</thead>

			<tbody>

%			foreach my $tourn (@tourns) { 

%				my $district = Tab::District->retrieve($tourn->setting("nsda_district"));

				<tr class="smallish">

					<td class="nospace">

						<div class="full padleft padless">
							<% $tourn->name %>
						</div>

						<div class="full padleft padless martop">
							<% $tourn->city.", ".$tourn->state %>
						</div>

					</td>

					<td class="centeralign">
						<span class="hidden">
							<% $tourn->start->epoch %>
						</span>
						<% Tab::niceshortdate($tourn->start) %>
					</td>

					<td class="centeralign">
						<span class="hidden">
							<% $tourn->end->epoch %>
						</span>
						<% Tab::niceshortdate($tourn->end) %>
					</td>


					<td class="centeralign">

%						my $current = $tourn->setting("nsda_strikes");

						<& "/funclib/phoneswitch.mas", 
							url     => "strike_switch",
							value   => "nsda_strikes",
							target  => $tourn->id,
							current => $current
						&>
				
					</td>	

%						$current = $tourn->setting("nsda_ratings");

					<td class="centeralign">

						<& "/funclib/phoneswitch.mas", 
							url     => "rating_switch",
							value   => "nsda_ratings",
							target  => $tourn->id,
							current => $current
						&>

					</td>

					<td class="centeralign">

%						foreach my $tag (1 .. 3) { 

%							my $existing = $tourn->setting("nsda_contact_".$tag);

							<div class="padless padright marno full nowrap">

								<span class="tenth marno padless">
									<% $tag %>.
								</span>

								<span class="ninetenths marno padless">

									<select 
										name     = "nsda_contact_<% $tag %>"
										class    = "fixedmed thin plain"
										id       = "<% $tourn->id."-".$tag %>"
										onChange = "postResult( 
														'<% $contact_target %>',
														'<% $tourn->id %>-<% $tag %>',
														this.value,
														'Contact saved for <% $tourn->name %>'
													);"
									>

										<option value=""></option>

%										foreach my $contact (@nsda_contacts) { 

											<option 
												value="<% $contact->id %>"
												<% $contact->id == $existing ? 'selected="selected"' : "" %>
											><% $contact->email %></option>

%										}
									</select>

								</span>
							</div>
%						}

					</td>

					<td class="centeralign padless">
						<a 
							class = "bluetext buttonwhite fa fa-edit"
							title = "Enter Tournament as Admin"
							href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
						></a>
					</td>

				</tr>


%			}

			</tbody>

		</table>

	</div>

</div>
