<%args>
	$person
	$person_settings
	$future => undef
</%args>
<%init>

	my $after = &Tab::school_year();

	$after = DateTime->now() if $future;

	Tab::Tourn->set_sql( districts => "
		select distinct tourn.*
		from tourn, tourn_setting
		where tourn.id = tourn_setting.tourn
		and tourn_setting.tag = 'nsda_district'
		and tourn_setting.value > 0
		and tourn.start > ?
		group by tourn.id
		order by tourn.start, tourn_setting.value
	");

	my @tourns = Tab::Tourn->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

	my @nsda_contacts = $m->comp("/funclib/nsda_admins.mas");

	my @tabs = ("tournaments", "orders", "settings");

	my $contact_target = "tourn_contacts.mhtml";

</%init>

	<script>

        function postResult(url, target, value, message) { 

			$.post(
				url, 

				{ target_id : target, value: value },

				function(reply) { 

					$("#"+target).val(reply);

					if (message) { 
						alertify.success(message);
					}
				}
			);

        };  

	</script>

	<& 
		"../menu.mas",
		whoami          => "district_tourns",
		person          => $person,
		person_settings => $person_settings,
		district_menu   => "tourns"
	&>

<div class="main">

	<h2>District Tournament Checklist</h2>

	<& "/funclib/tablesorter.mas", table => "tourns" &>

	<& "/funclib/tabs.mas", tabs => \@tabs, default => "tournaments" &>

	<div class="tournaments screens">

		<span class="threequarters nospace">
			<h4><% $after->year %> - <% $after->year + 1 %> Districts</h4>
		</span>
		<span 
			id    = "tourns_buttonarea"
			class = "quarter rightalign"
		>
		</span>

		<table id="tourns">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						District
					</th>

					<th>
						Name
					</th>

					<th>
						Start
					</th>

					<th>
						End
					</th>

					<th>
						Reg Start
					</th>

					<th>
						Reg End
					</th>

					<th>
						Points
					</th>

					<th>
						Results
					</th>

					<th>
						Method
					</th>

					<th>
						IE Rules
					</th>

					<th class="nosort">
						Events
					</th>

					<th class="nosort">
						Admin
					</th>
				</tr>

			</thead>

			<tbody>

<%perl>

			foreach my $tourn (@tourns) { 

				my $district = Tab::District->retrieve($tourn->setting("nsda_district"));
   				
				my $tabbing = $tourn->setting("nsda_tabbing_software");
				$tabbing = "TR" if $tabbing eq "tabroom";
				$tabbing = "JOT" if $tabbing eq "jot";

				my $rules = $tourn->setting("nsda_speech_method");

				$rules = "DD" if $rules eq "doubledown";
				$rules = "C3" if $rules eq "california_3";
				$rules = "C2" if $rules eq "california_2";

				my %events = ();

				foreach my $event ($tourn->events) { 
					push @{$events{$event->setting("weekend")}}, $event;
				}

				foreach my $weekend ($tourn->weekends) { 

</%perl>
					<tr class="smallish">

						<td>
							<% $district->name %>
						</td>

						<td>
							<% $weekend->name %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->start->epoch() %></span>
							<% Tab::niceshortdate($weekend->start) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->end->epoch() %></span>
							<% Tab::niceshortdate($weekend->end) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->reg_start->epoch() %></span>
							<% Tab::niceshortdate($weekend->reg_start) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->reg_end->epoch() %></span>
							<% Tab::niceshortdate($weekend->reg_end) %>
						</td>

						<td class="centeralign">
							<% $weekend->setting("points_posted") ? "Y" : "N" %>
						</td>

						<td class="centeralign">
							<% $tourn->setting("nsda_registered") ? "Y" : "N"  %>
						</td>

						<td class="centeralign">
							<% $tabbing %>
						</td>

						<td class="centeralign">
							<% $rules %>
						</td>

						<td class="centeralign">
%							foreach my $event (@{$events{$weekend->id}}) { 
								<% $event->abbr %>
%							}
						</td>

						<td class="centeralign padless">
							<a 
								class = "bluetext buttonwhite fa fa-edit hover fa-sm"
								title = "Enter Tournament as Admin"
								href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
							></a>
						</td>

					</tr>
%				}

%				if ($events{"nope"}) { 

					<tr class="smallish">

						<td>
							<% $district->name %>
						</td>

						<td>
							Not Held
						</td>

						<td colspan="8">
						</td>

						<td class="centeralign">
%							foreach my $event (@{$events{"nope"}}) { 
								<% $event->abbr %>
%							}
						</td>

						<td>
						</td>


					</tr>
%				}

%			}

			</tbody>

		</table>

	</div>

	<& "/funclib/tablesorter.mas", table => "contacts" &>

	<div class="screens settings">

		<table id="contacts">

			<thead>

				<tr class="yellowrow smallish">

%					if ($person->id == 1) {
						<th>
							PDLS
						</th>
%					}
					<th>
						Name 
					</th>

					<th>
						Start
					</th>

					<th>
						End
					</th>

					<th>
						Strikes
					</th>

					<th>
						Ratings
					</th>

					<th>
						Office Contact Rotation
					</th>

					<th class="nosort">
					</th>

				</tr>

			</thead>

			<tbody>

%			foreach my $tourn (@tourns) { 

%				my $district = Tab::District->retrieve($tourn->setting("nsda_district"));

				<tr class="smallish">

%					if ($person->id == 1) {

						<td class="centeralign padless">
							<a 
								class = "bluetext buttonwhite fa fa-wrench hover"
								title = "Fix the Friggin Sweepstakes"
								href  = "/user/nsda/district_sweepstakes_save.mhtml?tourn_id=<% $tourn->id %>"
							></a>
							<% scalar $tourn->sweep_sets %>
						</td>

%					}

					<td class="nospace">

						<div class="full padleft padless">
							<% $tourn->name %>
						</div>

						<div class="full padleft padless martop">
							<% $tourn->city.", ".$tourn->state %>
						</div>

					</td>

					<td class="centeralign">
						<span class="hidden">
							<% $tourn->start->epoch %>
						</span>
						<% Tab::niceshortdate($tourn->start) %>
					</td>

					<td class="centeralign">
						<span class="hidden">
							<% $tourn->end->epoch %>
						</span>
						<% Tab::niceshortdate($tourn->end) %>
					</td>


					<td class="centeralign">

%						my $current = $tourn->setting("nsda_strikes");

						<span class="hidden"> <% $current %> </span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $tourn->id %>_strikes"
								setting_name = "nsda_strikes"
								target_type  = "tourn"
								target_id    = "<% $tourn->id %>"
								onChange     = "postSwitch( this, 'districts_switch.mhtml');"

								<% $current ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</td>	

					<td class="centeralign">

%						$current = $tourn->setting("nsda_ratings");

						<span class="hidden"> <% $current %> </span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $tourn->id %>_ratings"
								setting_name = "nsda_ratings"
								target_type  = "tourn"
								target_id    = "<% $tourn->id %>"
								onChange     = "postSwitch( this, 'districts_switch.mhtml');"

								<% $current ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</td>

					<td class="centeralign">

%						foreach my $tag (1 .. 3) { 

%							my $existing = $tourn->setting("nsda_contact_".$tag);

							<div class="padless padright marno full nowrap">

								<span class="tenth marno padless">
									<% $tag %>.
								</span>

								<span class="ninetenths marno padless">

									<select 
										name     = "nsda_contact_<% $tag %>"
										class    = "fixedmed thin plain"
										id       = "<% $tourn->id."-".$tag %>"
										onChange = "postResult( 
														'<% $contact_target %>',
														'<% $tourn->id %>-<% $tag %>',
														this.value,
														'Contact saved for <% $tourn->name %>'
													);"
									>

										<option value=""></option>

%										foreach my $contact (@nsda_contacts) { 

											<option 
												value="<% $contact->id %>"
												<% $contact->id == $existing ? 'selected="selected"' : "" %>
											><% $contact->email %></option>

%										}
									</select>

								</span>
							</div>
%						}

					</td>

					<td class="centeralign padless">
						<a 
							class = "bluetext buttonwhite fa fa-edit hover"
							title = "Enter Tournament as Admin"
							href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
						></a>
					</td>

				</tr>


%			}

			</tbody>

		</table>

	</div>

</div>
