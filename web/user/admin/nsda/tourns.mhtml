<%args>
	$person
	$person_settings
	$future => undef
	$default => 'tournaments'
	$tourn => undef
</%args>
<%init>

	my $after = &Tab::school_year();

	$after = DateTime->now() if $future;

	Tab::Tourn->columns(TEMP => "district");

	if ($tourn) { 
		$tourn->district($tourn->setting("nsda_district"));
	}

	Tab::Tourn->set_sql( districts => "
		select distinct tourn.*, tourn_setting.value as district
		from tourn, tourn_setting
		where tourn.id = tourn_setting.tourn
		and tourn_setting.tag = 'nsda_district'
		and tourn_setting.value > 0
		and tourn.start > ?
		group by tourn.id
		order by tourn.start, tourn_setting.value
	");

	my @tourns = Tab::Tourn->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

	my @nsda_contacts = $m->comp("/funclib/nsda_admins.mas");

	my @tabs = ("tournaments", "orders", "survey", "settings", "not_done", "change_log");

	my $contact_target = "tourn_contacts.mhtml";

	my %tourn_settings;

	my ($keys, $event_ref) = $m->comp("/funclib/nsda_events.mas");

</%init>

	<script>

        function postResult(url, target, value, message) { 

			$.post(
				url, 

				{ target_id : target, value: value },

				function(reply) { 

					$("#"+target).val(reply);

					if (message) { 
						alertify.success(message);
					}
				}
			);

        };  

	</script>

	<& 
		"../menu.mas",
		whoami          => "district_tourns",
		person          => $person,
		person_settings => $person_settings,
		district_menu   => "tourns"
	&>

<div class="main">

	<h2>District Tournament Checklist</h2>

	<& "/funclib/tablesorter.mas", table => "tourns" &>

	<& "/funclib/tabs.mas", tabs => \@tabs, default => $default &>

	<div class="tournaments screens">

		<span class="threequarters nospace">
			<h4><% $after->year %> - <% $after->year + 1 %> Districts</h4>
		</span>
		<span 
			id    = "tourns_buttonarea"
			class = "quarter rightalign"
		>
		</span>

		<table id="tourns">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						District
					</th>
					<th>
						St
					</th>

					<th>
						Name
					</th>

					<th>
						Start
					</th>

					<th>
						End
					</th>

					<th>
						Reg Start
					</th>

					<th>
						Reg End
					</th>

					<th>
						Points
					</th>

					<th>
						Results
					</th>

					<th>
						Method
					</th>

					<th>
						IE Rules
					</th>

					<th class="nosort">
						Events
					</th>

					<th class="nosort">
						Admin
					</th>
				</tr>

			</thead>

			<tbody>

<%perl>

			foreach my $tourn (@tourns) { 

				my $district = Tab::District->retrieve($tourn->district);
				next unless $district;

				%{$tourn_settings{$tourn->id}} = $tourn->all_settings();
   				
				my $tabbing = $tourn_settings{$tourn->id}{"nsda_tabbing_software"};
				$tabbing = "TR" if $tabbing eq "tabroom";
				$tabbing = "JOT" if $tabbing eq "jot";

				my $rules = $tourn_settings{$tourn->id}{"nsda_speech_method"};

				$rules = "DD" if $rules eq "doubledown";
				$rules = "C3" if $rules eq "california_3";
				$rules = "C2" if $rules eq "california_2";

				my %events = ();

				foreach my $event ($tourn->events) { 

					my $weekend = $event->setting("weekend");
					$weekend = "nope" unless $weekend;

					push @{$events{$weekend}}, $event;
				}

				foreach my $weekend ($tourn->weekends) { 

</%perl>
					<tr class="smallish">

						<td>
							<% $district->name %>
						</td>
						<td>
							<% $district->location %>
						</td>

						<td>
							<% $weekend->name %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->start->epoch() %></span>
							<% Tab::shortdate($weekend->start) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->end->epoch() %></span>
							<% Tab::shortdate($weekend->end) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->reg_start->epoch() %></span>
							<% Tab::shortdate($weekend->reg_start) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->reg_end->epoch() %></span>
							<% Tab::shortdate($weekend->reg_end) %>
						</td>

						<td class="centeralign">
							<% $weekend->setting("points_posted") ? "Y" : "N" %>
						</td>

						<td class="centeralign">
							<% $tourn_settings{$tourn->id}{"nsda_registered"} ? "Y" : "N"  %>
						</td>

						<td class="centeralign">
							<% $tabbing %>
						</td>

						<td class="centeralign">
							<% $rules %>
						</td>

						<td class="centeralign">
%							foreach my $event (@{$events{$weekend->id}}) { 
								<% $event->abbr %>
%							}
						</td>

						<td class="centeralign padless">
							<a 
								class = "bluetext buttonwhite fa fa-edit hover fa-sm"
								title = "Enter Tournament as Admin"
								href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
							></a>
						</td>

					</tr>
%				}

%				if ($events{"nope"}) { 

					<tr class="smallish">

						<td>
							<% $district->name %>
						</td>
						<td>
							<% $district->location %>
						</td>

						<td>
							Not Held
						</td>

						<td colspan="8">
						</td>

						<td class="centeralign">
%							foreach my $event (@{$events{"nope"}}) { 
								<% $event->abbr %>
%							}
						</td>

						<td>
						</td>


					</tr>
%				}

%			}

			</tbody>

		</table>

	</div>

	<div class="screens orders">

		<span class="half">
			<h5>District orders</h5>
		</span>
		<span 
			class = "half rightalign"
			id    = "order_table_buttonarea"
		>
		</span>

			<& "/funclib/tablesorter.mas", table => "order_table" &>

			<table id="order_table">

				<thead>

				<tr class="yellowrow smallish padtop padbottom">
					
					<th>
						District
					</th>

					<th>
						Coach
					</th>

					<th>
						Principal
					</th>

					<th>
						SOY
					</th>

					<th>
						Alum
					</th>

					<th>
						Comm
					</th>

					<th class="borderright">
						Vol
					</th>

					<th>
						EXT
					</th>

					<th class="borderright">
						Date
					</th>

					<th>
						CX
					</th>

					<th class="borderright">
						Date
					</th>

					<th>
						LD
					</th>

					<th class="borderright">
						Date
					</th>

					<th>
						PF
					</th>

					<th>
						Date
					</th>

				</tr>

				</thead>

				<tbody>

<%perl>
				foreach my $tourn (@tourns) {

					my $district = Tab::District->retrieve($tourn->district);
					next unless $district;

					my $policy = Tab::Event->search( abbr => "CX", tourn => $tourn)->first;
					my $ld = Tab::Event->search( abbr => "LD", tourn => $tourn)->first;
					my $pf = Tab::Event->search( abbr => "PF", tourn => $tourn)->first;

					my $int_extemp = Tab::Event->search( abbr => "IX", tourn => $tourn)->first;
					my $us_extemp = Tab::Event->search( abbr => "USX", tourn => $tourn)->first;

					my %weekends_by_id = map {$_->id => $_} $tourn->weekends();

</%perl>

					<tr>
						
						<td>
							<% $district->name %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"nsda_coach_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"nsda_principal_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"nsda_student_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"nsda_alum_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"nsda_communicator_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign borderright'>
							<% $tourn_settings{$tourn}{"nsda_volunteer_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"nsda_extemp_topics"} ? "Y" : "" %>
						</td>

						<td class="borderright">

<%perl>

							my $int_weekend = $weekends_by_id{$int_extemp->setting('weekend')}
								if $int_extemp;

							my $us_weekend = $weekends_by_id{$us_extemp->setting('weekend')}
								if $us_extemp;

</%perl>
%							if ($int_weekend && $int_weekend == $us_weekend) { 
								<% Tab::shortdate($int_weekend->start) %>
%							} elsif ($int_weekend || $us_weekend)  { 

								<div class="full marless">
									<% $int_weekend ? "IX: ".Tab::shortdate($int_weekend->start) : ""%>
								</div>
								<div class="full marless">
									<% $us_weekend ? "USX: ".Tab::shortdate($us_weekend->start) : ""%>
								</div>
%							}

						</td>

						<td>
							<% $policy ? $policy->setting("nsda_ballot_order") : "" %>
						</td>

						<td class="borderright">
%							if ($policy && $policy->setting("nsda_ballot_order")) { 
%								my $cx_weekend = $weekends_by_id{$policy->setting('weekend')} if $policy;
								<% $cx_weekend ? Tab::shortdate($cx_weekend->start) : "" %>
%							}
						</td>

						<td>
							<% $ld ?  $ld->setting("nsda_ballot_order") : "" %>
						</td>

						<td class="borderright">
%							if ($ld && $ld->setting("nsda_ballot_order")) { 
%								my $ld_weekend = $weekends_by_id{$ld->setting('weekend')} if $ld;
								<% $ld_weekend ? Tab::shortdate($ld_weekend->start) : "" %>
%							}
						</td>

						<td>
							<% $pf ?  $pf->setting("nsda_ballot_order") : "" %>
						</td>

						<td>
%							if ($pf &&  $pf->setting("nsda_ballot_order")) { 
%								my $pf_weekend = $weekends_by_id{$pf->setting('weekend')} if $pf;
								<% $pf_weekend ? Tab::shortdate($pf_weekend->start) : "" %>
%							}
						</td>

					</tr>

%				}

				</tbody>

			</table>
	</div>

	<& "/funclib/tablesorter.mas", table => "contacts" &>

	<div class="screens settings">

		<table id="contacts">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						Name 
					</th>

					<th>
						Strikes
					</th>

					<th>
						Ratings
					</th>

					<th>
						Events
					</th>

					<th>
						JOT Approved
					</th>

					<th>
						Office Contact Rotation
					</th>

					<th class="nosort">
					</th>

				</tr>

			</thead>

			<tbody>

%			foreach my $tourn (@tourns) { 

%				my $district = Tab::District->retrieve($tourn->district);

				<tr class="smallish">

					<td class="nospace">

						<div class="full padleft padless">
							<% $tourn->name %>
						</div>

					</td>

					<td class="centeralign">

%						my $current = $tourn_settings{$tourn->id}{"nsda_strikes"};

						<span class="hidden"> <% $current %> </span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $tourn->id %>_strikes"
								setting_name = "nsda_strikes"
								target_type  = "tourn"
								target_id    = "<% $tourn->id %>"
								onChange     = "postSwitch( this, 'districts_switch.mhtml');"

								<% $current ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</td>	

					<td class="centeralign">

%						$current = $tourn_settings{$tourn->id}{"nsda_ratings"};

						<span class="hidden"> <% $current %> </span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $tourn->id %>_ratings"
								setting_name = "nsda_ratings"
								target_type  = "tourn"
								target_id    = "<% $tourn->id %>"
								onChange     = "postSwitch( this, 'districts_switch.mhtml');"

								<% $current ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</td>

%					my @events = $tourn->events;

					<td class="centeralign">
						<% scalar @events %>
					</td>

					<td class="centeralign">

%						unless (@events) { 
							<div class="semibold redtext full marno">
								Setup not done
							</div>
%						}

%						if ($tourn_settings{$tourn->id}{"nsda_tabbing_software"} eq "jot") { 

%							$current = $tourn_settings{$tourn->id}{"nsda_jot_tabbed"};

							<span class="hidden"> <% $current %> </span>

							<label class="switch">
								<input 
									type         = "checkbox"
									value        = "1"
									id           = "<% $tourn->id %>_jot_tabbed"
									setting_name = "nsda_jot_tabbed"
									target_type  = "tourn"
									target_id    = "<% $tourn->id %>"
									onChange     = "postSwitch( this, 'districts_switch.mhtml');"

									<% $current ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>

%						} else { 
							<div class="full marno semibold">
								Tabroom
							</div>
%						}

					</td>	


					<td class="centeralign">

%						foreach my $tag (1 .. 3) { 

%							my $existing = $tourn_settings{$tourn->id}{"nsda_contact_".$tag};

							<div class="padless padright marno full nowrap">

								<span class="tenth marno padless">
									<% $tag %>.
								</span>

								<span class="ninetenths marno padless">

									<select 
										name     = "nsda_contact_<% $tag %>"
										class    = "fixedmed thin plain"
										id       = "<% $tourn->id."-".$tag %>"
										onChange = "postResult( 
														'<% $contact_target %>',
														'<% $tourn->id %>-<% $tag %>',
														this.value,
														'Contact saved for <% $tourn->name %>'
													);"
									>

										<option value=""></option>

%										foreach my $contact (@nsda_contacts) { 

											<option 
												value="<% $contact->id %>"
												<% $contact->id == $existing ? 'selected="selected"' : "" %>
											><% $contact->email %></option>

%										}
									</select>

								</span>
							</div>
%						}

					</td>

					<td class="centeralign padless">
						<a 
							class = "bluetext buttonwhite fa fa-edit hover"
							title = "Enter Tournament as Admin"
							href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
						></a>
					</td>

				</tr>


%			}

			</tbody>

		</table>

	</div>

	<div class="screens survey">

		<span class="half">
			<h5>Survey Responses</h5>
		</span>
		<span 
			class = "half rightalign"
			id    = "survey_table_buttonarea"
		>
		</span>

			<& "/funclib/tablesorter.mas", table => "survey_table" &>

			<table id="survey_table">

				<thead>

				<tr class="yellowrow smallish padtop padbottom">
					
					<th>
						District
					</th>

					<th>
						Base
					</th>

					<th>
						IE
					</th>

					<th class="borderright">
						Hire
					</th>

					<th>
						DB
					</th>

					<th class="borderright">
						Hire
					</th>

					<th>
						CN
					</th>

					<th class="borderright">
						Hire
					</th>

%					foreach my $event (@{$keys}) { 
						<th>
							<% $event %>
						</th>
%					}

					<th>
						Notes
					</th>

				</tr>

				</thead>

				<tbody>

%				foreach my $tourn (@tourns) {

%					my %event_by_abbr = map {$_->abbr => $_} $tourn->events;
%					my %event_settings = $m->comp('/funclib/event_settings.mas', tourn => $tourn);
%					my $district = Tab::District->retrieve($tourn->district);

					<tr>
						
						<td>
							<% $district->name %>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn}{"survey_school_fee"}) %>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn}{"survey_obligation_ie"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"survey_no_hire_ie"} 
								? "N" 
								: $tourn_settings{$tourn}{"survey_hire_ie"} 
							%>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn}{"survey_obligation_debate"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"survey_no_hire_debate"} 
								? "N" 
								: $tourn_settings{$tourn}{"survey_hire_debate"} 
							%>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn}{"survey_obligation_con"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn}{"survey_no_hire_con"} 
								? "N" 
								: $tourn_settings{$tourn}{"survey_hire_con"} 
							%>
						</td>

%						foreach my $abbr (@{$keys}) { 
%							my $event = $event_by_abbr{$abbr};
							<td class="rightalign">
								<% $event ? int($event_settings{$event->id}{"survey_fees"}) : "" %>
							</td>
%						}

%						my $strip = HTML::Strip->new();
%						my $message = $strip->parse( $tourn_settings{$tourn}{"survey_explanation"} );

						<td class="smallish">
							<% $message %>
						</td>

					</tr>

%				}

				</tbody>

			</table>
	</div>

	<div class="screens not_done">

<%perl>

	Tab::District->columns(TEMP => qw/first last email/);

	Tab::District->set_sql( districts => "
		select distinct district.*, chair.first first, chair.last last, chair.email email
		from district

		left join permission on district.id = permission.district and permission.tag = 'chair'
		left join person chair on chair.id = permission.person

		where district.id > 0
		and district.realm = 'NFL'
		and not exists ( 
			select tourn.id 
			from tourn, tourn_setting 
			where tourn.id = tourn_setting.tourn
			and tourn_setting.tag = 'nsda_district'
			and tourn_setting.value = district.id
			and tourn.start > ?
		)
	");

	my @districts = Tab::District->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

</%perl>

	<& "/funclib/tablesorter.mas", table => "notdone" &>

		<span class="threequarters">
			<h5><% scalar @districts %> Districts without tournaments</h5>
		</span>
		<span 
			class = "quarter rightalign"
			id    = "notdone_buttonarea"
		>
		</span>

		<table id="notdone">

			<thead>
				<tr class="yellowrow">
					<th>
						District
					</th>
					<th>	
						State
					</th>
					<th>
						Chair
					</th>
				</tr>
			</thead>

			<tbody>
%				foreach my $district (@districts) { 
					<tr>
						<td>
							<% $district->name %>
						</td>
						<td>
							<% $district->location %>
						</td>
						<td>
							<a
								class = "plain padmore full hover"
								title = "mailto:<% $district->email %>"
								href  = "mailto:<% $district->email %>">
								<% $district->first %> <% $district->last %>
							</a>
						</td>
					</tr>
%				}

			</tbody>

		</table>

	</div>

<%perl>

	Tab::ChangeLog->columns(TEMP => "tournname");

	Tab::ChangeLog->set_sql( districts => "

		select distinct change_log.*, tourn.name as tournname
		from change_log, tourn
		where change_log.timestamp > ? 
		and change_log.tourn = tourn.id
		and change_log.type = 'districts'
		order by change_log.timestamp DESC
	");

	my @changes = Tab::ChangeLog->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

</%perl>

	<div class="screens change_log">

		<& "/funclib/tablesorter.mas", table => "changelog" &>

		<span class="threequarters">
			<h5>Change log</h5>
		</span>

		<span 
			class = "quarter rightalign"
			id    = "changelog_buttonarea"
		>
		</span>

		<table id="changelog">

			<thead>

				<tr class="yellowrow">

					<th>
						Tournament
					</th>

					<th>	
						Date
					</th>

					<th>
						Change by
					</th>

					<th>
						Log
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $change (@changes) { 

					<tr>

						<td>
							<% $change->tournname %>
						</td>

						<td>
							<span class="hidden"><% $change->timestamp->epoch() %></span>
							<% Tab::shortdate($change->timestamp) %>
						</td>

						<td>
							<a 
								href  = "mailto:<% $change->person->email %>"
								title = "mailto:<% $change->person->email %>"
								class = "full hover plain"
							>
								<% $change->person->first." ".$change->person->last %>
							</a>
						</td>

						<td>
							<% $change->description %>
						</td>

					</tr>

%				}

			</tbody>

		</table>

	</div>

</div>
