<%args>
	$person
	$person_settings
	$future  => undef
	$default => 'tournaments'
	$tourn   => undef
	$deleted => 0
	$year    => undef
</%args>
<%init>

	use Math::Round;
	my $after;

	if ($year) {
		$after = DateTime->new({
			year   => $year,
			month  => 7,
			day    => 1,
			hour   => 0,
			minute => 0,
			second => 0
		});
	}

	unless ($after) {
		$after = &Tab::school_year();
	}

	$after = DateTime->now() if $future;

	my $limit = $after->clone();
	$limit->add(years => 1);

	Tab::Tourn->columns(TEMP => "district");
	Tab::Tourn->columns(TEMP => "chairid");

	my $tz = "America/Chicago";

	my %contacts = $m->comp("/funclib/nsda_admins.mas");
	my $contact_target = "tourn_contacts.mhtml";

	my @tabs = (
		"tournaments",
		"awards",
		"ballots",
		"extemp",
		"survey",
		"settings",
		"not_started",
		"change_log"
	);

	my ($keys, $event_ref) = $m->comp("/funclib/nsda_events.mas");
	my %questions = $m->comp("/funclib/districts_awards.mas");

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select
			tourn.id, tourn.name, tourn_setting.value, tourn.start,
			district.id, district.name, district.location, district.level,
			event.id, event.name, event.abbr,
				ballots.value, fees.value,
			weekend.id, weekend.name, weekend.start, weekend.end,
				weekend.reg_start, weekend.reg_end, weekend.timestamp,
				weekend_site.name, weekend.city, weekend.state,
			chair.id, chair.email, chair.first, chair.last, chair.phone,
			chair.street, chair.city, chair.state, chair.zip, chair.postal, chair.country,
			shipping.value_text

		from (tourn, tourn_setting, event, district)
		left join permission chairperm
			on chairperm.district = tourn_setting.value
			and chairperm.tag = 'chair'
		left join person chair on chairperm.person = chair.id
		left join event_setting esw on esw.event = event.id and esw.tag = 'weekend'
		left join event_setting ballots on ballots.event = event.id and ballots.tag = 'nsda_ballot_order'
		left join event_setting fees on fees.event = event.id and fees.tag = 'survey_fees'
		left join weekend on weekend.id = esw.value
		left join site weekend_site on weekend_site.id = weekend.site
		left join tourn_setting shipping on shipping.tourn = tourn.id and shipping.tag = 'shipping_address'

		where tourn.id = tourn_setting.tourn
			and tourn_setting.tag = 'nsda_district'
			and tourn_setting.value > 0
			and tourn.start > ?
			and tourn.end < ?
			and tourn.id = event.tourn
			and district.id = tourn_setting.value

		group by event.id
		order by tourn.start, tourn_setting.value, tourn.timestamp DESC
	");

	$sth->execute(
		DateTime::Format::MySQL->format_datetime($after),
		DateTime::Format::MySQL->format_datetime($limit)
	);

	my %tourns;
	my %weekends;

	sub dateme {
		my $string = shift;
		my ($date, $time) = split(/\ /, $string);
		my ($yr, $mo, $dy) = split(/-/, $date);

		$mo =~ s/^0//g;
		$dy =~ s/^0//g;
		$yr =~ s/^20//g;
		return $mo."/".$dy;
	}

	while (
		my (
            $tourn_id, $tourn_name, $tourn_district, $tourn_start,
			$district_id, $district_name, $district_location, $district_level,
            $event_id, $event_name, $event_abbr,
			$event_ballots, $event_fees,
            $weekend_id, $weekend_name, $weekend_start, $weekend_end,
				$weekend_reg_start, $weekend_reg_end, $weekend_timestamp,
				$weekend_sitename, $weekend_city, $weekend_state,
            $chair_id, $chair_email, $chair_first, $chair_last, $chair_phone,
				$chair_street, $chair_city, $chair_state, $chair_zip, $chair_postal, $chair_country,
			$shipping_address
		) = $sth->fetchrow_array()
	) {

		next unless $district_name;

		unless ($tourns{$tourn_id}{"name"}) {
			$tourns{$tourn_id}{"name"}              = $tourn_name;
			$tourns{$tourn_id}{"district"}          = $district_id;
			$tourns{$tourn_id}{"district_name"}     = $district_name;
			$tourns{$tourn_id}{"district_level"}    = $district_level;
			$tourns{$tourn_id}{"district_location"} = $district_location;
			$tourns{$tourn_id}{"chair"}             = $chair_id;
			$tourns{$tourn_id}{"chair_email"}       = $chair_email;
			$tourns{$tourn_id}{"chair_phone"}       = $chair_phone;
			$tourns{$tourn_id}{"chair_name"}        = $chair_first." ".$chair_last;

			if ($shipping_address) {
				$tourns{$tourn_id}{"address"} = eval {
					return JSON::decode_json($shipping_address);
				};
			}

			unless ($tourns{$tourn_id}{"address"}) {
				$tourns{$tourn_id}{"address"}{"name"} = $chair_first." ".$chair_last;
				$tourns{$tourn_id}{"address"}{"street"} = $chair_street;
				$tourns{$tourn_id}{"address"}{"city"} = $chair_city;
				$tourns{$tourn_id}{"address"}{"state"} = $chair_state;
				$tourns{$tourn_id}{"address"}{"zip"} = $chair_zip;
				$tourns{$tourn_id}{"address"}{"zip"} = $chair_postal unless $chair_zip;
				$tourns{$tourn_id}{"address"}{"country"} = $chair_country;
			}

			$tourns{$tourn_id}{"chair_email"}       = $chair_email;
		}

		if ($weekend_id) {

			unless ($weekends{$weekend_id}{"name"}) {

				$weekends{$weekend_id}{'tourn'} = $tourn_id;

				$weekends{$weekend_id}{"name"}      = $weekend_name;
				$weekends{$weekend_id}{"state"}     = $weekend_state;
				$weekends{$weekend_id}{"site"}      = $weekend_sitename;
				$weekends{$weekend_id}{"city"}      = $weekend_city;
				$weekends{$weekend_id}{"timestamp"} = $weekend_timestamp;
				$weekends{$weekend_id}{"start"}     = $weekend_start;
				$weekends{$weekend_id}{"end"}       = $weekend_end;
				$weekends{$weekend_id}{"reg_start"} = $weekend_reg_start;
				$weekends{$weekend_id}{"reg_end"}   = $weekend_reg_end;

				my $weekend_epoch = $weekend_start;
				$weekend_epoch =~ s/[\D_]//g;

				$weekends{$weekend_id}{"start_epoch"} = $weekend_epoch;

				if (
					(not defined $tourns{$tourn_id}{"start_epoch"})
					|| ($weekend_epoch < $tourns{$tourn_id}{'start_epoch'})
				) {
					$tourns{$tourn_id}{'start_epoch'} = $weekend_epoch;
					$tourns{$tourn_id}{'start'} = $weekend_start;
				}

				$weekends{$weekend_id}{"tourn"} = $tourn_id;
				$tourns{$tourn_id}{"weekends"}{$weekend_id} = $weekends{$weekend_id};
			}

			push @{$weekends{$weekend_id}{"events"}}, $event_id;
			$weekends{$weekend_id}{$event_abbr} = $event_id;

		} else {

			push @{$tourns{$tourn_id}{"nope"}}, $event_id;
		}

		$tourns{$tourn_id}{"events"}{$event_id}{"ballots"} = $event_ballots;
		$tourns{$tourn_id}{"events"}{$event_id}{"fees"}    = $event_fees;
		$tourns{$tourn_id}{"events"}{$event_id}{"name"}    = $event_name;
		$tourns{$tourn_id}{"events"}{$event_id}{"abbr"}    = $event_abbr;
		$tourns{$tourn_id}{"events"}{$event_id}{"weekend"} = $weekend_id;

		$tourns{$tourn_id}{"events"}{$event_id}{"weekend_start"} = $weekend_start;
		$tourns{$tourn_id}{"eventabbr"}{$event_abbr}             = $event_id;

	}

	$sth = $dbh->prepare("
		select tourn.id, tourn_setting.tag,
			tourn_setting.value, tourn_setting.value_date, tourn_setting.value_text
		from tourn_setting, tourn
		where tourn.start > ?
		and tourn.end < ?
		and tourn.id = tourn_setting.tourn

		and exists (
			select district.id
			from tourn_setting district
			where district.tourn = tourn.id
			and district.tag = 'nsda_district'
		)
	");

	my %tourn_settings;

	$sth->execute(
		DateTime::Format::MySQL->format_datetime($after),
		DateTime::Format::MySQL->format_datetime($limit)
	);

	while(
		my ($tourn_id, $tag, $value, $value_date, $value_text) = $sth->fetchrow_array()
	) {

		$tourn_settings{$tourn_id}{$tag} = $value;
		$tourn_settings{$tourn_id}{$tag} = $value_date if $value eq "date";
		$tourn_settings{$tourn_id}{$tag} = $value_text if $value eq "text";
	}

</%init>

	<script>
        function postResult(url, target, value, message) {
			$.post(
				url,
				{ target_id : target, value: value },
				function(reply) {
					$("#"+target).val(reply);
					if (message) {
						alertify.notify(message, "custom");
					}
				}
			);
        };
	</script>

	<&
		"../menu.mas",
		whoami          => "district_tourns",
		person          => $person,
		person_settings => $person_settings,
		district_menu   => "tourns"
	&>

<div class="main">

	<h2>District Tournament Checklist</h2>

	<& "/funclib/tablesorter.mas",
		table     => "tourns",
		invisible => "yah"
	&>

	<& "/funclib/tabs.mas",
		tabs    => \@tabs,
		default => $default
	&>

	<div class="tournaments screens">

		<span class="half nospace">
			<h4><% $after->year %> - <% $after->year + 1 %> Districts</h4>
		</span>

		<span
			class = "quarter centeralign"
		>
			<h6 class="semibold"><% scalar (keys %tourns) %> Districts</h6>
		</span>

		<span
			id    = "tourns_buttonarea"
			class = "quarter rightalign"
		>
		</span>

		<table id="tourns">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						District
					</th>

					<th>
						ST
					</th>

					<th>
						Made
					</th>

					<th>
						Name
					</th>

					<th>
						Start
					</th>

					<th>
						End
					</th>

					<th class="Registration Opens">
						RSt
					</th>

					<th class="Registration Closes">
						RE
					</th>

					<th title="Points Posted">
						Pts
					</th>

					<th title="Results Posted">
						Res
					</th>

					<th>
						Soft
					</th>

					<th>
						Rules
					</th>

					<th title="Running an online tournament even if in person possible">
						ONL
					</th>

					<th>
						IE
					</th>

					<th>
						Events
					</th>

					<th class="nosort">
					</th>

					<th class="hiddencsv">
						Site
					</th>

					<th class="hiddencsv">
						City
					</th>

					<th class="hiddencsv">
						State
					</th>

					<th class="hiddencsv">
						Chair
					</th>

					<th class="hiddencsv">
						Email
					</th>

%					foreach my $event (@{$keys}) {
						<th class="hiddencsv">
							<% $event %>
						</th>
%					}

					<th class="hiddencsv">
						Notes
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
			foreach my $tourn_id (keys %tourns) {

				my $tabbing = $tourn_settings{$tourn_id}{"nsda_tabbing_software"};

				if ($tabbing eq "tabroom") {
					$tabbing = "TR";
					$tabbing .= " 1" if $tourn_settings{$tourn_id}{"nsda_tabroom_first"};

				} elsif ($tabbing eq "speechwire") {
					$tabbing = "SW";
				} else {
					$tabbing = "??";
				}

				my $rules = $tourn_settings{$tourn_id}{"nsda_speech_method"};

				$rules = "DD" if $rules eq "doubledown";
				$rules = "C3" if $rules eq "california_3";
				$rules = "C2" if $rules eq "california_2";

				$rules = "PS" if $tourn_settings{$tourn_id}{"nsda_pilot_speech"};
				$rules .= "/PD" if $tourn_settings{$tourn_id}{"nsda_pilot_debate"};

				my $speech = ucfirst(substr($tourn_settings{$tourn_id}{"nsda_speech_online"},0,2));
				my $online = "Y" if $tourn_settings{$tourn_id}{"nsda_online_tournament"} eq "online";

				foreach my $weekend_id (
					sort { $tourns{$tourn_id}{"weekends"}{$a}{"start"} <=> $tourns{$tourn_id}{"weekends"}{$b}{"start"}}
					keys %{$tourns{$tourn_id}{"weekends"}}
				) {

</%perl>
					<tr class="smallish">

						<td>
							<% $tourns{$tourn_id}{"district_name"} %>
						</td>

						<td>
							<% $tourns{$tourn_id}{"district_location"} %>
						</td>

						<td>
							<% dateme($tourns{$tourn_id}{"weekends"}{$weekend_id}{"timestamp"}) %>
						</td>

						<td>
							<% $tourns{$tourn_id}{"weekends"}{$weekend_id}{"name"} %>
						</td>

						<td class="rightalign">
							<% dateme($tourns{$tourn_id}{"weekends"}{$weekend_id}{"start"}) %>
						</td>

						<td class="rightalign">
							<% dateme($tourns{$tourn_id}{"weekends"}{$weekend_id}{"end"}) %>
						</td>

						<td class="rightalign">
							<% dateme($tourns{$tourn_id}{"weekends"}{$weekend_id}{"reg_start"} ) %>
						</td>

						<td class="rightalign">
							<% dateme($tourns{$tourn_id}{"weekends"}{$weekend_id}{"reg_end"} ) %>
						</td>

						<td class="centeralign">
							<% $tourns{$tourn_id}{"weekends"}{$weekend_id}{"points"} ? "Y" : "N" %>
						</td>

						<td class="centeralign">
							<% $tourn_settings{$tourn_id}{"nsda_registered"} ? "Y" : "N"  %>
						</td>

						<td class="centeralign">
							<% $tabbing %>
						</td>

						<td class="centeralign">
							<% $rules %>
						</td>

						<td class="centeralign">
							<% $online %>
						</td>

						<td class="centeralign">
							<% $speech %>
						</td>

						<td class="centeralign">
%							my %yup;
%							foreach my $event_id (@{$tourns{$tourn_id}{"weekends"}{$weekend_id}{"events"}}) {
%								$yup{$tourns{$tourn_id}{"events"}{$event_id}{"abbr"}}++;
								<% $tourns{$tourn_id}{"events"}{$event_id}{"abbr"} %>
%							}
						</td>

						<td class="centeralign padless">
							<a
								class = "bluetext buttonwhite fa fa-edit hover fa-sm"
								title = "Enter Tournament as Admin"
								href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn_id %>"
							></a>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"weekends"}{$weekend_id}{"site"} %>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"weekends"}{$weekend_id}{"city"} %>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"weekends"}{$weekend_id}{"state"} %>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"chair_name"} %>
						</td>

						<td class="hiddencsv">
								<a href="mailto:<% $tourns{$tourn_id}{"chair_email"} %>">
								<% $tourns{$tourn_id}{"chair_email"} %>
							</a>
						</td>

%						foreach my $event (@{$keys}) {
							<th class="hiddencsv">
								<% $yup{$event} ? "Y" : "" %>
							</th>
%						}

						<td
							class="hiddencsv <% $tourn_id %>_notes"
						>
							<% $tourn_settings{$tourn_id}{"nsda_notes"} %>
						</td>

					</tr>
%				}

%				if ($tourns{$tourn_id}{"nope"}) {

					<tr class="smallish">

						<td>
							<% $tourns{$tourn_id}{"district_name"} %>
						</td>

						<td>
							<% $tourns{$tourn_id}{"district_location"} %>
						</td>

						<td>
						</td>

						<td>
							Not Held
						</td>

						<td colspan="10">
						</td>

						<td class="centeralign">
%							foreach my $event_id (@{$tourns{$tourn_id}{"nope"}}) {
								<% $tourns{$tourn_id}{"events"}{$event_id}{"abbr"} %>
%							}
						</td>

						<td>
						</td>

					</tr>
%				}

%			}

			</tbody>

		</table>

	</div>

	<div class="ballots screens">

		<span class="half nospace">
			<h5>Ballot Orders</h5>
		</span>

		<span
			class = "half rightalign nospace"
			id    = "ballots_table_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas",
			table     => "ballots_table",
			invisible => "yah"
		&>

		<table id="ballots_table">

			<thead>
				<tr class="yellowrow">
					<th>
						District
					</th>

					<th>
						Start Date
					</th>

					<th>
						Policy
					</th>

					<th>
						LD
					</th>

					<th>
						PF
					</th>

					<th>
						Chair
					</th>

					<th>
						Email
					</th>

					<th class="hiddencsv">
						Ship To
					</th>
					<th class="hiddencsv">
						Street
					</th>
					<th class="hiddencsv">
						Street2
					</th>
					<th class="hiddencsv">
						City/State/Zip
					</th>

					<th class="hiddencsv">
						Country
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>
				foreach my $weekend_id (
					sort {
						$weekends{$a}{"start_epoch"} <=> $weekends{$b}{"start_epoch"}
					} keys %weekends
				) {

					my $tourn_id = $weekends{$weekend_id}{"tourn"};
					my %orders;

					foreach my $event_id (@{$weekends{$weekend_id}{"events"}}) {
						next unless $tourns{$tourn_id}{"events"}{$event_id}{"ballots"};
						$orders{$event_id} = $tourns{$tourn_id}{"events"}{$event_id};
					}

					unless (keys %orders) {
						next;
					}
</%perl>

					<tr>

						<td>
							<% $tourns{$tourn_id}{"district_name"} %>
						</td>

						<td class='rightalign'>
							<span class="hidden">
								<% $weekends{$weekend_id}{"start_epoch"} %>
							</span>
							<% dateme($weekends{$weekend_id}{"start"}) %>
						</td>

						<td class="centeralign">
							<% $orders{$weekends{$weekend_id}{"CX"}}{"ballots"} %>
						</td>

						<td class="centeralign">
							<% $orders{$weekends{$weekend_id}{"LD"}}{"ballots"} %>
						</td>

						<td class="centeralign">
							<% $orders{$weekends{$weekend_id}{"PF"}}{"ballots"} %>
						</td>

						<td>
							<% $tourns{$tourn_id}{"chair_name"} %>
						</td>

						<td>
							<% $tourns{$tourn_id}{"chair_email"} %>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"address"}{"name"} %>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"address"}{"street"} %>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"address"}{"street2"} %>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"address"}{"city"} %>, <% $tourns{$tourn_id}{"address"}{"state"} %> <% $tourns{$tourn_id}{"address"}{"zip"} %>
						</td>

						<td class="hiddencsv">
							<% $tourns{$tourn_id}{"address"}{"country"} %>
						</td>
					</tr>
%				}

			</tbody>
		</table>

	</div>


	<div class="extemp screens">

		<span class="half nospace">
			<h5>Extemp Question Orders</h5>
		</span>

		<span
			class = "half rightalign nospace"
			id    = "extemp_table_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas",
			table     => "extemp_table",
			invisible => "yah"
		&>

		<table id="extemp_table">

			<thead>
				<tr class="yellowrow">
					<th>
						District
					</th>

					<th>
						Start Date
					</th>

					<th>
						IX
					</th>

					<th>
						USX
					</th>

					<th>
						Chair
					</th>

					<th>
						Chair Email
					</th>


				</tr>
			</thead>

			<tbody>

<%perl>
				foreach my $weekend_id (
					sort {
						$weekends{$a}{"start_epoch"} <=> $weekends{$b}{"start_epoch"}
					} keys %weekends
				) {

					my $tourn_id = $weekends{$weekend_id}{"tourn"};

					unless ($tourn_settings{$tourn_id}{"nsda_extemp_topics"}) {
						next;
					}

					unless ($weekends{$weekend_id}{"IX"} || $weekends{$weekend_id}{"USX"}) {
						next;
					}
</%perl>

					<tr>

						<td>
							<% $tourns{$tourn_id}{"district_name"} %>
						</td>

						<td class='rightalign'>
							<span class="hidden">
								<% $weekends{$weekend_id}{"start_epoch"} %>
							</span>
							<% dateme($weekends{$weekend_id}{"start"}) %>
						</td>

						<td class="centeralign">
							<% $weekends{$weekend_id}{"IX"} ? "Y" : "" %>
						</td>

						<td class="centeralign">
							<% $weekends{$weekend_id}{"USX"} ? "Y" : "" %>
						</td>

						<td>
							<% $tourns{$tourn_id}{"chair_name"} %>
						</td>

						<td>
							<% $tourns{$tourn_id}{"chair_email"} %>
						</td>
					</tr>
%				}

			</tbody>
		</table>

	</div>

	<div class="screens awards">

		<span class="half nospace">
			<h5>Awards orders</h5>
		</span>

		<span
			class = "threeeighths rightalign nospace"
		>
			<a
				class="bluetext buttonwhite smallish invert"
				href="order_sheets.mhtml"
			>Order Sheets</a>

		</span>

		<span
			class = "eighth rightalign nospace"
			id    = "awards_table_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas",
			table     => "awards_table",
			invisible => "yah"
		&>

		<table id="awards_table">

			<thead>

				<tr class="yellowrow smallish padtop padbottom">

					<th>
						District
					</th>

					<th>
						Level
					</th>

					<th>
						First Weekend
					</th>

%					foreach my $key (sort keys %questions) {
%						next if $questions{$key}{"short"} eq "Ext";
						<th title="<% $questions{$key}{"text"} %>">
							<% $questions{$key}{"short"} %>
						</th>
%					}

					<th>
						Chair
					</th>

					<th class="hiddencsv">
						Email
					</th>

					<th class="hiddencsv">
						Phone
					</th>

					<th class="hiddencsv">
						Ship To
					</th>
					<th class="hiddencsv">
						Street
					</th>
					<th class="hiddencsv">
						Street2
					</th>
					<th class="hiddencsv">
						City/State/Zip
					</th>

					<th class="hiddencsv">
						Country
					</th>
				</tr>

			</thead>
			<tbody>

<%perl>

			foreach my $tourn_id (
				sort {
					$tourns{$a}{"start_epoch"} <=> $tourns{$b}{"start_epoch"}
				} keys %tourns
			) {

</%perl>

				<tr>

					<td>
						<% $tourns{$tourn_id}{"district_name"} %>
					</td>

					<td class="centeralign">
						<% $tourns{$tourn_id}{"district_level"} %>
					</td>

					<td class="rightalign">
						<span class="hidden">
							<% $tourns{$tourn_id}{"start_epoch"} %>
						</span>
						<% dateme($tourns{$tourn_id}{"start"}) %>
					</td>

%					foreach my $key (sort keys %questions) {
%						next if $questions{$key}{"short"} eq "Ext";
						<td class="centeralign">
							<% $tourn_settings{$tourn_id}{$questions{$key}{"label"}} ? "Y" : "" %>
						</td>
%					}

					<td>
						<% $tourns{$tourn_id}{"chair_name"} %>
					</td>

					<td class="hiddencsv">
						<% $tourns{$tourn_id}{"chair_email"} %>
					</td>

					<td class="hiddencsv">
						<% Tab::phone($tourns{$tourn_id}{"chair_phone"}) %>
					</td>

					<td class="hiddencsv">
						<% $tourns{$tourn_id}{"address"}{"name"} %>
					</td>

					<td class="hiddencsv">
						<% $tourns{$tourn_id}{"address"}{"street"} %>
					</td>

					<td class="hiddencsv">
						<% $tourns{$tourn_id}{"address"}{"street2"} %>
					</td>

					<td class="hiddencsv">
						<% $tourns{$tourn_id}{"address"}{"city"} %>, <% $tourns{$tourn_id}{"address"}{"state"} %> <% $tourns{$tourn_id}{"address"}{"zip"} %>
					</td>

					<td class="hiddencsv">
						<% $tourns{$tourn_id}{"address"}{"country"} %>
					</td>

				</tr>
%			}

			</tbody>
		</table>
	</div>

	<div class="screens settings">

		<table id="contacts">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						Name
					</th>

					<th>
						Strikes
					</th>

					<th>
						Ratings
					</th>

					<th>
						Setup Status
					</th>

					<th>
						Office Contact Rotation
					</th>

					<th class="nosort">
					</th>

				</tr>

			</thead>

			<tbody>

%			foreach my $tourn_id (keys %tourns) {

				<tr class="smallish row">

					<td class="nospace padleft">

						<div class="full padless semibold bluetext">
							<% $tourns{$tourn_id}{"district_name"} %>
						</div>
<%perl>
						foreach my $weekend_id (
							sort { $tourns{$tourn_id}{"weekends"}{$a}{"start"} <=> $tourns{$tourn_id}{"weekends"}{$b}{"start"}}
							keys %{$tourns{$tourn_id}{"weekends"}}
						) {
</%perl>


							<div class="full padless marno smallish">

								<span class="threefifths nospace">
									<% $tourns{$tourn_id}{"weekends"}{$weekend_id}{"name"} %>
								</span>

								<span class="fifth nospace">
									<% dateme($tourns{$tourn_id}{"weekends"}{$weekend_id}{"start"}) %>
								</span>

								<span class="fifth nospace">
									<% dateme($tourns{$tourn_id}{"weekends"}{$weekend_id}{"end"}) %>
								</span>

							</div>
%						}


						<div class="full bordertop martop marno padno">

							<span class="fourfifths <% $tourn %>_notes">
								<% $tourn_settings{$tourn_id}{"nsda_notes"} %>
							</span>

							<span class="fifth">
								<a
									id		= "<% $tourn_id %>"
									title	= "Enter Tournament Notes"
									class	= "buttonwhite greentext fa-xs fa fa-edit formbutton hover"
									href	= "#"
								></a>
							</span>

						</div>

					</td>


					</td>

					<td class="centeralign">

%						my $current = $tourn_settings{$tourn_id}{"nsda_strikes"};

						<span class="hidden"> <% $current %> </span>

						<label class="switch">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $tourn_id %>_strikes"
								setting_name = "nsda_strikes"
								target_type  = "tourn"
								target_id    = "<% $tourn_id %>"
								onChange     = "postSwitch( this, 'tourn_switch.mhtml');"

								<% $current ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</td>

					<td class="centeralign">

%						$current = $tourn_settings{$tourn_id}{"nsda_ratings"};

						<span class="hidden"> <% $current %> </span>

						<label class="switch">
							<input
								type         = "checkbox"
								value        = "1"
								id           = "<% $tourn_id %>_ratings"
								setting_name = "nsda_ratings"
								target_type  = "tourn"
								target_id    = "<% $tourn_id %>"
								onChange     = "postSwitch( this, 'tourn_switch.mhtml');"

								<% $current ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</td>

					<td class="centeralign">
%						unless ($tourns{$tourn_id}) {
							XX
%						} elsif ($tourn_settings{$tourn_id}{"nsda_tabbing_software"} eq "speechwire") {
							SW
%						} else {
							TR
%						}
					</td>

					<td class="centeralign">

%						foreach my $tag (1 .. 3) {

%							my $existing = $tourn_settings{$tourn_id}{"nsda_contact_".$tag};

							<div class="padless padright marno full nowrap limit2">

								<span class="tenth marno padless">
									<% $tag %>.
								</span>

								<span class="ninetenths marno padless">

									<select
										name     = "nsda_contact_<% $tag %>"
										class    = "fixedsmall thin plain"
										id       = "<% $tourn_id."-".$tag %>"
										onChange = "postResult(
											'<% $contact_target %>',
											'<% $tourn_id %>-<% $tag %>',
											this.value,
											'Contact saved for <% $tourns{$tourn_id}{"name"} %>'
										);"
									>

										<option value=""></option>

%										foreach my $contact_id (keys %contacts) {
											<option
												value="<% $contact_id %>"
												<% $contact_id == $existing ? 'selected="selected"' : "" %>
											><% $contacts{$contact_id}{"email"} %></option>

%										}
									</select>

								</span>
							</div>
%						}

					</td>

					<td class="centeralign padless">
						<a
							class = "bluetext buttonwhite fa fa-arrow-right hover"
							title = "Enter Tournament as Admin"
							href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn_id %>"
						></a>
					</td>

				</tr>

%			}

			</tbody>

		</table>

	</div>

	<div class="screens survey">

		<span class="half">
			<h5>Survey Responses</h5>
		</span>

		<span
			class = "half rightalign"
			id    = "survey_table_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas",
			table => "survey_table"
		&>

		<table id="survey_table">

				<thead>

				<tr class="yellowrow smallish padtop padbottom">

					<th>
						District
					</th>

					<th>
						FEIN
					</th>

					<th class="smaller">
						501c3
					</th>

					<th class="smaller" title="Online or In Person">
						Wh?
					</th>

					<th class="smaller" title="IE online format">
						IEF
					</th>

					<th class="smaller" title="Congress pilot times">
						CT
					</th>

					<th>
						Base
					</th>

					<th>
						IE
					</th>

					<th class="borderright">
						Hire
					</th>

					<th>
						DB
					</th>

					<th class="borderright">
						Hire
					</th>

					<th>
						CN
					</th>

					<th class="borderright">
						Hire
					</th>

%					foreach my $event (@{$keys}) {
						<th>
							<% $event %>
						</th>
%					}

					<th>
						Notes
					</th>

				</tr>

				</thead>

				<tbody>

%				foreach my $tourn_id (keys %tourns) {

					<tr class="smaller">

						<td>
							<% $tourns{$tourn_id}{"district_name"} %>
						</td>

						<td class='centeralign nowrap smaller'>
<%perl>
							if ($tourn_settings{$tourn_id}{"nsda_irs_fein"}) {
								$m->print($tourn_settings{$tourn_id}{"nsda_irs_fein"});
							} elsif ($tourn_settings{$tourn_id}{"nsda_irs"} eq "irs_id") {
								$m->print("Has FEIN");
							} elsif ($tourn_settings{$tourn_id}{"nsda_irs"} eq "irs_apply") {
								$m->print("Applying");
							} elsif ($tourn_settings{$tourn_id}{"nsda_irs"} eq "irs_none") {
								$m->print("No");
							}
</%perl>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nonprofit"} eq "nonprofit_501c3" ? "Has" : "" %>
							<% $tourn_settings{$tourn_id}{"nonprofit"} eq "nonprofit_intend" ? "Intend" : "" %>
							<% $tourn_settings{$tourn_id}{"nonprofit"} eq "nonprofit_dont_intend" ? "No" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_online_tournament"} eq "online" ? "OL" : "IP" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_speech_online"} %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_congress_timelimits"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn_id}{"survey_school_fee"}) %>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn_id}{"survey_obligation_ie"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"survey_no_hire_ie"}
								? "N"
								: $tourn_settings{$tourn_id}{"survey_hire_ie"}
							%>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn_id}{"survey_obligation_debate"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"survey_no_hire_debate"}
								? "N"
								: $tourn_settings{$tourn_id}{"survey_hire_debate"}
							%>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn_id}{"survey_obligation_con"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"survey_no_hire_con"}
								? "N"
								: $tourn_settings{$tourn_id}{"survey_hire_con"}
							%>
						</td>

%						foreach my $abbr (@{$keys}) {
%							my $event_id = $tourns{$tourn_id}{"eventabbr"}{$abbr};
							<td class="centeralign">
								<% nearest(1, $tourns{$tourn_id}{'events'}{$event_id}{"fees"}) %>
							</td>
%						}

<%perl>
						my $message = $m->comp(
			                "/funclib/save_editor.mas",
							text        => $tourn_settings{$tourn_id}{"survey_explanation"},
							restrictive => 1
						);

</%perl>

						<td class="smallish">
							<% $message %>
						</td>

					</tr>

%				}

				</tbody>

			</table>
	</div>

	<div class="screens not_started">

<%perl>

	$sth = $dbh->prepare("
		select district.id, district.name, district.location,
			chair.first first, chair.last last, chair.email email, chair.phone
		from district

		left join permission on district.id = permission.district and permission.tag = 'chair'
		left join person chair on chair.id = permission.person

		where district.id > 0
		and district.realm = 'NSDA'
		and not exists (
			select tourn.id
			from tourn, tourn_setting
			where tourn_setting.value = district.id
			and tourn_setting.tag = 'nsda_district'
			and tourn_setting.tourn = tourn.id
			and tourn.start > ?
		)
		order by district.name
	");

	my %districts;
	$sth->execute(DateTime::Format::MySQL->format_datetime($after));

	while (
		my ($district_id, $district_name, $district_location,
			$chair_first, $chair_last, $chair_email, $chair_phone,
		) = $sth->fetchrow_array()
	) {

		next if $districts{$district_id};

		$districts{$district_id}{"name"} = $district_name;
		$districts{$district_id}{"location"} = $district_location;
		$districts{$district_id}{"chair_name"} = $chair_first." ".$chair_last;
		$districts{$district_id}{"chair_email"} = $chair_email;
		$chair_phone =~ s/[\D_]//g;
		$districts{$district_id}{"chair_phone"} = $chair_phone;
	}


</%perl>

	<& "/funclib/tablesorter.mas",
		table     => "notstarted",
		invisible => 'yah'
	&>

		<span class="threequarters">
			<h5><% scalar (keys %districts) %> Districts without tournaments</h5>
		</span>

		<span
			class = "quarter rightalign"
			id    = "notstarted_buttonarea"
		>
		</span>

		<table id="notstarted">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						District
					</th>

					<th>
						State
					</th>
					<th>
						Chair
					</th>

					<th>
						Email
					</th>

					<th>
						Phone
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $district_id (keys %districts) {

					<tr>

						<td>
							<% $districts{$district_id}{"name"} %>
						</td>

						<td>
							<% $districts{$district_id}{"location"} %>
						</td>

						<td class="smallish">
							<a
								class = "plain padmore full hover"
								title = "mailto:<%  $districts{$district_id}{"chair_email"} %>"
								href  = "mailto:<%  $districts{$district_id}{"chair_email"} %>">
								<% $districts{$district_id}{"chair_name"} %>
							</a>
						</td>

						<td class="smallish">
							<a
								class = "plain padmore full hover"
								title = "mailto:<%  $districts{$district_id}{"chair_email"} %>"
								href  = "mailto:<%  $districts{$district_id}{"chair_email"} %>">
								<%  $districts{$district_id}{"chair_email"} %>
							</a>
						</td>

						<td>
							<% Tab::phoneme($districts{$district_id}{"chair_phone"}) %>
						</td>

					</tr>
%				}

			</tbody>

		</table>

	</div>

<%perl>

	my $change_sth = $dbh->prepare("
		select
			change_log.id,
				CONVERT_TZ(change_log.created_at, '+00:00', tourn.tz),
			change_log.description, change_log.deleted,
			tourn.name,
			person.first,
			person.last,
			person.email
		from (tourn, change_log)
			left join person on person.id = change_log.person
		where change_log.created_at > ?
			and change_log.tourn = tourn.id
			and change_log.tag  = 'districts'
		order by change_log.created_at DESC
	");

</%perl>

	<div class="screens change_log">

		<& "/funclib/tablesorter.mas",
			table     => "changelog",
			invisible => "yah"
		&>

		<script>

			function toggleDeleted() {
				$(".hidebutton").toggleClass("hidden");
				$(".showbutton").toggleClass("hidden");
				$(".deleted").toggleClass("hidden");
				zebraRows();
			}

		</script>

		<span class="threequarters">
			<h5>Change log</h5>
		</span>

		<span
			class = "quarter rightalign"
		>
			<a
				onClick = "toggleDeleted();"
				class="buttonwhite smallish padless redtext hidebutton hidden"
			>Hide Deleted</a>

			<a
				onClick = "toggleDeleted();"
				class="buttonwhite smallish padless bluetext showbutton"
			>Show Deleted</a>
		</span>

		<span
			class = "quarter rightalign"
			id    = "changelog_buttonarea"
		>
		</span>

		<table id="changelog">

			<thead>

				<tr class="yellowrow">

					<th>

					</th>

					<th>
						Tournament
					</th>

					<th>
						Date
					</th>

					<th>
						Change by
					</th>

					<th>
						Log
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

			$change_sth->execute($after);

			while (
				my (
					$id, $created_at, $description, $deleted,
					$tourn_name,
					$person_first, $person_last, $person_email
				) = $change_sth->fetchrow_array()
			) {

				$tourn_name =~ s/District Tournament//g;
</%perl>

					<tr id="<% $id %>" class="smallish <% $deleted ? "deleted hidden" : "" %>">

						<td class="centeralign">
%							if ($deleted) {
								<a
									id         = "<% $id %>"
									target_id  = "<% $id %>"
									onClick    = "postSwitch(this, 'delete_change.mhtml');"
									class      = "buttonwhite fa-sm fa fa-eye greentext hover"
									title      = "Show this change"
								></a>
%							} else {
								<a
									id         = "<% $id %>"
									target_id  = "<% $id %>"
									on_success = "hide"
									onClick    = "postSwitch(this, 'delete_change.mhtml');"
									class      = "buttonwhite fa-sm fa fa-eye-slash redtext hover"
									title      = "Hide this change"
								></a>
%							}
						</td>

						<td class="nowrap">
							<% $tourn_name %>
						</td>

						<td>
							<span class="hidden"><% $created_at %></span>
							<& "/funclib/showdate.mas", string => $created_at &>
						</td>

						<td class="nowrap">
							<a
								href  = "mailto:<% $person_email %>"
								title = "mailto:<% $person_email %>"
								class = "full hover plain"
							>
								<% $person_first." ".$person_last %>
							</a>
						</td>

						<td>
							<% $description %>
						</td>
					</tr>
%				}

			</tbody>

		</table>

	</div>

</div>
<script>

	function c(){
		return $('#hoverlay').fadeOut('fast',function(){
			$('#nsda_notes').remove();
			$('#hoverlay').remove();
		});
	}

	function notePost(dest,vals) {

		$.post(dest,vals).done(function(res,r){
			if(!res.error){
				c();
				alertify.notify(res.message, "custom");
				$("."+vals.tourn_id+"_notes").text(vals.notes);
			} else{
				c();
				alertify.error(res.message);
			}
		});
	};

	function gen(e,r,i = "") {

		return `
			<div id="hoverlay"
				style="position:fixed;background-color:#000;top:0;right:0;bottom:0;left:0;overflow:hidden;opacity:.9;z-index:899"
			></div>

			<div
				id		= "nsda_notes"
				class	= "full nospace martop"
				style	= "position:absolute; top:${e};left:30%;z-index:900;opacity:1; width: 40%;">

				<h4 class="whitetext">
					District Tournament Notes (admin only)
				</h4>

					<input
						type  = "hidden"
						id    = "district_notes_id"
						name  = "tourn_id"
						value = "${r}"
					/>
					<textarea
						id		= "district_notes_textarea"
						class 	= "full martop padmore"
						style	= "width:100%;min-height:180px;max-height:480px;"
						name	= "notes"
					>${i}</textarea>

					<div class="full rightalign">
						<input
							type	= "submit"
							id		= "notes_submit"
							value	= "Save"
							class 	= "thin notfirst"
							onClick	= "notePost('district_notes_save.mhtml',{
										tourn_id: $('#district_notes_id').val(),
										notes  	: $('#district_notes_textarea').val()
										});" />
						<input
							type	= "button"
							value	= "Close"
							class 	= "thin notfirst"
							onClick	= "c();" /
						>
					</div>
			</div>`
	};

	$('.formbutton').click(function(e){

		var $x = window.scrollY + 80 + "px";
		var id = $(this).attr("id");

		$.get(
			'district_notes_save.mhtml',
			{'tourn_id':id},
			function(data){
				$('#overlay').after(gen($x,id,data.notes));
			}
		);
	});

</script>
