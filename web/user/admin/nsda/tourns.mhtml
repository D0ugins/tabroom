<%args>
	$person
	$person_settings
	$future  => undef
	$default => 'tournaments'
	$tourn   => undef
</%args>
<%init>

	my $after = &Tab::school_year();

	$after = DateTime->now() if $future;

	use Tab::NSDA::Person;
	use Tab::NSDA::PersonSchool;
	use Tab::NSDA::MemberSchool;

	Tab::Tourn->columns(TEMP => "district");
	Tab::Tourn->columns(TEMP => "chairid");

	if ($tourn) { 
		$tourn->district($tourn->setting("nsda_district"));

		my $chair = Tab::Permission->search(
			tag      => "chair",
			district => $tourn->district
		)->first;

		$tourn->chairid($chair->person->ualt_id) if $chair;
	}

	Tab::Tourn->set_sql( districts => "
		select distinct tourn.*, 
			tourn_setting.value as district, 
			chair.ualt_id as chairid

		from (tourn, tourn_setting)
		left join permission chairperm 
			on chairperm.district = tourn_setting.value
			and chairperm.tag = 'chair'
		left join person chair on chairperm.person = chair.id

		where tourn.id = tourn_setting.tourn
		and tourn_setting.tag = 'nsda_district'
		and tourn_setting.value > 0
		and tourn.start > ?
		group by tourn.id
		order by tourn.start, tourn_setting.value
	");

	my @tourns = Tab::Tourn->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

	my @nsda_contacts = $m->comp("/funclib/nsda_admins.mas");

	my @tabs = (	
		"tournaments",
		"orders",
		"survey",
		"settings",
		"not_started",
		"change_log"
	);

	my $contact_target = "tourn_contacts.mhtml";

	my %tourn_settings;

	my ($keys, $event_ref) = $m->comp("/funclib/nsda_events.mas");

	my %chairs = ();
	my %chair_school = ();

</%init>

	<script>

        function postResult(url, target, value, message) { 

			$.post(
				url, 

				{ target_id : target, value: value },

				function(reply) { 

					$("#"+target).val(reply);

					if (message) { 
						alertify.notify(message, "custom");
					}
				}
			);

        };  

	</script>

	<& 
		"../menu.mas",
		whoami          => "district_tourns",
		person          => $person,
		person_settings => $person_settings,
		district_menu   => "tourns"
	&>

<div class="main">

	<h2>District Tournament Checklist</h2>

	<& "/funclib/tablesorter.mas",
		table     => "tourns",
		invisible => "yah"
	&>

	<& "/funclib/tabs.mas", 
		tabs    => \@tabs,
		default => $default
	&>

	<div class="tournaments screens">

		<span class="threequarters nospace">
			<h4><% $after->year %> - <% $after->year + 1 %> Districts</h4>
		</span>

		<span 
			id    = "tourns_buttonarea"
			class = "quarter rightalign"
		>
		</span>

		<table id="tourns">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						District
					</th>
					<th>
						St
					</th>

					<th>
						Name
					</th>

					<th>
						Start
					</th>

					<th>
						End
					</th>

					<th>
						Reg Start
					</th>

					<th>
						Reg End
					</th>

					<th>
						Points
					</th>

					<th>
						Results
					</th>

					<th>
						Method
					</th>

					<th>
						IE Rules
					</th>

					<th>
						Events
					</th>

					<th class="nosort">
						Admin
					</th>

					<th class="hiddencsv">
						Site
					</th>

					<th class="hiddencsv">
						City
					</th>

					<th class="hiddencsv">
						State
					</th>

					<th class="hiddencsv">
						Chair
					</th>

					<th class="hiddencsv">
						Email
					</th>

%					foreach my $event (@{$keys}) { 
						<th class="hiddencsv">
							<% $event %>
						</th>
%					}

					<th class="hiddencsv">
						Notes
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

			my %tourn_weekends = ();
			my %tourn_events   = ();
			my %event_settings = ();
			my %tourn_district = ();

			foreach my $tourn (@tourns) { 

				my $tourn_id = $tourn->id;

				%{$tourn_weekends{$tourn_id}} = 
					map {$_->id => $_} 
					$tourn->weekends();

				$tourn_district{$tourn_id} = Tab::District->retrieve($tourn->district);

				%{$tourn_settings{$tourn_id}} = $tourn->all_settings();

				my $chair_id = $tourn->chairid;
				my $chair = $chairs{$chair_id};
				my $school = $chair_school{$chair_id};

				if ($chair_id && (not defined $chair)) { 
					$chair = Tab::NSDA::Person->search(ualt_id => $chair_id)->first;
					$chairs{$chair_id} = $chair;

					my $nuts = Tab::NSDA::PersonSchool->search(
						ualt_id => $chair_id,
						enddate => "0000-00-00 00:00:00"
					)->first;

					$school = $nuts->school_id if $nuts;
					$chair_school{$chair_id} = $school;
				}
   				
				my $tabbing = $tourn_settings{$tourn_id}{"nsda_tabbing_software"};
				$tabbing = "TR" if $tabbing eq "tabroom";
				$tabbing = "JOT" if $tabbing eq "jot";

				my $rules = $tourn_settings{$tourn_id}{"nsda_speech_method"};

				$rules = "DD" if $rules eq "doubledown";
				$rules = "C3" if $rules eq "california_3";
				$rules = "C2" if $rules eq "california_2";

				my %events = ();

				%{$tourn_events{$tourn_id}} = 
					map {$_->id => $_} 
					$tourn->events;

				%{$tourn_events{$tourn_id}{"abbr"}} = 
					map {$_->abbr => $_} 
					$tourn->events;

				%{$event_settings{$tourn_id}} = 
					$m->comp("/funclib/event_settings.mas", 
						tourn => $tourn
					); 

				foreach my $event_id (keys %{$tourn_events{$tourn_id}}) {

					next if $event_id eq "abbr";

					my $event = $tourn_events{$tourn_id}{$event_id};

					my $weekend_id = $event_settings{$tourn_id}{$event_id}{"weekend"};

					$weekend_id = "nope" unless $weekend_id;
					push @{$events{$weekend_id}}, $event;

				}

				foreach my $weekend_id (keys %{$tourn_weekends{$tourn_id}} ) { 

					my $weekend = $tourn_weekends{$tourn_id}{$weekend_id};

</%perl>
					<tr class="smallish">

						<td>
							<% $tourn_district{$tourn_id}->name %>
						</td>

						<td>
							<% $tourn_district{$tourn_id}->location %>
						</td>

						<td>
							<% $weekend->name %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->start->epoch() %></span>
							<% Tab::shortdate($weekend->start) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->end->epoch() %></span>
							<% Tab::shortdate($weekend->end) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->reg_start->epoch() %></span>
							<% Tab::shortdate($weekend->reg_start) %>
						</td>

						<td class="rightalign">
							<span class="hidden"><% $weekend->reg_end->epoch() %></span>
							<% Tab::shortdate($weekend->reg_end) %>
						</td>

						<td class="centeralign">
							<% $weekend->setting("points_posted") ? "Y" : "N" %>
						</td>

						<td class="centeralign">
							<% $tourn_settings{$tourn_id}{"nsda_registered"} ? "Y" : "N"  %>
						</td>

						<td class="centeralign">
							<% $tabbing %>
						</td>

						<td class="centeralign">
							<% $rules %>
						</td>

						<td class="centeralign">
%							my %yup;
%							foreach my $event (@{$events{$weekend->id}}) { 
%								$yup{$event->abbr}++;
								<% $event->abbr %>
%							}
						</td>

						<td class="centeralign padless">
							<a 
								class = "bluetext buttonwhite fa fa-edit hover fa-sm"
								title = "Enter Tournament as Admin"
								href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn_id %>"
							></a>
						</td>

						<td class="hiddencsv">
							<% $weekend->site ? $weekend->site->name : "" %>
						</td>
						<td class="hiddencsv">
							<% $weekend->city %>
						</td>
						<td class="hiddencsv">
							<% $weekend->state %>
						</td>

						<td class="hiddencsv">
							<% $chair ? $chair->ufname." ".$chair->ulname : ""%>
						</td>

						<td class="hiddencsv">
%							if ($chair) { 
								<a href="mailto:<% $chair->uemail %>">
									<% $chair->uemail %>
								</a>
%							}
						</td>

%						foreach my $event (@{$keys}) { 
							<th class="hiddencsv">
								<% $yup{$event} ? "Y" : "" %>
							</th>
%						}

						<td 
							class="hiddencsv <% $tourn_id %>_notes"
						>
							<% $tourn_settings{$tourn_id}{"nsda_notes"} %>
						</td>

					</tr>
%				}

%				if ($events{"nope"}) { 

					<tr class="smallish">

						<td>
							<% $tourn_district{$tourn_id}->name %>
						</td>
						<td>
							<% $tourn_district{$tourn_id}->location %>
						</td>

						<td>
							Not Held
						</td>

						<td colspan="8">
						</td>

						<td class="centeralign">
%							foreach my $event (@{$events{"nope"}}) { 
								<% $event->abbr %>
%							}
						</td>

						<td>
						</td>


					</tr>
%				}

%			}

			</tbody>

		</table>

	</div>

	<div class="screens orders">

		<span class="half">
			<h5>District orders</h5>
		</span>

		<span 
			class = "half rightalign"
			id    = "order_table_buttonarea"
		>
		</span>

		<& "/funclib/tablesorter.mas",
			table     => "order_table",
			invisible => "yah"
		&>

			<table id="order_table">

				<thead>

				<tr class="yellowrow smallish padtop padbottom">
					
					<th>
						District
					</th>

					<th>
						Level
					</th>

					<th>
						Coach
					</th>

					<th>
						Principal
					</th>

					<th>
						SOY
					</th>

					<th>
						Alum
					</th>

					<th>
						Comm
					</th>

					<th class="borderright">
						Vol
					</th>

					<th>
						EXT
					</th>

					<th class="borderright">
						Date
					</th>

					<th>
						CX
					</th>

					<th class="borderright">
						Date
					</th>

					<th>
						LD
					</th>

					<th class="borderright">
						Date
					</th>

					<th>
						PF
					</th>

					<th>
						Date
					</th>

					<th class="hiddencsv">
						Chair
					</th>

					<th class="hiddencsv">
						Email
					</th>

					<th class="hiddencsv">
						School
					</th>
					<th class="hiddencsv">
						Address
					</th>

					<th class="hiddencsv">
						Address2
					</th>

					<th class="hiddencsv">	
						City
					</th>

					<th class="hiddencsv">
						ST
					</th>

					<th class="hiddencsv">
						ZIP
					</th>

					<th class="hiddencsv">
						Personal Phone
					</th>

					<th class="hiddencsv">
						School Phone
					</th>

				</tr>

				</thead>

				<tbody>

<%perl>
				foreach my $tourn (@tourns) {

					my $tourn_id = $tourn->id;

					my $policy = $tourn_events{$tourn_id}{"abbr"}{"CX"};
					my $ld = $tourn_events{$tourn_id}{"abbr"}{"LD"};
					my $pf = $tourn_events{$tourn_id}{"abbr"}{"PF"};
					my $int_extemp = $tourn_events{$tourn_id}{"abbr"}{"IX"};
					my $us_extemp = $tourn_events{$tourn_id}{"abbr"}{"USX"};

					my $chair_id = $tourn->chairid;
					my $chair = $chairs{$chair_id};
					my $school = $chair_school{$chair_id};

					if ($chair_id && (not defined $chair)) { 

						$chair = Tab::NSDA::Person->search(
							ualt_id => $chair_id
						)->first;

						$chairs{$chair_id} = $chair;

						my $nuts = Tab::NSDA::PersonSchool->search(
							ualt_id => $chair_id,
							enddate => "0000-00-00 00:00:00"
						)->first;

						$school = $nuts->school_id if $nuts;
						$chair_school{$chair_id} = $school;
					}

</%perl>

					<tr>
						
						<td>
							<% $tourn_district{$tourn_id}->name %>
						</td>

						<td>
							<% $tourn_district{$tourn_id}->level %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_coach_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_principal_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_student_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_alum_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_communicator_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign borderright'>
							<% $tourn_settings{$tourn_id}{"nsda_volunteer_trophy"} ? "Y" : "" %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"nsda_extemp_topics"} ? "Y" : "" %>
						</td>

						<td class="borderright">
<%perl>

							my $int_weekend = 
								$tourn_weekends{$tourn_id}{
									$event_settings{$tourn_id}{$int_extemp->id}{"weekend"}
								}
								if $int_extemp;

							my $us_weekend = 
								$tourn_weekends{$tourn_id}{
									$event_settings{$tourn_id}{$us_extemp->id}{"weekend"}
								}
								if $us_extemp;

</%perl>
%							if ($int_weekend && $int_weekend == $us_weekend) { 
								<% Tab::shortdate($int_weekend->start) %>
%							} elsif ($int_weekend || $us_weekend)  { 

								<div class="full marless">
									<% $int_weekend 
										? "IX: ".Tab::shortdate($int_weekend->start) 
										: ""
									%>
								</div>

								<div class="full marless">
									<% $us_weekend 
										? "USX: ".Tab::shortdate($us_weekend->start) 
										: ""
									%>
								</div>
%							}

						</td>

						<td>
							<% $policy 
								?  $event_settings{$tourn_id}{$policy->id}{"nsda_ballot_order"}
								: "" 
							%>
						</td>

						<td class="borderright">
<%perl>
							if ($policy 
								&& $event_settings{$tourn_id}{$policy->id}{"nsda_ballot_order"}
							) { 

								my $cx_weekend = $tourn_weekends{$tourn_id}{
									$event_settings{$tourn_id}{$policy->id}{"weekend"}
								};

</%perl>
	   							<% $cx_weekend 
									? Tab::shortdate($cx_weekend->start)
									: ""
								%>
%							}
						</td>

						<td>
							<% $ld 
								? $event_settings{$tourn_id}{$ld->id}{"nsda_ballot_order"}
								: ""
							%>
						</td>

						<td class="borderright">
<%perl>
							if ($ld 
								&& $event_settings{$tourn_id}{$ld->id}{"nsda_ballot_order"}
							) { 

								my $ld_weekend = $tourn_weekends{$tourn_id}{
									$event_settings{$tourn_id}{$ld->id}{"weekend"}
								};
</%perl>
								<% $ld_weekend ? Tab::shortdate($ld_weekend->start) : "" %>
%							}
						</td>

						<td>
							<% $pf ?  $event_settings{$tourn_id}{$pf->id}{"nsda_ballot_order"} : "" %>
						</td>

						<td>
<%perl>
							if ($pf 
								&& $event_settings{$tourn_id}{$pf->id}{"nsda_ballot_order"}
							) { 

								my $pf_weekend = $tourn_weekends{$tourn_id}{
									$event_settings{$tourn_id}{$pf->id}{"weekend"}
								};
</%perl>
								<% $pf_weekend ? Tab::shortdate($pf_weekend->start) : "" %>
%							}
						</td>

						<td class="hiddencsv">
							<% $chair ? $chair->ufname." ".$chair->ulname : "" %>
						</td>

						<td class="hiddencsv">
							<% $chair ? $chair->uemail : ""%>
						</td>

						<td class="hiddencsv">
							<% $school ?  $school->school_name : "" %>
						</td>

						<td class="hiddencsv">
							<% $school ?  $school->school_addr : "" %>
						</td>

						<td class="hiddencsv">
							<% $school ?  $school->school_addr2 : "" %>
						</td>

						<td class="hiddencsv">
							<% $school ?  $school->school_city : "" %>
						</td>

						<td class="hiddencsv">
							<% $school ?  $school->school_state : "" %>
						</td>

						<td class="hiddencsv">
							<% $school ?  $school->school_zip : "" %>
						</td>

						<td class="hiddencsv">
							<% $chair ? $chair->cell : ""%>
						</td>

						<td class="hiddencsv">
							<% $school ? $school->school_phone : ""%>
						</td>

					</tr>

%				}

				</tbody>

			</table>
	</div>

	<div class="screens settings">

		<table id="contacts">

			<thead>

				<tr class="yellowrow smallish">

					<th>
						Name 
					</th>

					<th>
						Strikes
					</th>

					<th>
						Ratings
					</th>

					<th>
						JOT Approved
					</th>

					<th>
						Office Contact Rotation
					</th>

					<th class="nosort">
					</th>

				</tr>

			</thead>

			<tbody>

%			foreach my $tourn (@tourns) { 

%				my $tourn_id = $tourn->id;

				<tr class="smallish row">

					<td class="nospace padleft">

						<div class="full padless semibold bluetext">
							<% $tourn_district{$tourn_id}->name %>
						</div>

%						foreach my $weekend_id (keys %{$tourn_weekends{$tourn_id}} ) { 

%							my $weekend = $tourn_weekends{$tourn_id}{$weekend_id};

							<div class="full padless marno smallish">

								<span class="threefifths nospace">
									<% $weekend->name %>
								</span>

								<span class="fifth nospace">
									<% Tab::shortdate($weekend->start) %>
								</span>

								<span class="fifth nospace">
									<% Tab::shortdate($weekend->end) %>
								</span>

							</div>
%						}


						<div class="full bordertop martop marno padno">
						
							<span class="fourfifths <% $tourn %>_notes">
								<% $tourn_settings{$tourn_id}{"nsda_notes"} %>
							</span>

							<span class="fifth">
								<a 
									id		= "<% $tourn_id %>" 
									title	= "Enter Tournament Notes" 
									class	= "buttonwhite greentext fa-xs fa fa-edit formbutton hover" 
									href	= "#"
								></a>
							</span>

						</div>

					</td>


					</td>

					<td class="centeralign">

%						my $current = $tourn_settings{$tourn_id}{"nsda_strikes"};

						<span class="hidden"> <% $current %> </span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $tourn_id %>_strikes"
								setting_name = "nsda_strikes"
								target_type  = "tourn"
								target_id    = "<% $tourn_id %>"
								onChange     = "postSwitch( this, 'districts_switch.mhtml');"

								<% $current ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</td>	

					<td class="centeralign">

%						$current = $tourn_settings{$tourn_id}{"nsda_ratings"};

						<span class="hidden"> <% $current %> </span>

						<label class="switch">
							<input 
								type         = "checkbox"
								value        = "1"
								id           = "<% $tourn_id %>_ratings"
								setting_name = "nsda_ratings"
								target_type  = "tourn"
								target_id    = "<% $tourn_id %>"
								onChange     = "postSwitch( this, 'districts_switch.mhtml');"

								<% $current ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>

					</td>

					<td class="centeralign">

%						unless ($tourn_events{$tourn_id}) {
							<div class="semibold redtext full marno">
								Setup not done
							</div>
%						}

%						if ($tourn_settings{$tourn_id}{"nsda_tabbing_software"} eq "jot") { 

%							$current = $tourn_settings{$tourn_id}{"nsda_jot_tabbed"};

							<span class="hidden"> <% $current %> </span>

							<label class="switch">
								<input 
									type         = "checkbox"
									value        = "1"
									id           = "<% $tourn_id %>_jot_tabbed"
									setting_name = "nsda_jot_tabbed"
									target_type  = "tourn"
									target_id    = "<% $tourn_id %>"
									onChange     = "postSwitch( this, 'districts_switch.mhtml');"

									<% $current ? 'checked="checked"' : "" %>
								>
								<div class="slider"></div>
							</label>

%						} else { 
							<div class="full marno semibold">
								Tabroom
							</div>
%						}

					</td>	


					<td class="centeralign">

%						foreach my $tag (1 .. 3) { 

%							my $existing = $tourn_settings{$tourn_id}{"nsda_contact_".$tag};

							<div class="padless padright marno full nowrap">

								<span class="tenth marno padless">
									<% $tag %>.
								</span>

								<span class="ninetenths marno padless">

									<select 
										name     = "nsda_contact_<% $tag %>"
										class    = "fixedsmall thin plain"
										id       = "<% $tourn_id."-".$tag %>"
										onChange = "postResult( 
														'<% $contact_target %>',
														'<% $tourn_id %>-<% $tag %>',
														this.value,
														'Contact saved for <% $tourn->name %>'
													);"
									>

										<option value=""></option>

%										foreach my $contact (@nsda_contacts) { 

											<option 
												value="<% $contact->id %>"
												<% $contact->id == $existing ? 'selected="selected"' : "" %>
											><% $contact->email %></option>

%										}
									</select>

								</span>
							</div>
%						}

					</td>

					<td class="centeralign padless">
						<a 
							class = "bluetext buttonwhite fa fa-arrow-right hover"
							title = "Enter Tournament as Admin"
							href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn_id %>"
						></a>
					</td>

				</tr>


%			}

			</tbody>

		</table>

	</div>

	<div class="screens survey">

		<span class="half">
			<h5>Survey Responses</h5>
		</span>

		<span 
			class = "half rightalign"
			id    = "survey_table_buttonarea"
		>
		</span>

			<& "/funclib/tablesorter.mas", 
				table => "survey_table"
			&>

			<table id="survey_table">

				<thead>

				<tr class="yellowrow smallish padtop padbottom">
					
					<th>
						District
					</th>

					<th>
						Base
					</th>

					<th>
						IE
					</th>

					<th class="borderright">
						Hire
					</th>

					<th>
						DB
					</th>

					<th class="borderright">
						Hire
					</th>

					<th>
						CN
					</th>

					<th class="borderright">
						Hire
					</th>

%					foreach my $event (@{$keys}) { 
						<th>
							<% $event %>
						</th>
%					}

					<th>
						Notes
					</th>

				</tr>

				</thead>

				<tbody>

<%perl>

				foreach my $tourn (@tourns) {

					next unless $tourn;

					my $tourn_id = $tourn->id;


</%perl>

					<tr>
						
						<td>
							<% $tourn_district{$tourn_id}->name %>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn_id}{"survey_school_fee"}) %>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn_id}{"survey_obligation_ie"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"survey_no_hire_ie"} 
								? "N" 
								: $tourn_settings{$tourn_id}{"survey_hire_ie"} 
							%>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn_id}{"survey_obligation_debate"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"survey_no_hire_debate"} 
								? "N" 
								: $tourn_settings{$tourn_id}{"survey_hire_debate"} 
							%>
						</td>

						<td class='centeralign'>
							<% int($tourn_settings{$tourn_id}{"survey_obligation_con"}) %>
						</td>

						<td class='centeralign'>
							<% $tourn_settings{$tourn_id}{"survey_no_hire_con"} 
								? "N" 
								: $tourn_settings{$tourn_id}{"survey_hire_con"} 
							%>
						</td>

%						foreach my $abbr (@{$keys}) { 

%							my $event = $tourn_events{$tourn_id}{"abbr"}{$abbr};

							<td class="rightalign">
								<% $event ? int($event_settings{$tourn_id}{$event->id}{"survey_fees"}) : "" %>
							</td>
%						}

%						my $strip = HTML::Strip->new();
%						my $message = $strip->parse( $tourn_settings{$tourn_id}{"survey_explanation"} );

						<td class="smallish">
							<% $message %>
						</td>

					</tr>

%				}

				</tbody>

			</table>
	</div>

	<div class="screens not_started">

<%perl>

	Tab::District->columns(TEMP => qw/first last email chairid/);

	Tab::District->set_sql( districts => "
		select distinct district.*, 
			chair.first first, chair.last last, chair.email email, chair.ualt_id as chairid
		from district

		left join permission on district.id = permission.district and permission.tag = 'chair'
		left join person chair on chair.id = permission.person

		where district.id > 0
		and district.realm = 'NFL'
		and not exists ( 
			select tourn.id 
			from tourn, tourn_setting 
			where tourn.id = tourn_setting.tourn
			and tourn_setting.tag = 'nsda_district'
			and tourn_setting.value = district.id
			and tourn.start > ?
		)
		order by district.name
	");

	my @districts = Tab::District->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

</%perl>

	<& "/funclib/tablesorter.mas", 
		table     => "notstarted",
		invisible => 'yah'
	&>

		<span class="threequarters">
			<h5><% scalar @districts %> Districts without tournaments</h5>
		</span>

		<span 
			class = "quarter rightalign"
			id    = "notstarted_buttonarea"
		>
		</span>

		<table id="notstarted">

			<thead>

				<tr class="yellowrow smallish">
					<th>
						District
					</th>
					<th>	
						State
					</th>
					<th>
						Chair
					</th>

					<th>
						Email
					</th>

					<th>
						Phone
					</th>

					<th>
						School Phone
					</th>
				</tr>

			</thead>

			<tbody>

<%perl>
				foreach my $district (@districts) { 

					my $chair_id = $district->chairid;
					my $chair = $chairs{$chair_id};
					my $school = $chair_school{$chair_id};

					if ($chair_id && (not defined $chair)) { 

						$chair = Tab::NSDA::Person->search(
							ualt_id => $chair_id
						)->first;

						$chairs{$chair_id} = $chair;

						my $nuts = Tab::NSDA::PersonSchool->search(
							ualt_id => $chair_id,
							enddate => "0000-00-00 00:00:00"
						)->first;

						$school = $nuts->school_id if $nuts;
						$chair_school{$chair_id} = $school;

					}
   				
</%perl>

					<tr>

						<td>
							<% $district->name %>
						</td>

						<td>
							<% $district->location %>
						</td>

						<td class="smallish">
							<a
								class = "plain padmore full hover"
								title = "mailto:<% $district->email %>"
								href  = "mailto:<% $district->email %>">
								<% $district->first %> <% $district->last %>
							</a>
						</td>

						<td class="smallish">
							<a
								class = "plain padmore full hover"
								title = "mailto:<% $district->email %>"
								href  = "mailto:<% $district->email %>">
								<% $district->email %>
							</a>
						</td>

						<td>
							<% $chair ? $chair->cell : ""%>
						</td>

						<td>
							<% $school ? $school->school_phone : ""%>
						</td>

					</tr>
%				}

			</tbody>

		</table>

	</div>

<%perl>

	Tab::ChangeLog->columns(TEMP => "tournname");

	Tab::ChangeLog->set_sql( districts => "

		select distinct change_log.*, tourn.name as tournname
		from change_log, tourn
		where change_log.timestamp > ? 
		and change_log.tourn = tourn.id
		and change_log.type  = 'districts'
		order by change_log.timestamp DESC
	");

	my @changes = Tab::ChangeLog->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

</%perl>

	<div class="screens change_log">

		<& "/funclib/tablesorter.mas", 
			table     => "changelog",
			invisible => "yah"
		&>

		<span class="threequarters">
			<h5>Change log</h5>
		</span>

		<span 
			class = "quarter rightalign"
			id    = "changelog_buttonarea"
		>
		</span>

		<table id="changelog">

			<thead>

				<tr class="yellowrow">

					<th>
						Tournament
					</th>

					<th>	
						Date
					</th>

					<th>
						Change by
					</th>

					<th>
						Log
					</th>

				</tr>

			</thead>

			<tbody>

%				foreach my $change (@changes) { 

					<tr>

						<td>
							<% $change->tournname %>
						</td>

						<td>
							<span class="hidden"><% $change->timestamp->epoch() %></span>
							<% Tab::shortdate($change->timestamp) %>
						</td>

						<td>
							<a 
								href  = "mailto:<% $change->person->email %>"
								title = "mailto:<% $change->person->email %>"
								class = "full hover plain"
							>
								<% $change->person->first." ".$change->person->last %>
							</a>
						</td>

						<td>
							<% $change->description %>
						</td>

					</tr>

%				}

			</tbody>

		</table>

	</div>

</div>
<script>

	function c(){
		return $('#hoverlay').fadeOut('fast',function(){
			$('#nsda_notes').remove();
			$('#hoverlay').remove();
		});
	}

	function notePost(dest,vals) {

		$.post(dest,vals).done(function(res,r){
			if(!res.error){
				c();
				alertify.notify(res.message, "custom");
				$("."+vals.tourn_id+"_notes").text(vals.notes);
			} else{
				c();
				alertify.error(res.message);
			}
		});
	};

	function gen(e,r,i = "") {

		return `
			<div id="hoverlay" 
				style="position:fixed;background-color:#000;top:0;right:0;bottom:0;left:0;overflow:hidden;opacity:.9;z-index:899"
			></div>

			<div 
				id		= "nsda_notes"
				class	= "full nospace martop"
				style	= "position:absolute; top:${e};left:30%;z-index:900;opacity:1; width: 40%;">

				<h4 class="whitetext">
					District Tournament Notes (admin only)
				</h4>

					<input 
						type  = "hidden"
						id    = "district_notes_id"
						name  = "tourn_id"
						value = "${r}"
					/>
					<textarea 
						id		= "district_notes_textarea" 
						class 	= "full martop padmore"
						style	= "width:100%;min-height:180px;max-height:480px;"
						name	= "notes"
					>${i}</textarea>

					<div class="full rightalign">
						<input 
							type	= "submit"
							id		= "notes_submit"
							value	= "Save"
							class 	= "thin notfirst"
							onClick	= "notePost('district_notes_save.mhtml',{
										tourn_id: $('#district_notes_id').val(),
										notes  	: $('#district_notes_textarea').val()
										});" />
						<input 
							type	= "button" 
							value	= "Close"
							class 	= "thin notfirst"
							onClick	= "c();" /
						>
					</div>
			</div>`
	};

	$('.formbutton').click(function(e){

		var $x = window.scrollY + 80 + "px";
		var id = $(this).attr("id");

		$.get(
			'district_notes_save.mhtml',
			{'tourn_id':id},
			function(data){
				$('#overlay').after(gen($x,id,data.notes));
			}
		);
	});

</script>
