<%args>
	$person
	$person_settings
	$future => undef
</%args>
<%init>

	my $after = &Tab::school_year();

	$after = DateTime->now() if $future;

	Tab::Tourn->set_sql( districts => "
		select distinct tourn.*
		from tourn, tourn_setting
		where tourn.id = tourn_setting.tourn
		and tourn_setting.tag = 'nsda_district'
		and tourn_setting.value > 0
		and tourn.start > ?
		group by tourn.id
		order by tourn.start, tourn_setting.value
	");

	my @tourns = Tab::Tourn->search_districts( 
		DateTime::Format::MySQL->format_datetime($after)
	);

	my @nsda_contacts = $m->comp("/funclib/nsda_admins.mas");

</%init>

	<& 
		"../menu.mas",
		whoami          => "district_tourns",
		person          => $person,
		person_settings => $person_settings,
		district_menu   => "tourns"
	&>

<div class="main">

	<h2>District Tournaments</h2>

	<& "/funclib/tablesorter.mas", table => "sorttourns" &>

	<table id="sorttourns">

		<thead>

			<tr class="yellowrow smallish">

				<th>
					Name 
				</th>

				<th>
					Dist
				</th>

				<th>
					Start
				</th>

				<th>
					End
				</th>

				<th>
					Special Settings
				</th>

				<th>
					Office Contacts
				</th>

				<th class="nosort">
				</th>

			</tr>

		</thead>

		<tbody>

%		foreach my $tourn (@tourns) { 

%			my $district = Tab::District->retrieve($tourn->setting("nsda_district"));

			<tr class="smallish">

				<td class="nospace">

					<div class="marno padleft">
						<% $tourn->name %>
					</div>

					<div class="marno padless martop">
						<% $tourn->city.", ".$tourn->state %>
					</div>

%					my @events = sort {$a->type cmp $b->type} $tourn->events;

					<div class="marno padless martop">
%						foreach my $event (@events) { 
							<span class="padmore">
								<% $event->abbr %>
							</span>
%						}
					</div>
				</td>

				<td class="centeralign nospace">
					<a 
						class = "plain padmuchmore hover"
						title = "<% $district->name %>"
						href  = "district_edit.mhtml?district_id=<% $district->id %>"
					>
						<% $district->code %>
					</a>
				</td>

				<td class="centeralign">
					<span class="hidden">
						<% $tourn->start->epoch %>
					</span>
					<% Tab::niceshortdate($tourn->start) %>
				</td>

				<td class="rightalign">
					<span class="hidden">
						<% $tourn->end->epoch %>
					</span>
					<% Tab::niceshortdate($tourn->end) %>
				</td>

				<td class="centeralign">

					<span class="full padless marno">

						<span class="twothirds strong">
							Strikes:
						</span>

%						my $current = $tourn->setting("nsda_strikes");

						<span class="third">
							<& "/funclib/phoneswitch.mas", 
								url     => "strike_switch",
								value   => "nsda_strikes",
								target  => $tourn->id,
								current => $current
							&>
						</span>

					</span>

					<span class="full padless marno">

						<span class="twothirds strong">
							Judge ratings:
						</span>

						<span class="third">
						</span>
					</span>
				</td>

				<td class="padno">

					<form 
						action = "tourn_contacts.mhtml"
						method = "post"
					>

					<input 
						type  = "hidden"
						name  = "tourn_id"
						value = "<% $tourn->id %>"
					>

%					foreach my $tag (1 .. 3) { 

%						my $existing = $tourn->setting("nsda_contact_".$tag);

						<div class="padless padright marno full nowrap">

							<span class="tenth marno padless">
								<% $tag %>.
							</span>

							<span class="ninetenths marno padless">

								<select 
									name     = "nsda_contact_<% $tag %>"
									class    = "fixedsmaller thinner plain"
									onChange = "this.form.submit()"
								>

									<option value=""></option>

%									foreach my $contact (@nsda_contacts) { 

										<option 
											value="<% $contact->id %>"
											<% $contact->id == $existing ? 'selected="selected"' : "" %>
										><% $contact->email %></option>

%									}
								</select>

							</span>
						</div>
%					}


					</form>

				</td>

				<td class="centeralign padless">
					<a 
						class = "bluetext buttonwhite fa fa-edit"
						title = "Enter Tournament as Admin"
						href  = "/user/tourn/select.mhtml?tourn_id=<% $tourn->id %>"
					></a>
				</td>

			</tr>


%		}

		</tbody>

	</table>

</div>
