<%args>
	$edit_id
	$first
	$last
	$email
	$middle         => undef
	$phone          => undef
	$provider       => undef
	$street         => undef
	$city           => undef
	$state          => undef
	$country        => undef
	$no_email       => 0
	$zip            => undef
	$site_admin     => undef
	$nsda_admin     => 0
	$naudl_admin    => 0
	$scream_in_pain => 0
	$nsda           => undef
	$person
</%args>
<%init>

	use Email::Valid;

	$phone  =~ s/\D//g;
	$email  =~ s/\s+//g;
	$email = lc($email);

	my $emailok = Email::Valid->address(
		-address => $email,
		-mxcheck => 1
	) ? 'yes' : 'no';

	unless ($emailok eq "yes") {
		my $err = "That email address is not valid.  Please enter a valid address. $emailok";
		$m->redirect("person_edit.mhtml?edit_id=$edit_id&err=$err");
	}

	my $edit = Tab::Person->retrieve($edit_id);

	unless ($email eq lc($edit->email)) {

		my @existing_emails = Tab::Person->search(
			email => $email
		);

		if (@existing_emails) {
			my $err = "Email address $email already has an account: ";
			$err .= $existing_emails[0]->first." ".$existing_emails[0]->last;

			$m->redirect("person_edit.mhtml?edit_id=$edit_id&err=$err");
		}

		my $taken = Tab::Login->search(
			username => $email
		)->first;

		if ($taken && $taken->person->id != $edit->id) {

			my $err = "Email address $email already in use as a login";
			$m->redirect("person_edit.mhtml?edit_id=$edit_id&err=$err");

		} elsif (not defined $taken) {

			my $login = Tab::Login->search(
				person   => $edit->id,
				username => $edit->email
			)->first;

			$login->username($email) if $login;
			$login->update() if $login;
		}
	}

	foreach my $login ($edit->logins) {
		$login->username(lc($ARGS{$login->id."_username"}));
		$login->update();
		$m->comp("/funclib/ldap_person.mas", login => $login);
	}

	$edit->first($first);
	$edit->middle($middle);
	$edit->last($last);
	$edit->street($street);
	$edit->city($city);
	$edit->email($email);
	$edit->state($state);
	$edit->country($country);
	$edit->no_email($no_email);
	$edit->zip($zip);
	$edit->site_admin($site_admin);
	$edit->phone($phone);
	$edit->provider($provider);

	$edit->update();

	$edit->setting("nsda_admin", $nsda_admin);
	$edit->setting("naudl_admin", $naudl_admin);
	$edit->setting("scream_in_pain", $scream_in_pain);

	$nsda =~ s/[\D_]//g;
	undef $nsda if $nsda < 1;

	my $other_user = Tab::Person->search( nsda => $nsda )->first if $nsda;

	# Had a minor bug here with an undeclared array so I fucked with it -- CLP
	if ($other_user && $other_user->id != $edit->id) {
		my $err = "Changes saved, but another account (".$other_user->email.") is already linked to NSDA ID $nsda, so that was skipped";
		$m->redirect("person_edit.mhtml?edit_id=$edit_id&&err=$err");
	}

	my ($person_ref, $flubber) = $m->comp(
		"/funclib/nsda/api_client.mas",
		path => "/members/".$nsda
	) if $nsda;

	if ($nsda
		&& ((not defined $person_ref) || (not defined $person_ref->{person_id}))
	) {
		my $err = "Changes saved, but the NSDA ID $nsda does not match an NSDA record, so no link was made.";
		$m->redirect("person_edit.mhtml?edit_id=$edit_id&&err=$err");
	}

    Tab::log("PROFILE CHANGE: Account ID ".$person->id." changed ($email) from IP address ".$ENV{REMOTE_ADDR}) ;

	$edit->nsda($person_ref->{person_id});
	$edit->update();

	my $msg = "Changes saved";
	$m->redirect("person_edit.mhtml?edit_id=$edit_id&msg=$msg");

</%init>
