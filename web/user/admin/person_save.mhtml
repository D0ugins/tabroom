<%args>
	$edit_id
	$first
	$last
	$email
	$middle         => undef
	$pronoun        => undef
	$phone          => undef
	$provider       => undef
	$street         => undef
	$city           => undef
	$state          => undef
	$country        => undef
	$no_email       => 0
	$zip            => undef
	$site_admin     => undef
	$nsda_admin     => 0
	$naudl_admin    => 0
	$scream_in_pain => 0
	$timezone       => undef
	$nsda           => undef
	$person
</%args>
<%init>

	use Email::Valid;

	$phone  =~ s/\D//g;
	$email  =~ s/\s+//g;
	$email = lc($email);

	my $emailok = Email::Valid->address(
		-address => $email,
		-mxcheck => 1
	) ? 'yes' : 'no';

	unless ($emailok eq "yes") {
		my $err = "That email address is not valid.  Please enter a valid address. $emailok";
		$m->redirect("person_edit.mhtml?edit_id=$edit_id&err=$err");
	}

	my $edit = Tab::Person->retrieve($edit_id);

	if ($email ne lc($edit->email)) {

		my $existing = Tab::Person->search( email => $email)->first;

		unless ($existing) {

			my $login = Tab::Login->search(username => $email )->first;

			if ($login && $login->person == $edit->id) {

			} elsif ($login && $login->person > 0) {
				$existing = $login->person;
			} elsif ($login) {
				#Orphans alas must perish in this cruel world.
				$login->delete();
			}
		}

		if ($existing) {
			my $err = "Email address $email already has an account belonging to: ";
			$err   .= $existing->first." ".$existing->last." (".$existing->email.") ";
			$m->redirect("/user/admin/person_edit.mhtml?err=$err");
		}
	}

	my $primary;
	my $exists;

	foreach my $login ($edit->logins) {

		if ($login->username eq $edit->email) {
			$primary = $login;
		} elsif ($login->username eq $email) {
			$primary = $login;
			$exists++;
		} elsif ($ARGS{$login->id."_username"} ne $login->username) {
			$login->username(lc($ARGS{$login->id."_username"}));
			$login->update();
		}
	}

	if ($exists) {

		# Do nothing, I already have a login with this email

	} elsif ($primary) {

		$primary->username($email);
		$primary->update();

	} else {

		$primary = Tab::Login->create({
			person   => $edit->id,
			username => $email
		});

		my $other = $edit->logins->first;

		if ($other) {
			$primary->sha512($other->sha512);
			$primary->pass_timestamp($other->pass_timestamp);
			$primary->update();
		}
	}


	$edit->first($first);
	$edit->middle($middle);
	$edit->pronoun($pronoun);
	$edit->last($last);
	$edit->street($street);
	$edit->city($city);
	$edit->email($email);
	$edit->state($state);
	$edit->country($country);
	$edit->no_email($no_email);
	$edit->zip($zip);
	$edit->site_admin($site_admin);
	$edit->phone($phone);
	$edit->tz($timezone);
	$edit->provider($provider);

	$edit->update();

	my %edit_settings = $edit->all_settings();

	foreach my $tag (
		"nsda_admin",
		"naudl_admin",
		"scream_in_pain",
		"email_unconfirmed",
		"email_confirmation_key"
	) {

		if ($ARGS{$tag} eq "0" || $ARGS{$tag} eq "") {
			undef($ARGS{$tag});
		}

		if ($edit_settings{$tag} && (not defined $ARGS{$tag})) {
			$edit->setting($tag, 0);
		} elsif ($ARGS{$tag} ne $edit_settings{$tag}) {
			$edit->setting($tag, $ARGS{$tag});
		}
	}

	$nsda =~ s/[\D_]//g;
	undef $nsda if $nsda < 1;

	my $other_user = Tab::Person->search( nsda => $nsda )->first if $nsda;

	# Had a minor bug here with an undeclared array so I fucked with it -- CLP
	if ($other_user && $other_user->id != $edit->id) {
		my $err = "Changes saved, but another account (".$other_user->email.") is already linked to NSDA ID $nsda, so that was skipped";
		$m->redirect("person_edit.mhtml?edit_id=$edit_id&&err=$err");
	}

	my ($person_ref, $flubber) = $m->comp(
		"/funclib/nsda/api_client.mas",
		path => "/members/".$nsda
	) if $nsda;

	if ($nsda
		&& ((not defined $person_ref) || (not defined $person_ref->{person_id}))
	) {
		my $err = "Changes saved, but the NSDA ID $nsda does not match an NSDA record, so no link was made.";
		$m->redirect("person_edit.mhtml?edit_id=$edit_id&&err=$err");
	}

	$m->comp("/funclib/ldap_person.mas", person => $person);
    Tab::log("PROFILE CHANGE BY ADMIN: Account ID ".$edit->id." changed ($email) from IP address ".$ENV{REMOTE_ADDR}." by ".$person->email) ;

	$edit->nsda($person_ref->{person_id});
	$edit->update();

	my $msg = "Changes saved";
	$m->redirect("person_edit.mhtml?edit_id=$edit_id&msg=$msg");

</%init>
