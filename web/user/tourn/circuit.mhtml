<%args>
	$person
	$defaults
	$session
</%args>
<%init>

	my $request = $defaults->{"request"};

	my $startdt = eval {
		return Tab::dtme($request->{"start"}, $request->{"starttime"});
	};

	my $enddt = eval {
		return Tab::dtme($request->{"end"}, $request->{"endtime"});
	};

	my %dts;

	foreach my $deadline (
		"reg_start",
		"reg_end",
		"frozen",
		"judge",
		"drops",
		"fines"
	) {

		my $dt = eval {
			return Tab::dtme($ARGS{$deadline}, $ARGS{$deadline."time"});
		};

		unless ($dt) {
			if ($deadline eq "reg_start" || $deadline eq "reg_end") {
				$request->{"errors"}{$deadline}++;
				$request->{"error"} .= "You must set a valid $deadline deadline";
			} elsif ($request->{"reg_end"}) {
				$dt = $request->{"reg_end"}->clone();
			}
		}

		if ($dt) {
			$request->{$deadline} = $ARGS{$deadline};
			$request->{$deadline."time"} = $ARGS{$deadline."time"};
			$dts{$deadline} = $dt;
		}
	}

	$defaults->{request} = $request;
	$session->default($defaults);

</%init>

	<div class="main">

		<h2>Tournament Circuit(s)</h2>

%       if ($request->{"error"}) {
            <p class="warning">
                <% $request->{"error"} %>
            </p>
%       }

		<p>
			Select which circuit or circuits your tournament should appear
			under.  The members of these circuits will see your tournament
			automatically when they log in.  and you will appear on that
			circuit's calendar once your tournament is approved.  You must
			choose at least one.
		</p>

		<p class="<% $request->{"errors"}{"spam"} ? "strong redtext" : "" %>">
			Please do not circuit spam. Putting your tournament into every
			circuit in the world, in the dreams it'll become the next
			tournament to rival NSDA Nationals in scale, is an abuse of the
			system and will be rejected. Use only those circuits you've
			actually drawn people from.
		</p>

<%perl>

		my @circuits = $m->comp("/funclib/person_circuits.mas", person => $person);
		push @circuits, $m->comp("/funclib/person_tourn_circuits.mas", person => $person);

		my %seen = ();
		@circuits = grep { ! $seen{$_} ++ } @circuits;

		my @all_circuits = Tab::Circuit->search(active => 1);

</%perl>

		<h4>Circuits you've managed tournaments in</h4>

		<form
			action = "location.mhtml"
			method = "post"
		>

		<table>

%		my %done_already;
%		my $switch = 1;

			<tr class="row">

<%perl>

			CIRCUIT:
			foreach my $circuit (sort {$a->name cmp $b->name} @circuits) {

				next if $circuit->setting("tourns_no_add");
				next if $done_already{$circuit->id};
				$done_already{$circuit->id}++;
</%perl>

%				if ($switch++ % 2) {
					</tr>
					<tr class="row">
%				}

				<td width="5%" class="centeralign">
					<input
						type = "checkbox"
						name = "<% $circuit->id %>"
						id   = "<% $circuit->id %>"
						<% $request->{"circuits"}{$circuit->id} ? "checked" : "" %>
					>
				</td>

				<td width="40%" class="nospace">
					<label for="<% $circuit->id %>">
						<span class="full padvert hover">
							<% $circuit->name %>
						</span>
					</label>
				</td>

				<td width="5%" class="centeralign">
					<% $circuit->state ? $circuit->state : $circuit->country %>
				</td>
%			}

			</tr>
		</table>

		<div class="liblrow rightalign">
			<span class="third centeralign">
				<input
					type  = "submit"
					value = "Next:  Tournament Location"
				>
			</span>
		</div>

		<h4>Other circuits</h4>

		<table>

			<tr class="row">
<%perl>
			$switch = 1;

			CIRCUIT:
			foreach my $circuit (sort {
				length($b->state) cmp length($a->state)
				|| $a->state cmp $b->state
				|| $a->country cmp $b->country
				|| $a->name cmp $b->name
				} @all_circuits
			) {

				next if $circuit->setting("tourns_no_add");
				if ($circuit->setting("ncfl")) {
					$done_already{$circuit->id}++;
					next CIRCUIT;
				}

				next if $done_already{$circuit->id};
				$done_already{$circuit->id}++;
</%perl>

%				if ($switch++ % 2) {
					</tr>
					<tr class="row">
%				}

				<td width="5%" class="centeralign">
					<input
						type = "checkbox"
						name = "<% $circuit->id %>"
						id   = "<% $circuit->id %>"
						<% $request->{"circuits"}{$circuit->id} ? "checked" : "" %>
					>
				</td>

				<td width="40%">
					<label for="<% $circuit->id %>">
						<span class="full padvert hover">
							<% $circuit->name %>
						</span>
					</label>
				</td>

				<td width = "5%"
					class = "centeralign"
				>
					<% $circuit->state ? $circuit->state : $circuit->country %>
				</td>
%			}
			</tr>
		</table>

		<div class="libl full marvertno rightalign">
			<span class="third centeralign">
				<input
					type  = "submit"
					value = "Next:  Tournament Host Site"
				>
			</span>
		</div>
		</form>

	</div>

	<div class="menu">
		<div class="sidenote">
			<h4>Tournament Setup</h4>

			<table>
				<tr class="row">
					<td class="smaller" colspan="2">
						<% $request->{"name"} %>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Webname
					</td>

					<td class="smaller">
						<% $request->{"webname"} %>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						City/Location
					</td>

					<td class="smaller">
						<% $request->{"city"} %>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						State/Country
					</td>

					<td class="smaller">
						<% $request->{"state"} ? $request->{"state"}."/" : "" %><% $request->{"country"} %>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Timezone
					</td>

					<td class="smaller">
						<% $request->{"tz"} %>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Start
					</td>

					<td class="smaller">
						<& "/funclib/showdt.mas",
							dt => $dts{"start"},
							tz => $request->{"tz"}
						&>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						End
					</td>

					<td class="smaller">
						<& "/funclib/showdt.mas",
							dt => $dts{"end"},
							tz => $request->{"tz"}
						&>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Entry Opens
					</td>

					<td class="smaller">
						<& "/funclib/showdt.mas",
							dt => $dts{"reg_start"},
							tz => $request->{"tz"}
						&>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Entries Due
					</td>

					<td class="smaller">
						<& "/funclib/showdt.mas",
							dt => $dts{"reg_end"},
							tz => $request->{"tz"}
						&>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Judges Due
					</td>

					<td class="smaller">
						<& "/funclib/showdt.mas",
							dt => $dts{"judge"},
							tz => $request->{"tz"}
						&>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Entry freeze
					</td>

					<td class="smaller">
						<& "/funclib/showdt.mas",
							dt => $dts{"frozen"},
							tz => $request->{"tz"}
						&>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Drop online
					</td>

					<td class="smaller">
						<& "/funclib/showdt.mas",
							dt => $dts{"drops"},
							tz => $request->{"tz"}
						&>
					</td>
				</tr>

				<tr class="row">
					<th class="smaller">
						Drop fines
					</td>

					<td class="smaller">
						<& "/funclib/showdt.mas",
							dt => $dts{"fines"},
							tz => $request->{"tz"}
						&>
					</td>
				</tr>
			</table>
		</div>
	</div>
