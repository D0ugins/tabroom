<%args>
	$session
	$tourn_id
	$person
	$person_settings
</%args>
<%init>

	# Make sure the user has access to that tournament through whatever pathway.
	my $tourn = Tab::Tourn->retrieve($tourn_id);

    Tab::Circuit->set_sql(by_admin => "
        select distinct circuit.*
        from circuit, permission
        where circuit.id = permission.circuit
        and permission.person = ?
		and permission.tag = 'circuit'
        order by circuit.name");

	my @auth_circuits = Tab::Circuit->search_by_admin($person->id);

	my $ok;
	my $reg_ok;

	if ($tourn) {

		if ($person->site_admin
			|| $person_settings->{"nsda_admin"}
		) {
			$ok++;
			$reg_ok++;
		}

		unless ($ok) {

			my %perms = $person->all_permissions($tourn);

			if (
				$perms{"owner"}
				|| $perms{"full_admin"}
				|| $perms{"registration"}
				|| $perms{"setup"}
				|| $perms{"details"}
				|| $perms{"category_tab"}
				|| $perms{"tabbing"}
				|| $perms{"entry_only"}
			) {
				$ok++;
			}

			if (
				$perms{"owner"}
				|| $perms{"full_admin"}
				|| $perms{"registration"}
				|| $perms{"category_tab"}
				|| $perms{"tabbing"}
			) {
				$reg_ok++;
			}

			if ($perms{"detailed"}) {
				foreach my $event_id (keys %{$perms{"details"}}) {
                	if ($perms{"details"}{$event_id} eq "admin") {
						$reg_ok++;
						last;
					}
				}
			}
        }
    }

	Tab::debuglog("I am here with reg $reg_ok and ok $ok");

	my $defaults = $session->default;
	$defaults->{tourn} = $tourn->id;
	$session->default($defaults);
	$session->update();

	my $now = DateTime->now();

	Tab::ChangeLog->create({
		tourn       => $tourn->id,
		person      => $person->id,
		type        => 'access',
		created     => $now,
		description => "Access from ".$ENV{REMOTE_ADDR}
	});

	if ($ok) {

		if ($tourn->setting("nsda_district")
			&& $tourn->setting("nsda_tabbing_software") eq "speechwire"
		) {
			$m->redirect('/tabbing/publish/swdistrict.mhtml');
		} elsif ($reg_ok) {
			$m->redirect("/register/index.mhtml");
		} else {
			$m->redirect("/tabbing/entry/index.mhtml");
		}

	} else {

		my $err = "You do not have administrative access to that tournament.  ";
		$err .= "Please contact the tournament director ";
		$err .= "or your circuit administrators if you think this in error";
		$m->redirect("/user/home.mhtml?err=$err");
	}

</%init>
