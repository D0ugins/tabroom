<%args>
	$person
	$name       => undef
	$webname    => undef
	$city       => undef
	$state      => undef
	$country    => undef
	$start      => undef
	$starttime  => undef
	$end        => undef
	$endtime    => undef
	$error      => undef
	$return_con => undef
</%args>
<%init>

	my $tz = $person->tz;
	$tz = "UTC" unless $tz;

	my @tourns = $m->comp(
		"/funclib/person_tourns.mas",
		person       => $person,
		all          => 1,
		no_districts => 1
	);

	my $startdt;
	my $enddt;

	eval{
		$startdt = Tab::dtme($start, $starttime, $tz);
		$enddt = Tab::dtme($end, $endtime, $tz);
	};

	my $defaultstart = DateTime->now();

	$defaultstart->set(
		hour   => 8,
		minute => 00,
		second => 00
	);

	my $defaultend = DateTime->now();

	$defaultend->set(
		hour   => 20,
		minute => 00,
		second => 00
	);

	my %returns =
		map {$_ => 1}
		split (/,/, $return_con)
		if $return_con;


	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select distinct tourn.webname, tourn.start
		from tourn, permission
		where tourn.id = permission.tourn
		and ( permission.tag = 'owner' or permission.tag = 'full_admin')
		and permission.person = ?
	");

	$sth->execute($person->id);

	my %webnames;

	while (
		my ($past, $start) = $sth->fetchrow_array()
	) {
		$webnames{$past} = $start;
	}


</%init>

	<div class="main">

		<h2>Manage a tournament with Tabroom</h2>

%		if ($error) {
			<p class="warning">
				<% $error %>
			</p>
%		}

		<div class="semibold bluetext full nospace padvertmore biggish centeralign">
			Please DO NOT include the year of your tournament in its name.  It's automatically included where needed.
		</div>

		<div class="<% ($name || not defined $error) ? "row" : "lirdrow" %>">

			<span class='fifth semibold bluetext'>
				Tournament Name
			</span>

			<span class="fourfifths">
				<form
					action = "deadlines.mhtml"
					method = "post"
				>
				<input
					type  = "text"
					name  = "name"
					size  = "64"
					value = "<% $name %>"
				>
			</span>

		</div>

		<div class="<% $return_con ? $returns{'webname'} || $webname ? "row" : "borderred" : "row" %>">

			<span class='fifth semibold bluetext'>
				Web Name
			</span>

			<span class="twofifths">

%				if (%webnames) {

					<div class="full nospace">
						<span class="third semibold bluetext marno">
							Existing
						</span>

						<span class="twothirds">

							<select
								name="existing_webname"
								class="fixedsmall"
							>

								<option value="">New Webname</option>
%									my $notfirst;
%									$notfirst++ if $webname;
%									foreach my $past (sort {$webnames{$b} cmp $webnames{$a}} keys %webnames) {
										<option
											value="<% $past %>"
											<% $past eq $webname ? "selected" : "" %>
											<% $notfirst++ ? "" : "selected" %>
										><% $past %></option>
%									}
							</select>
						</span>
					</div>
%				}

				<span class="third semibold bluetext marno">
					Or, New*
				</span>

				<span class="twothirds">
					<input
						type  = "text"
						name  = "webname"
						size  = "16"
						value = "<% $webname %>"
					>
				</span>
			</span>

			<span class="fourtenths bluetext centeralign">
				<div class="full marno padvertless semibold">
					* Lowercase letters, no spaces, no year.
				</div>

				<div class="full marno padvertless">
					Keep the same webname year to year.
				</div>

				<div class="full marno padvertless">
					Your tournament website will be
						<span class="inline redtext semibold">http://&lt;&lt;webname&gt;&gt;.tabroom.com</span>
				</div>
			</span>

		</div>

		<& "/funclib/datepicker.mas",
			from => "tournfrom",
			to   => "tournto"
		&>

		<div class="<% ($start || not defined $error) ? "row" : "lirdrow" %>">

			<span class="fifth semibold bluetext marvert">
				Dates
			</span>

			<span class='fourfifths'>

				<span class="sixth semibold bluetext marno">
					Start
				</span>

				<span class="twothirds">
					<input
						type  = "text"
						name  = "start"
						id    = "tournfrom"
						size  = "16"
						value = "<% $start %>"
					>
						at&nbsp;
					<& "/funclib/timepicker.mas",
						size    => 6,
						name    => "starttime",
						time    => $startdt,
						default => $defaultstart
					&>
				</span>

				<br />

				<span class="sixth semibold bluetext marno">
					End
				</span>

				<span class="twothirds">
					<input
						type  = "text"
						name  = "end"
						id    = "tournto"
						size  = "16"
						value = "<% $end %>"
					>
						at&nbsp;
					<& "/funclib/timepicker.mas",
						size    => 6,
						name    => "endtime",
						time    => $enddt,
						default => $defaultend
					&>
				</span>
			</span>

		</div>

		<div class="row">

			<span class="fifth semibold bluetext">
				Location
			</span>

			<span class="fourfifths">
				<div class="nospace full <%
					($city || not defined $error) && (not defined $returns{'city'})
					? "" : "borderred"
				%>">
					<span class="sixth semibold bluetext">
						City
					</span>

					<span class="twothirds">
						<input
							type  = "text"
							name  = "city"
							size  = "32"
							value = "<% $city ? $city : $person->city %>"
						>
					</span>
				</div>

				<div class="nospace full">
					<span class="sixth semibold bluetext">
						State
					</span>

					<span class="twothirds">
						<select
							name="state"
							class="fixedbig"
						>
							<&
								"/funclib/state_select.mas",
								state  => $state,
								person => $person
							&>
						</select>
					</span>
				</div>

				<div class="nospace full">
					<span class="sixth semibold bluetext">
						Country
					</span>

					<span class="twothirds">
						<select
							name  = "country"
							class = "fixedbig"
						>
							<&
								"/funclib/country_select.mas",
								country => $country,
								person  => $person
							&>
						</select>
					</span>
				</div>

				<div class="nospace full <%
					($tz || not defined $error) && (not defined $returns{'tz'})
						? "" : "borderred"
				%>">
					<span class="sixth semibold bluetext">
						Time Zone
					</span>

					<span class="twothirds">
						<select name="tz" class="fixedbig">
							<& "/funclib/timezones.mas", tz => $tz &>
						</select>
					</span>
				</div>
			</span>
		</div>

%		if (@tourns) {

			<div class="row padvert">

				<span class="fifth semibold bluetext">
					Clone setup from
				</span>

				<span class="fourfifths">
					<select
						name  = "clone"
						class = "fixedbigger"
					>
						<option value="">None: Create tournament from scratch</option>
%						foreach my $tourn (@tourns) {
							<option value="<% $tourn->id %>">
								<% $tourn->start->year %> <% substr($tourn->name,0,40) %>
							</option>
%						}
					</select>
				</span>
			</div>
%		}

		<label for="test">

			<div class="hover row <% $returns{"test"} ? "redtext borderred" : "" %>">

				<span class="fifth semibold bluetext">
					Test Tournament
				</span>

				<span class="fifth centeralign">
					<input
						type  = "checkbox"
						name  = "test"
						class = "check"
						value = "-1"
						id    = "test"
					>
				</span>

				<span class="threefifths bluetext">
%					if ($returns{"test"}) {
						<div class="full marno padvertless redtext">
							Your tournament has "test" in the name.
							Confirm that no, really, it is not a test tournament.
						</div>
%					}
					<div class="full marno padvertless">
						A test tournament is useful to test &amp; learn how to use Tabroom.com.
					</div>
					<div class="full marno padvertless">
						Test tournaments do not appear on the front page or for registration.
					</div>
					<div class="full marno padvertless">
						They also allow you to quickly create fake entries &amp; results.
					</div>
				</span>
			</div>
		</label>

		<div class="liblrow rightalign">
			<span class="twofifths centeralign">
				<input
					type  = "submit"
					value = "  Next: Set Deadlines  "
				>
			</span>
		</div>

		</form>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Don't register here</h4>

			<p>

				This area is for tournament directors.  Do not use this form if
				you are trying to register for someone else's tournament.  Go
				back to your <a class="inline redtext" href="/user/home.mhtml">home screen</a> and if
				the tournament does not appear, join the circuit the tournament
				is in.  Or find the tournament on the <a class="inline redtext" href="/">Tabroom home page</a>.
			</p>

			<h4>Tournament directors:</h4>

			<p>
				Once you set up your online tournament, a request will be sent to
				the administrators of your circuit for approval.  After they
				approve the tournament, it'll appear on the schedule for the
				circuit and be open for entries on this website on the date you
				set.
			</p>

			<p>
				Not all options are covered by the pre-approval forms; be sure
				to go into the admin pages once it's approved and create
				divisions and judge categories and suchforth.
			</p>

		</div>

	</div>

