<%args>
	$person
	$name       => undef
	$webname    => undef
	$city       => undef
	$start      => undef
	$starttime  => undef
	$end        => undef
	$endtime    => undef
	$error      => undef
	$return_con => undef
</%args>
<%init>

	my $tz = $person->tz;
	$tz = "UTC" unless $tz;

	my @tourns = $m->comp(
		"/funclib/person_tourns.mas", 
		person       => $person,
		all          => 1,
		no_districts => 1
	);

	my $startdt;
	my $enddt;
	
	eval{
		$startdt = Tab::dtme($start, $starttime, $tz);
		$enddt = Tab::dtme($end, $endtime, $tz);
	};

	my $defaultstart = DateTime->now();

	$defaultstart->set(
		hour   => 8,
		minute => 00,
		second => 00
	);

	my $defaultend = DateTime->now();

	$defaultend->set(
		hour   => 20,
		minute => 00,
		second => 00
	);

	my %returns = 
		map {$_ => 1}
		split (/,/, $return_con) 
		if $return_con;


	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare(" 
		select distinct tourn.webname, tourn.start
		from tourn, permission
		where tourn.id = permission.tourn
		and ( permission.tag = 'owner' or permission.tag = 'full_admin')
		and permission.person = ? 
	");

	$sth->execute($person->id);

	my %webnames;

	while (
		my ($past, $start) = $sth->fetchrow_array()
	) { 
		$webnames{$past} = $start;
	}


</%init>

	<div class="main">

		<h2>Manage a tournament with Tabroom</h2>

%		if ($error) { 
			<p class="warning">
				<% $error %>
			</p>
%		}

		<table>

%		if ($person->id == 1) { 
			<tr class="<% ($name || not defined $error) ? "row" : "lirdrow" %>">

				<th>
					ID number you cheating bastard:
				</th>

				<td class="rightalign">
					<input 
						type  = "number"
						name  = "id"
						size  = "16"
						value = ""
					>
				</td>
%			}

			</tr>
			<tr class="<% ($name || not defined $error) ? "row" : "lirdrow" %>">

				<th>
					Tournament Full Name
				</th>

				<td class="rightalign">
					<form 
						action = "deadlines.mhtml"
						method = "post"
					>
					<input 
						type  = "text"
						name  = "name"
						size  = "40"
						value = "<% $name %>"
					>
				</td>

			</tr>

			<tr class="<% ($name || not defined $error) ? "row" : "lirdrow" %>">

				<td class="explain rightalign" colspan="2">
					<div class="semibold redtext full nospace">
						Please DO NOT include the year of your tournament in its name.
					</div>
						Lots of reports add the year automatically, and having a 
						tournament listed as <br />
						"The 2017 Debate Invitational 2017" is kind of,
						well, weird looking.
				</td>

			</tr>

			<& "/funclib/datepicker.mas",
				from => "tournfrom",
				to   => "tournto"
			&> 
		
			<tr class="<% ($start || not defined $error) ? "row" : "lirdrow" %>">

				<th>
					Tournament Start:
				</th>

				<td class="rightalign">
					<input 
						type  = "text"
						name  = "start"
						id    = "tournfrom"
						size  = "15"
						value = "<% $start %>"
					>
						at
					<& "/funclib/timepicker.mas",
						size    => 6,
						name    => "starttime",
						time    => $startdt,
						default => $defaultstart
					&>
				</td>

			</tr>
		
			<tr class="<% ($end || not defined $error) ? "row" : "lirdrow" %>">

				<th>
					Tournament End:
				</th>

				<td class="rightalign">
					<input 
						type  = "text"
						name  = "end"
						id    = "tournto"
						size  = "15"
						value = "<% $end %>"
					>
					at
					<& "/funclib/timepicker.mas", 
						size    => 6,
						name    => "endtime",
						time    => $enddt,
						default => $defaultend
					&>
				</td>

			</tr>

			<tr class="<% $returns{'webname'} || $webname ? "row" : "borderred" %>">

				<th>
					Web Name
				</th>

				<td class="rightalign">

%					if (%webnames) { 
						<span class="half">
							<span class="quarter nospace semibold bluetext">
								Existing:
							</span>
							<span class="threequarters nospace">
							<select name="existing_webname">
								<option value="">New Webname</option>
%								my $notfirst;
%								$notfirst++ if $webname;
%								foreach my $past (sort {$webnames{$b} cmp $webnames{$a}} keys %webnames) { 
									<option 
										value="<% $past %>"
										<% $past eq $webname ? "selected" : "" %>
										<% $notfirst++ ? "" : "selected" %>
									><% $past %></option>
%								}
							</select>
							</span>
						</span>
%					}

%					if (%webnames) { 
						<span class="half">
							<span class="quarter nospace semibold bluetext">
								New:
							</span>
							<span class="threequarters nospace leftalign">
%					}

						<input 
							type  = "text"
							name  = "webname"
							size  = "16"
							value = "<% $webname %>"
						>
%					if (%webnames) { 
						</span>
%					}
					</span>
				</td>

			</tr>

			<tr class="<% ($name || not defined $error) ? "row" : "lirdrow" %>">

				<td
					class   = "explain rightalign"
					colspan = "2"
				>

					* Webname must be all lowercase letters, no spaces, and not
					in use by another tournament.  Don't include the tournament year.

					<br />
					<span class="inline semibold redtext">Make your webname the same 
					from year to year</span> so your results archives will show.

					<br />

					This name will form your tournament website, which will be 
					http://&lt;&lt;webname&gt;&gt;.tabroom.com.

				</td>

			</tr>

			<tr class="<% ($city || not defined $error) && (not defined $returns{'city'})
				? "row" : "borderred"
			%>">

				<th>
					City/Location
				</th>

				<td class="rightalign">
					<input 
						type  = "text"
						name  = "city"
						size  = "32"
						value = "<% $city %>"
					>
				</td>

			</tr>


			<tr class="row">
				<th>
					Time Zone 
				</th>

				<td class="rightalign">
					<select name="tz" class="fixed chosen">
					<& "/funclib/timezones.mas", tz => $tz &>
					</select>
				</td>
			</tr>


%			if (@tourns) { 

				<tr class="row">

					<th>
						Clone tournament:
					</th>

					<td class="rightalign">

						<select name="clone" class="fixed chosen">
							
							<option value="">None: Create tournament from scratch</option>

%							foreach my $tourn (@tourns) { 
								<option value="<% $tourn->id %>">
									<% $tourn->start->year %> <% substr($tourn->name,0,40) %>
								</option>
%							}
						</select>
					</td>

				</tr>

%			}


			<tr class="row <% $returns{"test"} ? "redtext borderred" : "" %>">

				<th class="nospace padleft">
					<label for="test">
						<span class="padvert hover marno">
							Hidden/Test Tournament
						</span>
					</label>
				</th>

				<td class="rightalign nospace">

					<label for="test">
						<div class="full rightalign nospace hover">

%							if ($returns{"test"}) { 
								<span class="threequarters semibold redtext padvert nospace">
									Your tournament has "test" in the name.
									Confirm that no, really, it is not a test
									tournament:
								</span>

								<span class="quarter centeralign">
									<input 
										type  = "checkbox"
										name  = "test"
										class = "check"
										value = "-1"
										id    = "test"
									>
								</span>
						
%							} else { 

								<span class="quarter centeralign">
									<input 
										type  = "checkbox"
										name  = "test"
										class = "large"
										value = "1"
										id    = "test"
										<% $returns{"test"} ? 'checked="checked"' : "" %>
									>
								</span>
%							}

						</div>
					</label>
				</td>
			</tr>

			<tr class="<% ($name || not defined $error) ? "row" : "lirdrow" %>">

				<td class="explain rightalign" colspan="2">
					A test tournament is for folks wanting to try and learn tabbing on Tabroom.com.  
					<br /> Test tournaments will not appear in the public calendar or for regsitration, 
					<br /> and have features that allow you to quickly create fake entries &amp; results.
				</td>

			</tr>

			<tr class="liblrow">
				<td colspan="2" class="rightalign">
					<input  
						type  = "submit"
						value = "  Next: Set Deadlines  "
					>
					</form>
				</td>
			</tr>
		
		</table>


        <h4 class="martop">Or, upload a tournament from an XML File:</h4>

           	<form 
				enctype  = "multipart/form-data"
				onsubmit = "return uploadThis()"
				name     = "xml"
				action   = "upload_tourn.mhtml"
				method   = "post"
			>

			<div class="evenrow">

                <div class="half">
                    <input 
						name  = "xml"
						type  = "file"
						class = "button"
					>
                </div>

                <div class="half rightalign">
                    <input 
						type  = "submit"
						value = " Upload XML "
					>
					</form>
                </div>

			</div>

	</div>

	<div class="menu">

		<div class="sidenote">

			<h4>Don't register here</h4>

			<p>
			
				This area is for tournament directors.  Do not use this form if
				you are trying to register for someone else's tournament.  Go
				back to your <a href="/user/home.mhtml">home screen</a> and if
				the tournament does not appear, join the circuit the tournament
				is in.  Or find the tournament on the <a href="/">Tabroom home page</a>.
			</p>

			<h4>Tournament directors:</h4>

			<p>
				Once you set up your online tournament, a request will be sent to
				the administrators of your circuit for approval.  After they
				approve the tournament, it'll appear on the schedule for the
				circuit and be open for entries on this website on the date you
				set.
			</p>

			<p>
				Not all options are covered by the pre-approval forms; be sure
				to go into the admin pages once it's approved and create
				divisions and judge categories and suchforth.
			</p>

		</div>

	</div>

