<%args>
	$person
	$session
	$chapter_id
	$naudl_err => undef
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	$m->comp("/user/chapter/auth.mas", 
		chapter => $chapter,
		person  => $person,
		session => $session
	);

	my @regions = $m->comp(
		"/funclib/chapter_regions.mas", 
		chapter => $chapter
	);

	my %region_yes = map {$_->id => 1} @regions;

	my $now = DateTime->now;

	my $tz = $person->tz;
	$tz = "UTC" unless $tz;
	$now->set_time_zone($tz);

	my @ualts;

	foreach my $login ($person->logins) { 
		push @ualts, $login->ualt_id if $login->ualt_id;
	}

	push @ualts, $person->ualt_id if $person->ualt_id;

</%init>

	<& 
		"/user/menu.mas", 
		chapter => $chapter,
		person  => $person 
	&>

	<div class="main">

		<h2><% $chapter->name %></h2>

		<& 
			"tabbar.mas",
			chapter => $chapter, 
			person => $person,
			whoami  => "nsda"
		&>

		<div class="full nospace">

			<span class = "threequarter">
				<h4>National Speech &amp; Debate Association Membership</h4>
			</span>

			<span class = "quarter rightalign">

%				if ($person->site_admin || $person->setting("nsda_admin") ) {
					<a 
						class="bluetext buttonwhite hover"
						href="nsda_chapter_fix.mhtml?chapter_id=<% $chapter->id %>"
					>
						NSDA Points Fix
					</a>
%				}
			</span>

		</div>

%		unless ($chapter->nsda) { 

%			if (@ualts) { 

				<& 
					"/user/nsda/chapters.mas", 
					person  => $person,
					chapter => $chapter,
					from    => "nsda_tab"
				&>


%			} else { 

				<h5 class="centeralign martopmore">
					Your Tabroom account is not connected to your NSDA account
				</h5>

				<p>
					Link them together in order to connect your students for
					autopoint posting and register for your District tournament.
				</p>

				<p class='centeralign martopmore'>
					<a 
						class = "buttonwhite bluetext invert hover"
						href  = "/user/nsda/link.mhtml"
					>
						Link to the NSDA
					</a>
				</p>

%			}

%		} elsif ($chapter->district) { 

%			my $district = $chapter->district;

			<div class="full row">

				<span class="fifth strong">
					Active Degrees
				</span>

				<span class="fifth">
					<% $chapter->setting("nsda_degrees") %>
				</span>

				<span class="fifth strong">
					Charter Status:
				</span>

				<span class="eighth">
					<% $chapter->setting("nsda_charter") %>
				</span>

				<span class="quarter marno centeralign strong padtop padbottom">
					<% $chapter->setting("nsda_paid") ? "Paid" : "Not Paid" %>
				</span>

			</div>

			<div class="full row marbottommore">

				<span class="fifth strong padtop padbottom">
					District:
				</span>
					
				<span class="fifth">
					#<% $district->code %>
					<% $chapter->district->name %>
				</span>

				<span class="fifth">
					<% $district->location ? $district->location : "" %>
				</span>
					
				<span class="twofifth strong centeralign">
					Level: <% $district->level %>
				</span>

			</div>

<%perl>
			my @tourns = $m->comp(
				"/funclib/district_tourns.mas", 
				district => $district,
				hidden   => 1
			);

			my %committee = $m->comp(
				"/funclib/district_committee.mas", 
				district => $district
			);

			my $is_chair;
			my $is_member;
</%perl>


			<h4>District Committee</h4>

%			foreach my $role ("chair", "member", "alternate") { 

%				next unless $committee{$role};

%				foreach my $member (@{$committee{$role}}) { 

					<div class="full row padless marno">

						<span class="sixth strong">
							<% ucfirst($role) %>
						</span>

						<span class="third">
							<% $member->first." ".$member->last %>
						</span>

						<span class="third">
							<a 
								href="mailto:<% $member->email %>" 
								class="plain"
							>
								<% $member->email %>
							</a>
						</span>

						<span class="sixth marno rightalign">
%							if ($member->id == $person->id) { 
%								$is_chair++ if $role eq "chair";
%								$is_member++;
								(aka, you)
%							}
						</span>

					</div>

%				}

%			}

%			if (@tourns) { 
				<h4 class="martopmore">
					District Tournaments
				</h4>
%			}

<%perl>

			foreach my $tourn (@tourns) { 

				my $school =  Tab::School->search( 
					chapter => $chapter->id, 
					tourn => $tourn->id 
				)->first;

				my $start = $tourn->start->set_time_zone($tourn->tz);
				my $end = $tourn->end->set_time_zone($tourn->tz);

				my $reg_start = $tourn->reg_start->set_time_zone($tourn->tz);
				my $reg_end = $tourn->reg_end->set_time_zone($tourn->tz);

</%perl>
	
				<div class="full padless row">

					<span class="quarter">
						<% $tourn->name %>
					</span>

					<span class="quarter nospace">
%						foreach my $event (sort {$a->abbr cmp $b->abbr} $tourn->events) { 
							<span class="fifth marno">
								<% $event->abbr %>
							</span>
%						}
					</span>

					<span class="fifth nospace">
%						foreach my $site (sort {$a->name cmp $b->name} $tourn->sites) { 
							<div class="full">
								<% $site->name %>
							</div>
%						}
					</span>

					<span class="fifth">
						<% Tab::niceshortdayte($start) %>
						<% $end->day != $start->day ? "&ndash; ".Tab::niceshortdayte($end) : ""%>
					</span>


					<span class="tenth">

%						if ($school) { 

							<a 
								href="/user/enter/entry.mhtml?school_id=<% $school->id %>"
								class="buttonwhite bluetext invert"
							>
								Entry
							</a>

%						} elsif ($reg_start > $now) { 

							Opens <% Tab::niceshortdt($reg_start) %>

%						} elsif ($reg_end <  $now) { 

							Closed <% Tab::niceshortdt($reg_end) %>

%						} else { 

							<a 
								href="/user/enter/create.mhtml?chapter_id=<% $chapter->id %>&tourn_id=<% $tourn->id %>"
								class="buttonwhite redtext invert"
							>
								Enter
							</a>

%						} 

					</span>

				</div>

%			}

%			if ($is_member || $person->site_admin) { 

				<div class="full nospace">

					<span class="twothirds nospace">
						<h3 class="martopmuchmore">
							District Committee Info
						</h3>
					</span>

%					if ($person->setting("nsda_beta")) { 

						<span class="third rightalign">
							<a 
								class = "buttonwhite bluetext"
								href  = "/user/nsda/district_tournament_create.mhtml?district_id=<% $district->id %>"
							>Create District Tournament
							</a>
						</span>
%					}

					</div>
%			}

%			foreach my $tourn (@tourns) { 

%				next if (not defined $is_member);

%				my $start = $tourn->start->set_time_zone($tourn->tz);
%				my $end = $tourn->end->set_time_zone($tourn->tz);

				<div class="full nospace lightrow">

					<div class="quarter nospace padleft">
						<a 
							class="plain full"
							href="/index/tourn/index.mhtml?tourn_id=<% $tourn->id %>"
						>

							<% $tourn->name %>
						</a>
					</div>

					<div class="third nospace padless">
%						foreach my $event (sort {$a->abbr cmp $b->abbr} $tourn->events) { 
							<span class="sixth marno">
								<% $event->abbr %>
							</span>

%						}
					</div>

					<div class="fifth">
						<% Tab::niceshortdayte($start) %>
						<% $end->day != $start->day ? "&ndash; ".Tab::niceshortdayte($end) : ""%>
					</div>

				</div>

%			}


			<div class="full nospace">

				<span class="twothirds">
					<h4 class="martop">
						District Members in Tabroom
					</h4>
				</span>

				<span class="third rightalign">
					<a 
						class = "buttonwhite bluetext"
						href  = "/user/nsda/district_update.mhtml?district_id=<% $district->id %>&whoami=chapter&chapter_id=<% $chapter->id %>"
					>Update District Records
					</a>
				</span>
			</div>


			<& "/funclib/tablesorter.mas", table => "sortmebaby" &>

			<table id="sortmebaby">

				<thead>
					<tr class="yellowrow">

						<th>
							School
						</th>

						<th>
							Degrees
						</th>

						<th>
							Paid
						</th>

						<th>
							Type
						</th>

					</tr>

				</thead>

				<tbody>

%					foreach my $chapter ($district->chapters) { 

						<tr>

							<td>
								<% $chapter->name %>
							</td>

							<td class="rightalign">
								<% $chapter->setting("nsda_degrees") %>
							</td>

							<td class="centeralign">
								<% $chapter->setting("nsda_paid") ? "Y" : "N"  %>
							</td>

							<td class="centeralign">
								<% $chapter->setting("nsda_charter") %>
							</td>

						</tr>

%					}

				</tbody>

			</table>


%		}

	</div>


