<%args>
	$person
	$person_settings
	$newbie     => undef
	$student_id => undef
	$chapter_id => undef
	$from       => undef
	$first      => undef
	$middle     => undef
	$last       => undef
</%args>
<%init>

	use Tab::NSDA::Person;

	my $student = Tab::Student->retrieve($student_id) if $student_id;
	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	unless ($student || $chapter) { 
		my $err = "You haven't chosen a chapter.  Please choose at right";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my %student_settings = $student->all_settings();

	$chapter = $student->chapter unless $chapter;

	unless ($chapter) { 
		my $err = "You haven't chosen a chapter.  Please choose at right";
		$m->redirect("/user/home.mhtml?err=$err");
	}

	my $ndt;

	my @circuits = $chapter->circuits;
	@circuits = $student->chapter->circuits if $student && not defined $chapter;

	foreach my $circuit (@circuits) { 
		$ndt++ if $circuit->id == 43;
	}

	my $demo;
	foreach my $circuit ($chapter->circuits) { 
		next if $demo;
		$demo++ if $circuit->setting("demographics");
	}

	my $tz = $person->tz if $person;
	$tz = "UTC" unless $tz;

	my $now = DateTime->now(time_zone => $tz);
	$now->subtract( days => 1 );

	my $default_year = $now->year + 4;

	my $then = $now->clone;
	$then->subtract( years => 15 );

	my @students = Tab::Student->search_where({
		chapter   => $chapter->id,
		timestamp => {">=", DateTime::Format::MySQL->format_date($now)}},
		{order_by => "timestamp"}
	);

	$from = "edit" unless $from || (not defined $student_id);

</%init>

	<div class="main">

		<h2><% $chapter->name %> Student Roster</h2>

        <& tabbar.mas,
			chapter => $chapter,
			person  => $person,
			whoami  => "students"
		&>

%		if ($student) {
			<h4><% $student->first." ".$student->last %></h4>
% 		} else { 
			<h4>Add a student:</h4>
% 		}

%		if ($newbie) { 

			<p>
				You now should add the student names for your team into your
				roster by adding their information below.  Consider adding in
				your entire team to save work later.
			</p>
			
			<p>
				You only have to add each student once for their entire career;
				you can then look up an entire student record for all the
				tournaments on Tabroom that a given student attends.
			</p>

			<p>
				Begin by adding the first student below.
			</p>

			<hr />

%		}

%		unless ($student && $student->person && $student->person->id) { 	

			<form action="student_search.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "chapter_id"
				value = "<% $chapter->id %>"
			>

			<input 
				type  = "hidden"
				name  = "student_id"
				value = "<% $student_id %>"
			>

			<div class="row">

				<span class="half padleft">
					<% ($student) ? 
						"Link ".$student->first." ".$student->last." to "  
						: "Find student w/"
					%> a Tabroom login:
				</span>

				<span class="third">
					<input 
						type        = "email"
						name        = "email"
						placeholder = "Search by email address"
						size        = "32"
					>
				</span>

				<span class="sixth rightalign">
					<input 
						type     = "submit"
						class    = "thin notfirst"
						tabindex = "-1"
						value    = "Search"
					>
				</span>
			</div>
			</form>

			<h4>
				<% ($student) 
					? "Edit Details" 
					: "Or, Create a new student (without tabroom.com account)" 
				%>
			</h4>

%		}


		<table>

%			if ($student && $student->person && $student->person->id) { 

				<tr class="row">

					<td class="rightalign semibold limit2 bluetext">
						Linked to Tabroom login 
					</td>

					<td>
						<span class="half nospace">
							<a class="white semibold bluetext" 
								href="mailto:<% $student->person->email %>"
							>
								<% $student->person->email %> 
							</a>
						</span>

						<span class="threeeighths nospace semibold bluetext">
							<% $student->person->first %> <% $student->person->last %>
						</span>

						<span class="eighth rightalign nospace padvert semibold redtext">
							Unlink:
							<a 
								class="fa fa-sm fa-chain-broken redtext buttonwhite"
								href="student_unlink.mhtml?student_id=<% $student->id %>"
								title="Undo link to competitor"
							></a>
						</span>
					</td>

				</tr>
%			}

			<form action="student_save.mhtml" method="post">

			<input 
				type  = "hidden"
				name  = "student_id"
				value = "<% ($student) ? $student->id : "" %>"
			>

			<input 
				type  = "hidden"
				name  = "chapter_id"
				value = "<% $chapter->id %>"
			>

			<input 
				type  = "hidden"
				name  = "from"
				value = "<% $from %>"
			>

			<tr class="row">

				<td class="rightalign limit2">
					First Name
				</td>
				
				<td>
					<input 
						type  = "text"
						name  = "first"
						size  = "32"
						value = "<% ($student) ? $student->first : $first %>"
					>
				</td>

			</tr> 

			<tr class="row">
			
				<td class="rightalign">
					Middle Name
				</td>
				
				<td>
					<input 
						type  = "text"
						name  = "middle"
						size  = "32"
						value = "<% ($student) ? $student->middle : $middle %>"
					>
				</td>

			</tr> 
			
			<tr class="row">
			
				<td class="rightalign">
					Last Name
				</td>
				
				<td>
					<input 
						type  = "text"
						name  = "last"
						size  = "32"
						value = "<% ($student) ? $student->last : $last %>"
					>
				</td>

			</tr> 
			<tr class="row">
			
				<td class="rightalign">
					Email Address
				</td>
				
				<td>
					<input 
						type  = "email"
						name  = "student_email"
						size  = "32"
						value = "<% ($student && $student_settings{"student_email"} ne "X")
							? $student_settings{'student_email'} 
							: ""
						%>"
					>
				</td>

			</tr> 

%			if ($person->site_admin || $person_settings->{"nsda_admin"}) { 

				<tr class="row">
				
					<td class="rightalign">
						NSDA Merit #
					</td>
					
					<td>
						<input 
							type  = "text"
							name  = "ualt_id"
							size  = "32"
							value = "<% $student ? $student->ualt_id : "" %>"
						>
					</td>
				</tr> 

				<tr class="row">
				
					<td class="rightalign">
						NSDA ID
					</td>
					
					<td>
						<input 
							type  = "text"
							name  = "nsda"
							size  = "32"
							value = "<% $student ? $student->nsda : "" %>"
						>
					</td>

				</tr> 

%			} else { 

				<input 
					type  = "hidden"
					name  = "ualt_id"
					value = "<% $student ? $student->ualt_id : "" %>"
				>

				<input 
					type  = "hidden"
					name  = "nsda"
					value = "<% $student ? $student->nsda : "" %>"
				>
%			}
			
			<tr class="row">
				
				<td class="rightalign">
					Phonetic Pronunciation
				</td>
				
				<td>
					<input 
						type  = "text"
						name  = "phonetic"
						size  = "32"
						value = "<% ($student) ? $student->phonetic : ""%>"
					>
				</td> 

			</tr> 
			
			<tr class="row">
			
				<td class="rightalign">
					Grad Year
				</td>
				
				<td>
					<input 
						type  = "number"
						name  = "grad_year"
						min   = "1900"
						max   = "2100"
						size  = "6"
						value = "<% ($student) ?   $student->grad_year : $default_year %>"
					>
				</td>

			</tr> 
			
			<tr class="row">
			
				<td class="rightalign">
					Novice
				</td>
				
				<td class="nospace">
					<label for="n">
						<span class="quarter hover padless">
							<input 
								type  = "checkbox"
								name  = "novice"
								id    = "n"
								value = "1"
								<% ($student) ?  ($student->novice) ? 'checked' : '': "" %> >
						</span>
					</label>
				</td> 

			</tr> 
			
			<tr class="row">
			
				<td class="rightalign">
					Gender
				</td>
				
				<td class="nospace">

					<label for="m">
						<span class="quarter hover padless">
							<input 
								type  = "radio"
								name  = "gender"
								id    = "m"
								value = "M" 
								<% ($student) ? ($student->gender eq "M") ? "checked" : "" : "" %>> M
						</span>
					</label>

					<label for="f">
						<span class="quarter hover padless">
							<input 
								type  = "radio"
								name  = "gender"
								id    = "f"
								value = "F" 
								<% ($student) ? ($student->gender eq "F" ) ? "checked" : "" : "" %>> F
						</span>
					</label>

					<label for="o">
						<span class="quarter hover padless">
							<input 
								type="radio" 
								name="gender" 
								id="o" 
								value="O" 
								<% ($student) ? ($student->gender eq "O" ) ? "checked" : "" : "" %>> Other
						</span>
					</label>
				</td>
			</tr> 
			
%			if ($demo) { 

				<tr class="row">
				
					<td class="rightalign">
						Student ID
					</td>
					
					<td>
						<input 
							type    = "text"
							name    = "school_sid"
							size 	= "30"
							value	= "<% $student ? $student->school_sid : '' %>"
						>
					</td>
				</tr> 

				<tr class="row">
				
					<td class="rightalign">
						Date of Birth
					</td>

					<& /funclib/datepicker.mas, id => "birthdate" &>

					<td>
						<input 
							type  = "text"
							name  = "birthdate"
							id    = "birthdate"
							size  = "10"
							value = "<% $student && $student->birthdate
								? Tab::pickerdate($student->birthdate) 
								: "" %>"
					</td>
				</tr> 

				<tr class="row">

%					my $race = $student->race if $student;
				
					<td class="rightalign">
						Ethnic Background
					</td>

					<td>
						<select name="race" class="fixedmed">

							<option value="">Choose one</option>

							<option 
								value="white" 
								<% $race eq "white" ? "selected" : "" %>
							>White, non-Hispanic/Latino</option>

							<option 
								value="black" 
								<% $race eq "black" ? "selected" : "" %>
							>Black, non-Hispanic/Latino</option>

							<option 
								value="latino" 
								<% $race eq "latino" ? "selected" : "" %>
							>Hispanic/Latino</option>

							<option 
								value="amerindian" 
								<% $race eq "amerindian" ? "selected" : "" %>
							>American Indian/Native Alaskan</option>

							<option 
								value="asian" 
								<% $race eq "asian" ? "selected" : "" %>
							>Asian</option>

							<option 
								value="pacific" 
								<% $race eq "pacific" ? "selected" : "" %>
							>Native Hawaiian/Pacific Islander</option>

							<option 
								value="dual" 
								<% $race eq "dual" ? "selected" : "" %>
							>Two or more races</option>

							<option 
								value="other" 
								<% $race eq "other" ? "selected" : "" %>
							>Other</option>

						</select>
					</td>
				</tr> 
%			}

			<tr class="row">
			
				<td class="rightalign">
					Diet Notes
				</td>
				
				<td>
					<input 
						type  = "text"
						name  = "diet"
						size  = "32"
						value = "<% $student ? $student->diet : "" %>"
					>
				</td>
			</tr> 

%			if ($ndt && $student) {

				<tr class="row">
					<td class="rightalign">
						NDT bid sheets
					</td>

					<td>
						<a class="buttonwhite bluetext"
							href="ndt_bid_honors.mhtml?student_id=<% $student->id %>&chapter_id=<% $chapter->id %>">
							NDT Bid Sheet honors
						</a>
					</td>
						
				</tr>
%			}


			<tr class="libl">

				<td colspan="2" class="rightalign">
					<input  
						type  = "submit"
						name  = "twitch"
						value = "  Save Student <% ($student) ? "" : "& Add Another" %>  ">
					</form>
				</td>
				
			</tr>

		</table>

	</div>

	<div class="menu">

		<div class="sidenote bigger">
			<a class="blue full" 
				href="student_edit.mhtml?chapter_id=<% $chapter->id %>">
				Add another student
			</a>

			<a class="blue full" 
				href="students.mhtml?chapter_id=<% $chapter->id %>">
				Return to student roster
			</a>
		</div>

%		if ($chapter->nsda > 0 ) { 

%			if ($student && $student->nsda) { 

				<div class="sidenote bigger">

					<h4>NSDA Membership</h4>

%					if ($person->site_admin && $student) { 

%						my $nsda_person = Tab::NSDA::Person->search(user_id => $student->nsda)->first;
%						$nsda_person = Tab::NSDA::Person->search(ualt_id => $student->ualt_id)->first unless $nsda_person;

%						if ($nsda_person) { 

							<div class="full row marno padvert biggish centeralign semibold bluetext">
								Member: <% $nsda_person->ufname." ".$nsda_person->umname." ".$nsda_person->ulname %>
							</div>

							<div class="full row marno padvert biggish">

								<span class="threefifths semibold bluetext">
									Points
								</span>

								<span class="twofifths">
									<% $student_settings{"nsda_points"} %>
								</span>

							</div>

							<div class="full row marno padvert biggish">

								<span class="threefifths semibold bluetext">
									Dues Paid
								</span>

								<span 
									class="twofifths leftalign fa fa-lg
									<% $student_settings{"nsda_paid"} 
										? "fa-check greentext" 
										: "fa-times redtext"
									%>"
								></span>
							</div>

							<div class="full row marno padvert biggish">

								<span class="threefifths semibold bluetext">
									Join Date
								</span>

%								my $nsda_joined = $student_settings{"nsda_joined"};

								<span class="twofifths">
									<& "/funclib/showdate.mas", 
										tz     => $tz,
										length => "medium",
										string => $nsda_joined
									&>
								</span>

							</div>

							<div class="full row marno padvert biggish">

								<span class="threefifths semibold bluetext">
									NSDA Web Account
								</span>

								<span 
									class="twofifths leftalign fa fa-lg
									<% $student_settings{"student_email"} && $student_settings{"student_email"} ne "X"
										? "fa-check greentext" 
										: "fa-times redtext"
									%>"
								></span>

							</div>

%		my $warn = "This will separate this competitor and this NSDA membership, meaning they will get no auto-posted points and possibly will be unable to attend Districts or Nationals.  Are you sure?";

							<div class="full row nospace rightalign">
								<a
									title = "Use this if you have connected this competitor to the wrong NSDA member"
									class = "buttonwhite redtext invert smallish"
									href  = "unlink_student.mhtml?student_id=<% $student->id %>"
									<& "/funclib/confirm.mas", warn => $warn &>
								>Unlink!</a>
							</div>

%						}
%					}

				</div>

%			}

%		}

%		if ($student) { 
		<div class="sidenote">

			<h4>Parent notifications</h4>

			<div class="odd ltborder marno padless full">
				<p class="biggish explain">
					Parents will be notified, and sent tournament messages/memos,
					when a competitor signs up for a tournament.  It does not
					happen when a team admin registers a competitor.
				</p>

				<p class="biggish explain">
					Parent followers do not need their own Tabroom.com accounts.
				</p>
			</div>

%			foreach my $follower ($student->followers) { 

				<div 
					class = "row full marno"
					id    = "<% $follower->id %>"
				>
					<span 
						class="fourfifths biggish bluetext nowrap"
						title="<% $follower->follower ? $follower->follower->email : $follower->email %>"
					>
						<% $follower->follower ? $follower->follower->email : $follower->email %>
					</span>

					<span class="fifth centeralign nospace">
				
%						my $warn = "This email will no longer be notified of tournament information for this competitor.  Are you sure?";

						<a 
							id            = "<% $follower->id %>" 
							target_id     = "<% $follower->id %>" 
							on_success    = "destroy"
							onClick       = "postConfirm('<% $warn %>', this, 'unfollow.mhtml');"
							class         = "buttonwhite padless fa fa-chain-broken redtext hover"
							title         = "Unfollow"
						>
						</a>

					</span>
				</div>
%			}

			<h5>Add parent/guardian:</h5>

			<form 
				action = "follow.mhtml"
				method = "post"
			>

			<input 
				type="hidden"
				name="student_id"
				value="<% $student->id %>"
			>

			<div class="libl full centeralign biggish">
				<input 
					type        = "email"
					name        = "email"
					size        = "24"
					placeholder = "Email address"
				>

				<input 
					type="submit" 
					class="thin"
					value="Add"
				>
			</div>

			</form>

		</div>

%		}

		<div class="sidenote">
	
			<h4>Recently Changed:</h4>

%			foreach my $student (@students) { 
			
				<a 
					class="nowrap blue full" 
					href="student_edit.mhtml?student_id=<% $student->id %>"
				>
					<span class="threequarter">
						<% $student->first." ".$student->last %>
					</span>

					<span class="quarter">
						<% $student->grad_year %>
					</span>
				</a>

%			}

		</div>

	</div>

