<%args>
	$person
	$chapter_id
</%args>
<%init>

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	my %students_by_name = ();

	foreach my $student ($chapter->students) {

		my $namestring = lc($student->first." ".$student->middle." ".$student->last);

		Tab::debuglog("name string is $namestring") if $student->last eq "Cohen";

		unless ($namestring) {
			$student->delete();
		} else {
			push @{$students_by_name{$namestring}}, $student;
		}
	}


</%init>

	<& /user/menu.mas,
		chapter => $chapter,
		person  => $person
	&>

	<div class="main">

		<h2><% $chapter->name %>: De-duplicate Students</h2>

		<& tabbar.mas,
			chapter => $chapter,
			person  => $person,
			whoami  => "students"
		&>

		<& /funclib/tablesorter.mas, table => 'dedupe' &>

		<form action="dedupe_save.mhtml" method="post">

		<input
			type  = "hidden"
			name  = "chapter_id"
			value = "<% $chapter->id %>"
		>

		<table id="dedupe">

			<thead>

				<tr class="yellowrow">

					<th class="smaller">
						Name
					</th>

					<th class="smaller">
						Students
					</th>

					<th class="smaller">
						Merge?
					</th>

				</tr>

			</thead>

			<tbody>

<%perl>

			foreach my $key (keys %students_by_name) {

				next if scalar @{$students_by_name{$key}} < 2;

				my $sample = ${$students_by_name{$key}}[0];

</%perl>

				<tr>

					<td>
						<% $sample->first." ".$sample->middle." ".$sample->last %>
					</td>

					<td class="smallish">

%						foreach my $student (@{$students_by_name{$key}}) {

							<div class="block padless">
								TR #<% $student->id %>
								<% $student->nsda ? "NSDA: ".$student->nsda : "" %>
								<%$student->first." ".$student->last." '".$student->grad_year %>:
								<% scalar $student->entries %> entries
							</div>
%						}
					</td>

					<td class="centeralign">
						<input
							type    = "checkbox"
							name    = "<% $key %>"
							value   = "1"
							checked = "checked"
						>
					</td>

				</tr>

%			}

			</tbody>

			<tr class="liblrow">

				<td colspan="3" class="rightalign">
					<input
						type  = "submit"
						value = " Merge Duplicates "
					>
					</form>
				</td>

			</tr>

		</table>

	</div>

