<%args>
	$person
	$session
	$perms
	$chapter_id => undef
	$show_grads => undef
</%args>
<%init>

	$m->abort unless (
		$perms->{"chapter"}{$chapter_id} eq "chapter"
		|| $perms->{"owner"}
	);

	my $chapter = Tab::Chapter->retrieve($chapter_id) if $chapter_id;

	$m->abort unless $chapter;

	my @students;

	if ($show_grads) {
		@students = $chapter->students;
	} else {
		@students = $chapter->students( retired => 0 );
	}

    my @student_requests = Tab::Student->search_where({
        chapter        => $chapter->id,
        person_request => { ">", 0 }
    });

	my $message;

</%init>

	<div class="main">

		<h2><% $chapter->name %>: Competitors</h2>

		<& "tabbar.mas",
			chapter => $chapter,
			person  => $person,
			session => $session,
			whoami  => "students"
		&>

%		if (@student_requests) {

			<h4>Competitors requesting online access</h4>

			<p>
				The following persons have asked to be linked to these
				students.  Only permit this if you know the account is the same
				person as the students; otherwise online balloting and other
				access may be given incorrectly
			</p>

			<& /funclib/tablesorter.mas,
				table     => "requests",
				nobuttons => 1
			&>

			<table id="requests">

				<thead>

					<tr class="yellowrow">

						<th>
							Competitor
						</th>

						<th>
							Requestor
						</th>

						<th colspan="2">
						</th>

					</tr>

				</thead>

				<tbody>
<%perl>

				foreach my $request (@student_requests) {

					unless ($request->person_request && $request->person_request->id) {
						$request->delete;
						next;
					}

</%perl>
					<tr id="<% $request->id %>">

						<td>
							<% $request->first." ".$request->last %>
						</td>

						<td>
							<span class="half">
								<% $request->person_request->first %>
								<% $request->person_request->last %>
							</span>
							<span class="half nospace rightalign">
								<a href="mailto:<% $request->person_request->email %>">
								(<% $request->person_request->email %>)
								</a>
							</span>
						</td>

						<td class="centeralign nospace padvertless">
							<a
								class         = "buttonwhite greentext fa fa-lg fa-check invert"
								target_id     = "<% $request->id %>"
								property_name = "accept"
								on_success    = "destroy"
								onClick       = "postSwitch(this, 'link.mhtml');"
							></a>
						</td>

						<td class="centeralign nospace padvertless">
							<a
								class="buttonwhite redtext fa fa-lg fa-times invert"
								target_id     = "<% $request->id %>"
								property_name = "deny"
								on_success    = "destroy"
								onClick       = "postSwitch(this, 'link.mhtml');"
							></a>
						</td>

					</tr>
%				}
				</tbody>
			</table>
%		}

		<& /funclib/tablesorter.mas,
			table     => "students",
			nobuttons => 1
		&>

		<div class="full nospace">
			<span class="half nospace">
				<h4>
					<% scalar @students %>
					<% $show_grads ? "Total" : "Active" %>
					Competitors
				</h4>
			</span>

			<span class="half rightalign nospace">
				<a
					class="<% $show_grads ? "bluetext" : "redtext" %> buttonwhite fa fa-lg fa-ban marright"
					href="students.mhtml?show_grads=<% $show_grads ? "" : "true" %>&chapter_id=<% $chapter->id %>"
					title="Show inactive competitors"
				></a>
				<a
					class = "buttonwhite greentext fa fa-lg fa-file-excel-o hover"
					title = "Download Excel roster of students"
					href  = "students_csv.mhtml?chapter_id=<% $chapter->id %>&show_grads=<% $show_grads %>"
				></a>
			</span>
		</div>

		<table id="students" class="narrow">

			<thead>
				<tr class="yellowrow">

					<th class="smaller">
					</th>

					<th class="smaller">
						First
					</th>

					<th class="smaller">
						Middle
					</th>
					<th class="smaller">
						Last
					</th>

					<th class="smaller nowrap">
						Grad
					</th>

					<th class="smaller">
						Account
					</th>

					<th class="smaller nowrap">
						Novice
					</th>

					<th class="smaller">
						Retired
					</th>
				</tr>
			</thead>
			<tbody>

% 			foreach my $student (@students) {

				<tr>

					<td class="centeralign">
						<a class="hidden" id="<% $student->id %>"></a>
						<a
							class  = "buttonwhite greentext smallish hover"
							target = "_blank"
							href   = "record.mhtml?student_id=<% $student->id %>&from=<% $student->id %>"
						>
							Records
						</a>
					</td>

					<td class="smallish">
						<a
							class = "white"
							href  = "student_edit.mhtml?student_id=<% $student->id %>&from=<% $student->id %>"
						>
							<% $student->first %>
						</a>
					</td>
					<td class="smallish">
						<a
							class = "white"
							href  = "student_edit.mhtml?student_id=<% $student->id %>&from=<% $student->id %>"
						>
							<% $student->middle %>
						</a>
					</td>

					<td class="smallish">
						<a
							class = "white"
							href  = "student_edit.mhtml?student_id=<% $student->id %>&from=<% $student->id %>"
						>
							<% $student->last %>
						</a>
					</td>

					<td class="centeralign smallish">
						<% $student->grad_year %>
					</td>

					<td class="smallish">
%						if ($student->person > 0) {
							<a
								class="white"
								href="mailto:<% ($student->person) ? $student->person->email : "" %>"
							>
								<% ($student->person) ? $student->person->email : "" %>
							</a>
%						}
					</td>

					<td class="centeralign smallish">

						<span class="hidden"><% $student->novice %></span>

						<label class="switch">
							<input
								type          = "checkbox"
								value         = "1"
								id            = "<% $student->id %>_novice"
								property_name = "novice"
								target_type   = "student"
								target_id     = "<% $student->id %>"
								onChange      = "postSwitch( this, 'novice_switch.mhtml');"

								<% $student->novice ? 'checked="checked"' : "" %>
							>
							<div class="slider"></div>
						</label>
					</td>

					<td class="centeralign smallish">

						<span class="hidden"><% $student->retired %></span>

						<label class="switch">
							<input
								type          = "checkbox"
								value         = "1"
								id            = "<% $student->id %>_retired"
								property_name = "retired"
								target_type   = "student"
								target_id     = "<% $student->id %>"
								onChange      = "postSwitch( this, 'retired_switch.mhtml');"

								<% $student->retired ? 'checked="checked"' : "" %>
							>
							<div class="slider offmore"></div>
						</label>
					</td>

				</tr>

% 			}

			</tbody>
		</table>
	</div>

	<div class="menu">

        <div class="sidenote">

			<h4>Competitor Roster</h4>

            <a
				class="dkblue full"
				href="student_edit.mhtml?chapter_id=<% $chapter->id %>"
			>
                Add a new student
            </a>

            <a
				class="yellow full"
				href="import_csv.mhtml?chapter_id=<% $chapter->id %>"
			>
				Import from Spreadsheet
            </a>

            <a
				class="yellow full"
				href="dedupe.mhtml?chapter_id=<% $chapter->id %>"
			>
				De-duplicate students
            </a>


<%perl>

			if (
				$chapter->level eq "highschool"
				|| $chapter->level eq "middle"
			) {

</%perl>

				<h6 class="martop">NSDA Points</h6>

%				if ($chapter && $chapter->nsda > 0) {

					<a
						class="blue martop full"
						href="/user/nsda/student_roster.mhtml?chapter_id=<% $chapter->id %>"
					>
						NSDA Points Competitor Connections
					</a>

					<a
						class="blue full"
						href="/user/nsda/import_nsda_roster.mhtml?chapter_id=<% $chapter->id %>"
					>
						Import NSDA Competitor Roster
					</a>

%				} else {

					<a
						class="blue martop full"
						href="/user/nsda/link.mhtml?chapter_id=<% $chapter->id %>"
					>
						Connect to NSDA Auto Pointing
					</a>
%				}

%			} elsif ($chapter->level eq "university") {

				<h6 class="martop">PKD Points</h6>

%				if ($chapter && $chapter->nsda > 0) {

					<a
						class="blue martop full"
						href="/user/nsda/student_roster.mhtml?chapter_id=<% $chapter->id %>"
					>
						PKD Points Competitor Connections
					</a>

					<a
						class="blue full"
						href="/user/nsda/import_nsda_roster.mhtml?chapter_id=<% $chapter->id %>"
					>
						Import PKD Competitor Roster
					</a>

%				} else {

					<a
						class="blue martop full"
						href="/user/nsda/link.mhtml?chapter_id=<% $chapter->id %>"
					>
						Connect to PKD Auto Pointing
					</a>

%				}

%			}

			<h6 class="martop">Other Info</h6>

            <a
				class="blue martop full"
				href="diets.mhtml?chapter_id=<% $chapter->id %>"
			>
				Dietary preferences
            </a>

            <a
				class="blue full"
				href="parents.mhtml?chapter_id=<% $chapter->id %>"
			>
				Parent Notifications
            </a>


		</div>

		<& "/user/menu.mas",
			chapter => $chapter,
			person  => $person,
			nodiv   => 1
		&>

	</div>
