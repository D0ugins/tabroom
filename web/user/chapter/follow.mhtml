<%args>
	$person
	$student_id
	$perms
	$email       => undef
	$return_only => undef
	$return_to   => undef
</%args>
<%init>

	my $msg;
	my $err;

	use Email::Valid;

	my $emailok = Email::Valid->address(
		-address => $email, 
		-mxcheck => 0
	) ? 'yes' : 'no';

	my $follower;
	my $student = Tab::Student->retrieve($student_id) if $student_id;

	if ($student) { 

		unless (
			($student->person && $student->person->id == $person->id)
			|| $perms->{"chapter"}{$student->chapter->id} eq "chapter"
			|| $person->site_admin 
		) { 

			$err = "You can only edit your own parent notifications";
		}   

	}

	if ($err) { 

	} elsif ($email && $emailok && $student) { 

		my $follow = Tab::Person->search( 
			email => $email
		)->first;

		my $login = Tab::Login->search( 
			username => $email
		)->first;

		$follow = $login->person if $login && (not defined $follow);

		if ($follow) { 

			unless (
				Tab::Follower->search(
					student => $student_id,
					follower => $follow->id
				)
			) { 
				$follower = Tab::Follower->create({
					student  => $student_id,
					follower => $follow->id
				});
			}

		} else { 

			unless (
				Tab::Follower->search(
					student => $student_id,
					email   => $email
				)
			) { 
				$follower = Tab::Follower->create({
					student => $student_id,
					email   => $email
				});
			}

		}

		if ($follower) { 

			$msg = "$email will now get signup notifications for ".$student->first." ".$student->last;

			my $subject = "You are now following ".$student->first." ".$student->last." on Tabroom";

			my $body = "You have been registered by ".$person->first." ".$person->last." to recieve updates ";
			$body .= "about ".$student->first." ".$student->last." on Tabroom.com, which manages ";
			$body .= "competitions for speech and debate.\n\n";
			
			$body .= "You will be notified when ".$student->first." ";
			$body .= "signs up for tournaments, and will automatically receive any information ";
			$body .= "that the coaches or team administrators post about that tournament. \n\n";
			$body .= "If you think this is in error, please reply to this email.\n";

			$body .= "Thanks!\n";
			$body .= $person->first." ".$person->last;

			$m->comp("/funclib/send_email.mas", 
				raw     => $email,
				from    => $person,
				subject => $subject,
				body    => $body
			);

		} else { 

			$msg = "$email is already getting signup notifications for ".$student->first." ".$student->last;

		}


	} else { 

		$err = "$email is not a valid email address or $student_id is not a valid Student ID";

	}

	return ($follower, $msg, $err) if $return_only;

	$m->redirect("/user/student/parents.mhtml?student_id=$student_id&err=$err&msg=$msg")
		if $return_to eq "self_edit";

	$m->redirect("student_edit.mhtml?student_id=$student_id&err=$err&msg=$msg");

</%init>
