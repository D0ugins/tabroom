<%args>
	$person
	$person_settings
	$session
	$chapter_id => undef
	$default    => "calendar"
</%args>
<%init>

	my $tz = $person->tz;
	$tz = "UTC" unless $tz;

	my $chapter = Tab::Chapter->retrieve($chapter_id);

	unless ($chapter) {
		$m->comp("/funclib/abort.mas", message => "No chapter exists with ID $chapter_id");
	}

	my $access = Tab::Permission->search(
		person  => $person,
		chapter => $chapter->id
	)->first;

	unless ($person->site_admin || $access || $chapter_id) {
		$m->comp("/funclib/abort.mas", message => "You do you have access school ID $chapter_id");
	}

	unless ($chapter && $chapter->level) {
		my $err = "Please fill in your institution's level before continuing";
		$m->redirect("/user/chapter/settings.mhtml?chapter_id=".$chapter->id."&err=$err");
	}

	my $this_year = Tab::school_year;
	$this_year->add(years => 1);

	my $max = $this_year->year."-07-01";
	my $dbh = Tab::DBI->db_Main();

	my $now = DateTime->now();
	my $until = $now->clone();
	$until->add(months => 1);

	$dbh->disconnect();

	my @tabs = ("calendar", "create");

</%init>

	<& "/user/menu.mas",
		person          => $person,
		person_settings => $person_settings,
		chapter         => $chapter
	&>

	<div class="main">

		<h2><% $chapter->name %>: Practice Tracker</h2>

		<&
			"tabbar.mas",
			chapter => $chapter,
			person  => $person,
			session => $session,
			whoami  => "practice"
		&>

		<&  "/funclib/tabs.mas",
			tabs    => \@tabs,
			default => $default,
			buttons => 1,
			center  => "yaskween"
		&>

		<div class="screens calendar ltbordertop martopless">
			<h5>Upcoming Practice Sessions</h5>
		</div>

		<div class="screens create ltbordertop martopless">

			<h5>Create New Practice(s)</h5>

			<form action="practice_add.mhtml" method="post">

				<div class="row">
					<span class="spacer"></span>
					<span class="quarter semibold">
						Practice Name or Label
					</span>

					<span class="half">
						<input
							type = "text"
							name = "label"
						>
					</span>
				</div>

				<div class="row">
					<span class="spacer"></span>
					<span class="quarter semibold">
						Practice Start
					</span>

					<span class="quarter padvert">
						<input
							name = "start_date"
							type = "date"
							max  = "<% $max %>"
						>
					</span>

					<span class="spacer">
						at
					</span>

					<span class="fifth padvert">
						<input
							name = "start_time"
							type = "time"
						>
					</span>
				</span>

				<div class="row">
					<span class="spacer"></span>
					<span class="quarter semibold">
						Practice End
					</span>

					<span class="quarter">
						<input
							name = "end_date"
							type = "date"
							max  = "<% $max %>"
						>
					</span>
					<span class="spacer">
						at
					</span>

					<span class="fifth padvert">
						<input
							name = "end_time"
							type = "time"
						>
					</span>
				</div>

				<div class="row">

					<span class="spacer"></span>
					<span class="quarter semibold">
						Repeating series?
					</span>

					<span class="quarter">
						<select
							name     = "recurring"
							method   = "fixedmost"
							id       = "recurring"
							onChange = "repeatCheck();";
						>
							<option value="">Does not repeat</option>
							<option value="weekly">Repeat every week</option>
							<option value="daily">Repeat every schoolday</option>
						</select>
					</span>
				</div>

				<script>
					function repeatCheck() {

						var repeatCode = $("#recurring").val();
						console.log(repeatCode);

						if (repeatCode) {
							$("#repeater").removeClass("hidden");
						} else {
							$("#repeater").addClass("hidden");
						}
					}

					$(document).ready(function() {
						repeatCheck();
					});

				</script>

				<div class="row" id="repeater">
					<span class="spacer"></span>
					<span class="quarter semibold">
						Repeat until
					</span>

					<span class="quarter padvert">
						<input
							name = "recurring_end_date"
							type = "date"
							max  = "<% $max %>"
							value = "<& "/funclib/showdate.mas", length => "sortable", dt => $until &>"
						>
					</span>
				</div>

				<div class="liblrow rightalign">
					<span class="centeralign third nospace padvertless">
						<input type="submit" value="Save Practice">
					</span>
				</div>

			</form>
		</div>

	</div>
