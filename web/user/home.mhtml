<%args>
	$person
	$chapter => undef
	$err     => undef
	$msg     => undef
	$session => undef
</%args>
<%init>

	my $dbh = Tab::DBI->db_Main();

	my $sth = $dbh->prepare("
		select count(*)
		from person
			left join judge on(person.id = judge.person and judge.active = 1)
			left join category on(judge.category = category.id)
			left join student on(person.id = student.person)
			left join entry_student on(student.id = entry_student.student)
			left join entry on(entry.id = entry_student.entry and entry.dropped = 0)
			inner join tourn on(tourn.id=entry.tourn or tourn.id=category.tourn)
			inner join tourn_setting on(tourn.id=tourn_setting.tourn 
										and tourn_setting.tag = 'googleplus' 
										and tourn_setting.value = 1)
		where (person.googleplus IS NULL OR person.googleplus = '')
		and person.id = ?
	");

	$sth->execute($session->person->id);

	my $missing = $sth->fetchrow_array();

	if ($missing) {
		my $err = "You are scheduled in debates that require a Google+ Account, and have not yet linked your Gmail/Google+ account";
		$m->redirect("/user/login/profile.mhtml?err=$err");
	}

	my @entries = $m->comp("/funclib/person_entries.mas", person => $person);
	my @entry_panels = $m->comp("/funclib/person_entry_panels.mas", person => $person) if @entries;
	my @judges = $m->comp("/funclib/person_judges.mas", person => $person);

	my @panels = $m->comp("/funclib/person_panels.mas", person => $person) if @judges;

	my @students = Tab::Student->search( person => $person->id );

	my @chapters = $m->comp("/funclib/person_chapters.mas", person => $person);

	if (@panels) { 
		$m->redirect("/user/judge/panels.mhtml?err=$err&msg=$msg"); 
	}

	if (@entry_panels) { 
		#$m->redirect("/user/entry/panels.mhtml?err=$err&msg=$msg");
	}

	if (@entries) { 
		$m->redirect("/user/student/index.mhtml?err=$err&msg=$msg");
	}

	if (@chapters) { 
		$m->redirect("/user/chapter/index.mhtml?err=$err&msg=$msg");
	}

	if (@judges) { 
		$m->redirect("/user/judge/index.mhtml?err=$err&msg=$msg");
	}

	if (@students) { 
		$m->redirect("/user/student/index.mhtml?err=$err&msg=$msg");
	}

	$m->redirect("/user/setup.mhtml?err=$err&msg=$msg");

</%init>

