<%args>
	$person
	$chapter => undef
	$err     => undef
	$msg     => undef
	$session => undef
</%args>
<%init>

	my $missing;

	unless ($person->googleplus) { 

		my $dbh = Tab::DBI->db_Main();

		my $student_sth = $dbh->prepare("
			select count(student.id)
				from student, entry_student, entry, event, tourn, tourn_setting

				where tourn_setting.tag = 'googleplus'
				and tourn_setting.tourn = event.tourn
				and tourn.start > NOW()
				and event.id = entry.event
				and entry.id = entry_student.entry
				and entry_student.student = student.id
				and student.person = ? 
		");

		my $judge_sth = $dbh->prepare("
			select count(judge.id)
				from judge, category, tourn_setting, tourn
				where tourn_setting.tag = 'googleplus'
				and tourn_setting.tourn = category.tourn
				and tourn.start > NOW()
				and category.id = judge.category
				and judge.person = ? 

		");

		$student_sth->execute($person->id);
		$judge_sth->execute($person->id);

		my $missing = $student_sth->fetchrow_array();
		$missing += $judge_sth->fetchrow_array();

	}

	if ($missing) {
		my $err = "You are scheduled in debates that require a Google+ Account, ";
		$err .= "and have not yet linked your Gmail/Google+ account";
		$m->redirect("/user/login/profile.mhtml?err=$err");
	}

	my @judges = $m->comp("/funclib/person_judges.mas", person => $person);

	my @panels = $m->comp("/funclib/person_panels.mas", person => $person) if @judges;

	if (@panels) { 
		$m->redirect("/user/judge/panels.mhtml?err=$err&msg=$msg"); 
	}

	my @entries = $m->comp("/funclib/person_entries.mas", person => $person);

	#	if (@entries) {
	# 	my @entry_panels = $m->comp("/funclib/person_entry_panels.mas", person => $person) 
	# 	if (@entry_panels) { 
	#		$m->redirect("/user/entry/panels.mhtml?err=$err&msg=$msg");
	# 	}
	# }

	if (@entries) { 
		$m->redirect("/user/student/index.mhtml?err=$err&msg=$msg");
	}

	my @chapters = $m->comp("/funclib/person_chapters.mas", person => $person);

	if (@chapters) { 
		$m->redirect("/user/chapter/index.mhtml?err=$err&msg=$msg");
	}

	if (@judges) { 
		$m->redirect("/user/judge/index.mhtml?err=$err&msg=$msg");
	}

	my @students = Tab::Student->search( person => $person->id );

	if (@students) { 
		$m->redirect("/user/student/index.mhtml?err=$err&msg=$msg");
	}

	$m->redirect("/user/setup.mhtml?err=$err&msg=$msg");

</%init>

